<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link rel="preconnect" href="https://unpkg.com" />
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
  :root{
    --bg:#0b1224;--panel:#111a33;--panel2:#0e1830;--text:#e7efff;--muted:#9fb0d6;
    --accent:#2b7fff;--accent2:#1b69ee;--ok:#18c37e;--warn:#ffb02e;--bad:#ff5d5d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#0b1224, #0d1430 60%, #0b1224);
    color:var(--text);font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP", "Yu Gothic", "Helvetica Neue", Arial, sans-serif;
  }
  h1{font-size:22px;font-weight:800;letter-spacing:.04em;margin:14px 16px 8px}
  .bar{display:flex;gap:8px;align-items:center;padding:10px 12px;margin:0 12px 10px;border-radius:14px;background:var(--panel);border:1px solid #1e2a4e;flex-wrap:wrap}
  .bar input[type="text"]{flex:1 1 220px;min-width:180px;padding:12px 14px;border-radius:12px;background:#0b1530;border:1px solid #203056;color:var(--text);outline:none}
  .btn{appearance:none;border:1px solid #29437e;background:linear-gradient(180deg,#20408f,#1c3370);color:#f5f9ff;font-weight:700;border-radius:12px;padding:12px 16px;cursor:pointer}
  .btn.secondary{background:#132248}
  .btn.warn{background:#5c2a00;border-color:#9a560e}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;gap:8px;margin:0 12px}
  .grid.cols{grid-template-columns: repeat(2,minmax(0,1fr))}
  .grid.cols3{grid-template-columns: repeat(3,minmax(0,1fr))}
  .pill{background:var(--panel);border:1px solid #213058;border-radius:14px;padding:10px 12px}
  .pill label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .pill input{width:100%;padding:10px 12px;border-radius:10px;background:#0b1530;border:1px solid #213058;color:var(--text)}
  .select{display:flex;gap:8px;align-items:center}
  .select .seg{display:inline-flex;background:#0b1430;border:1px solid #22345c;border-radius:10px;overflow:hidden}
  .seg button{padding:8px 12px;border:0;background:transparent;color:#cfe2ff;font-weight:700}
  .seg button.on{background:#1a2c5e;color:#fff}
  .status{margin:10px 16px;font-size:14px;color:#cfe2ff}
  .status .muted{color:var(--muted)}
  #map{height:58vh;margin:8px 12px 12px;border-radius:16px;overflow:hidden;border:1px solid #1b294e}
  .fabcol{position:absolute;right:14px;bottom:18px;display:flex;flex-direction:column;gap:12px;z-index:420}
  .fab{min-width:120px;text-align:center;border-radius:16px;padding:12px 16px;font-weight:800;background:linear-gradient(180deg,#162756,#132149);border:1px solid #2a3d71;box-shadow:0 8px 22px rgba(0,0,0,.35);cursor:pointer}
  .fab.ok{background:linear-gradient(180deg,#0d6f47,#0a5a3a)}
  .fab.accent{background:linear-gradient(180deg,#1b4be8,#173bb9)}
  .fab.warn{background:linear-gradient(180deg,#6a2a2a,#4b1b1b)}
  .helper{margin:4px 16px 8px;color:#a7b7e5;font-size:14px}
  .helper b{color:#dbe8ff}
  /* æ¤œç´¢çµæœ */
  #results{margin:6px 16px;background:var(--panel);border:1px solid #213058;border-radius:12px;display:none}
  #results h3{font-size:14px;color:#cfe2ff;margin:12px}
  .res{padding:10px 12px;border-top:1px dashed #27375f;cursor:pointer}
  .res:hover{background:#0f1b39}
  /* Leaflet èª¿æ•´ */
  .leaflet-control-attribution{background:rgba(0,0,0,.3);color:#cfe2ff;border-radius:10px;padding:2px 6px}
  .leaflet-top.leaflet-left .leaflet-control{margin-top:10px;margin-left:10px}
  .leaflet-bottom.leaflet-left .leaflet-control{margin-left:10px;margin-bottom:10px}
  /* æ–¹ä½è¨ˆï¼ˆå°å‹ãƒ»å¸¸æ™‚ONï¼‰ */
  #compass{
    position:absolute;top:10px;right:10px;z-index:460;
    width:72px;height:72px;border-radius:50%;
    background:radial-gradient(ellipse at center,#0c1530 0%,#0c1530 60%,#0a1228 100%);
    border:1px solid #2a3a5e;box-shadow:0 10px 24px rgba(0,0,0,.35);
    display:flex;align-items:center;justify-content:center;user-select:none;pointer-events:none;
  }
  #ring{ position:absolute; inset:5px; border-radius:50%; border:2px solid #22355f; box-shadow:inset 0 0 10px rgba(0,0,0,.5); }
  .tick{ position:absolute; width:2px; height:9px; background:#3a4f7a; top:5px; left:50%; transform-origin:50% 28px; }
  .tick.big{ height:12px; background:#85a3e6; }
  #needle{ position:absolute; left:50%; top:10px; width:0; height:0;
    border-left:6px solid transparent; border-right:6px solid transparent; border-top:28px solid #ff5757;
    transform:translateX(-50%) rotate(0deg); transform-origin:50% 30px; filter:drop-shadow(0 0 6px rgba(255,80,80,.45));
  }
  #tail{ position:absolute; left:50%; bottom:10px; width:0; height:0;
    border-left:5px solid transparent; border-right:5px solid transparent; border-bottom:18px solid #35a8ff;
    transform:translateX(-50%) rotate(0deg); transform-origin:50% -22px; opacity:.95;
  }
  .dir{ position:absolute; font-size:11px; color:#d7e4ff; font-weight:700; letter-spacing:.05em; text-shadow:0 1px 2px rgba(0,0,0,.35) }
  .dir.n{ top:7px; left:50%; transform:translateX(-50%) }
  .dir.s{ bottom:7px; left:50%; transform:translateX(-50%); color:#9fb0d6 }
  .dir.e{ right:7px; top:50%; transform:translateY(-50%); color:#cbd8ff }
  .dir.w{ left:7px; top:50%; transform:translateY(-50%); color:#cbd8ff }
  #headingLabel{ position:absolute; bottom:-16px; left:50%; transform:translateX(-50%);
    font-size:10px; color:#cfe2ff; background:#0f1a31; padding:1px 6px; border-radius:8px; border:1px solid #2a3556 }
  #headingLabel.bad{ background:#3a1b1b; border-color:#6e2a2a; color:#ffd4d4 }
  /* ã‚¹ãƒ¢ãƒ¼ãƒ«ç«¯æœ«ã§å¾®èª¿æ•´ */
  @media (max-width:420px){
    .grid.cols3{grid-template-columns:1fr 1fr}
    #compass{transform: scale(.88); transform-origin: top right;}
  }
</style>
</head>
<body>
  <h1>Cloudflare Workers ãƒŠãƒ“</h1>

  <!-- æ¤œç´¢ãƒãƒ¼ -->
  <div class="bar">
    <input id="q" type="text" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢ï¼ˆè¿‘ã„é †ã«5ä»¶ï¼‰" />
    <button id="mic" class="btn secondary" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
    <button id="search" class="btn">æ¤œç´¢</button>
  </div>

  <!-- å…¥åŠ›ç¾¤ -->
  <div class="grid cols3">
    <div class="pill">
      <label>é–‹å§‹åœ°ç‚¹ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="grid cols">
        <input id="startLon" placeholder="çµŒåº¦" />
        <input id="startLat" placeholder="ç·¯åº¦" />
      </div>
    </div>
    <div class="pill">
      <label>ç›®çš„åœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="grid cols">
        <input id="endLon" placeholder="çµŒåº¦" />
        <input id="endLat" placeholder="ç·¯åº¦" />
      </div>
    </div>
    <div class="pill">
      <label>ãƒ¢ãƒ¼ãƒ‰</label>
      <div class="select">
        <div class="seg" id="modeSeg">
          <button data-mode="foot-walking" class="on">å¾’æ­©</button>
          <button data-mode="cycling-regular">è‡ªè»¢è»Š</button>
          <button data-mode="driving-car">è»Š</button>
        </div>
      </div>
      <div style="margin-top:8px;color:#b9c8ef;font-size:13px">è¨€èªï¼š<b>æ—¥æœ¬èª</b></div>
    </div>
  </div>

  <!-- æ“ä½œ -->
  <div class="bar" style="justify-content:flex-start">
    <button id="routeBtn" class="btn accent">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
    <button id="clearBtn" class="btn secondary">ã‚¯ãƒªã‚¢</button>
    <div class="helper"><b>åœ°å›³ã‚’é•·æŠ¼ã—</b>ã™ã‚‹ã¨ç›®çš„åœ°ã«è¨­å®šã§ãã¾ã™</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆè¢«ã‚‰ãªã„ãƒ•ãƒ©ãƒƒãƒˆãªãƒ†ã‚­ã‚¹ãƒˆï¼‰ -->
  <div id="status" class="status">æº–å‚™å®Œäº†ã€‚<span class="muted">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</span></div>

  <!-- æ¤œç´¢çµæœ -->
  <div id="results">
    <h3>æ¤œç´¢çµæœï¼ˆè¿‘ã„é † ä¸Šä½5ä»¶ï¼‰</h3>
    <div id="resWrap"></div>
  </div>

  <!-- ãƒãƒƒãƒ— -->
  <div id="map"></div>
  <div class="fabcol">
    <button id="startNav" class="fab ok">æ¡ˆå†…é–‹å§‹</button>
    <button id="hereBtn" class="fab">ç¾åœ¨åœ°</button>
    <button id="destBtn" class="fab">ç›®çš„åœ°</button>
    <button id="rerouteBtn" class="fab warn">ãƒªãƒ«ãƒ¼ãƒˆ</button>
  </div>
  <!-- æ–¹ä½è¨ˆï¼ˆå¸¸æ™‚ONãƒ»å°å‹ï¼‰ -->
  <div id="compass" aria-hidden="true">
    <div id="ring"></div>
    <div class="tick big" style="transform:translateX(-50%) rotate(0deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(30deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(60deg)"></div>
    <div class="tick big" style="transform:translateX(-50%) rotate(90deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(120deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(150deg)"></div>
    <div class="tick big" style="transform:translateX(-50%) rotate(180deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(210deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(240deg)"></div>
    <div class="tick big" style="transform:translateX(-50%) rotate(270deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(300deg)"></div>
    <div class="tick" style="transform:translateX(-50%) rotate(330deg)"></div>
    <div id="needle"></div>
    <div id="tail"></div>
    <div class="dir n">N</div><div class="dir s">S</div><div class="dir e">E</div><div class="dir w">W</div>
    <div id="headingLabel">N/A</div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ====== è¨­å®š ======
  const WORKER_ENDPOINT = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
  const LANG = 'ja';
  const OFFROUTE_M = 5;                 // 5mã§ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆ
  const REROUTE_COOLDOWN_MS = 15000;    // å†ãƒ«ãƒ¼ãƒˆã®é€£ç™ºé˜²æ­¢
  let currentProfile = 'foot-walking';

  // ====== UI å–å¾— ======
  const $ = (s)=>document.querySelector(s);
  const q = $('#q'); const mic = $('#mic'); const searchBtn = $('#search');
  const startLon = $('#startLon'), startLat = $('#startLat');
  const endLon = $('#endLon'), endLat = $('#endLat');
  const routeBtn = $('#routeBtn'), clearBtn = $('#clearBtn');
  const hereBtn = $('#hereBtn'), destBtn = $('#destBtn'), rerouteBtn = $('#rerouteBtn'), startNavBtn = $('#startNav');
  const statusEl = $('#status');
  const results = $('#results'), resWrap = $('#resWrap');

  // ====== åœ°å›³ åˆæœŸåŒ– ======
  const map = L.map('map', { zoomControl: true });
  map.zoomControl.setPosition('bottomleft');

  const tile = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom: 19, attribution:'<a href="https://www.openstreetmap.org/copyright">Â© OpenStreetMap contributors</a>'
  }).addTo(map);

  let meMarker = L.marker([0,0],{draggable:false}).addTo(map);
  let destMarker = null;
  let routeLine = null;
  let watchId = null;
  let lastPos = null;
  let routeData = null;
  let stepIndex = 0;
  let snappedPolyline = null;
  let lastReroute = 0;

  // é•·æŠ¼ã—ã§ç›®çš„åœ°
  map.on('contextmenu', e=>{
    setDest(e.latlng.lng, e.latlng.lat);
  });
  map.on('longpress', e=>{ setDest(e.latlng.lng, e.latlng.lat); }); // ä¸€éƒ¨ç«¯æœ«ç”¨

  function setStatus(t){ statusEl.textContent = t; }
  function setDest(lon,lat){
    endLon.value = lon.toFixed(6); endLat.value = lat.toFixed(6);
    if(destMarker) destMarker.remove();
    destMarker = L.marker([lat,lon],{draggable:true}).addTo(map);
    destMarker.on('dragend', e=>{
      const ll = e.target.getLatLng();
      endLon.value = ll.lng.toFixed(6); endLat.value = ll.lat.toFixed(6);
    });
    setStatus('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚');
  }

  // ç¾åœ¨åœ°å–å¾—
  function initGeolocation(){
    if(!navigator.geolocation){
      map.setView([35,135],5);
      setStatus('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude, heading} = pos.coords;
      meMarker.setLatLng([latitude, longitude]);
      startLat.value = latitude.toFixed(6);
      startLon.value = longitude.toFixed(6);
      map.setView([latitude, longitude], 17);
      lastPos = pos.coords;
      updateCompass(heading ?? null);
    }, _err=>{
      map.setView([35,135],5);
      setStatus('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    },{enableHighAccuracy:true, maximumAge:0, timeout:10000});

    // watch
    if(watchId) navigator.geolocation.clearWatch(watchId);
    watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude, longitude, heading} = pos.coords;
      lastPos = pos.coords;
      meMarker.setLatLng([latitude, longitude]);
      if(isNavigating) onMoveDuringNav(latitude, longitude);
      updateCompass(heading ?? bearingFromHistory(pos.coords));
    }, _=>{}, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
  }

  // ====== ã‚³ãƒ³ãƒ‘ã‚¹æ›´æ–° ======
  const needle = document.getElementById('needle');
  const tail = document.getElementById('tail');
  const headingLabel = document.getElementById('headingLabel');
  function updateCompass(deg){
    if(typeof deg!=='number' || isNaN(deg)){
      headingLabel.textContent = 'N/A';
      headingLabel.classList.add('bad');
      return;
    }
    headingLabel.classList.remove('bad');
    const rot = deg; // 0=N
    needle.style.transform = `translateX(-50%) rotate(${rot}deg)`;
    tail.style.transform   = `translateX(-50%) rotate(${rot}deg)`;
    headingLabel.textContent = `${Math.round(((deg%360)+360)%360)}Â°`;
  }
  // ç›´è¿‘ã®é€²è¡Œãƒ™ã‚¯ãƒˆãƒ«ã‹ã‚‰æ¦‚ç®—æ–¹ä½
  let lastHist=null;
  function bearingFromHistory(c){
    if(!lastHist){ lastHist=c; return null; }
    const b = bearing(lastHist.latitude,lastHist.longitude,c.latitude,c.longitude);
    lastHist=c; return b;
  }

  // ====== ãƒ«ãƒ¼ãƒˆå–å¾— ======
  async function fetchRoute(){
    const slon = parseFloat(startLon.value), slat=parseFloat(startLat.value);
    const elon = parseFloat(endLon.value), elat=parseFloat(endLat.value);
    if(!isFinite(slon)||!isFinite(slat)||!isFinite(elon)||!isFinite(elat)){
      setStatus('é–‹å§‹åœ°ç‚¹ã¨ç›®çš„åœ°ã®åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;
    }
    setStatus('ãƒ«ãƒ¼ãƒˆã‚’å•ã„åˆã‚ã›ä¸­...');
    try{
      const res = await fetch(`${WORKER_ENDPOINT}?profile=${encodeURIComponent(currentProfile)}`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          coordinates:[[slon,slat],[elon,elat]],
          instructions:true, language:LANG
        })
      });
      if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
      const data = await res.json();
      routeData = data;
      drawRoute(data);
      previewWholeRoute(data);
      speak('ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚æ¡ˆå†…é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚');
      setStatus('HTTP 200 / æˆåŠŸï¼šãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚');
    }catch(e){
      console.error(e);
      setStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å¾Œã§ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
      speak('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }
  }
  function drawRoute(data){
    if(routeLine) routeLine.remove();
    const geom = data.routes[0].geometry;
    const coords = decodePolyline(geom); // [ [lat,lng], ... ]
    routeLine = L.polyline(coords,{color:'#4db2ff',weight:6,opacity:.9}).addTo(map);
    snappedPolyline = coords;
    stepIndex = 0;
  }
  function previewWholeRoute(data){
    const bounds = routeLine.getBounds();
    map.fitBounds(bounds, {padding:[40,40]});
  }

  // ====== ãƒŠãƒ“é–‹å§‹ ======
  let isNavigating=false;
  startNavBtn.addEventListener('click', ()=>{
    if(!routeData){ speak('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚'); return; }
    isNavigating = true; stepIndex = 0;
    setStatus('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
    speak('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚');
    // æœ€åˆã®æŒ‡ç¤ºã‚’å³æ™‚èª­ã¿ä¸Šã’
    const step = nextStep();
    if(step) speakStep(step);
    // ç¾åœ¨åœ°ã«ã‚«ãƒ¡ãƒ©å¾©å¸°
    if(lastPos) map.setView([lastPos.latitude,lastPos.longitude], 18);
  });

  function nextStep(){
    const steps = routeData?.routes?.[0]?.segments?.[0]?.steps || [];
    return steps[stepIndex] || null;
  }
  function speakStep(step){
    if(!step) return;
    let text = step.instruction || '';
    // ORSã®instructionã¯æ—¥æœ¬èªåŒ–æ¸ˆã¿ã€‚é€šã‚ŠåãŒã‚ã‚Œã°ä»˜ä¸ã€‚
    if(step.name && step.name !== '-') text = `${step.name}ã€${text}`;
    speak(text);
  }

  function onMoveDuringNav(lat,lon){
    if(!routeData || !snappedPolyline) return;

    // 1) ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆåˆ¤å®šï¼ˆ5mï¼‰
    const d = distancePointToPolyline([lat,lon], snappedPolyline);
    if(d > OFFROUTE_M){
      const now=Date.now();
      if(now - lastReroute > REROUTE_COOLDOWN_MS){
        lastReroute = now;
        speak('é€šã‚Šéãã¾ã—ãŸã€‚ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã™ã€‚');
        doReroute(lat,lon);
      }
      return;
    }

    // 2) æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«è¿‘ã¥ã„ãŸã‚‰ã‚¢ãƒŠã‚¦ãƒ³ã‚¹
    const step = nextStep();
    if(!step) return;
    const wpIndex = step.way_points?.[1] ?? null;
    if(wpIndex!=null && snappedPolyline[wpIndex]){
      const tgt = snappedPolyline[wpIndex];
      const dist = haversine(lat,lon,tgt[0],tgt[1]);
      if(dist < 12){ // ç›®æ¨™ç‚¹ã¾ã§12mã‚’åˆ‡ã£ãŸã‚‰æ¬¡ã¸
        stepIndex++;
        const nxt = nextStep();
        if(nxt) speakStep(nxt);
        else speak('ç›®çš„åœ°ä»˜è¿‘ã§ã™ã€‚æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚');
      }
    }
  }

  async function doReroute(lat,lon){
    startLat.value = lat.toFixed(6); startLon.value = lon.toFixed(6);
    await fetchRoute();
    if(lastPos) map.setView([lastPos.latitude,lastPos.longitude], 18);
    if(isNavigating){
      const st = nextStep(); if(st) speakStep(st);
    }
  }

  // ====== å„ãƒœã‚¿ãƒ³ ======
  routeBtn.addEventListener('click', fetchRoute);
  clearBtn.addEventListener('click', ()=>{
    q.value=''; resWrap.innerHTML=''; results.style.display='none';
    if(routeLine){ routeLine.remove(); routeLine=null; }
    routeData=null; stepIndex=0; setStatus('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
  });
  hereBtn.addEventListener('click', ()=>{
    if(lastPos) map.setView([lastPos.latitude, lastPos.longitude], 18);
  });
  destBtn.addEventListener('click', ()=>{
    if(destMarker) map.setView(destMarker.getLatLng(), 18);
  });
  rerouteBtn.addEventListener('click', ()=>{
    if(!lastPos){ speak('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚'); return; }
    doReroute(lastPos.latitude,lastPos.longitude);
  });

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
  document.getElementById('modeSeg').addEventListener('click', (e)=>{
    if(e.target.tagName!=='BUTTON') return;
    [...e.currentTarget.children].forEach(b=>b.classList.remove('on'));
    e.target.classList.add('on');
    currentProfile = e.target.dataset.mode;
  });

  // ====== æ¤œç´¢ï¼ˆNominatimï¼‰ ======
  searchBtn.addEventListener('click', runSearch);
  q.addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });

  async function runSearch(){
    const term = q.value.trim(); if(!term){ speak('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    let base = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=5&accept-language=ja&q=${encodeURIComponent(term)}`;
    if(lastPos){
      base += `&lat=${lastPos.latitude}&lon=${lastPos.longitude}`;
    }
    setStatus('æ¤œç´¢ä¸­...');
    const res = await fetch(base, {headers:{'Accept-Language':'ja','User-Agent':'workers-nav-demo'}});
    const list = await res.json();
    resWrap.innerHTML='';
    if(!list || !list.length){
      results.style.display='block'; resWrap.innerHTML='<div class="res">è©²å½“ãªã—</div>'; setStatus('è©²å½“ãªã—'); return;
    }
    results.style.display='block';
    list.forEach(it=>{
      const div = document.createElement('div');
      div.className='res';
      div.textContent = `${it.display_name}`;
      div.addEventListener('click', ()=>{
        map.setView([it.lat, it.lon], 18);
        setDest(parseFloat(it.lon), parseFloat(it.lat));
        results.style.display='none';
        speak('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚');
      });
      resWrap.appendChild(div);
    });
    setStatus('æ¤œç´¢çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚');
  }

  // éŸ³å£°å…¥åŠ›
  let rec=null;
  try{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SR){ rec = new SR(); rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1;
      mic.addEventListener('click', ()=>{
        rec.start(); setStatus('éŸ³å£°å…¥åŠ›ä¸­...');
      });
      rec.addEventListener('result', e=>{
        const text = e.results[0][0].transcript;
        q.value = text;
        setStatus(`éŸ³å£°å…¥åŠ›: ${text}`);
        runSearch();
      });
    }else{
      mic.disabled=true; mic.title='éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶';
    }
  }catch{ mic.disabled=true; }

  // ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text);
      u.lang='ja-JP'; u.rate=1.0; u.pitch=1.0; u.volume=1.0;
      window.speechSynthesis.speak(u);
    }catch{}
  }

  // Haversine(meter)
  function haversine(lat1,lon1,lat2,lon2){
    const R=6371000; const toRad=(d)=>d*Math.PI/180;
    const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }
  function bearing(lat1,lon1,lat2,lon2){
    const toRad=(d)=>d*Math.PI/180, toDeg=(r)=>r*180/Math.PI;
    const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
    const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2)) - Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
    let brng = toDeg(Math.atan2(y,x)); return (brng+360)%360;
  }
  // ç·šåˆ†è·é›¢ï¼ˆç‚¹â†’polyline ã®æœ€çŸ­è·é›¢ï¼‰
  function distancePointToPolyline(p, poly){
    let min=Infinity;
    for(let i=0;i<poly.length-1;i++){
      const d = distancePointToSegment(p, poly[i], poly[i+1]);
      if(d<min) min=d;
    }
    return min;
  }
  function distancePointToSegment(p,a,b){
    // p=[lat,lon], a=[lat,lon], b=[lat,lon]; è¿‘ä¼¼çš„ã«å¹³é¢ã§æŠ•å½±â†’è·é›¢ã‚’haversineã§è£œæ­£
    const toXY = (lat,lon)=>{
      const R=6371000, x=R*lon*Math.PI/180*Math.cos((a[0]+b[0])*Math.PI/360);
      const y=R*lat*Math.PI/180; return [x,y];
    };
    const P=toXY(p[0],p[1]), A=toXY(a[0],a[1]), B=toXY(b[0],b[1]);
    const AP=[P[0]-A[0],P[1]-A[1]], AB=[B[0]-A[0],B[1]-A[1]];
    const ab2=AB[0]*AB[0]+AB[1]*AB[1]; if(ab2===0) return haversine(p[0],p[1],a[0],a[1]);
    let t=(AP[0]*AB[0]+AP[1]*AB[1])/ab2; t=Math.max(0,Math.min(1,t));
    const proj=[A[0]+AB[0]*t, A[1]+AB[1]*t];
    // é€†å¤‰æ›ã¯ä¸è¦ã€è¿‘ä¼¼èª¤å·®ã¯å°ã•ã„ã®ã§ haversineã§ç«¯ç‚¹ã®ç·¯åº¦çµŒåº¦ã«è£œæ­£
    // è¿‘ã„ç‚¹ã‚’æ¨å®šã—ã¦è·é›¢
    const tLat=a[0]+(b[0]-a[0])*t, tLon=a[1]+(b[1]-a[1])*t;
    return haversine(p[0],p[1],tLat,tLon);
  }

  // polyline decode (ORSã¯googleEncoded)
  function decodePolyline(str){
    // return [ [lat,lng], ... ]
    let index=0, lat=0, lng=0, coordinates=[];
    while(index < str.length){
      let b, shift=0, result=0;
      do{ b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while(b >= 0x20);
      const dlat = ((result & 1) ? ~(result>>1) : (result>>1)); lat += dlat;
      shift=0; result=0;
      do{ b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while(b >= 0x20);
      const dlng = ((result & 1) ? ~(result>>1) : (result>>1)); lng += dlng;
      coordinates.push([lat * 1e-5, lng * 1e-5]);
    }
    return coordinates;
  }

  // ====== èµ·å‹• ======
  initGeolocation();
  setStatus('æº–å‚™å®Œäº†ã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„');

  // ç«¯æœ«æ–¹ä½ï¼ˆå¯èƒ½ãªã‚‰ä½¿ç”¨ï¼‰
  if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function'){
    // iOSç³»ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¾Œã«è¨±å¯ãŒå¿…è¦
    document.body.addEventListener('click', askDOEPerm, {once:true});
  }else if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', (e)=>{
      if(e.absolute && e.alpha!=null) updateCompass(360 - e.alpha); // alphaã¯æ™‚è¨ˆå›ã‚Š
    });
  }
  function askDOEPerm(){
    DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==='granted'){
        window.addEventListener('deviceorientation', (e)=>{
          if(e.absolute && e.alpha!=null) updateCompass(360 - e.alpha);
        });
      }
    }).catch(()=>{});
  }
</script>
</body>
</html>