<!-- =========================
     WalkNav å®Œå…¨å·®ã—æ›¿ãˆä¸€å¼ï¼ˆindex.html / app.css / app.jsï¼‰
     è¦ä»¶ï¼šç¾åœ¨åœ°å–å¾—å¾Œã«ã®ã¿åœ°å›³ã‚’è¡¨ç¤ºï¼ˆä»®è¡¨ç¤ºãªã—ï¼‰
     ========================= -->
<!-- index.html -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>WalkNav</title>
  <meta name="theme-color" content="#0e1a2d" />
  <link rel="stylesheet" href="./app.css" />
</head>
<body>
  <!-- Loading -->
  <div id="loading" class="loading-screen" aria-live="polite" aria-busy="true">
    <div class="loading-inner">
      <div class="loading-title">ç¾åœ¨åœ°å–å¾—ä¸­â€¦</div>
      <p class="loading-sub">
        ãƒ‡ãƒ¼ã‚¿é€šä¿¡æ–™å‰Šæ¸›ã®ãŸã‚ã€<br>
        ç¾åœ¨åœ°ã®åœ°å›³ã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚<br>
        ã‚‚ã†å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„â€¦
      </p>
    </div>
  </div>

  <div class="app" id="app">
    <div id="map" role="application" aria-label="åœ°å›³è¡¨ç¤ºã‚¨ãƒªã‚¢"></div>

    <div class="glassbar" id="glassbar">
      <div class="card">
        <div class="row">
          <input id="searchBox" class="grow" type="search" placeholder="ç›®çš„åœ°ã‚’æ¤œç´¢ï¼ˆä¾‹ï¼šæ±äº¬é§…ï¼‰" autocomplete="off" />
          <button id="micBtn" class="ok" aria-pressed="false" title="éŸ³å£°æ¤œç´¢">ğŸ¤ éŸ³å£°</button>
          <button id="searchBtn" class="primary" title="æ¤œç´¢">æ¤œç´¢</button>
          <button id="locBtn" class="ghost" title="ç¾åœ¨åœ°ã¸ç§»å‹•">ç¾åœ¨åœ°</button>
        </div>
        <div class="row">
          <div id="status" class="hint" aria-live="polite"></div>
        </div>
      </div>
    </div>

    <div class="comp-wrap">
      <div class="compass" aria-hidden="true">
        <svg viewBox="0 0 76 76" xmlns="http://www.w3.org/2000/svg">
          <circle cx="38" cy="38" r="35" fill="none" stroke="rgba(255,255,255,.25)" />
          <polygon class="needle" points="38,10 42,38 38,34 34,38" fill="#f45c5c"/>
          <text x="36" y="14">N</text>
        </svg>
      </div>
    </div>

    <!-- å³å´ãƒœã‚¿ãƒ³ã¯ Maps Controls API ã§å‹•çš„é…ç½®ï¼ˆHTMLã«ã¯ç½®ã‹ãªã„ï¼‰ -->

    <div id="error-banner" class="hidden error-banner">
      <span id="error-text"></span>
    </div>
  </div>

  <script src="./app.js" defer></script>
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&callback=initMap"></script>
</body>
</html>

<!-- app.css -->
<style>
:root{
  --glass: rgba(20,28,44,.54);
  --glass-strong: rgba(16,22,36,.68);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
  --mic-green:#0cb35a;
  --mic-red:#d53d3d;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Meiryo,sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none} /* â† å–å¾—å®Œäº†ã¾ã§åœ°å›³DOMã¯éè¡¨ç¤º */

/* Glass panel */
.glassbar{position:absolute;left:0;right:0;top:0;z-index:420;padding:10px 12px;pointer-events:none}
.card{pointer-events:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:16px;backdrop-filter: blur(14px) saturate(120%);-webkit-backdrop-filter: blur(14px) saturate(120%);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px 12px;width:min(1100px,96vw);margin:0 auto}
.row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.grow{flex:1 1 220px}
input,button{background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px;outline:none;min-height:44px}
button.primary{background:rgba(95,177,255,.92);border:none;font-weight:700}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button.reroute{background:var(--accent);border:none;color:#fff;font-weight:700}
button.reroute:hover{background:#00c2ff}
#micBtn{background:var(--mic-green)}
#micBtn.rec{background:var(--mic-red)}
.hint{color:var(--muted);font-size:13px}

/* Compass */
.comp-wrap{position:absolute;left:10px;top:150px;z-index:425;pointer-events:none}
.compass{width:90px;height:90px;background:var(--glass);border:1px solid var(--stroke);border-radius:50%;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 10px 26px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
.compass .needle{transform-origin:38px 38px}

/* Right controls container (mounted via Maps Controls API) */
.gm-fab-col{display:flex;flex-direction:column;gap:10px;transform:translateY(40px);z-index:430}
.gm-fab-col .btn-wide{min-width:150px;box-shadow:0 12px 26px rgba(0,0,0,.45);background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px}
.gm-fab-col .btn-wide.ok{background:var(--ok);border:none}
.gm-fab-col .btn-wide.danger{background:var(--danger);border:none}
.gm-fab-col .btn-wide.reroute{background:var(--accent);border:none;color:#fff}

/* Zoom buttons (smaller) */
.gm-fab-col .zooms{display:flex;flex-direction:column;gap:8px;align-items:center}
.gm-fab-col .btn-zoom{width:44px;height:44px;border-radius:8px;border:1px solid var(--stroke);background:var(--glass-strong);color:#fff;font-size:18px;line-height:44px;text-align:center;box-shadow:0 10px 20px rgba(0,0,0,.35)}

/* Loading overlay */
.loading-screen{position:fixed;inset:0;background:#0e1a2d;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:1;transition:opacity .4s}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-inner{text-align:center;padding:28px 24px}
.loading-title{font-size:26px;font-weight:900;color:#ffffff;margin-bottom:14px;letter-spacing:.02em}
.loading-sub{font-size:18px;line-height:1.7;color:#cfe0ff}
.loading-sub br{content:"";}

/* Error banner */
.error-banner{position:absolute;left:12px;right:12px;bottom:12px;z-index:999;background:#d53d3d;color:#fff;border-radius:10px;padding:10px 12px;text-align:center;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.hidden{display:none}
</style>

<!-- app.js -->
<script>
"use strict";

/* Globals */
let map, directionsService, directionsRenderer;
let currentPositionMarker = null, destinationMarker = null;
let watchId = null, isNavigating = false;
let recognition = null, recognizing = false;
let currentHeading = null;

let hasLocationFix = false;

const PLACES_PROXY = "https://ors-proxy.miyata-connect-jp.workers.dev/places";
const TRAVEL_MODE = google.maps.TravelMode.WALKING;

/* ====== Bootstrap ======
   è¦ä»¶ï¼šåœ°å›³ã¯ç¾åœ¨åœ°å–å¾—å¾Œã«ã®ã¿ç”Ÿæˆï¼ˆä»®è¡¨ç¤ºãªã—ï¼‰ */
function initMap() {
  setLoadingMessage();           // 3è¡Œãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
  showLoading(true);             // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º

  // å…ˆã«ç¾åœ¨åœ°ã‚’å–å¾—ã—ã€æˆåŠŸã—ãŸã‚‰åœ°å›³ã‚’åˆæœŸåŒ–
  if (!navigator.geolocation) {
    showError("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
    // åœ°å›³ã¯ç”Ÿæˆã—ãªã„ï¼ˆè¦ä»¶æº–æ‹ ï¼‰ã€‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯é–‰ã˜ã¦æ“ä½œå¯èƒ½åŒ–ã€‚
    showLoading(false);
    bindUI_NoMap(); // éŸ³å£°æ¤œç´¢ç­‰ã®UIã¯å‹•ãã‚ˆã†ã«ã™ã‚‹ï¼ˆæ¤œç´¢ã¯ã‚¨ãƒ©ãƒ¼è¿”å´ï¼‰
    return;
  }

  navigator.geolocation.getCurrentPosition(
    pos => {
      const here = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      hasLocationFix = true;
      createMap(here);           // â† ã“ã“ã§åˆã‚ã¦åœ°å›³ç”Ÿæˆ
      placeOrMoveCurrent(here);
      setStatus("ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸã€‚");
      startLocationWatch();
      setupCompass();
      showLoading(false);        // å®Œäº†ã—ãŸã‚‰ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆ
    },
    err => {
      showError("ç¾åœ¨åœ°å–å¾—å¤±æ•—: " + err.message);
      // åœ°å›³ã¯ç”Ÿæˆã—ãªã„ï¼ˆå–å¾—å¾Œã®ã¿è¡¨ç¤ºã®è¦ä»¶ã‚’éµå®ˆï¼‰
      showLoading(false);
      bindUI_NoMap();
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
}

/* ====== Map factory ====== */
function createMap(center) {
  const mapEl = document.getElementById("map");
  mapEl.style.display = "block"; // å–å¾—å¾Œã«ã®ã¿å¯è¦–åŒ–
  map = new google.maps.Map(mapEl, {
    center,
    zoom: 16,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false,
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer({ map });

  mountRightControls();
  bindUI();
}

/* ====== Controls on RIGHT_CENTER ====== */
let ctrlContainer;
function mountRightControls(){
  ctrlContainer = document.createElement("div");
  ctrlContainer.className = "gm-fab-col";

  const btnStart = document.createElement("button");
  btnStart.className = "btn-wide ok";
  btnStart.id = "gm-start-nav";
  btnStart.textContent = "æ¡ˆå†…é–‹å§‹";

  const btnStop = document.createElement("button");
  btnStop.className = "btn-wide danger";
  btnStop.id = "gm-stop-nav";
  btnStop.textContent = "æ¡ˆå†…ã‚’åœæ­¢";

  const btnReroute = document.createElement("button");
  btnReroute.className = "btn-wide reroute";
  btnReroute.id = "gm-reroute";
  btnReroute.textContent = "ãƒªãƒ«ãƒ¼ãƒˆ";

  const zooms = document.createElement("div");
  zooms.className = "zooms";
  const zIn = document.createElement("button");
  zIn.className = "btn-zoom";
  zIn.id = "gm-zoom-in";
  zIn.textContent = "ï¼‹";
  const zOut = document.createElement("button");
  zOut.className = "btn-zoom";
  zOut.id = "gm-zoom-out";
  zOut.textContent = "ï¼";
  zooms.append(zIn, zOut);

  ctrlContainer.append(btnStart, btnStop, btnReroute, zooms);
  map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(ctrlContainer);

  // æ¤œç´¢ãƒ‘ãƒãƒ«è¡¨ç¤ºä¸­ã¯å³åˆ—éè¡¨ç¤ºï¼ˆå¹²æ¸‰å›é¿ï¼‰
  const gb = q("#glassbar");
  const toggle = ()=> {
    const visible = gb && getComputedStyle(gb).display !== "none";
    if (ctrlContainer) ctrlContainer.style.display = visible ? "none" : "";
  };
  new MutationObserver(toggle).observe(document.body, { attributes:true, childList:true, subtree:true });
  addEventListener("resize", toggle);
  setTimeout(toggle, 100);
}

/* ====== UI binding ====== */
function bindUI() {
  q("#searchBtn").onclick = searchPlace;
  q("#micBtn").onclick = initVoiceRecognition;
  q("#locBtn").onclick = relocalize;
  q("#searchBox").addEventListener("keydown", e => { if (e.key === "Enter") searchPlace(); });

  document.addEventListener("click", (e)=>{
    const id = (e.target && e.target.id) || "";
    if (id === "gm-start-nav") startNav();
    else if (id === "gm-stop-nav") stopNav();
    else if (id === "gm-reroute") reroute(true);
    else if (id === "gm-zoom-in") map.setZoom(map.getZoom()+1);
    else if (id === "gm-zoom-out") map.setZoom(map.getZoom()-1);
  });
}

/* å–å¾—å¤±æ•—æ™‚ã§ã‚‚æœ€ä½é™ã®UIã‚¤ãƒ™ãƒ³ãƒˆã‚’ç”Ÿã‹ã™ï¼ˆæ¤œç´¢ã¯ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ */
function bindUI_NoMap(){
  q("#searchBtn") && (q("#searchBtn").onclick = () => showError("ç¾åœ¨åœ°å–å¾—å¾Œã«æ¤œç´¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚"));
  q("#micBtn") && (q("#micBtn").onclick = initVoiceRecognition);
  q("#locBtn") && (q("#locBtn").onclick = relocalize); // å†å–å¾—ãƒˆãƒ©ã‚¤
  q("#searchBox") && q("#searchBox").addEventListener("keydown", e => {
    if (e.key === "Enter") showError("ç¾åœ¨åœ°å–å¾—å¾Œã«æ¤œç´¢ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚");
  });
}

/* ====== ç¾åœ¨åœ°ï¼ˆæ‰‹å‹•å†å–å¾—ï¼‰ ====== */
function relocalize(){
  setStatus("ç¾åœ¨åœ°ã‚’å†å–å¾—ä¸­â€¦");
  if (!navigator.geolocation) { showError("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚"); return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      const here = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      hasLocationFix = true;
      if (!map) {
        createMap(here);
      }
      placeOrMoveCurrent(here);
      map.panTo(here);
      setStatus("ç¾åœ¨åœ°ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
      startLocationWatch();
    },
    err => showError("ç¾åœ¨åœ°å–å¾—å¤±æ•—: " + err.message),
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
}

/* ====== è¿½å¾“ ====== */
function startLocationWatch() {
  if (!navigator.geolocation) return;
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(
    pos => {
      const here = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      placeOrMoveCurrent(here);
      if (typeof pos.coords.heading === "number") currentHeading = pos.coords.heading;
      if (isNavigating) reroute(false);
    },
    err => console.warn("watchPosition error:", err.message),
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
}

/* ====== ãƒãƒ¼ã‚«ãƒ¼ ====== */
function placeOrMoveCurrent(latlng){
  if (!map) return;
  if (currentPositionMarker) {
    currentPositionMarker.setPosition(latlng);
  } else {
    currentPositionMarker = new google.maps.Marker({
      position: latlng,
      map,
      icon: { path: google.maps.SymbolPath.CIRCLE, scale: 8, fillColor: "#5fb1ff", fillOpacity: 1, strokeWeight: 1 },
      title: "ç¾åœ¨åœ°",
    });
  }
}

/* ====== æ¤œç´¢ï¼ˆPlaces New via Workerï¼‰ ====== */
async function searchPlace() {
  const qv = q("#searchBox")?.value.trim();
  if (!qv) return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  if (!hasLocationFix || !map) return showError("ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚");

  setStatus("æ¤œç´¢ä¸­â€¦");
  try {
    const pos = currentPositionMarker?.getPosition();
    const payload = {
      textQuery: qv,
      locationBias: pos ? { circle: { center: { latitude: pos.lat(), longitude: pos.lng() }, radius: 20000 } } : undefined,
    };

    const res = await fetch(PLACES_PROXY, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Goog-FieldMask": "places.displayName,places.location"
      },
      body: JSON.stringify(payload),
    });

    if (!res.ok) {
      console.warn("Places not OK:", res.status, await res.text().catch(()=> ""));
      setStatus("");
      return showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
    }

    const data = await res.json().catch(()=> ({}));
    const places = data?.places || [];
    if (!places.length) {
      setStatus("");
      return showError("è©²å½“ã™ã‚‹åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
    }

    const p = places[0];
    const lat = p.location?.latitude, lng = p.location?.longitude;
    const name = p.displayName?.text || qv;
    if (typeof lat !== "number" || typeof lng !== "number") {
      setStatus("");
      return showError("æ¤œç´¢çµæœã®ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚");
    }

    if (destinationMarker) destinationMarker.setMap(null);
    destinationMarker = new google.maps.Marker({ position: { lat, lng }, map, title: name });
    map.panTo({ lat, lng });
    setStatus(`æ¤œç´¢å®Œäº†: ${name}`);
  } catch (e) {
    console.error(e);
    setStatus("");
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}

/* ====== çµŒè·¯æ¡ˆå†… ====== */
function startNav() {
  if (!map || !currentPositionMarker || !destinationMarker)
    return showError("ç¾åœ¨åœ°ã¾ãŸã¯ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™ã€‚");

  const origin = currentPositionMarker.getPosition();
  const dest = destinationMarker.getPosition();
  setStatus("çµŒè·¯è¨ˆç®—ä¸­â€¦");

  directionsService.route(
    { origin, destination: dest, travelMode: TRAVEL_MODE, provideRouteAlternatives: true },
    (res, status) => {
      if (status !== "OK") return showError("çµŒè·¯ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚");
      directionsRenderer.setDirections(res);
      isNavigating = true;
      speak("æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
      setStatus("æ¡ˆå†…ä¸­");
    }
  );
}

function stopNav() {
  if (!map) return;
  directionsRenderer.setDirections({ routes: [] });
  isNavigating = false;
  speak("æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
  setStatus("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
}

function reroute(manual) {
  if (!map || !isNavigating) { if (manual) showError("æ¡ˆå†…ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"); return; }
  if (!currentPositionMarker || !destinationMarker) return;
  const origin = currentPositionMarker.getPosition();
  const dest = destinationMarker.getPosition();
  directionsService.route(
    { origin, destination: dest, travelMode: TRAVEL_MODE, provideRouteAlternatives: true },
    (res, status) => {
      if (status !== "OK") return showError("ãƒªãƒ«ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      directionsRenderer.setDirections(res);
      if (manual) speak("ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");
      setStatus("æ¡ˆå†…æ›´æ–°ä¸­");
    }
  );
}

/* ====== ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆå¹³æ»‘åŒ– + ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ====== */
let compassAlpha = 0, targetAlpha = 0, rAFId = null;
function setupCompass() {
  const needle = document.querySelector(".needle");
  if (!needle) return;

  function animate(){
    compassAlpha = compassAlpha * 0.8 + targetAlpha * 0.2;
    needle.style.transform = `rotate(${compassAlpha}deg)`;
    rAFId = requestAnimationFrame(animate);
  }
  rAFId = requestAnimationFrame(animate);

  const useAlpha = (a)=> { if (typeof a === "number") targetAlpha = a; };

  if (typeof DeviceOrientationEvent !== "undefined") {
    const handler = (e)=> { if (e && typeof e.alpha === "number") useAlpha(e.alpha); };
    window.addEventListener("deviceorientation", handler, { capture:false });
  }
  setInterval(()=>{ if (typeof currentHeading === "number") useAlpha(currentHeading); }, 300);
}

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
function q(sel){ return document.querySelector(sel); }
function setStatus(s){ const el=q("#status"); if(el) el.textContent=s||""; }
function showError(msg){
  const b=q("#error-banner"), t=q("#error-text");
  if(t) t.textContent=msg;
  if(b){ b.classList.remove("hidden"); setTimeout(()=>b.classList.add("hidden"),4000); }
  speak(msg);
}
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang="ja-JP"; u.rate=0.88; speechSynthesis.speak(u);}catch{} }
function showLoading(show){
  const el=document.getElementById("loading");
  if(!el) return;
  if(show){ el.classList.remove("hide"); el.style.display="flex"; }
  else { el.classList.add("hide"); setTimeout(()=>{ el.style.display="none"; }, 400); }
}
function setLoadingMessage(){
  const sub=document.querySelector(".loading-sub");
  if(sub){
    sub.innerHTML = `ãƒ‡ãƒ¼ã‚¿é€šä¿¡æ–™å‰Šæ¸›ã®ãŸã‚ã€<br>
      ç¾åœ¨åœ°ã®åœ°å›³ã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚<br>
      ã‚‚ã†å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„â€¦`;
  }
}

/* Expose */
window.initMap = initMap;
</script>
