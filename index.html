<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>æ­©è¡ŒãƒŠãƒ“ï¼ˆãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ç‰ˆãƒ»å˜ä¸€HTMLï¼‰</title>
  <style>
    :root{
      --bg:#0f1b2a; --panel:#1a2a3aee; --glass:#223547e6; --text:#eaf1ff;
      --muted:#a8b5c7; --accent:#5bb8ff; --danger:#ff6f6f; --ok:#2fd28f;
      --btn:#2a3d52; --shadow:0 8px 24px rgba(0,0,0,.25);
      --radius:16px;
    }
    /* åŸºæœ¬ï¼šåœ°å›³ã‚’å¸¸ã«å…¨é¢è¡¨ç¤ºï¼ˆåœ°å›³ãŒæ¶ˆãˆã‚‹äº‹æ•…ã‚’é˜²ãï¼‰ */
    html,body,#map{height:100%;margin:0;padding:0;}
    #map{position:fixed; inset:0; z-index:1;}

    /* æ“ä½œãƒ‘ãƒãƒ«ï¼ˆä¸‹ä»˜ãï¼ä¸‹æ–¹å‘ã«åç´ã€‚is-open ã®ã¨ãã ã‘è¦‹ãˆã‚‹ï¼‰ */
    .panel{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:10;
      max-width: 720px; margin:0 auto; background:var(--panel);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      color:var(--text); border-radius: var(--radius);
      box-shadow: var(--shadow); transform: translateY(110%);
      transition: transform .35s ease, opacity .2s ease;
      opacity:.0;
    }
    .panel.is-open{ transform: translateY(0); opacity:1; }
    .panel .row{display:flex; gap:12px; align-items:center;}
    .panel .field{
      flex:1; background:#0e1722; color:var(--text);
      border-radius:12px; padding:14px 16px; box-sizing:border-box;
      border:1px solid rgba(255,255,255,.08);
    }
    .panel h3{margin:8px 0 6px; font-size:14px; color:var(--muted); font-weight:600;}
    .chip-bar{display:flex; gap:12px; flex-wrap:wrap;}
    .chip{background:#1f3042; color:var(--text); padding:10px 14px; border-radius:999px; border:1px solid rgba(255,255,255,.08); font-weight:700}
    .chip.active{background:#4285f4; }
    .btn{border:0; border-radius:14px; padding:14px 16px; color:#fff; font-weight:800; letter-spacing:.02em; cursor:pointer; box-shadow: var(--shadow); background:var(--btn);}
    .btn.ok{background:var(--ok)}
    .btn.danger{background:var(--danger)}
    .btn.soft{background:#3a4d63}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
    .spacer{height:8px}
    .section{padding:16px}
    .bar{padding:12px 16px; background:var(--glass); border-radius: var(--radius) var(--radius) 0 0; font-size:20px; font-weight:900}
    .foot{padding:12px 16px 16px}

    /* ãƒ‘ãƒãƒ«å‘¼ã³å‡ºã—ã‚¿ãƒ–ï¼ˆç”»é¢åº•ä¸­å¤®ï¼ãƒ‘ãƒãƒ«åç´æ™‚ã®ã¿è¡¨ç¤ºï¼‰ */
    .panel-tab{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      z-index:9; background:#1f3042e6; color:#fff; border:0; padding:12px 18px;
      border-radius:999px; box-shadow: var(--shadow); font-weight:800;
    }
    /* ä»•æ§˜ï¼šãƒ‘ãƒãƒ«OPENä¸­ã¯ã‚¿ãƒ–ãƒ»ã‚³ãƒ³ãƒ‘ã‚¹ãƒ»åˆ‡æ›¿ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™ï¼ˆå¼·åˆ¶ï¼‰ */
    body.panel-open .panel-tab,
    body.panel-open .compass,
    body.panel-open .north-heading{ display:none !important; }

    /* ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆå·¦ä¸Šå›ºå®šï¼‰ */
    .compass-wrap{position:fixed; left:12px; top:12px; z-index:8;}
    .compass{
      width:92px; height:92px; border-radius:999px; background:#1c2736d9; 
      box-shadow: var(--shadow); position:relative; color:#fff;
    }
    .compass .tick{
      position:absolute; left:50%; top:50%; width:4px; height:32px; 
      background:#ff5252; transform-origin:50% 80%; transform:translate(-50%,-80%) rotate(0deg);
      border-radius:2px;
    }
    .compass .label{position:absolute; top:8px; left:50%; transform:translateX(-50%); font-weight:900; color:#ffd65c}
    /* ãƒãƒ¼ã‚¹ï¼ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°åˆ‡æ›¿ï¼ˆã‚³ãƒ³ãƒ‘ã‚¹ã®ä¸‹ãƒ»ãƒ‘ãƒãƒ«OPENæ™‚ã¯éè¡¨ç¤ºï¼‰ */
    .north-heading{
      position:fixed; left:12px; top:116px; z-index:8; display:flex; gap:8px;
    }
    .nh-btn{background:#1f3042e6; color:#fff; border:0; padding:8px 10px; border-radius:10px; font-weight:800;}

    /* å³å´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç¸¦ä¸¦ã³ï¼ˆãƒ‘ãƒãƒ«OPENæ™‚ã¯éè¡¨ç¤ºï¼‰ */
    .qa{ position:fixed; right:12px; top:34%; display:flex; flex-direction:column; gap:12px; z-index:7;}
    .qa .btn{min-width:140px}

    /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã¨éŸ³å£°ãƒœã‚¿ãƒ³è‰²ãƒ«ãƒ¼ãƒ«ï¼ˆç·‘â†’å¾…æ©Ÿã€èµ¤â†’éŒ²éŸ³ä¸­ï¼‰ */
    .mic{ background:#19c37d; }
    .mic.recording{ background:#ff4b4b; }

    /* ã¯ã¿å‡ºã—é˜²æ­¢ãƒ»å®‰å®šåŒ– */
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
    .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  </style>
</head>
<body data-spec="root">
  <div id="map" data-spec="map"></div>

  <!-- ã‚³ãƒ³ãƒ‘ã‚¹ï¼†åˆ‡æ›¿ -->
  <div class="compass-wrap">
    <div class="compass" id="compass" data-spec="compass">
      <div class="label">N</div>
      <div class="tick" id="needle"></div>
    </div>
  </div>
  <div class="north-heading" id="northHeadingBtns" data-spec="north-heading">
    <button class="nh-btn" id="btnNorth">ãƒãƒ¼ã‚¹ã‚¢ãƒƒãƒ—</button>
    <button class="nh-btn" id="btnHeading">ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒƒãƒ—</button>
  </div>

  <!-- å³å´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç¸¦ä¸¦ã³ï¼ä¸­å¤®ä»˜è¿‘ï¼‰ -->
  <div class="qa" id="qa" data-spec="qa">
    <button class="btn ok" id="startNav">æ¡ˆå†…é–‹å§‹</button>
    <button class="btn danger" id="stopNav">æ¡ˆå†…ã‚’åœæ­¢</button>
    <button class="btn soft" id="btnCurrent">ç¾åœ¨åœ°</button>
    <button class="btn soft" id="btnDest">ç›®çš„åœ°</button>
    <button class="btn soft" id="btnReroute">ãƒªãƒ«ãƒ¼ãƒˆ</button>
  </div>

  <!-- æ“ä½œãƒ‘ãƒãƒ«ï¼ˆä¸‹ä»˜ããƒ»ä¸‹æ–¹å‘ã«åç´ï¼‰ -->
  <div class="panel is-open" id="panel" data-spec="panel">
    <div class="bar nowrap">åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢</div>
    <div class="section">
      <div class="row">
        <input id="query" class="field" placeholder="ä¾‹ï¼šã‚³ãƒ³ãƒ“ãƒ‹ éŠ€åº§" />
        <button id="mic" class="btn mic" title="éŸ³å£°æ¤œç´¢">ğŸ™ éŸ³å£°</button>
      </div>
      <div class="spacer"></div>
      <div class="row">
        <button id="btnSearch" class="btn" style="background:#4285f4;">æ¤œç´¢</button>
        <button id="btnClear" class="btn soft">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="spacer"></div>
      <div class="chip-bar">
        <div class="chip active" id="aiShortest">æœ€çŸ­Ai</div>
        <div class="chip" id="aiEasy">æ¥½ãƒãƒ³Ai</div>
        <div class="chip" id="aiWalk">ãŠæ•£æ­©Ai</div>
      </div>

      <div class="spacer"></div>
      <div class="row" style="align-items:center; gap:8px;">
        <div class="chip soft" style="padding:10px 12px;">â–¶ è¨€èª / Language</div>
      </div>

      <div class="spacer"></div>
      <h3>é–‹å§‹åœ°ç‚¹</h3>
      <div class="grid2">
        <div class="field nowrap" id="curLng">ç¾åœ¨åœ°çµŒåº¦</div>
        <div class="field nowrap" id="curLat">ç¾åœ¨åœ°ç·¯åº¦</div>
      </div>

      <div class="spacer"></div>
      <h3>ç›®çš„åœ°ç‚¹</h3>
      <div class="grid2">
        <div class="field nowrap" id="dstLng">ç›®çš„åœ°çµŒåº¦</div>
        <div class="field nowrap" id="dstLat">ç›®çš„åœ°ç·¯åº¦</div>
      </div>

      <div class="spacer"></div>
      <div class="row">
        <select id="saved" class="field">
          <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
        </select>
        <button id="saveHere" class="btn ok">ç¾åœ¨åœ°ã‚’ä¿å­˜</button>
      </div>
    </div>
    <div class="foot row" style="justify-content:space-between;">
      <button id="setDest" class="btn" style="background:#5bb8ff;">ç›®çš„åœ°ã«è¨­å®š</button>
      <button id="btnDelete" class="btn danger">å‰Šé™¤</button>
      <button id="closePanel" class="btn soft">æ“ä½œãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ‘ãƒãƒ«å‘¼ã³å‡ºã—ã‚¿ãƒ–ï¼ˆåç´æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
  <button id="openTab" class="panel-tab" data-spec="panel-tab">â–² ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º</button>

  <script>
  /* ====== Google Maps åˆæœŸåŒ–ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰ ====== */
  let map, userMarker, destMarker;
  let headingMode = "north"; // 'north' or 'heading'
  let smoothHeading = 0;
  let lastHeading = 0;
  let watchId = null;

  window.initMap = function(){
    // ã¾ãšåœ°å›³ã ã‘ç¢ºå®Ÿã«è¡¨ç¤ºï¼ˆæ—¢å®šã‚»ãƒ³ã‚¿ãƒ¼ï¼‰ã€‚ç¾åœ¨åœ°ã¯æˆåŠŸå¾Œã«åæ˜ ã€‚
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 35.681236, lng: 139.767125}, // æ±äº¬é§…ã‚’ä»®ã‚»ãƒ³ã‚¿ï¼ˆåˆæœŸæç”»ç”¨ï¼‰
      zoom: 16,
      heading: 0,
      tilt: 0,
      mapId: "DEMO_MAP_ID" // ä»»æ„ã€‚æŒ‡å®šãŒç„¡ãã¦ã‚‚OK
    });

    // ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã‹ã‚‰ã‚»ãƒ³ã‚¿ï¼ˆè¦ç´„ï¼šåˆæœŸè¡¨ç¤ºã¯ç¾åœ¨åœ°ï¼‰
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const p = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        map.setCenter(p);
        placeOrMoveUser(p);
        updateCurText(p);
      }, err=>{
        console.warn("Geolocation error:", err);
      }, {enableHighAccuracy:true, timeout:12000, maximumAge:0});
      // è¿½å¾“
      watchId = navigator.geolocation.watchPosition(pos=>{
        const p = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        placeOrMoveUser(p);
        updateCurText(p);
        if(headingMode === "heading") applyHeading(lastHeading);
      }, e=>{}, {enableHighAccuracy:true, timeout:12000, maximumAge:5000});
    }

    wireUI();
    specLock();
    hookDeviceHeading();
  };

  function placeOrMoveUser(p){
    if(!userMarker){
      userMarker = new google.maps.Marker({position:p, map, title:"ç¾åœ¨åœ°"});
    }else{
      userMarker.setPosition(p);
    }
  }
  function updateCurText(p){
    document.getElementById('curLat').textContent = p.lat.toFixed(6);
    document.getElementById('curLng').textContent = p.lng.toFixed(6);
  }

  /* ====== UI é…ç·š ====== */
  function wireUI(){
    const body = document.body;
    const panel = document.getElementById('panel');
    const openTab = document.getElementById('openTab');
    const closePanel = document.getElementById('closePanel');

    // ãƒ‘ãƒãƒ«é–‹é–‰
    const open = ()=>{ panel.classList.add('is-open'); body.classList.add('panel-open'); };
    const close = ()=>{ panel.classList.remove('is-open'); body.classList.remove('panel-open'); };
    openTab.addEventListener('click', open);
    closePanel.addEventListener('click', close);

    // åˆæœŸçŠ¶æ…‹ã¯ã€Œé–‹ã„ã¦ã„ã‚‹ã€â†’ ä»•æ§˜ã§ã‚³ãƒ³ãƒ‘ã‚¹ç­‰ã¯è‡ªå‹•ã§éè¡¨ç¤º

    // å³å´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ãƒãƒ«OPENä¸­ã¯CSSã§éè¡¨ç¤ºï¼‰
    document.getElementById('btnCurrent').addEventListener('click', ()=>{
      if(userMarker){ map.panTo(userMarker.getPosition()); map.setZoom(18); }
    });
    document.getElementById('btnDest').addEventListener('click', ()=>{
      if(destMarker){ map.panTo(destMarker.getPosition()); map.setZoom(18); }
    });

    // ç›®çš„åœ°è¨­å®šã¯ç¾åœ¨åœ°ï¼‹å°‘ã—ã‚ªãƒ•ã‚»ãƒƒãƒˆã®ãƒ‡ãƒ¢
    document.getElementById('setDest').addEventListener('click', ()=>{
      const c = map.getCenter();
      const p = {lat: c.lat()+0.0008, lng: c.lng()+0.0008};
      if(!destMarker){ destMarker = new google.maps.Marker({position:p, map, title:"ç›®çš„åœ°", icon: {path:google.maps.SymbolPath.BACKWARD_CLOSED_ARROW, scale:6, fillColor:"#5bb8ff", fillOpacity:1, strokeWeight:0}}); }
      else destMarker.setPosition(p);
      document.getElementById('dstLat').textContent = p.lat.toFixed(6);
      document.getElementById('dstLng').textContent = p.lng.toFixed(6);
    });

    // ãƒãƒ¼ã‚¹ï¼ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°
    document.getElementById('btnNorth').addEventListener('click', ()=>{
      headingMode = "north"; map.setHeading(0);
    });
    document.getElementById('btnHeading').addEventListener('click', ()=>{
      headingMode = "heading"; applyHeading(lastHeading);
    });

    // éŸ³å£°æ¤œç´¢ï¼ˆç·‘â†’èµ¤â†’ç·‘ï¼‰
    const mic = document.getElementById('mic');
    mic.addEventListener('click', ()=>{
      if(window.webkitSpeechRecognition){
        const rec = new webkitSpeechRecognition();
        rec.lang = "ja-JP";
        mic.classList.add('recording');
        rec.onresult = (e)=>{ 
          const t = e.results[0][0].transcript || "";
          document.getElementById('query').value = t;
        };
        rec.onend = ()=>{ mic.classList.remove('recording'); };
        rec.onerror = ()=>{ mic.classList.remove('recording'); };
        rec.start();
      }else{
        // éå¯¾å¿œç«¯æœ«ã§ã‚‚è‰²ãƒ«ãƒ¼ãƒ«ã ã‘ä¿ã¤
        mic.classList.add('recording');
        setTimeout(()=>mic.classList.remove('recording'), 1200);
      }
    });

    // æ¤œç´¢ãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒ¢ï¼šåœ°å›³ä¸­å¤®ã«ãƒ”ãƒ³ï¼‰
    document.getElementById('btnSearch').addEventListener('click', ()=>{
      const c = map.getCenter();
      placeOrMoveUser({lat:c.lat(), lng:c.lng()});
    });

    // ãƒªãƒ«ãƒ¼ãƒˆï¼ˆé¸æŠå¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®éª¨çµ„ã¿ï¼‰
    document.getElementById('btnReroute').addEventListener('click', ()=>{
      const mode = prompt("ãƒªãƒ«ãƒ¼ãƒˆ\n1) æœ€çŸ­Ai\n2) æ¥½ãƒãƒ³Ai\n3) ãŠæ•£æ­©Ai\nç•ªå·ã§é¸æŠ");
      if(!mode) return;
      let msg = "";
      if(mode==="1") msg = "æœ€çŸ­AIã‚’é¸æŠã€‚æœ€çŸ­ãƒ«ãƒ¼ãƒˆã§æ¡ˆå†…ã—ã¾ã™ã€‚";
      else if(mode==="2") msg = "æ¥½ãƒãƒ³AIã‚’é¸æŠã€‚èº«ä½“ã«å„ªã—ã„ãƒ«ãƒ¼ãƒˆã§æ¡ˆå†…ã—ã¾ã™ã€‚";
      else if(mode==="3") msg = "ãŠæ•£æ­©AIã‚’é¸æŠã€‚é å›ã‚Šã®æ•£æ­©ãƒ«ãƒ¼ãƒˆã§æ¡ˆå†…ã—ã¾ã™ã€‚";
      if(msg) speak(msg);
    });

    // æ¡ˆå†…ã®é–‹å§‹/åœæ­¢ï¼ˆéŸ³å£°ã ã‘ï¼‰
    document.getElementById('startNav').addEventListener('click', ()=>speak("é¸æŠã—ãŸãƒ«ãƒ¼ãƒˆã§æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚å®‰å…¨ã®ãŸã‚æ­©é“ã‚’é€šè¡Œã—ã¦ãã ã•ã„ã€‚"));
    document.getElementById('stopNav').addEventListener('click', ()=>speak("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚"));
  }

  /* ====== æ–¹ä½ï¼šã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°ï¼‹è¡¨ç¤º ====== */
  function hookDeviceHeading(){
    const needle = document.getElementById('needle');
    const smooth = (a,b,alpha)=> a + alpha * (b - a);
    window.addEventListener('deviceorientationabsolute', handle, true);
    window.addEventListener('deviceorientation', handle, true);

    function handle(ev){
      let h = ev.alpha; // 0..360 (åŒ—=0)
      if(typeof h !== "number") return;
      lastHeading = h;
      // é‡ï¼ˆåŒ—æŒ‡ã™ï¼‰ï¼šç”»é¢ä¸Šã¯åŒ—å›ºå®šè¡¨ç¤ºãªã®ã§ãã®ã¾ã¾
      smoothHeading = smooth(smoothHeading, h, 0.15);
      needle.style.transform = `translate(-50%,-80%) rotate(${smoothHeading}deg)`;
      if(headingMode === "heading") applyHeading(h);
    }
  }
  function applyHeading(h){
    try{
      map.setHeading(360 - h); // ãƒ‡ãƒã‚¤ã‚¹ãŒåŒ—=0ã§æ™‚è¨ˆå›ã‚Šã€Mapã¯åŒ—å›ºå®šâ†’é€†å›è»¢
    }catch(e){}
  }

  /* ====== éŸ³å£°ï¼ˆç°¡æ˜“ï¼‰ ====== */
  function speak(text){
    try{
      const u = new SpeechSynthesisUtterance(text.replace("æœ€çŸ­Ai","ã•ã„ãŸã‚“ã‚¨ãƒ¼ã‚¢ã‚¤"));
      u.lang = "ja-JP"; speechSynthesis.cancel(); speechSynthesis.speak(u);
    }catch(e){}
  }

  /* ====== ä»•æ§˜ãƒ­ãƒƒã‚¯ï¼ˆå£Šã‚ŒãŸã‚‰å³æ°—ã¥ãï¼‰ ====== */
  function specLock(){
    const req = [
      ['[data-spec="map"]', 'åœ°å›³DOMãŒç„¡ã„'],
      ['[data-spec="panel"]', 'æ“ä½œãƒ‘ãƒãƒ«ãŒç„¡ã„'],
      ['[data-spec="panel-tab"]', 'ãƒ‘ãƒãƒ«å‘¼ã³å‡ºã—ã‚¿ãƒ–ãŒç„¡ã„'],
      ['[data-spec="compass"]', 'ã‚³ãƒ³ãƒ‘ã‚¹ãŒç„¡ã„'],
      ['[data-spec="north-heading"]', 'ãƒãƒ¼ã‚¹/ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ãŒç„¡ã„'],
      ['[data-spec="qa"]', 'å³å´ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç„¡ã„'],
    ];
    setInterval(()=>{
      for(const [sel,msg] of req){
        if(!document.querySelector(sel)){
          console.error('SPEC VIOLATION:', msg, sel);
        }
      }
      // ãƒ‘ãƒãƒ«OPENæ™‚ã®éè¡¨ç¤ºãƒ«ãƒ¼ãƒ«å¼·åˆ¶ï¼ˆCSSã§ã‚‚ !important æ¸ˆã¿ã ãŒäºŒé‡åŒ–ï¼‰
      const open = document.getElementById('panel').classList.contains('is-open');
      document.body.classList.toggle('panel-open', open);
    }, 1000);
  }
  </script>

  <!-- â˜…ã‚ãªãŸã®APIã‚­ãƒ¼ã‚’ã“ã® query ã® key= ã®ç®‡æ‰€ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ -->
  <script defer src="https://maps.googleapis.com/maps/api/js?key=<YOUR_BROWSER_API_KEY_HERE>&callback=initMap"></script>
</body>
</html>