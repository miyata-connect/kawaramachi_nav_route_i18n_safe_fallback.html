<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  :root{
    --bg:#0f2048; --panel:#163063; --panel2:#122a58;
    --text:#f4f8ff; --muted:#cfe0ff;
    --accent:#3ab0ff; --accent2:#2a8fff;
    --ok:#21d79a; --warn:#ff835c; --danger:#ff5d5d;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0f214a 60%,var(--bg));color:var(--text);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Yu Gothic Medium","Hiragino Kaku Gothic ProN",sans-serif}
  h1{font-size:22px;font-weight:800;letter-spacing:.04em;margin:14px 16px 8px}

  .bar{display:flex;gap:8px;align-items:center;padding:10px 12px;margin:0 12px 10px;border-radius:14px;background:var(--panel);
       border:1px solid rgba(255,255,255,.08);flex-wrap:wrap}
  .bar input[type="text"]{flex:1 1 240px;min-width:180px;padding:12px 14px;border-radius:12px;background:#0f2552;
       border:1px solid rgba(255,255,255,.08);color:var(--text);outline:none}

  .btn{appearance:none;border:0;background:linear-gradient(180deg,var(--accent),var(--accent2));color:#fff;font-weight:800;
       border-radius:12px;padding:12px 16px;cursor:pointer;box-shadow:0 6px 16px rgba(42,143,255,.35)}
  .btn.secondary{background:linear-gradient(180deg,#1e4396,#193c86);box-shadow:0 6px 14px rgba(28,85,176,.35)}
  .btn.warn{background:linear-gradient(180deg,#ff996c,#ff7b47);box-shadow:0 6px 16px rgba(255,122,71,.35)}
  .btn:disabled{opacity:.45;cursor:not-allowed}

  .grid{display:grid;gap:8px;margin:0 12px}
  .grid.cols3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid.cols{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:840px){ .grid.cols3{grid-template-columns:1fr} }

  .pill{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px 12px}
  .pill label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  .pill input{width:100%;padding:10px 12px;border-radius:10px;background:#0f2552;border:1px solid rgba(255,255,255,.08);color:var(--text)}

  .seg{display:inline-flex;background:#0e2550;border:1px solid rgba(255,255,255,.1);border-radius:10px;overflow:hidden}
  .seg button{padding:8px 12px;border:0;background:transparent;color:#eaf1ff;font-weight:800}
  .seg button.on{background:#2050b0;color:#fff}

  .status{margin:10px 16px;font-size:14px;color:#e8f0ff}
  .status .muted{color:var(--muted)}

  #results{margin:6px 16px;border-radius:12px;overflow:hidden;max-height:0;transition:max-height .28s ease,padding .28s ease,border .28s ease}
  #results.open{background:var(--panel);border:1px solid rgba(255,255,255,.1);max-height:48vh}
  #results h3{font-size:14px;color:#eaf1ff;margin:12px}
  .res{padding:10px 12px;border-top:1px dashed rgba(255,255,255,.15);cursor:pointer}
  .res:hover{background:#17336c}

  /* ãƒãƒƒãƒ—é«˜ã•ã¯ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆä¾å­˜ã€‚çµæœãƒ‘ãƒãƒ«ã‚’é–‹é–‰ã—ã¦ã‚‚è¦‹åˆ‡ã‚Œãªã„ã‚ˆã†60vhå›ºå®š */
  #map{height:60vh;margin:8px 12px 12px;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.1);position:relative}
  .leaflet-bottom.leaflet-left .leaflet-control{margin-left:10px;margin-bottom:10px}

  /* å³ä¸‹FABã€‚ä¸‹ã«ååˆ†ãªä½™ç™½ï¼ˆå®‰å…¨é ˜åŸŸå¯¾å¿œï¼‰ */
  .fabcol{position:absolute;right:14px;bottom:calc(env(safe-area-inset-bottom, 0px) + 28px);
          display:flex;flex-direction:column;gap:12px;z-index:420}
  .fab{min-width:124px;text-align:center;border-radius:16px;padding:12px 16px;font-weight:800;color:#fff;
       background:linear-gradient(180deg,#1f52ca,#1a48ad);border:0;box-shadow:0 10px 22px rgba(31,82,202,.38);cursor:pointer}
  .fab.ok{background:linear-gradient(180deg,#1ec88f,#18a571);box-shadow:0 10px 22px rgba(24,165,113,.38)}
  .fab.warn{background:linear-gradient(180deg,#ff6b6b,#e64b4b);box-shadow:0 10px 22px rgba(255,107,107,.38)}

  .helper{margin:6px 16px 2px;color:#d7e6ff;font-size:14px}
  .helper b{color:#fff}

  /* æ–¹ä½è¨ˆï¼ˆå³ä¸Šå›ºå®šãƒ»å°å‹ãƒ»ã‚¹ãƒ ãƒ¼ã‚ºï¼‰ */
  #compass{position:absolute;top:10px;right:10px;z-index:460;width:66px;height:66px;border-radius:50%;
    background:radial-gradient(ellipse at center,#133267 0%,#102b5d 60%,#0f2857 100%); border:1px solid rgba(255,255,255,.16);
    box-shadow:0 10px 24px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;user-select:none;pointer-events:none}
  #ring{position:absolute;inset:5px;border-radius:50%;border:2px solid rgba(255,255,255,.18);box-shadow:inset 0 0 10px rgba(0,0,0,.45)}
  .tick{position:absolute;width:2px;height:9px;background:#8fbeff;top:5px;left:50%;transform-origin:50% 26px;opacity:.9}
  .tick.big{height:12px;background:#d3e6ff}
  #needle{position:absolute;left:50%;top:10px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:26px solid #ff5959;transform:translateX(-50%) rotate(0deg);transform-origin:50% 28px;filter:drop-shadow(0 0 6px rgba(255,90,90,.45));transition:transform .18s ease}
  #tail{position:absolute;left:50%;bottom:10px;width:0;height:0;border-left:5px solid transparent;border-right:5px solid transparent;border-bottom:18px solid #58c7ff;transform:translateX(-50%) rotate(0deg);transform-origin:50% -20px;opacity:.95;transition:transform .18s ease}
  .dir{position:absolute;font-size:10px;color:#fff;font-weight:800;letter-spacing:.06em;text-shadow:0 1px 2px rgba(0,0,0,.35)}
  .dir.n{top:6px;left:50%;transform:translateX(-50%)}
  .dir.s{bottom:6px;left:50%;transform:translateX(-50%)}
  .dir.e{right:6px;top:50%;transform:translateY(-50%)}
  .dir.w{left:6px;top:50%;transform:translateY(-50%)}
  #headingLabel{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);font-size:10px;color:#fff;background:#1b4497;padding:1px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.2)}
  #headingLabel.bad{background:#7b2b2b;border-color:#ff9a9a;color:#ffecec}
</style>
</head>
<body>
  <h1>Cloudflare Workers ãƒŠãƒ“</h1>

  <!-- æ¤œç´¢ -->
  <div class="bar">
    <input id="q" type="text" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢ï¼ˆç¾åœ¨åœ°è¿‘ãã‹ã‚‰5ä»¶ï¼‰"/>
    <button id="mic" class="btn secondary" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
    <button id="search" class="btn">æ¤œç´¢</button>
  </div>

  <!-- å…¥åŠ› -->
  <div class="grid cols3">
    <div class="pill">
      <label>é–‹å§‹åœ°ç‚¹ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="grid cols">
        <input id="startLon" placeholder="çµŒåº¦"/>
        <input id="startLat" placeholder="ç·¯åº¦"/>
      </div>
    </div>
    <div class="pill">
      <label>ç›®çš„åœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="grid cols">
        <input id="endLon" placeholder="çµŒåº¦"/>
        <input id="endLat" placeholder="ç·¯åº¦"/>
      </div>
    </div>
    <div class="pill">
      <label>ãƒ¢ãƒ¼ãƒ‰</label>
      <div class="seg" id="modeSeg">
        <button data-mode="foot-walking" class="on">å¾’æ­©</button>
        <button data-mode="wheelchair">è»Šæ¤…å­</button>
      </div>
      <div style="margin-top:8px;color:#eaf1ff;font-size:13px">è¨€èªï¼š<b>æ—¥æœ¬èª</b></div>
    </div>
  </div>

  <!-- æ“ä½œ -->
  <div class="bar" style="justify-content:flex-start">
    <button id="routeBtn" class="btn">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
    <button id="clearBtn" class="btn secondary">ã‚¯ãƒªã‚¢</button>
    <div class="helper"><b>åœ°å›³ã‚’é•·æŠ¼ã—</b>ã™ã‚‹ã¨ç›®çš„åœ°ã«è¨­å®šã§ãã¾ã™</div>
  </div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
  <div id="status" class="status">æº–å‚™å®Œäº†ã€‚<span class="muted">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</span></div>

  <!-- æ¤œç´¢çµæœï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æŠ¼ã—ä¸‹ã’ãªã„æŠ˜ã‚ŠãŸãŸã¿ï¼‰ -->
  <div id="results">
    <h3>æ¤œç´¢çµæœï¼ˆè¿‘ã„é † ä¸Šä½5ä»¶ï¼‰</h3>
    <div id="resWrap"></div>
  </div>

  <!-- ãƒãƒƒãƒ— -->
  <div id="map">
    <!-- æ–¹ä½è¨ˆ -->
    <div id="compass" aria-hidden="true">
      <div id="ring"></div>
      <div class="tick big" style="transform:translateX(-50%) rotate(0deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(30deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(60deg)"></div>
      <div class="tick big" style="transform:translateX(-50%) rotate(90deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(120deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(150deg)"></div>
      <div class="tick big" style="transform:translateX(-50%) rotate(180deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(210deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(240deg)"></div>
      <div class="tick big" style="transform:translateX(-50%) rotate(270deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(300deg)"></div>
      <div class="tick" style="transform:translateX(-50%) rotate(330deg)"></div>
      <div id="needle"></div><div id="tail"></div>
      <div class="dir n">N</div><div class="dir s">S</div><div class="dir e">E</div><div class="dir w">W</div>
      <div id="headingLabel">N/A</div>
    </div>

    <!-- å³ä¸‹FAB -->
    <div class="fabcol">
      <button id="startNav" class="fab ok" disabled>æ¡ˆå†…é–‹å§‹</button>
      <button id="hereBtn" class="fab">ç¾åœ¨åœ°</button>
      <button id="destBtn" class="fab">ç›®çš„åœ°</button>
      <button id="rerouteBtn" class="fab warn">ãƒªãƒ«ãƒ¼ãƒˆ</button>
    </div>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // ====== è¨­å®š ======
  const WORKER_ENDPOINT = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
  const OFFROUTE_M = 5;                 // 5mã§ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆ
  const REROUTE_COOLDOWN_MS = 15000;    // é€£ç™ºæŠ‘æ­¢
  const SEARCH_RADIUS_KM = 25;          // è¿‘å‚æ¤œç´¢ã®åŠå¾„
  let currentProfile = 'foot-walking';

  // ====== è¦ç´  ======
  const $ = s => document.querySelector(s);
  const q = $('#q'), mic = $('#mic'), searchBtn = $('#search');
  const startLon=$('#startLon'), startLat=$('#startLat'), endLon=$('#endLon'), endLat=$('#endLat');
  const routeBtn=$('#routeBtn'), clearBtn=$('#clearBtn');
  const hereBtn=$('#hereBtn'), destBtn=$('#destBtn'), rerouteBtn=$('#rerouteBtn'), startNavBtn=$('#startNav');
  const statusEl=$('#status'); const results=$('#results'), resWrap=$('#resWrap');

  // ====== åœ°å›³ ======
  const map = L.map('map',{zoomControl:true}); map.zoomControl.setPosition('bottomleft');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'<a href="https://www.openstreetmap.org/copyright">Â© OpenStreetMap contributors</a>'}).addTo(map);

  let meMarker=L.marker([0,0]).addTo(map);
  let destMarker=null, routeLine=null, watchId=null, lastPos=null;
  let routeData=null, stepIndex=0, snappedPolyline=null, lastReroute=0, hasRoutedOnce=false;

  // é•·æŠ¼ã—ã§ç›®çš„åœ°
  map.on('contextmenu', e=> setDestAndMaybeAutoRoute(e.latlng.lng, e.latlng.lat));

  function setStatus(t){ statusEl.textContent=t; }
  function setDest(lon,lat){
    endLon.value=lon.toFixed(6); endLat.value=lat.toFixed(6);
    if(destMarker) destMarker.remove();
    destMarker=L.marker([lat,lon],{draggable:true}).addTo(map);
    destMarker.on('dragend', e=>{const ll=e.target.getLatLng(); endLon.value=ll.lng.toFixed(6); endLat.value=ll.lat.toFixed(6);});
  }
  function setDestAndMaybeAutoRoute(lon,lat){
    setDest(lon,lat);
    setStatus('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã™â€¦');
    // åˆå›ã¯è‡ªå‹•ã§ãƒ«ãƒ¼ãƒˆå–å¾—
    if(isFinite(parseFloat(startLon.value)) && isFinite(parseFloat(startLat.value))){
      fetchRoute(true /*auto*/);
    }else{
      setStatus('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸã€‚ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…ã£ã¦ã„ã¾ã™â€¦');
    }
  }

  // ç¾åœ¨åœ°åˆæœŸåŒ– + ã‚¦ã‚©ãƒƒãƒ
  function initGeolocation(){
    if(!navigator.geolocation){ map.setView([35,135],5); setStatus('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); return; }
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude, longitude, heading, speed}=pos.coords;
      meMarker.setLatLng([latitude, longitude]);
      startLat.value=latitude.toFixed(6); startLon.value=longitude.toFixed(6);
      map.setView([latitude, longitude],17); lastPos=pos.coords;
      updateHeadingFromGPS(pos.coords); // æ–¹ä½åˆæœŸåŒ–
      // ã‚‚ã—ç›®çš„åœ°ãŒã™ã§ã«å…¥ã£ã¦ã„ã‚Œã°è‡ªå‹•ãƒ«ãƒ¼ãƒˆ
      if(endLat.value && endLon.value && !hasRoutedOnce) fetchRoute(true);
    }, _=>{ map.setView([35,135],5); setStatus('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'); },
    {enableHighAccuracy:true, maximumAge:0, timeout:10000});

    if(watchId) navigator.geolocation.clearWatch(watchId);
    watchId=navigator.geolocation.watchPosition(pos=>{
      const {latitude, longitude}=pos.coords;
      lastPos=pos.coords; meMarker.setLatLng([latitude, longitude]);
      updateHeadingFromGPS(pos.coords);
      if(isNavigating) onMoveDuringNav(latitude, longitude);
    }, _=>{}, {enableHighAccuracy:true, maximumAge:1000, timeout:15000});
  }

  // ====== æ–¹ä½è¨ˆï¼šGPSé€²è¡Œæ–¹ä½ã‚’å„ªå…ˆã€åœæ­¢æ™‚ã¯ç«¯æœ«æ–¹ä½ã€‚EMAã§å¹³æ»‘åŒ– ======
  const needle=document.getElementById('needle'), tail=document.getElementById('tail'), headingLabel=document.getElementById('headingLabel');
  let lastHeadingDeg=null, lastCompassUpdate=0;
  function setNeedle(deg){
    if(typeof deg!=='number'||isNaN(deg)) { headingLabel.textContent='N/A'; headingLabel.classList.add('bad'); return; }
    headingLabel.classList.remove('bad'); headingLabel.textContent=`${Math.round((deg+360)%360)}Â°`;
    needle.style.transform=`translateX(-50%) rotate(${deg}deg)`;
    tail.style.transform=`translateX(-50%) rotate(${deg}deg)`;
  }
  function smoothHeading(newDeg){
    const now=Date.now(); if(now-lastCompassUpdate<200) return; // ãƒ¬ãƒ¼ãƒˆåˆ¶é™
    lastCompassUpdate=now;
    if(lastHeadingDeg==null){ lastHeadingDeg=newDeg; setNeedle(newDeg); return; }
    // è§’åº¦å·®ï¼ˆæœ€çŸ­çµŒè·¯ï¼‰
    let delta=((newDeg-lastHeadingDeg+540)%360)-180;
    // æ€¥æ¿€ãªã‚¸ãƒ£ãƒ³ãƒ—ã¯æŠ‘åˆ¶ï¼ˆåœæ­¢æ™‚ã®èª¤å·®ãªã©ï¼‰
    const maxJump=60; if(Math.abs(delta)>maxJump) delta=Math.sign(delta)*maxJump;
    lastHeadingDeg=(lastHeadingDeg + delta*0.18 + 360)%360;
    setNeedle(lastHeadingDeg);
  }
  function updateHeadingFromGPS(c){
    // å„ªå…ˆï¼šcourseï¼ˆé€Ÿåº¦ãŒã‚ã‚‹å ´åˆï¼‰ã€æ¬¡ç‚¹ï¼šç›´è¿‘2ç‚¹ã‹ã‚‰ã®æ–¹ä½
    if(typeof c.heading==='number' && !isNaN(c.heading) && (c.speed??0) > 0.5){
      smoothHeading(c.heading);
    }else{
      const b=bearingFromHistory(c);
      if(b!=null) smoothHeading(b);
    }
  }
  let lastHist=null;
  function bearingFromHistory(c){ if(!lastHist){ lastHist=c; return null; } const d=haversine(lastHist.latitude,lastHist.longitude,c.latitude,c.longitude); if(d<2){ return null; } const b=bearing(lastHist.latitude,lastHist.longitude,c.latitude,c.longitude); lastHist=c; return b; }

  // ç«¯æœ«æ–¹ä½ã¯ã€Œåœæ­¢æ™‚ã®ã¿ã®è£œåŠ©ã€ï¼†ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°
  if(window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission==='function'){
    document.body.addEventListener('click', ()=>{ DeviceOrientationEvent.requestPermission().then(state=>{
      if(state==='granted'){ window.addEventListener('deviceorientation', e=>{ if(e.absolute && e.alpha!=null && (!lastPos || (lastPos.speed??0)<0.3)){ const hd=(360-e.alpha+360)%360; smoothHeading(hd);} }); }
    }).catch(()=>{}); }, {once:true});
  }else if(window.DeviceOrientationEvent){
    window.addEventListener('deviceorientation', e=>{ if(e.absolute && e.alpha!=null && (!lastPos || (lastPos.speed??0)<0.3)){ const hd=(360-e.alpha+360)%360; smoothHeading(hd);} });
  }

  // ====== ãƒ«ãƒ¼ãƒˆå–å¾—ï¼ˆwheelchairåˆ¶ç´„ & ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ======
  async function fetchRoute(auto=false){
    const slon=parseFloat(startLon.value), slat=parseFloat(startLat.value);
    const elon=parseFloat(endLon.value), elat=parseFloat(endLat.value);
    if(!isFinite(slon)||!isFinite(slat)||!isFinite(elon)||!isFinite(elat)){ setStatus('é–‹å§‹åœ°ç‚¹ã¨ç›®çš„åœ°ã®åº§æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }

    // UIãƒ­ãƒƒã‚¯
    routeBtn.disabled=true; startNavBtn.disabled=true;

    const payload = { coordinates:[[slon,slat],[elon,elat]], instructions:true, language:'ja' };
    if(currentProfile==='wheelchair'){
      payload.options = {
        avoid_features: ['steps'],
        profile_params: { restrictions: { wheelchair: { maximum_slope: 6, maximum_kerb_height: 0.03 } } }
      };
    }

    setStatus(auto?'åˆå›ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦':'ãƒ«ãƒ¼ãƒˆã‚’å•ã„åˆã‚ã›ä¸­â€¦');
    try{
      const res=await fetch(`${WORKER_ENDPOINT}?profile=${encodeURIComponent(currentProfile)}`,{
        method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const data=await res.json(); handleRoute(data,true,auto);
    }catch(e){
      if(currentProfile==='wheelchair' && payload.options){
        try{
          const res2=await fetch(`${WORKER_ENDPOINT}?profile=${encodeURIComponent(currentProfile)}`,{
            method:'POST', headers:{'Content-Type':'application/json'},
            body:JSON.stringify({coordinates:payload.coordinates,instructions:true,language:'ja'})
          });
          if(!res2.ok) throw new Error(`HTTP ${res2.status}`);
          const data2=await res2.json();
          handleRoute(data2,false,auto);
          setStatus('ä¸€éƒ¨åˆ¶ç´„ãŒæœªå¯¾å¿œã®ãŸã‚æ¨™æº–ã®è»Šæ¤…å­ãƒ«ãƒ¼ãƒˆã§å†è©¦è¡Œã—ã¾ã—ãŸã€‚');
        }catch(_e){ setStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); speak('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); routeBtn.disabled=false; return; }
      }else{
        setStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); speak('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'); routeBtn.disabled=false; return;
      }
    }
  }
  function handleRoute(data, strictOptions, auto){
    routeData=data; drawRoute(data); previewWholeRoute();
    const modeText=currentProfile==='wheelchair' ? (strictOptions?'è»Šæ¤…å­ï¼ˆæ®µå·®ãƒ»æ€¥å‹¾é…å›é¿ï¼‰':'è»Šæ¤…å­') : 'å¾’æ­©';
    hasRoutedOnce=true;
    setStatus(`HTTP 200 / æˆåŠŸï¼š${modeText}ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚`);
    // æ¡ˆå†…é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ï¼ˆå–å¾—å®Œäº†ã¾ã§ã¯ç„¡åŠ¹åŒ–ã—ã¦ã„ãŸã®ã§èª¤æ¡ˆå†…ãªã—ï¼‰
    startNavBtn.disabled=false; routeBtn.disabled=false;
    // è‡ªå‹•ãƒ«ãƒ¼ãƒˆæ™‚ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã«è»½ãã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
    if(auto){ speak('ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸã€‚æ¡ˆå†…é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚'); }
  }
  function drawRoute(data){
    if(routeLine) routeLine.remove();
    const coords=decodePolyline(data.routes[0].geometry);
    routeLine=L.polyline(coords,{color:'#67caff',weight:7,opacity:.95}).addTo(map);
    snappedPolyline=coords; stepIndex=0;
  }
  function previewWholeRoute(){ if(routeLine){ map.fitBounds(routeLine.getBounds(),{padding:[40,40]}); } }

  // ====== æ¡ˆå†… ======
  let isNavigating=false;
  startNavBtn.addEventListener('click', ()=>{
    if(!routeData){ setStatus('ãƒ«ãƒ¼ãƒˆæº–å‚™ä¸­ã§ã™â€¦'); return; } // ã“ã“ã§ã¯å–‹ã‚‰ãªã„ï¼ˆèª¤æ¡ˆå†…é˜²æ­¢ï¼‰
    isNavigating=true; stepIndex=0;
    const modeText=currentProfile==='wheelchair'?'è»Šæ¤…å­ãƒ«ãƒ¼ãƒˆ':'å¾’æ­©ãƒ«ãƒ¼ãƒˆ';
    setStatus(`æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ${modeText}ï¼‰ã€‚`); speak(`æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚${modeText}ã§ã™ã€‚`);
    const st=nextStep(); if(st) speakStep(st);
    if(lastPos) map.setView([lastPos.latitude,lastPos.longitude],18);
  });
  function nextStep(){ return routeData?.routes?.[0]?.segments?.[0]?.steps?.[stepIndex] ?? null; }
  function speakStep(step){ if(!step) return; let t=step.instruction||''; if(step.name && step.name!=='-') t=`${step.name}ã€${t}`; speak(t); }

  function onMoveDuringNav(lat,lon){
    if(!routeData || !snappedPolyline) return;
    const d=distancePointToPolyline([lat,lon],snappedPolyline);
    if(d>OFFROUTE_M){
      const now=Date.now(); if(now-lastReroute>REROUTE_COOLDOWN_MS){ lastReroute=now; speak('é€šã‚Šéãã¾ã—ãŸã€‚ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã™ã€‚'); doReroute(lat,lon); }
      return;
    }
    const step=nextStep(); if(!step) return;
    const wpIndex=step.way_points?.[1] ?? null;
    if(wpIndex!=null && snappedPolyline[wpIndex]){
      const tgt=snappedPolyline[wpIndex];
      const dist=haversine(lat,lon,tgt[0],tgt[1]);
      if(dist<12){ stepIndex++; const n=nextStep(); if(n) speakStep(n); else speak('ç›®çš„åœ°ä»˜è¿‘ã§ã™ã€‚æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚'); }
    }
  }
  async function doReroute(lat,lon){
    startLat.value=lat.toFixed(6); startLon.value=lon.toFixed(6);
    await fetchRoute(); if(lastPos) map.setView([lastPos.latitude,lastPos.longitude],18);
    if(isNavigating){ const st=nextStep(); if(st) speakStep(st); }
  }

  // ã‚¯ãƒªãƒƒã‚¯ç¾¤
  routeBtn.addEventListener('click', ()=>fetchRoute(false));
  clearBtn.addEventListener('click', ()=>{
    q.value=''; resWrap.innerHTML=''; results.classList.remove('open');
    if(routeLine){ routeLine.remove(); routeLine=null; } routeData=null; stepIndex=0; startNavBtn.disabled=true;
    setStatus('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
    // FABãŒè¦‹ãˆã‚‹ã‚ˆã†ãƒãƒƒãƒ—ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.getElementById('map').scrollIntoView({behavior:'smooth',block:'end'});
  });
  hereBtn.addEventListener('click', ()=>{ if(lastPos) map.setView([lastPos.latitude,lastPos.longitude],18); });
  destBtn.addEventListener('click', ()=>{ if(destMarker) map.setView(destMarker.getLatLng(),18); });
  rerouteBtn.addEventListener('click', ()=>{ if(!lastPos){ speak('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“ã€‚'); return; } doReroute(lastPos.latitude,lastPos.longitude); });

  // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ï¼ˆå¾’æ­© / è»Šæ¤…å­ï¼‰
  document.getElementById('modeSeg').addEventListener('click',(e)=>{
    if(e.target.tagName!=='BUTTON') return;
    [...e.currentTarget.children].forEach(b=>b.classList.remove('on'));
    e.target.classList.add('on'); currentProfile=e.target.dataset.mode;
  });

  // ====== æ¤œç´¢ï¼šç¾åœ¨åœ°åŠå¾„25kmã«é™å®šï¼†è¿‘ã„5ä»¶ ======
  searchBtn.addEventListener('click', runSearch);
  q.addEventListener('keydown', e=>{ if(e.key==='Enter') runSearch(); });

  async function runSearch(){
    const term=q.value.trim(); if(!term){ speak('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
    if(!lastPos){ speak('ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚'); setStatus('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦ å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'); return; }

    const lat=lastPos.latitude, lon=lastPos.longitude;
    const box=viewboxAround(lat,lon,SEARCH_RADIUS_KM);
    let url=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=10&accept-language=ja`+
            `&q=${encodeURIComponent(term)}`+
            `&viewbox=${box.left},${box.top},${box.right},${box.bottom}&bounded=1`+
            `&countrycodes=jp&addressdetails=1`;
    setStatus('æ¤œç´¢ä¸­â€¦ï¼ˆç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„é †ã«è¡¨ç¤ºï¼‰');
    const res=await fetch(url,{headers:{'Accept-Language':'ja','User-Agent':'workers-nav-demo'}});
    const list=await res.json();

    const enriched=(list||[]).map(it=>{
      const d=haversine(lat,lon,parseFloat(it.lat),parseFloat(it.lon));
      return {...it, _dist:d};
    }).sort((a,b)=>a._dist-b._dist).slice(0,5);

    resWrap.innerHTML=''; if(enriched.length){ results.classList.add('open'); } else { results.classList.remove('open'); }
    if(!enriched.length){ resWrap.innerHTML='<div class="res">è©²å½“ãªã—ï¼ˆç¾åœ¨åœ°è¿‘å‚ï¼‰</div>'; setStatus('è©²å½“ãªã—'); return; }

    enriched.forEach(it=>{
      const km=(it._dist/1000).toFixed(it._dist<10000?2:1);
      const div=document.createElement('div'); div.className='res';
      div.textContent=`${it.display_name}ï¼ˆç´„${km}kmï¼‰`;
      div.addEventListener('click', ()=>{
        results.classList.remove('open');
        map.setView([it.lat,it.lon],18);
        setDestAndMaybeAutoRoute(parseFloat(it.lon),parseFloat(it.lat));
      });
      resWrap.appendChild(div);
    });
    setStatus('æ¤œç´¢çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚');
  }

  function viewboxAround(lat,lon,km){
    const dLat=km/111; const dLon=km/(111*Math.cos(lat*Math.PI/180));
    return { left:(lon-dLon).toFixed(6), right:(lon+dLon).toFixed(6),
             top:(lat+dLat).toFixed(6), bottom:(lat-dLat).toFixed(6) };
  }

  // ====== éŸ³å£° ======
  let rec=null;
  try{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(SR){ rec=new SR(); rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1;
      mic.addEventListener('click', ()=>{ rec.start(); setStatus('éŸ³å£°å…¥åŠ›ä¸­...'); });
      rec.addEventListener('result', e=>{ const text=e.results[0][0].transcript; q.value=text; setStatus(`éŸ³å£°å…¥åŠ›: ${text}`); runSearch(); });
    }else{ mic.disabled=true; mic.title='éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶'; }
  }catch{ mic.disabled=true; }

  // ====== å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; u.rate=1.0; u.pitch=1.0; u.volume=1.0; speechSynthesis.speak(u);}catch{} }
  function haversine(lat1,lon1,lat2,lon2){ const R=6371000,toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
    const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
  function bearing(lat1,lon1,lat2,lon2){ const toRad=d=>d*Math.PI/180,toDeg=r=>r*180/Math.PI;
    const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
    const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
    return (toDeg(Math.atan2(y,x))+360)%360; }
  function distancePointToPolyline(p,poly){ let min=Infinity; for(let i=0;i<poly.length-1;i++){ const d=distancePointToSegment(p,poly[i],poly[i+1]); if(d<min) min=d; } return min; }
  function distancePointToSegment(p,a,b){ const toXY=(lat,lon)=>{ const R=6371000,x=R*lon*Math.PI/180*Math.cos((a[0]+b[0])*Math.PI/360); const y=R*lat*Math.PI/180; return [x,y]; };
    const P=toXY(p[0],p[1]),A=toXY(a[0],a[1]),B=toXY(b[0],b[1]); const AP=[P[0]-A[0],P[1]-A[1]],AB=[B[0]-A[0],B[1]-A[1]];
    const ab2=AB[0]*AB[0]+AB[1]*AB[1]; if(ab2===0) return haversine(p[0],p[1],a[0],a[1]);
    let t=(AP[0]*AB[0]+AP[1]*AB[1])/ab2; t=Math.max(0,Math.min(1,t));
    const tLat=a[0]+(b[0]-a[0])*t, tLon=a[1]+(b[1]-a[1])*t; return haversine(p[0],p[1],tLat,tLon);
  }
  function decodePolyline(str){ let index=0,lat=0,lng=0,coordinates=[];
    while(index<str.length){ let b,shift=0,result=0;
      do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
      const dlat=((result&1)?~(result>>1):(result>>1)); lat+=dlat; shift=0; result=0;
      do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
      const dlng=((result&1)?~(result>>1):(result>>1)); lng+=dlng; coordinates.push([lat*1e-5,lng*1e-5]);}
    return coordinates;}

  // èµ·å‹•
  initGeolocation();
</script>
</body>
</html>