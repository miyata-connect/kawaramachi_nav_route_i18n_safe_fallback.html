<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.88);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;z-index:0}
    .overlay{
      position:absolute;left:12px;right:12px;top:12px;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px);
      z-index:10; pointer-events:auto;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{
      position:fixed;right:12px;bottom:18px;display:flex;flex-direction:column;gap:14px;
      z-index:9999; pointer-events:none;
    }
    .btn{
      width:96px;height:96px;border-radius:24px;background:rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25);pointer-events:auto;
    }
    .toast{
      position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;
      border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:10000;
    }
    .result-panel{
      position:absolute;left:0;right:0;bottom:0;background:var(--glass-strong);
      backdrop-filter:blur(10px);border-top:1px solid var(--stroke);
      padding:10px 16px;max-height:50%;overflow-y:auto;display:none;z-index:20;
    }
    .result-item{
      border:1px solid var(--stroke);border-radius:12px;padding:10px 14px;margin:8px 0;
      background:rgba(255,255,255,.06);
    }
    .result-title{font-weight:bold;font-size:1.1em}
    .result-address{font-size:.9em;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div id="panel" class="overlay">
      <div class="row">
        <strong id="panel-title">Set your destination</strong>
        <span id="coord" style="font-variant-numeric:tabular-nums;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
    </div>

    <div class="pill">
      <button id="btn-current" class="btn" title="Current">Current</button>
      <button id="btn-search" class="btn" title="Search">Search</button>
      <button id="btn-stop" class="btn" title="Stop">Stop</button>
      <button id="btn-dest" class="btn" title="Destination">Dest</button>
      <button id="btn-reroute" class="btn" title="Reroute">Reroute</button>
      <button id="btn-ops" class="btn" title="Ops">Ops</button>
    </div>

    <div id="results" class="result-panel"></div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    // Toast helper
    const toast = (msg, ok=false)=>{
      const el=document.getElementById("toast");
      el.style.background=ok?"#25d07a":"#ff6b6b";
      el.textContent=msg;
      el.style.display="block";
      clearTimeout(el._t);
      el._t=setTimeout(()=>{el.style.display="none"},3000);
    };

    // Wait for Google Maps
    async function waitForGoogleMaps(timeout=15000){
      const start=performance.now();
      while(performance.now()-start<timeout){
        if(window.google && google.maps && google.maps.importLibrary){return true;}
        await new Promise(r=>setTimeout(r,50));
      }
      throw new Error("Google Maps failed to load");
    }

    // Cloudflare proxy function
    async function cfPlacesSearchText(body){
      const r=await fetch("https://ors-proxy.miyata-connect-jp.workers.dev/places:searchText",{
        method:"POST",
        headers:{
          "Origin":"https://miyata-connect.github.io",
          "Content-Type":"application/json"
        },
        body:JSON.stringify(body)
      });
      if(!r.ok) throw new Error("Places API error");
      return await r.json();
    }

    // Main logic
    let map,marker;
    let currentPos={lat:35.681236,lng:139.767125};

    try{
      await waitForGoogleMaps();
      const {Map}=await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");

      map=new Map(document.getElementById("map"),{
        center:currentPos,zoom:15,mapId:"DEMO_MAP",disableDefaultUI:true,
      });
      marker=new AdvancedMarkerElement({map,position:currentPos});

      const setCoord=p=>{
        document.getElementById("coord").textContent=`Lat: ${p.lat.toFixed(6)} / Lng: ${p.lng.toFixed(6)}`;
      };
      setCoord(currentPos);

      const getLocation=()=>new Promise((res,rej)=>{
        if(!navigator.geolocation)return rej(new Error("Geolocation unsupported"));
        navigator.geolocation.getCurrentPosition(
          pos=>res({lat:pos.coords.latitude,lng:pos.coords.longitude}),
          err=>rej(new Error(err.message||"Location error")),
          {enableHighAccuracy:true,timeout:10000,maximumAge:0}
        );
      });

      try{
        currentPos=await getLocation();
        map.setCenter(currentPos);
        marker.position=currentPos;
        setCoord(currentPos);
        toast("Location updated",true);
      }catch(e){toast(`Location error: ${e.message}`);}

      document.getElementById("btn-current").addEventListener("click",async()=>{
        try{
          const p=await getLocation();
          currentPos=p;map.setCenter(p);marker.position=p;setCoord(p);
          toast("Centered to current position",true);
        }catch(e){toast(`Location error: ${e.message}`);}
      });

      // Search button
      document.getElementById("btn-search").addEventListener("click",async()=>{
        const q=prompt("Search text (e.g., Ramen Tokushima):");
        if(!q)return;
        toast("Searching...",true);
        try{
          const res=await cfPlacesSearchText({
            textQuery:q,
            languageCode:"ja",
            regionCode:"JP",
            pageSize:5,
            locationBias:{
              circle:{
                center:currentPos,
                radius:10000 // 10km radius
              }
            }
          });
          const panel=document.getElementById("results");
          panel.innerHTML="";
          if(res.places && res.places.length>0){
            res.places.slice(0,5).forEach(p=>{
              const div=document.createElement("div");
              div.className="result-item";
              div.innerHTML=`<div class="result-title">${p.displayName?.text||"Unknown"}</div>
              <div class="result-address">${p.formattedAddress||""}</div>`;
              panel.appendChild(div);
            });
            panel.style.display="block";
            toast(`${res.places.length} results found`,true);
          }else{
            panel.style.display="none";
            toast("No results found");
          }
        }catch(e){
          toast("Search error: "+e.message);
        }
      });

      ["btn-stop","btn-dest","btn-reroute","btn-ops"].forEach(id=>{
        document.getElementById(id).addEventListener("click",()=>toast(`${id} tapped`));
      });

    }catch(e){
      console.error(e);
      toast("Map init error: "+e.message);
    }
  </script>
</body>
</html>
