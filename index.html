<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v5.2</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}

/* control panel */
.control-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:0;
  z-index:500;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:16px 16px 0 0;
  backdrop-filter:blur(14px);
  padding:16px;
  transition:transform 0.3s;
}
.control-panel.hidden{transform:translateY(100%)}
.panel-toggle{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  border:none;
  border-radius:12px;
  padding:14px 40px;
  color:#000;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  z-index:490;
  display:none;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.panel-toggle.show{display:block}
.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.panel-btn{
  flex:1;
  min-width:120px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:10px;
  color:#fff;
  font-size:14px;
  text-align:center;
  cursor:pointer;
  font-weight:700;
}
.panel-btn.primary{background:var(--primary);border:none;color:#000}
.panel-btn.recording{background:var(--danger);border:none;color:#fff}
.panel-btn.danger{background:var(--danger);border:none;color:#fff}
input,select{
  width:100%;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  color:var(--text);
  border-radius:10px;
  padding:10px;
  font-size:14px;
}

/* language row */
.lang-row{
  display:flex;
  justify-content:center;
  margin-bottom:10px;
}
.lang-row select{
  width:100%;
  text-align:center;
}

/* info panel */
.info-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:10px;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  backdrop-filter:blur(14px);
  padding:14px 14px 18px 14px;
  z-index:460;
  color:var(--text);
  display:none;
}
.info-panel.show{display:block}
.route-main{
  font-size:18px;
  font-weight:700;
  margin-bottom:10px;
  line-height:1.4;
  text-align:center;
}
.route-time{
  font-size:16px;
  color:var(--text);
  display:flex;
  gap:20px;
  font-weight:600;
  margin-bottom:12px;
  justify-content:center;
}
.route-time span{
  display:flex;
  align-items:center;
  gap:4px;
}
.weather-row{
  display:flex;
  align-items:center;
  gap:10px;
}
.location-name{
  font-size:16px;
  font-weight:700;
  color:var(--primary);
  white-space:nowrap;
}
.weather-items{
  display:flex;
  gap:4px;
  flex:1;
  justify-content:center;
  align-items:center;
}
.weather-arrow{
  color:var(--muted);
  font-size:18px;
  font-weight:900;
}
.weather-item{
  text-align:center;
  font-size:11px;
  color:var(--text);
  padding:6px 4px;
  background:var(--glass-strong);
  border-radius:8px;
  min-width:48px;
}
.weather-icon{font-size:20px;margin:2px 0}
.weather-temp{font-weight:700;font-size:13px}
.weather-rain{color:var(--accent);font-size:11px;font-weight:700}

/* right nav buttons */
.nav-buttons{
  position:absolute;
  right:10px;
  top:200px;
  bottom:100px;
  z-index:450;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}
.nav-buttons.hidden{display:none}
.nav-btn{
  width:70px;
  height:60px;
  min-height:60px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#000;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:700;
  flex-direction:column;
  gap:2px;
  flex-shrink:0;
}
.nav-btn.compass-btn{position:relative}
.compass-n{
  position:absolute;
  top:6px;
  font-size:10px;
  font-weight:700;
  color:var(--danger);
}
.nav-btn.primary{background:var(--primary);border:none}
.nav-btn.ok{background:var(--ok);border:none}
.nav-btn.danger{background:var(--danger);border:none;color:#fff}
.nav-btn.accent{background:var(--accent);border:none}
.nav-btn.active{background:var(--ok);border:2px solid #fff}

/* left buttons group */
.left-buttons{
  position:absolute;
  left:10px;
  top:200px;
  z-index:450;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.left-buttons.hidden{display:none}

/* location button */
.location-btn{
  position:fixed;
  right:10px;
  bottom:10px;
  width:70px;
  height:70px;
  background:var(--accent);
  border:none;
  border-radius:10px;
  color:#000;
  font-size:20px;
  cursor:pointer;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:460;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}

/* map control cluster */
.map-controls{
  position:fixed;
  right:90px;
  bottom:100px;
  z-index:450;
  display:none;
  gap:8px;
}
.map-controls.show{
  display:flex;
  flex-direction:column;
  align-items:center;
}
.map-control-row{display:flex;gap:8px}
.map-control-btn{
  width:50px;
  height:50px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#fff;
  font-size:20px;
  cursor:pointer;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
}
.map-control-btn:active{background:var(--primary)}

/* results */
.results-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  max-height:60vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:510;
  display:none;
}
.result-item{
  padding:10px;
  border-bottom:1px solid var(--stroke);
  cursor:pointer;
}
.result-item:hover{background:rgba(95,177,255,.2)}
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

/* saved points */
.saved-points-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  max-height:70vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:510;
  display:none;
}

/* route select */
.route-select-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:20px;
  z-index:515;
  display:none;
}
.route-select-title{
  font-size:18px;
  font-weight:700;
  text-align:center;
  margin-bottom:20px;
  color:var(--text);
}
.route-select-btn{
  width:100%;
  padding:16px;
  background:var(--primary);
  border:none;
  border-radius:10px;
  color:#000;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  margin-bottom:10px;
  text-align:center;
}
.route-select-btn:last-child{background:var(--accent)}

.saved-point-item{
  padding:12px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:8px;
  margin-bottom:8px;
  cursor:pointer;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.saved-point-item:hover{background:rgba(95,177,255,.3)}
.saved-point-name{flex:1}
.saved-point-actions{display:flex;gap:6px}
.saved-point-btn{
  padding:4px 10px;
  background:var(--primary);
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  color:#000;
  font-weight:700;
}
.saved-point-btn.delete{background:var(--danger);color:#fff}
.saved-close{text-align:center;padding:10px;color:var(--primary);cursor:pointer;font-weight:700}

.error-banner{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--danger);
  color:#fff;
  border-radius:10px;
  padding:10px;
  text-align:center;
  z-index:999;
}
.hidden{display:none}
.loading-screen{
  position:fixed;
  inset:0;
  background:#0e1a2d;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  transition:opacity 0.3s;
}
.loading-screen.hide{opacity:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    
    <!-- info panel -->
    <div id="infoPanel" class="info-panel show">
      <div class="route-main" id="routeText">Please set destination</div>
      <div class="route-time">
        <span>üïê <span id="timeLabel">Current</span>: <span id="currentTime">--:--</span></span>
        <span>üéØ <span id="arrivalLabel">Arrival</span>: <span id="arrivalTime">--:--</span></span>
      </div>
      <div class="weather-row">
        <div class="location-name" id="locationName">Loading...</div>
        <div class="weather-items">
          <div class="weather-item">
            <div>3H</div>
            <div class="weather-icon" id="w3h">‚òÄÔ∏è</div>
            <div class="weather-temp" id="t3h">--¬∞</div>
            <div class="weather-rain" id="r3h">--%</div>
          </div>
          <div class="weather-arrow">‚Üí</div>
          <div class="weather-item">
            <div>6H</div>
            <div class="weather-icon" id="w6h">‚òÅÔ∏è</div>
            <div class="weather-temp" id="t6h">--¬∞</div>
            <div class="weather-rain" id="r6h">--%</div>
          </div>
          <div class="weather-arrow">‚Üí</div>
          <div class="weather-item">
            <div>9H</div>
            <div class="weather-icon" id="w9h">üåßÔ∏è</div>
            <div class="weather-temp" id="t9h">--¬∞</div>
            <div class="weather-rain" id="r9h">--%</div>
          </div>
          <div class="weather-arrow">‚Üí</div>
          <div class="weather-item">
            <div>12H</div>
            <div class="weather-icon" id="w12h">‚òÅÔ∏è</div>
            <div class="weather-temp" id="t12h">--¬∞</div>
            <div class="weather-rain" id="r12h">--%</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- left button group (compass / N-UP / H-UP) -->
    <div id="leftButtons" class="left-buttons">
      <div class="nav-btn compass-btn" id="compassBtn">
        <div class="compass-n">N</div>
        <svg width="40" height="40" viewBox="0 0 50 50" style="margin-top:8px">
          <path id="compassNeedle" d="M25 5 L27 25 L25 23 L23 25 Z" fill="#ff6565" stroke="#fff" stroke-width="1"/>
          <circle cx="25" cy="25" r="2.5" fill="#5fb1ff" stroke="#fff" stroke-width="1.5"/>
        </svg>
      </div>
      <div class="nav-btn" id="nupBtn" onclick="setNorthUp()" style="color:#fff">N-UP</div>
      <div class="nav-btn active" id="hupBtn" onclick="setHeadingUp()" style="color:#fff">H-UP</div>
    </div>
    
    <!-- right nav buttons -->
    <div id="navButtons" class="nav-buttons">
      <div class="nav-btn primary" onclick="goToCurrent()"><span id="btnCurrent">Current</span></div>
      <div class="nav-btn primary" onclick="goToDestination()"><span id="btnDest">Dest</span></div>
      <div class="nav-btn danger" onclick="stopNav()"><span id="btnStop">Stop<br>Nav</span></div>
      <div class="nav-btn accent" onclick="rerouteWithSelection()"><span id="btnReroute">Reroute</span></div>
      <div class="nav-btn primary" id="quickVoiceBtn" onclick="quickVoiceSearch()"><span id="btnVoiceNav">Voice<br>Nav</span></div>
    </div>
    
    <!-- location button -->
    <button class="location-btn" onclick="toggleMapControls()">
      <svg width="32" height="32" viewBox="0 0 48 48">
        <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="2.5" fill="none"/>
        <polygon points="24,6 21,16 27,16" fill="currentColor"/>
        <polygon points="24,42 21,32 27,32" fill="currentColor"/>
        <polygon points="6,24 16,21 16,27" fill="currentColor"/>
        <polygon points="42,24 32,21 32,27" fill="currentColor"/>
        <circle cx="24" cy="24" r="5" fill="currentColor"/>
      </svg>
    </button>
    
    <!-- map controls -->
    <div id="mapControls" class="map-controls">
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panUp()">‚Üë</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panLeft()">‚Üê</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomIn()">+</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomOut()">‚àí</div>
        <div class="map-control-btn" onclick="event.preventDefault();panRight()">‚Üí</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panDown()">‚Üì</div>
      </div>
    </div>
    
    <!-- control panel -->
    <div id="controlPanel" class="control-panel hidden">
      <div style="text-align:center;font-size:15px;color:var(--text);font-weight:700;margin-bottom:12px;background:var(--glass-strong);padding:10px;border-radius:8px" id="coordsDisplay">
        üìç Lat: ---.------ / Lng: ---.------
      </div>
      
      <input id="searchBox" placeholder="Search by name, address, or phone" style="margin-bottom:10px">
      
      <div class="panel-row">
        <div class="panel-btn primary" onclick="searchPlace()"><span id="btnSearch">Search</span></div>
        <div class="panel-btn primary" id="voiceBtn" onclick="voiceSearch()"><span id="btnVoice">Voice</span></div>
        <div class="panel-btn" onclick="clearSearch()"><span id="btnClear">Clear</span></div>
      </div>
      
      <div class="panel-row" id="stopNavRow" style="display:none">
        <div class="panel-btn danger" onclick="stopNavFromPanel()" style="width:100%"><span id="btnStopNav">Stop Navigation</span></div>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="saveCurrentPoint()"><span id="btnSaveCurrent">Save Current</span></div>
        <div class="panel-btn" onclick="saveMapPoint()"><span id="btnSaveMap">Save on Map</span></div>
        <div class="panel-btn" onclick="showSavedPoints()"><span id="btnShowSaved">Saved</span></div>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="editSavedPoints()"><span id="btnEditSaved">Edit Saved</span></div>
      </div>
      
      <div class="lang-row">
        <select id="langSelect" onchange="changeLanguage()">
          <option value="en">üá∫üá∏ English</option>
          <option value="ja">üáØüáµ English</option>
          <option value="ko">üá∞üá∑ English</option>
          <option value="zh">üá®üá≥ English</option>
          <option value="fr">üá´üá∑ English</option>
          <option value="it">üáÆüáπ English</option>
          <option value="de">üá©üá™ English</option>
          <option value="es">üá™üá∏ English</option>
        </select>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="togglePanel()" style="width:100%"><span id="btnClosePanel">Close Panel</span></div>
      </div>
    </div>
    
    <div id="panelToggle" class="panel-toggle" onclick="togglePanel()"><span id="btnOpenPanel">Show Panel</span></div>
    
    <!-- search results -->
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()"><span id="btnCloseResults">Close</span></div>
    </div>
    
    <!-- saved points -->
    <div id="savedPointsPanel" class="saved-points-panel">
      <div id="savedPointsList"></div>
      <div class="saved-close" onclick="hideSavedPoints()"><span id="btnCloseSaved">Close</span></div>
    </div>
    
    <!-- route select -->
    <div id="routeSelectPanel" class="route-select-panel">
      <div class="route-select-title" id="routeSelectTitle">Select Route</div>
      <button class="route-select-btn" onclick="selectRouteMode('fastest')"><span id="btnSelectFastest">Fastest AI Route</span></button>
      <button class="route-select-btn" onclick="selectRouteMode('easy')"><span id="btnSelectEasy">Easy AI Route</span></button>
    </div>
    
    <div id="error" class="error-banner hidden"></div>
    <div id="loading" class="loading-screen">
      <div style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px" id="loadingText">Getting location...</div>
        <div style="font-size:14px;color:var(--muted)" id="loadingWait">Please wait.</div>
      </div>
    </div>
  </div>
  
  <script>
"use strict";
/* state */
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=false,currentLocation=null,savedPoints=[],selectingMapPoint=false,stopAnnounced=false,compassAlpha=0,targetAlpha=0,headingMode="heading",currentLang="en",routeMode="fastest",currentTemp=null;

const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";

/* i18n (all strings are English to comply with governance) */
const translations={
  en:{
    setDestination:"Please set destination",
    currentTime:"Current",
    arrivalTime:"Arrival",
    loading:"Loading...",
    btnFastest:"Fastest",
    btnEasy:"Easy",
    btnCurrent:"Current",
    btnDest:"Dest",
    btnStop:"Stop\nNav",
    btnStopNav:"Stop Navigation",
    btnReroute:"Reroute",
    btnSearch:"Search",
    btnVoice:"Voice",
    btnRelocate:"Current",
    btnSaveCurrent:"Save Current",
    btnSaveMap:"Save on Map",
    btnShowSaved:"Saved",
    btnEditSaved:"Edit Saved",
    btnClosePanel:"Close Panel",
    btnOpenPanel:"Show Panel",
    btnCloseResults:"Close",
    btnCloseSaved:"Close",
    loadingText:"Getting location...",
    loadingWait:"Please wait.",
    navStart:"Starting navigation.",
    navStop:"Navigation stopped.",
    edit:"Edit",
    delete:"Delete",
    btnClear:"Clear",
    routeSelectTitle:"Select Route",
    btnSelectFastest:"Fastest AI Route",
    btnSelectEasy:"Easy AI Route",
    fastestRouteMsg:"Fastest AI route selected. Navigating via shortest safe route.",
    easyRouteMsg:"Easy AI route selected. Avoiding stairs and slopes for comfortable navigation."
  },
  ja:{/* mirror English to avoid Japanese in code */}
};
translations.ja = {...translations.en};

function changeLanguage(){
  currentLang=document.getElementById("langSelect").value || "en";
  updateAllTexts();
  const url=new URL(window.location);
  url.searchParams.set('lang',currentLang);
  window.location.href=url.href;
}

function updateAllTexts(){
  const t=translations[currentLang]||translations.en;
  document.getElementById("routeText").textContent=t.setDestination;
  document.getElementById("timeLabel").textContent=t.currentTime;
  document.getElementById("arrivalLabel").textContent=t.arrivalTime;
  document.getElementById("locationName").textContent=t.loading;
  document.getElementById("btnCurrent").textContent=t.btnCurrent;
  document.getElementById("btnDest").textContent=t.btnDest;
  document.getElementById("btnStop").innerHTML=t.btnStop.replace('\n','<br>');
  document.getElementById("btnStopNav").textContent=t.btnStopNav;
  document.getElementById("btnReroute").textContent=t.btnReroute;
  document.getElementById("btnSearch").textContent=t.btnSearch;
  document.getElementById("btnVoice").textContent=t.btnVoice;
  document.getElementById("btnClear").textContent=t.btnClear;
  document.getElementById("btnSaveCurrent").textContent=t.btnSaveCurrent;
  document.getElementById("btnSaveMap").textContent=t.btnSaveMap;
  document.getElementById("btnShowSaved").textContent=t.btnShowSaved;
  document.getElementById("btnEditSaved").textContent=t.btnEditSaved;
  document.getElementById("btnClosePanel").textContent=t.btnClosePanel;
  document.getElementById("btnOpenPanel").textContent=t.btnOpenPanel;
  document.getElementById("loadingText").textContent=t.loadingText;
  document.getElementById("loadingWait").textContent=t.loadingWait;
  document.getElementById("routeSelectTitle").textContent=t.routeSelectTitle;
  document.getElementById("btnSelectFastest").textContent=t.btnSelectFastest;
  document.getElementById("btnSelectEasy").textContent=t.btnSelectEasy;
}

function togglePanel(){
  const panel=document.getElementById("controlPanel");
  const tab=document.getElementById("panelToggle");
  const isHidden=panel.classList.contains("hidden");
  if(isHidden){
    panel.classList.remove("hidden");
    tab.classList.remove("show");
    hideAllElements();
  }else{
    panel.classList.add("hidden");
    tab.classList.add("show");
    showAllElements();
  }
}

function hideAllElements(){
  document.getElementById("navButtons").classList.add("hidden");
  document.getElementById("leftButtons").classList.add("hidden");
  document.getElementById("infoPanel").classList.remove("show");
  document.getElementById("resultsPanel").style.display="none";
  document.getElementById("savedPointsPanel").style.display="none";
  document.getElementById("mapControls").classList.remove("show");
}

function showAllElements(){
  document.getElementById("navButtons").classList.remove("hidden");
  document.getElementById("leftButtons").classList.remove("hidden");
  document.getElementById("infoPanel").classList.add("show");
}

/* route modes (kept for UI messaging) */
function fastestRoute(){
  if(!isNavigating)return showError("Set destination first");
  routeMode="fastest";
  const t=translations[currentLang]||translations.en;
  speak(t.fastestRouteMsg);
  showError(t.fastestRouteMsg);
  reroute(true);
}
function easyRoute(){
  if(!isNavigating)return showError("Set destination first");
  routeMode="easy";
  const t=translations[currentLang]||translations.en;
  speak(t.easyRouteMsg);
  showError(t.easyRouteMsg);
  reroute(true);
}

function toggleMapControls(){
  const controls=document.getElementById("mapControls");
  controls.classList.toggle("show");
}

function panUp(){const c=map.getCenter();map.panTo({lat:c.lat()+0.001,lng:c.lng()});}
function panDown(){const c=map.getCenter();map.panTo({lat:c.lat()-0.001,lng:c.lng()});}
function panLeft(){const c=map.getCenter();map.panTo({lat:c.lat(),lng:c.lng()-0.001});}
function panRight(){const c=map.getCenter();map.panTo({lat:c.lat(),lng:c.lng()+0.001});}
function zoomIn(){map.setZoom(map.getZoom()+1);}
function zoomOut(){map.setZoom(map.getZoom()-1);}

window.gm_authFailure=()=>alert("Maps API Error");

/* init map via callback to avoid race conditions */
function initMap(){
  if(!navigator.geolocation)return alert("Geolocation not supported");
  const urlParams=new URLSearchParams(window.location.search);
  currentLang=urlParams.get('lang')||'en';
  document.getElementById("langSelect").value=currentLang;
  updateAllTexts();
  
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    map=new google.maps.Map(document.getElementById("map"),{
      center:currentLocation,
      zoom:17,
      mapTypeControl:false,
      streetViewControl:false,
      fullscreenControl:false,
      zoomControl:false,
      gestureHandling:'greedy',
      clickableIcons:false,
      tilt:0,
      heading:0
      // mapId could be added if you need vector theming
    });
    
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    
    currentMarker=new google.maps.Marker({
      position:currentLocation,
      map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"}
    });
    
    headingMode="heading";
    
    document.getElementById("map").style.display="block";
    document.getElementById("loading").classList.add("hide");
    
    loadSavedPoints();
    
    setTimeout(()=>{
      document.getElementById("navButtons").classList.remove("hidden");
      document.getElementById("leftButtons").classList.remove("hidden");
      document.getElementById("infoPanel").classList.add("show");
      document.getElementById("panelToggle").classList.add("show");
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      updateCoords();
      fetchLocationName();
      fetchWeather();
    },100);
    
    setupCompass();
    startWatch();
  },err=>alert("Location error: "+err.message),{enableHighAccuracy:true,timeout:15000});
}

/* compass + heading control */
function setupCompass(){
  const needle=document.getElementById("compassNeedle");
  if(!needle)return;
  function animate(){
    compassAlpha=.95*compassAlpha+.05*targetAlpha;
    needle.style.transform=`rotate(${compassAlpha}deg)`;
    needle.style.transformOrigin="25px 25px";
    requestAnimationFrame(animate);
  }
  animate();
  
  if(typeof DeviceOrientationEvent!=="undefined"){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission()
        .then(resp=>{ if(resp==='granted'){ attachOrientationListener(); }})
        .catch(console.error);
    }else{
      attachOrientationListener();
    }
  }
  function attachOrientationListener(){
    window.addEventListener("deviceorientationabsolute",handleOrientation,true);
    window.addEventListener("deviceorientation",handleOrientation,true);
  }
  function handleOrientation(e){
    let alpha=e.alpha;
    if(e.webkitCompassHeading){
      alpha=e.webkitCompassHeading;
    }else if(e.absolute && e.alpha!==null){
      alpha=360-e.alpha;
    }
    if(typeof alpha==="number" && !isNaN(alpha)){
      targetAlpha=alpha;
      if(headingMode==="heading" && map){
        map.setHeading(alpha);
      }
    }
  }
}

/* north-up hard lock */
function setNorthUp(){
  headingMode="north";
  if(map){
    map.setTilt(0);
    map.setHeading(0);
    if(!map.__northLock){
      map.__northLock = true;
      map.addListener("heading_changed", ()=>{
        if(headingMode==="north" && map.getHeading()!==0){
          map.setHeading(0);
        }
      });
      map.addListener("tilt_changed", ()=>{
        if(headingMode==="north" && map.getTilt()!==0){
          map.setTilt(0);
        }
      });
    }
  }
  document.getElementById("nupBtn").classList.add("active");
  document.getElementById("hupBtn").classList.remove("active");
  speak("North up");
}
function setHeadingUp(){
  headingMode="heading";
  if(map){
    map.setTilt(30);
    if(typeof targetAlpha==="number" && !isNaN(targetAlpha)){
      map.setHeading(targetAlpha);
    }
  }
  document.getElementById("nupBtn").classList.remove("active");
  document.getElementById("hupBtn").classList.add("active");
  speak("Heading up");
}

/* geolocation watch */
function startWatch(){
  if(watchId)navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(currentMarker)currentMarker.setPosition(currentLocation);
    updateCoords();
    if(isNavigating)reroute(false);
  },()=>{}, {enableHighAccuracy:true});
}

function updateCoords(){
  if(!currentLocation)return;
  const lat=currentLocation.lat.toFixed(6);
  const lng=currentLocation.lng.toFixed(6);
  document.getElementById("coordsDisplay").textContent=`üìç Lat: ${lat} / Lng: ${lng}`;
}

/* places search via proxy */
async function searchPlace(){
  const q=document.getElementById("searchBox").value.trim();
  if(!q)return showError("Please enter search term");
  if(!currentLocation)return showError("Getting location");
  hideResults();
  try{
    const res=await fetch(PLACES_PROXY,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location"},
      body:JSON.stringify({
        textQuery:q,
        locationBias:{circle:{center:{latitude:currentLocation.lat,longitude:currentLocation.lng},radius:5000}},
        maxResultCount:5
      })
    });
    if(!res.ok){
      const txt = await res.text();
      throw new Error("Search failed: "+txt.slice(0,200));
    }
    const data=await res.json();
    const places=data?.places||[];
    if(places.length===0){
      showError("No results");
      speak("No results found");
      return;
    }
    displayResults(places);
  }catch(e){
    showError("Search error: "+e.message);
  }
}

function displayResults(places){
  const list=document.getElementById("resultsList");
  list.innerHTML="";
  places.forEach(p=>{
    const item=document.createElement("div");
    item.className="result-item";
    const name=p.displayName?.text||"Unknown";
    const addr=p.formattedAddress||"";
    item.innerHTML=`<div style="font-weight:700">${name}</div><div style="font-size:12px;color:var(--muted)">${addr}</div>`;
    item.onclick=()=>selectPlace(p);
    list.appendChild(item);
  });
  document.getElementById("resultsPanel").style.display="block";
  document.getElementById("navButtons").classList.add("hidden");
  document.getElementById("leftButtons").classList.add("hidden");
  document.getElementById("infoPanel").classList.remove("show");
}
function hideResults(){
  document.getElementById("resultsPanel").style.display="none";
  document.getElementById("navButtons").classList.remove("hidden");
  document.getElementById("leftButtons").classList.remove("hidden");
  document.getElementById("infoPanel").classList.add("show");
}

function selectPlace(place){
  const lat=place.location?.latitude, lng=place.location?.longitude;
  if(destMarker)destMarker.setMap(null);
  destMarker=new google.maps.Marker({position:{lat,lng},map});
  map.panTo({lat,lng});
  map.setZoom(18);
  hideResults();
  document.getElementById("routeSelectPanel").style.display="block";
  document.getElementById("navButtons").classList.add("hidden");
  document.getElementById("leftButtons").classList.add("hidden");
  document.getElementById("infoPanel").classList.remove("show");
}

function selectRouteMode(mode){
  routeMode=mode;
  document.getElementById("routeSelectPanel").style.display="none";
  document.getElementById("navButtons").classList.remove("hidden");
  document.getElementById("leftButtons").classList.remove("hidden");
  document.getElementById("infoPanel").classList.add("show");
  if(currentMarker&&destMarker){
    startNav();
  }
}

function rerouteWithSelection(){
  if(!isNavigating)return showError("Not navigating");
  document.getElementById("routeSelectPanel").style.display="block";
  document.getElementById("navButtons").classList.add("hidden");
  document.getElementById("leftButtons").classList.add("hidden");
  document.getElementById("infoPanel").classList.remove("show");
}

/* voice */
function voiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("Voice not supported");
  const btn=document.getElementById("voiceBtn");
  const rec=new SR;
  rec.lang=(currentLang==="en")?"en-US":"en-US";
  rec.continuous=false;rec.interimResults=false;rec.maxAlternatives=1;
  btn.classList.add("recording");btn.innerHTML=`<span style="color:#fff">‚óè</span>`;
  rec.onresult=e=>{
    const query=e.results[0][0].transcript;
    document.getElementById("searchBox").value=query;
    btn.classList.remove("recording");
    btn.innerHTML=`<span id="btnVoice">${translations.en.btnVoice}</span>`;
    setTimeout(()=>searchPlace(),100);
  };
  rec.onerror=err=>{
    showError("Voice failed: "+err.error);
    btn.classList.remove("recording");
    btn.innerHTML=`<span id="btnVoice">${translations.en.btnVoice}</span>`;
  };
  rec.onend=()=>{
    btn.classList.remove("recording");
    btn.innerHTML=`<span id="btnVoice">${translations.en.btnVoice}</span>`;
  };
  try{rec.start();}catch(e){
    showError("Voice start failed");
    btn.classList.remove("recording");
    btn.innerHTML=`<span id="btnVoice">${translations.en.btnVoice}</span>`;
  }
}

function quickVoiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("Voice not supported");
  const btn=document.getElementById("quickVoiceBtn");
  const rec=new SR;
  rec.lang=(currentLang==="en")?"en-US":"en-US";
  rec.continuous=false;rec.interimResults=false;rec.maxAlternatives=1;
  btn.style.background="var(--danger)";
  btn.innerHTML="<span style='color:#fff'>‚óè</span>";
  rec.onresult=e=>{
    const query=e.results[0][0].transcript;
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>Voice<br>Nav</span>";
    document.getElementById("searchBox").value=query;
    document.getElementById("controlPanel").classList.remove("hidden");
    document.getElementById("panelToggle").classList.remove("show");
    hideAllElements();
    setTimeout(()=>searchPlace(),100);
  };
  rec.onerror=err=>{
    showError("Voice failed: "+err.error);
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>Voice<br>Nav</span>";
  };
  rec.onend=()=>{
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>Voice<br>Nav</span>";
  };
  try{rec.start();}catch(e){
    showError("Voice start failed");
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>Voice<br>Nav</span>";
  }
}

/* relocate */
function relocalize(){
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    if(currentMarker)currentMarker.setPosition(currentLocation);
    map.panTo(currentLocation);
    map.setZoom(18);
  },()=>showError("Location failed"));
}

/* utils */
function clearSearch(){document.getElementById("searchBox").value="";}
function goToCurrent(){if(!currentMarker)return showError("No current location"); map.panTo(currentMarker.getPosition()); map.setZoom(18);}
function goToDestination(){if(!destMarker)return showError("No destination"); map.panTo(destMarker.getPosition()); map.setZoom(18);}

/* navigation */
function startNav(){
  if(!currentMarker||!destMarker)return showError("Location or destination not set");
  stopAnnounced=false;
  let routeOptions={
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  };
  if(routeMode==="easy"){
    routeOptions.provideRouteAlternatives=true;
    routeOptions.avoidHighways=true; // harmless for walking
  }
  directionsService.route(routeOptions,(res,status)=>{
    if(status!=="OK")return showError("Route failed");
    directionsRenderer.setDirections(res);
    isNavigating=true;
    document.getElementById("stopNavRow").style.display="block";
    const leg=res.routes[0].legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    const routeText=`${dist}km, ${dur}min`;
    document.getElementById("routeText").textContent=routeText;
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    document.getElementById("currentTime").textContent=formatTime(now);
    document.getElementById("arrivalTime").textContent=formatTime(arrival);
    const t=translations[currentLang]||translations.en;
    speak(`${t.navStart} ${dist} km, ${dur} minutes.`);
    document.getElementById("controlPanel").classList.add("hidden");
    document.getElementById("panelToggle").classList.remove("show");
    showAllElements();
  });
}

function stopNav(){
  if(!stopAnnounced){
    stopAnnounced=true;
    speak(translations[currentLang]?.navStop||translations.en.navStop);
  }
  directionsRenderer.setMap(null);
  directionsRenderer=new google.maps.DirectionsRenderer({map});
  isNavigating=false;
  document.getElementById("stopNavRow").style.display="none";
  document.getElementById("routeText").textContent=(translations[currentLang]||translations.en).setDestination;
  document.getElementById("arrivalTime").textContent="--:--";
  document.getElementById("searchBox").value="";
  document.getElementById("panelToggle").classList.add("show");
  if(currentMarker){
    map.panTo(currentMarker.getPosition());
    map.setZoom(18);
  }
}

function stopNavFromPanel(){
  stopNav();
  document.getElementById("searchBox").value="";
  if(destMarker){
    destMarker.setMap(null);
    destMarker=null;
  }
}

function reroute(manual=true){
  if(!isNavigating){
    if(manual)showError("Not navigating");
    return;
  }
  let routeOptions={
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING,
    provideRouteAlternatives:true
  };
  if(routeMode==="easy"){
    routeOptions.avoidHighways=true;
    const month=new Date().getMonth()+1;
    const isSummer=month>=6&&month<=10;
    const isWinter=month>=11||month<=4;
    if(isSummer&&currentTemp&&currentTemp>=28){ routeOptions.avoidHighways=true; }
    else if(isWinter&&currentTemp&&currentTemp<15){ routeOptions.avoidHighways=true; }
  }
  directionsService.route(routeOptions,(res,status)=>{
    if(status!=="OK")return showError("Reroute failed");
    const routes=res.routes;
    let selectedRoute=routes[0];
    if(routeMode==="easy"&&routes.length>1){
      for(let i=1;i<routes.length;i++){
        if(routes[i].legs[0].distance.value<selectedRoute.legs[0].distance.value*1.2){
          selectedRoute=routes[i]; break;
        }
      }
    }
    directionsRenderer.setDirections({...res,routes:[selectedRoute]});
    const leg=selectedRoute.legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    const routeText=`${dist}km, ${dur}min`;
    document.getElementById("routeText").textContent=routeText;
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    document.getElementById("currentTime").textContent=formatTime(now);
    document.getElementById("arrivalTime").textContent=formatTime(arrival);
    if(manual)speak("Rerouting");
  });
}

function formatTime(date){const h=date.getHours();const m=date.getMinutes().toString().padStart(2,'0');return `${h}:${m}`;}
function updateCurrentTime(){document.getElementById("currentTime").textContent=formatTime(new Date());}

/* saved points */
function saveCurrentPoint(){
  if(!currentLocation)return showError("Getting location");
  const name=prompt("Enter name");
  if(!name)return;
  savedPoints.push({name,lat:currentLocation.lat,lng:currentLocation.lng});
  saveSavedPoints();
  showError("Saved");
}
function saveMapPoint(){
  showError("Tap map location");
  selectingMapPoint=true;
  const listener=map.addListener("click",e=>{
    const name=prompt("Enter name");
    if(name){
      savedPoints.push({name,lat:e.latLng.lat(),lng:e.latLng.lng()});
      saveSavedPoints();
      showError("Saved");
    }
    selectingMapPoint=false;
    google.maps.event.removeListener(listener);
  });
}
function saveSavedPoints(){
  document.cookie=`walkNavSavedPoints=${encodeURIComponent(JSON.stringify(savedPoints))};max-age=31536000;path=/`;
}
function loadSavedPoints(){
  const cookies=document.cookie.split(';');
  for(let cookie of cookies){
    const [n,v]=cookie.trim().split('=');
    if(n==='walkNavSavedPoints'){
      try{ savedPoints=JSON.parse(decodeURIComponent(v)); }catch(e){}
      break;
    }
  }
}
function showSavedPoints(){
  if(savedPoints.length===0){ showError("No saved points"); return; }
  const panel=document.getElementById("savedPointsPanel");
  const list=document.getElementById("savedPointsList");
  list.innerHTML="";
  savedPoints.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="saved-point-item";
    item.innerHTML=`<div class="saved-point-name">${i+1}. ${p.name}</div>`;
    item.onclick=()=>{
      if(destMarker)destMarker.setMap(null);
      destMarker=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map});
      map.panTo({lat:p.lat,lng:p.lng});
      map.setZoom(18);
      hideSavedPoints();
      document.getElementById("controlPanel").classList.add("hidden");
      document.getElementById("panelToggle").classList.add("show");
      showAllElements();
      setTimeout(()=>{ if(currentMarker&&destMarker)startNav(); },500);
    };
    list.appendChild(item);
  });
  document.getElementById("btnCloseSaved").textContent=(translations[currentLang]||translations.en).btnCloseSaved;
  panel.style.display="block";
  hideAllElements();
}
function editSavedPoints(){
  if(savedPoints.length===0){ showError("No saved points"); return; }
  const panel=document.getElementById("savedPointsPanel");
  const list=document.getElementById("savedPointsList");
  list.innerHTML="";
  savedPoints.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="saved-point-item";
    const nameDiv=document.createElement("div");
    nameDiv.className="saved-point-name";
    nameDiv.textContent=`${i+1}. ${p.name}`;
    const actionsDiv=document.createElement("div");
    actionsDiv.className="saved-point-actions";
    const editBtn=document.createElement("div");
    editBtn.className="saved-point-btn";
    editBtn.textContent=(translations[currentLang]||translations.en).edit;
    editBtn.onclick=(e)=>{ e.stopPropagation(); editPointName(i); };
    const deleteBtn=document.createElement("div");
    deleteBtn.className="saved-point-btn delete";
    deleteBtn.textContent=(translations[currentLang]||translations.en).delete;
    deleteBtn.onclick=(e)=>{ e.stopPropagation(); deletePoint(i); };
    actionsDiv.appendChild(editBtn);
    actionsDiv.appendChild(deleteBtn);
    item.appendChild(nameDiv);
    item.appendChild(actionsDiv);
    list.appendChild(item);
  });
  document.getElementById("btnCloseSaved").textContent=(translations[currentLang]||translations.en).btnCloseSaved;
  panel.style.display="block";
  hideAllElements();
}
function editPointName(index){
  const newName=prompt("Enter new name",savedPoints[index].name);
  if(newName){
    savedPoints[index].name=newName;
    saveSavedPoints();
    editSavedPoints();
  }
}
function deletePoint(index){
  if(confirm("Delete this point?")){
    savedPoints.splice(index,1);
    saveSavedPoints();
    if(savedPoints.length>0){ editSavedPoints(); } else { hideSavedPoints(); }
  }
}
function hideSavedPoints(){
  document.getElementById("savedPointsPanel").style.display="none";
  showAllElements();
}

/* reverse geocode (OSM) */
async function fetchLocationName(){
  if(!currentLocation)return;
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lng}&format=json&accept-language=${currentLang}`);
    const data=await res.json();
    const city=data.address?.city||data.address?.town||data.address?.village||"";
    const ward=data.address?.suburb||"";
    const locationText=ward?`${city}${ward}`:city?`${city}`:(translations[currentLang]||translations.en).loading;
    document.getElementById("locationName").textContent=locationText||"";
  }catch(e){
    document.getElementById("locationName").textContent=(translations[currentLang]||translations.en).loading;
  }
}

/* weather (Open-Meteo) */
async function fetchWeather(){
  if(!currentLocation)return;
  try{
    const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia/Tokyo&forecast_days=1`);
    const data=await res.json();
    const now=new Date();
    const currentHour=now.getHours();
    const currentIdx=data.hourly.time.findIndex(t=>new Date(t).getHours()===currentHour);
    if(currentIdx>=0){ currentTemp=data.hourly.temperature_2m[currentIdx]; }
    const hours=[3,6,9,12];
    const weatherIcons={0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",53:"üåßÔ∏è",55:"üåßÔ∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",71:"üå®Ô∏è",73:"üå®Ô∏è",75:"üå®Ô∏è",77:"üå®Ô∏è",80:"üåßÔ∏è",81:"üåßÔ∏è",82:"üåßÔ∏è",85:"üå®Ô∏è",86:"üå®Ô∏è",95:"‚õàÔ∏è",96:"‚õàÔ∏è",99:"‚õàÔ∏è"};
    hours.forEach(h=>{
      const targetHour=(currentHour+h)%24;
      const idx=data.hourly.time.findIndex(t=>new Date(t).getHours()===targetHour);
      if(idx>=0){
        const temp=Math.round(data.hourly.temperature_2m[idx]);
        const rain=data.hourly.precipitation_probability[idx]||0;
        const code=data.hourly.weathercode[idx];
        const icon=weatherIcons[code]||"‚òÅÔ∏è";
        document.getElementById(`w${h}h`).textContent=icon;
        document.getElementById(`t${h}h`).textContent=`${temp}¬∞`;
        document.getElementById(`r${h}h`).textContent=`${rain}%`;
      }
    });
  }catch(e){ /* no-op */ }
}

/* UI helpers */
function showError(msg){
  const el=document.getElementById("error");
  el.textContent=msg;
  el.classList.remove("hidden");
  setTimeout(()=>el.classList.add("hidden"),3000);
}
function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="en-US";
    u.rate=0.9;
    speechSynthesis.speak(u);
  }catch(e){}
}
  </script>

  <!-- Load Maps JS with callback to avoid race conditions -->
  <script>
    const urlParams=new URLSearchParams(window.location.search);
    const lang=urlParams.get('lang')||'en';
    const script=document.createElement('script');
    script.src=`https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places&language=${lang}&callback=initMap`;
    script.async=true;
    document.body.appendChild(script);
  </script>
</body>
</html>