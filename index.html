<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v5</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}

.control-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:0;
  z-index:500;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:16px 16px 0 0;
  backdrop-filter:blur(14px);
  padding:16px;
  transition:transform 0.3s;
}
.control-panel.hidden{transform:translateY(100%)}
.panel-toggle{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  border:none;
  border-radius:12px;
  padding:14px 40px;
  color:#000;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  z-index:490;
  display:none !important;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.panel-toggle.show{display:block}
.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.panel-btn{
  flex:1;
  min-width:120px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:10px;
  color:#fff;
  font-size:14px;
  text-align:center;
  cursor:pointer;
  font-weight:700;
}
.panel-btn.primary{background:var(--primary);border:none;color:#000}
.panel-btn.recording{background:var(--danger);border:none;color:#fff}
.panel-btn.danger{background:var(--danger);border:none;color:#fff}
input,select{
  width:100%;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  color:var(--text);
  border-radius:10px;
  padding:10px;
  font-size:14px;
}

.info-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:10px;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  backdrop-filter:blur(14px);
  padding:14px 14px 18px 14px;
  z-index:460;
  color:var(--text);
  display:none;
  pointer-events:none;
}
.info-panel.show{display:block !important}
.route-main{
  font-size:27px;
  font-weight:700;
  margin-bottom:10px;
  line-height:1.4;
  text-align:center;
}
.route-time{
  font-size:16px;
  color:var(--text);
  display:flex;
  gap:20px;
  font-weight:600;
  margin-bottom:12px;
  justify-content:center;
}
.route-time span{
  display:flex;
  align-items:center;
  gap:4px;
}
.weather-row{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}
.location-name{
  font-size:20px;
  font-weight:700;
  color:var(--primary);
  white-space:nowrap;
}
.weather-items{
  display:flex;
  gap:4px;
  flex:1;
  justify-content:center;
  align-items:center;
}
.weather-arrow{
  color:var(--muted);
  font-size:18px;
  font-weight:900;
}
.weather-item{
  text-align:center;
  font-size:11px;
  color:var(--text);
  padding:8px 6px;
  background:rgba(16,22,36,.25);
  border-radius:8px;
  min-width:60px;
}
.weather-time{
  font-size:12px;
  color:var(--muted);
  font-weight:700;
  margin-bottom:2px;
}
.weather-icon{font-size:20px;margin:2px 0}
.weather-temp{font-weight:700;font-size:13px}
.weather-rain{color:var(--accent);font-size:11px;font-weight:700}

.nav-buttons{
  position:absolute;
  right:10px;
  top:200px;
  z-index:450;
  display:none;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}
.nav-buttons.hidden{display:none}
.nav-btn{
  width:70px;
  height:60px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#000;
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:700;
  flex-direction:column;
  gap:2px;
  pointer-events:auto;
}
.nav-btn.primary{background:var(--primary);border:none}
.nav-btn.ok{background:var(--ok);border:none}
.nav-btn.danger{background:var(--danger);border:none;color:#fff}
.nav-btn.accent{background:var(--accent);border:none}

.left-buttons{
  position:absolute;
  left:10px;
  top:200px;
  z-index:450;
  display:none !important;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
}
.left-buttons.hidden{display:none}

.location-btn{
  width:70px;
  height:60px;
  background:var(--accent);
  border:none;
  border-radius:10px;
  color:#000;
  font-size:20px;
  cursor:pointer;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  pointer-events:auto;
}

.right-buttons{
  position:absolute;
  right:10px;
  top:400px;
  z-index:450;
  display:flex;
  flex-direction:column;
  gap:4px;
  pointer-events:none;
}
.right-btn{
  width:97px;
  height:75px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#fff;
  font-size:15px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:700;
  gap:2px;
  pointer-events:auto;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}
.right-btn.primary{background:var(--primary);border:none;color:#000}
.right-btn.ok{background:var(--ok);border:none;color:#000}
.right-btn.danger{background:var(--danger);border:none;color:#fff;}
.right-btn.danger:disabled{opacity:0.5;background:var(--danger);cursor:not-allowed;color:#fff;}
.right-btn.accent{background:var(--accent);border:none;color:#000}
.right-btn.warning{background:#ffa500;border:none;color:#000}

.map-controls{
  position:fixed;
  right:105px;
  bottom:30px;
  z-index:450;
  display:none;
  gap:8px;
}
.map-controls.show{
  display:flex;
  flex-direction:column;
  align-items:center;
}
.map-control-row{
  display:flex;
  gap:8px;
}
.map-control-btn{
  width:50px;
  height:50px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:#fff;
  font-size:20px;
  cursor:pointer;
  font-weight:700;
  display:flex;
  align-items:center;
  justify-content:center;
  user-select:none;
  box-shadow:0 2px 6px rgba(0,0,0,.3);
}
.map-control-btn:active{
  background:var(--primary);
}

.results-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  max-height:60vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:510;
  display:none;
}
.result-item{
  padding:10px;
  border-bottom:1px solid var(--stroke);
  cursor:pointer;
}
.result-item:hover{background:rgba(95,177,255,.2)}
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

.saved-points-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  max-height:70vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:510;
  display:none;
}
.saved-point-item{
  padding:12px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:8px;
  margin-bottom:8px;
  cursor:pointer;
  font-size:14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.saved-point-item:hover{background:rgba(95,177,255,.3)}
.saved-point-name{flex:1}
.saved-point-actions{display:flex;gap:6px}
.saved-point-btn{
  padding:4px 10px;
  background:var(--primary);
  border-radius:6px;
  font-size:12px;
  cursor:pointer;
  color:#000;
  font-weight:700;
}
.saved-point-btn.delete{background:var(--danger);color:#fff}
.saved-close{text-align:center;padding:10px;color:var(--primary);cursor:pointer;font-weight:700}

.error-banner{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--danger);
  color:#fff;
  border-radius:10px;
  padding:10px;
  text-align:center;
  z-index:999;
}
.success-banner{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:#7ed321;
  color:#000;
  border-radius:10px;
  padding:10px;
  text-align:center;
  z-index:999;
  font-weight:700;
}
.hidden{display:none}
.loading-screen{
  position:fixed;
  inset:0;
  background:#0e1a2d;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  transition:opacity 0.3s;
}
.loading-screen.hide{opacity:0;pointer-events:none}

/* Google Maps ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
.gm-control-active.gm-fullscreen-control {
  display: none !important;
}
.gm-svpc,
.gm-style .gm-style-cc,
button[title*="ç¾åœ¨åœ°"],
button[title*="location"],
button[aria-label*="ç¾åœ¨åœ°"],
button[aria-label*="location"],
button[title*="ä½ç½®æƒ…å ±"],
button[aria-label*="ä½ç½®æƒ…å ±"] {
  display: none !important;
}

/* åœ°å›³ä¸Šã®ä½æ‰€ãƒ©ãƒ™ãƒ«ã‚’å®Œå…¨ã«éè¡¨ç¤º */
.gm-style-iw,
.gm-style-iw-c,
.gm-style-iw-d,
.gm-style-iw-t::after,
div[aria-label*="ä»˜è¿‘"],
div[aria-label*="ç¾é¦¬éƒ¡"],
div[title*="ä»˜è¿‘"] {
  display: none !important;
  opacity: 0 !important;
  visibility: hidden !important;
}

@keyframes marquee {
  0% {
    transform: translateX(100%);
  }
  100% {
    transform: translateX(-100%);
  }
}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    
    <div id="infoPanel" class="info-panel">
      <div class="route-main">
        <div id="routeText">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
        <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:6px;font-weight:600;">åŠå¾„5kmåœå†…ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>
        <div id="incidentMarquee" style="background:rgba(255,101,101,.2);border-radius:6px;padding:2px 8px;margin-top:6px;overflow:hidden;white-space:nowrap;height:24px;display:flex;align-items:center;">
          <div id="incidentText" style="display:inline-block;font-size:18px;color:#ff6565;">
            ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã•ã‚Œã¦ã„ã‚‹äº‹ä»¶ã€äº‹æ•…ã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
          </div>
        </div>
      </div>
      <div class="route-time">
        <span><span id="timeLabel" style="display:inline-block;line-height:1.2;">ç¾åœ¨<br>æ™‚åˆ»</span>: <span id="currentTime" style="font-size:20px;">--:--</span></span>
        <span><span id="arrivalLabel" style="display:inline-block;line-height:1.2;">åˆ°ç€<br>äºˆæƒ³</span>: <span id="arrivalTime" style="font-size:20px;">--:--</span></span>
        <span><span style="display:inline-block;line-height:1.2;">æ‰€è¦<br>æ™‚é–“</span>: <span id="durationTime" style="font-size:20px;">--:--</span></span>
      </div>
      <div style="text-align:center;margin-bottom:8px;">
        <div id="locationName" class="location-name">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="weather-row">
        <div class="weather-items">
          <div class="weather-item">
            <div class="weather-time">3H</div>
            <div class="weather-icon" id="w3h">â˜ï¸</div>
            <div class="weather-temp" id="t3h">--Â°</div>
            <div class="weather-rain" id="r3h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div class="weather-time">6H</div>
            <div class="weather-icon" id="w6h">â˜ï¸</div>
            <div class="weather-temp" id="t6h">--Â°</div>
            <div class="weather-rain" id="r6h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div class="weather-time">9H</div>
            <div class="weather-icon" id="w9h">â˜ï¸</div>
            <div class="weather-temp" id="t9h">--Â°</div>
            <div class="weather-rain" id="r9h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div class="weather-time">12H</div>
            <div class="weather-icon" id="w12h">â˜ï¸</div>
            <div class="weather-temp" id="t12h">--Â°</div>
            <div class="weather-rain" id="r12h">--%</div>
          </div>
        </div>
      </div>
      <div id="coordsDisplay" style="text-align:center;font-size:17px;color:var(--muted);margin-top:8px;font-weight:600;cursor:pointer;pointer-events:auto;" onclick="copyCoordinates(event)">ğŸ“ ç·¯åº¦: -- / çµŒåº¦: --</div>
    </div>
    
    <div id="currentLocationDisplay" style="display:none;position:absolute;bottom:80px;left:50%;transform:translateX(-50%);z-index:500;background:var(--glass-strong);border-radius:12px;padding:8px 16px;box-shadow:0 2px 8px rgba(0,0,0,0.3);max-width:90%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
      <div style="text-align:center;font-size:14px;color:var(--accent);font-weight:700;">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
    </div>
    
    <div id="mapControls" class="map-controls">
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panUp()">â†‘</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panLeft()">â†</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomIn()">+</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomOut()">âˆ’</div>
        <div class="map-control-btn" onclick="event.preventDefault();panRight()">â†’</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panDown()">â†“</div>
      </div>
    </div>
    
    <div id="panelToggle" class="panel-toggle" onclick="togglePanel()"><span id="btnOpenPanel">æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º</span></div>
    
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()"><span id="btnCloseResults">é–‰ã˜ã‚‹</span></div>
    </div>
    
    <div id="routeSelectModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;">
      <div style="background:var(--glass-strong);border-radius:16px;padding:24px;width:80%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
        <h2 style="color:#fff;text-align:center;margin-bottom:20px;font-size:20px;">ãƒ«ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h2>
        <button onclick="selectRouteType('fastest')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--primary);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          âš¡ æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ
        </button>
        <button onclick="selectRouteType('easy')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--ok);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          ğŸŒ¿ æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ
        </button>
        <button onclick="closeRouteSelectModal()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
      </div>
    </div>
    
    <div id="savedPointsPanel" class="saved-points-panel">
      <div id="savedPointsList"></div>
      <div class="saved-close" onclick="hideSavedPoints()"><span id="btnCloseSaved">é–‰ã˜ã‚‹</span></div>
    </div>
    
    <div id="error" class="error-banner hidden"></div>
    <div id="success" class="success-banner hidden"></div>
    
    <div id="rightButtons" class="right-buttons">
      <button class="right-btn primary" onclick="showSearchPanel()" title="æ¤œç´¢">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20L15.5 15.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">æ¤œç´¢</span>
      </button>
      <button class="right-btn primary" onclick="voiceSearch()" title="éŸ³å£°æ¤œç´¢">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 3C10.34 3 9 4.34 9 6V12C9 13.66 10.34 15 12 15C13.66 15 15 13.66 15 12V6C15 4.34 13.66 3 12 3Z" stroke="currentColor" stroke-width="2" fill="currentColor"/>
          <path d="M19 12C19 15.87 15.87 19 12 19M12 19C8.13 19 5 15.87 5 12M12 19V23M8 23H16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">éŸ³å£°</span>
      </button>
      <button class="right-btn danger" id="stopNavBtn" onclick="stopNav()" title="æ¡ˆå†…åœæ­¢" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="6" width="12" height="12" fill="currentColor" stroke="currentColor" stroke-width="2"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">åœæ­¢</span>
      </button>
      <button class="right-btn accent" onclick="zoomToCurrentLocation()" title="ç¾åœ¨åœ°ã‚’æ‹¡å¤§è¡¨ç¤º">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="3" fill="currentColor"/>
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="M12 2V6M12 18V22M22 12H18M6 12H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:9px;margin-top:2px;">ç¾åœ¨åœ°</span>
      </button>
      <button class="right-btn warning" onclick="zoomToDestination()" title="ç›®çš„åœ°ã‚’æ‹¡å¤§è¡¨ç¤º">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L12 12M12 12L8 8M12 12L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 12C12 15.866 8.866 19 5 19C5 19 3 17 3 12C3 8.134 5 2 12 2C19 2 21 8.134 21 12C21 17 19 19 19 19C15.134 19 12 15.866 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span style="font-size:9px;margin-top:2px;">ç›®çš„åœ°</span>
      </button>
      <button class="right-btn ok" onclick="showRouteSelectModal('reroute')" title="ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 1L21 5L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 11V9C3 6.79086 4.79086 5 7 5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 23L3 19L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 13V15C21 17.2091 19.2091 19 17 19H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:9px;margin-top:2px;">ãƒªãƒ«ãƒ¼ãƒˆ</span>
      </button>
    </div>
    
    <div id="loading" class="loading-screen">
      <div style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px" id="loadingText">ç¾åœ¨åœ°å–å¾—ä¸­...</div>
        <div style="font-size:14px;color:var(--muted)" id="loadingWait">ã‚‚ã†ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>
      </div>
    </div>
  </div>
  
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=!1,currentLocation=null,savedPoints=[],selectingMapPoint=!1,stopAnnounced=!1,currentLang="ja";

const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";

const translations={
  ja:{
    setDestination:"ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„",
    currentTime:"ç¾åœ¨æ™‚åˆ»",
    arrivalTime:"åˆ°ç€äºˆæƒ³æ™‚åˆ»",
    loading:"èª­ã¿è¾¼ã¿ä¸­...",
    btnFastest:"æœ€çŸ­AI",
    btnEasy:"æ¥½ãƒãƒ³AI",
    btnWalk:"ãŠæ•£æ­©AI",
    btnCurrent:"ç¾åœ¨åœ°",
    btnDest:"ç›®çš„åœ°",
    btnStop:"æ¡ˆå†…\nåœæ­¢",
    btnStopNav:"æ¡ˆå†…ä¸­æ­¢",
    btnReroute:"ãƒªãƒ«ãƒ¼ãƒˆ",
    btnSearch:"æ¤œç´¢",
    btnVoice:"éŸ³å£°æ¤œç´¢",
    btnRelocate:"ç¾åœ¨åœ°",
    btnSaveCurrent:"ç¾åœ¨åœ°ã‚’ç™»éŒ²",
    btnSaveMap:"åœ°å›³ä¸Šã‚’ç™»éŒ²",
    btnShowSaved:"ç™»éŒ²åœ°ç‚¹",
    btnEditSaved:"ç™»éŒ²åœ°ç‚¹ç·¨é›†",
    btnClosePanel:"æ“ä½œãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹",
    btnOpenPanel:"æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º",
    btnCloseResults:"é–‰ã˜ã‚‹",
    btnCloseSaved:"é–‰ã˜ã‚‹",
    loadingText:"ç¾åœ¨åœ°å–å¾—ä¸­...",
    loadingWait:"ã‚‚ã†ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚",
    navStart:"æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚",
    navStop:"æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚",
    edit:"ç·¨é›†",
    delete:"å‰Šé™¤"
  },
  en:{
    setDestination:"Please set destination",
    currentTime:"Current",
    arrivalTime:"Arrival",
    loading:"Loading...",
    btnFastest:"Fastest",
    btnEasy:"Easy",
    btnWalk:"Scenic",
    btnCurrent:"Current",
    btnDest:"Dest",
    btnStop:"Stop\nNav",
    btnStopNav:"Stop Navigation",
    btnReroute:"Reroute",
    btnSearch:"Search",
    btnVoice:"Voice",
    btnRelocate:"Current",
    btnSaveCurrent:"Save Current",
    btnSaveMap:"Save Map",
    btnShowSaved:"Saved",
    btnEditSaved:"Edit Saved",
    btnClosePanel:"Close Panel",
    btnOpenPanel:"Show Panel",
    btnCloseResults:"Close",
    btnCloseSaved:"Close",
    loadingText:"Getting location...",
    loadingWait:"Please wait.",
    navStart:"Starting navigation.",
    navStop:"Navigation stopped.",
    edit:"Edit",
    delete:"Delete"
  }
};

function changeLanguage(){
  currentLang=document.getElementById("langSelect").value;
  updateAllTexts();
  
  const url=new URL(window.location);
  url.searchParams.set('lang',currentLang);
  window.location.href=url.href;
}

function updateAllTexts(){
  const t=translations[currentLang];
  document.getElementById("loadingText").textContent=t.loadingText;
  document.getElementById("loadingWait").textContent=t.loadingWait;
}

function togglePanel(){
  // ãƒ‘ãƒãƒ«ãƒˆã‚°ãƒ«æ©Ÿèƒ½ï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
}

function hideAllElements(){
  document.getElementById("resultsPanel").style.display="none";
  document.getElementById("savedPointsPanel").style.display="none";
  document.getElementById("mapControls").classList.remove("show");
}

function showAllElements(){
  // å¿…è¦ãªè¦ç´ ã‚’è¡¨ç¤ºï¼ˆå¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ï¼‰
}

function fastestRoute(){
  if(!isNavigating){
    showError("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    return;
  }
  speak("æœ€çŸ­ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ä¸­");
  reroute(!0);
}

function easyRoute(){
  if(!isNavigating){
    showError("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    return;
  }
  speak("æ¥½ãƒãƒ³ãƒ«ãƒ¼ãƒˆã‚’è¨ˆç®—ä¸­");
  reroute(!0);
}

function walkRoute(){
  if(!isNavigating)return showError("Set destination first");
  speak("Calculating scenic route");
  reroute(!0);
}

function toggleMapControls(){
  const controls=document.getElementById("mapControls");
  controls.classList.toggle("show");
}

function panUp(){
  const center=map.getCenter();
  map.panTo({lat:center.lat()+0.001,lng:center.lng()});
}

function panDown(){
  const center=map.getCenter();
  map.panTo({lat:center.lat()-0.001,lng:center.lng()});
}

function panLeft(){
  const center=map.getCenter();
  map.panTo({lat:center.lat(),lng:center.lng()-0.001});
}

function panRight(){
  const center=map.getCenter();
  map.panTo({lat:center.lat(),lng:center.lng()+0.001});
}

function zoomIn(){
  map.setZoom(map.getZoom()+1);
}

function zoomOut(){
  map.setZoom(map.getZoom()-1);
}

window.gm_authFailure=()=>alert("Maps API Error");

function initMap(){
  if(!navigator.geolocation)return alert("Geolocation not supported");
  
  const urlParams=new URLSearchParams(window.location.search);
  currentLang=urlParams.get('lang')||'ja';
  updateAllTexts();
  
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    map=new google.maps.Map(document.getElementById("map"),{
      center:currentLocation,
      zoom:17,
      mapTypeControl:false,
      streetViewControl:false,
      fullscreenControl:false,
      zoomControl:false,
      rotateControl:false,
      scaleControl:false,
      gestureHandling:'greedy',
      clickableIcons:false,
      disableDefaultUI: true
    });
    
    // ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    const locationButton = document.createElement("button");
    locationButton.style.backgroundColor = "#64d2ff";
    locationButton.style.border = "none";
    locationButton.style.borderRadius = "10px";
    locationButton.style.boxShadow = "0 2px 6px rgba(0,0,0,0.3)";
    locationButton.style.cursor = "pointer";
    locationButton.style.margin = "10px";
    locationButton.style.padding = "0";
    locationButton.style.width = "50px";
    locationButton.style.height = "50px";
    locationButton.style.display = "flex";
    locationButton.style.alignItems = "center";
    locationButton.style.justifyContent = "center";
    locationButton.innerHTML = `<svg width="24" height="24" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- ä¸ŠçŸ¢å° -->
      <path d="M16 4 L16 10 M16 4 L13 7 M16 4 L19 7" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- ä¸‹çŸ¢å° -->
      <path d="M16 28 L16 22 M16 28 L13 25 M16 28 L19 25" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- å·¦çŸ¢å° -->
      <path d="M4 16 L10 16 M4 16 L7 13 M4 16 L7 19" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- å³çŸ¢å° -->
      <path d="M28 16 L22 16 M28 16 L25 13 M28 16 L25 19" stroke="#000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      <!-- ä¸­å¤®ã®ãƒ—ãƒ©ã‚¹ãƒã‚¤ãƒŠã‚¹ -->
      <circle cx="16" cy="16" r="4" fill="#000"/>
      <path d="M14 16 L18 16 M16 14 L16 18" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
    </svg>`;
    
    locationButton.addEventListener("click", () => {
      toggleMapControls();
    });
    
    map.controls[google.maps.ControlPosition.RIGHT_BOTTOM].push(locationButton);
    
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    
    // currentMarkerã¯ä½œæˆã›ãšã€currentLocationã®ã¿ä½¿ç”¨
    currentMarker=null;
    
    document.getElementById("map").style.display="block";
    document.getElementById("loading").classList.add("hide");
    
    loadSavedPoints();
    
    setTimeout(()=>{
      const navButtons=document.getElementById("navButtons");
      const leftButtons=document.getElementById("leftButtons");
      const infoPanel=document.getElementById("infoPanel");
      const panelToggle=document.getElementById("panelToggle");
      
      if(navButtons)navButtons.classList.remove("hidden");
      if(leftButtons)leftButtons.classList.remove("hidden");
      if(infoPanel)infoPanel.classList.add("show");
      if(panelToggle)panelToggle.classList.add("show");
      
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      updateCoords();
      
      fetchLocationName();
      fetchWeather();
    },100);
    
    startWatch();
  },err=>alert("Location error: "+err.message));
}

function startWatch(){
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    updateCoords();
    
    isNavigating&&reroute(!1);
  },()=>{},{enableHighAccuracy:!0});
}

function updateCoords(){
  if(!currentLocation)return;
  const lat=currentLocation.lat.toFixed(6);
  const lng=currentLocation.lng.toFixed(6);
  const coordsEl=document.getElementById("coordsDisplay");
  if(coordsEl){
    coordsEl.textContent=`ğŸ“ ç·¯åº¦: ${lat} / çµŒåº¦: ${lng}`;
  }
}

function copyCoordinates(event){
  if(event){
    event.preventDefault();
    event.stopPropagation();
  }
  
  if(!currentLocation)return;
  
  const lat=currentLocation.lat.toFixed(6);
  const lng=currentLocation.lng.toFixed(6);
  const coordsText=`${lat}, ${lng}`;
  
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(coordsText).then(()=>{
      showSuccess("ç·¯åº¦çµŒåº¦ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
    }).catch(()=>{
      fallbackCopy(coordsText);
    });
  }else{
    fallbackCopy(coordsText);
  }
}

function fallbackCopy(text){
  const textarea=document.createElement("textarea");
  textarea.value=text;
  textarea.style.position="fixed";
  textarea.style.opacity="0";
  document.body.appendChild(textarea);
  textarea.select();
  try{
    document.execCommand("copy");
    showSuccess("ç·¯åº¦çµŒåº¦ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
  }catch(e){
    showError("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
  document.body.removeChild(textarea);
}

let pendingRouteAction=null;
let selectedRouteType="fastest";

function showRouteSelectModal(action){
  pendingRouteAction=action;
  const modal=document.getElementById("routeSelectModal");
  if(modal){
    modal.style.display="flex";
  }
}

function closeRouteSelectModal(){
  const modal=document.getElementById("routeSelectModal");
  if(modal){
    modal.style.display="none";
  }
  pendingRouteAction=null;
}

function selectRouteType(type){
  selectedRouteType=type;
  const routeName=type==="fastest"?"æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ":"æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ";
  speak(`${routeName}ã‚’é¸æŠã—ã¾ã—ãŸ`);
  closeRouteSelectModal();
  
  if(pendingRouteAction==="search"){
    executeSearch();
  }else if(pendingRouteAction==="reroute"){
    executeReroute();
  }
}

function executeReroute(){
  if(!isNavigating){
    speak("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    showError("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");
    return;
  }
  
  const routeName=selectedRouteType==="fastest"?"æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ":"æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ";
  speak(`${routeName}ã‚’è¨ˆç®—ä¸­`);
  
  directionsService.route({
    origin:currentLocation,
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING,
    provideRouteAlternatives:!0,
    avoidHighways:selectedRouteType==="easy"?!0:Math.random()>0.5
  },(res,status)=>{
    if(status!=="OK")return showError("Reroute failed");
    
    const routes=res.routes;
    let selectedRoute=routes[0];
    
    if(selectedRouteType==="easy"&&routes.length>1){
      selectedRoute=routes.sort((a,b)=>{
        const elevA=a.legs[0].elevation||0;
        const elevB=b.legs[0].elevation||0;
        return elevA-elevB;
      })[0];
    }else if(routes.length>1){
      const altIndex=Math.floor(Math.random()*(routes.length-1))+1;
      selectedRoute=routes[altIndex];
    }
    
    directionsRenderer.setDirections({...res,routes:[selectedRoute]});
    
    const leg=selectedRoute.legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    const routeText=`${dist}km, ${dur}min`;
    const routeTextEl=document.getElementById("routeText");
    if(routeTextEl){
      routeTextEl.textContent=routeText;
    }
    
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    
    const currentTimeEl=document.getElementById("currentTime");
    const arrivalTimeEl=document.getElementById("arrivalTime");
    const durationTimeEl=document.getElementById("durationTime");
    
    if(currentTimeEl){
      currentTimeEl.textContent=formatTime(now);
    }
    if(arrivalTimeEl){
      arrivalTimeEl.textContent=formatTime(arrival);
    }
    if(durationTimeEl){
      const hours=Math.floor(dur/60);
      const mins=dur%60;
      durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;
    }
    
    speak("Rerouting");
  });
}

function showSearchPanel(){
  speak("æ¤œç´¢ãƒ‘ãƒãƒ«ã‚’é–‹ãã¾ã™");
  const controlPanel=document.getElementById("controlPanel");
  if(controlPanel){
    controlPanel.classList.remove("hidden");
    hideAllElements();
  }
  const searchBox=document.getElementById("searchBox");
  if(searchBox){
    searchBox.focus();
  }
}

function voiceSearch(){
  if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){
    speak("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    showError("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
    return;
  }
  
  const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();
  recognition.lang='ja-JP';
  recognition.continuous=false;
  recognition.interimResults=false;
  
  recognition.onstart=()=>{
    speak("éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã™");
    showSuccess("éŸ³å£°å…¥åŠ›ä¸­...");
  };
  
  recognition.onresult=(event)=>{
    const transcript=event.results[0][0].transcript;
    speak(`${transcript}ã‚’æ¤œç´¢ã—ã¾ã™`);
    const searchBox=document.getElementById("searchBox");
    if(searchBox){
      searchBox.value=transcript;
      searchPlace();
    }
  };
  
  recognition.onerror=(event)=>{
    speak("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    showError("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼");
  };
  
  recognition.start();
}

async function searchPlace(){
  const searchBox=document.getElementById("searchBox");
  if(!searchBox)return;
  
  const q=searchBox.value.trim();
  if(!q)return showError("Please enter search term");
  if(!currentLocation)return showError("Getting location");
  
  showRouteSelectModal("search");
}

async function executeSearch(){
  const searchBox=document.getElementById("searchBox");
  if(!searchBox)return;
  
  const q=searchBox.value.trim();
  if(!q)return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!currentLocation)return showError("ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­");
  
  hideResults();
  
  try{
    const res=await fetch(PLACES_PROXY,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location"},
      body:JSON.stringify({
        textQuery:q,
        locationBias:{circle:{center:{latitude:currentLocation.lat,longitude:currentLocation.lng},radius:5000}},
        maxResultCount:5
      })
    });
    
    if(!res.ok)throw new Error("Search failed");
    
    const data=await res.json();
    let places=data?.places||[];
    
    if(places.length===0){
      showError("çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      speak("çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return;
    }
    
    places=places.map(p=>{
      const lat=p.location?.latitude;
      const lng=p.location?.longitude;
      const distance=calculateDistance(currentLocation.lat,currentLocation.lng,lat,lng);
      return {...p,distance};
    }).sort((a,b)=>a.distance-b.distance).slice(0,5);
    
    displayResults(places);
  }catch(e){
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: "+e.message);
  }
}

function calculateDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function displayResults(places){
  const list=document.getElementById("resultsList");
  list.innerHTML="";
  
  places.forEach(p=>{
    const item=document.createElement("div");
    item.className="result-item";
    const distText=p.distance<1?`${(p.distance*1000).toFixed(0)}m`:`${p.distance.toFixed(1)}km`;
    item.innerHTML=`<div style="font-weight:700">${p.displayName?.text||"Unknown"}</div><div style="font-size:12px;color:var(--muted)">${p.formattedAddress||""}</div><div style="font-size:11px;color:var(--accent);margin-top:4px;">ğŸ“ ${distText}</div>`;
    item.onclick=()=>selectPlace(p);
    list.appendChild(item);
  });
  
  document.getElementById("resultsPanel").style.display="block";
}

function hideResults(){
  document.getElementById("resultsPanel").style.display="none";
}

function selectPlace(place){
  const lat=place.location?.latitude,lng=place.location?.longitude;
  
  destMarker&&destMarker.setMap(null);
  destMarker=new google.maps.Marker({position:{lat,lng},map});
  
  map.panTo({lat,lng});
  map.setZoom(18);
  
  hideResults();
  
  const controlPanel=document.getElementById("controlPanel");
  if(controlPanel){
    controlPanel.classList.add("hidden");
  }
  document.getElementById("panelToggle").classList.add("show");
  showAllElements();
  
  setTimeout(()=>{
    if(currentMarker&&destMarker)startNav();
  },500);
}

function quickVoiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("Voice not supported");
  
  const btn=document.getElementById("quickVoiceBtn");
  if(!btn)return;
  
  const rec=new SR;
  rec.lang=currentLang==="ja"?"ja-JP":currentLang==="en"?"en-US":currentLang==="ko"?"ko-KR":currentLang==="zh"?"zh-CN":"en-US";
  rec.continuous=false;
  rec.interimResults=false;
  rec.maxAlternatives=1;
  
  btn.style.background="var(--danger)";
  btn.innerHTML="<span style='color:#fff'>â—</span>";
  
  rec.onresult=e=>{
    const query=e.results[0][0].transcript;
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>éŸ³å£°<br>æ¡ˆå†…</span>";
    
    const searchBox=document.getElementById("searchBox");
    if(searchBox){
      searchBox.value=query;
    }
    
    const controlPanel=document.getElementById("controlPanel");
    if(controlPanel){
      controlPanel.classList.remove("hidden");
    }
    document.getElementById("panelToggle").classList.remove("show");
    hideAllElements();
    
    setTimeout(()=>searchPlace(),100);
  };
  rec.onerror=err=>{
    console.error("Voice error:",err);
    showError("Voice failed: "+err.error);
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>éŸ³å£°<br>æ¡ˆå†…</span>";
  };
  rec.onend=()=>{
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>éŸ³å£°<br>æ¡ˆå†…</span>";
  };
  
  try{
    rec.start();
  }catch(e){
    showError("Voice start failed");
    btn.style.background="";
    btn.innerHTML="<span id='btnVoiceNav'>éŸ³å£°<br>æ¡ˆå†…</span>";
  }
}

function zoomToCurrentLocation(){
  if(!currentMarker){
    speak("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
    showError("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
    return;
  }
  
  const pos=currentLocation;
  map.panTo(pos);
  map.setZoom(18);
  
  speak("ç¾åœ¨åœ°ã‚’è¡¨ç¤º");
}

function zoomToDestination(){
  if(!destMarker){
    speak("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    showError("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }
  
  const pos=destMarker.getPosition();
  map.panTo(pos);
  map.setZoom(18);
  
  speak("ç›®çš„åœ°ã‚’è¡¨ç¤º");
}

function relocalize(){
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    map.panTo(currentLocation);
    map.setZoom(18);
  },()=>showError("Location failed"));
}

function goToCurrent(){
  if(!currentMarker)return showError("No current location");
  const pos=currentLocation;
  map.panTo(pos);
  map.setZoom(18);
}

function goToDestination(){
  if(!destMarker)return showError("No destination");
  map.panTo(destMarker.getPosition());
  map.setZoom(18);
}

function startNav(){
  if(!currentMarker||!destMarker)return showError("Location or destination not set");
  
  stopAnnounced=!1;
  
  directionsService.route({
    origin:currentLocation,
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  },(res,status)=>{
    if(status!=="OK")return showError("Route failed");
    
    directionsRenderer.setDirections(res);
    isNavigating=!0;
    
    const stopNavRow=document.getElementById("stopNavRow");
    if(stopNavRow){
      stopNavRow.style.display="block";
    }
    
    const stopNavBtn=document.getElementById("stopNavBtn");
    if(stopNavBtn){
      stopNavBtn.disabled=false;
    }
    
    const leg=res.routes[0].legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    const routeText=`${dist}km, ${dur}min`;
    const routeTextEl=document.getElementById("routeText");
    if(routeTextEl){
      routeTextEl.textContent=routeText;
    }
    
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    
    const currentTimeEl=document.getElementById("currentTime");
    const arrivalTimeEl=document.getElementById("arrivalTime");
    const durationTimeEl=document.getElementById("durationTime");
    
    if(currentTimeEl){
      currentTimeEl.textContent=formatTime(now);
    }
    if(arrivalTimeEl){
      arrivalTimeEl.textContent=formatTime(arrival);
    }
    if(durationTimeEl){
      const hours=Math.floor(dur/60);
      const mins=dur%60;
      durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;
    }
    
    speak(`${translations[currentLang].navStart} ${dist} km, ${dur} minutes.`);
    
    const controlPanel=document.getElementById("controlPanel");
    if(controlPanel){
      controlPanel.classList.add("hidden");
    }
    document.getElementById("panelToggle").classList.remove("show");
    showAllElements();
  });
}

function stopNav(){
  if(!isNavigating){
    speak("æ¡ˆå†…ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  speak("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã™");
  
  if(!stopAnnounced){
    stopAnnounced=!0;
  }
  
  directionsRenderer.setMap(null);
  directionsRenderer=new google.maps.DirectionsRenderer({map});
  
  isNavigating=!1;
  
  const stopNavRow=document.getElementById("stopNavRow");
  if(stopNavRow){
    stopNavRow.style.display="none";
  }
  
  const stopNavBtn=document.getElementById("stopNavBtn");
  if(stopNavBtn){
    stopNavBtn.disabled=true;
  }
  
  const routeTextEl=document.getElementById("routeText");
  const arrivalTimeEl=document.getElementById("arrivalTime");
  const durationTimeEl=document.getElementById("durationTime");
  
  if(routeTextEl){
    routeTextEl.textContent=translations[currentLang].setDestination;
  }
  if(arrivalTimeEl){
    arrivalTimeEl.textContent="--:--";
  }
  if(durationTimeEl){
    durationTimeEl.textContent="--:--";
  }
  
  const searchBox=document.getElementById("searchBox");
  if(searchBox){
    searchBox.value="";
  }
  
  document.getElementById("panelToggle").classList.add("show");
  
  if(currentMarker){
    map.panTo(currentLocation);
    map.setZoom(18);
  }
}

function stopNavFromPanel(){
  stopNav();
  
  const searchBox=document.getElementById("searchBox");
  if(searchBox){
    searchBox.value="";
  }
  
  if(destMarker){
    destMarker.setMap(null);
    destMarker=null;
  }
}

function reroute(manual=!0){
  if(!isNavigating){
    if(manual)showError("Not navigating");
    return;
  }
  
  directionsService.route({
    origin:currentLocation,
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING,
    provideRouteAlternatives:!0,
    avoidHighways:Math.random()>0.5
  },(res,status)=>{
    if(status!=="OK")return showError("Reroute failed");
    
    const routes=res.routes;
    let selectedRoute=routes[0];
    if(routes.length>1){
      const altIndex=Math.floor(Math.random()*(routes.length-1))+1;
      selectedRoute=routes[altIndex];
    }
    
    directionsRenderer.setDirections({...res,routes:[selectedRoute]});
    
    const leg=selectedRoute.legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    const routeText=`${dist}km, ${dur}min`;
    const routeTextEl=document.getElementById("routeText");
    if(routeTextEl){
      routeTextEl.textContent=routeText;
    }
    
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    
    const currentTimeEl=document.getElementById("currentTime");
    const arrivalTimeEl=document.getElementById("arrivalTime");
    const durationTimeEl=document.getElementById("durationTime");
    
    if(currentTimeEl){
      currentTimeEl.textContent=formatTime(now);
    }
    if(arrivalTimeEl){
      arrivalTimeEl.textContent=formatTime(arrival);
    }
    if(durationTimeEl){
      const hours=Math.floor(dur/60);
      const mins=dur%60;
      durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;
    }
    
    manual&&speak("Rerouting");
  });
}

function formatTime(date){
  const h=date.getHours();
  const m=date.getMinutes().toString().padStart(2,'0');
  return `${h}:${m}`;
}

function updateCurrentTime(){
  const currentTimeEl=document.getElementById("currentTime");
  if(currentTimeEl){
    currentTimeEl.textContent=formatTime(new Date());
  }
}

function saveCurrentPoint(){
  if(!currentLocation)return showError("Getting location");
  const promptText=currentLang==="ja"?"ç¾åœ¨åœ°ç™»éŒ²":"Register current location";
  const name=prompt(promptText);
  if(!name)return;
  
  savedPoints.push({name,lat:currentLocation.lat,lng:currentLocation.lng});
  saveSavedPoints();
  
  const savedText=currentLang==="ja"?"ç™»éŒ²ã—ã¾ã—ãŸ":"Saved";
  showSuccess(savedText);
}

function saveMapPoint(){
  const tapText=currentLang==="ja"?"åœ°å›³ä¸Šã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„":"Tap map location";
  showError(tapText);
  selectingMapPoint=!0;
  
  const listener=map.addListener("click",e=>{
    const promptText=currentLang==="ja"?"ç¾åœ¨åœ°ç™»éŒ²":"Register location";
    const name=prompt(promptText);
    if(name){
      savedPoints.push({name,lat:e.latLng.lat(),lng:e.latLng.lng()});
      saveSavedPoints();
      
      const savedText=currentLang==="ja"?"ç™»éŒ²ã—ã¾ã—ãŸ":"Saved";
      showSuccess(savedText);
    }
    selectingMapPoint=!1;
    google.maps.event.removeListener(listener);
  });
}

function saveSavedPoints(){
  document.cookie=`walkNavSavedPoints=${encodeURIComponent(JSON.stringify(savedPoints))};max-age=31536000;path=/`;
}

function loadSavedPoints(){
  const cookies=document.cookie.split(';');
  for(let cookie of cookies){
    const [name,value]=cookie.trim().split('=');
    if(name==='walkNavSavedPoints'){
      try{
        savedPoints=JSON.parse(decodeURIComponent(value));
      }catch(e){}
      break;
    }
  }
}

function showSavedPoints(){
  if(savedPoints.length===0){
    const noPointsText=currentLang==="ja"?"ä¿å­˜ã•ã‚ŒãŸåœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“":"No saved points";
    showError(noPointsText);
    return;
  }
  
  const panel=document.getElementById("savedPointsPanel");
  const list=document.getElementById("savedPointsList");
  list.innerHTML="";
  
  savedPoints.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="saved-point-item";
    item.innerHTML=`<div class="saved-point-name">${i+1}. ${p.name}</div>`;
    item.onclick=()=>{
      destMarker&&destMarker.setMap(null);
      destMarker=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map});
      map.panTo({lat:p.lat,lng:p.lng});
      map.setZoom(18);
      hideSavedPoints();
      
      const controlPanel=document.getElementById("controlPanel");
      if(controlPanel){
        controlPanel.classList.add("hidden");
      }
      document.getElementById("panelToggle").classList.add("show");
      showAllElements();
      
      setTimeout(()=>{
        if(currentMarker&&destMarker)startNav();
      },500);
    };
    list.appendChild(item);
  });
  
  document.getElementById("btnCloseSaved").textContent=translations[currentLang].btnCloseSaved;
  
  panel.style.display="block";
  
  hideAllElements();
}

function editSavedPoints(){
  if(savedPoints.length===0){
    showError(translations[currentLang].edit==="Edit"?"No saved points":"ä¿å­˜ã•ã‚ŒãŸåœ°ç‚¹ãŒã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  const panel=document.getElementById("savedPointsPanel");
  const list=document.getElementById("savedPointsList");
  list.innerHTML="";
  
  savedPoints.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="saved-point-item";
    
    const nameDiv=document.createElement("div");
    nameDiv.className="saved-point-name";
    nameDiv.textContent=`${i+1}. ${p.name}`;
    
    const actionsDiv=document.createElement("div");
    actionsDiv.className="saved-point-actions";
    
    const editBtn=document.createElement("div");
    editBtn.className="saved-point-btn";
    editBtn.textContent=translations[currentLang].edit;
    editBtn.onclick=(e)=>{
      e.stopPropagation();
      editPointName(i);
    };
    
    const deleteBtn=document.createElement("div");
    deleteBtn.className="saved-point-btn delete";
    deleteBtn.textContent=translations[currentLang].delete;
    deleteBtn.onclick=(e)=>{
      e.stopPropagation();
      deletePoint(i);
    };
    
    actionsDiv.appendChild(editBtn);
    actionsDiv.appendChild(deleteBtn);
    item.appendChild(nameDiv);
    item.appendChild(actionsDiv);
    list.appendChild(item);
  });
  
  document.getElementById("btnCloseSaved").textContent=translations[currentLang].btnCloseSaved;
  
  panel.style.display="block";
  
  hideAllElements();
}

function editPointName(index){
  const promptText=currentLang==="ja"?"æ–°ã—ã„åå‰ã‚’å…¥åŠ›":"Enter new name";
  const newName=prompt(promptText,savedPoints[index].name);
  if(newName){
    savedPoints[index].name=newName;
    saveSavedPoints();
    editSavedPoints();
  }
}

function deletePoint(index){
  const confirmText=currentLang==="ja"?"ã“ã®åœ°ç‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ":"Delete this point?";
  if(confirm(confirmText)){
    savedPoints.splice(index,1);
    saveSavedPoints();
    if(savedPoints.length>0){
      editSavedPoints();
    }else{
      hideSavedPoints();
    }
  }
}

function hideSavedPoints(){
  document.getElementById("savedPointsPanel").style.display="none";
  showAllElements();
}

async function fetchLocationName(){
  if(!currentLocation)return;
  
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lng}&format=json&accept-language=${currentLang}`);
    const data=await res.json();
    
    console.log("=== Location Debug ===");
    console.log("Display name:", data.display_name);
    console.log("Address:", data.address);
    
    let locationText="";
    
    // addressã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ç›´æ¥å–å¾—ï¼ˆroadã‚’é™¤å¤–ï¼‰
    const state=data.address?.state||"";
    const county=data.address?.county||"";
    const city=data.address?.city||data.address?.town||data.address?.village||"";
    const suburb=data.address?.suburb||"";
    const hamlet=data.address?.hamlet||"";
    const house_number=data.address?.house_number||"";
    
    console.log("Parsed parts:", {state, county, city, suburb, hamlet, house_number});
    
    // éƒ½é“åºœçœŒã‚’é™¤å¤–ã—ã¦è¡¨ç¤º
    if(county)locationText+=county;
    if(city)locationText+=city;
    if(suburb)locationText+=suburb;
    if(hamlet)locationText+=hamlet;
    if(house_number)locationText+=house_number;
    
    if(locationText)locationText+="ä»˜è¿‘";
    
    console.log("Final text:", locationText);
    
    if(!locationText)locationText=translations[currentLang].loading;
    
    const locationNameEl=document.getElementById("locationName");
    if(locationNameEl){
      locationNameEl.textContent=locationText;
    }
    
    // åœ°å›³ä¸Šã®ä½æ‰€è¡¨ç¤ºã¯è¡Œã‚ãªã„ï¼ˆãƒ‘ãƒãƒ«ã®ã¿è¡¨ç¤ºï¼‰
    // const currentLocationDisplayEl=document.getElementById("currentLocationDisplay");
    // if(currentLocationDisplayEl){
    //   const displayEl=currentLocationDisplayEl.querySelector("div");
    //   if(displayEl){
    //     displayEl.textContent=locationText;
    //   }
    // }
  }catch(e){
    const locationNameEl=document.getElementById("locationName");
    if(locationNameEl){
      locationNameEl.textContent=translations[currentLang].loading;
    }
  }
}

async function fetchWeather(){
  if(!currentLocation)return;
  
  try{
    const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia/Tokyo&forecast_days=1`);
    const data=await res.json();
    
    const now=new Date();
    const currentHour=now.getHours();
    
    const hours=[3,6,9,12];
    const weatherIcons={0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",71:"ğŸŒ¨ï¸",73:"ğŸŒ¨ï¸",75:"ğŸŒ¨ï¸",77:"ğŸŒ¨ï¸",80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",85:"ğŸŒ¨ï¸",86:"ğŸŒ¨ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"};
    
    hours.forEach(h=>{
      const targetHour=(currentHour+h)%24;
      const idx=data.hourly.time.findIndex(t=>new Date(t).getHours()===targetHour);
      
      if(idx>=0){
        const temp=Math.round(data.hourly.temperature_2m[idx]);
        const rain=data.hourly.precipitation_probability[idx]||0;
        const code=data.hourly.weathercode[idx];
        const icon=weatherIcons[code]||"â˜ï¸";
        
        const wEl=document.getElementById(`w${h}h`);
        const tEl=document.getElementById(`t${h}h`);
        const rEl=document.getElementById(`r${h}h`);
        
        if(wEl)wEl.textContent=icon;
        if(tEl)tEl.textContent=`${temp}Â°`;
        if(rEl)rEl.textContent=`${rain}%`;
      }
    });
  }catch(e){
    console.error("Weather error:",e);
  }
  
  fetchIncidents();
}

let lastIncidentTime=0;
let currentIncidentText="";

async function fetchIncidents(){
  const incidents=[
    "âš ï¸ ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã•ã‚Œã¦ã„ã‚‹äº‹ä»¶ã€äº‹æ•…ã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",
    "â˜” é™é›¨ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚å‚˜ã®æº–å‚™ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
    "âš¡ é›·æ³¨æ„å ±ãŒç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å»ºç‰©å†…ã¸ã®é¿é›£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",
    "ğŸŒ«ï¸ è¦–ç•Œä¸è‰¯ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚æ­©è¡Œæ™‚ã¯å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "ğŸš¸ å­¦æ ¡ä»˜è¿‘ã§ã¯å…ç«¥ãƒ»ç”Ÿå¾’ã®é€šè¡Œã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "ğŸ¦Œ é‡ç”Ÿå‹•ç‰©ã®å‡ºæ²¡æƒ…å ±ãŒã‚ã‚Šã¾ã™ã€‚å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "âš ï¸ å·¥äº‹åŒºé–“ãŒã‚ã‚Šã¾ã™ã€‚è¿‚å›è·¯ã®åˆ©ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚"
  ];
  
  const randomIncident=incidents[Math.floor(Math.random()*incidents.length)];
  const now=Date.now();
  
  const incidentEl=document.getElementById("incidentText");
  if(!incidentEl)return;
  
  if(randomIncident===currentIncidentText){
    if(now-lastIncidentTime<180000){
      incidentEl.style.animation="none";
      incidentEl.textContent=currentIncidentText;
      return;
    }
  }
  
  currentIncidentText=randomIncident;
  lastIncidentTime=now;
  incidentEl.textContent=randomIncident;
  incidentEl.style.animation="marquee 20s linear infinite";
  
  setTimeout(()=>{
    if(incidentEl){
      incidentEl.style.animation="none";
    }
  },20000);
}

function showError(msg){
  const el=document.getElementById("error");
  el.textContent=msg;
  el.classList.remove("hidden");
  setTimeout(()=>el.classList.add("hidden"),3000);
}

function showSuccess(msg){
  const el=document.getElementById("success");
  el.textContent=msg;
  el.classList.remove("hidden");
  setTimeout(()=>el.classList.add("hidden"),3000);
}

function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang=currentLang==="ja"?"ja-JP":"en-US";
    u.rate=0.9;
    speechSynthesis.speak(u);
  }catch(e){}
}

window.addEventListener("load",initMap);
  </script>
  <script>
    const urlParams=new URLSearchParams(window.location.search);
    const lang=urlParams.get('lang')||'ja';
    const script=document.createElement('script');
    script.src=`https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places`;
    script.async=true;
    script.defer=true;
    document.body.appendChild(script);
  </script>
</body>
</html>
