<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
      --btnfg:#111;
      --btnbg:#eaf2ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .panel{
      position:absolute;left:12px;right:12px;top:12px;z-index:10;
      background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      border-radius:14px;padding:14px;max-width:820px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .panel h3{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 280px}
    .input{
      width:100%;height:44px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;font-size:16px;
    }
    select.input{padding-right:32px}
    .btn{
      height:44px;min-width:92px;border-radius:10px;border:1px solid var(--stroke);
      background:var(--btnbg);color:var(--btnfg);padding:0 14px;font-weight:600;cursor:pointer;
    }
    .btn.secondary{background:rgba(255,255,255,.18);color:#111}
    .check{display:flex;align-items:center;gap:6px;color:var(--text);opacity:.9}
    .check input{width:18px;height:18px}

    .results{position:absolute;left:12px;top:110px;right:12px;z-index:9;max-width:820px;margin:0 auto;}
    .card{margin-top:10px;background:rgba(10,19,33,.92);border:1px solid var(--stroke);border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.28)}
    .item{display:flex;gap:12px;align-items:flex-start;padding:14px 16px;border-top:1px solid var(--stroke)}
    .item:first-child{border-top:none}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--accent);margin-top:7px;flex:0 0 9px}
    .ititle{font-weight:700}
    .imeta{color:var(--muted);font-size:13px;margin-top:2px}
    .go{margin-left:auto;align-self:center;background:var(--btnbg);color:var(--btnfg);border:1px solid var(--stroke);height:36px;min-width:64px;border-radius:9px;cursor:pointer}
    .empty{padding:20px;color:var(--muted)}

    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;border:0;display:none;z-index:20;color:#fff;font-weight:600}
    .routeHud{position:absolute;right:12px;bottom:12px;z-index:8;background:rgba(10,19,33,.92);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:10px 12px;min-width:200px}
    @media (max-width:640px){.btn{min-width:84px}.panel{padding:12px}.results{top:104px}}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div class="panel" id="searchPanel" role="region" aria-label="search">
      <h3 id="title">近くを検索</h3>
      <div class="row">
        <input id="q" class="input grow" type="text" inputmode="search" placeholder="店名・カテゴリ・住所・電話・座標・施設" />
        <select id="radius" class="input" style="width:110px">
          <option value="10000">10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>
        <button id="btnSearch" class="btn">検索</button>
        <button id="btnClear" class="btn secondary">クリア</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="check"><input id="optUseCenter" type="checkbox" /> Use map center</label>
        <label class="check"><input id="optOpenNow" type="checkbox" /> 営業中</label>
        <label class="check"><input id="optSortRating" type="checkbox" /> 高レビュー順</label>
        <label class="check"><input id="optPhotos" type="checkbox" /> 画像あり</label>
        <button id="btnSetHere" class="btn secondary" title="Set current to map center">Set here</button>
        <span id="coord" style="margin-left:auto;color:var(--muted);font-variant-numeric:tabular-nums">Lat: -- / Lng: --</span>
      </div>
    </div>

    <div class="results" id="results"></div>

    <div class="routeHud" id="routeHud" hidden>
      <div><strong id="routeTitle">Route</strong></div>
      <div id="routeMeta" class="imeta">--</div>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    const ORS_BASE = "https://ors-proxy.miyata-connect-jp.workers.dev";

    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const $ = (id)=>document.getElementById(id);
    const toast = (msg, ok=false) => {
      const el = $("toast");
      el.style.background = ok ? "#25d07a" : "#ff6565";
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 3200);
    };

    async function waitForGoogleMaps(timeout = 15000) {
      const start = performance.now();
      while (performance.now() - start < timeout) {
        if (window.google && google.maps && google.maps.importLibrary) return true;
        await sleep(50);
      }
      throw new Error("Google Maps failed to load within timeout.");
    }

    let map, here = { lat: 35.681236, lng: 139.767125 }; // fallback
    let curMarker, destMarker, directionsService, directionsRenderer;

    try {
      await waitForGoogleMaps();

      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      const { DirectionsService, DirectionsRenderer } = await google.maps.importLibrary("routes");

      map = new Map($("map"), { center: here, zoom: 16, mapId: "DEMO_MAP", disableDefaultUI: true });
      curMarker = new AdvancedMarkerElement({ map, position: here });
      directionsService = new DirectionsService();
      directionsRenderer = new DirectionsRenderer({ map, suppressMarkers: true });

      updateCoord(here);

      // Race geolocation with timeout; fallback to map center w/o blocking
      locate(4000).then(p=>{
        here = p; curMarker.position = here; map.setCenter(here); updateCoord(here);
        toast("現在地を取得しました", true);
      }).catch(()=> {
        updateCoord(map.getCenter().toJSON());
        toast("測位できないため地図中心を使用します（検索は可能）");
      });

      // UI events
      $("btnSearch").addEventListener("click", doSearch);
      $("btnClear").addEventListener("click", clearResults);
      $("q").addEventListener("keydown", e=>{ if(e.key==="Enter") doSearch(); });
      $("btnSetHere").addEventListener("click", ()=> {
        const c = map.getCenter().toJSON();
        here = c; curMarker.position = here; updateCoord(here);
        toast("“Here” を地図中心に設定", true);
      });

      // Map gestures: long-press / Alt+Click set here
      map.addListener("click", (ev)=>{
        if (ev.domEvent && ev.domEvent.altKey) {
          setHere(ev.latLng.toJSON());
        }
      });
      let pressTimer;
      map.addListener("mousedown", (ev)=>{ pressTimer = setTimeout(()=> setHere(ev.latLng.toJSON()), 650); });
      ["mouseup","dragstart"].forEach(evt=> map.addListener(evt, ()=> clearTimeout(pressTimer)));

    } catch (e) {
      console.error(e);
      toast("初期化エラー: " + e.message);
    }

    function setHere(p){
      here = p; curMarker.position = here; updateCoord(here);
      toast("長押し地点を“Here”に設定", true);
    }

    function updateCoord(pos){
      $("coord").textContent = `Lat: ${pos.lat.toFixed(6)} / Lng: ${pos.lng.toFixed(6)}`;
    }

    async function locate(timeoutMs=10000){
      if(!navigator.geolocation) throw new Error("Geolocation unsupported");
      return await new Promise((resolve, reject)=>{
        let done = false;
        const t = setTimeout(()=>{ if(!done){ done = true; reject(new Error("timeout")); }}, timeoutMs);
        navigator.geolocation.getCurrentPosition(
          g=>{ if(done) return; done = true; clearTimeout(t); resolve({lat:g.coords.latitude,lng:g.coords.longitude}); },
          err=>{ if(done) return; done = true; clearTimeout(t); reject(new Error(err.message||"Location error")); },
          {enableHighAccuracy:true, timeout:timeoutMs, maximumAge:0}
        );
      });
    }

    async function doSearch(){
      const q = $("q").value.trim();
      const radius = parseInt($("radius").value,10) || 10000;
      const openNow = $("optOpenNow").checked;
      const sortByRating = $("optSortRating").checked;
      const withPhotos = $("optPhotos").checked;
      const useCenter = $("optUseCenter").checked;

      if(!q){ toast("キーワードを入力してください"); return; }

      const center = useCenter ? map.getCenter().toJSON() : here;

      const body = {
        textQuery: q,
        languageCode: "ja",
        regionCode: "JP",
        pageSize: 5,
        locationBias: { circle: { center: { latitude: center.lat, longitude: center.lng }, radius } },
        openNow
      };

      try{
        const r = await fetch(`${ORS_BASE}/places:searchText`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        if(!r.ok) throw new Error(`Places API ${r.status}`);
        const data = await r.json();
        let list = (data.places || []).slice(0);

        if(withPhotos){ list = list.filter(p => Array.isArray(p.photos) && p.photos.length>0); }
        if(sortByRating){ list.sort((a,b)=> (b.rating||0) - (a.rating||0)); }
        else { list.sort((a,b)=> dist(center,a.location) - dist(center,b.location)); }

        list = list.slice(0,5);
        renderResults(list, radius, center);
        if(list.length===0) toast("該当なし", true);
      }catch(e){
        console.error(e);
        toast("検索エラー: " + (e.message||"Failed to fetch"));
      }
    }

    function dist(a,b){ const dx = (a.lat - b.latitude), dy = (a.lng - b.longitude); return Math.hypot(dx,dy); }
    function km(m){ return (m/1000).toFixed(2); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function renderResults(list, radius, center){
      const wrap = document.createElement("div");
      wrap.className = "card"; wrap.setAttribute("role","list");
      wrap.innerHTML = list.length ? "" : `<div class="empty">結果がありません</div>`;

      list.forEach((p)=>{
        const d = haversine(center.lat, center.lng, p.location.latitude, p.location.longitude);
        const el = document.createElement("div");
        el.className = "item"; el.setAttribute("role","listitem");
        el.innerHTML = `
          <div class="dot"></div>
          <div class="grow">
            <div class="ititle">${escapeHtml(p.displayName?.text || "名称不明")}</div>
            <div class="imeta">
              ${d.toFixed(2)} km ・ ${escapeHtml(p.formattedAddress || "")}
              ${p.rating?` ・ ⭐ ${p.rating}`:""}
            </div>
          </div>
          <button class="go" aria-label="Go">Go</button>
        `;
        el.querySelector(".go").addEventListener("click", ()=> startRoute(p, center));
        wrap.appendChild(el);
      });

      const host = $("results");
      host.innerHTML = "";
      host.appendChild(wrap);
      $("title").textContent = `近くを検索（${Math.round(radius/1000)} km / ${list.length}件）`;
    }

    async function startRoute(place, centerOrigin){
      const origin = centerOrigin || here;
      const dst = { lat: place.location.latitude, lng: place.location.longitude };

      if(!destMarker){
        const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
        destMarker = new AdvancedMarkerElement({ map, position: dst });
      }else{
        destMarker.position = dst;
      }

      try{
        const url = new URL(`${ORS_BASE}/directions`);
        url.searchParams.set("origin", `${origin.lat},${origin.lng}`);
        url.searchParams.set("destination", `${dst.lat},${dst.lng}`);
        url.searchParams.set("mode", "walking");
        url.searchParams.set("language", "ja");
        url.searchParams.set("region", "JP");

        const r = await fetch(url.toString(), { method: "GET" });
        if(!r.ok) throw new Error(`Directions ${r.status}`);
        const data = await r.json();
        const route = data.routes?.[0];
        if(!route) throw new Error("ルートなし");

        directionsRenderer.setDirections(data);
        $("routeTitle").textContent = place.displayName?.text || "Destination";
        const leg = route.legs?.[0];
        if(leg) $("routeMeta").textContent = `${leg.distance?.text || ""} ・ ${leg.duration?.text || ""}`;
        $("routeHud").hidden = false;

        map.setCenter(dst);
        toast("ルートを表示しました", true);
      }catch(e){
        console.error(e);
        toast("ルート取得エラー: " + e.message);
      }
    }

    function haversine(lat1, lon1, lat2, lon2){
      const toRad = d => d*Math.PI/180; const R = 6371;
      const dLat = toRad(lat2-lat1), dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
  </script>
</body>
</html>