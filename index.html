<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cloudflare Workers ナビ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{
  --bg:#0f1a25; --panel:#132235; --panel2:#0f1e30;
  --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:sans-serif;}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1 1 200px}
input,button,select{border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:var(--panel2);color:var(--text);padding:12px 14px;font-size:16px;outline:none}
button.primary{background:var(--primary);border:none;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
.hint{color:var(--muted);font-size:14px}
#msg.danger{color:var(--danger)}
.mapwrap{position:relative}
#map{height:64vh;border-radius:16px;overflow:hidden; background:#0a1320;}
.fab-col{position:absolute;right:12px;bottom:88px;z-index:460;display:flex;flex-direction:column;gap:10px}
.results{margin-top:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
.modal .box{background:var(--panel);border-radius:16px;max-width:520px;width:92vw;padding:16px;}
/* 他のスタイルは省略 */
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <input id="q" class="grow" placeholder="店舗名・住所・電話番号で検索" autocomplete="off">
      <button id="mic" class="ghost">🎤 音声</button>
      <button id="search" class="primary">検索</button>
    </div>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="grow"><div class="hint">開始地点</div><div class="row"><input id="startLon" class="grow" placeholder="経度"><input id="startLat" class="grow" placeholder="緯度"></div></div>
      <div class="grow"><div class="hint">目的地</div><div class="row"><input id="destLon" class="grow" placeholder="経度"><input id="destLat" class="grow" placeholder="緯度"></div></div>
    </div>
    <div class="row" style="margin-top:10px"><button id="modeWalk" class="primary">徒歩</button><button id="modeWheel" class="ghost">車椅子</button><div class="grow"></div><button id="getRoute" class="primary">ルート取得</button><button id="clear" class="ghost">クリア</button></div>
    <div id="msg" class="hint" style="margin-top:6px;">診断を開始します...</div>
  </div>
  <div class="card mapwrap" style="margin-top:12px">
    <div id="map"></div>
    <div class="fab-col"><button id="navStart" class="ok">案内開始</button></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== 最終診断プログラム =====
document.addEventListener('DOMContentLoaded', () => {
    'use strict';
    const msgEl = document.getElementById('msg');
    const mapEl = document.getElementById('map');
    let step = 0;

    function log(message, isError = false) {
        step++;
        const status = isError ? '❌ 失敗' : '✅ 成功';
        msgEl.innerHTML = `ステップ ${step}/8: ${message} ... ${status}`;
        msgEl.style.color = isError ? 'var(--danger)' : 'var(--ok)';
        if (isError) {
            console.error(message);
            throw new Error(`診断停止: ステップ ${step}で失敗しました。`);
        }
    }

    function finalLog(message) {
        msgEl.innerHTML = `🎉 ${message}`;
        msgEl.style.color = 'var(--ok)';
    }

    // わずかに遅延させて、ブラウザのレンダリングを待つ
    setTimeout(() => {
        try {
            log('DOM要素の取得');

            if (!mapEl || !msgEl) {
                log('必須DOM要素（map or msg）が見つかりません', true);
                return;
            }
            log('DOM要素の取得');

            if (typeof L === 'undefined') {
                log('Leafletライブラリ(L)が見つかりません', true);
                return;
            }
            log('Leafletライブラリのチェック');
            
            if (mapEl.clientHeight === 0) {
                log('地図コンテナの高さが0です。CSSの問題の可能性があります', true);
                return;
            }
            log(`地図コンテナのサイズ確認 (高さ: ${mapEl.clientHeight}px)`);

            const map = L.map('map', { zoomControl: false });
            log('Leaflet地図オブジェクトの作成 (L.map)');

            map.setView([34.342, 134.046], 16);
            log('地図の中心とズームを設定 (setView)');

            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 });
            log('タイルレイヤーの作成 (L.tileLayer)');
            
            tileLayer.addTo(map);
            log('タイルレイヤーを地図に追加 (addTo)');
            
            finalLog('診断完了: 地図の初期化に成功しました。もし地図が表示されていれば、ネットワークかタイルサーバーの問題です。');

        } catch (e) {
            log(`予期せぬエラーが発生: ${e.message}`, true);
        }
    }, 200); // 200ミリ秒待機
});
</script>
</body>
</html>
