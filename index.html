<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}
    /* minimal overlay (kept to avoid UI changes later) */
    .overlay{
      position:absolute;left:12px;right:12px;top:12px;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px);z-index:3
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{
      position:fixed;right:12px;display:flex;flex-direction:column;gap:14px;
      bottom:18px;z-index:4
    }
    .btn{
      width:96px;height:96px;border-radius:24px;background:rgba(255,255,255,.04);
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .toast{
      position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;
      border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:6
    }
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div id="panel" class="overlay" aria-hidden="false">
      <div class="row">
        <strong id="panel-title">Set your destination</strong>
        <span id="coord" style="font-variant-numeric:tabular-nums;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
    </div>

    <div class="pill" aria-hidden="false">
      <button id="btn-current" class="btn" title="Current">Current</button>
      <button id="btn-search" class="btn" title="Search">Search</button>
      <button id="btn-stop" class="btn" title="Stop">Stop</button>
      <button id="btn-dest" class="btn" title="Destination">Dest</button>
      <button id="btn-reroute" class="btn" title="Reroute">Reroute</button>
      <button id="btn-ops" class="btn" title="Ops">Ops</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Async importLibrary loader (official pattern) -->
  <script>
    (g=>{var h,a,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=c in b?b[c]:b[c]={};var d=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{a=m.createElement("script");e.set("libraries",[...d]+"");for(const r in g)e.set(r.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[r]);e.set("callback",c+".maps."+q);a.src=`https://maps.googleapis.com/maps/api/js?`+e;b.maps?f():b.maps={};b.maps[q]=f;a.onerror=()=>n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));b.maps[l]?console.warn(p+" only loads once. Ignoring repeated load."):b.maps[l]=(f,...n)=>d.add(f)&&u().then(()=>b.maps[l](f,...n))})({
      key: "AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk",
      v: "weekly",
      language: "ja",
      region: "JP"
    });
  </script>

  <!-- App code (module) -->
  <script type="module">
    // toast helper
    const toast = (msg, ok=false) => {
      const el = document.getElementById('toast');
      el.style.background = ok ? "#25d07a" : "#ff6b6b";
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 3500);
    };

    // default fallback center (no UI freeze if location fails)
    let map, marker;
    let currentPos = { lat: 35.681236, lng: 139.767125 };

    // safe wrapper to import libs (maps + marker)
    try {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      // initialize map immediately with fallback center
      map = new Map(document.getElementById("map"), {
        center: currentPos,
        zoom: 16,
        disableDefaultUI: true,
        gestureHandling: "greedy"
      });

      marker = new AdvancedMarkerElement({
        map,
        position: currentPos
      });

      // update coordinate panel
      const setCoord = (pos) => {
        const el = document.getElementById("coord");
        el.textContent = `Lat: ${pos.lat.toFixed(6)} / Lng: ${pos.lng.toFixed(6)}`;
      };
      setCoord(currentPos);

      // geolocation: single-get + watch with robust error handling
      const getCurrent = (opts={enableHighAccuracy:true, timeout:10000, maximumAge:0}) =>
        new Promise((resolve, reject) => {
          if(!("geolocation" in navigator)) return reject(new Error("Geolocation unavailable"));
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
            err => reject(new Error(err.message || "Location error")),
            opts
          );
        });

      try {
        const p = await getCurrent();
        currentPos = p;
        map.setCenter(currentPos);
        marker.position = currentPos;
        setCoord(currentPos);
        toast("Location updated", true);
      } catch (e) {
        toast(`Location error: ${e.message}`);
      }

      // watch updates (non-fatal)
      if(navigator.geolocation && navigator.geolocation.watchPosition){
        navigator.geolocation.watchPosition(pos=>{
          const np = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          marker.position = np;
          map.panTo(np);
          setCoord(np);
        }, ()=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
      }

      // wire minimal buttons (no layout/visual changes)
      document.getElementById("btn-current").addEventListener("click", async ()=>{
        try {
          const p = await getCurrent();
          currentPos = p;
          map.setCenter(p);
          marker.position = p;
          setCoord(p);
          toast("Centered to current position", true);
        } catch (e) { toast(`Location error: ${e.message}`); }
      });

      ["btn-search","btn-stop","btn-dest","btn-reroute","btn-ops"].forEach(id=>{
        document.getElementById(id).addEventListener("click", ()=>toast(`${id} tapped`));
      });

    } catch (err) {
      // if importLibrary or map init fails, surface error but keep UI responsive
      console.error("Maps initialization failed:", err);
      toast("Map initialization error");
      // keep panel visible so debugging can proceed
    }
  </script>
</body>
</html>
