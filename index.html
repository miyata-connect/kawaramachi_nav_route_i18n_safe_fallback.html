<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walk-Nav AI (Debugged v4)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
/* --- åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« --- */
:root{--bg:#0f1a25;--panel:#132235;--panel2:#0f1e30;--text:#eaf2ff;--muted:#9db0c6;--ok:#2ecc71;--primary:#4aa3ff;--danger:#ff6b6b;--accent:#4ac8ff;}
body,html{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--text)}
main{max-width:800px;margin:0 auto;padding:10px}
h3{margin:10px 0 5px;padding-bottom:5px;border-bottom:1px solid var(--panel2);color:var(--accent);font-weight:400}
input,button,select{font-size:16px;padding:10px;border-radius:8px;border:1px solid var(--panel2);background:var(--panel);color:var(--text);margin:2px}
button{cursor:pointer}
button.primary{background:var(--primary);color:#fff}
#status{margin-top:8px;color:var(--muted);min-height:1.2em;font-size:14px}
button.loading{opacity:.7;pointer-events:none}
.btn-group{margin-bottom:10px}
.btn-group button.selected{background:var(--accent);color:var(--bg);font-weight:700}

/* --- FIX 2: åº§æ¨™å…¥åŠ›æ¬„ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
.coord-grid{display:flex;flex-wrap:wrap;gap:5px;align-items:center;margin-bottom:5px}
.coord-grid label{font-weight:bold;font-size:15px;flex-basis:60px}
.coord-grid input{flex:1 1 120px}

/* --- åœ°å›³é–¢é€£ --- */
#map{width:100%;height:60vh;border-radius:12px;background:#334;position:relative;overflow:hidden}
.compass-container{position:absolute;left:10px;top:10px;z-index:999;display:flex;flex-direction:column;align-items:center}
.compass{width:60px;height:60px}
#compass-needle{transform-origin:50% 50%;transition:transform .3s linear;fill:var(--danger)}
.heading-modes{background:rgba(19,34,53,0.7);border-radius:8px;padding:4px 6px;margin-top:4px;font-size:12px;color:var(--muted);display:flex;gap:8px}
.heading-modes span{cursor:pointer}
.heading-modes span.selected{color:var(--accent);font-weight:bold}
.fab-container{position:absolute;bottom:20px;right:10px;z-index:999;display:flex;flex-direction:column;gap:10px}
.fab-container button{box-shadow:0 8px 20px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1)}
.fab-container button.selected{background-color:var(--accent);color:var(--bg);}
.leaflet-control-zoom-in, .leaflet-control-zoom-out {width:40px !important;height:40px !important;line-height:40px !important;font-size:24px !important;}
#btn-voice{background-color:var(--ok)}
#btn-voice.recording{background-color:var(--danger);animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.7)}70%{box-shadow:0 0 0 10px rgba(255,107,107,0)}100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}
.user-marker-icon {background-color:var(--accent);width:20px;height:20px;border-radius:50%;border:3px solid #fff;box-shadow:0 0 10px rgba(0,0,0,0.5);transition:transform 0.3s linear;}
.user-marker-icon::after {content:'';position:absolute;top:-6px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:12px solid #fff;}

/* --- FIX 4: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
.nav-popup button {width:100%;padding:8px;font-size:15px;border:none;border-radius:6px;cursor:pointer;margin-bottom:5px;}
.nav-popup .primary {background-color:var(--ok);color:#fff;}
.leaflet-popup-content-wrapper {border-radius:8px;background:var(--panel);}
.leaflet-popup-content {margin:10px;}
.leaflet-popup-tip {background:var(--panel);}

/* --- æ¤œç´¢çµæœãƒ‘ãƒãƒ« --- */
#results{position:fixed;bottom:0;left:0;right:0;background:rgba(15,26,37,.95);backdrop-filter:blur(5px);border-top:1px solid var(--panel2);padding:10px;transform:translateY(100%);transition:transform .3s ease-out;z-index:1000;max-height:50vh;overflow-y:auto}
#results.show{transform:translateY(0)}
#results ul{list-style:none;padding:0;margin:0}
#results li{padding:12px;border-bottom:1px solid var(--panel2);cursor:pointer}
#results li:hover{background:var(--panel)}
#results-list strong{color:var(--accent)}

/* --- ãƒ¢ãƒ¼ãƒ€ãƒ« --- */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1001}.modal-box{background:var(--panel);padding:20px;border-radius:12px;width:90%;max-width:400px}.modal-box h3{margin-top:0}.modal-box input{width:calc(100% - 24px);margin-bottom:10px}.modal-box .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}#load-list li{display:flex;align-items:center;padding:8px;border-bottom:1px solid var(--panel2)}#load-list li .name{flex-grow:1}#load-list li button{margin-left:5px;padding:5px 8px;font-size:14px}
</style>
</head>
<body>

<main>
  <h3 data-i18n="language">è¨€èª</h3>
  <select id="lang-select">
    <option value="ja">æ—¥æœ¬èª</option><option value="en">English</option>
  </select>

  <h3 data-i18n="search">æ¤œç´¢</h3>
  <div class="search-bar">
    <input id="q" data-i18n-placeholder="search_placeholder">
    <button id="btn-voice">ğŸ¤</button>
    <button id="btn-search" class="primary" data-i18n="search_button">æ¤œç´¢</button>
    <button id="btn-clear-history" data-i18n="clear_history_button">å±¥æ­´ã‚¯ãƒªã‚¢</button>
  </div>

  <div id="map">
    <div class="compass-container">
      <div class="compass"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#132235" stroke="#4aa3ff" stroke-width="2"></circle><text x="50" y="28" text-anchor="middle" font-size="22" fill="#fff" font-weight="bold">N</text><polygon id="compass-needle" points="50,10 60,50 50,90 40,50"></polygon><circle cx="50" cy="50" r="5" fill="#4aa3ff"></circle></svg></div>
      <div class="heading-modes">
        <span id="btn-north" data-i18n="north_up">åŒ—å›ºå®š</span>
        <span id="btn-heading" data-i18n="heading_up">é€²è¡Œæ–¹å‘</span>
      </div>
    </div>
    <div class="fab-container">
      <button id="btn-current" data-i18n="current_location_button">ç¾åœ¨åœ°</button>
      <button id="btn-dest" data-i18n="destination_button">ç›®çš„åœ°</button>
      <button id="btn-reroute" data-i18n="reroute_button">ãƒªãƒ«ãƒ¼ãƒˆ</button>
    </div>
  </div>
  <div id="status" data-i18n="status_ready">æº–å‚™å®Œäº†</div>

  <h3 data-i18n="route_mode">ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰</h3>
  <div class="btn-group">
    <button class="mode-btn selected" data-mode="shortest" data-i18n="mode_shortest">æœ€çŸ­Ai</button>
    <button class="mode-btn" data-mode="easy" data-i18n="mode_easy">æ¥½ã¡ã‚“Ai</button>
    <button class="mode-btn" data-mode="walkai" data-i18n="mode_stroll">ãŠæ•£æ­©Ai</button>
    <button class="mode-btn" data-mode="tour" data-i18n="mode_sightseeing">è¦³å…‰Ai</button>
  </div>

  <h3 data-i18n="coordinates">åº§æ¨™</h3>
  <div class="coord-grid">
    <label data-i18n="current_location_label">ç¾åœ¨åœ°</label><input id="start-lng" data-i18n-placeholder="longitude"><input id="start-lat" data-i18n-placeholder="latitude">
  </div>
  <div class="coord-grid">
    <label data-i18n="destination_label">ç›®çš„åœ°</label><input id="end-lng" data-i18n-placeholder="longitude"><input id="end-lat" data-i18n-placeholder="latitude">
  </div>

  </main>

<div id="results">
  <button id="btn-close-results" style="float:right" data-i18n="close_button">é–‰ã˜ã‚‹</button>
  <h3 data-i18n="search_results">æ¤œç´¢çµæœ</h3>
  <ul id="results-list"></ul>
</div>

<div id="save-modal" class="modal"><div class="modal-box"><h3 data-i18n="save_location_title">åœ°ç‚¹ã®ä¿å­˜</h3><input id="save-name" data-i18n-placeholder="save_name_placeholder"><div class="actions"><button id="btn-cancel-save" data-i18n="cancel_button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button id="btn-do-save" class="primary" data-i18n="save_button">ä¿å­˜</button></div></div></div>
<div id="load-modal" class="modal"><div class="modal-box"><h3 data-i18n="saved_locations_title">ä¿å­˜ã—ãŸåœ°ç‚¹</h3><ul id="load-list"></ul><div class="actions"><button id="btn-close-load" data-i18n="close_button">é–‰ã˜ã‚‹</button></div></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/***********************
 * è¨­å®š
 ************************/
const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const PLACES_SEARCH_URL = `${GMAP_PROXY}/places:searchText`;
const DIRECTIONS_URL      = `${GMAP_PROXY}/maps/api/directions/json`;
let currentLang = 'ja', currentMode = 'shortest', watchId = null, headingDeg = 0;
let userMarker = null, destMarker = null, routeLayer = null, lastResults = [], isRecording = false;
let isHeadingUp = false;
const LS_SAVED = 'walknav_saved_locations', LS_HISTORY = 'walknav_hist';

/***********************
 * FIX 1: å¤šè¨€èªå¯¾å¿œ
 ************************/
const translations = {
  ja: {
    language: "è¨€èª", search: "æ¤œç´¢", search_placeholder: "æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰", search_button: "æ¤œç´¢", clear_history_button: "å±¥æ­´ã‚¯ãƒªã‚¢",
    north_up: "åŒ—å›ºå®š", heading_up: "é€²è¡Œæ–¹å‘", current_location_button: "ç¾åœ¨åœ°", destination_button: "ç›®çš„åœ°", reroute_button: "ãƒªãƒ«ãƒ¼ãƒˆ",
    status_ready: "æº–å‚™å®Œäº†", route_mode: "ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰", mode_shortest: "æœ€çŸ­Ai", mode_easy: "æ¥½ã¡ã‚“Ai", mode_stroll: "ãŠæ•£æ­©Ai", mode_sightseeing: "è¦³å…‰Ai",
    coordinates: "åº§æ¨™", current_location_label: "ç¾åœ¨åœ°", destination_label: "ç›®çš„åœ°", longitude: "çµŒåº¦", latitude: "ç·¯åº¦",
    close_button: "é–‰ã˜ã‚‹", search_results: "æ¤œç´¢çµæœ", save_location_title: "åœ°ç‚¹ã®ä¿å­˜", save_name_placeholder: "åå‰ (ä¾‹: è‡ªå®…)",
    cancel_button: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", save_button: "ä¿å­˜", saved_locations_title: "ä¿å­˜ã—ãŸåœ°ç‚¹",
    status_getting_location: "ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦", status_location_error: "ç¾åœ¨åœ°ã‚¨ãƒ©ãƒ¼ï¼š", status_location_set: "ç¾åœ¨åœ°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ",
    status_search_word_required: "æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›", status_searching: "æ¤œç´¢ä¸­â€¦", status_search_failed: "æ¤œç´¢å¤±æ•—ï¼š",
    status_search_results_count: "æ¤œç´¢çµæœï¼š{count}ä»¶", status_route_fetching: "ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦",
    status_route_error: "ãƒ«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼š", status_nav_started: "æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã—ãŸ", status_nav_stopped: "æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸ",
    start_nav: "æ¡ˆå†…é–‹å§‹", stop_nav: "æ¡ˆå†…åœæ­¢"
  },
  en: {
    language: "Language", search: "Search", search_placeholder: "Search term", search_button: "Search", clear_history_button: "Clear History",
    north_up: "North Up", heading_up: "Heading Up", current_location_button: "My Location", destination_button: "Destination", reroute_button: "Reroute",
    status_ready: "Ready", route_mode: "Route Mode", mode_shortest: "Shortest", mode_easy: "Easy", mode_stroll: "Stroll", mode_sightseeing: "Tour",
    coordinates: "Coordinates", current_location_label: "Current", destination_label: "Destination", longitude: "Longitude", latitude: "Latitude",
    close_button: "Close", search_results: "Search Results", save_location_title: "Save Location", save_name_placeholder: "Name (e.g., Home)",
    cancel_button: "Cancel", save_button: "Save", saved_locations_title: "Saved Locations",
    status_getting_location: "Getting current location...", status_location_error: "Location error: ", status_location_set: "Current location set",
    status_search_word_required: "Enter a search term", status_searching: "Searching...", status_search_failed: "Search failed: ",
    status_search_results_count: "Found {count} results", status_route_fetching: "Fetching route...",
    status_route_error: "Route error: ", status_nav_started: "Navigation started", status_nav_stopped: "Navigation stopped",
    start_nav: "Start Navigation", stop_nav: "Stop Navigation"
  }
};
function updateUIText(lang) {
  const t = translations[lang] || translations.ja;
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t[el.dataset.i18n];
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    el.placeholder = t[el.dataset.i18nPlaceholder];
  });
}
function t(key, params = {}) {
  let text = translations[currentLang]?.[key] || translations.ja[key] || key;
  for (const p in params) { text = text.replace(`{${p}}`, params[p]); }
  return text;
}

/***********************
 * åœ°å›³
 ************************/
const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap', maxZoom: 19
}).addTo(map);
L.control.zoom({ position:'bottomleft' }).addTo(map);

const userMarkerIcon = L.divIcon({ className: 'user-marker-icon', iconSize: [20, 20] });

/***********************
 * è¦ç´ 
 ************************/
const $ = s => document.querySelector(s);
const langSelect = $('#lang-select');
const qInput = $('#q'), statusEl = $('#status'), resultsEl = $('#results'), resultsList = $('#results-list');
const btnVoice = $('#btn-voice'), btnSearch = $('#btn-search'), btnClearHistory = $('#btn-clear-history');
const btnCurrent = $('#btn-current'), btnDest = $('#btn-dest'), btnReroute = $('#btn-reroute');
const startLng = $('#start-lng'), startLat = $('#start-lat'), endLng = $('#end-lng'), endLat = $('#end-lat');
const needle = $('#compass-needle');
const btnSave = $('#btn-save'), btnLoad = $('#btn-load');
const saveModal = $('#save-modal'), saveNameInput = $('#save-name'), btnCancelSave = $('#btn-cancel-save'), btnDoSave = $('#btn-do-save');
const loadModal = $('#load-modal'), loadList = $('#load-list'), btnCloseLoad = $('#btn-close-load');
const btnNorth = $('#btn-north'), btnHeading = $('#btn-heading');

/***********************
 * ãƒ„ãƒ¼ãƒ«
 ************************/
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function setStatus(textKey, params = {}){ statusEl.textContent = t(textKey, params) || ''; }
function asLatLng(lngInput, latInput){ const lng = parseFloat(lngInput.value), lat = parseFloat(latInput.value); if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng]; return null; }
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function langCodeToBCP47(l){ const map = {ja:'ja-JP', en:'en-US'}; return map[l] || 'ja-JP'; }
function decodePolyline(str){let index=0,lat=0,lng=0,coordinates=[];while(index<str.length){let b,shift=0,result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);let dlat=(result&1)?~(result>>1):(result>>1);lat+=dlat;shift=0;result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);let dlng=(result&1)?~(result>>1):(result>>1);lng+=dlng;coordinates.push([lat*1e-5,lng*1e-5])}return coordinates}

/***********************
 * éŸ³å£°æ¤œç´¢ãƒ»UIã‚¤ãƒ™ãƒ³ãƒˆ
 ************************/
let recog = null;
function ensureRecog(){
  if(recog) { recog.lang = langCodeToBCP47(currentLang); return recog; }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  recog = new SR();
  recog.lang = langCodeToBCP47(currentLang);
  recog.onstart = ()=> { isRecording=true; btnVoice.classList.add('recording'); setStatus('status_searching'); };
  recog.onend   = ()=> { isRecording=false; btnVoice.classList.remove('recording'); };
  recog.onerror = (e)=> { setStatus('status_location_error', { message: e.error }); };
  recog.onresult= (e)=> { qInput.value = e.results[0][0].transcript; btnSearch.click(); };
  return recog;
}
btnVoice.addEventListener('click', ()=> { const r=ensureRecog(); if (r && !isRecording) r.start(); });

langSelect.addEventListener('change', (e) => {
  currentLang = e.target.value;
  updateUIText(currentLang);
});
$$('.mode-btn').forEach(b=>{ b.addEventListener('click', ()=>{ $$('.mode-btn').forEach(x=>x.classList.remove('selected')); b.classList.add('selected'); currentMode = b.dataset.mode; setStatus(`ãƒ«ãƒ¼ãƒˆï¼š${b.textContent}`); }); });

/***********************
 * ç¾åœ¨åœ°ã¨æ–¹ä½
 ************************/
function getCurrentPosition(opts={}){ return new Promise((res,rej)=>{ navigator.geolocation.getCurrentPosition(res,rej,opts); }); }
async function updateUserLocation(){
  try {
    const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
    const { latitude, longitude } = p.coords;
    map.panTo([latitude, longitude]);
    updateUserMarker(latitude, longitude);
    startLng.value = longitude.toFixed(6);
    startLat.value = latitude.toFixed(6);
    setStatus('status_location_set');
  } catch(e) { setStatus('status_location_error', { message: e.message }); }
}
function watchHeading(){
  if (watchId) return;
  watchId = navigator.geolocation.watchPosition(p=>{
    if (p.coords.heading !== null && p.coords.heading !== undefined) {
      headingDeg = p.coords.heading;
      updateNeedle(headingDeg);
      updateUserMarkerRotation(headingDeg);
    }
    updateUserMarker(p.coords.latitude, p.coords.longitude);
    if (isHeadingUp) {
      map.panTo([p.coords.latitude, p.coords.longitude], { animate: true, duration: 0.5 });
    }
  }, ()=>{}, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
}
function updateNeedle(deg){ needle.style.transform = `rotate(${deg}deg)`; }
function updateUserMarker(lat,lng){
  if (!userMarker){
    userMarker = L.marker([lat,lng], { icon: userMarkerIcon, title: 'ç¾åœ¨åœ°', zIndexOffset: 1000 }).addTo(map);
  } else {
    userMarker.setLatLng([lat,lng]);
  }
}
function updateUserMarkerRotation(deg) {
  if (userMarker && userMarker.getElement()) {
    userMarker.getElement().style.transform += ` rotate(${deg}deg)`;
  }
}
btnCurrent.addEventListener('click', updateUserLocation);

btnNorth.addEventListener('click', () => {
  isHeadingUp = false;
  btnNorth.classList.add('selected');
  btnHeading.classList.remove('selected');
  setStatus('north_up');
});
btnHeading.addEventListener('click', () => {
  isHeadingUp = true;
  btnHeading.classList.add('selected');
  btnNorth.classList.remove('selected');
  setStatus('heading_up');
});

/***********************
 * æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
 ************************/
btnSearch.addEventListener('click', async ()=>{
  const text = qInput.value.trim();
  if (!text){ setStatus('status_search_word_required'); return; }
  btnSearch.classList.add('loading');
  try{
    const resp = await fetch(PLACES_SEARCH_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ textQuery:text, languageCode: currentLang })
    });
    const data = await resp.json();
    if (resp.status !== 200) { throw new Error(data.error?.message || 'Unknown error'); }
    lastResults = (data.places||[]).map(p=>({ id: p.id, name: p.displayName?.text || p.name || '(no name)', address: p.formattedAddress || '', loc: p.location ? [p.location.latitude, p.location.longitude] : null }));
    renderResults(lastResults);
    showResults(true);
    addHistory(text);
    setStatus('status_search_results_count', { count: lastResults.length });
  }catch(e){
    setStatus('status_search_failed', { message: e.message });
  }finally{
    btnSearch.classList.remove('loading');
  }
});
function renderResults(items){
  resultsList.innerHTML = '';
  if (!items.length){ resultsList.innerHTML = `<li>${t('no_results_found')}</li>`; return; }
  items.forEach(r => {
    const li = document.createElement('li');
    li.innerHTML = `<div><strong>${escapeHtml(r.name)}</strong></div><div style="opacity:.85">${escapeHtml(r.address)}</div>`;
    li.addEventListener('click', ()=>{
      if (r.loc){
        endLat.value = r.loc[0].toFixed(6);
        endLng.value = r.loc[1].toFixed(6);
        putDestMarker(r.loc[0], r.loc[1], r.name);
        showResults(false);
        // ãƒ«ãƒ¼ãƒˆå–å¾—ã‚’è‡ªå‹•å®Ÿè¡Œ
        getAndDrawRoute();
      }
    });
    resultsList.appendChild(li);
  });
}
document.getElementById('btn-close-results').addEventListener('click', ()=> showResults(false));
function showResults(flag){ resultsEl.classList.toggle('show', !!flag); }

// (putDestMarkerã¨btnSetDestã¯å»ƒæ­¢ã€ãƒ­ã‚¸ãƒƒã‚¯ã¯ä»–ã¸çµ±åˆ)
function putDestMarker(lat,lng,name){
  if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
  destMarker.setLatLng([lat,lng]).bindPopup(name||'ç›®çš„åœ°').openPopup();
  map.setView([lat,lng], 17);
}


/***********************
 * ãƒ«ãƒ¼ãƒˆå–å¾—ãƒ»æ¡ˆå†…
 ************************/
async function getAndDrawRoute() {
  let start = asLatLng(startLng, startLat);
  const end   = asLatLng(endLng, endLat);
  if (!end){ setStatus('destination_not_set'); return; }
  if (!start){
    try {
      setStatus('status_getting_location');
      const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
      startLat.value = p.coords.latitude.toFixed(6);
      startLng.value = p.coords.longitude.toFixed(6);
      start = [p.coords.latitude, p.coords.longitude];
    } catch(e) { setStatus('start_location_not_set'); return; }
  }
  setStatus('status_route_fetching');
  try{
    const url = new URL(DIRECTIONS_URL);
    url.searchParams.set('origin', `${start[0]},${start[1]}`);
    url.searchParams.set('destination', `${end[0]},${end[1]}`);
    url.searchParams.set('mode','walking');
    url.searchParams.set('language', currentLang);
    const resp = await fetch(url.toString());
    const data = await resp.json();
    if (data.status !== 'OK'){ throw new Error(data.error_message || data.status); }
    drawRoute(data);
    showResults(false);
  }catch(e){
    setStatus('status_route_error', { message: e.message });
  }
}

function drawRoute(d){
  if(routeLayer){ routeLayer.remove(); routeLayer=null; }
  const path = decodePolyline(d.routes[0].overview_polyline.points);
  routeLayer = L.polyline(path, {color:'#22c55e', weight:7, opacity:.88}).addTo(map);
  map.fitBounds(L.latLngBounds(path).pad(0.2));

  // FIX 4: ãƒ«ãƒ¼ãƒˆå–å¾—å¾Œã«ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
  const popupContent = `
    <div class="nav-popup">
      <button id="popup-start-nav" class="primary">${t('start_nav')}</button>
      <button id="popup-stop-nav">${t('stop_nav')}</button>
    </div>
  `;
  if (userMarker) {
    userMarker.bindPopup(popupContent).openPopup();
  }
}

// FIX 4: ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å†…ã®ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰²ã‚Šå½“ã¦
map.on('popupopen', function (e) {
  const startBtn = document.getElementById('popup-start-nav');
  if (startBtn) {
    startBtn.onclick = () => { 
      setStatus('status_nav_started'); 
      // ã“ã“ã«å°†æ¥ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°ãƒŠãƒ“ã®é–‹å§‹ãƒ­ã‚¸ãƒƒã‚¯ãŒå…¥ã‚‹
      if (userMarker) userMarker.closePopup();
    };
  }
  const stopBtn = document.getElementById('popup-stop-nav');
  if (stopBtn) {
    stopBtn.onclick = () => {
      if(routeLayer){ routeLayer.remove(); routeLayer=null; }
      setStatus('status_nav_stopped');
      endLat.value=''; endLng.value='';
      if(destMarker){ destMarker.remove(); destMarker=null; }
      if (userMarker) { userMarker.closePopup(); }
    };
  }
});


btnReroute.addEventListener('click', getAndDrawRoute);
btnDest.addEventListener('click', ()=>{
  const e = asLatLng(endLng, endLat);
  if(!e){ setStatus('destination_not_set'); return; }
  map.setView([e[0], e[1]], 17);
});

/***********************
 * ä¿å­˜ãƒ»å±¥æ­´
 ************************/
// (å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
const addHistory=(text)=>{const h=JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');h.unshift({t:Date.now(),text});localStorage.setItem(LS_HISTORY,JSON.stringify(h.slice(0,50)))};btnClearHistory.addEventListener('click',()=>{localStorage.removeItem(LS_HISTORY);endLat.value='';endLng.value='';if(destMarker){destMarker.remove();destMarker=null}setStatus('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ')});btnSave.addEventListener('click',async()=>{try{setStatus('status_getting_location');const p=await getCurrentPosition({enableHighAccuracy:true,timeout:10000});const{latitude,longitude}=p.coords;saveModal.dataset.lat=latitude;saveModal.dataset.lng=longitude;saveNameInput.value='';saveModal.style.display='flex';saveNameInput.focus();setStatus('save_name_prompt')}catch(e){setStatus('status_save_error',{message:e.message})}});btnDoSave.addEventListener('click',()=>{const name=saveNameInput.value.trim();if(!name){setStatus('name_required');return}const lat=parseFloat(saveModal.dataset.lat);const lng=parseFloat(saveModal.dataset.lng);const saved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');saved.unshift({name,lat,lng,t:Date.now()});localStorage.setItem(LS_SAVED,JSON.stringify(saved.slice(0,50)));saveModal.style.display='none';setStatus('location_saved',{name:name})});btnCancelSave.addEventListener('click',()=>{saveModal.style.display='none'});btnLoad.addEventListener('click',()=>{renderSavedList();loadModal.style.display='flex'});btnCloseLoad.addEventListener('click',()=>{loadModal.style.display='none'});function renderSavedList(){const saved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');loadList.innerHTML='';if(saved.length===0){loadList.innerHTML=`<li>${t('no_saved_locations')}</li>`;return}saved.forEach((item,index)=>{const li=document.createElement('li');const nameSpan=document.createElement('span');nameSpan.className='name';nameSpan.textContent=item.name;const setDestBtn=document.createElement('button');setDestBtn.textContent=t('set_as_destination');setDestBtn.className='primary';setDestBtn.addEventListener('click',()=>{endLat.value=item.lat.toFixed(6);endLng.value=item.lng.toFixed(6);putDestMarker(item.lat,item.lng,item.name);loadModal.style.display='none';setStatus('destination_set',{name:item.name});getAndDrawRoute()});const deleteBtn=document.createElement('button');deleteBtn.textContent=t('delete');deleteBtn.className='danger';deleteBtn.addEventListener('click',()=>{if(confirm(t('confirm_delete',{name:item.name}))){const currentSaved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');const updatedSaved=currentSaved.filter((_,i)=>i!==index);localStorage.setItem(LS_SAVED,JSON.stringify(updatedSaved));renderSavedList()}});li.appendChild(nameSpan);li.appendChild(setDestBtn);li.appendChild(deleteBtn);loadList.appendChild(li)})}


/***********************
 * åˆæœŸåŒ–
 ************************/
async function initializeApp() {
  setStatus('status_getting_location');
  btnNorth.classList.add('selected');
  updateUIText(currentLang); // UIã‚’åˆæœŸè¨€èªã§æç”»
  await updateUserLocation();
  watchHeading();
}
document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
