<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v5.1</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{
  height:100%;
  margin:0;
  background:#0a1321;
  color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
*{box-sizing:border-box}
.app{
  position:relative;
  height:100dvh;
  overflow:hidden;
}
#map{
  position:absolute;
  inset:0;
  display:none;
}
.control-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  backdrop-filter:blur(12px);
  transition:transform .3s ease;
}
.control-panel.hidden{
  transform:translateY(100%);
}
input,button{
  font:inherit;
  color:var(--text);
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:8px;
  padding:8px;
  margin:2px;
}
button{cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    <!-- ▼ hiddenクラス削除：初期表示対応 -->
    <div id="controlPanel" class="control-panel">
      <input id="emergencySearchBox" type="text" placeholder="Search places...">
      <button id="emergencySearchBtn">Search</button>
    </div>
    <div id="debug" style="position:absolute;top:0;left:0;font-size:11px;color:#7ff;background:rgba(0,0,0,.3);max-height:40%;overflow:auto;"></div>
  </div>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places&callback=initMap">
  </script>

  <script>
let map, service;

// ------------------------
// Core Initialization
// ------------------------
function initMap(){
  debugLog('initMap: start');
  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: 35.681236, lng: 139.767125 },
    zoom: 15,
    mapId: "DEMO_MAP",
  });
  service = new google.maps.places.PlacesService(map);
  document.getElementById("map").style.display = "block";
  debugLog('initMap: map ready');
}

// ------------------------
// Safe logger
// ------------------------
function debugLog(){
  try{
    console.debug('[WalkNav]', ...arguments);
    const host=document.getElementById('debug');
    if(host){
      const line=document.createElement('div');
      line.textContent=Array.from(arguments).map(a=>{
        try{return typeof a==='string'?a:JSON.stringify(a);}
        catch{return String(a);}
      }).join(' ');
      host.appendChild(line);
    }
  }catch(e){
    console.debug('[WalkNav][debugLog error]', e);
  }
}

// ------------------------
// Ensure Places Ready
// ------------------------
function ensurePlacesReady(maxWaitMs=4000){
  return new Promise((resolve,reject)=>{
    const start=Date.now();
    (function spin(){
      const ok=(window.google && google.maps && google.maps.places && service);
      if(ok)return resolve();
      if(Date.now()-start>maxWaitMs)return reject(new Error('Places API not ready'));
      setTimeout(spin,80);
    })();
  });
}

// ------------------------
// Execute Search
// ------------------------
async function executeSearch(params){
  try{
    await ensurePlacesReady();
  }catch(e){
    debugLog('executeSearch: Places not ready', e);
    return;
  }
  if(!params || !params.query){
    debugLog('executeSearch: missing query');
    return;
  }

  const request={
    query:params.query,
    fields:["name","geometry"],
    location: map.getCenter(),
    radius: 5000
  };

  try{
    debugLog('executeSearch: start', request.query);
    service.textSearch(request,(results,status)=>{
      if(status===google.maps.places.PlacesServiceStatus.OK && results && results.length){
        debugLog('executeSearch: results', results.length);
        results.forEach(r=>{
          if(r.geometry && r.geometry.location){
            new google.maps.Marker({
              map,
              position:r.geometry.location,
              title:r.name
            });
          }
        });
        map.setCenter(results[0].geometry.location);
      }else{
        debugLog('executeSearch: no results / error', status);
        if(status===google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
          debugLog('No results found.');
        }else if(status===google.maps.places.PlacesServiceStatus.OVER_QUERY_LIMIT){
          debugLog('Query limit exceeded.');
        }else if(status===google.maps.places.PlacesServiceStatus.INVALID_REQUEST){
          debugLog('Invalid request.');
        }else{
          debugLog('Search failed:', status);
        }
      }
    });
  }catch(err){
    debugLog('executeSearch error', err);
  }
}

// ------------------------
// Emergency Search Wrapper
// ------------------------
function emergencySearch(evt){
  if(evt && typeof evt.preventDefault==='function')evt.preventDefault();
  const input=document.getElementById('emergencySearchBox');
  if(!input){
    debugLog('emergencySearch: input not found');
    return;
  }
  const q=(input.value||'').trim();
  if(!q){
    debugLog('emergencySearch: empty query');
    return;
  }
  try{
    executeSearch({query:q});
  }catch(e){
    debugLog('emergencySearch error', e);
  }
}

// ------------------------
// Event Binding
// ------------------------
(function bindEmergencySearch(){
  const input=document.getElementById('emergencySearchBox');
  const btn=document.getElementById('emergencySearchBtn');
  if(input){
    input.addEventListener('keydown',e=>{
      if(e.key==='Enter')emergencySearch(e);
    });
  }
  if(btn){
    btn.addEventListener('click',e=>emergencySearch(e));
  }
})();
  </script>
</body>
</html>