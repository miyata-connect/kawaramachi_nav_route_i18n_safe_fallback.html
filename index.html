<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v3</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}

/* 操作パネル */
.control-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:0;
  z-index:500;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:16px 16px 0 0;
  backdrop-filter:blur(14px);
  padding:16px;
  transition:transform 0.3s;
}
.control-panel.hidden{
  transform:translateY(calc(100% - 40px));
}
.panel-toggle{
  position:absolute;
  top:-30px;
  left:50%;
  transform:translateX(-50%);
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:12px 12px 0 0;
  padding:6px 20px;
  color:var(--text);
  font-size:12px;
  cursor:pointer;
}

.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.panel-btn{
  flex:1;
  min-width:120px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:10px;
  color:var(--text);
  font-size:14px;
  text-align:center;
  cursor:pointer;
}
.panel-btn.primary{background:var(--primary);border:none}
.panel-btn.ok{background:var(--ok);border:none}

input{
  width:100%;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  color:var(--text);
  border-radius:10px;
  padding:10px;
  font-size:14px;
}

/* ナビボタン */
.nav-buttons{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  z-index:450;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.nav-btn{
  width:60px;
  height:50px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:var(--text);
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:700;
}
.nav-btn.primary{background:var(--primary);border:none}
.nav-btn.ok{background:var(--ok);border:none}
.nav-btn.danger{background:var(--danger);border:none}
.nav-btn.accent{background:var(--accent);border:none}

/* 検索結果 */
.results-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:10px;
  max-height:60vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:480;
  display:none;
}
.result-item{
  padding:10px;
  border-bottom:1px solid var(--stroke);
  cursor:pointer;
}
.result-item:hover{background:rgba(95,177,255,.2)}
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

.error-banner{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--danger);
  color:#fff;
  border-radius:10px;
  padding:10px;
  text-align:center;
  z-index:999;
}
.hidden{display:none}

.loading-screen{
  position:fixed;
  inset:0;
  background:#0e1a2d;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  transition:opacity 0.3s;
}
.loading-screen.hide{opacity:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    
    <!-- 操作パネル -->
    <div id="controlPanel" class="control-panel">
      <div class="panel-toggle" onclick="togglePanel()">操作パネルを表示</div>
      
      <input id="searchBox" placeholder="店舗名・住所・電話番号で検索" style="margin-bottom:10px">
      
      <div class="panel-row">
        <div class="panel-btn primary" onclick="searchPlace()">検索</div>
        <div class="panel-btn primary" onclick="voiceSearch()">🎤 音声検索</div>
        <div class="panel-btn" onclick="relocalize()">現在地</div>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="saveCurrentPoint()">現在地を登録</div>
        <div class="panel-btn" onclick="saveMapPoint()">地図上を登録</div>
        <div class="panel-btn" onclick="showSavedPoints()">登録地点</div>
      </div>
    </div>
    
    <!-- ナビボタン -->
    <div id="navButtons" class="nav-buttons hidden">
      <div class="nav-btn primary" onclick="goToCurrent()">現在地</div>
      <div class="nav-btn primary" onclick="goToDestination()">目的地</div>
      <div class="nav-btn ok" onclick="startNav()">案内開始</div>
      <div class="nav-btn danger" onclick="stopNav()">案内停止</div>
      <div class="nav-btn accent" onclick="reroute()">リルート</div>
    </div>
    
    <!-- 検索結果 -->
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()">閉じる</div>
    </div>
    
    <div id="error" class="error-banner hidden"></div>
    <div id="loading" class="loading-screen"><div>現在地取得中...</div></div>
  </div>
  
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=!1,currentLocation=null,savedPoints=[],selectingMapPoint=!1,stopAnnounced=!1;

const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";

function togglePanel(){
  const panel=document.getElementById("controlPanel");
  panel.classList.toggle("hidden");
}

window.gm_authFailure=()=>alert("Maps APIエラー");

function initMap(){
  if(!navigator.geolocation)return alert("位置情報非対応");
  
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    map=new google.maps.Map(document.getElementById("map"),{
      center:currentLocation,
      zoom:17,
      mapTypeControl:!1,
      streetViewControl:!1,
      fullscreenControl:!1,
      zoomControl:!1,
    });
    
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    
    currentMarker=new google.maps.Marker({
      position:currentLocation,
      map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"}
    });
    
    document.getElementById("map").style.display="block";
    document.getElementById("loading").classList.add("hide");
    
    startWatch();
  },err=>alert("位置情報取得失敗: "+err.message));
}

function startWatch(){
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    currentMarker&&currentMarker.setPosition(currentLocation);
    isNavigating&&reroute(!1);
  },()=>{},{enableHighAccuracy:!0});
}

async function searchPlace(){
  const q=document.getElementById("searchBox").value.trim();
  if(!q)return showError("検索ワードを入力してください");
  if(!currentLocation)return showError("現在地取得中");
  
  hideResults();
  togglePanel();
  
  try{
    const res=await fetch(PLACES_PROXY,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location"},
      body:JSON.stringify({
        textQuery:q,
        locationBias:{circle:{center:{latitude:currentLocation.lat,longitude:currentLocation.lng},radius:5000}},
        maxResultCount:5
      })
    });
    
    if(!res.ok)throw new Error("検索失敗");
    
    const data=await res.json();
    const places=data?.places||[];
    
    if(places.length===0){
      showError("結果なし");
      speak("該当する地点が見つかりませんでした");
      return;
    }
    
    displayResults(places);
  }catch(e){
    showError("検索エラー: "+e.message);
  }
}

function displayResults(places){
  const list=document.getElementById("resultsList");
  list.innerHTML="";
  
  places.forEach(p=>{
    const item=document.createElement("div");
    item.className="result-item";
    item.innerHTML=`<div style="font-weight:700">${p.displayName?.text||"不明"}</div><div style="font-size:12px;color:var(--muted)">${p.formattedAddress||""}</div>`;
    item.onclick=()=>selectPlace(p);
    list.appendChild(item);
  });
  
  document.getElementById("resultsPanel").style.display="block";
}

function hideResults(){
  document.getElementById("resultsPanel").style.display="none";
}

function selectPlace(place){
  const lat=place.location?.latitude,lng=place.location?.longitude;
  
  destMarker&&destMarker.setMap(null);
  destMarker=new google.maps.Marker({position:{lat,lng},map});
  
  map.panTo({lat,lng});
  map.setZoom(18);
  
  hideResults();
  
  setTimeout(()=>{
    if(currentMarker&&destMarker)startNav();
  },500);
}

function voiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("音声認識非対応");
  
  const rec=new SR;
  rec.lang="ja-JP";
  rec.onresult=e=>{
    document.getElementById("searchBox").value=e.results[0][0].transcript;
    searchPlace();
  };
  rec.onerror=()=>showError("音声認識失敗");
  rec.start();
}

function relocalize(){
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    currentMarker&&currentMarker.setPosition(currentLocation);
    map.panTo(currentLocation);
    map.setZoom(18);
  },()=>showError("位置情報取得失敗"));
}

function goToCurrent(){
  if(!currentMarker)return;
  map.panTo(currentMarker.getPosition());
  map.setZoom(18);
}

function goToDestination(){
  if(!destMarker)return showError("目的地未設定");
  map.panTo(destMarker.getPosition());
  map.setZoom(18);
}

function startNav(){
  if(!currentMarker||!destMarker)return showError("現在地または目的地が未設定");
  
  stopAnnounced=!1;
  
  directionsService.route({
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  },(res,status)=>{
    if(status!=="OK")return showError("経路取得失敗");
    
    directionsRenderer.setDirections(res);
    isNavigating=!0;
    
    const leg=res.routes[0].legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    speak(`案内を開始します。目的地まで約${dist}キロメートル、所要時間は約${dur}分です。`);
    
    document.getElementById("navButtons").classList.remove("hidden");
    document.getElementById("controlPanel").classList.add("hidden");
  });
}

function stopNav(){
  if(!stopAnnounced){
    stopAnnounced=!0;
    speak("案内停止ボタンが押されましたので、案内を終了します。");
  }
  
  directionsRenderer.setDirections({routes:[]});
  isNavigating=!1;
  
  if(currentMarker){
    map.panTo(currentMarker.getPosition());
    map.setZoom(18);
  }
}

function reroute(manual=!0){
  if(!isNavigating){
    if(manual)showError("案内中ではありません");
    return;
  }
  
  directionsService.route({
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING,
    provideRouteAlternatives:!0
  },(res,status)=>{
    if(status!=="OK")return showError("リルート失敗");
    
    const routes=res.routes;
    const alt=routes.length>1?routes[1]:routes[0];
    directionsRenderer.setDirections({...res,routes:[alt]});
    
    manual&&speak("別のルートで案内します");
  });
}

function saveCurrentPoint(){
  if(!currentLocation)return showError("現在地取得中");
  const name=prompt("地点名を入力");
  if(!name)return;
  savedPoints.push({name,lat:currentLocation.lat,lng:currentLocation.lng});
  alert("登録しました");
}

function saveMapPoint(){
  alert("地図上の任意の場所をタップしてください");
  selectingMapPoint=!0;
  
  const listener=map.addListener("click",e=>{
    const name=prompt("地点名を入力");
    if(name){
      savedPoints.push({name,lat:e.latLng.lat(),lng:e.latLng.lng()});
      alert("登録しました");
    }
    selectingMapPoint=!1;
    google.maps.event.removeListener(listener);
  });
}

function showSavedPoints(){
  if(savedPoints.length===0)return alert("登録地点なし");
  
  const list=savedPoints.map((p,i)=>`${i+1}. ${p.name}`).join("\n");
  const idx=prompt(`登録地点:\n${list}\n\n目的地にする番号を入力`);
  
  if(idx&&savedPoints[idx-1]){
    const p=savedPoints[idx-1];
    destMarker&&destMarker.setMap(null);
    destMarker=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map});
    map.panTo({lat:p.lat,lng:p.lng});
    map.setZoom(18);
  }
}

function showError(msg){
  const el=document.getElementById("error");
  el.textContent=msg;
  el.classList.remove("hidden");
  setTimeout(()=>el.classList.add("hidden"),3000);
}

function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    speechSynthesis.speak(u);
  }catch(e){}
}

window.addEventListener("load",initMap);
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places" async defer></script>
</body>
</html>