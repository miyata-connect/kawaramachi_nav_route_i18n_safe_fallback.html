<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav</title>
  <style>
:root{
  --glass: rgba(20,28,44,.54);
  --glass-strong: rgba(16,22,36,.68);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
  --mic-green:#0cb35a;
  --mic-red:#d53d3d;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Meiryo,sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}
.glassbar{position:absolute;left:0;right:0;top:0;z-index:420;padding:10px 12px;pointer-events:none}
.card{pointer-events:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:16px;backdrop-filter: blur(14px) saturate(120%);-webkit-backdrop-filter: blur(14px) saturate(120%);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px 12px;width:min(1100px,96vw);margin:0 auto}
.row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.grow{flex:1 1 220px}
input,button{background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px;outline:none;min-height:44px}
button.primary{background:rgba(95,177,255,.92);border:none;font-weight:700}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button.reroute{background:var(--accent);border:none;color:#fff;font-weight:700}
button.reroute:hover{background:#00c2ff}
#micBtn{background:var(--mic-green)}
#micBtn.rec{background:var(--mic-red)}
.hint{color:var(--muted);font-size:13px}
.comp-wrap{position:absolute;left:10px;top:150px;z-index:425}
.compass{width:90px;height:90px;background:var(--glass);border:1px solid var(--stroke);border-radius:50%;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 10px 26px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
.compass .needle{transform-origin:38px 38px}
.gm-fab-col{display:flex;flex-direction:column;gap:10px;transform:translateY(40px);z-index:430}
.gm-fab-col .btn-wide{min-width:150px;box-shadow:0 12px 26px rgba(0,0,0,.45);background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px}
.gm-fab-col .btn-wide.ok{background:var(--ok);border:none}
.gm-fab-col .btn-wide.danger{background:var(--danger);border:none}
.gm-fab-col .btn-wide.reroute{background:var(--accent);border:none;color:#fff}
.gm-fab-col .zooms{display:flex;flex-direction:column;gap:8px;align-items:center}
.gm-fab-col .btn-zoom{width:44px;height:44px;border-radius:8px;border:1px solid var(--stroke);background:var(--glass-strong);color:#fff;font-size:18px;line-height:44px;text-align:center;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.loading-screen{position:fixed;inset:0;background:#0e1a2d;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:1000;opacity:1;transition:opacity .4s;gap:20px}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-inner{text-align:center;padding:28px 24px}
.loading-title{font-size:26px;font-weight:900;color:#ffffff;margin-bottom:14px;letter-spacing:.02em}
.loading-sub{font-size:18px;line-height:1.6;color:#cfe0ff;white-space:pre-line}
.loading-retry{margin-top:20px}
.debug-log{background:rgba(0,0,0,.7);border:1px solid #444;border-radius:8px;padding:12px;max-width:90vw;max-height:200px;overflow-y:auto;font-size:11px;text-align:left;color:#0f0}
.debug-log div{margin:2px 0;font-family:monospace}
.error-banner{position:absolute;left:12px;right:12px;bottom:12px;z-index:999;background:#d53d3d;color:#fff;border-radius:10px;padding:10px 12px;text-align:center;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    <div id="glassbar" class="glassbar">
      <div class="card row">
        <input id="searchBox" class="grow" placeholder="è¡Œãå…ˆã‚’æ¤œç´¢">
        <button id="searchBtn" class="primary">æ¤œç´¢</button>
        <button id="micBtn">ğŸ¤</button>
        <button id="locBtn">ğŸ“</button>
      </div>
      <div class="hint">éŸ³å£°æ¤œç´¢ãƒ»å†æ¸¬ä½ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</div>
      <div id="status" aria-live="polite" style="color:var(--muted);font-size:13px;margin-top:8px;"></div>
    </div>
    <div class="comp-wrap">
      <div class="compass">
        <svg class="needle" width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M38 8 L42 38 L38 36 L34 38 Z" fill="#ff6565" stroke="#fff" stroke-width="1"/>
          <path d="M38 68 L42 38 L38 40 L34 38 Z" fill="#eaf2ff" stroke="#444" stroke-width="1"/>
          <circle cx="38" cy="38" r="4" fill="#5fb1ff" stroke="#fff" stroke-width="2"/>
        </svg>
      </div>
    </div>
    <div id="loading" class="loading-screen">
      <div class="loading-inner">
        <div class="loading-title">ç¾åœ¨åœ°å–å¾—ä¸­â€¦</div>
        <div class="loading-sub">ãƒ‡ãƒ¼ã‚¿é€šä¿¡æ–™å‰Šæ¸›ã®ãŸã‚ã€<br>ç¾åœ¨åœ°ã®åœ°å›³ã‚’è¡¨ç¤ºä¸­ã§ã™ã€‚<br>ã‚‚ã†å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„â€¦</div>
        <div class="loading-retry hidden">
          <button id="retryBtn" class="primary">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</button>
        </div>
      </div>
      <div id="debugLog" class="debug-log"></div>
    </div>
    <div id="error-banner" class="error-banner hidden">
      <div id="error-text">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>
    </div>
  </div>
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentPositionMarker=null,destinationMarker=null,watchId=null,isNavigating=false,initDone=false,mapCreated=false,currentLocation=null;
const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/places",GEO_TIMEOUT_MS=8000;

function log(msg){
  console.log(msg);
  const el=document.getElementById("debugLog");
  if(el){
    const d=document.createElement("div");
    d.textContent=new Date().toLocaleTimeString()+" "+msg;
    el.appendChild(d);
    el.scrollTop=el.scrollHeight;
  }
}

log("ã‚¢ãƒ—ãƒªèµ·å‹•");
log("URL: "+location.href);
log("User-Agent: "+navigator.userAgent.substring(0,50)+"...");

window.gm_authFailure=function(){log("ERROR: Mapsèªè¨¼å¤±æ•—");showError("APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„");showLoadingRetry()};

window.addEventListener("error",e=>{
  log(`ERROR: ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ - ${e.message}`);
  if(e.message.includes("maps.googleapis.com")){
    log("ERROR: Maps ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—");
    showError("åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    showLoadingRetry();
  }
});

function waitForGoogleMaps(){
  log("Google Maps APIå¾…æ©Ÿé–‹å§‹");
  let attempts=0;
  const maxAttempts=100;
  const checkInterval=setInterval(()=>{
    attempts++;
    if(attempts%10===0)log(`ãƒã‚§ãƒƒã‚¯ä¸­... ${attempts}/${maxAttempts}`);
    if(typeof google!=="undefined"&&google.maps){
      clearInterval(checkInterval);
      log("Google Maps APIèª­ã¿è¾¼ã¿å®Œäº†");
      initMap();
    }else if(attempts>=maxAttempts){
      clearInterval(checkInterval);
      log("ERROR: Maps APIã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ (20ç§’)");
      showError("åœ°å›³ã®èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
      showLoadingRetry();
    }
  },200);
}

function initMap(){
  if(initDone)return;
  initDone=!0;
  log("initMapé–‹å§‹");
  
  if(typeof google==="undefined"||!google.maps){
    log("ERROR: google.mapsæœªå®šç¾©");
    showError("Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");
    showLoadingRetry();
    return;
  }
  
  if(!navigator.geolocation){
    log("ERROR: Geolocationéå¯¾å¿œ");
    showError("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
    showLoadingRetry();
    return;
  }
  
  log("ä½ç½®æƒ…å ±å–å¾—ãƒªã‚¯ã‚¨ã‚¹ãƒˆé–‹å§‹");
  setStatus("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦");
  
  navigator.geolocation.getCurrentPosition(pos=>{
    log(`ä½ç½®å–å¾—æˆåŠŸ: ${pos.coords.latitude}, ${pos.coords.longitude}`);
    log(`ç²¾åº¦: ${pos.coords.accuracy}m`);
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    createMap(currentLocation);
    startLocationWatch();
  },err=>{
    log(`ERROR: ä½ç½®å–å¾—å¤±æ•— - code:${err.code}, msg:${err.message}`);
    const errMsg=getGeoErrorMessage(err);
    showError(errMsg);
    showLoadingRetry();
  },{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function getGeoErrorMessage(err){
  switch(err.code){
    case 1:return "ä½ç½®æƒ…å ±ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    case 2:return "ä½ç½®æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚GPSä¿¡å·ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
    case 3:return "ä½ç½®æƒ…å ±ã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    default:return "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
  }
}

function createMap(center){
  if(mapCreated)return;
  mapCreated=!0;
  log("åœ°å›³ç”Ÿæˆé–‹å§‹");
  
  try{
    map=new google.maps.Map(document.getElementById("map"),{center,zoom:15,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,clickableIcons:!1,zoomControl:!1});
    log("Map ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”ŸæˆæˆåŠŸ");
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    log("DirectionsåˆæœŸåŒ–å®Œäº†");
    
    document.getElementById("map").style.display="block";
    log("åœ°å›³è¡¨ç¤º");
    hideLoading();
    
    mountRightControls();
    bindUI();
    setupCompass();
    placeOrMoveCurrent(center);
    setStatus("åœ°å›³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ");
    log("åˆæœŸåŒ–å®Œäº†");
  }catch(e){
    log("ERROR: åœ°å›³ç”Ÿæˆä¾‹å¤– - "+e.message);
    console.error(e);
    showError("åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ");
    showLoadingRetry();
  }
}

function showLoadingRetry(){
  log("å†å–å¾—UIè¡¨ç¤º");
  const loading=document.getElementById("loading");
  const title=loading.querySelector(".loading-title");
  const sub=loading.querySelector(".loading-sub");
  const retry=loading.querySelector(".loading-retry");
  
  if(title)title.textContent="èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
  if(sub)sub.textContent="ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ã€\nãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚";
  if(retry)retry.classList.remove("hidden");
}

function hideLoading(){
  log("ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º");
  const el=document.getElementById("loading");
  if(el&&"none"!==el.style.display){
    el.classList.add("hide");
    setTimeout(()=>el.style.display="none",400)
  }
}

function relocalize(){
  log("å†å–å¾—é–‹å§‹");
  setStatus("ç¾åœ¨åœ°ã‚’å†å–å¾—ä¸­â€¦");
  if(!navigator.geolocation){
    log("ERROR: Geolocationéå¯¾å¿œ");
    return void showError("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
  }
  
  navigator.geolocation.getCurrentPosition(pos=>{
    log(`å†å–å¾—æˆåŠŸ: ${pos.coords.latitude}, ${pos.coords.longitude}`);
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    if(!mapCreated){
      log("åœ°å›³æœªç”Ÿæˆã®ãŸã‚ createMap å®Ÿè¡Œ");
      createMap(currentLocation);
      startLocationWatch();
    }else{
      log("æ—¢å­˜åœ°å›³ã‚’æ›´æ–°");
      placeOrMoveCurrent(currentLocation);
      map.panTo(currentLocation);
      setStatus("ç¾åœ¨åœ°ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
    }
  },err=>{
    log(`ERROR: å†å–å¾—å¤±æ•— - code:${err.code}`);
    showError(getGeoErrorMessage(err));
    if(!mapCreated)showLoadingRetry();
  },{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function startLocationWatch(){
  if(!navigator.geolocation)return;
  log("ä½ç½®è¿½å¾“é–‹å§‹");
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    placeOrMoveCurrent(currentLocation);
    isNavigating&&reroute(!1);
  },err=>log(`watchPosition error: ${err.message}`),{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function placeOrMoveCurrent(latlng){
  currentPositionMarker?currentPositionMarker.setPosition(latlng):currentPositionMarker=new google.maps.Marker({position:latlng,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"},title:"ç¾åœ¨åœ°"});
}

async function searchPlace(){
  const qv=q("#searchBox").value.trim();
  if(!qv)return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  if(!currentLocation)return showError("ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚");
  
  log(`æ¤œç´¢é–‹å§‹: ${qv}`);
  setStatus("æ¤œç´¢ä¸­â€¦");
  try{
    const payload={
      textQuery:qv,
      locationBias:currentLocation?{circle:{center:{latitude:currentLocation.lat,longitude:currentLocation.lng},radius:20000}}:void 0
    };
    const res=await fetch(PLACES_PROXY,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "X-Goog-FieldMask":"places.displayName,places.location"
      },
      body:JSON.stringify(payload)
    });
    if(!res.ok){
      log(`ERROR: Places APIå¤±æ•— - ${res.status}`);
      throw new Error(await res.text());
    }
    const data=await res.json(),place=data?.places?.[0];
    if(!place){
      log("æ¤œç´¢çµæœ0ä»¶");
      showError("è©²å½“ã™ã‚‹åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      speak("è©²å½“ã™ã‚‹åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      return;
    }
    const lat=place.location?.latitude,lng=place.location?.longitude,name=place.displayName?.text||qv;
    log(`æ¤œç´¢æˆåŠŸ: ${name}`);
    destinationMarker&&destinationMarker.setMap(null);
    destinationMarker=new google.maps.Marker({position:{lat,lng},map,title:name});
    map.panTo({lat,lng});
    setStatus(`æ¤œç´¢å®Œäº†: ${name}`);
  }catch(e){
    log(`ERROR: æ¤œç´¢ä¾‹å¤– - ${e.message}`);
    console.error(e);
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}

function startNav(){
  if(!currentPositionMarker||!destinationMarker)return showError("ç¾åœ¨åœ°ã¾ãŸã¯ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™ã€‚");
  log("æ¡ˆå†…é–‹å§‹");
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  setStatus("çµŒè·¯è¨ˆç®—ä¸­â€¦");
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    if("OK"!==status){
      log(`ERROR: Directionså¤±æ•— - ${status}`);
      showError("çµŒè·¯ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚");
      return;
    }
    log("æ¡ˆå†…é–‹å§‹æˆåŠŸ");
    directionsRenderer.setDirections(res);
    isNavigating=!0;
    speak("æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚");
    setStatus("æ¡ˆå†…ä¸­");
  });
}

function stopNav(){
  log("æ¡ˆå†…åœæ­¢");
  directionsRenderer.setDirections({routes:[]});
  isNavigating=!1;
  speak("æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
  setStatus("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸ");
}

function reroute(manual){
  if(!isNavigating)return void(manual&&showError("æ¡ˆå†…ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"));
  log(manual?"æ‰‹å‹•ãƒªãƒ«ãƒ¼ãƒˆ":"è‡ªå‹•ãƒªãƒ«ãƒ¼ãƒˆ");
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    if("OK"!==status){
      log(`ERROR: ãƒªãƒ«ãƒ¼ãƒˆå¤±æ•— - ${status}`);
      showError("ãƒªãƒ«ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }
    directionsRenderer.setDirections(res);
    manual&&speak("ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚");
    setStatus("çµŒè·¯ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  });
}

function initVoiceRecognition(){
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    log("ERROR: SpeechRecognitionéå¯¾å¿œ");
    return showError("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
  }
  log("éŸ³å£°èªè­˜é–‹å§‹");
  const recognition=new SpeechRecognition,micBtn=q("#micBtn");
  recognition.lang="ja-JP";
  recognition.continuous=!1;
  recognition.interimResults=!1;
  micBtn.classList.add("rec");
  recognition.onresult=e=>{
    const transcript=e.results[0][0].transcript;
    log(`éŸ³å£°èªè­˜çµæœ: ${transcript}`);
    q("#searchBox").value=transcript;
    searchPlace();
    micBtn.classList.remove("rec");
  };
  recognition.onerror=e=>{
    log(`éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: ${e.error}`);
    console.error("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:",e.error);
    showError("éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    micBtn.classList.remove("rec");
  };
  recognition.onend=()=>micBtn.classList.remove("rec");
  recognition.start();
}

function mountRightControls(){
  const c=document.createElement("div");
  c.className="gm-fab-col";
  const btnStart=mkBtn("æ¡ˆå†…é–‹å§‹","ok","gm-start-nav"),btnStop=mkBtn("æ¡ˆå†…ã‚’åœæ­¢","danger","gm-stop-nav"),btnReroute=mkBtn("ãƒªãƒ«ãƒ¼ãƒˆ","reroute","gm-reroute"),zooms=document.createElement("div");
  zooms.className="zooms";
  zooms.append(mkBtn("ï¼‹","btn-zoom","gm-zoom-in"),mkBtn("ï¼","btn-zoom","gm-zoom-out"));
  c.append(btnStart,btnStop,btnReroute,zooms);
  map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(c);
  const gb=q("#glassbar"),toggle=()=>{const visible=gb&&"none"!==getComputedStyle(gb).display;c.style.display=visible?"none":""};
  new MutationObserver(toggle).observe(document.body,{attributes:!0,childList:!0,subtree:!0});
  addEventListener("resize",toggle);
  setTimeout(toggle,100);
}

function mkBtn(label,cls,id){
  const b=document.createElement("button");
  b.textContent=label;
  b.className=cls.includes("btn-zoom")?cls:`btn-wide ${cls}`;
  b.id=id;
  return b;
}

function bindUI(){
  q("#searchBtn").onclick=searchPlace;
  q("#micBtn").onclick=initVoiceRecognition;
  q("#locBtn").onclick=relocalize;
  const retryBtn=q("#retryBtn");
  retryBtn&&(retryBtn.onclick=()=>location.reload());
  q("#searchBox").addEventListener("keydown",e=>{"Enter"===e.key&&searchPlace()});
  document.addEventListener("click",e=>{
    const id=e.target?.id||"";
    "gm-start-nav"===id?startNav():"gm-stop-nav"===id?stopNav():"gm-reroute"===id?reroute(!0):"gm-zoom-in"===id?map.setZoom(map.getZoom()+1):"gm-zoom-out"===id&&map.setZoom(map.getZoom()-1);
  });
}

let compassAlpha=0,targetAlpha=0;
function setupCompass(){
  const needle=document.querySelector(".needle");
  if(!needle)return;
  !function animate(){compassAlpha=.8*compassAlpha+.2*targetAlpha;needle.style.transform=`rotate(${compassAlpha}deg)`;requestAnimationFrame(animate)}();
  
  if("undefined"!=typeof DeviceOrientationEvent){
    window.addEventListener("deviceorientation",e=>{"number"==typeof e.alpha&&(targetAlpha=e.alpha)});
  }
  
  let lastHeading=Date.now();
  const headingFallback=()=>{
    if(Date.now()-lastHeading<300)return;
    if(watchId&&navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        if("number"==typeof pos.coords.heading){
          targetAlpha=pos.coords.heading;
          lastHeading=Date.now();
        }
      });
    }
  };
  setInterval(headingFallback,300);
}

function q(s){return document.querySelector(s)}
function setStatus(s){const el=q("#status");el&&(el.textContent=s||"")}
function showError(msg){
  const b=q("#error-banner"),t=q("#error-text");
  t&&(t.textContent=msg);
  b&&(b.classList.remove("hidden"),setTimeout(()=>b.classList.add("hidden"),4e3));
  speak(msg);
}
function speak(t){
  try{
    const u=new SpeechSynthesisUtterance(t);
    u.lang="ja-JP";
    u.rate=0.88;
    speechSynthesis.speak(u)
  }catch{}
}

bindUI();
log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆæœŸåŒ–å®Œäº†ã€Mapså¾…æ©Ÿé–‹å§‹");
waitForGoogleMaps();
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places" async defer onerror="log('ERROR: Maps script load failed')"></script>
</body>
</html>
