<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>æ­©è¡Œè€…ãƒŠãƒ“ï¼ˆCloudflare Workers + OSMï¼‰</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">

<style>
:root{
  --bg:#0f1a25; --panel:#132235; --panel2:#0f1e30; --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b;
  --compassSize:82px; --compassMargin:18px; --labelW:8ch;
  --aqua:#7fd3ff;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Helvetica Neue",Arial,"ãƒ¡ã‚¤ãƒªã‚ª",Meiryo,sans-serif;scroll-behavior:smooth}
.wrap{max-width:1100px;margin:0 auto;padding:12px;box-sizing:border-box}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.28);overflow:hidden;box-sizing:border-box}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1 1 200px}
input,button,select{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--panel2);color:var(--text);padding:12px 14px;font-size:16px;outline:none;box-sizing:border-box}
input::placeholder{color:#8aa2bc}
button.primary{background:var(--primary);border:none;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button[disabled]{opacity:.6;pointer-events:none}
.hint{color:var(--muted);font-size:14px}

/* ==== ãƒ«ãƒ¼ãƒˆç¨®åˆ¥ãƒˆã‚°ãƒ«ï¼ˆæ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ç¦æ­¢ãƒ»æŠ˜è¿”ã—ï¼‰ ==== */
.toggle-group{
  display:flex;gap:8px;justify-content:center;align-content:center;
  background:#0b1624;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:8px 10px;
  flex-wrap:wrap; /* â† æ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ç¦æ­¢ã€‚ã¯ã¿å‡ºã™å ´åˆã¯æŠ˜ã‚Šè¿”ã— */
  overflow:hidden; /* â† æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æŠ‘æ­¢ */
}
.toggle input{display:none}
.toggle label{
  display:inline-flex;align-items:center;justify-content:center;
  padding:7px 12px;border-radius:999px;cursor:pointer;white-space:nowrap;
  font-size:clamp(12px,1.6vw,15px); /* ã»ã‚“ã®å°‘ã—å¤§ãã„ */
  font-weight:800;line-height:1;
}
.toggle input:checked + label{
  background:#18314d;box-shadow:0 0 0 3px rgba(74,163,255,.18) inset;border:1px solid rgba(74,163,255,.5)
}

/* æ¤œç´¢UIï¼šãƒã‚¤ã‚¯ã¯ç·‘â†’ãƒ“ã‚¸ãƒ¼ã¯èµ¤ */
#mic{background:var(--ok);border:none;font-weight:800}
.btn-busy{background:var(--danger)!important;border-color:transparent!important}
/* ã€Œæ¤œç´¢ä¸­â€¦ã€ã¯æ°´è‰²ã§å¤§ãã */
#searchStatus.search-large{font-size:18px;font-weight:800;color:var(--aqua)}

/* ç·¯åº¦çµŒåº¦ãƒ–ãƒ­ãƒƒã‚¯ */
.stagger-wrap{display:flex;flex-direction:column;gap:10px}
.st-row{display:flex;gap:12px;align-items:center;flex-wrap:nowrap}
.st-row>.hint{flex:0 0 var(--labelW);min-width:var(--labelW);text-align:left;color:#ffd166;font-weight:800}
.coords{flex:1 1 auto;display:flex;gap:12px;align-items:stretch;flex-wrap:nowrap}
.coord-col{flex:1 1 0;display:flex;flex-direction:column;gap:6px;min-width:0}
.coord-label{font-size:12px;color:var(--muted);padding-left:2px}
.coord-input{width:100%;max-width:none;min-width:0;padding:10px 12px;font-size:16px}

/* Map */
.mapwrap{position:relative;scroll-margin-top:12px}
#map{height:64vh;min-height:360px;border-radius:16px;overflow:hidden;background:#0c1724}
#mapSkeleton{position:absolute;inset:0;pointer-events:none;z-index:1;background:repeating-linear-gradient(90deg,rgba(255,255,255,.06)0,rgba(255,255,255,.06)40px,rgba(255,255,255,.02)40px,rgba(255,255,255,.02)80px);animation:sh 1.15s linear infinite;opacity:.55;border-radius:16px}
@keyframes sh{from{transform:translateX(-28%)}to{transform:translateX(28%)}}

/* ETAãƒ”ãƒ« */
#etaOverlay{position:absolute;left:calc(var(--compassMargin) + var(--compassSize) + 10px);right:12px;top:var(--compassMargin);z-index:470;display:flex;justify-content:center;pointer-events:none}
#etaPill{pointer-events:auto;display:flex;flex-direction:column;gap:4px;align-items:center;background:rgba(8,16,28,.88);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:8px 12px;max-width:520px}
#timeRow{font-size:18px;font-weight:800;opacity:.95;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
#etaMain{font-size:22px;font-weight:900;letter-spacing:.01em}
#etaMain .num{font-size:24px}

/* ã‚³ãƒ³ãƒ‘ã‚¹ */
.compass{position:absolute;left:var(--compassMargin);top:var(--compassMargin);z-index:450;width:var(--compassSize);height:var(--compassSize);border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.35);pointer-events:none}
.compass svg{display:block;width:100%;height:100%}
.compass text{font-size:10px;fill:#f6d365;letter-spacing:.1em}
#needle polygon{fill:#ff4e4e;filter:drop-shadow(0 4px 8px rgba(0,0,0,.35))}

/* Leaflet UIï¼šã‚ºãƒ¼ãƒ  +/âˆ’ å¤§ãã‚ */
.leaflet-control-zoom{left:10px!important;right:auto!important;bottom:14px!important;top:auto!important}
.leaflet-control-zoom a{
  width:56px;height:56px;line-height:56px;font-size:28px;
  border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#0e1a2a;color:#eaf2ff;
}
.leaflet-control-zoom a:hover{filter:brightness(1.15)}
.leaflet-control-attribution{left:8px!important;right:auto!important;bottom:10px!important;max-width:calc(100% - 160px)!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:rgba(0,0,0,.25);color:#eaf2ff;border-radius:10px;padding:2px 6px}

/* FAB */
.fab-col{position:absolute;right:12px;bottom:88px;z-index:460;display:flex;flex-direction:column;gap:10px}
.fab-col button{min-width:126px;padding:10px 12px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35);white-space:nowrap}

/* æ¤œç´¢çµæœ */
.results{margin-top:10px}
.result{background:#0b1624;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.result[role="button"]{outline:none}
.result:focus-visible{box-shadow:0 0 0 3px rgba(74,163,255,.45)}
.result small{color:#a9bed5}
.badge{display:inline-block;background:rgba(255,255,255,.08);padding:3px 8px;border-radius:999px;margin-left:6px}
.results .body{max-height:44vh;overflow:auto;margin-top:8px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆã‚­ãƒ¼ãƒœãƒ¼ãƒ‰å¯¾å¿œï¼‰ */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:12px 12px calc(env(safe-area-inset-bottom) + 12px)}
.modal .box{background:var(--panel);border-radius:16px;width:92vw;max-width:560px;margin:8px auto 0;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.5);max-height:85dvh;overflow:auto}
.modal .title{font-weight:800;margin-bottom:8px}
.modal .row{margin-top:8px}
.modal .actions{position:sticky;bottom:0;display:flex;gap:10px;justify-content:flex-end;margin-top:12px;padding-top:8px;background:linear-gradient(to top, rgba(19,34,53,.98), rgba(19,34,53,.82) 60%, rgba(19,34,53,0))}
</style>
</head>
<body>
<div class="wrap">

  <!-- ãƒ«ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ï¼ˆæ¨ªã‚¹ãƒ©ã‚¤ãƒ‰ç¦æ­¢ãƒ»æŠ˜è¿”ã—ï¼‰ -->
  <div class="card">
    <div class="toggle-group" id="routeToggles" role="radiogroup" aria-label="ãƒ«ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—">
      <div class="toggle"><input type="radio" name="routeMode" id="routeShortest" value="shortest" checked><label for="routeShortest" data-i18n="route.shortest">æœ€çŸ­</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeEasy" value="easy"><label for="routeEasy" data-i18n="route.easy">æ¥½ãƒãƒ³</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeStroll" value="stroll"><label for="routeStroll" data-i18n="route.stroll">ãŠæ•£æ­©AI</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeTour" value="tour"><label for="routeTour" data-i18n="route.tour">è¦³å…‰æ¡ˆå†…ï¼ˆäºˆå®šï¼‰</label></div>
    </div>
  </div>

  <!-- è¨€èªé¸æŠï¼ˆä¿å­˜åœ°ç‚¹ã¨åŒã˜ã‚»ãƒ¬ã‚¯ãƒˆæ–¹å¼ï¼‰ -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="hint" style="min-width:8ch" data-i18n="lang.label">è¨€èª</div>
      <select id="langSelect" class="grow" aria-label="è¨€èªé¸æŠ">
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="fr">FranÃ§ais</option>
        <option value="es">EspaÃ±ol</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <!-- æ¤œç´¢ -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <input id="q" class="grow" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" autocomplete="off" data-i18n-ph="search.placeholder">
      <button id="mic" class="ok" data-i18n="search.voice">ğŸ¤ éŸ³å£°</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="search" class="primary" data-i18n="search.button">æ¤œç´¢</button>
      <button id="clearHistory" class="ghost" data-i18n="search.clear">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      <span id="searchStatus" class="hint" style="min-width:8ch"></span>
    </div>
  </div>

  <!-- åº§æ¨™ï¼†æ“ä½œ -->
  <div class="card" style="margin-top:12px">
    <div class="stagger-wrap">
      <div class="st-row start">
        <div class="hint" data-i18n="coord.start">é–‹å§‹åœ°ç‚¹</div>
        <div class="coords">
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lon">çµŒåº¦</div>
            <input id="startLon" class="coord-input" placeholder="çµŒåº¦" inputmode="decimal" data-i18n-ph="coord.lon">
          </div>
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lat">ç·¯åº¦</div>
            <input id="startLat" class="coord-input" placeholder="ç·¯åº¦" inputmode="decimal" data-i18n-ph="coord.lat">
          </div>
        </div>
      </div>
      <div class="st-row dest">
        <div class="hint" data-i18n="coord.dest">ç›®çš„åœ°ç‚¹</div>
        <div class="coords">
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lon">çµŒåº¦</div>
            <input id="destLon" class="coord-input" placeholder="çµŒåº¦" inputmode="decimal" data-i18n-ph="coord.lon">
          </div>
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lat">ç·¯åº¦</div>
            <input id="destLat" class="coord-input" placeholder="ç·¯åº¦" inputmode="decimal" data-i18n-ph="coord.lat">
          </div>
        </div>
      </div>
    </div>

    <!-- åœ°ç‚¹ä¿å­˜ -->
    <div class="row" style="margin-top:12px">
      <div class="grow">
        <div class="hint" data-i18n="save.label">è¨˜æ†¶åœ°ç‚¹ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰</div>
        <div class="row">
          <select id="savedList" class="grow"></select>
          <button id="openSaveModal" class="ok" data-i18n="save.now">ç¾åœ¨åœ°ã‚’ä¿å­˜</button>
          <button id="setFromSaved" class="primary" data-i18n="save.set">ç›®çš„åœ°ã«è¨­å®š</button>
          <button id="delSaved" class="danger" data-i18n="save.del">å‰Šé™¤</button>
        </div>
      </div>
    </div>

    <div id="msg" class="hint" style="margin-top:6px;" data-i18n="msg.wait">ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…æ©Ÿä¸­â€¦</div>
  </div>

  <!-- åœ°å›³ -->
  <div class="card mapwrap" id="mapCard" style="margin-top:12px">
    <div id="map"></div>
    <div id="mapSkeleton" aria-hidden="true"></div>

    <!-- ETA -->
    <div id="etaOverlay" role="region" aria-label="åˆ°ç€äºˆæƒ³">
      <div id="etaPill">
        <div id="timeRow"><span id="nowClock" data-i18n-prefix="clock.now">ç¾åœ¨ </span>ï½œ<span id="etaClock" data-i18n-prefix="clock.eta">åˆ°ç€ </span></div>
        <div id="etaMain"><span class="num" id="etaDurationTop">â€”</span> ï½œ <span class="num" id="etaDistanceTop">â€”</span></div>
      </div>
    </div>

    <!-- ã‚³ãƒ³ãƒ‘ã‚¹ -->
    <div class="compass" aria-hidden="true">
      <svg viewBox="0 0 74 74">
        <defs><radialGradient id="g1" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#0b1624"/><stop offset="60%" stop-color="#0a1320"/><stop offset="100%" stop-color="#07121e"/></radialGradient></defs>
        <circle cx="37" cy="37" r="36" fill="url(#g1)" stroke="rgba(255,255,255,.15)"/>
        <text x="37" y="12" text-anchor="middle">N</text>
        <g id="needle"><polygon points="37,11 31.5,37 42.5,37"/></g>
        <text x="37" y="66" text-anchor="middle" fill="#b8cce2" data-i18n="compass.caption">é€²è¡Œæ–¹å‘</text>
      </svg>
    </div>

    <div class="fab-col">
      <button id="navStart" class="ok" data-i18n="btn.nav">æ¡ˆå†…é–‹å§‹</button>
      <button id="gotoStart" class="primary" data-i18n="btn.cur">ç¾åœ¨åœ°</button>
      <button id="gotoDest"  class="primary" data-i18n="btn.dest">ç›®çš„åœ°</button>
      <button id="reroute"   class="danger"  data-i18n="btn.reroute">ãƒªãƒ«ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- æ¤œç´¢çµæœ -->
  <div class="card results" id="results" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div><span class="badge" data-i18n="results.heading">æ¤œç´¢çµæœï¼ˆè¿‘éš£ ä¸Šä½5ä»¶ï¼‰</span></div>
      <button id="closeResults" class="ghost" data-i18n="results.close">é–‰ã˜ã‚‹</button>
    </div>
    <div id="resultList" class="body"></div>
  </div>
</div>

<!-- ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="saveModal" aria-modal="true" role="dialog">
  <div class="box">
    <div class="title" data-i18n="save.title">ç¾åœ¨åœ°ã‚’ä¿å­˜</div>
    <div class="row"><input id="saveName" class="grow" placeholder="åœ°ç‚¹åï¼ˆä¾‹ï¼šè‡ªå®…ãƒ»å…¬åœ’ï¼‰" data-i18n-ph="save.namePh"></div>
    <div class="row" style="gap:12px">
      <div class="coord-col" style="flex:1 1 0">
        <div class="coord-label" data-i18n="coord.lon">çµŒåº¦</div>
        <input id="saveLon" class="coord-input" placeholder="çµŒåº¦" inputmode="decimal" data-i18n-ph="coord.lon">
      </div>
      <div class="coord-col" style="flex:1 1 0">
        <div class="coord-label" data-i18n="coord.lat">ç·¯åº¦</div>
        <input id="saveLat" class="coord-input" placeholder="ç·¯åº¦" inputmode="decimal" data-i18n-ph="coord.lat">
      </div>
    </div>
    <div class="actions">
      <button id="cancelSave" class="ghost" data-i18n="common.cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="doSave" class="ok" data-i18n="common.save">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ãƒªãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal" id="rerouteModal" aria-modal="true" role="dialog">
  <div class="box">
    <div class="title" data-i18n="rr.title">ãƒªãƒ«ãƒ¼ãƒˆæ–¹å¼ã‚’é¸æŠï¼ˆå¾’æ­©ï¼‰</div>
    <div class="row">
      <label><input type="radio" name="rr" value="shortest" checked> <span data-i18n="route.shortest">æœ€çŸ­</span></label>
      <label><input type="radio" name="rr" value="easy"> <span data-i18n="route.easy">æ¥½ãƒãƒ³ï¼ˆéšæ®µå›é¿ï¼‰</span></label>
      <label><input type="radio" name="rr" value="stroll"> <span data-i18n="route.stroll">ãŠæ•£æ­©AIï¼ˆé å›ã‚Šå‚¾å‘ï¼‰</span></label>
    </div>
    <div class="actions">
      <button id="cancelRR" class="ghost" data-i18n="common.cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="doRR" class="primary" data-i18n="rr.do">ãƒªãƒ«ãƒ¼ãƒˆ</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" defer></script>

<script>
/* ===== è¨­å®š ===== */
const WORKER_ORIGIN='https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
const OSRM='https://router.project-osrm.org';
const VALHALLA='https://valhalla1.openstreetmap.de/route';
const OVERPASS='https://overpass-api.de/api/interpreter';
const profile='foot-walking';
const ETA_UPDATE_MS=2000;

/* ===== è¦ç´  ===== */
const $=id=>document.getElementById(id);
const els={
  q:$('q'), mic:$('mic'), search:$('search'), clearHistory:$('clearHistory'),
  searchStatus:$('searchStatus'),
  results:$('results'), resultList:$('resultList'), closeResults:$('closeResults'),
  startLat:$('startLat'), startLon:$('startLon'), destLat:$('destLat'), destLon:$('destLon'),
  navStart:$('navStart'), gotoStart:$('gotoStart'), gotoDest:$('gotoDest'), reroute:$('reroute'),
  savedList:$('savedList'), openSaveModal:$('openSaveModal'), saveModal:$('saveModal'),
  saveName:$('saveName'), saveLon:$('saveLon'), saveLat:$('saveLat'),
  cancelSave:$('cancelSave'), doSave:$('doSave'),
  setFromSaved:$('setFromSaved'), delSaved:$('delSaved'),
  routeToggles:$('routeToggles'),
  rerouteModal:$('rerouteModal'), cancelRR:$('cancelRR'), doRR:$('doRR'),
  nowClock:$('nowClock'), etaClock:$('etaClock'), etaDurationTop:$('etaDurationTop'), etaDistanceTop:$('etaDistanceTop'),
  msg:$('msg'), mapCard:$('mapCard'),
  langSelect:$('langSelect')
};

/* ===== çŠ¶æ…‹ ===== */
let map=null, routeLayer=null, markerLayer=null, routeLine=null, lastRoute=null;
let currentMarker=null, destMarker=null, mapReady=false, watchId=null;
let navActive=false, routingLock=false, routeMode='shortest', safetyPoints=[], navState=null;
let followMe=false, lastKnownPos=null;
/* è¨€èª */
let voiceMode='ja';

/* ===== i18nï¼ˆUIè¡¨ç¤ºç”¨ï¼‰ ===== */
const UI_STR={
  ja:{
    title:'æ­©è¡Œè€…ãƒŠãƒ“ï¼ˆCloudflare Workers + OSMï¼‰',
    'route.shortest':'æœ€çŸ­','route.easy':'æ¥½ãƒãƒ³','route.stroll':'ãŠæ•£æ­©AI','route.tour':'è¦³å…‰æ¡ˆå†…ï¼ˆäºˆå®šï¼‰',
    'lang.label':'è¨€èª',
    'search.placeholder':'åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢',
    'search.voice':'ğŸ¤ éŸ³å£°','search.button':'æ¤œç´¢','search.clear':'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢',
    'coord.start':'é–‹å§‹åœ°ç‚¹','coord.dest':'ç›®çš„åœ°ç‚¹','coord.lon':'çµŒåº¦','coord.lat':'ç·¯åº¦',
    'save.label':'è¨˜æ†¶åœ°ç‚¹ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰','save.now':'ç¾åœ¨åœ°ã‚’ä¿å­˜','save.set':'ç›®çš„åœ°ã«è¨­å®š','save.del':'å‰Šé™¤',
    'msg.wait':'ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…æ©Ÿä¸­â€¦','msg.ready':'æº–å‚™å®Œäº†ã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„',
    'results.heading':'æ¤œç´¢çµæœï¼ˆè¿‘éš£ ä¸Šä½5ä»¶ï¼‰','results.close':'é–‰ã˜ã‚‹',
    'btn.nav':'æ¡ˆå†…é–‹å§‹','btn.cur':'ç¾åœ¨åœ°','btn.dest':'ç›®çš„åœ°','btn.reroute':'ãƒªãƒ«ãƒ¼ãƒˆ',
    'save.title':'ç¾åœ¨åœ°ã‚’ä¿å­˜','save.namePh':'åœ°ç‚¹åï¼ˆä¾‹ï¼šè‡ªå®…ãƒ»å…¬åœ’ï¼‰',
    'common.cancel':'ã‚­ãƒ£ãƒ³ã‚»ãƒ«','common.save':'ä¿å­˜',
    'rr.title':'ãƒªãƒ«ãƒ¼ãƒˆæ–¹å¼ã‚’é¸æŠï¼ˆå¾’æ­©ï¼‰','rr.do':'ãƒªãƒ«ãƒ¼ãƒˆ',
    'clock.now':'ç¾åœ¨ ','clock.eta':'åˆ°ç€ ',
    'status.searching':'æ¤œç´¢ä¸­â€¦','status.listening':'éŸ³å£°èªè­˜ä¸­â€¦','status.voiceFail':'éŸ³å£°å¤±æ•—','status.cleared':'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼ˆæ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã—ãŸï¼‰',
    'msg.noStart':'é–‹å§‹åœ°ç‚¹æœªè¨­å®š â†’ åœ°å›³ä¸­å¿ƒã‚’å‡ºç™ºåœ°ã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚','msg.needCoords':'åº§æ¨™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆé–‹å§‹/ç›®çš„åœ°ã‚’è¨­å®šï¼‰','msg.needDest':'å…ˆã«ç›®çš„åœ°ã‚’é¸ã‚“ã§ãã ã•ã„','msg.noDest':'ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™','msg.noCandidates':'å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“','msg.candidates':'å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ãƒªã‚¹ãƒˆã‹ã‚‰é¸ã¶ã¨æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚','msg.searching':'æ¤œç´¢ä¸­â€¦','msg.routeFail':'ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆå†è©¦è¡Œã—ã¦ãã ã•ã„ï¼‰','msg.routeOK':'ãƒ«ãƒ¼ãƒˆå–å¾—å®Œäº†','msg.startNav':'æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™'
  },
  en:{
    title:'Pedestrian Navigator (Cloudflare Workers + OSM)',
    'route.shortest':'Shortest','route.easy':'Easy','route.stroll':'Stroll AI','route.tour':'Tour (planned)',
    'lang.label':'Language',
    'search.placeholder':'Search by name, address or phone',
    'search.voice':'ğŸ¤ Voice','search.button':'Search','search.clear':'Clear history',
    'coord.start':'Start','coord.dest':'Destination','coord.lon':'Longitude','coord.lat':'Latitude',
    'save.label':'Saved places (local)','save.now':'Save current','save.set':'Set as destination','save.del':'Delete',
    'msg.wait':'Waiting for current locationâ€¦','msg.ready':'Ready. Set a destination.',
    'results.heading':'Results (Top 5 nearby)','results.close':'Close',
    'btn.nav':'Start guidance','btn.cur':'My location','btn.dest':'Destination','btn.reroute':'Reroute',
    'save.title':'Save current place','save.namePh':'Place name (e.g., Home/Park)',
    'common.cancel':'Cancel','common.save':'Save',
    'rr.title':'Choose reroute mode (on foot)','rr.do':'Reroute',
    'clock.now':'Now ','clock.eta':'ETA ',
    'status.searching':'Searchingâ€¦','status.listening':'Listeningâ€¦','status.voiceFail':'Voice failed','status.cleared':'History cleared (guidance stopped)',
    'msg.noStart':'No start set â†’ using map center as start.','msg.needCoords':'Missing coordinates (set start/destination).','msg.needDest':'Choose a destination first','msg.noDest':'Destination not set','msg.noCandidates':'No candidates found','msg.candidates':'Found candidates. Tap one to start guidance.','msg.searching':'Searchingâ€¦','msg.routeFail':'Failed to get route (retry)','msg.routeOK':'Route ready','msg.startNav':'Starting guidance'
  },
  ko:{ /* ä»¥é™ã¯ä¸»è¦UIã‚’ç°¡æ˜“è¨³ã€‚å¿…è¦ã«å¿œã˜ã¦ç²¾ç·»åŒ–å¯èƒ½ */
    title:'ë³´í–‰ì ë‚´ë¹„ (Cloudflare Workers + OSM)',
    'route.shortest':'ìµœë‹¨','route.easy':'í¸ì•ˆ','route.stroll':'ì‚°ì±… AI','route.tour':'ê´€ê´‘ ì•ˆë‚´(ì˜ˆì •)',
    'lang.label':'ì–¸ì–´',
    'search.placeholder':'ì´ë¦„Â·ì£¼ì†ŒÂ·ì „í™”ë¡œ ê²€ìƒ‰',
    'search.voice':'ğŸ¤ ìŒì„±','search.button':'ê²€ìƒ‰','search.clear':'ê¸°ë¡ ì§€ìš°ê¸°',
    'coord.start':'ì¶œë°œì§€','coord.dest':'ëª©ì ì§€','coord.lon':'ê²½ë„','coord.lat':'ìœ„ë„',
    'save.label':'ì €ì¥ ì¥ì†Œ(ë¡œì»¬)','save.now':'í˜„ì¬ ìœ„ì¹˜ ì €ì¥','save.set':'ëª©ì ì§€ë¡œ ì„¤ì •','save.del':'ì‚­ì œ',
    'msg.wait':'í˜„ì¬ ìœ„ì¹˜ ëŒ€ê¸° ì¤‘â€¦','msg.ready':'ì¤€ë¹„ ì™„ë£Œ. ëª©ì ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”.',
    'results.heading':'ê²€ìƒ‰ ê²°ê³¼(ì£¼ë³€ ìƒìœ„ 5ê±´)','results.close':'ë‹«ê¸°',
    'btn.nav':'ì•ˆë‚´ ì‹œì‘','btn.cur':'í˜„ì¬ ìœ„ì¹˜','btn.dest':'ëª©ì ì§€','btn.reroute':'ë¦¬ë£¨íŠ¸',
    'save.title':'í˜„ì¬ ìœ„ì¹˜ ì €ì¥','save.namePh':'ì¥ì†Œëª…(ì˜ˆ: ì§‘/ê³µì›)',
    'common.cancel':'ì·¨ì†Œ','common.save':'ì €ì¥',
    'rr.title':'ë¦¬ë£¨íŠ¸ ë°©ì‹ ì„ íƒ(ë„ë³´)','rr.do':'ë¦¬ë£¨íŠ¸',
    'clock.now':'í˜„ì¬ ','clock.eta':'ë„ì°© ',
    'status.searching':'ê²€ìƒ‰ ì¤‘â€¦','status.listening':'ìŒì„± ì¸ì‹ ì¤‘â€¦','status.voiceFail':'ìŒì„± ì‹¤íŒ¨','status.cleared':'ê¸°ë¡ ì‚­ì œ(ì•ˆë‚´ ì¢…ë£Œ)',
    'msg.noStart':'ì¶œë°œì§€ ì—†ìŒ â†’ ì§€ë„ì˜ ì¤‘ì•™ì„ ì‚¬ìš©','msg.needCoords':'ì¢Œí‘œ ë¶€ì¡±(ì¶œë°œ/ëª©ì ì§€ ì„¤ì •)','msg.needDest':'ë¨¼ì € ëª©ì ì§€ë¥¼ ì„ íƒ','msg.noDest':'ëª©ì ì§€ ë¯¸ì„¤ì •','msg.noCandidates':'í›„ë³´ ì—†ìŒ','msg.candidates':'í›„ë³´ ë°œê²¬. íƒ­í•˜ë©´ ì•ˆë‚´ ì‹œì‘.','msg.searching':'ê²€ìƒ‰ ì¤‘â€¦','msg.routeFail':'ê²½ë¡œ íšë“ ì‹¤íŒ¨(ì¬ì‹œë„)','msg.routeOK':'ê²½ë¡œ ì¤€ë¹„ë¨','msg.startNav':'ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤'
  },
  fr:{
    title:'Navigation piÃ©tonne (Cloudflare Workers + OSM)',
    'route.shortest':'Le plus court','route.easy':'Facile','route.stroll':'Balade AI','route.tour':'Visite (prÃ©vu)',
    'lang.label':'Langue',
    'search.placeholder':'Recherche par nom, adresse ou tÃ©lÃ©phone',
    'search.voice':'ğŸ¤ Voix','search.button':'Rechercher','search.clear':'Effacer lâ€™historique',
    'coord.start':'DÃ©part','coord.dest':'Destination','coord.lon':'Longitude','coord.lat':'Latitude',
    'save.label':'Lieux enregistrÃ©s (local)','save.now':'Enregistrer la position','save.set':'DÃ©finir comme destination','save.del':'Supprimer',
    'msg.wait':'En attente de la positionâ€¦','msg.ready':'PrÃªt. DÃ©finissez une destination.',
    'results.heading':'RÃ©sultats (Top 5 proches)','results.close':'Fermer',
    'btn.nav':'DÃ©marrer','btn.cur':'Ma position','btn.dest':'Destination','btn.reroute':'Recalculer',
    'save.title':'Enregistrer ce lieu','save.namePh':'Nom du lieu (ex. Maison/Parc)',
    'common.cancel':'Annuler','common.save':'Enregistrer',
    'rr.title':'Choisir le recalcul (Ã  pied)','rr.do':'Recalculer',
    'clock.now':'Actuel ','clock.eta':'ArrivÃ©e ',
    'status.searching':'Rechercheâ€¦','status.listening':'Ã‰couteâ€¦','status.voiceFail':'Ã‰chec voix','status.cleared':'Historique effacÃ© (guidage arrÃªtÃ©)',
    'msg.noStart':'Pas de dÃ©part â†’ centre de la carte utilisÃ©','msg.needCoords':'CoordonnÃ©es manquantes','msg.needDest':'Choisissez dâ€™abord une destination','msg.noDest':'Destination non dÃ©finie','msg.noCandidates':'Aucun rÃ©sultat','msg.candidates':'Des rÃ©sultats trouvÃ©s. Touchez pour dÃ©marrer.','msg.searching':'Rechercheâ€¦','msg.routeFail':'Ã‰chec dâ€™itinÃ©raire (rÃ©essayez)','msg.routeOK':'ItinÃ©raire prÃªt','msg.startNav':'DÃ©marrage du guidage'
  },
  es:{
    title:'NavegaciÃ³n a pie (Cloudflare Workers + OSM)',
    'route.shortest':'MÃ¡s corto','route.easy':'FÃ¡cil','route.stroll':'Paseo AI','route.tour':'Turismo (previsto)',
    'lang.label':'Idioma',
    'search.placeholder':'Buscar por nombre, direcciÃ³n o telÃ©fono',
    'search.voice':'ğŸ¤ Voz','search.button':'Buscar','search.clear':'Borrar historial',
    'coord.start':'Inicio','coord.dest':'Destino','coord.lon':'Longitud','coord.lat':'Latitud',
    'save.label':'Lugares guardados (local)','save.now':'Guardar ubicaciÃ³n','save.set':'Definir como destino','save.del':'Eliminar',
    'msg.wait':'Esperando ubicaciÃ³nâ€¦','msg.ready':'Listo. Seleccione un destino.',
    'results.heading':'Resultados (Top 5 cercanos)','results.close':'Cerrar',
    'btn.nav':'Iniciar guÃ­a','btn.cur':'Mi ubicaciÃ³n','btn.dest':'Destino','btn.reroute':'Recalcular',
    'save.title':'Guardar este lugar','save.namePh':'Nombre (ej. Casa/Parque)',
    'common.cancel':'Cancelar','common.save':'Guardar',
    'rr.title':'Modo de recÃ¡lculo (a pie)','rr.do':'Recalcular',
    'clock.now':'Ahora ','clock.eta':'Llegada ',
    'status.searching':'Buscandoâ€¦','status.listening':'Escuchandoâ€¦','status.voiceFail':'Fallo de voz','status.cleared':'Historial borrado (guÃ­a detenida)',
    'msg.noStart':'Sin inicio â†’ usar centro del mapa','msg.needCoords':'Faltan coordenadas','msg.needDest':'Elija un destino primero','msg.noDest':'Destino no definido','msg.noCandidates':'Sin resultados','msg.candidates':'Resultados encontrados. Toque para iniciar.','msg.searching':'Buscandoâ€¦','msg.routeFail':'Fallo al obtener ruta (reintente)','msg.routeOK':'Ruta lista','msg.startNav':'Iniciando guÃ­a'
  },
  zh:{
    title:'æ­¥è¡Œå¯¼èˆªï¼ˆCloudflare Workers + OSMï¼‰',
    'route.shortest':'æœ€çŸ­','route.easy':'è½»æ¾','route.stroll':'æ•£æ­¥AI','route.tour':'è§‚å…‰ï¼ˆé¢„å®šï¼‰',
    'lang.label':'è¯­è¨€',
    'search.placeholder':'æŒ‰åç§°/åœ°å€/ç”µè¯æœç´¢',
    'search.voice':'ğŸ¤ è¯­éŸ³','search.button':'æœç´¢','search.clear':'æ¸…é™¤å†å²',
    'coord.start':'èµ·ç‚¹','coord.dest':'ç»ˆç‚¹','coord.lon':'ç»åº¦','coord.lat':'çº¬åº¦',
    'save.label':'å·²ä¿å­˜åœ°ç‚¹ï¼ˆæœ¬æœºï¼‰','save.now':'ä¿å­˜å½“å‰ä½ç½®','save.set':'è®¾ä¸ºç»ˆç‚¹','save.del':'åˆ é™¤',
    'msg.wait':'æ­£åœ¨ç­‰å¾…å½“å‰ä½ç½®â€¦','msg.ready':'å‡†å¤‡å°±ç»ªã€‚è¯·è®¾ç½®ç›®çš„åœ°ã€‚',
    'results.heading':'æœç´¢ç»“æœï¼ˆé™„è¿‘å‰5ï¼‰','results.close':'å…³é—­',
    'btn.nav':'å¼€å§‹å¯¼èˆª','btn.cur':'å½“å‰ä½ç½®','btn.dest':'ç›®çš„åœ°','btn.reroute':'é‡æ–°è§„åˆ’',
    'save.title':'ä¿å­˜å½“å‰ä½ç½®','save.namePh':'åœ°ç‚¹åï¼ˆå¦‚ï¼šå®¶/å…¬å›­ï¼‰',
    'common.cancel':'å–æ¶ˆ','common.save':'ä¿å­˜',
    'rr.title':'é€‰æ‹©é‡æ–°è§„åˆ’æ–¹å¼ï¼ˆæ­¥è¡Œï¼‰','rr.do':'é‡æ–°è§„åˆ’',
    'clock.now':'å½“å‰ ','clock.eta':'åˆ°è¾¾ ',
    'status.searching':'æœç´¢ä¸­â€¦','status.listening':'è¯­éŸ³è¯†åˆ«ä¸­â€¦','status.voiceFail':'è¯­éŸ³å¤±è´¥','status.cleared':'å·²æ¸…é™¤å†å²ï¼ˆå¯¼èˆªå·²åœæ­¢ï¼‰',
    'msg.noStart':'æœªè®¾ç½®èµ·ç‚¹ â†’ ä½¿ç”¨åœ°å›¾ä¸­å¿ƒ','msg.needCoords':'åæ ‡ç¼ºå¤±ï¼ˆè¯·è®¾å®šèµ·/ç»ˆç‚¹ï¼‰','msg.needDest':'è¯·å…ˆé€‰æ‹©ç›®çš„åœ°','msg.noDest':'æœªè®¾ç½®ç›®çš„åœ°','msg.noCandidates':'æ²¡æœ‰ç»“æœ','msg.candidates':'æ‰¾åˆ°å€™é€‰ã€‚ç‚¹å‡»å¼€å§‹å¯¼èˆªã€‚','msg.searching':'æœç´¢ä¸­â€¦','msg.routeFail':'è·å–è·¯çº¿å¤±è´¥ï¼ˆè¯·é‡è¯•ï¼‰','msg.routeOK':'è·¯çº¿å°±ç»ª','msg.startNav':'å¼€å§‹å¯¼èˆª'
  }
};
function t(key){ const u=UI_STR[voiceMode]||UI_STR.ja; return u[key]||UI_STR.ja[key]||key; }

/* UIåæ˜  */
function applyUIStrings(){
  document.title=t('title');
  document.documentElement.lang = voiceMode;
  // data-i18n ã®ãƒ†ã‚­ã‚¹ãƒˆ
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=t(key); if(val!=null) el.textContent=val;
  });
  // data-i18n-ph ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key=el.getAttribute('data-i18n-ph');
    const val=t(key); if(val!=null) el.setAttribute('placeholder', val);
  });
  // æ™‚åˆ»ãƒ©ãƒ™ãƒ«ã®æ¥é ­è¾
  const nowPref=t('clock.now'); if(els.nowClock){ const txt=els.nowClock.textContent.replace(/^.*\s/, ''); els.nowClock.textContent=nowPref + txt; }
  const etaPref=t('clock.eta'); if(els.etaClock){ const txt=els.etaClock.textContent.replace(/^.*\s/, ''); els.etaClock.textContent=etaPref + txt; }
}

/* ===== ãƒŠãƒ“éŸ³å£°ã®I18Nï¼ˆæ—¢å­˜ï¼‰ ===== */
const I18N={ /* çœç•¥ã›ãšæ—¢å­˜ã®ã¾ã¾ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒç­‰ï¼‰ */ 
  ja:{ start:'æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚', near:'ã¾ã‚‚ãªãç›®çš„åœ°ã§ã™ã€‚', arrived:'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸã€‚æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚',
       ahead:'å‰æ–¹', meters:'ãƒ¡ãƒ¼ãƒˆãƒ«', go:'ç›´é€²ã—ã¦ãã ã•ã„', then:'ã€ãã®å¾Œ', proceed:'é€²ã¿ã¾ã™', now:'ã“ã“ã§', head:'æ–¹å‘ã¸', using:'ã§ãƒªãƒ«ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚',
       dirs:['åŒ—','æ±','å—','è¥¿'], left:'å·¦æŠ˜ã—ã¦ãã ã•ã„', right:'å³æŠ˜ã—ã¦ãã ã•ã„', uturn:'Uã‚¿ãƒ¼ãƒ³ã—ã¦ãã ã•ã„' },
  en:{ start:'Starting guidance.', near:'You are approaching your destination.', arrived:'You have arrived at your destination. Ending guidance.',
       ahead:'In', meters:'meters', go:'go straight', then:', then', proceed:'proceed', now:'Now,', head:'', using:' re-routing.',
       dirs:['north','east','south','west'], left:'turn left', right:'turn right', uturn:'make a U-turn' },
  ko:{ start:'ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.', near:'ê³§ ëª©ì ì§€ì— ë„ì°©í•©ë‹ˆë‹¤.', arrived:'ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤. ì•ˆë‚´ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.',
       ahead:'ì•ìœ¼ë¡œ', meters:'ë¯¸í„°', go:'ì§ì§„í•˜ì„¸ìš”', then:', ì´í›„', proceed:'ì§„í–‰í•©ë‹ˆë‹¤', now:'ì§€ê¸ˆ', head:' ë°©í–¥ìœ¼ë¡œ', using:'ë¡œ ê²½ë¡œë¥¼ ë‹¤ì‹œ ì•ˆë‚´í•©ë‹ˆë‹¤.',
       dirs:['ë¶','ë™','ë‚¨','ì„œ'], left:'ì¢ŒíšŒì „í•˜ì„¸ìš”', right:'ìš°íšŒì „í•˜ì„¸ìš”', uturn:'ìœ í„´í•˜ì„¸ìš”' },
  fr:{ start:'DÃ©marrage du guidage.', near:'Vous approchez de votre destination.', arrived:'Vous Ãªtes arrivÃ© Ã  destination. Fin du guidage.',
       ahead:'Dans', meters:'mÃ¨tres', go:'continuez tout droit', then:', puis', proceed:'avancez', now:'Maintenant,', head:' vers', using:' pour un nouveau calcul dâ€™itinÃ©raire.',
       dirs:['nord','est','sud','ouest'], left:'tournez Ã  gauche', right:'tournez Ã  droite', uturn:'faites demi-tour' },
  es:{ start:'Iniciando la guÃ­a.', near:'EstÃ¡ acercÃ¡ndose a su destino.', arrived:'Ha llegado a su destino. Finalizando la guÃ­a.',
       ahead:'En', meters:'metros', go:'siga recto', then:', luego', proceed:'avance', now:'Ahora,', head:' hacia', using:' para recalcular la ruta.',
       dirs:['norte','este','sur','oeste'], left:'gire a la izquierda', right:'gire a la derecha', uturn:'dÃ© la vuelta' },
  zh:{ start:'å¼€å§‹å¯¼èˆªã€‚', near:'å³å°†åˆ°è¾¾ç›®çš„åœ°ã€‚', arrived:'æ‚¨å·²åˆ°è¾¾ç›®çš„åœ°ã€‚ç»“æŸå¯¼èˆªã€‚',
       ahead:'å‰æ–¹', meters:'ç±³', go:'ç›´è¡Œ', then:'ï¼Œç„¶å', proceed:'å‰è¿›', now:'ç°åœ¨ï¼Œ', head:'æ–¹å‘', using:'å¼€å§‹é‡æ–°è§„åˆ’è·¯çº¿ã€‚',
       dirs:['åŒ—','ä¸œ','å—','è¥¿'], left:'è¯·å·¦è½¬', right:'è¯·å³è½¬', uturn:'è¯·æ‰å¤´' }
};
const LANG_CODE={ ja:'ja-JP', en:'en-US', ko:'ko-KR', fr:'fr-FR', es:'es-ES', zh:'zh-CN' };

/* ===== TTSï¼ˆé‡è¤‡æŠ‘åˆ¶ï¼‰ ===== */
const tts=(function(){
  const q=[]; let speaking=false; let lastKey=null,lastAt=0;
  const minInterval=900, repeatWindow=7000;
  function pump(){ if(speaking) return; const it=q.shift(); if(!it) return;
    speaking=true; const u=new SpeechSynthesisUtterance(it.txt);
    u.lang=it.lang||'ja-JP'; u.rate=1.0; u.pitch=1.0;
    u.onend=()=>{ speaking=false; lastKey=(it.key||it.txt.slice(0,64))+'|'+(it.lang||''); lastAt=Date.now(); pump(); };
    try{ speechSynthesis.speak(u);}catch{ speaking=false; }
  }
  return {
    speak(txt,key,lang){
      const clean=String(txt||'').replace(/\s+/g,' ').replace(/ã€‚+/g,'ã€‚').trim();
      const now=Date.now();
      if(key && lastKey===key+'|'+lang && (now-lastAt)<repeatWindow) return;
      if((now-lastAt)<minInterval){ setTimeout(()=>{ q.push({txt:clean,key,lang}); pump(); }, Math.max(0,minInterval-(now-lastAt))); return; }
      q.push({txt:clean,key,lang}); pump();
    },
    stop(){ try{speechSynthesis.cancel();}catch{} speaking=false; q.length=0; lastKey=null; lastAt=0; }
  };
})();

/* ===== ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆè½ã¡ç€ãæŒ™å‹•ï¼‰ ===== */
const norm360=x=>{x%=360;if(x<0)x+=360;return x;}
const shortDiff=(a,b)=>{let d=norm360(b)-norm360(a);if(d>180)d-=360;if(d<-180)d+=360;return d;}
const compass={ angle:0,target:0,raf:null,maxDegPerSec:60,deadBand:3,lastTs:0,deviceMinInterval:120 };
function setCompassTarget(deg){ if(!Number.isFinite(deg)) return; const t=norm360(deg);
  if(Math.abs(shortDiff(compass.target,t))<compass.deadBand) return; compass.target=t;
  if(!compass.raf) compass.raf=requestAnimationFrame(needleStep);
}
function needleStep(ts){
  if(!needleStep.prev) needleStep.prev=ts;
  const dt=Math.max(1,ts-needleStep.prev)/1000; needleStep.prev=ts;
  const d=shortDiff(compass.angle,compass.target);
  if(Math.abs(d)<0.15){ compass.raf=null; needleStep.prev=0; return; }
  const maxStep=compass.maxDegPerSec*dt;
  const step=Math.sign(d)*Math.min(Math.abs(d)*0.10,maxStep);
  compass.angle=norm360(compass.angle+step);
  const g=document.getElementById('needle'); if(g) g.setAttribute('transform',`rotate(${compass.angle} 37 37)`);
  compass.raf=requestAnimationFrame(needleStep);
}
function initDeviceOrientation(){
  const getScreenAngle=()=> (screen.orientation&&typeof screen.orientation.angle==='number')?screen.orientation.angle:(typeof window.orientation==='number'?window.orientation:0)||0;
  const handler=(ev)=>{ const now=performance.now(); if(now-compass.lastTs<compass.deviceMinInterval) return;
    let heading=null;
    if(typeof ev.webkitCompassHeading==='number'){ if(ev.webkitCompassAccuracy>45) return; heading=ev.webkitCompassHeading; }
    else if(typeof ev.alpha==='number'){ heading=norm360(360-ev.alpha+getScreenAngle()); }
    compass.lastTs=now; if(heading!=null) setCompassTarget(heading);
  };
  if(window.DeviceOrientationEvent){
    if(DeviceOrientationEvent.requestPermission){
      DeviceOrientationEvent.requestPermission().then(s=>{ if(s==='granted'){ addEventListener('deviceorientation',handler,true); }});
    }else{
      addEventListener('deviceorientationabsolute',handler,true);
      addEventListener('deviceorientation',handler,true);
    }
  }
}

/* ===== åœ°å›³ ===== */
function ensureMapVisible(lat=35.362,lon=137.724,zoom=6){
  if(window.L&&L.map&&L.tileLayer){
    if(!mapReady){
      map=L.map('map',{zoomControl:false});
      const base=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20});
      base.addTo(map);
      const sk=document.getElementById('mapSkeleton');
      base.on('load',()=>{ if(sk) sk.style.display='none'; });
      base.on('tileerror',()=>{ if(sk) sk.style.display='none'; });
      setTimeout(()=>{ if(sk) sk.style.display='none'; }, 3000);
      L.control.zoom({position:'bottomleft'}).addTo(map);
      routeLayer=L.layerGroup().addTo(map);
      markerLayer=L.layerGroup().addTo(map);
      map.on('dragstart',()=>{ followMe=false; });
      window.addEventListener('resize',()=>{ if(mapReady&&map) setTimeout(()=>map.invalidateSize(),100); });
      mapReady=true;
    }
    map.setView([lat,lon],zoom);
    requestAnimationFrame(()=>map.invalidateSize());
    return;
  }
}

/* ===== æ±ç”¨ ===== */
const timeout=(p,ms)=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
function setBusy(btn,flag){ if(!btn) return; if(flag){ btn.setAttribute('disabled',''); setTimeout(()=>btn.removeAttribute('disabled'),1100); }}

/* ===== ç¾åœ¨åœ° ===== */
function updateCurrent(latlng){
  lastKnownPos={lat:latlng[0],lng:latlng[1]};
  if(!mapReady) ensureMapVisible(latlng[0],latlng[1],18);
  if(currentMarker){ currentMarker.setLatLng(latlng); }
  else if(window.L){ currentMarker=L.marker(latlng,{title:t('btn.cur')}).addTo(markerLayer||map); }
}
function setStart(lon,lat){ els.startLon.value=lon??''; els.startLat.value=lat??''; }
function setDest(lon,lat){
  els.destLon.value=lon??''; els.destLat.value=lat??'';
  if(Number.isFinite(lat)&&Number.isFinite(lon)){
    if(!mapReady) ensureMapVisible(lat,lon,13);
    if(window.L){
      if(!destMarker) destMarker=L.marker([lat,lon],{title:t('btn.dest')}).addTo(markerLayer||map);
      else destMarker.setLatLng([lat,lon]);
    }
  }
}
function initGeolocation(){
  if(!navigator.geolocation){ ensureMapVisible(); els.msg.textContent=t('msg.ready'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude,heading}=pos.coords;
    ensureMapVisible(latitude,longitude,18);
    setStart(longitude,latitude);
    updateCurrent([latitude,longitude]);
    if(Number.isFinite(heading)) setCompassTarget(heading);
    els.msg.textContent=t('msg.ready');
  }, err=>{
    ensureMapVisible();
    els.msg.textContent=t('msg.wait')+' ('+err.message+')';
  }, {enableHighAccuracy:true,maximumAge:1000,timeout:8000});

  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude,heading}=pos.coords;
    updateCurrent([latitude,longitude]);
    if(Number.isFinite(heading)) setCompassTarget(heading);
    if(navActive && followMe && mapReady && map) map.setView([latitude,longitude], map.getZoom());
    if(navActive) advanceGuidance({lat:latitude,lng:longitude});
    tickNowClock(); updateEtaDynamic();
  },()=>{}, {enableHighAccuracy:true,maximumAge:2500,timeout:10000});
}

/* ===== ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é–¢é€£ï¼ˆæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç¶­æŒï¼‰ ===== */
function actionFromOsrm(type,modifier){if(type==='arrive')return'arrive';if(type==='depart')return'straight';if(['left','sharp left','slight left'].includes(modifier))return'left';if(['right','sharp right','slight right'].includes(modifier))return'right';if(type==='uturn'||modifier==='uturn')return'uturn';return'straight';}
function osrmToOrsLike(osrm){const r=osrm.routes?.[0]; if(!r) return null; const coords=r.geometry?.coordinates||[]; const leg=r.legs?.[0]||{}; const steps=[]; let idx=0;(leg.steps||[]).forEach(st=>{const segLen=(st.geometry?.coordinates||[]).length; const name=st.name||''; const man=st.maneuver||{}; const action=actionFromOsrm(man.type,man.modifier); const toIdx=Math.min(coords.length-1, idx+Math.max(1,segLen)-1); steps.push({name,action,way_points:[idx,toIdx],distance:st.distance||0,duration:st.duration||0}); idx=toIdx;}); return {geometry:{type:'LineString',coordinates:coords},segments:[{distance:r.distance||0,duration:r.duration||0,steps}],summary:{distance:r.distance||0,duration:r.duration||0}};}
function decode6(str){let i=0,lat=0,lon=0,out=[];while(i<str.length){let b,shift=0,res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);const dlat=((res&1)?~(res>>1):(res>>1));shift=0;res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);const dlon=((res&1)?~(res>>1):(res>>1));lat+=dlat;lon+=dlon;out.push([lat/1e6,lon/1e6])}return out}
function valhallaToOrsLike(vh){const tr=vh.trip; if(!tr) return null; const leg=tr.legs?.[0]; if(!leg) return null; const coords=[];(leg.shape?.length?decode6(leg.shape):[]).forEach(p=>coords.push([p[1],p[0]])); const steps=[]; let idx=0;(leg.maneuvers||[]).forEach(mv=>{const name=(mv.street_names&&mv.street_names[0])||''; const action=(mv.type===17?'right':mv.type===18?'left':mv.type===16?'uturn':(mv.type===15||mv.type===4)?'arrive':'straight'); const addPts=Math.max(1,Math.round((mv.length||0)*20)); const toIdx=Math.min(coords.length-1, idx+addPts); steps.push({name,action,way_points:[idx,toIdx],distance:(mv.length||0)*1000,duration:mv.time||0}); idx=toIdx;}); const dist=(tr.summary?.length||0)*1000, dur=tr.summary?.time||0; return {geometry:{type:'LineString',coordinates:coords},segments:[{distance:dist,duration:dur,steps}],summary:{distance:dist,duration:dur}};}
function normalizeRoadName(name){ if(!name) return ''; const m=name.match(/^(å›½é“|çœŒé“|ç”ºé“)\s*(\d+)\s*å·(ç·š)?/); if(m) return `${m[1]}${m[2]}å·ç·š`; return name; }
function normalizeRoadNameEn(name){ if(!name) return ''; const m=name.match(/^(å›½é“|çœŒé“|ç”ºé“)\s*(\d+)\s*å·(ç·š)?/); if(m){ if(m[1]==='å›½é“') return `National Route ${m[2]}`; if(m[1]==='çœŒé“') return `Prefectural Route ${m[2]}`; if(m[1]==='ç”ºé“') return `Town Road ${m[2]}`; } return name; }
function cardinal4(deg, lang){ const a=norm360(deg); const d=I18N[lang]?.dirs||I18N.ja.dirs; if(a<45||a>=315) return d[0]; if(a<135) return d[1]; if(a<225) return d[2]; return d[3]; }
function initialBearing(){ const g=lastRoute?.route?.geometry?.coordinates; if(!g||g.length<2) return null; const a={lat:g[0][1],lng:g[0][0]},b={lat:g[1][1],lng:g[1][0]}; const toRad=t=>t*Math.PI/180, toDeg=t=>t*180/Math.PI; const Ï†1=toRad(a.lat),Ï†2=toRad(b.lat),Î»1=toRad(a.lng),Î»2=toRad(b.lng); const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2); const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1); return norm360(toDeg(Math.atan2(y,x))); }

/* ===== ETA/æ®‹è·é›¢ï¼ˆæ—¢å­˜ï¼‰ ===== */
function buildRouteMeta(latlngs, route){ const cum=[0]; let total=0; const dist=(a,b)=>L.latLng(a[0],a[1]).distanceTo(L.latLng(b[0],b[1])); for(let i=1;i<latlngs.length;i++){ total += dist(latlngs[i-1], latlngs[i]); cum[i]=total; } const s=route?.summary; const dur = s?.duration ?? (route?.segments||[]).reduce((a,b)=>a+(b.duration||0),0); const speed = (dur>0 && total>0) ? (total/dur) : 1.2; return {latlngs, cum, total, speed}; }
function extractDurDist(route){ const s=route?.summary; if(s) return {dur:s.duration,dist:s.distance}; const seg=route?.segments||[]; return {dur:seg.reduce((a,b)=>a+(b.duration||0),0),dist:seg.reduce((a,b)=>a+(b.distance||0),0)}; }
function km(m){ return (m/1000).toFixed(m>=10000?0:(m>=1000?1:2)); }
function fmtDurationMin(sec){ const m=Math.max(1,Math.ceil(sec/60)); const h=Math.floor(m/60), mm=m%60; return h>0?`${h}æ™‚é–“${mm}åˆ†`:`${mm}åˆ†`; }
function computeFinalSec(route){ const {dur,dist}=extractDurDist(route); const modelSec=dist>0 ? dist/1.2 : 0; let sec = Math.max(dur||0, modelSec||0); return Math.max(60, Math.ceil(sec/60)*60); }
function estimateRemainingSeconds(){ if(!lastRoute?.meta) return null; const meta=lastRoute.meta; let cur = lastKnownPos; if(!cur && currentMarker){ const ll=currentMarker.getLatLng(); cur={lat:ll.lat,lng:ll.lng}; } if(!cur) return null; let bestIdx=0, bestD=Infinity; for(let i=0;i<meta.latlngs.length;i++){ const p=meta.latlngs[i]; const d=L.latLng(cur.lat,cur.lng).distanceTo(L.latLng(p[0],p[1])); if(d<bestD){ bestD=d; bestIdx=i; } } const remainingDistance = Math.max(0, meta.total - meta.cum[bestIdx]); const speed = Math.max(0.6, Math.min(2.0, meta.speed||1.2)); let sec = remainingDistance / speed; sec = Math.max(60, Math.ceil(sec/60)*60); return {sec, remainingDistance}; }
function updateETAPill(route, overrideSec=null, overrideDist=null){
  const r = route || lastRoute?.route; if(!r){ return; }
  let sec = overrideSec!=null ? overrideSec : computeFinalSec(r);
  let dist = overrideDist!=null ? overrideDist : extractDurDist(r).dist;
  const now=new Date(); const eta=new Date(now.getTime()+sec*1000);
  els.etaDurationTop.textContent=fmtDurationMin(sec);
  els.etaDistanceTop.textContent=`${km(dist)} km`;
  els.etaClock.textContent=`${t('clock.eta')}${String(eta.getHours()).padStart(2,'0')}:${String(eta.getMinutes()).padStart(2,'0')}`;
}
function tickNowClock(){ const n=new Date(); els.nowClock.textContent=`${t('clock.now')}${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }
function updateEtaDynamic(){ const est = estimateRemainingSeconds(); if(est && lastRoute?.route){ updateETAPill(lastRoute.route, est.sec, est.remainingDistance); } else if(lastRoute?.route){ const sec=computeFinalSec(lastRoute.route); updateETAPill(lastRoute.route, sec, extractDurDist(lastRoute.route).dist); } }

/* ===== éŸ³å£°ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼ˆæ—¢å­˜ï¼‰ ===== */
function buildIntroSpeechLang(lang){
  const L=I18N[lang]||I18N.ja;
  const st=lastRoute?.route?.segments?.[0]?.steps?.[0];
  const br=initialBearing(); const dir=(br!=null)?cardinal4(br,lang):'';
  const langCode=LANG_CODE[lang]||'ja-JP';
  if(!st){
    const base = lang==='en' ? `${L.start} ${dir?`Head ${dir} and `:''}${L.go}.` :
                lang==='fr' ? `${L.start} ${dir?`Cap ${dir} et `:''}${L.go}.` :
                lang==='es' ? `${L.start} ${dir?`Vaya hacia ${dir} y `:''}${L.go}.` :
                lang==='ko' ? `${L.start} ${dir?`${dir}${L.head} `:''}${L.go}.` :
                lang==='zh' ? `${L.start} ${dir?`å‘${dir} ${L.go}ã€‚`:`${L.go}ã€‚`}` :
                              `${L.start}${dir?dir+'ã¸':''}${L.go}ã€‚`;
    return {text:base, lang:langCode};
  }
  const roadJa = normalizeRoadName(st.name||'') || (lang==='ja'?'ã“ã®é“':'');
  const roadEn = normalizeRoadNameEn(st.name||'') || 'this road';
  const road = lang==='ja'?roadJa:roadEn;
  const dRaw=Math.max(1,Math.round(st.distance||0));
  const BUCKETS=[200,150,120,80,50,30,10,5,3];
  function bucket(d){ if(d>200) return 200; for(const b of BUCKETS){ if(d>b) return b; if(d===b) return b; } return 3; }
  const b=bucket(dRaw);
  const dLabel=b>=120?(lang==='en'?`about ${b}`:`ç´„${b}`):`${b}`;
  const action=st.action||'straight';
  let s='';
  switch(lang){
    case 'en': s = `${L.start} Proceed ${dir?`${dir} `:''}${dLabel} ${L.meters} on ${road}${action==='straight'?'.':`, then ${I18N.en[action]}.`}`; break;
    case 'fr': s = `${L.start} ${L.proceed} ${dir?`vers ${dir} `:''}${dLabel} ${L.meters} sur ${road}${action==='straight'?'.':`, puis ${I18N.fr[action]}.`}`; break;
    case 'es': s = `${L.start} ${L.proceed} ${dir?`hacia ${dir} `:''}${dLabel} ${L.meters} por ${road}${action==='straight'?'.':`, luego ${I18N.es[action]}.`}`; break;
    case 'ko': s = `${L.start} ${dir?`${dir}${L.head} `:''}${dLabel}${L.meters} ${L.proceed} (${road})${action==='straight'?'.':`, ì´í›„ ${I18N.ko[action]}.`}`; break;
    case 'zh': s = `${L.start} ${dir?`å‘${dir} `:''}${dLabel}${L.meters} åœ¨${road}${L.proceed}${action==='straight'? 'ã€‚' : `ï¼Œç„¶å${I18N.zh[action]}ã€‚`}`; break;
    default:   s = `${L.start}${road}ã‚’${dir?dir+'ã«':''}${dLabel}${L.meters}${L.proceed}ã€‚${action==='straight'?'':I18N.ja[action]}`;
  }
  return {text:s, lang:langCode};
}
function bucketSpeakTextLang(lang, b, s){
  const L=I18N[lang]||I18N.ja;
  const dLabel = (lang==='en') ? (b>=120?`about ${b}`:`${b}`) : (b>=120?`ç´„${b}`:`${b}`);
  switch(lang){
    case 'en': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.en[s.action]||L.go}.`;
    case 'fr': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.fr[s.action]||L.go}.`;
    case 'es': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.es[s.action]||L.go}.`;
    case 'ko': return `${L.ahead} ${dLabel}${L.meters}, ${I18N.ko[s.action]||L.go}.`;
    case 'zh': return `${L.ahead}${dLabel}${L.meters}ï¼Œ${I18N.zh[s.action]||L.go}ã€‚`;
    default:   return `${L.ahead}${dLabel}${L.meters}ã‚’ã€${I18N.ja[s.action]||L.go}`;
  }
}
function nowSpeakTextLang(lang, s){ const L=I18N[lang]||I18N.ja; const map=I18N[lang]||I18N.ja;
  switch(lang){
    case 'en': return `${L.now} ${map[s.action]||L.go}.`;
    case 'fr': return `${L.now} ${map[s.action]||L.go}.`;
    case 'es': return `${L.now} ${map[s.action]||L.go}.`;
    case 'ko': return `${L.now} ${map[s.action]||L.go}.`;
    case 'zh': return `${L.now}${map[s.action]||L.go}ã€‚`;
    default:   return `${L.now}${map[s.action]||L.go}`;
  }
}

/* ===== ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹é€²è¡Œï¼ˆæ—¢å­˜ï¼‰ ===== */
function prepareGuidance(){
  navState={steps:[],idx:0,nearArrivalSaid:false,arrived:false,lastBucketIdx:null,startAt:Date.now()};
  const coords=lastRoute.route?.geometry?.coordinates||[], st=lastRoute.route?.segments?.[0]?.steps||[];
  const steps=[];
  st.forEach(s=>{
    const i2=Array.isArray(s.way_points)?s.way_points[1]:null;
    if(i2!=null&&coords[i2]){
      const [lon,lat]=coords[i2];
      steps.push({lat,lon,action:(s.action||'straight'),distance:s.distance||0});
    }
  });
  navState.steps=steps;
  if(steps[0]){ const BUCKETS=[200,150,120,80,50,30,10,5,3]; const b=(d)=>{ if(d>200) return 200; for(const x of BUCKETS){ if(d>x) return x; if(d===x) return x; } return 3; }; const bi=(v)=>BUCKETS.indexOf(v); navState.lastBucketIdx=bi(b(steps[0].distance)); }
  updateEtaDynamic();
}
function advanceGuidance(cur){
  if(!navState || navState.arrived) return;
  const L=I18N[voiceMode]||I18N.ja;
  if(destMarker){
    const d=L.latLng(cur.lat,cur.lng).distanceTo(destMarker.getLatLng());
    if(d<=5 && !navState.arrived){
      tts.speak(L.arrived,'arrived',LANG_CODE[voiceMode]);
      navState.arrived=true; navActive=false; return;
    }
    if(d<=8 && !navState.nearArrivalSaid){
      tts.speak(L.near,'near-arrival',LANG_CODE[voiceMode]);
      navState.nearArrivalS
