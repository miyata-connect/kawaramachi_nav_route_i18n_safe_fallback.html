<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{
  --bg:#0f1a25; --panel:#132235; --panel2:#0f1e30;
  --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:sans-serif;}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1 1 200px}
input,button,select{border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:var(--panel2);color:var(--text);padding:12px 14px;font-size:16px;outline:none}
button.primary{background:var(--primary);border:none;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
.hint{color:var(--muted);font-size:14px}
#msg.danger{color:var(--danger)}
.mapwrap{position:relative}
#map{height:64vh;border-radius:16px;overflow:hidden; background:#0a1320;}
.fab-col{position:absolute;right:12px;bottom:88px;z-index:460;display:flex;flex-direction:column;gap:10px}
.results{margin-top:10px}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
.modal .box{background:var(--panel);border-radius:16px;max-width:520px;width:92vw;padding:16px;}
/* ä»–ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯çœç•¥ */
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <input id="q" class="grow" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" autocomplete="off">
      <button id="mic" class="ghost">ğŸ¤ éŸ³å£°</button>
      <button id="search" class="primary">æ¤œç´¢</button>
    </div>
  </div>
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="grow"><div class="hint">é–‹å§‹åœ°ç‚¹</div><div class="row"><input id="startLon" class="grow" placeholder="çµŒåº¦"><input id="startLat" class="grow" placeholder="ç·¯åº¦"></div></div>
      <div class="grow"><div class="hint">ç›®çš„åœ°</div><div class="row"><input id="destLon" class="grow" placeholder="çµŒåº¦"><input id="destLat" class="grow" placeholder="ç·¯åº¦"></div></div>
    </div>
    <div class="row" style="margin-top:10px"><button id="modeWalk" class="primary">å¾’æ­©</button><button id="modeWheel" class="ghost">è»Šæ¤…å­</button><div class="grow"></div><button id="getRoute" class="primary">ãƒ«ãƒ¼ãƒˆå–å¾—</button><button id="clear" class="ghost">ã‚¯ãƒªã‚¢</button></div>
    <div id="msg" class="hint" style="margin-top:6px;">è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™...</div>
  </div>
  <div class="card mapwrap" style="margin-top:12px">
    <div id="map"></div>
    <div class="fab-col"><button id="navStart" class="ok">æ¡ˆå†…é–‹å§‹</button></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ===== æœ€çµ‚è¨ºæ–­ãƒ—ãƒ­ã‚°ãƒ©ãƒ  =====
document.addEventListener('DOMContentLoaded', () => {
    'use strict';
    const msgEl = document.getElementById('msg');
    const mapEl = document.getElementById('map');
    let step = 0;

    function log(message, isError = false) {
        step++;
        const status = isError ? 'âŒ å¤±æ•—' : 'âœ… æˆåŠŸ';
        msgEl.innerHTML = `ã‚¹ãƒ†ãƒƒãƒ— ${step}/8: ${message} ... ${status}`;
        msgEl.style.color = isError ? 'var(--danger)' : 'var(--ok)';
        if (isError) {
            console.error(message);
            throw new Error(`è¨ºæ–­åœæ­¢: ã‚¹ãƒ†ãƒƒãƒ— ${step}ã§å¤±æ•—ã—ã¾ã—ãŸã€‚`);
        }
    }

    function finalLog(message) {
        msgEl.innerHTML = `ğŸ‰ ${message}`;
        msgEl.style.color = 'var(--ok)';
    }

    // ã‚ãšã‹ã«é…å»¶ã•ã›ã¦ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤
    setTimeout(() => {
        try {
            log('DOMè¦ç´ ã®å–å¾—');

            if (!mapEl || !msgEl) {
                log('å¿…é ˆDOMè¦ç´ ï¼ˆmap or msgï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                return;
            }
            log('DOMè¦ç´ ã®å–å¾—');

            if (typeof L === 'undefined') {
                log('Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒª(L)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                return;
            }
            log('Leafletãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ãƒã‚§ãƒƒã‚¯');
            
            if (mapEl.clientHeight === 0) {
                log('åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®é«˜ã•ãŒ0ã§ã™ã€‚CSSã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', true);
                return;
            }
            log(`åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºç¢ºèª (é«˜ã•: ${mapEl.clientHeight}px)`);

            const map = L.map('map', { zoomControl: false });
            log('Leafletåœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ (L.map)');

            map.setView([34.342, 134.046], 16);
            log('åœ°å›³ã®ä¸­å¿ƒã¨ã‚ºãƒ¼ãƒ ã‚’è¨­å®š (setView)');

            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 20 });
            log('ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä½œæˆ (L.tileLayer)');
            
            tileLayer.addTo(map);
            log('ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’åœ°å›³ã«è¿½åŠ  (addTo)');
            
            finalLog('è¨ºæ–­å®Œäº†: åœ°å›³ã®åˆæœŸåŒ–ã«æˆåŠŸã—ã¾ã—ãŸã€‚ã‚‚ã—åœ°å›³ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚¿ã‚¤ãƒ«ã‚µãƒ¼ãƒãƒ¼ã®å•é¡Œã§ã™ã€‚');

        } catch (e) {
            log(`äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${e.message}`, true);
        }
    }, 200); // 200ãƒŸãƒªç§’å¾…æ©Ÿ
});
</script>
</body>
</html>
