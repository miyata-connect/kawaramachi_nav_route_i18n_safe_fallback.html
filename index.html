(() => {
  if (window.__diagOn) { console.warn('DIAG already ON'); return; }
  window.__diagOn = true;
  const origFetch = window.fetch;
  window.fetch = async (...args) => {
    const url = String(args[0] || '');
    const res = await origFetch(...args);
    try {
      const clone = res.clone();
      const text = await clone.text();
      let json=null; try{ json = JSON.parse(text); }catch(_){}
      // ORS / ルート応答の形を判定
      if (/openrouteservice|\/proxy\b/i.test(url)) {
        let g=null;
        if (json && json.routes && json.routes[0]) g = json.routes[0].geometry;
        console.log('[DIAG/ORS]', {
          status: res.status, url,
          geometryType: (g && typeof g),
          geojsonLen: (g && g.coordinates && g.coordinates.length) || null,
          polylineSample: (typeof g==='string') ? String(g).slice(0,80) : null
        });
      }
      // ジオコーダ（検索）応答の形をざっくり判定
      if (/geocode|search|nominatim|photon|places/i.test(url)) {
        const items = (json?.features || json?.results || json) || [];
        const list = Array.isArray(items) ? items : (items.features || items.results || []);
        const rows = (list || []).slice(0,10).map((it,i)=>({
          i, name: it?.properties?.name || it?.name || it?.display_name,
          dist: it?.properties?.distance || it?.distance || null
        }));
        console.log('[DIAG/SEARCH]', {count: rows.length, rows});
      }
    } catch(e) { console.warn('[DIAG ERR]', e); }
    return res;
  };

  // 音声ログ
  if (window.speechSynthesis?.speak) {
    const origSpeak = window.speechSynthesis.speak.bind(window.speechSynthesis);
    window.speechSynthesis.speak = (utt)=>{ console.log('[DIAG/SPEAK]', utt?.text); origSpeak(utt); };
  }

  // 方位イベントの生ログ（振れ幅を見る）
  let lastAlpha=null, lastLog=0;
  const logOrientation = (a) => {
    const now=Date.now();
    const d = (lastAlpha==null)? null : ((((a-lastAlpha+540)%360)-180).toFixed(1));
    if (now-lastLog>800) { console.log('[DIAG/COMPASS]', {alpha: a?.toFixed?.(1), delta: d}); lastLog=now; }
    lastAlpha=a;
  };
  const handler = (e)=> logOrientation(e.absolute===true ? e.alpha : e.webkitCompassHeading ?? e.alpha);
  window.addEventListener('deviceorientationabsolute', handler, {passive:true});
  window.addEventListener('deviceorientation', handler, {passive:true});
  console.log('=== DIAG MODE ON ===');
})();
