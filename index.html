<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalkNav v5</title>
  <style>
:root {
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted: #a7b8ce;
  --primary: #5fb1ff;
  --ok: #25d07a;
  --danger: #ff6565;
  --accent: #64d2ff;
}
html,body {
  height:100%;
  margin:0;
  background:#0a1321;
  color:var(--text);
  font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif;
}
*{box-sizing:border-box}
.app {
  position:relative;
  height:100dvh;
  overflow:hidden;
}
#map {
  position:absolute;
  inset:0;
  display:block;
}
.control-panel {
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:18px;
  backdrop-filter:blur(10px);
  padding:12px;
  box-shadow:0 8px 24px rgba(0,0,0,.4);
}
.control-panel h2 {
  text-align:center;
  font-size:1.1em;
  margin:0 0 8px 0;
}
.btn-row {
  display:flex;
  gap:8px;
  margin:8px 0;
}
.btn {
  flex:1;
  border:none;
  border-radius:10px;
  padding:10px;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}
.btn.primary{background:var(--primary)}
.btn.ok{background:var(--ok)}
.btn.danger{background:var(--danger)}
.btn.glass{background:var(--glass)}
.search-input {
  width:100%;
  border:none;
  border-radius:8px;
  padding:10px;
  margin-bottom:6px;
  background:rgba(255,255,255,.1);
  color:var(--text);
}
label {
  font-size:.9em;
  color:var(--muted);
}
.option-row {
  display:flex;
  align-items:center;
  gap:8px;
  margin:4px 0;
}
.toast {
  position:fixed;
  left:50%;
  top:10%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.8);
  color:#fff;
  padding:10px 16px;
  border-radius:10px;
  font-size:.9em;
  z-index:9999;
  opacity:0;
  transition:opacity .4s;
}
.toast.show{opacity:1}
  </style>
</head>
<body>
<div class="app">
  <div id="map"></div>
  <div class="control-panel" id="panel">
    <h2>近くを検索（10km / 5件）</h2>
    <div class="btn-row">
      <button class="btn glass" id="r10">10km</button>
      <button class="btn glass" id="r20">20km</button>
    </div>
    <input id="searchInput" class="search-input" placeholder="店舗名・電話番号・住所・座標など">
    <div class="btn-row">
      <button class="btn ok" id="voiceBtn">音声検索</button>
      <button class="btn danger" id="resetBtn">リセット</button>
      <button class="btn primary" id="searchBtn">入力検索</button>
    </div>
    <div class="option-row">
      <input type="checkbox" id="optPlace">
      <label for="optPlace">任意の場所を検索</label>
      <input type="checkbox" id="optOpen">
      <label for="optOpen">現在営業中</label>
      <input type="checkbox" id="optReview">
      <label for="optReview">レビュー順</label>
    </div>
    <div class="btn-row">
      <button class="btn glass" id="savePoint">現在地点登録</button>
      <button class="btn glass" id="editPoint">登録地点修正</button>
    </div>
    <div id="coords" style="text-align:center;margin-top:4px;font-size:.85em;">現在地：- , -</div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const toast = (msg,dur=2000)=>{
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),dur);
};

let map, marker, circle, watchId, recognition;
const proxy="https://ors-proxy.miyata-connect-jp.workers.dev";
let currentPos=null;

function initMap(){
  map=new google.maps.Map(document.getElementById("map"),{
    center:{lat:35.681236,lng:139.767125},
    zoom:16,
    disableDefaultUI:true,
    mapId:"4504f8b37365c3d0"
  });
  getCurrentLocation();
}

function createRippleMarker(position){
  if(marker) marker.setMap(null);
  const el=document.createElement("div");
  el.style.width="16px";
  el.style.height="16px";
  el.style.background="#5fb1ff";
  el.style.borderRadius="50%";
  el.style.boxShadow="0 0 0 10px rgba(95,177,255,.3)";
  el.style.transition="all .3s";
  marker=new google.maps.marker.AdvancedMarkerElement({
    map,
    position,
    content:el
  });
}

function getCurrentLocation(){
  if(navigator.geolocation){
    watchId=navigator.geolocation.watchPosition(pos=>{
      currentPos={lat:pos.coords.latitude,lng:pos.coords.longitude};
      map.setCenter(currentPos);
      map.setZoom(17);
      createRippleMarker(currentPos);
      document.getElementById("coords").textContent=`現在地：緯度:${currentPos.lat.toFixed(6)} / 経度:${currentPos.lng.toFixed(6)}`;
      toast("現在地を取得しました。");
    },err=>{
      toast("位置情報を取得できません");
    });
  } else toast("Geolocation未対応");
}

function triggerSearch(){
  const q=document.getElementById("searchInput").value.trim();
  if(!q){toast("検索ワードを入力してください。");return;}
  fetch(`${proxy}/places`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({query:q,location:currentPos})
  }).then(r=>{
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }).then(data=>{
    toast(`${data.results?.length||0}件の結果`);
  }).catch(e=>{
    toast(`検索エラー: ${e.message}`);
  });
}

function startVoice(){
  if(!("webkitSpeechRecognition" in window)){toast("音声認識非対応");return;}
  recognition=new webkitSpeechRecognition();
  recognition.lang="ja-JP";
  recognition.start();
  toast("音声入力を開始します");
  recognition.onresult=(e)=>{
    const transcript=e.results[0][0].transcript;
    document.getElementById("searchInput").value=transcript;
    toast("音声を認識しました");
    triggerSearch();
  };
  recognition.onerror=()=>toast("音声認識に失敗");
}

document.getElementById("voiceBtn").onclick=startVoice;
document.getElementById("searchBtn").onclick=triggerSearch;
document.getElementById("resetBtn").onclick=()=>{
  document.getElementById("searchInput").value="";
  toast("リセットしました");
};
document.getElementById("savePoint").onclick=()=>{
  if(!currentPos){toast("位置情報未取得");return;}
  localStorage.setItem("savedPoint",JSON.stringify(currentPos));
  toast("現在地を登録しました");
};
document.getElementById("editPoint").onclick=()=>{
  const saved=JSON.parse(localStorage.getItem("savedPoint")||"null");
  if(!saved){toast("登録地点がありません");return;}
  const newData=prompt("登録地点の緯度,経度を修正（削除は空欄でOK）",`${saved.lat},${saved.lng}`);
  if(!newData){localStorage.removeItem("savedPoint");toast("登録地点を削除しました");return;}
  const [lat,lng]=newData.split(",").map(v=>parseFloat(v));
  if(isNaN(lat)||isNaN(lng)){toast("入力値が不正です");return;}
  localStorage.setItem("savedPoint",JSON.stringify({lat,lng}));
  toast("登録地点を更新しました");
};
</script>

<script async
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=maps,marker,places&v=weekly&callback=initMap">
</script>
</body>
</html>