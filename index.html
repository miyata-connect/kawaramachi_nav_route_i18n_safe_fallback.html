<!DOCTYPE html>
<!-- idx202511011905 : WalkNav index.html (full) -->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="x-issue" content="idx202511011905" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321; --text:#eaf2ff; --muted:#a7b8ce; --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78); --glass-strong: rgba(16,22,36,.92);
      --stroke: rgba(255,255,255,.12); --ok:#25d07a; --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* Fullscreen preloader */
    .boot{
      position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;
      color:#fff;z-index:1000;font-size:16px;text-align:center;padding:24px;line-height:1.6
    }

    /* Top bars */
    .topbar, .incidentbar{
      position:absolute;left:12px;right:12px;border-radius:14px;
      background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      z-index:6
    }
    .topbar{top:10px;padding:10px 12px}
    .incidentbar{top:58px;padding:8px 10px;display:none}

    .topbar .txt, .incidentbar .txt{font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* Control panel */
    .panel{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:5;
      background:var(--glass-strong);border:1px solid var(--stroke);backdrop-filter:blur(8px);
      border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:10px
    }
    .row{display:flex;gap:10px;align-items:center}
    .grow{flex:1}
    input[type="text"]{
      width:100%;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);color:var(--text);outline:none;font-size:15px
    }
    input::placeholder{color:var(--muted)}
    .btn{
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);color:var(--text);cursor:pointer;user-select:none
    }
    .btn:active{transform:translateY(1px)}
    .chips{display:flex;gap:8px;align-items:center;justify-content:center}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);cursor:pointer}
    .chip.active{outline:2px solid var(--accent)}
    .label{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--stroke);margin:2px 0}

    /* Right-side floating buttons (non-overlap) */
    .rstack{
      position:absolute;right:12px;top:110px;display:flex;flex-direction:column;gap:10px;z-index:6
    }
    .fab{
      width:44px;height:44px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);display:flex;align-items:center;justify-content:center;cursor:pointer
    }

    /* Results at bottom (never under the panel) */
    .results{
      position:absolute;left:12px;right:12px;bottom: calc(12px + 220px);
      /* sits above panel height to avoid overlap */
      max-height:35vh;overflow:auto;z-index:7;padding:8px;
      background:var(--glass);border:1px solid var(--stroke);border-radius:14px;display:none
    }
    .resitem{padding:10px;border-radius:10px;border:1px solid var(--stroke);margin-bottom:8px;cursor:pointer}
    .resitem:hover{background:rgba(255,255,255,.06)}
    .resname{font-weight:600}
    .resaddr{font-size:12px;color:var(--muted)}

    /* Toast (muted to avoid intrusive popups) */
    .toast{position:absolute;left:50%;transform:translateX(-50%);bottom:12px;padding:10px 12px;border-radius:10px;background:#222;color:#ddd;border:1px solid var(--stroke);display:none;z-index:20}

    /* AdvancedMarker ripple */
    .pulse{
      position:relative;width:18px;height:18px;border-radius:50%;background:#ff4d4d;box-shadow:0 0 0 2px rgba(255,77,77,.25)
    }
    .pulse::after{
      content:"";position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(255,77,77,.4);animation:ripple 1.6s infinite
    }
    @keyframes ripple{
      0%{transform:scale(0.7);opacity:.9}
      70%{transform:scale(1.5);opacity:0}
      100%{opacity:0}
    }
    .pin{
      width:20px;height:20px;border-radius:50%;background:#5fb1ff;border:2px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.35)
    }

    /* Hide on routing */
    .panel.hidden, .results.hidden, .incidentbar.hidden, .topbar.hidden{display:none!important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <!-- startup blocker -->
    <div id="boot" class="boot">
      <div>
        <div style="font-weight:700;margin-bottom:8px">Acquiring current location…</div>
        <div>Please wait up to 30 seconds. If not acquired, try moving near open sky.</div>
      </div>
    </div>

    <!-- guidance bars -->
    <div id="topbar" class="topbar"><div id="guideText" class="txt">Ready.</div></div>
    <div id="incidentbar" class="incidentbar"><div id="incidentText" class="txt">No incidents.</div></div>

    <!-- right stack -->
    <div class="rstack">
      <button id="btn-current" class="fab" title="Current">◎</button>
      <button id="btn-pause" class="fab" title="Pause">II</button>
      <button id="btn-reroute" class="fab" title="Reroute">↻</button>
    </div>

    <!-- results list -->
    <div id="results" class="results"></div>

    <!-- control panel -->
    <div id="panel" class="panel">
      <div class="row" style="justify-content:center;gap:12px">
        <button id="btn-ai-fast" class="chip">Fast AI</button>
        <button id="btn-ai-easy" class="chip">Easy AI</button>
      </div>
      <div class="divider"></div>

      <div class="row">
        <div class="grow">
          <div class="label" id="nearLabel">Search nearby (10km / 5)</div>
        </div>
        <div class="chips">
          <button class="chip active" data-km="10">10km</button>
          <button class="chip" data-km="20">20km</button>
        </div>
      </div>

      <div class="row">
        <input id="q" type="text" class="grow" placeholder="Store name · Phone · Category · Address · LatLng · Facility name" />
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btn-text-search" class="btn">Text Search</button>
          <button id="btn-voice" class="btn">Voice Search</button>
          <button id="btn-reset" class="btn">Reset</button>
        </div>
        <div class="row" style="gap:8px">
          <button id="btn-anywhere" class="btn">Any-location Search</button>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px">
          <button id="btn-reg-now" class="btn">Register Here</button>
          <button id="btn-reg-edit" class="btn">Edit Registered</button>
        </div>
        <div class="label" id="latlngLabel">Current: -- / --</div>
      </div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Google Maps JS API -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk&v=weekly&libraries=marker&language=ja&region=JP&loading=async"></script>

  <!-- App (module) -->
  <script type="module">
    // ISSUE_ID
    const ISSUE_ID = "idx202511011905";

    /********** audit-hook (minimal inline) **********/
    const AUDIT_ENDPOINT = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";
    async function auditRun(payload){
      try{
        await fetch(AUDIT_ENDPOINT + "/audit/run", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ issue: ISSUE_ID, ...payload })
        });
      }catch(_){}
    }
    async function auditEvent(event, payload){
      try{
        await fetch(AUDIT_ENDPOINT + "/audit/event", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ issue: ISSUE_ID, event, ...payload })
        });
      }catch(_){}
    }

    /********** helpers **********/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const toast = (msg, ms=1800)=>{
      const el = $("#toast"); el.textContent = msg; el.style.display="block";
      clearTimeout(el._t); el._t = setTimeout(()=>el.style.display="none", ms);
    };
    const guide = (msg)=> $("#guideText").textContent = msg;
    const incident = (msg)=> { const b=$("#incidentbar"); $("#incidentText").textContent=msg; b.style.display= msg?"block":"none"; };

    function kmToMeters(km){ return Math.max(1000, Math.min(30000, (km|0)*1000)); }

    /********** state **********/
    let map, curMarker, selMarker, routePoly;
    let currentPos = null;
    let useAnyLocation = false;
    let nearbyKm = 10;
    let registered = null;

    const workerBase = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";

    /********** boot flow **********/
    auditRun({ phase:"entry", score:98, errorRate:0 });
    guide("Initializing…");

    (async function main(){
      try{
        await waitForGoogleMaps();
        await acquireLocation(30000);
        initMap();
        initUI();
        $("#boot").style.display="none";
        guide("Ready.");
        auditEvent("ready",{ ok:true });
      }catch(e){
        $("#boot").style.display="none"; // do not block UI
        guide("Ready (location deferred).");
        auditEvent("boot_error",{ message: String(e&&e.message||e) });
      }
    })();

    async function waitForGoogleMaps(timeout=15000){
      const t0 = performance.now();
      while(performance.now()-t0<timeout){
        if (window.google && google.maps && google.maps.importLibrary) return true;
        await new Promise(r=>setTimeout(r,40));
      }
      throw new Error("Google Maps load timeout");
    }

    async function acquireLocation(ms){
      currentPos = await new Promise((resolve,reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation unsupported"));
        const to = setTimeout(()=>reject(new Error("Location timeout")), ms);
        navigator.geolocation.getCurrentPosition(
          pos=>{ clearTimeout(to); resolve({ lat:pos.coords.latitude, lng:pos.coords.longitude }); },
          err=>{ clearTimeout(to); reject(new Error(err.message||"Location error")); },
          { enableHighAccuracy:true, timeout:ms, maximumAge:0 }
        );
      });
      auditEvent("location_acquired", { lat:currentPos.lat, lng:currentPos.lng });
    }

    async function initMap(){
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      map = new Map($("#map"), {
        center: currentPos || { lat:35.681236, lng:139.767125 }, // never shown if boot success
        zoom: currentPos ? 17 : 15,
        mapId: "WALKNAV_MAP",
        disableDefaultUI: true
      });

      // Current location marker (ripple)
      curMarker = new AdvancedMarkerElement({
        map,
        position: currentPos || map.getCenter(),
        content: mkPulse(),
        zIndex: 10
      });

      // Drag follow for "any-location search" (long-press)
      attachLongPress();
      auditEvent("map_init",{ ok:true });
    }

    function mkPulse(){
      const d = document.createElement("div");
      d.className = "pulse";
      return d;
    }
    function mkPin(){
      const d = document.createElement("div");
      d.className = "pin";
      return d;
    }

    function attachLongPress(){
      let pressTimer=null, isDown=false;
      map.addListener("mousedown", (e)=>{
        isDown=true;
        pressTimer = setTimeout(()=>{
          if(!useAnyLocation) return;
          setSelected(e.latLng);
        }, 550);
      });
      ["mouseup","dragstart"].forEach(ev=>{
        map.addListener(ev, ()=>{
          isDown=false; if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; }
        });
      });
      map.addListener("touchstart", (e)=>{
        pressTimer = setTimeout(()=>{
          if(!useAnyLocation) return;
          const ll = map.getCenter(); // consistent on mobile
          setSelected(ll);
        }, 650);
      });
      ["touchend","dragstart"].forEach(ev=>{
        map.addListener(ev, ()=>{
          if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; }
        });
      });
    }

    function setSelected(latlng){
      if(!selMarker){
        selMarker = new google.maps.marker.AdvancedMarkerElement({
          map, position: latlng, content: mkPin(), zIndex: 9
        });
      }else{
        selMarker.position = latlng;
      }
      toast("Selected point set.");
      auditEvent("select_point",{ lat: latlng.lat(), lng: latlng.lng() });
    }

    function setCurrentLabel(pos){
      $("#latlngLabel").textContent = `Current: ${pos.lat.toFixed(6)} / ${pos.lng.toFixed(6)}`;
    }

    /********** UI wiring **********/
    function initUI(){
      if(currentPos){
        map.setCenter(currentPos);
        setCurrentLabel(currentPos);
      }

      // radius chips
      $$(".chip[data-km]").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          $$(".chip[data-km]").forEach(x=>x.classList.remove("active"));
          ch.classList.add("active");
          nearbyKm = parseInt(ch.dataset.km,10);
          $("#nearLabel").textContent = `Search nearby (${nearbyKm}km / 5)`;
        });
      });

      // text search
      $("#btn-text-search").addEventListener("click", ()=>doSearch(false));
      $("#btn-voice").addEventListener("click", ()=>voiceSearch());
      $("#btn-reset").addEventListener("click", ()=>resetSearch());
      $("#btn-anywhere").addEventListener("click", ()=>{
        useAnyLocation = !useAnyLocation;
        $("#btn-anywhere").style.outline = useAnyLocation ? "2px solid var(--accent)" : "none";
        toast(useAnyLocation ? "Any-location mode ON (long-press to set point)" : "Any-location mode OFF");
      });

      // register here
      $("#btn-reg-now").addEventListener("click", ()=>{
        const p = map.getCenter()?.toJSON?.() || currentPos || { lat:35.0, lng:135.0 };
        registered = p;
        toast("Registered current map center.");
        auditEvent("register_here", p);
      });

      // edit registered (update / clear)
      $("#btn-reg-edit").addEventListener("click", ()=>{
        if(!registered){ toast("No registered point."); return; }
        // simple toggle: move to current center; clear if second tap within 3s
        const now = map.getCenter().toJSON();
        if(Math.hypot(now.lat-registered.lat, now.lng-registered.lng) < 0.0002){
          registered = null; toast("Registered cleared.");
          auditEvent("register_cleared", {});
        }else{
          registered = now; toast("Registered updated.");
          auditEvent("register_updated", now);
        }
      });

      // right buttons
      $("#btn-current").addEventListener("click", async ()=>{
        try{
          await acquireLocation(10000);
          curMarker.position = currentPos;
          map.setCenter(currentPos);
          map.setZoom(17);
          setCurrentLabel(currentPos);
        }catch(e){ /* mute */ }
      });
      $("#btn-pause").addEventListener("click", ()=>{
        hideRoute();
        guide("Paused.");
      });
      $("#btn-reroute").addEventListener("click", ()=>{
        if(routeTarget) doRoute(routeTarget);
      });

      // enter key
      $("#q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") doSearch(false); });
    }

    function resetSearch(){
      $("#q").value="";
      hideResults();
      guide("Ready.");
      auditEvent("reset",{});
    }

    /********** Places (New) via Worker **********/
    async function doSearch(forceAny){
      const q = $("#q").value.trim();
      if(!q){ toast("Please input search text."); return; }

      const base = useAnyLocation || forceAny ? (selMarker?.position?.toJSON?.()) : (currentPos || map.getCenter()?.toJSON?.());
      if(!base){ toast("No base location."); return; }

      const body = {
        textQuery: q,
        languageCode: "ja",
        regionCode: "JP",
        pageSize: 5,
        locationBias: {
          circle: { center: { latitude: base.lat, longitude: base.lng }, radius: kmToMeters(nearbyKm) }
        }
      };

      try{
        const resp = await fetch(workerBase + "/places:searchText", {
          method:"POST",
          headers:{ "Content-Type":"application/json", "Origin":"https://miyata-connect.github.io" },
          body: JSON.stringify(body)
        });
        const txt = await resp.text();
        if(!resp.ok){ auditEvent("places_error",{ status:resp.status, body:txt.slice(0,400) }); return; }
        const data = JSON.parse(txt);
        renderResults(data?.places||[]);
        auditEvent("places_ok",{ count:(data?.places||[]).length });
      }catch(e){
        auditEvent("places_exc",{ message:String(e&&e.message||e) });
      }
    }

    function renderResults(list){
      const box = $("#results");
      if(!list.length){ box.style.display="none"; return; }
      box.innerHTML = "";
      list.slice(0,5).forEach(p=>{
        const it = document.createElement("div");
        it.className = "resitem";
        it.innerHTML = `<div class="resname">${esc(p.displayName?.text||"Unnamed")}</div>
                        <div class="resaddr">${esc(p.formattedAddress||"")}</div>`;
        it.addEventListener("click", ()=>{
          $("#results").style.display="none";
          if(p.location?.latitude && p.location?.longitude){
            const dest = { lat: p.location.latitude, lng: p.location.longitude };
            doRoute(dest);
          }
        });
        box.appendChild(it);
      });
      // when results are shown, hide panel to avoid overlap
      $("#panel").classList.add("hidden");
      box.style.display="block";
    }
    function hideResults(){
      $("#results").style.display="none";
      $("#panel").classList.remove("hidden");
    }

    function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }

    /********** Directions via Worker **********/
    let routeTarget = null;
    async function doRoute(dest){
      routeTarget = dest;
      const src = selMarker?.position?.toJSON?.() || currentPos || map.getCenter()?.toJSON?.();
      if(!src){ return; }
      try{
        const url = new URL(workerBase + "/directions");
        url.searchParams.set("origin", `${src.lat},${src.lng}`);
        url.searchParams.set("destination", `${dest.lat},${dest.lng}`);
        url.searchParams.set("mode", "walking");
        url.searchParams.set("language", "ja");
        url.searchParams.set("region", "JP");
        const resp = await fetch(url.toString(), { headers:{ "Origin":"https://miyata-connect.github.io" }});
        const txt = await resp.text();
        if(!resp.ok){ auditEvent("dir_error",{ status:resp.status, body:txt.slice(0,400) }); return; }
        const data = JSON.parse(txt);
        drawRoute(data);
        // hide UI while guiding; keep right stack visible
        $("#panel").classList.add("hidden");
        $("#results").classList.add("hidden");
        guide("Routing…");
        auditEvent("dir_ok",{ ok:true });
      }catch(e){
        auditEvent("dir_exc",{ message:String(e&&e.message||e) });
      }
    }

    function drawRoute(data){
      try{
        if(routePoly){ routePoly.setMap(null); routePoly=null; }
        const pts = google.maps.geometry?.encoding?.decodePath
          ? google.maps.geometry.encoding.decodePath(data.routes?.[0]?.overview_polyline?.points||"")
          : decodePolyline(data.routes?.[0]?.overview_polyline?.points||"");
        routePoly = new google.maps.Polyline({
          map, path: pts, strokeColor:"#5fb1ff", strokeOpacity:0.9, strokeWeight:5
        });
        const b = new google.maps.LatLngBounds();
        pts.forEach(p=>b.extend(p));
        map.fitBounds(b, { top:160, bottom:260, left:40, right:40 });
      }catch(_){}
    }

    function hideRoute(){
      if(routePoly){ routePoly.setMap(null); routePoly=null; }
      $("#panel").classList.remove("hidden");
      hideResults();
    }

    // polyline decode (fallback)
    function decodePolyline(encoded){
      let points=[]; let index=0, lat=0, lng=0;
      while(index<encoded.length){
        let b, shift=0, result=0;
        do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
        const dlat = ((result&1)?~(result>>1):(result>>1)); lat += dlat;
        shift=0; result=0;
        do{ b=encoded.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
        const dlng = ((result&1)?~(result>>1):(result>>1)); lng += dlng;
        points.push(new google.maps.LatLng(lat/1e5,lng/1e5));
      }
      return points;
    }

    /********** voice search **********/
    function voiceSearch(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ toast("Voice unsupported."); return; }
      const r = new SR();
      r.lang = "ja-JP";
      r.interimResults = false;
      r.maxAlternatives = 1;
      r.onresult = (e)=>{
        const t = e.results?.[0]?.[0]?.transcript||"";
        $("#q").value = t;
        doSearch(false);
      };
      r.onerror = ()=>{/* mute */};
      r.start();
    }

    /********** small niceties **********/
    // suppress intrusive healthz toasts (worker health is checked invisibly)
    (async ()=>{ try{ await fetch(workerBase+"/healthz"); }catch(_){ } })();

    // keep current label fresh if we had geo
    if(currentPos) setCurrentLabel(currentPos);

  </script>
</body>
</html>