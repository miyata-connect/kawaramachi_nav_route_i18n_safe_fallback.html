<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
      --btnfg:#111;
      --btnbg:#eaf2ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .panel{
      position:absolute;left:12px;right:12px;top:12px;z-index:10;
      background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      border-radius:14px;padding:14px;max-width:820px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .panel h3{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 280px}
    .input{
      width:100%;height:44px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;font-size:16px;
    }
    select.input{padding-right:32px}
    .btn{
      height:44px;min-width:92px;border-radius:10px;border:1px solid var(--stroke);
      background:var(--btnbg);color:var(--btnfg);padding:0 14px;font-weight:600;cursor:pointer;
    }
    .btn.secondary{background:rgba(255,255,255,.18);color:#111}
    .check{display:flex;align-items:center;gap:6px;color:var(--text);opacity:.9}
    .check input{width:18px;height:18px}

    /* 緯度経度表示：中央寄せ */
    #coordBar{
      width:100%;
      text-align:center;
      color:var(--muted);
      margin-top:6px;
      font-variant-numeric:tabular-nums;
    }

    /* 結果リスト：下部固定 */
    .results{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:9;
      max-width:820px;margin:0 auto;
      max-height:45vh;overflow-y:auto;
      border-radius:14px;background:rgba(10,19,33,.9);
      border:1px solid var(--stroke);backdrop-filter:blur(8px);
      box-shadow:0 -4px 20px rgba(0,0,0,.4);
    }
    .card{overflow:hidden}
    .item{display:flex;gap:12px;align-items:flex-start;padding:14px 16px;border-top:1px solid var(--stroke);cursor:pointer}
    .item:first-child{border-top:none}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--accent);margin-top:7px;flex:0 0 9px}
    .ititle{font-weight:700}
    .imeta{color:var(--muted);font-size:13px;margin-top:2px}
    .go{margin-left:auto;align-self:center;background:var(--btnbg);color:var(--btnfg);border:1px solid var(--stroke);height:36px;min-width:64px;border-radius:9px;cursor:pointer}
    .empty{padding:20px;color:var(--muted);text-align:center}

    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;border:0;display:none;z-index:20;color:#fff;font-weight:600}
    .routeHud{position:absolute;right:12px;bottom:12px;z-index:8;background:rgba(10,19,33,.92);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:10px 12px;min-width:200px}
    @media (max-width:640px){.btn{min-width:84px}.panel{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <div class="panel">
      <h3 id="title">近くを検索</h3>
      <div class="row">
        <input id="q" class="input grow" type="text" placeholder="店名・カテゴリ・住所・電話・座標・施設" />
        <select id="radius" class="input" style="width:110px">
          <option value="10000">10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>
        <button id="btnSearch" class="btn">検索</button>
        <button id="btnClear" class="btn secondary">クリア</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="check"><input id="useCenter" type="checkbox" /> 地図中心で検索</label>
        <label class="check"><input id="optOpenNow" type="checkbox" /> 営業中</label>
        <label class="check"><input id="optSortRating" type="checkbox" /> 高レビュー順</label>
        <label class="check"><input id="optPhotos" type="checkbox" /> 画像あり</label>
      </div>
      <div id="coordBar">緯度: -- / 経度: --</div>
    </div>

    <div class="results" id="results" hidden></div>
    <div class="routeHud" id="routeHud" hidden>
      <div><strong id="routeTitle">経路</strong></div>
      <div id="routeMeta" class="imeta">--</div>
    </div>
    <div id="toast" class="toast"></div>
  </div>

  <!-- Google Maps JS API（ユーザー指定のブラウザキー） -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP"></script>

  <script type="module">
    const ORS_BASE = "https://ors-proxy.miyata-connect-jp.workers.dev";
    const $ = (id)=>document.getElementById(id);
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const toast=(m,ok=false)=>{const t=$("toast");t.style.background=ok?"#25d07a":"#ff6565";t.textContent=m;t.style.display="block";clearTimeout(t._t);t._t=setTimeout(()=>t.style.display="none",3000)};

    let map,here={lat:35.681236,lng:139.767125},curMarker,destMarker,dirSvc,dirRend;

    // 先に宣言しておく（起動直後の未定義エラー対策）
    function clearResults(){
      const host=$("results");
      host.hidden=true;
      host.style.display="none";
      host.innerHTML="";
    }

    async function waitMaps(){
      const start=Date.now();
      while(Date.now()-start<12000){
        if(window.google&&google.maps&&google.maps.importLibrary)return;
        await sleep(50);
      }throw new Error("Maps の読み込みに失敗しました");
    }

    function updateCoord(p){
      $("coordBar").textContent = `緯度: ${p.lat.toFixed(6)} / 経度: ${p.lng.toFixed(6)}`;
    }

    function locate(){
      if(!navigator.geolocation){
        updateCoord(here);
        return;
      }
      navigator.geolocation.getCurrentPosition(pos=>{
        here={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.setCenter(here);
        curMarker.position=here;
        updateCoord(here);
      },()=>{
        // 失敗時は初期 center を使う（エラートーストは出さない）
        updateCoord(here);
      },{enableHighAccuracy:true,timeout:8000,maximumAge:0});
    }

    try{
      await waitMaps();
      const {Map}=await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");
      const {DirectionsService,DirectionsRenderer}=await google.maps.importLibrary("routes");

      map=new Map($("map"),{center:here,zoom:16,mapId:"DEMO_MAP",disableDefaultUI:true});
      curMarker=new AdvancedMarkerElement({map,position:here});
      dirSvc=new DirectionsService();dirRend=new DirectionsRenderer({map,suppressMarkers:true});

      locate();
      updateCoord(here);

      $("btnSearch").onclick=doSearch;
      $("btnClear").onclick=()=>{ $("q").value=""; clearResults(); };
      $("q").onkeydown=e=>{ if(e.key==="Enter") doSearch(); };
    }catch(e){
      toast("初期化エラー: "+e.message);
    }

    function distHav(a,b){ // km
      const R=6371, toR=Math.PI/180;
      const dLat=(b.latitude-a.lat)*toR, dLon=(b.longitude-a.lng)*toR;
      const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);
      const A=s1*s1 + Math.cos(a.lat*toR)*Math.cos(b.latitude*toR)*s2*s2;
      return R*2*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));
    }
    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

    async function doSearch(){
      const q=$("q").value.trim(); if(!q){ toast("検索語を入力してください"); return; }
      const radius=parseInt($("radius").value)||10000;
      const useCenter=$("useCenter").checked;
      const optOpen=$("optOpenNow").checked;
      const optRate=$("optSortRating").checked;
      const optPhoto=$("optPhotos").checked;

      const base = useCenter ? map.getCenter().toJSON() : here;
      const body={
        textQuery:q,
        languageCode:"ja",
        regionCode:"JP",
        pageSize:5,
        openNow:optOpen,
        locationBias:{circle:{center:{latitude:base.lat,longitude:base.lng},radius}}
      };

      try{
        const r=await fetch(`${ORS_BASE}/places:searchText`,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify(body)
        });
        const d=await r.json();
        let list=d.places||[];

        if(optPhoto) list=list.filter(p=>Array.isArray(p.photos)&&p.photos.length>0);
        // 並び：高評価 or 近い順
        if(optRate) list.sort((a,b)=>(b.rating||0)-(a.rating||0));
        else list.sort((a,b)=>distHav(base,a.location)-distHav(base,b.location));

        renderResults(list,radius,base);
      }catch(e){
        toast("検索エラー: "+e.message);
      }
    }

    function renderResults(list,radius,center){
      const wrap=document.createElement("div");wrap.className="card";
      if(!list.length){
        wrap.innerHTML=`<div class="empty">結果がありません</div>`;
      }else{
        list.forEach(p=>{
          const d=distHav(center,p.location);
          const el=document.createElement("div");
          el.className="item";
          el.innerHTML=`<div class="dot"></div>
            <div class="grow">
              <div class="ititle">${escapeHtml(p.displayName?.text||"名称不明")}</div>
              <div class="imeta">${d.toFixed(2)} km ・ ${escapeHtml(p.formattedAddress||"")} ${p.rating?`・⭐${p.rating}`:""}</div>
            </div>
            <button class="go">Go</button>`;
          el.onclick=()=>startRoute(p,center);
          el.querySelector(".go").onclick=()=>startRoute(p,center);
          wrap.appendChild(el);
        });
      }
      const host=$("results");host.innerHTML="";host.appendChild(wrap);
      host.hidden=false;host.style.display="block";
      $("title").textContent=`近くを検索（${Math.round(radius/1000)} km / ${list.length}件）`;
    }

    async function startRoute(p,origin){
      const dst={lat:p.location.latitude,lng:p.location.longitude};
      if(!destMarker){
        const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");
        destMarker=new AdvancedMarkerElement({map,position:dst});
      }else{
        destMarker.position=dst;
      }
      try{
        const url=new URL(`${ORS_BASE}/directions`);
        url.searchParams.set("origin",`${origin.lat},${origin.lng}`);
        url.searchParams.set("destination",`${dst.lat},${dst.lng}`);
        url.searchParams.set("mode","walking");
        url.searchParams.set("language","ja");
        url.searchParams.set("region","JP");

        const r=await fetch(url);
        const d=await r.json();
        dirRend.setDirections(d);

        const leg=d.routes?.[0]?.legs?.[0];
        $("routeTitle").textContent=p.displayName?.text||"目的地";
        $("routeMeta").textContent=leg?`${leg.distance.text} ・ ${leg.duration.text}`:"--";
        $("routeHud").hidden=false;

        // 検索結果を閉じる
        clearResults();
        map.setCenter(dst);
      }catch(e){
        toast("経路取得エラー: "+e.message);
      }
    }
  </script>
</body>
</html>