<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321; --text:#eaf2ff; --muted:#a7b8ce; --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78); --stroke: rgba(255,255,255,.12);
      --ok:#25d07a; --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;z-index:0}
    .overlay{
      position:absolute;left:12px;right:12px;top:12px;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px);
      z-index:10; pointer-events:auto;
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{
      position:fixed;right:12px;bottom:18px;display:flex;flex-direction:column;gap:14px;
      z-index:9999; pointer-events:none;
    }
    .btn{
      width:96px;height:96px;border-radius:24px;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.28); color:#fff; text-decoration:none; cursor:pointer;
      box-shadow:0 10px 30px rgba(0,0,0,.45); background:rgba(0,0,0,.42);
      font-weight:600; letter-spacing:.2px; pointer-events:auto; user-select:none;
    }
    .toast{
      position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;
      background:#ff6b6b;color:white;border:0;display:none;z-index:10000
    }
    /* 結果パネル */
    #results{ position:fixed; left:12px; right:12px; bottom:120px; top:auto;
      max-height:40vh; overflow:auto; z-index:9998; display:none; }
    #results h4{ margin:0 0 10px; font-size:14px; color:var(--muted) }
    .item{ padding:10px 8px; border-radius:12px; border:1px solid var(--stroke);
      background:rgba(255,255,255,.04); margin-bottom:8px; cursor:pointer }
    .item b{ display:block; font-size:15px; color:var(--text) }
    .item small{ display:block; color:var(--muted) }
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div id="panel" class="overlay">
      <div class="row">
        <strong id="panel-title">Set your destination</strong>
        <span id="coord" style="font-variant-numeric:tabular-nums;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
    </div>

    <!-- 検索結果パネル -->
    <div id="results" class="overlay">
      <h4>Search results</h4>
      <div id="list"></div>
    </div>

    <div class="pill">
      <button id="btn-current" class="btn" title="Current">Current</button>
      <button id="btn-search" class="btn" title="Search">Search</button>
      <button id="btn-stop" class="btn" title="Stop">Stop</button>
      <button id="btn-dest" class="btn" title="Destination">Dest</button>
      <button id="btn-reroute" class="btn" title="Reroute">Reroute</button>
      <button id="btn-ops" class="btn" title="Ops">Ops</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Google Maps JS API（ブラウザキー） -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    const toast = (msg, ok=false) => {
      const el = document.getElementById('toast');
      el.style.background = ok ? "var(--ok)" : "var(--danger)";
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 2500);
    };

    async function waitForGoogleMaps(timeout = 15000) {
      const t0 = performance.now();
      while (performance.now() - t0 < timeout) {
        if (globalThis.google?.maps?.importLibrary) return;
        await new Promise(r => setTimeout(r, 50));
      }
      throw new Error("Google Maps failed to load within timeout");
    }

    const PROXY_BASE = "https://ors-proxy.miyata-connect-jp.workers.dev";
    const cfPlacesSearchText = async (payload) => {
      const r = await fetch(`${PROXY_BASE}/places:searchText`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
      const text = await r.text();
      if (!r.ok) throw new Error(`places ${r.status}: ${text.slice(0,120)}`);
      try { return JSON.parse(text); } catch { return { raw:text }; }
    };
    const cfDirections = async (params) => {
      const q = new URLSearchParams(params);
      const r = await fetch(`${PROXY_BASE}/directions?${q}`);
      const text = await r.text();
      if (!r.ok) throw new Error(`directions ${r.status}: ${text.slice(0,120)}`);
      try { return JSON.parse(text); } catch { return { raw:text }; }
    };

    let map, currentMarker, destMarker, routePolyline;
    let currentPos = { lat: 35.681236, lng: 139.767125 };
    let destination = null;

    const setCoord = (p)=>{
      const c = document.getElementById('coord');
      c.textContent = `Lat: ${p.lat.toFixed(6)} / Lng: ${p.lng.toFixed(6)}`;
    };
    const getLocation = ()=>new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error("Geolocation unsupported"));
      navigator.geolocation.getCurrentPosition(
        pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}),
        err=>reject(new Error(err.message||"Location error")),
        {enableHighAccuracy:true,timeout:10000,maximumAge:0}
      );
    });
    const clearRoute = ()=>{ if(routePolyline){ routePolyline.setMap(null); routePolyline=null; } };

    // 結果パネル制御
    const resultsBox = document.getElementById('results');
    const listBox = document.getElementById('list');
    const showResults = (items)=>{ resultsBox.style.display = "block"; listBox.innerHTML = ""; items.forEach(addItem); };
    const hideResults = ()=>{ resultsBox.style.display = "none"; listBox.innerHTML = ""; };
    const addItem = (p)=>{
      const el = document.createElement('div');
      el.className = 'item';
      el.innerHTML = `<b>${p.displayName?.text ?? "Unnamed place"}</b><small>${p.formattedAddress ?? ""}</small>`;
      el.onclick = ()=>{
        destination = { lat:p.location.latitude, lng:p.location.longitude };
        if(!destMarker){ destMarker = new google.maps.marker.AdvancedMarkerElement({ map, position: destination }); }
        else { destMarker.position = destination; }
        map.panTo(destination);
        hideResults();
        toast("Destination set", true);
      };
      listBox.appendChild(el);
    };

    function decodePolyline(str){
      if(!str) return [];
      let index=0,lat=0,lng=0,coords=[];
      while(index<str.length){
        let b,shift=0,result=0;
        do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
        const dlat=(result&1)?~(result>>1):(result>>1); lat+=dlat;
        shift=0; result=0;
        do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20);
        const dlng=(result&1)?~(result>>1):(result>>1); lng+=dlng;
        coords.push({lat:lat/1e5,lng:lng/1e5});
      }
      return coords;
    }

    try{
      await waitForGoogleMaps();
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: currentPos, zoom: 16, mapId: "WALKNAV_MAP", disableDefaultUI: true
      });
      currentMarker = new AdvancedMarkerElement({ map, position: currentPos });
      setCoord(currentPos);

      try{
        currentPos = await getLocation();
        map.setCenter(currentPos);
        currentMarker.position = currentPos;
        setCoord(currentPos);
      }catch(e){ /* 位置取れなくても続行 */ }

      document.getElementById("btn-current").addEventListener("click", async ()=>{
        try{
          const p = await getLocation();
          currentPos = p; map.setCenter(p); currentMarker.position = p; setCoord(p);
          toast("Centered", true);
        }catch(e){ toast(e.message); }
      });

      document.getElementById("btn-search").addEventListener("click", async ()=>{
        const q = window.prompt("Search text (e.g., Ramen Tokushima):","ラーメン 徳島市");
        if(!q){ hideResults(); return; }
        try{
          toast("Searching…");
          const res = await cfPlacesSearchText({
            textQuery: q, languageCode: "ja", regionCode: "JP", pageSize: 5
          });
          const items = res?.places || [];
          if (!items.length){ hideResults(); toast("0件でした"); return; }
          showResults(items);
          toast(`${items.length}件ヒット`, true);
        }catch(e){
          hideResults();
          toast(`Search error: ${e.message}`);
        }
      });

      document.getElementById("btn-dest").addEventListener("click", ()=>{
        if(!destination){ toast("Destination not set"); return; }
        map.panTo(destination); toast("Destination centered", true);
      });

      document.getElementById("btn-reroute").addEventListener("click", async ()=>{
        if(!destination){ toast("Destination not set"); return; }
        clearRoute();
        try{
          const dir = await cfDirections({
            origin:`${currentPos.lat},${currentPos.lng}`,
            destination:`${destination.lat},${destination.lng}`,
            mode:"walking", language:"ja", region:"JP"
          });
          const poly = dir?.routes?.[0]?.overview_polyline?.points || "";
          const pts = decodePolyline(poly);
          routePolyline = new google.maps.Polyline({ path: pts, map, strokeOpacity:1.0 });
          toast("Route updated", true);
        }catch(e){ toast(`Directions error: ${e.message}`); }
      });

      document.getElementById("btn-stop").addEventListener("click", ()=>{
        clearRoute(); toast("Route cleared", true);
      });

      // 結果パネル外をタップで閉じられるように
      document.getElementById('map').addEventListener('click', hideResults);
    }catch(e){
      console.error(e);
      toast("Init error: "+e.message);
    }
  </script>
</body>
</html>