<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav</title>
  <style>
:root{
  --glass: rgba(20,28,44,.54);
  --glass-strong: rgba(16,22,36,.68);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
  --mic-green:#0cb35a;
  --mic-red:#d53d3d;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Meiryo,sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0}
.glassbar{position:absolute;left:0;right:0;top:0;z-index:420;padding:10px 12px;pointer-events:none}
.card{pointer-events:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:16px;backdrop-filter: blur(14px) saturate(120%);-webkit-backdrop-filter: blur(14px) saturate(120%);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px 12px;width:min(1100px,96vw);margin:0 auto}
.row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.grow{flex:1 1 220px}
input,button{background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px;outline:none;min-height:44px}
button.primary{background:rgba(95,177,255,.92);border:none;font-weight:700}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button.reroute{background:var(--accent);border:none;color:#fff;font-weight:700}
button.reroute:hover{background:#00c2ff}
#micBtn{background:var(--mic-green)}
#micBtn.rec{background:var(--mic-red)}
.hint{color:var(--muted);font-size:13px}
.comp-wrap{position:absolute;left:10px;top:150px;z-index:425}
.compass{width:90px;height:90px;background:var(--glass);border:1px solid var(--stroke);border-radius:50%;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 10px 26px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
.compass .needle{transform-origin:38px 38px}
.gm-fab-col{display:flex;flex-direction:column;gap:10px;transform:translateY(40px);z-index:430}
.gm-fab-col .btn-wide{min-width:150px;box-shadow:0 12px 26px rgba(0,0,0,.45);background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px}
.gm-fab-col .btn-wide.ok{background:var(--ok);border:none}
.gm-fab-col .btn-wide.danger{background:var(--danger);border:none}
.gm-fab-col .btn-wide.reroute{background:var(--accent);border:none;color:#fff}
.gm-fab-col .zooms{display:flex;flex-direction:column;gap:8px;align-items:center}
.gm-fab-col .btn-zoom{width:44px;height:44px;border-radius:8px;border:1px solid var(--stroke);background:var(--glass-strong);color:#fff;font-size:18px;line-height:44px;text-align:center;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.loading-screen{position:fixed;inset:0;background:#0e1a2d;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:1;transition:opacity .4s;flex-direction:column;gap:20px}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-inner{text-align:center;padding:28px 24px}
.loading-sub{font-size:18px;line-height:1.6;color:#cfe0ff;white-space:pre-line}
.debug-log{background:rgba(0,0,0,.7);border:1px solid #444;border-radius:8px;padding:12px;max-width:90vw;max-height:200px;overflow-y:auto;font-size:11px;text-align:left;color:#0f0}
.debug-log div{margin:2px 0;font-family:monospace}
.error-banner{position:absolute;left:12px;right:12px;bottom:12px;z-index:999;background:#d53d3d;color:#fff;border-radius:10px;padding:10px 12px;text-align:center;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    <div id="glassbar" class="glassbar">
      <div class="card row">
        <input id="searchBox" class="grow" placeholder="è¡Œãå…ˆã‚’æ¤œç´¢">
        <button id="searchBtn" class="primary">æ¤œç´¢</button>
        <button id="micBtn">ğŸ¤</button>
        <button id="locBtn">ğŸ“</button>
      </div>
      <div class="hint">éŸ³å£°æ¤œç´¢ãƒ»å†æ¸¬ä½ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚</div>
    </div>
    <div class="comp-wrap">
      <div class="compass">
        <svg class="needle" width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M38 8 L42 38 L38 36 L34 38 Z" fill="#ff6565" stroke="#fff" stroke-width="1"/>
          <path d="M38 68 L42 38 L38 40 L34 38 Z" fill="#eaf2ff" stroke="#444" stroke-width="1"/>
          <circle cx="38" cy="38" r="4" fill="#5fb1ff" stroke="#fff" stroke-width="2"/>
        </svg>
      </div>
    </div>
    <div id="loading" class="loading-screen">
      <div class="loading-inner">
        <div class="loading-sub">ãƒ‡ãƒ¼ã‚¿é€šä¿¡æ–™å‰Šæ¸›ã®ãŸã‚ã€<br>ç¾åœ¨åœ°ã®åœ°å›³è¡¨ç¤ºä¸­ã§ã™ã€‚<br>è¡¨ç¤ºã¾ã§ã€ã“ã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„â€¦</div>
      </div>
      <div id="debugLog" class="debug-log"></div>
    </div>
    <div id="error-banner" class="error-banner hidden">
      <div id="error-text">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</div>
    </div>
    <div id="status" style="position:absolute;left:10px;bottom:10px;z-index:999;color:#cfe0ff;font-size:12px;"></div>
  </div>
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentPositionMarker=null,destinationMarker=null,watchId=null,isNavigating=false,initDone=false,hasLocationFix=false;
const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/places/text",GEO_TIMEOUT_MS=8000,FALLBACK_CENTER={lat:35.681236,lng:139.767125},LS_LAST_LOC="WALKNAV_LAST_LOCATION";

function log(msg){console.log(msg);const el=document.getElementById("debugLog");if(el){const d=document.createElement("div");d.textContent=new Date().toLocaleTimeString()+" "+msg;el.appendChild(d);el.scrollTop=el.scrollHeight}}

log("ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†");

window.gm_authFailure=function(){log("ERROR: Google Mapsèªè¨¼å¤±æ•—");showError("APIã‚­ãƒ¼ã‚¨ãƒ©ãƒ¼ï¼šè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„")};

function waitForGoogleMaps(){
  log("Google Maps APIèª­ã¿è¾¼ã¿å¾…æ©Ÿé–‹å§‹");
  let attempts=0;
  const maxAttempts=50;
  const checkInterval=setInterval(()=>{
    attempts++;
    log(`ãƒã‚§ãƒƒã‚¯ ${attempts}/${maxAttempts}`);
    if(typeof google!=="undefined"&&google.maps){
      clearInterval(checkInterval);
      log("Google Maps APIèª­ã¿è¾¼ã¿ç¢ºèªï¼");
      initMap();
    }else if(attempts>=maxAttempts){
      clearInterval(checkInterval);
      log("ERROR: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ - Google Maps APIãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“");
      showError("åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚");
      hideLoading();
    }
  },200);
}

function initMap(){
  log("initMapå‘¼ã³å‡ºã—");
  if(initDone){log("æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿");return}
  initDone=!0;
  
  if(typeof google==="undefined"||!google.maps){log("ERROR: google.mapsãŒæœªå®šç¾©");showError("Google Maps APIã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");return}
  
  log("Google Maps APIèª­ã¿è¾¼ã¿æˆåŠŸ");
  const center=readLastLocation()||FALLBACK_CENTER;
  log("ä¸­å¿ƒåº§æ¨™: "+center.lat+","+center.lng);
  
  try{
    map=new google.maps.Map(document.getElementById("map"),{center,zoom:15,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,clickableIcons:!1,zoomControl:!1});
    log("åœ°å›³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä½œæˆæˆåŠŸ");
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    log("DirectionsåˆæœŸåŒ–å®Œäº†");
    
    let tilesLoaded=!1;
    google.maps.event.addListenerOnce(map,"tilesloaded",()=>{log("ã‚¿ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†");tilesLoaded=!0;hideLoading()});
    setTimeout(()=>{if(!tilesLoaded){log("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼šå¼·åˆ¶ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è§£é™¤");hideLoading()}},5e3);
    
    mountRightControls();
    bindUI();
    setupCompass();
    log("UIåˆæœŸåŒ–å®Œäº†");
    
    if(navigator.geolocation){
      log("ä½ç½®æƒ…å ±å–å¾—é–‹å§‹");
      navigator.geolocation.getCurrentPosition(pos=>{
        log("ä½ç½®æƒ…å ±å–å¾—æˆåŠŸ");
        const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
        hasLocationFix=!0;
        saveLastLocation(here);
        map.setCenter(here);
        placeOrMoveCurrent(here);
        startLocationWatch();
      },err=>{
        log("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—: "+err.message);
        console.warn("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—ã€‚FALLBACKé©ç”¨ã€‚",err.message);
        placeOrMoveCurrent(center);
      },{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0})
    }else{
      log("ä½ç½®æƒ…å ±éå¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶");
      console.warn("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚")
    }
  }catch(e){
    log("ERROR: åˆæœŸåŒ–ä¾‹å¤– - "+e.message);
    console.error(e);
    showError("åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: "+e.message)
  }
}

function hideLoading(){
  const el=document.getElementById("loading");
  if(el&&"none"!==el.style.display){
    log("ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º");
    el.classList.add("hide");
    setTimeout(()=>el.style.display="none",400)
  }
}

function mountRightControls(){
  const c=document.createElement("div");
  c.className="gm-fab-col";
  const btnStart=mkBtn("æ¡ˆå†…é–‹å§‹","ok","gm-start-nav"),btnStop=mkBtn("æ¡ˆå†…ã‚’åœæ­¢","danger","gm-stop-nav"),btnReroute=mkBtn("ãƒªãƒ«ãƒ¼ãƒˆ","reroute","gm-reroute"),zooms=document.createElement("div");
  zooms.className="zooms";
  zooms.append(mkBtn("ï¼‹","btn-zoom","gm-zoom-in"),mkBtn("ï¼","btn-zoom","gm-zoom-out"));
  c.append(btnStart,btnStop,btnReroute,zooms);
  map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(c);
  const gb=q("#glassbar"),toggle=()=>{const visible=gb&&"none"!==getComputedStyle(gb).display;c.style.display=visible?"none":""};
  new MutationObserver(toggle).observe(document.body,{attributes:!0,childList:!0,subtree:!0});
  addEventListener("resize",toggle);
  setTimeout(toggle,100);
}

function mkBtn(label,cls,id){
  const b=document.createElement("button");
  b.textContent=label;
  b.className=cls.includes("btn-zoom")?cls:`btn-wide ${cls}`;
  b.id=id;
  return b;
}

function bindUI(){
  q("#searchBtn").onclick=searchPlace;
  q("#micBtn").onclick=initVoiceRecognition;
  q("#locBtn").onclick=relocalize;
  q("#searchBox").addEventListener("keydown",e=>{"Enter"===e.key&&searchPlace()});
  document.addEventListener("click",e=>{
    const id=e.target?.id||"";
    "gm-start-nav"===id?startNav():"gm-stop-nav"===id?stopNav():"gm-reroute"===id?reroute(!0):"gm-zoom-in"===id?map.setZoom(map.getZoom()+1):"gm-zoom-out"===id&&map.setZoom(map.getZoom()-1);
  });
}

function relocalize(){
  setStatus("ç¾åœ¨åœ°ã‚’å†å–å¾—ä¸­â€¦");
  if(!navigator.geolocation)return void showError("ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
  navigator.geolocation.getCurrentPosition(pos=>{
    const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
    hasLocationFix=!0;
    saveLastLocation(here);
    placeOrMoveCurrent(here);
    map.panTo(here);
    setStatus("ç¾åœ¨åœ°ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
  },err=>showError("ç¾åœ¨åœ°å–å¾—å¤±æ•—: "+err.message),{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function startLocationWatch(){
  if(!navigator.geolocation)return;
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
    hasLocationFix=!0;
    saveLastLocation(here);
    placeOrMoveCurrent(here);
    isNavigating&&reroute(!1);
  },err=>console.warn("watchPosition:",err.message),{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function placeOrMoveCurrent(latlng){
  currentPositionMarker?currentPositionMarker.setPosition(latlng):currentPositionMarker=new google.maps.Marker({position:latlng,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"},title:"ç¾åœ¨åœ°"});
}

async function searchPlace(){
  const qv=q("#searchBox").value.trim();
  if(!qv)return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
  if(!currentPositionMarker)return showError("ç¾åœ¨åœ°ã®å–å¾—ã‚’å¾…ã£ã¦ã„ã¾ã™ã€‚");
  setStatus("æ¤œç´¢ä¸­â€¦");
  try{
    const pos=currentPositionMarker.getPosition(),payload={textQuery:qv,locationBias:pos?{circle:{center:{latitude:pos.lat(),longitude:pos.lng()},radius:2e4}}:void 0};
    const res=await fetch(PLACES_PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!res.ok)throw new Error(await res.text());
    const data=await res.json(),place=data?.places?.[0];
    if(!place)return showError("è©²å½“ã™ã‚‹åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    const lat=place.location?.latitude,lng=place.location?.longitude,name=place.displayName?.text||qv;
    destinationMarker&&destinationMarker.setMap(null);
    destinationMarker=new google.maps.Marker({position:{lat,lng},map,title:name});
    map.panTo({lat,lng});
    setStatus(`æ¤œç´¢å®Œäº†: ${name}`);
  }catch(e){
    console.error(e);
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
  }
}

function startNav(){
  if(!currentPositionMarker||!destinationMarker)return showError("ç¾åœ¨åœ°ã¾ãŸã¯ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™ã€‚");
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  setStatus("çµŒè·¯è¨ˆç®—ä¸­â€¦");
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    "OK"!==status?showError("çµŒè·¯ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚"):(directionsRenderer.setDirections(res),isNavigating=!0,speak("æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚"),setStatus("æ¡ˆå†…ä¸­"));
  });
}

function stopNav(){
  directionsRenderer.setDirections({routes:[]});
  isNavigating=!1;
  speak("æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
  setStatus("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚");
}

function reroute(manual){
  if(!isNavigating)return void(manual&&showError("æ¡ˆå†…ãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"));
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    "OK"!==status?showError("ãƒªãƒ«ãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"):(directionsRenderer.setDirections(res),manual&&speak("ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚"),setStatus("æ¡ˆå†…æ›´æ–°ä¸­"));
  });
}

function initVoiceRecognition(){
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition)return showError("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚");
  const recognition=new SpeechRecognition,micBtn=q("#micBtn");
  recognition.lang="ja-JP";
  recognition.continuous=!1;
  recognition.interimResults=!1;
  micBtn.classList.add("rec");
  recognition.onresult=e=>{const transcript=e.results[0][0].transcript;q("#searchBox").value=transcript;searchPlace();micBtn.classList.remove("rec")};
  recognition.onerror=e=>{console.error("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼:",e.error);showError("éŸ³å£°èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");micBtn.classList.remove("rec")};
  recognition.onend=()=>micBtn.classList.remove("rec");
  recognition.start();
}

let compassAlpha=0,targetAlpha=0;
function setupCompass(){
  const needle=document.querySelector(".needle");
  if(!needle)return;
  !function animate(){compassAlpha=.8*compassAlpha+.2*targetAlpha;needle.style.transform=`rotate(${compassAlpha}deg)`;requestAnimationFrame(animate)}();
  const useAlpha=a=>{"number"==typeof a&&(targetAlpha=a)};
  "undefined"!=typeof DeviceOrientationEvent&&window.addEventListener("deviceorientation",e=>{"number"==typeof e.alpha&&useAlpha(e.alpha)});
}

function q(s){return document.querySelector(s)}
function setStatus(s){const el=q("#status");el&&(el.textContent=s||"")}
function showError(msg){
  log("ERROR: "+msg);
  const b=q("#error-banner"),t=q("#error-text");
  t&&(t.textContent=msg);
  b&&(b.classList.remove("hidden"),setTimeout(()=>b.classList.add("hidden"),4e3));
  speak(msg);
}
function speak(t){try{const u=new SpeechSynthesisUtterance(t);u.lang="ja-JP";speechSynthesis.speak(u)}catch{}}
function saveLastLocation(latlng){try{localStorage.setItem(LS_LAST_LOC,JSON.stringify(latlng))}catch{}}
function readLastLocation(){try{const s=localStorage.getItem(LS_LAST_LOC);if(!s)return null;const v=JSON.parse(s);if("number"==typeof v?.lat&&"number"==typeof v?.lng)return v}catch{}return null}

waitForGoogleMaps();
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places" async defer></script>
</body>
</html>