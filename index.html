<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Walk-NAV</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kG9kG8a9kaK2vNhbbX6YsJh8e3toDnN2DXW8A="
    crossorigin=""
    defer
  ></script>

  <style>
    /* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåŸºç¤ ===== */
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "æ¸¸ã‚´ã‚·ãƒƒã‚¯ä½“", Meiryo, sans-serif; }

    /* åœ°å›³ */
    #map { position:fixed; inset:0; z-index:0; }

    /* ã‚¬ãƒ©ã‚¹æ¿ï¼ˆå³ä¸Šå›ºå®šï¼šç¾çŠ¶ã®ãƒ‡ã‚¶ã‚¤ãƒ³ç¶­æŒï¼‰ */
    .glass {
      position: fixed;
      top: 12px;
      right: 12px;
      width: min(92vw, 720px);
      max-height: calc(100vh - 24px);
      overflow: auto;
      padding: 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.62);
      box-shadow: 0 8px 28px rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      z-index: 5;
    }

    .row { display:flex; align-items:center; }
    .gap { gap:10px; margin-top:10px; flex-wrap: wrap; }
    .mini-gap { gap:8px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .section { margin-top: 12px; }
    .section-title { font-weight:600; margin-bottom:6px; }

    .input {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.85);
      outline: none;
    }

    .btn {
      cursor:pointer;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      background:#f2f2f2;
    }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn.secondary { background:#e5e7eb; }
    .btn.green { background:#16a34a; color:#fff; }
    .btn.blue { background:#0ea5e9; color:#fff; }
    .btn.red { background:#ef4444; color:#fff; }
    .btn.big { padding: 12px 18px; }
    .btn.mic { font-size: 14px; }
    .btn.mic.green { background:#16a34a; color:#fff; }
    .btn.mic.recording, .btn.loading { background:#ef4444 !important; color:#fff; }
    .btn.ghost { background:transparent; border:1px solid rgba(0,0,0,.2); }

    .mode-btn, .lang-btn {
      cursor:pointer;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.2);
      background:#fff;
      padding:8px 12px;
      font-weight:600;
    }
    .mode-btn.selected, .lang-btn.selected { background:#0ea5e9; color:#fff; border-color: transparent; }

    .lang-accordion summary { cursor:pointer; list-style:none; }
    .summary-center { text-align:center; font-weight:700; }
    .langs { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; justify-content:center; }

    /* å³ã‚µã‚¤ãƒ‰ç¸¦ãƒœã‚¿ãƒ³ï¼ˆåœ°å›³ä¸Šï¼‰ */
    .right-stack {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 4;
      pointer-events: auto;
    }
    .btn-right {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      cursor: pointer;
    }

    /* æ–¹ä½è¨ˆï¼ˆå·¦å´ï¼‰ */
    .compass-wrap {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 4;
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }
    .compass-dial {
      width: 84px; height: 84px;
      border-radius: 50%;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      position: relative;
      box-shadow: 0 4px 18px rgba(0,0,0,.16);
      pointer-events: auto;
    }
    .compass-needle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 2px;
      height: 70%;
      background: #ef4444;
      transform-origin: 50% calc(100% - 8px); /* é‡ã®åŸºç‚¹ã‚’ç›¤ä¸­å¿ƒå¯„ã‚Šã« */
      transform: translate(-50%,-90%) rotate(0deg);
      border-radius: 2px;
    }
    .heading-buttons { display:flex; flex-direction: column; gap:8px; pointer-events: auto; }
    .btn-mini { padding: 6px 8px; border-radius: 8px; background:rgba(255,255,255,.92); border:1px solid rgba(0,0,0,.15); cursor:pointer; }

    /* æ¤œç´¢çµæœã‚¹ãƒ©ã‚¤ãƒ‰ */
    .results {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.9);
      transform: translateY(-8px);
      transition: transform .22s ease;
      display:none;
    }
    .results.show { display:block; transform: translateY(0); }
    .results-head {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,.08);
    }
    #results-list { list-style:none; padding:8px 12px; margin:0; }
    #results-list li { padding: 8px 4px; cursor:pointer; border-bottom:1px dashed rgba(0,0,0,.08); }
    #results-list li:last-child { border-bottom: none; }

    .status { margin-top: 10px; font-size: 13px; opacity:.9; }

    /* ===== å¤‰æ›´ç‚¹1ï¼šLeafletã‚ºãƒ¼ãƒ ã‚’å·¦ä¸‹ã¸ï¼ˆæ¿ã¨å¹²æ¸‰ã•ã›ãªã„ï¼‰ ===== */
    .leaflet-bottom.leaflet-left { bottom: 12px !important; left: 12px !important; }
    .leaflet-bottom .leaflet-control { margin-bottom: 0 !important; }
    .leaflet-left .leaflet-control  { margin-left: 0 !important; }

    /* ===== å¤‰æ›´ç‚¹2ï¼šé–‹å§‹/ç›®çš„ åœ°ç‚¹ã®çµŒåº¦ãƒ»ç·¯åº¦å…¥åŠ›ã®ãƒãƒŸå‡ºã—é˜²æ­¢ ===== */
    #start-lng, #start-lat, #end-lng, #end-lat {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
      display: block;
      text-align: center;
    }
    .grid2.mini-gap { grid-template-columns: 1fr 1fr; }
    @media (max-width: 520px) {
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Map -->
  <div id="map"></div>

  <!-- å³ã‚µã‚¤ãƒ‰ç¸¦ãƒœã‚¿ãƒ³ï¼ˆåœ°å›³ä¸Šã€‚æ¿ã¨å¹²æ¸‰ã—ãªã„ä½ç½®/ä½™ç™½æ¸ˆã¿ï¼‰ -->
  <div class="right-stack">
    <button id="btn-current" class="btn-right">ç¾åœ¨åœ°</button>
    <button id="btn-dest"    class="btn-right">ç›®çš„åœ°</button>
    <button id="btn-reroute" class="btn-right">ãƒªãƒ«ãƒ¼ãƒˆ</button>
  </div>

  <!-- æ–¹ä½è¨ˆï¼ˆé‡ã¯ä¸­å¿ƒå›è»¢ãƒ»ç›¤å†…ã«åã‚ã‚‹ï¼‰ -->
  <div class="compass-wrap">
    <div class="compass-dial">
      <div class="compass-needle" id="compass-needle"></div>
    </div>
    <div class="heading-buttons">
      <button id="btn-north"  class="btn-mini">åŒ—ã‚’å‘ã</button>
      <button id="btn-heading" class="btn-mini">é€²è¡Œæ–¹å‘</button>
    </div>
  </div>

  <!-- ã‚¬ãƒ©ã‚¹æ¿ï¼ˆ1æšã«çµ±åˆï¼‰ -->
  <div id="panel" class="glass">
    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div class="row search-row">
      <input id="q" class="input" placeholder="åç§°ãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" />
      <button id="btn-voice" class="btn mic green" title="éŸ³å£°æ¤œç´¢ï¼ˆé•·æŠ¼ã—ã§éŒ²éŸ³é–‹å§‹ï¼‰">ğŸ¤ éŸ³å£°</button>
    </div>

    <!-- ä¸Šæ®µï¼šæ¤œç´¢ï¼‹å±¥æ­´ã‚¯ãƒªã‚¢ -->
    <div class="row gap">
      <button id="btn-search" class="btn primary">æ¤œç´¢</button>
      <button id="btn-clear-history" class="btn secondary">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼šæœ€çŸ­/æ¥½ãƒãƒ³/ãŠæ•£æ­©Ai/è¦³å…‰æ¡ˆå†…ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
    <div class="row gap">
      <button class="mode-btn selected" data-mode="shortest">æœ€çŸ­</button>
      <button class="mode-btn" data-mode="easy">æ¥½ãƒãƒ³</button>
      <button class="mode-btn" data-mode="walkai">ãŠæ•£æ­©Ai</button>
      <button class="mode-btn" data-mode="tour">è¦³å…‰æ¡ˆå†…</button>
    </div>

    <!-- è¨€èªï¼šç¸¦ãƒˆã‚°ãƒ«ï¼ˆçœã‚¹ãƒšãƒ¼ã‚¹ï¼‰ -->
    <details class="lang-accordion">
      <summary class="summary-center">è¨€èª / Language</summary>
      <div class="langs">
        <button class="lang-btn selected" data-lang="ja">æ—¥æœ¬èª</button>
        <button class="lang-btn" data-lang="en">English</button>
        <button class="lang-btn" data-lang="de">Deutsch</button>
        <button class="lang-btn" data-lang="it">Italiano</button>
        <button class="lang-btn" data-lang="fr">FranÃ§ais</button>
        <button class="lang-btn" data-lang="es">EspaÃ±ol</button>
        <button class="lang-btn" data-lang="ko">í•œêµ­ì–´</button>
        <button class="lang-btn" data-lang="zh">ä¸­æ–‡</button>
      </div>
    </details>

    <!-- ä½ç½®å…¥åŠ›ï¼ˆé–‹å§‹/ç›®çš„ï¼‰ -->
    <div class="grid2 gap section">
      <div>
        <div class="section-title">é–‹å§‹åœ°ç‚¹</div>
        <div class="grid2 mini-gap">
          <input id="start-lng" class="input" placeholder="çµŒåº¦" />
          <input id="start-lat" class="input" placeholder="ç·¯åº¦" />
        </div>
      </div>
      <div>
        <div class="section-title">ç›®çš„åœ°ç‚¹</div>
        <div class="grid2 mini-gap">
          <input id="end-lng" class="input" placeholder="çµŒåº¦" />
          <input id="end-lat" class="input" placeholder="ç·¯åº¦" />
        </div>
      </div>
    </div>

    <!-- ä¿å­˜/è¨­å®š/æ¡ˆå†… -->
    <div class="row gap">
      <button id="btn-save" class="btn green">ç¾åœ¨åœ°ã‚’ä¿å­˜</button>
      <button id="btn-set-dest" class="btn blue">ç›®çš„åœ°ã«è¨­å®š</button>
      <button id="btn-start" class="btn green big">æ¡ˆå†…é–‹å§‹</button>
      <button id="btn-stop"  class="btn red big">æ¡ˆå†…ã‚’åœæ­¢</button>
    </div>

    <!-- æ¤œç´¢çµæœãƒ“ãƒ¥ãƒ¼ï¼ˆã‚¹ãƒ©ã‚¤ãƒ‰åˆ‡æ›¿ï¼‰ -->
    <div id="results" class="results">
      <div class="results-head">
        <div class="results-title">æ¤œç´¢çµæœ</div>
        <button id="btn-close-results" class="btn ghost">Ã—</button>
      </div>
      <ul id="results-list"></ul>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div id="status" class="status"></div>
  </div>

  <script>
    window.addEventListener('load', () => {
      /***********************
       * è¨­å®š
       ************************/
      // â† å¿…ãšã‚ãªãŸã® Worker URL ã«æ›¸ãæ›ãˆï¼ˆæ—¢å­˜ã®å€¤ã‚’ç¶­æŒï¼‰
      const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';

      // æ¤œç´¢ï¼šPlaces API (New) ã® searchText ã‚’ Worker çµŒç”±
      const PLACES_SEARCH_URL = \`\${GMAP_PROXY}/places:searchText\`;
      // ãƒ«ãƒ¼ãƒˆï¼šDirections API
      const DIRECTIONS_URL     = \`\${GMAP_PROXY}/maps/api/directions/json\`;

      // çŠ¶æ…‹
      let currentLang = 'ja';
      let currentMode = 'shortest'; // shortest|easy|walkai|tour
      let watchId = null;
      let headingDeg = 0; // é‡ã®è§’åº¦
      let userMarker = null;
      let destMarker = null;
      let routeLayer = null;
      let lastResults = [];
      let isRecording = false;

      /***********************
       * åœ°å›³
       ************************/
      const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap',
        maxZoom: 19
      }).addTo(map);

      // ã‚ºãƒ¼ãƒ å·¦ä¸‹ï¼ˆæŒ‡å®šé€šã‚Šï¼‰
      L.control.zoom({ position:'bottomleft' }).addTo(map);

      /***********************
       * è¦ç´ 
       ************************/
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      const qInput = $('#q');
      const statusEl = $('#status');
      const resultsEl = $('#results');
      const resultsList = $('#results-list');

      const btnVoice = $('#btn-voice');
      const btnSearch = $('#btn-search');
      const btnClearHistory = $('#btn-clear-history');

      const btnNorth = $('#btn-north');
      const btnHeading = $('#btn-heading');

      const btnCurrent = $('#btn-current');
      const btnDest = $('#btn-dest');
      const btnReroute = $('#btn-reroute');

      const startLng = $('#start-lng');
      const startLat = $('#start-lat');
      const endLng = $('#end-lng');
      const endLat = $('#end-lat');

      const btnSave = $('#btn-save');
      const btnSetDest = $('#btn-set-dest');
      const btnStart = $('#btn-start');
      const btnStop = $('#btn-stop');

      const needle = $('#compass-needle');

      /***********************
       * ãƒ„ãƒ¼ãƒ«
       ************************/
      const sleep = ms => new Promise(r=>setTimeout(r,ms));
      function setStatus(msg){ statusEl.textContent = msg || ''; }
      function asLatLng(lngInput, latInput){
        const lng = parseFloat(lngInput.value);
        const lat = parseFloat(latInput.value);
        if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng];
        return null;
      }

      /***********************
       * éŸ³å£°æ¤œç´¢ï¼ˆWeb Speech API ç°¡æ˜“ï¼‰
       ************************/
      let recog = null;
      function ensureRecog(){
        if (recog) return recog;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) return null;
        recog = new SR();
        recog.lang = langCodeToBCP47(currentLang);
        recog.interimResults = false;
        recog.continuous = false;
        recog.onstart = ()=> { isRecording=true; btnVoice.classList.add('recording'); setStatus('éŒ²éŸ³ä¸­â€¦'); };
        recog.onend   = ()=> { isRecording=false; btnVoice.classList.remove('recording'); };
        recog.onerror = (e)=> { setStatus('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ï¼š' + e.error); };
        recog.onresult= (e)=> {
          const t = e.results[0][0].transcript;
          qInput.value = t;
          setStatus(\`æ¤œç´¢æº–å‚™ï¼š\${t}\`);
        };
        return recog;
      }
      btnVoice.addEventListener('mousedown', ()=> { const r=ensureRecog(); if (r) r.start(); });
      btnVoice.addEventListener('touchstart', (ev)=> { ev.preventDefault(); const r=ensureRecog(); if (r) r.start(); });

      /***********************
       * è¨€èª
       ************************/
      $$('.lang-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          $$('.lang-btn').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          currentLang = b.dataset.lang;
          setStatus(\`è¨€èªï¼š\${b.textContent}\`);
          const r = ensureRecog();
          if (r) r.lang = langCodeToBCP47(currentLang);
        });
      });

      /***********************
       * ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰
       ************************/
      $$('.mode-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          $$('.mode-btn').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          currentMode = b.dataset.mode;
          setStatus(\`ãƒ«ãƒ¼ãƒˆï¼š\${b.textContent}\`);
        });
      });

      /***********************
       * ç¾åœ¨åœ°ã¨æ–¹ä½
       ************************/
      btnCurrent.addEventListener('click', async ()=>{
        try{
          const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
          map.setView([p.coords.latitude, p.coords.longitude], 17);
          updateUserMarker(p.coords.latitude, p.coords.longitude);
          startLng.value = p.coords.longitude.toFixed(6);
          startLat.value = p.coords.latitude.toFixed(6);
          setStatus('ç¾åœ¨åœ°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
        }catch(e){
          setStatus('ç¾åœ¨åœ°ã‚¨ãƒ©ãƒ¼ï¼š'+e.message);
        }
      });

      function getCurrentPosition(opts={}){
        return new Promise((res,rej)=>{
          navigator.geolocation.getCurrentPosition(res,rej,opts);
        });
      }
      function watchHeading(){
        if (watchId) return;
        watchId = navigator.geolocation.watchPosition(p=>{
          headingDeg = (p.coords.heading || 0);
          updateNeedle(headingDeg);
          if (btnHeading.dataset.active === '1'){
            map.panTo([p.coords.latitude, p.coords.longitude], {animate:true});
            updateUserMarker(p.coords.latitude, p.coords.longitude);
          }
        }, ()=>{}, {enableHighAccuracy:true, maximumAge:3000, timeout:15000});
      }
      function updateNeedle(deg){
        needle.style.transform = \`translate(-50%,-90%) rotate(\${deg}deg)\`;
      }
      function updateUserMarker(lat,lng){
        if (!userMarker){
          userMarker = L.marker([lat,lng]).addTo(map);
        }else{
          userMarker.setLatLng([lat,lng]);
        }
      }
      btnNorth.addEventListener('click', ()=>{
        btnHeading.dataset.active = '0';
        setStatus('åŒ—å›ºå®š');
      });
      btnHeading.addEventListener('click', ()=>{
        btnHeading.dataset.active = (btnHeading.dataset.active === '1' ? '0' : '1');
        setStatus(btnHeading.dataset.active==='1'?'é€²è¡Œæ–¹å‘ãƒ¢ãƒ¼ãƒ‰':'é€²è¡Œæ–¹å‘OFF');
      });
      watchHeading();

      /***********************
       * æ¤œç´¢ â†’ çµæœã‚¹ãƒ©ã‚¤ãƒ‰ â†’ ç›®çš„åœ°ã‚»ãƒƒãƒˆ â†’ ãƒ«ãƒ¼ãƒˆå–å¾—
       ************************/
      btnSearch.addEventListener('click', async ()=>{
        const text = qInput.value.trim();
        if (!text){ setStatus('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return; }
        btnSearch.classList.add('loading'); btnVoice.classList.add('loading');
        try{
          const resp = await fetch(PLACES_SEARCH_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ textQuery:text, languageCode: langCodeToBCP47(currentLang) })
          });
          const data = await resp.json();
          lastResults = (data.places||[]).map(p=>({
            id: p.id,
            name: p.displayName?.text || p.name || '(no name)',
            address: p.formattedAddress || '',
            loc: p.location ? [p.location.latitude, p.location.longitude] : null
          }));
          renderResults(lastResults);
          showResults(true); // ã‚¹ãƒ©ã‚¤ãƒ‰è¡¨ç¤º
          addHistory(text);
          setStatus(\`æ¤œç´¢ï¼š\${lastResults.length}ä»¶\`);
        }catch(e){
          setStatus('æ¤œç´¢å¤±æ•—ï¼š'+e.message);
        }finally{
          btnSearch.classList.remove('loading'); btnVoice.classList.remove('loading');
        }
      });

      function renderResults(items){
        resultsList.innerHTML = '';
        if (!items.length){
          resultsList.innerHTML = '<li>è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</li>';
          return;
        }
        for (const r of items){
          const li = document.createElement('li');
          li.innerHTML = \`<div><strong>\${escapeHtml(r.name)}</strong></div>
                          <div style="opacity:.85">\${escapeHtml(r.address)}</div>\`;
          li.addEventListener('click', ()=>{
            if (r.loc){
              endLat.value = r.loc[0].toFixed(6);
              endLng.value = r.loc[1].toFixed(6);
              putDestMarker(r.loc[0], r.loc[1], r.name);
              showResults(false);
              // ãƒ«ãƒ¼ãƒˆå–å¾—ã«è‡ªå‹•é·ç§»ï¼ˆä»•æ§˜é€šã‚Šï¼‰
              btnStart.click();
            }
          });
          resultsList.appendChild(li);
        }
      }

      $('#btn-close-results').addEventListener('click', ()=> showResults(false));
      function showResults(flag){
        resultsEl.classList.toggle('show', !!flag);
      }

      function putDestMarker(lat,lng,name){
        if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
        destMarker.setLatLng([lat,lng]).bindPopup(name||'ç›®çš„åœ°').openPopup();
        map.setView([lat,lng], 17);
      }

      btnSetDest.addEventListener('click', ()=>{
        const ll = asLatLng(endLng, endLat);
        if (!ll){ setStatus('ç›®çš„åœ°ã®ç·¯åº¦çµŒåº¦ãŒä¸æ­£'); return; }
        putDestMarker(ll[0], ll[1], 'ç›®çš„åœ°');
        setStatus('ç›®çš„åœ°ã‚’ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      });

      /***********************
       * ãƒ«ãƒ¼ãƒˆå–å¾—ãƒ»æ¡ˆå†…
       ************************/
      btnStart.addEventListener('click', async ()=>{
        const start = asLatLng(startLng, startLat);
        const end   = asLatLng(endLng, endLat);

        if (!start){
          try{
            const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
            startLat.value = p.coords.latitude.toFixed(6);
            startLng.value = p.coords.longitude.toFixed(6);
          }catch(e){
            setStatus('é–‹å§‹åœ°ç‚¹ãŒæœªè¨­å®šã§ã™'); return;
          }
        }
        const s = asLatLng(startLng, startLat);
        const e = asLatLng(endLng, endLat);
        if (!s || !e){ setStatus('ç·¯åº¦çµŒåº¦ã®å…¥åŠ›ã‚’ç¢ºèª'); return; }

        setStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦'); btnStart.classList.add('loading');
        try{
          const url = new URL(DIRECTIONS_URL);
          url.searchParams.set('origin', \`\${s[0]},\${s[1]}\`);
          url.searchParams.set('destination', \`\${e[0]},\${e[1]}\`);
          url.searchParams.set('mode','walking');
          url.searchParams.set('language', langCodeToBCP47(currentLang));

          const resp = await fetch(url.toString());
          const data = await resp.json();
          if (data.status !== 'OK'){ throw new Error(data.error_message || data.status); }

          drawRoute(data);
          showResults(false);
          setStatus('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
        }catch(e){
          setStatus('ãƒ«ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼ï¼š'+e.message);
        }finally{
          btnStart.classList.remove('loading');
        }
      });

      function drawRoute(d){
        if (routeLayer){ routeLayer.remove(); routeLayer=null; }
        const path = decodePolyline(d.routes[0].overview_polyline.points);
        routeLayer = L.polyline(path, {color:'#22c55e', weight:7, opacity:.88}).addTo(map);
        const bounds = L.latLngBounds(path);
        map.fitBounds(bounds.pad(0.2));
      }

      btnStop.addEventListener('click', ()=>{
        if (routeLayer){ routeLayer.remove(); routeLayer=null; }
        setStatus('æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸ');
        endLat.value=''; endLng.value='';
        if (destMarker){ destMarker.remove(); destMarker=null; }
      });

      btnReroute.addEventListener('click', ()=>{ btnStart.click(); });

      /***********************
       * ä¿å­˜ãƒ»å±¥æ­´
       ************************/
      const LS_SAVED = 'walknav_saved';
      const LS_HISTORY = 'walknav_hist';

      btnSave.addEventListener('click', async ()=>{
        try{
          const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
          const store = JSON.parse(localStorage.getItem(LS_SAVED)||'[]');
          store.unshift({ t:Date.now(), lat:p.coords.latitude, lng:p.coords.longitude });
          localStorage.setItem(LS_SAVED, JSON.stringify(store.slice(0,50)));
          setStatus('ç¾åœ¨åœ°ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        }catch(e){
          setStatus('ä¿å­˜å¤±æ•—ï¼š'+e.message);
        }
      });

      function addHistory(text){
        const h = JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');
        h.unshift({ t:Date.now(), text });
        localStorage.setItem(LS_HISTORY, JSON.stringify(h.slice(0,50)));
      }
      btnClearHistory.addEventListener('click', ()=>{
        localStorage.removeItem(LS_HISTORY);
        endLat.value=''; endLng.value='';
        if (destMarker){ destMarker.remove(); destMarker=null; }
        setStatus('å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
      });

      /***********************
       * ç›®çš„åœ°ãƒœã‚¿ãƒ³ï¼ˆåº§æ¨™â†’åœ°å›³ä¸­å¿ƒã¸ï¼‰
       ************************/
      btnDest.addEventListener('click', ()=>{
        const e = asLatLng(endLng, endLat);
        if (!e){ setStatus('ç›®çš„åœ°ãŒæœªè¨­å®š'); return; }
        map.setView([e[0], e[1]], 17);
      });

      /***********************
       * ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
       ************************/
      function decodePolyline(str){
        let index = 0, lat = 0, lng = 0, coordinates = [];
        while (index < str.length) {
          let b, shift = 0, result = 0;
          do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
          let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
          lat += dlat;
          shift = 0; result = 0;
          do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
          let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
          lng += dlng;
          coordinates.push([lat * 1e-5, lng * 1e-5]);
        }
        return coordinates;
      }
      function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
      function langCodeToBCP47(l){
        switch(l){
          case 'ja': return 'ja';
          case 'en': return 'en';
          case 'de': return 'de';
          case 'it': return 'it';
          case 'fr': return 'fr';
          case 'es': return 'es';
          case 'ko': return 'ko';
          case 'zh': return 'zh';
          default: return 'ja';
        }
      }
    });
  </script>
</body>
</html>
