<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>

  <!-- 発行番号 / ISSUE -->
  <meta name="x-issue" content="idx202511011945" />
  <meta name="description" content="WalkNav - 近くを検索 & ルート案内" />

  <style>
    :root{
      --bg:#0b1220;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.9);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --primary:#62b5ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --shadow:0 10px 35px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}

    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* 右側のフローティングボタン群（常に表示） */
    .fab-stack{
      position:fixed;right:16px;bottom:96px;display:flex;flex-direction:column;gap:12px;
      z-index:2600;
    }
    .panel{
      position:absolute;left:16px;right:110px;top:16px;
      background:var(--glass-strong);border:1px solid var(--stroke);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px 14px 12px;backdrop-filter:blur(10px);
      z-index:2500;
    }
    .panel h2{margin:0 0 10px;font-size:20px;letter-spacing:.5px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);font-size:14px;cursor:pointer;user-select:none}
    .chip.active{background:var(--primary);color:#05233a;border-color:transparent}
    .input{
      flex:1;min-width:220px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);outline:none
    }
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;user-select:none;border:none;
    }
    .btn.primary{background:var(--primary);color:#051a2a;border-color:transparent}
    .btn.danger{background:var(--danger);color:#240808;border-color:transparent}
    .btn:disabled{opacity:.5;pointer-events:none}

    /* 右側のフローティングボタン群（常に表示） */
    .fab{
      min-width:112px; height:56px; display:flex;align-items:center;justify-content:center;
      background:var(--glass-strong); border:1px solid var(--stroke); border-radius:18px;
      color:var(--text); box-shadow:var(--shadow); cursor:pointer; user-select:none;
      font-size:14px;
    }
    .fab:active{transform:translateY(1px)}

    /* ローディング全画面（初期位置取得時のみ） */
    .loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000; color:#fff; font-size:20px; z-index:3000
    }

    /* 検索結果リスト */
    .results{
      margin-top:12px;
      max-height:300px;
      overflow-y:auto;
      background:rgba(0,0,0,.3);
      border-radius:12px;
      padding:8px;
    }
    .result-item{
      padding:10px;
      margin-bottom:6px;
      background:rgba(255,255,255,.05);
      border-radius:8px;
      cursor:pointer;
      transition:background .2s;
    }
    .result-item:hover{
      background:rgba(255,255,255,.1);
    }
    .result-name{
      font-weight:600;
      margin-bottom:4px;
    }
    .result-address{
      font-size:12px;
      color:var(--muted);
    }

    /* トースト/エラー抑止（画面に乗せない） */
    .toast, .error-banner{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="地図"></div>

    <!-- 検索パネル -->
    <section class="panel" id="searchPanel" aria-label="検索パネル">
      <h2>近くを検索（<span id="radiusLabel">10km</span> / <span id="maxResults">5</span>件）</h2>
      <div class="row" style="margin-bottom:8px">
        <button class="chip active" id="r10">10km</button>
        <button class="chip" id="r20">20km</button>
        <button class="chip" id="btnPointSearch" style="margin-left:auto">📍 地点検索</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="q" class="input" placeholder="店舗名・電話番号・住所・座標など" />
        <button id="btnText" class="btn primary">入力検索</button>
        <button id="btnVoice" class="btn">音声検索</button>
        <button id="btnReset" class="btn danger">リセット</button>
      </div>
      <div class="row" style="font-size:13px;color:var(--muted)">
        現在地：<span id="locLabel">緯度 -- / 経度 --</span>
      </div>
      
      <!-- 検索結果リスト -->
      <div id="results" class="results" style="display:none"></div>
    </section>

    <!-- 右側 FAB 群 -->
    <div class="fab-stack" id="fabStack">
      <div class="fab" id="btnLocate">現在地</div>
      <div class="fab" id="btnPause">一時停止</div>
      <div class="fab" id="btnReroute">リルート</div>
    </div>

    <!-- 初期ローディング -->
    <div class="loading" id="loading">
      <div style="text-align:center">
        <div style="font-size:24px;margin-bottom:16px">📍 現在地取得中</div>
        <div style="font-size:16px;opacity:0.8">しばらくお待ちください...</div>
      </div>
    </div>
  </div>

  <script>
    // ====== 発行番号 ======
    const ISSUE_ID = 'idx202511011945';

    // ====== Google Maps 初期化 ======
    let map, userMarker, placesService;
    let currentPos = null;
    let pointSearchMode = false;
    let searchPoint = null;
    let searchPointMarker = null;
    let longPressTimer = null;
    let mapInitialized = false;
    let searchMarkers = [];

    // 現在地マーカー
    function setUserMarker(lat, lng){
      currentPos = {lat, lng};
      const pin = document.createElement('div');
      pin.style.width='22px'; pin.style.height='22px'; pin.style.borderRadius='50%';
      pin.style.background='#3aa0ff'; pin.style.boxShadow='0 0 0 6px rgba(98,181,255,.25)';
      pin.style.border='2px solid #fff';

      if(!userMarker){
        userMarker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: {lat,lng},
          content: pin,
          zIndex: 1000
        });
      }else{
        userMarker.position = {lat,lng};
      }
    }

    function initMap(center){
      map = new google.maps.Map(document.getElementById('map'),{
        center,
        zoom: 17,
        mapId: 'DEMO_MAP',
        gestureHandling:'greedy',
        clickableIcons:true,
        disableDefaultUI:true
      });

      // PlacesService初期化
      placesService = new google.maps.places.PlacesService(map);

      // 地図上の長押しイベント
      map.addListener('mousedown', (e) => {
        if(!pointSearchMode) return;
        longPressTimer = setTimeout(() => {
          setSearchPoint(e.latLng.lat(), e.latLng.lng());
        }, 1000);
      });

      map.addListener('mouseup', () => {
        if(longPressTimer){
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      // タッチデバイス用
      map.addListener('touchstart', (e) => {
        if(!pointSearchMode || !e.latLng) return;
        longPressTimer = setTimeout(() => {
          setSearchPoint(e.latLng.lat(), e.latLng.lng());
        }, 1000);
      });

      map.addListener('touchend', () => {
        if(longPressTimer){
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      mapInitialized = true;
      console.log('[WalkNav] Map initialized');
    }

    // 検索地点を設定
    function setSearchPoint(lat, lng){
      searchPoint = {lat, lng};
      
      if(searchPointMarker){
        searchPointMarker.map = null;
      }

      const pin = document.createElement('div');
      pin.style.width='30px';
      pin.style.height='30px';
      pin.style.borderRadius='50% 50% 50% 0';
      pin.style.background='#ff6565';
      pin.style.border='3px solid #fff';
      pin.style.transform='rotate(-45deg)';
      pin.style.boxShadow='0 4px 8px rgba(0,0,0,.3)';

      searchPointMarker = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: {lat, lng},
        content: pin,
        zIndex: 999
      });

      console.log(`[WalkNav] 検索地点設定: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
      map.panTo({lat, lng});
    }

    // ====== 検索機能（Places Library使用） ======
    function performSearch(query){
      if(!query || query.trim() === ''){
        console.log('[Search] 検索ワードが空です');
        return;
      }

      if(!placesService){
        console.log('[Search] PlacesServiceが初期化されていません');
        return;
      }

      // 検索の基準地点を決定
      let centerLat, centerLng;
      if(pointSearchMode && searchPoint){
        centerLat = searchPoint.lat;
        centerLng = searchPoint.lng;
        console.log(`[Search] 地点検索: "${query}" at ${centerLat.toFixed(6)}, ${centerLng.toFixed(6)}`);
      }else if(currentPos){
        centerLat = currentPos.lat;
        centerLng = currentPos.lng;
        console.log(`[Search] 現在地検索: "${query}" at ${centerLat.toFixed(6)}, ${centerLng.toFixed(6)}`);
      }else{
        console.log('[Search] 検索の基準地点が不明です');
        return;
      }

      // 半径を取得
      const radiusLabel = document.getElementById('radiusLabel').textContent;
      const radiusKm = parseInt(radiusLabel);
      const radiusMeters = radiusKm * 1000;

      // textSearch を使用
      const request = {
        query: query,
        location: new google.maps.LatLng(centerLat, centerLng),
        radius: radiusMeters,
        language: 'ja'
      };

      console.log('[Search] リクエスト:', request);

      placesService.textSearch(request, (results, status) => {
        console.log('[Search] Status:', status);
        console.log('[Search] Results:', results);

        if(status === google.maps.places.PlacesServiceStatus.OK && results){
          // 最大件数に制限
          const maxResults = parseInt(document.getElementById('maxResults').textContent);
          const limitedResults = results.slice(0, maxResults);
          displayResults(limitedResults);
        }else if(status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
          alert('検索結果が見つかりませんでした');
          document.getElementById('results').style.display = 'none';
        }else{
          console.error('[Search] Error:', status);
          alert(`検索エラー: ${status}`);
        }
      });
    }

    // 検索結果を表示
    function displayResults(places){
      // 既存のマーカーをクリア
      searchMarkers.forEach(marker => marker.map = null);
      searchMarkers = [];

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'block';

      places.forEach((place, index) => {
        const name = place.name || '名称不明';
        const address = place.formatted_address || place.vicinity || '住所不明';
        const lat = place.geometry?.location?.lat();
        const lng = place.geometry?.location?.lng();
        const rating = place.rating || '-';
        const ratingCount = place.user_ratings_total || 0;

        // リスト項目を作成
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
          <div class="result-name">${index + 1}. ${name}</div>
          <div class="result-address">${address}</div>
          <div style="font-size:11px;color:#ffa500;margin-top:4px">
            ⭐ ${rating} (${ratingCount}件)
          </div>
        `;
        
        item.onclick = () => {
          if(lat && lng){
            map.panTo({lat, lng});
            map.setZoom(18);
          }
        };

        resultsDiv.appendChild(item);

        // マーカーを作成
        if(lat && lng){
          const markerPin = document.createElement('div');
          markerPin.style.width='24px';
          markerPin.style.height='24px';
          markerPin.style.borderRadius='50%';
          markerPin.style.background='#25d07a';
          markerPin.style.border='2px solid #fff';
          markerPin.style.boxShadow='0 2px 6px rgba(0,0,0,.3)';
          markerPin.style.display='flex';
          markerPin.style.alignItems='center';
          markerPin.style.justifyContent='center';
          markerPin.style.color='#fff';
          markerPin.style.fontSize='12px';
          markerPin.style.fontWeight='bold';
          markerPin.textContent = index + 1;

          const marker = new google.maps.marker.AdvancedMarkerElement({
            map,
            position: {lat, lng},
            content: markerPin,
            zIndex: 500 + index,
            title: name
          });

          searchMarkers.push(marker);
        }
      });

      // 最初の結果に地図を移動
      if(places[0]?.geometry?.location){
        const firstLat = places[0].geometry.location.lat();
        const firstLng = places[0].geometry.location.lng();
        map.panTo({lat: firstLat, lng: firstLng});
        map.setZoom(15);
      }

      console.log(`[Search] ${places.length}件の結果を表示しました`);
    }

    // ====== 現在地の取得 ======
    function acquireLocation(){
      const onOk = (pos)=>{
        const {latitude, longitude} = pos.coords;
        document.getElementById('loading')?.remove();
        if(!map) initMap({lat:latitude, lng:longitude});
        map.setCenter({lat:latitude,lng:longitude});
        setUserMarker(latitude, longitude);

        document.getElementById('locLabel').textContent = `緯度 ${latitude.toFixed(6)} / 経度 ${longitude.toFixed(6)}`;
        
        fetchLocationName(latitude, longitude);
      };
      const onErr = (_e)=>{
        console.log('[WalkNav] geolocation error', _e?.message||_e);
        document.getElementById('loading')?.remove();
        if(!map) initMap({lat:35.0,lng:135.0});
      };
      try{
        navigator.geolocation.getCurrentPosition(onOk,onErr,{enableHighAccuracy:true,timeout:30000,maximumAge:0});
      }catch(e){
        console.log('[WalkNav] geolocation exception', e);
      }
    }

    // ====== 地名取得 ======
    async function fetchLocationName(lat, lng){
      try{
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`
        );
        const data = await response.json();
        
        const addr = data.address || {};
        let locationName = '';
        
        if(addr.city) locationName = addr.city;
        else if(addr.town) locationName = addr.town;
        else if(addr.village) locationName = addr.village;
        else if(addr.county) locationName = addr.county;
        else if(addr.state) locationName = addr.state;
        
        if(addr.suburb) locationName += addr.suburb;
        else if(addr.hamlet) locationName += addr.hamlet;
        
        if(locationName) locationName += '付近';
        else locationName = '位置情報取得完了';
        
        document.getElementById('locLabel').textContent = locationName;
        
      }catch(e){
        console.log('[WalkNav] location name fetch error', e);
      }
    }

    // ====== UI ======
    function bindUI(){
      console.log('[WalkNav] Binding UI...');
      
      const radiusLabel = document.getElementById('radiusLabel');
      const r10 = document.getElementById('r10');
      const r20 = document.getElementById('r20');
      const btnPointSearch = document.getElementById('btnPointSearch');
      
      r10.onclick = ()=>{ 
        r10.classList.add('active'); 
        r20.classList.remove('active'); 
        radiusLabel.textContent='10km'; 
      };
      
      r20.onclick = ()=>{ 
        r20.classList.add('active'); 
        r10.classList.remove('active'); 
        radiusLabel.textContent='20km'; 
      };

      // 地点検索ボタン
      btnPointSearch.onclick = ()=>{
        pointSearchMode = !pointSearchMode;
        if(pointSearchMode){
          btnPointSearch.classList.add('active');
          btnPointSearch.textContent = '📍 地点検索中...';
          console.log('[WalkNav] 地点検索モードON');
        }else{
          btnPointSearch.classList.remove('active');
          btnPointSearch.textContent = '📍 地点検索';
          console.log('[WalkNav] 地点検索モードOFF');
        }
      };

      // 右サイド FAB
      document.getElementById('btnLocate').onclick = ()=>{
        if(currentPos && map) {
          map.panTo(currentPos);
          map.setZoom(17);
        }
      };
      
      document.getElementById('btnPause').onclick = ()=>{ 
        console.log('一時停止ボタンがクリックされました');
      };
      
      document.getElementById('btnReroute').onclick = ()=>{ 
        console.log('リルートボタンがクリックされました');
      };

      // 検索ボタン
      document.getElementById('btnText').onclick = ()=>{
        const q = document.getElementById('q').value.trim();
        if(!q){
          alert('検索ワードを入力してください');
          return;
        }
        performSearch(q);
      };
      
      // Enterキーでも検索
      document.getElementById('q').addEventListener('keypress', (e) => {
        if(e.key === 'Enter'){
          const q = document.getElementById('q').value.trim();
          if(q) performSearch(q);
        }
      });
      
      document.getElementById('btnVoice').onclick = ()=>{
        alert('音声検索機能は今後実装予定です');
      };
      
      document.getElementById('btnReset').onclick = ()=>{
        document.getElementById('q').value = '';
        
        // 検索結果をクリア
        document.getElementById('results').style.display = 'none';
        document.getElementById('results').innerHTML = '';
        
        // 検索マーカーをクリア
        searchMarkers.forEach(marker => marker.map = null);
        searchMarkers = [];
        
        // 検索地点とマーカーをクリア
        searchPoint = null;
        if(searchPointMarker){
          searchPointMarker.map = null;
          searchPointMarker = null;
        }
        
        // 地点検索モードをOFF
        pointSearchMode = false;
        btnPointSearch.classList.remove('active');
        btnPointSearch.textContent = '📍 地点検索';
        
        console.log('[WalkNav] リセット完了');
      };

      console.log('[WalkNav] UI binding complete');
    }

    // ====== 起動 ======
    function startApp(){
      console.log('[WalkNav] Starting app...');
      document.documentElement.lang = 'ja';
      bindUI();
      acquireLocation();
      console.log('[WalkNav] ISSUE', ISSUE_ID, 'boot');
    }

    // Google Maps API読み込み完了を待つ
    function initializeWhenReady(){
      if(typeof google !== 'undefined' && google.maps && google.maps.Map && google.maps.places){
        startApp();
      }else{
        setTimeout(initializeWhenReady, 100);
      }
    }

    window.addEventListener('DOMContentLoaded', initializeWhenReady);
  </script>

  <!-- Google Maps JS API - placesライブラリを追加 -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk&v=weekly&libraries=marker,places"
    async defer></script>
</body>
</html>
