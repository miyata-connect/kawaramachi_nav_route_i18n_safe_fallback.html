<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
      --btnfg:#111;
      --btnbg:#eaf2ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .panel{
      position:absolute;left:12px;right:12px;top:12px;z-index:10;
      background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      border-radius:14px;padding:14px;max-width:820px;margin:0 auto;box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .panel h3{margin:0 0 10px;font-size:18px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grow{flex:1 1 280px}
    .input{
      width:100%;height:44px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;font-size:16px;
    }
    select.input{padding-right:32px}
    .btn{
      height:44px;min-width:92px;border-radius:10px;border:1px solid var(--stroke);
      background:var(--btnbg);color:var(--btnfg);padding:0 14px;font-weight:600;cursor:pointer;
    }
    .btn.secondary{background:rgba(255,255,255,.18);color:#111}
    .check{display:flex;align-items:center;gap:6px;color:var(--text);opacity:.9}
    .check input{width:18px;height:18px}

    /* 結果リスト：下部固定＋上に十分な余白を持つ */
    .results{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:9;
      max-width:820px;margin:0 auto;
      max-height:45vh;overflow-y:auto;
      border-radius:14px;background:rgba(10,19,33,.9);
      border:1px solid var(--stroke);backdrop-filter:blur(8px);
      box-shadow:0 -4px 20px rgba(0,0,0,.4);
    }
    .card{overflow:hidden}
    .item{display:flex;gap:12px;align-items:flex-start;padding:14px 16px;border-top:1px solid var(--stroke);cursor:pointer}
    .item:first-child{border-top:none}
    .dot{width:9px;height:9px;border-radius:50%;background:var(--accent);margin-top:7px;flex:0 0 9px}
    .ititle{font-weight:700}
    .imeta{color:var(--muted);font-size:13px;margin-top:2px}
    .go{margin-left:auto;align-self:center;background:var(--btnbg);color:var(--btnfg);border:1px solid var(--stroke);height:36px;min-width:64px;border-radius:9px;cursor:pointer}
    .empty{padding:20px;color:var(--muted);text-align:center}

    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;border:0;display:none;z-index:20;color:#fff;font-weight:600}
    .routeHud{position:absolute;right:12px;bottom:12px;z-index:8;background:rgba(10,19,33,.92);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:10px 12px;min-width:200px}
    @media (max-width:640px){.btn{min-width:84px}.panel{padding:12px}}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <div class="panel">
      <h3 id="title">近くを検索</h3>
      <div class="row">
        <input id="q" class="input grow" type="text" placeholder="店名・カテゴリ・住所など" />
        <select id="radius" class="input" style="width:110px">
          <option value="10000">10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>
        <button id="btnSearch" class="btn">検索</button>
        <button id="btnClear" class="btn secondary">クリア</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="check"><input id="optOpenNow" type="checkbox" /> 営業中</label>
        <label class="check"><input id="optSortRating" type="checkbox" /> 高レビュー順</label>
        <label class="check"><input id="optPhotos" type="checkbox" /> 画像あり</label>
        <span id="coord" style="margin-left:auto;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
    </div>

    <div class="results" id="results" hidden></div>
    <div class="routeHud" id="routeHud" hidden>
      <div><strong id="routeTitle">Route</strong></div>
      <div id="routeMeta" class="imeta">--</div>
    </div>
    <div id="toast" class="toast"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP"></script>
  <script type="module">
    const ORS_BASE = "https://ors-proxy.miyata-connect-jp.workers.dev";
    const $ = (id)=>document.getElementById(id);
    const sleep=(ms)=>new Promise(r=>setTimeout(r,ms));
    const toast=(m,ok=false)=>{const t=$("toast");t.style.background=ok?"#25d07a":"#ff6565";t.textContent=m;t.style.display="block";clearTimeout(t._t);t._t=setTimeout(()=>t.style.display="none",3000)};
    let map,here={lat:35.681236,lng:139.767125},curMarker,destMarker,dirSvc,dirRend;

    async function waitMaps(){
      const start=Date.now();
      while(Date.now()-start<10000){
        if(window.google&&google.maps&&google.maps.importLibrary)return;
        await sleep(50);
      }throw new Error("Maps not loaded");
    }

    try{
      await waitMaps();
      const {Map}=await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");
      const {DirectionsService,DirectionsRenderer}=await google.maps.importLibrary("routes");
      map=new Map($("map"),{center:here,zoom:16,mapId:"DEMO_MAP",disableDefaultUI:true});
      curMarker=new AdvancedMarkerElement({map,position:here});
      dirSvc=new DirectionsService();dirRend=new DirectionsRenderer({map,suppressMarkers:true});
      locate();
      $("btnSearch").onclick=doSearch;$("btnClear").onclick=clearResults;
      $("q").onkeydown=e=>{if(e.key==="Enter")doSearch()};
    }catch(e){toast("init error "+e.message)}

    function locate(){
      if(!navigator.geolocation){toast("No geolocation");updateCoord(here);return;}
      navigator.geolocation.getCurrentPosition(pos=>{
        here={lat:pos.coords.latitude,lng:pos.coords.longitude};
        map.setCenter(here);curMarker.position=here;updateCoord(here);
      },()=>{updateCoord(here);toast("位置取得失敗:地図中心を使用")});
    }
    function updateCoord(p){$("coord").textContent=`Lat: ${p.lat.toFixed(6)} / Lng: ${p.lng.toFixed(6)}`}

    async function doSearch(){
      const q=$("q").value.trim();if(!q)return toast("入力を確認");
      const radius=parseInt($("radius").value)||10000;
      const optOpen=$("optOpenNow").checked,optRate=$("optSortRating").checked,optPhoto=$("optPhotos").checked;
      const center=map.getCenter().toJSON();
      const body={textQuery:q,languageCode:"ja",regionCode:"JP",pageSize:5,locationBias:{circle:{center:{latitude:center.lat,longitude:center.lng},radius}},openNow:optOpen};
      try{
        const r=await fetch(`${ORS_BASE}/places:searchText`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)});
        const d=await r.json();let list=d.places||[];
        if(optPhoto)list=list.filter(p=>Array.isArray(p.photos)&&p.photos.length>0);
        if(optRate)list.sort((a,b)=>(b.rating||0)-(a.rating||0));
        else list.sort((a,b)=>dist(center,a.location)-dist(center,b.location));
        renderResults(list,radius,center);
      }catch(e){toast("検索エラー:"+e.message)}
    }

    function dist(a,b){return Math.hypot(a.lat-b.latitude,a.lng-b.longitude)}
    function km(m){return(m/1000).toFixed(2)}
    function hav(lat1,lon1,lat2,lon2){const R=6371,toR=d=>d*Math.PI/180;const dLat=toR(lat2-lat1),dLon=toR(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toR(lat1))*Math.cos(toR(lat2))*Math.sin(dLon/2)**2;return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))}
    function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}

    function renderResults(list,radius,center){
      const wrap=document.createElement("div");wrap.className="card";
      wrap.innerHTML=list.length?""`<div class='empty'>結果がありません</div>`;
      list.forEach(p=>{
        const d=hav(center.lat,center.lng,p.location.latitude,p.location.longitude);
        const el=document.createElement("div");
        el.className="item";
        el.innerHTML=`<div class="dot"></div><div class="grow"><div class="ititle">${escapeHtml(p.displayName?.text||"名称不明")}</div><div class="imeta">${d.toFixed(2)} km ・ ${escapeHtml(p.formattedAddress||"")} ${p.rating?`・⭐${p.rating}`:""}</div></div><button class="go">Go</button>`;
        // Goボタン＆アイテム全体クリックでルート開始
        el.onclick=()=>startRoute(p,center);
        el.querySelector(".go").onclick=()=>startRoute(p,center);
        wrap.appendChild(el);
      });
      const host=$("results");host.innerHTML="";host.appendChild(wrap);
      host.hidden=false;host.style.display="block";
      $("title").textContent=`近くを検索（${Math.round(radius/1000)} km / ${list.length}件）`;
    }

    async function startRoute(p,origin){
      const dst={lat:p.location.latitude,lng:p.location.longitude};
      if(!destMarker){const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");destMarker=new AdvancedMarkerElement({map,position:dst});}else destMarker.position=dst;
      try{
        const url=new URL(`${ORS_BASE}/directions`);
        url.searchParams.set("origin",`${origin.lat},${origin.lng}`);url.searchParams.set("destination",`${dst.lat},${dst.lng}`);url.searchParams.set("mode","walking");url.searchParams.set("language","ja");url.searchParams.set("region","JP");
        const r=await fetch(url);const d=await r.json();dirRend.setDirections(d);
        const route=d.routes?.[0]?.legs?.[0];$("routeTitle").textContent=p.displayName?.text||"Destination";
        $("routeMeta").textContent=route?`${route.distance.text} ・ ${route.duration.text}`:"--";
        $("routeHud").hidden=false;
        $("results").style.display="none"; // ← ルート開始時に検索結果非表示
        map.setCenter(dst);
      }catch(e){toast("ルート取得失敗:"+e.message)}
    }
  </script>
</body>
</html>