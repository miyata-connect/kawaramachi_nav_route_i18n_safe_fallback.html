<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>ナビアプリ 診断プログラム</title>
<style>
  body { font-family: sans-serif; background: #f0f2f5; color: #333; padding: 20px; }
  #results { background: #fff; border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
  .pass { color: green; font-weight: bold; }
  .fail { color: red; font-weight: bold; }
  .info { color: navy; }
  pre { background: #eee; padding: 10px; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; }
</style>
</head>
<body>

<h1>ナビアプリ 診断プログラム</h1>
<div id="results">診断を開始します...</div>

<script>
(async function() {
  const resultsDiv = document.getElementById('results');
  let html = '';

  function log(message, type) {
    const className = type || '';
    html += `<p class="${className}">${message}</p>`;
    resultsDiv.innerHTML = html;
  }

  // --- テスト 1: ライブラリの読み込み ---
  log('<h3>テスト1: ライブラリの読み込み</h3>');
  try {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
    if (typeof L !== 'undefined') {
      log('Leaflet (地図ライブラリ) の読み込み: <span class="pass">成功</span>', 'pass');
    } else {
      throw new Error('Lオブジェクトが見つかりません。');
    }
  } catch (e) {
    log('Leaflet (地図ライブラリ) の読み込み: <span class="fail">失敗</span>', 'fail');
    log('→ これが失敗する場合、ネットワークの問題かunpkg.comへのアクセスがブロックされている可能性があります。', 'info');
    return; // これ以上進めない
  }

  // --- テスト 2: ブラウザ機能のチェック ---
  log('<h3>テスト2: ブラウザ機能のチェック</h3>');
  if (navigator.geolocation) {
    log('Geolocation API (現在地取得): <span class="pass">利用可能</span>', 'pass');
  } else {
    log('Geolocation API (現在地取得): <span class="fail">利用不可</span>', 'fail');
  }
  if (window.SpeechRecognition || window.webkitSpeechRecognition) {
    log('SpeechRecognition API (音声認識): <span class="pass">利用可能</span>', 'pass');
  } else {
    log('SpeechRecognition API (音声認識): <span class="fail">利用不可</span>', 'fail');
  }
  
  // --- テスト 3: 外部サーバーへの接続テスト ---
  log('<h3>テスト3: 外部サーバーへの接続テスト</h3>');
  const urlsToTest = [
    { name: 'ルート検索サーバー (Cloudflare Workers)', url: 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy' },
    { name: '地名検索サーバー (Photon)', url: 'https://photon.komoot.io/api/?q=test' },
    { name: '地名検索サーバー (Nominatim)', url: 'https://nominatim.openstreetmap.org/search?q=test&format=json' }
  ];

  for (const target of urlsToTest) {
    log(`---<br>接続先: ${target.name}`);
    try {
      const response = await fetch(target.url, { method: 'GET', mode: 'cors' });
      log(`接続テスト: <span class="pass">成功</span> (HTTPステータス: ${response.status})`, 'pass');
    } catch (error) {
      log(`接続テスト: <span class="fail">失敗</span>`, 'fail');
      log('エラー内容:', 'info');
      html += `<pre>${error.toString()}</pre>`;
      resultsDiv.innerHTML = html;
      log('→ これが失敗する場合、ネットワークの問題、セキュリティソフトによるブロック、またはサーバー自体がダウンしている可能性があります。特に「TypeError: Failed to fetch」と表示される場合は、その可能性が高いです。', 'info');
    }
  }
  
  log('<hr><h3>診断完了</h3>');

})();
</script>
</body>
</html>
