<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>歩行ナビ（最短 / 楽チン / お散歩AI）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
:root{
  --bg:#0f1a25; --panel:#132235; --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b; --aqua:#7fd3ff;
  --compassSize:82px; --compassMargin:18px; --labelW:8ch;
}
*{box-sizing:border-box}
html,body,#app{height:100%;margin:0;background:var(--bg);color:var(--text);font-family: system-ui,"Noto Sans JP","Helvetica Neue",Arial,"メイリオ",Meiryo,sans-serif}
#map{position:fixed;inset:0}
.panel{
  position:fixed;left:12px;top:12px;display:grid;gap:10px;padding:12px 12px 10px 12px;
  background:color-mix(in oklab, var(--panel) 85%, #0000 15%);
  border:1px solid color-mix(in oklab, var(--panel) 70%, #fff0 30%);
  border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.28);backdrop-filter: blur(6px);
  width:min(420px, calc(100vw - 24px));
}
.row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
input,select,button{
  appearance:none;border:none;outline:none;border-radius:12px;padding:10px 12px;font-size:15px;
  background:#132d45;color:var(--text)
}
input::placeholder{color:#b8c7d8}
button{cursor:pointer;transition:.2s transform}
button.primary{background:linear-gradient(180deg,#3ea4ff,#1a7be5)}
button.ghost{background:#1b2a3b}
button.warn{background:#4b1f29}
button:active{transform:scale(.98)}
.small{font-size:12px;color:var(--muted)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.badge{display:inline-block;padding:3px 8px;border-radius:10px;background:#21364d;color:#cae3ff;margin-left:6px}
h1{font-size:18px;margin:0 0 2px 0}
.kbd{padding:2px 6px;border:1px solid #40669a;border-radius:6px;font-size:12px}
ul#history{margin:6px 0 0 0;padding:0;list-style:none;max-height:120px;overflow:auto}
ul#history li{display:flex;justify-content:space-between;align-items:center;gap:6px;margin:4px 0;padding:6px 8px;background:#102436;border-radius:10px}
ul#history li button{padding:6px 8px}
hr{border:0;border-top:1px solid #1e334b;margin:6px 0}
.dialog{
  position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:5000
}
.dialog .box{
  width:min(420px,95vw);background:#132235;border:1px solid #27415f;border-radius:14px;padding:14px
}
.dialog.show{display:grid}
.mode-btn{padding:12px;border-radius:12px;border:1px solid #254264;background:#14283d;color:#e3f0ff}
.mode-btn:hover{outline:2px solid #3ea4ff}
.legend{position:fixed;right:12px;top:12px;background:#132235;border:1px solid #27415f;border-radius:12px;padding:8px 10px}
.legend .dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:6px}
.token{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div id="map"></div>

<div class="panel" id="panel">
  <div>
    <h1>歩行ナビ <span class="badge" id="modeBadge">最短</span></h1>
    <div class="small">クリックで目的地設定 / ルート再計算・音声案内に対応</div>
  </div>

  <div class="row">
    <input id="destInput" placeholder="目的地（地図をクリックでもOK）">
    <div class="grid2">
      <button id="setDest" class="ghost">目的地に設定</button>
      <button id="deleteDest" class="warn">削除</button>
    </div>
  </div>

  <div class="row">
    <div class="grid2">
      <button id="navStart" class="primary">案内開始</button>
      <button id="stopNav" class="ghost">停止</button>
    </div>
    <button id="reroute" class="ghost">リルート</button>
  </div>

  <div class="grid2">
    <button id="modeShortest" class="mode-btn">最短</button>
    <button id="modeEasy" class="mode-btn">楽チン</button>
  </div>
  <button id="modeStroll" class="mode-btn">お散歩AI</button>

  <hr/>
  <div class="row">
    <div class="small">履歴</div>
    <button id="clearHistory" class="ghost">履歴をクリア</button>
  </div>
  <ul id="history"></ul>
</div>

<!-- モード選択（リルート） -->
<div class="dialog" id="reroutePicker">
  <div class="box">
    <h3 style="margin:0 0 8px 0">リルート</h3>
    <div class="grid2" style="margin-bottom:8px">
      <button class="mode-btn" data-mode="shortest">最短</button>
      <button class="mode-btn" data-mode="easy">楽チン</button>
    </div>
    <button class="mode-btn" data-mode="stroll" style="width:100%">お散歩AI</button>
    <hr>
    <div class="row">
      <span class="small">Esc / 外側クリックで閉じる</span>
      <button class="ghost" onclick="closeDialog('reroutePicker')">閉じる</button>
    </div>
  </div>
</div>

<!-- お散歩AI 長中短 -->
<div class="dialog" id="strollPicker">
  <div class="box">
    <h3 style="margin:0 0 8px 0">お散歩AI：距離</h3>
    <div class="grid2" style="margin-bottom:8px">
      <button class="mode-btn" data-len="short">短（約1km）</button>
      <button class="mode-btn" data-len="mid">中（約2km）</button>
    </div>
    <button class="mode-btn" data-len="long" style="width:100%">長（約3km）</button>
    <hr>
    <div class="row">
      <span class="small">距離は概算・道路状況により変動します</span>
      <button class="ghost" onclick="closeDialog('strollPicker')">閉じる</button>
    </div>
  </div>
</div>

<div class="legend small">
  <div><span class="dot" style="background:#4aa3ff"></span>現在ルート</div>
  <div><span class="dot" style="background:#2ecc71"></span>代替（楽チン）</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ========= ユーティリティ ========= */
const $ = (id)=> document.getElementById(id);
function openDialog(id){ const d=$(id); d.classList.add('show'); d.onclick=(e)=>{ if(e.target===d) closeDialog(id); } }
function closeDialog(id){ $(id).classList.remove('show'); }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function speakJa(text){
  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang='ja-JP'; u.rate = 1; u.pitch = 1;
    window.speechSynthesis.speak(u);
  }catch(e){}
}
function token(n){ return Number(n).toLocaleString('ja-JP'); }

/* ========= 地図初期化 ========= */
const map = L.map('map', {zoomControl:false}).setView([34.345, 134.046], 15); // 高松・瓦町あたり
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution:'© OpenStreetMap'
}).addTo(map);
L.control.zoom({position:'bottomright'}).addTo(map);

/* ========= 状態 ========= */
let startLatLng = null;             // 出発（現在地）
let destLatLng = null;              // 目的地
let routeLayer = null;              // メインルート
let altLayer = null;                // 代替ルート（楽チン）
let destMarker = null;
let isNavigating = false;
let navTimer = null;
let routeGeo = null;                // GeoJSON LineString
let routeMode = 'shortest';         // 'shortest' | 'easy' | 'stroll'
let strollLength = 'mid';           // 'short' | 'mid' | 'long'
const historyList = [];             // {name, lat, lng}

/* ========= 現在地取得 ========= */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    startLatLng = [pos.coords.latitude, pos.coords.longitude];
    map.setView(startLatLng, 16);
    L.circleMarker(startLatLng,{radius:7,color:'#7fd3ff'}).addTo(map).bindTooltip('現在地');
  }, ()=>{
    startLatLng = map.getCenter(); // 取得不可なら中心
    L.circleMarker(startLatLng,{radius:7,color:'#7fd3ff'}).addTo(map).bindTooltip('現在地（推定）');
  });
}else{
  startLatLng = map.getCenter();
}

/* ========= UI: 目的地設定 ========= */
map.on('click', e=>{
  setDestination(e.latlng.lat, e.latlng.lng, '地図から');
});
$('setDest').onclick = ()=>{
  const v = $('destInput').value.trim();
  if(!v){ speakJa('目的地の入力が空です'); return; }
  // 簡易：緯度,経度 形式にも対応（例: "34.34,134.05"）
  const m = v.match(/^\s*(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)\s*$/);
  if(m){
    setDestination(parseFloat(m[1]), parseFloat(m[3]), '座標');
  }else{
    speakJa('地図クリック または「緯度,経度」で指定してください');
  }
};
$('deleteDest').onclick = clearDestination;
$('clearHistory').onclick = ()=>{
  historyList.length = 0;
  renderHistory();
  clearDestination(); // ★ 履歴クリアで目的地もクリア（要件7）
};

function setDestination(lat,lng, label=''){
  destLatLng = [lat,lng];
  $('destInput').value = `${lat.toFixed(6)},${lng.toFixed(6)}`
  if(destMarker){ map.removeLayer(destMarker); }
  destMarker = L.marker(destLatLng).addTo(map).bindTooltip('目的地');
  // 履歴追加
  historyList.unshift({name:label||'目的地', lat, lng});
  if(historyList.length>50) historyList.pop();
  renderHistory();
  // 目的地が入ったら即リルート
  ensureRouteForCurrentMode(true);
}

function renderHistory(){
  const ul = $('history'); ul.innerHTML='';
  for(const h of historyList){
    const li = document.createElement('li');
    li.innerHTML = `<span>${h.name} <span class="small">(${h.lat.toFixed(5)}, ${h.lng.toFixed(5)})</span></span>`;
    const b = document.createElement('button');
    b.className='ghost'; b.textContent='目的地に設定';
    b.onclick = ()=> setDestination(h.lat,h.lng,h.name);
    li.appendChild(b);
    ul.appendChild(li);
  }
}

function clearDestination(){
  destLatLng = null;
  if(destMarker){ map.removeLayer(destMarker); destMarker=null; }
  $('destInput').value='';
  // ルートも消す
  setRoute(null,null);
}

/* ========= ルート描画・消去 ========= */
function setRoute(geo, alt){
  if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; }
  if(altLayer){ map.removeLayer(altLayer); altLayer=null; }
  routeGeo = geo;
  if(geo){
    routeLayer = L.geoJSON(geo,{style:{color:'#4aa3ff',weight:6,opacity:.95}}).addTo(map);
    const b = routeLayer.getBounds(); if(b.isValid()) map.fitBounds(b.pad(0.15));
  }
  if(alt){
    altLayer = L.geoJSON(alt,{style:{color:'#2ecc71',weight:4,opacity:.7,dashArray:'6 8'}}).addTo(map);
  }
}

/* ========= OSRM ルーティング ========= */
async function osrmRoute(coords){ // coords: [[lat,lng], [lat,lng], ...]
  const ll = coords.map(([la,ln])=> `${ln},${la}`).join(';');
  const url = `https://router.project-osrm.org/route/v1/foot/${ll}?overview=full&geometries=geojson&alternatives=true&steps=false`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('OSRM error');
  const j = await r.json();
  return j.routes; // [{geometry:{coordinates:[[lng,lat],...]}, distance, duration}, ...]
}

/* ========= お散歩AI：袋小路スパー除去 ========= */
function _dist(a,b){const dx=a.lat-b.lat, dy=a.lng-b.lng; return Math.hypot(dx,dy);}
function _angle(p0,p1,p2){
  const v1=[p0.lat-p1.lat,p0.lng-p1.lng], v2=[p2.lat-p1.lat,p2.lng-p1.lng];
  const c=(v1[0]*v2[0]+v1[1]*v2[1])/(Math.hypot(...v1)*Math.hypot(...v2));
  return Math.acos(Math.max(-1,Math.min(1,c)))*180/Math.PI;
}
function stripDeadEndSpurs(polyline, proxim=0.00012 /*~13m*/, uTurn=160){
  if(!polyline || polyline.length<4) return polyline;
  let pts = polyline.slice();
  let changed = true;
  while(changed){
    changed = false;
    for(let i=2;i<pts.length;i++){
      const tail = pts[pts.length-1];
      const nearIdx = pts.findIndex((p,idx)=> idx<pts.length-2 && _dist(p,tail) < proxim);
      if(nearIdx>=0){
        const a = pts[pts.length-3], b = pts[pts.length-2], c = pts[pts.length-1];
        if(_angle(a,b,c) > uTurn){
          pts.splice(nearIdx+1, pts.length-(nearIdx+1));
          changed = true;
          break;
        }
      }
    }
  }
  return pts;
}

/* ========= ルート要求（モード別） ========= */
async function ensureRouteForCurrentMode(force=false){
  if(!startLatLng || !destLatLng){
    if(routeMode !== 'stroll'){ // stroll は目的地不要
      if(force) speakJa('現在地と目的地を設定してください');
      return;
    }
  }
  await requestRoute();
}

async function requestRoute(){
  try{
    $('modeBadge').textContent = routeMode==='shortest' ? '最短' : routeMode==='easy' ? '楽チン' : 'お散歩AI';
    if(routeMode==='stroll'){
      // 起点から周回：長中短でウェイポイントをつくる
      const [la,ln] = startLatLng || map.getCenter();
      const meter = strollLength==='short' ? 300 : strollLength==='mid' ? 600 : 900; // 半径目安
      // ざっくり3点（北東・南東・西）
      const dLat = (meter/111320);
      const dLng = (meter/(40075000*Math.cos(la*Math.PI/180)))*360;
      const wp1=[la+dLat, ln+dLng];
      const wp2=[la-dLat, ln+dLng*0.6];
      const wp3=[la,     ln-dLng*0.9];
      const routes = await osrmRoute([ [la,ln], wp1, wp2, wp3, [la,ln] ]);
      const best = routes[0];
      let coords = best.geometry.coordinates.map(([x,y])=> ({lat:y,lng:x}));
      coords = stripDeadEndSpurs(coords); // ★ 袋小路スパー除去（要件1）
      const geo = {type:'Feature', geometry:{type:'LineString', coordinates: coords.map(p=>[p.lng,p.lat])}};
      setRoute(geo,null);
      if(isNavigating) speakNextManeuver(); // ★ リルート後に必ず音声（要件2）
      return;
    }

    const routes = await osrmRoute([ startLatLng, destLatLng ]);
    // 最短
    let main = routes[0];
    // 楽チン：ターン数が少なそうなもの（座標間距離が滑らかな=総角度が小さい）を選ぶ
    let easy = null;
    if(routes.length>1){
      const score = r => {
        const pts = r.geometry.coordinates.map(([x,y])=>({lat:y,lng:x}));
        let s=0;
        for(let i=1;i<pts.length-1;i++){ s += _angle(pts[i-1],pts[i],pts[i+1]); }
        return s; // 大きいほど曲がりが緩い
      };
      routes.sort((a,b)=> score(b)-score(a));
      easy = routes[0]; main = routes[1]||routes[0];
    }
    const geo = {type:'Feature', geometry: main.geometry};
    const alt = easy && (easy!==main) ? {type:'Feature', geometry: easy.geometry} : null;
    setRoute(geo, alt);
    if(isNavigating) speakNextManeuver(); // ★ リルート後に必ず音声
  }catch(e){
    console.error(e);
    speakJa('ルートの計算に失敗しました');
  }
}

/* ========= ナビゲーション：開始/停止 ========= */
function resetNavigationState(){
  if(navTimer){ clearInterval(navTimer); navTimer=null; }
}
function startNavigation(){
  if(!routeGeo){ speakJa('ルートがありません'); return; }
  resetNavigationState();
  isNavigating = true;
  speakJa('案内を開始します');
  // 簡易：一定間隔で残距離アナウンス
  navTimer = setInterval(()=>{
    if(!routeGeo) return;
    const coords = routeGeo.geometry.coordinates;
    const dist = estimateDistance(coords); // m
    speakJa(`目的地までおよそ ${Math.max(0,Math.round(dist/50)*50)} メートルです`);
  }, 15000);
  speakNextManeuver();
}
function stopNavigation(){
  resetNavigationState();
  isNavigating = false;
  speakJa('案内を停止しました');
  clearDestination(); // ★ 目的地も空に（要件5）
}
function estimateDistance(coords){
  let d=0;
  for(let i=1;i<coords.length;i++){
    const a=coords[i-1], b=coords[i];
    const dx = (b[0]-a[0])*40075000*Math.cos((a[1])*Math.PI/180)/360;
    const dy = (b[1]-a[1])*111320;
    d+=Math.hypot(dx,dy);
  }
  return d;
}
function speakNextManeuver(){
  // 簡易メッセージ
  if(routeMode==='stroll') speakJa('お散歩ルートでご案内します');
  else speakJa('ルートを更新しました。案内を続けます');
}

/* ========= ボタン動作 ========= */
$('navStart').onclick = async ()=>{
  // ★ どんな状態でも「開始」で必ず開始（要件3）
  await ensureRouteForCurrentMode(true);
  if(routeGeo || routeMode==='stroll'){ startNavigation(); }
};
$('stopNav').onclick = stopNavigation;

// ★ リルートは必ずモードダイアログを出す（要件4）
$('reroute').onclick = ()=> openDialog('reroutePicker');

// ダイアログボタン
$('reroutePicker').querySelectorAll('[data-mode]').forEach(b=>{
  b.onclick = ()=>{
    closeDialog('reroutePicker');
    setModeAndReroute(b.dataset.mode);
  };
});
$('strollPicker').querySelectorAll('[data-len]').forEach(b=>{
  b.onclick = async ()=>{
    strollLength = b.dataset.len;
    closeDialog('strollPicker');
    await requestRoute();
    if(isNavigating) speakNextManeuver();
  };
});

function setModeAndReroute(mode){
  routeMode = mode;
  if(mode==='stroll'){
    openDialog('strollPicker'); // ★ お散歩のみ長/中/短を選ばせる（要件8）
  }else{
    requestRoute().then(()=>{
      if(isNavigating) speakNextManeuver();
    });
  }
  $('modeBadge').textContent = mode==='shortest'?'最短':mode==='easy'?'楽チン':'お散歩AI';
}
$('modeShortest').onclick = ()=> setModeAndReroute('shortest');
$('modeEasy').onclick     = ()=> setModeAndReroute('easy');
$('modeStroll').onclick   = ()=> setModeAndReroute('stroll');

/* ========= 目的地 → ルート反映イベント ========= */
function onRouteReadyHook(){
  // setRoute 内から呼びたい場合の保険を考えていたが
  // 今回は requestRoute 終端で isNavigating を見て音声再開しているので不要
}

/* ========= ルート保持に合わせて setRoute をラップ ========= */
const _setRoute = setRoute;
setRoute = function(geo,alt){ routeGeo = geo; _setRoute(geo,alt); };

/* ========= キーバインド（便利） ========= */
document.addEventListener('keydown', (e)=>{
  if(e.key==='Escape'){ closeDialog('reroutePicker'); closeDialog('strollPicker'); }
  if(e.key==='r'){ $('reroute').click(); }
});

/* ========= 最初の現在地→お散歩用の起点が定まったら軽く案内 ========= */
(async()=>{
  // 少し待ってから現在地が取れていればセンタリング
  await sleep(800);
  if(startLatLng) map.setView(startLatLng, 16);
})();
</script>
</body>
</html>