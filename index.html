<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walk-Nav AI</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
/* (CSSã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥) */
:root{--bg:#0f1a25;--panel:#132235;--panel2:#0f1e30;--text:#eaf2ff;--muted:#9db0c6;--ok:#2ecc71;--primary:#4aa3ff;--danger:#ff6b6b;--accent:#4ac8ff;}.btn-group button.selected{background:var(--accent);color:var(--bg);font-weight:700}.compass{position:absolute;left:10px;top:10px;width:60px;height:60px;z-index:450}#compass-needle{transform-origin:center;transition:transform .5s ease-out;transform:translate(-50%,-90%) rotate(0deg);fill:#ff6b6b}#map{width:100%;height:60vh;border-radius:12px;background:#334}.fab{position:absolute;bottom:20px;z-index:450;display:flex;gap:10px;width:100%;justify-content:center}.fab button{box-shadow:0 8px 20px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1)}body,html{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--text)}main{max-width:800px;margin:0 auto;padding:10px}h1,h2,h3{margin:0 0 10px;padding:0;color:var(--accent);font-weight:400}input,button,select{font-size:16px;padding:10px;border-radius:8px;border:1px solid var(--panel2);background:var(--panel);color:var(--text);margin:2px}button{cursor:pointer}button.primary{background:var(--primary);color:#fff}button.recording{animation:pulse 1.5s infinite}#results{position:fixed;bottom:0;left:0;right:0;background:rgba(15,26,37,.95);backdrop-filter:blur(5px);border-top:1px solid var(--panel2);padding:10px;transform:translateY(100%);transition:transform .3s ease-out;z-index:500;max-height:50vh;overflow-y:auto}#results.show{transform:translateY(0)}#results ul{list-style:none;padding:0;margin:0}#results li{padding:12px;border-bottom:1px solid var(--panel2);cursor:pointer}#results li:hover{background:var(--panel)}#results-list strong{color:var(--accent)}#status{margin-top:8px;color:var(--muted);min-height:1.2em}button.loading{opacity:.7;pointer-events:none}.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}.modal-box{background:var(--panel);padding:20px;border-radius:12px;width:90%;max-width:400px}.modal-box h3{margin-top:0}.modal-box input{width:calc(100% - 24px);margin-bottom:10px}.modal-box .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}#load-list li{display:flex;align-items:center;padding:8px;border-bottom:1px solid var(--panel2)}#load-list li .name{flex-grow:1}#load-list li button{margin-left:5px;padding:5px 8px;font-size:14px}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.7)}70%{box-shadow:0 0 0 10px rgba(255,107,107,0)}100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}
</style>
</head>
<body>

<main>
  <div class="btn-group">
    <button class="lang-btn selected" data-lang="ja">æ—¥æœ¬èª</button>
    <button class="lang-btn" data-lang="en">English</button>
  </div>
  <input id="q" placeholder="æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰">
  <button id="btn-voice">ğŸ¤</button>
  <button id="btn-search" class="primary">æ¤œç´¢</button>
  <button id="btn-clear-history">å±¥æ­´ã‚¯ãƒªã‚¢</button>
  <div id="map"></div>
  <div class="compass"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#132235" stroke="#4aa3ff" stroke-width="2"></circle><polygon id="compass-needle" points="50,10 60,50 50,90 40,50"></polygon><circle cx="50" cy="50" r="5" fill="#4aa3ff"></circle></svg></div>
  <div id="status">æº–å‚™å®Œäº†</div>
  <div class="fab">
    <button id="btn-current">ç¾åœ¨åœ°</button>
    <button id="btn-dest">ç›®çš„åœ°</button>
    <button id="btn-reroute">ãƒªãƒ«ãƒ¼ãƒˆ</button>
  </div>
  <div class="btn-group">
    <button class="mode-btn selected" data-mode="shortest">æœ€çŸ­Ai</button>
    <button class="mode-btn" data-mode="easy">æ¥½ã¡ã‚“Ai</button>
    <button class="mode-btn" data-mode="walkai">ãŠæ•£æ­©Ai</button>
  </div>
  <hr>
  <div>
    é–‹å§‹: <input id="start-lng" placeholder="çµŒåº¦"> <input id="start-lat" placeholder="ç·¯åº¦">
  </div>
  <div>
    çµ‚äº†: <input id="end-lng" placeholder="çµŒåº¦"> <input id="end-lat" placeholder="ç·¯åº¦">
  </div>
  <button id="btn-set-dest">ç›®çš„åœ°ã‚»ãƒƒãƒˆ</button>
  <button id="btn-start" class="primary">æ¡ˆå†…é–‹å§‹</button>
  <button id="btn-stop">æ¡ˆå†…åœæ­¢</button>
  <hr>
  <button id="btn-save" class="primary">ç¾åœ¨åœ°ã‚’ä¿å­˜</button>
  <button id="btn-load">å‘¼ã³å‡ºã—</button>
</main>

<div id="results">
  <button id="btn-close-results" style="float:right">é–‰ã˜ã‚‹</button>
  <h3>æ¤œç´¢çµæœ</h3>
  <ul id="results-list"></ul>
</div>

<div id="save-modal" class="modal">
  <div class="modal-box">
    <h3>åœ°ç‚¹ã®ä¿å­˜</h3>
    <input id="save-name" placeholder="åå‰ (ä¾‹: è‡ªå®…)">
    <div class="actions">
      <button id="btn-cancel-save">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="btn-do-save" class="primary">ä¿å­˜</button>
    </div>
  </div>
</div>

<div id="load-modal" class="modal">
  <div class="modal-box">
    <h3>ä¿å­˜ã—ãŸåœ°ç‚¹</h3>
    <ul id="load-list"></ul>
    <div class="actions">
      <button id="btn-close-load">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/***********************
 * è¨­å®š
 ************************/
// (è¨­å®šéƒ¨åˆ†ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const PLACES_SEARCH_URL = `${GMAP_PROXY}/places:searchText`;
const DIRECTIONS_URL      = `${GMAP_PROXY}/maps/api/directions/json`;
let currentLang = 'ja';
let currentMode = 'shortest';
let watchId = null;
let headingDeg = 0;
let userMarker = null;
let destMarker = null;
let routeLayer = null;
let lastResults = [];
let isRecording = false;
const LS_SAVED = 'walknav_saved_locations'; // NEW: ã‚­ãƒ¼åã‚’å¤‰æ›´
const LS_HISTORY = 'walknav_hist';

/***********************
 * åœ°å›³
 ************************/
// (åœ°å›³éƒ¨åˆ†ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap',
  maxZoom: 19
}).addTo(map);
L.control.zoom({ position:'bottomleft' }).addTo(map);

/***********************
 * è¦ç´ 
 ************************/
// (è¦ç´ å–å¾—éƒ¨åˆ†ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const qInput = $('#q');
const statusEl = $('#status');
const resultsEl = $('#results');
const resultsList = $('#results-list');
const btnVoice = $('#btn-voice');
const btnSearch = $('#btn-search');
const btnClearHistory = $('#btn-clear-history');
const btnCurrent = $('#btn-current');
const btnDest = $('#btn-dest');
const btnReroute = $('#btn-reroute');
const startLng = $('#start-lng');
const startLat = $('#start-lat');
const endLng = $('#end-lng');
const endLat = $('#end-lat');
const btnSetDest = $('#btn-set-dest');
const btnStart = $('#btn-start');
const btnStop = $('#btn-stop');
const needle = $('#compass-needle');
// NEW: ä¿å­˜ãƒ»å‘¼ã³å‡ºã—é–¢é€£ã®è¦ç´ 
const btnSave = $('#btn-save');
const btnLoad = $('#btn-load');
const saveModal = $('#save-modal');
const saveNameInput = $('#save-name');
const btnCancelSave = $('#btn-cancel-save');
const btnDoSave = $('#btn-do-save');
const loadModal = $('#load-modal');
const loadList = $('#load-list');
const btnCloseLoad = $('#btn-close-load');

/***********************
 * ãƒ„ãƒ¼ãƒ«
 ************************/
// (ãƒ„ãƒ¼ãƒ«éƒ¨åˆ†ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function setStatus(msg){ statusEl.textContent = msg || ''; }
function asLatLng(lngInput, latInput){
  const lng = parseFloat(lngInput.value);
  const lat = parseFloat(latInput.value);
  if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng];
  return null;
}

/***********************
 * JAVASCRIPT - ã“ã“ã‹ã‚‰ãƒ­ã‚¸ãƒƒã‚¯ã®å¤‰æ›´ãƒ»è¿½åŠ 
 ************************/

// (æ—¢å­˜ã®éŸ³å£°æ¤œç´¢ã€è¨€èªãƒ»ãƒ¢ãƒ¼ãƒ‰è¨­å®šã€ç¾åœ¨åœ°å–å¾—ã€æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ç­‰ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)

/***********************
 * NEW: ä¿å­˜ãƒ»å‘¼ã³å‡ºã—æ©Ÿèƒ½
 ************************/

// --- ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã ---
btnSave.addEventListener('click', async () => {
  try {
    // ä¿å­˜æ™‚ã«ã¯ç¾åœ¨åœ°ã‚’å¼·åˆ¶çš„ã«å–å¾—ã—ã¦åŸºæº–ã«ã™ã‚‹
    setStatus('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...');
    const p = await getCurrentPosition({ enableHighAccuracy: true, timeout: 10000 });
    const { latitude, longitude } = p.coords;
    
    // ç·¯åº¦çµŒåº¦ã‚’ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚»ãƒƒãƒˆ (ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç·¨é›†ä¸å¯)
    saveModal.dataset.lat = latitude;
    saveModal.dataset.lng = longitude;
    saveNameInput.value = ''; // åå‰å…¥åŠ›æ¬„ã¯ã‚¯ãƒªã‚¢
    saveModal.style.display = 'flex';
    saveNameInput.focus();
    setStatus('ä¿å­˜ã™ã‚‹å ´æ‰€ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  } catch(e) {
    setStatus('ä¿å­˜å¤±æ•—ï¼šç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ - ' + e.message);
  }
});

// --- ä¿å­˜å‡¦ç†ã®å®Ÿè¡Œ ---
btnDoSave.addEventListener('click', () => {
  const name = saveNameInput.value.trim();
  if (!name) {
    setStatus('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }
  const lat = parseFloat(saveModal.dataset.lat);
  const lng = parseFloat(saveModal.dataset.lng);
  
  const saved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
  saved.unshift({ name, lat, lng, t: Date.now() });
  localStorage.setItem(LS_SAVED, JSON.stringify(saved.slice(0, 50))); // 50ä»¶ã¾ã§ä¿å­˜
  
  saveModal.style.display = 'none';
  setStatus(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
});

// --- ä¿å­˜ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ---
btnCancelSave.addEventListener('click', () => {
  saveModal.style.display = 'none';
});

// --- å‘¼ã³å‡ºã—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã ---
btnLoad.addEventListener('click', () => {
  renderSavedList();
  loadModal.style.display = 'flex';
});

// --- å‘¼ã³å‡ºã—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ ---
btnCloseLoad.addEventListener('click', () => {
  loadModal.style.display = 'none';
});

// --- ä¿å­˜æ¸ˆã¿ãƒªã‚¹ãƒˆã®æç”» ---
function renderSavedList() {
  const saved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
  loadList.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
  
  if (saved.length === 0) {
    loadList.innerHTML = '<li>ä¿å­˜ã•ã‚ŒãŸåœ°ç‚¹ã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    return;
  }
  
  saved.forEach((item, index) => {
    const li = document.createElement('li');
    
    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = item.name;
    
    const setDestBtn = document.createElement('button');
    setDestBtn.textContent = 'ç›®çš„åœ°ã«è¨­å®š';
    setDestBtn.className = 'primary';
    setDestBtn.addEventListener('click', () => {
      endLat.value = item.lat.toFixed(6);
      endLng.value = item.lng.toFixed(6);
      putDestMarker(item.lat, item.lng, item.name);
      loadModal.style.display = 'none';
      setStatus(`ç›®çš„åœ°ã‚’ã€Œ${item.name}ã€ã«è¨­å®šã—ã¾ã—ãŸ`);
      // è‡ªå‹•ã§ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ã‚’é–‹å§‹
      btnStart.click();
    });
    
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'å‰Šé™¤';
    deleteBtn.className = 'danger';
    deleteBtn.addEventListener('click', () => {
      if (confirm(`ã€Œ${item.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        const currentSaved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
        const updatedSaved = currentSaved.filter((_, i) => i !== index);
        localStorage.setItem(LS_SAVED, JSON.stringify(updatedSaved));
        renderSavedList(); // ãƒªã‚¹ãƒˆã‚’å†æç”»
      }
    });
    
    li.appendChild(nameSpan);
    li.appendChild(setDestBtn);
    li.appendChild(deleteBtn);
    loadList.appendChild(li);
  });
}

// (æ—¢å­˜ã®å„ç¨®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚„åˆæœŸåŒ–é–¢æ•°ã¯å¤‰æ›´ãªã—ã®ãŸã‚çœç•¥)
// ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
function putDestMarker(lat,lng,name){
  if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
  destMarker.setLatLng([lat,lng]).bindPopup(name||'ç›®çš„åœ°').openPopup();
  map.setView([lat,lng], 17);
}
// ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ ...
// åˆæœŸåŒ–æ™‚ã«ä¸€åº¦ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ (ãŸã ã—UIã¯éè¡¨ç¤º)
document.addEventListener('DOMContentLoaded', () => {
    // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†
});
</script>

</body>
</html>
