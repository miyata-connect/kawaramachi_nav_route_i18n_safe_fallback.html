<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>

  <!-- 発行番号 / ISSUE -->
  <meta name="x-issue" content="idx202511011945" />
  <meta name="description" content="WalkNav - 近くを検索 & ルート案内" />

  <style>
    :root{
      --bg:#0b1220;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.9);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --primary:#62b5ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --shadow:0 10px 35px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}

    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* 下側の情報バナー（現在地・診断など） */
    .status-banner{
      position:fixed;
      left:16px; right:16px; bottom:16px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:10px 14px;
      box-shadow:var(--shadow);
      z-index:2500;
      display:flex;align-items:center;gap:12px;
      pointer-events:none; /* 地図操作を邪魔しない */
    }
    .status-banner .bar{
      flex:1;height:6px;border-radius:4px;background:rgba(255,255,255,.12);overflow:hidden
    }
    .status-banner .bar > i{
      display:block;height:100%;width:28%;
      background:linear-gradient(90deg,#23c483,#7bdc8f);
      border-radius:4px;
    }
    .status-banner .loc{font-size:12px;color:var(--muted)}
    .status-banner .score{font-size:13px;white-space:nowrap}

    /* 検索パネル（画面上部に配置だが、ボタンや地図を邪魔しない透明感） */
    .panel{
      position:absolute;left:16px;right:110px;top:16px;
      background:var(--glass-strong);border:1px solid var(--stroke);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px 14px 12px;backdrop-filter:blur(10px);
    }
    .panel h2{margin:0 0 10px;font-size:20px;letter-spacing:.5px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);font-size:14px}
    .chip.active{background:var(--primary);color:#05233a;border-color:transparent}
    .input{
      flex:1;min-width:220px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);outline:none
    }
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;user-select:none
    }
    .btn.primary{background:var(--primary);color:#051a2a;border-color:transparent}
    .btn.danger{background:var(--danger);color:#240808;border-color:transparent}
    .btn:disabled{opacity:.5;pointer-events:none}

    /* 右側のフローティングボタン群（常に表示） */
    .fab-stack{
      position:fixed;right:16px;bottom:96px;display:flex;flex-direction:column;gap:12px;
      z-index:2600;
    }
    .fab{
      min-width:112px; height:56px; display:flex;align-items:center;justify-content:center;
      background:var(--glass-strong); border:1px solid var(--stroke); border-radius:18px;
      color:var(--text); box-shadow:var(--shadow); cursor:pointer; user-select:none;
    }
    .fab:active{transform:translateY(1px)}

    /* ローディング全画面（初期位置取得時のみ） */
    .loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000; color:#fff; font-size:20px; z-index:3000
    }

    /* トースト/エラー抑止（画面に乗せない） */
    .toast, .error-banner{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="地図"></div>

    <!-- 検索パネル（必要最低限。機能は触らずUIのみ） -->
    <section class="panel" id="searchPanel" aria-label="検索パネル">
      <h2>近くを検索（<span id="radiusLabel">10km</span> / 5件）</h2>
      <div class="row" style="margin-bottom:8px">
        <button class="chip active" id="r10">10km</button>
        <button class="chip" id="r20">20km</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="q" class="input" placeholder="店舗名・電話番号・住所・座標など" />
        <button id="btnText" class="btn primary">入力検索</button>
        <button id="btnVoice" class="btn">音声検索</button>
        <button id="btnReset" class="btn danger">リセット</button>
      </div>
      <div class="row" style="font-size:13px;color:var(--muted)">
        現在地：<span id="locLabel">緯度 -- / 経度 --</span>
      </div>
    </section>

    <!-- 右側 FAB 群（表示のみ復活） -->
    <div class="fab-stack" id="fabStack">
      <div class="fab" id="btnLocate">現在地</div>
      <div class="fab" id="btnPause">一時停止</div>
      <div class="fab" id="btnReroute">リルート</div>
    </div>

    <!-- 下側 固定バナー（被らない位置） -->
    <div class="status-banner" id="statusBanner" role="status" aria-live="polite">
      <span class="loc" id="statusLoc">現在地: --,--</span>
      <div class="bar"><i id="barFill"></i></div>
      <span class="score" id="statusScore">診断: 80点</span>
    </div>

    <!-- 初期ローディング（現在地取得完了まで表示） -->
    <div class="loading" id="loading">現在地取得中です。ご迷惑をお掛けします。<br/>現在地表示まで <b>30秒</b> 程度お待ちください。</div>
  </div>

  <script>
    // ====== 発行番号（画面下部バナーにメモ） ======
    const ISSUE_ID = 'idx202511011945';

    // ====== Google Maps 初期化 ======
    let map, userMarker;
    let currentPos = null;

    // AdvancedMarkerElement を使った波紋付き現在地マーカー
    function setUserMarker(lat, lng){
      currentPos = {lat, lng};
      // 波紋 CSS を ShadowRoot で作る
      const pin = document.createElement('div');
      pin.style.width='22px'; pin.style.height='22px'; pin.style.borderRadius='50%';
      pin.style.background='#3aa0ff'; pin.style.boxShadow='0 0 0 6px rgba(98,181,255,.25)';
      pin.style.border='2px solid #fff';

      if(!userMarker){
        userMarker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: {lat,lng},
          content: pin,
          zIndex: 1000
        });
      }else{
        userMarker.position = {lat,lng};
      }
    }

    function initMap(center){
      map = new google.maps.Map(document.getElementById('map'),{
        center,
        zoom: 17,           // 拡大（初期は大きめ）
        mapId: 'DEMO_MAP',  // 任意のID
        gestureHandling:'greedy',
        clickableIcons:true,
        disableDefaultUI:true
      });
    }

    // ====== 現在地の取得（初期値=現在地一択・失敗時は地図非表示のまま） ======
    function acquireLocation(){
      const onOk = (pos)=>{
        const {latitude, longitude} = pos.coords;
        document.getElementById('loading')?.remove(); // ローディングを消す
        if(!map) initMap({lat:latitude, lng:longitude});
        map.setCenter({lat:latitude,lng:longitude});
        setUserMarker(latitude, longitude);

        // ラベル更新
        const s = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
        document.getElementById('locLabel').textContent = `緯度 ${latitude.toFixed(6)} / 経度 ${longitude.toFixed(6)}`;
        document.getElementById('statusLoc').textContent = `現在地: ${s}`;
      };
      const onErr = (_e)=>{
        // 画面へのエラー表示は禁止：コンソールのみに出す
        console.debug('[WalkNav] geolocation error', _e?.message||_e);
        // ローディングは残す（ユーザーの方針に合わせて非表示でも可）
        // ただし地図は最低限表示しておく（現在地不明）
        if(!map) initMap({lat:35.0,lng:135.0}); // 参照用：即座にユーザーの現在地取得で上書きされる
      };
      try{
        navigator.geolocation.getCurrentPosition(onOk,onErr,{enableHighAccuracy:true,timeout:30000,maximumAge:0});
      }catch(e){
        console.debug('[WalkNav] geolocation exception', e);
      }
    }

    // ====== UI（最小限。機能本体は触らない） ======
    function bindUI(){
      const radiusLabel = document.getElementById('radiusLabel');
      const r10 = document.getElementById('r10');
      const r20 = document.getElementById('r20');
      r10.onclick = ()=>{ r10.classList.add('active'); r20.classList.remove('active'); radiusLabel.textContent='10km'; };
      r20.onclick = ()=>{ r20.classList.add('active'); r10.classList.remove('active'); radiusLabel.textContent='20km'; };

      // 右サイド FAB は見た目のみ
      document.getElementById('btnLocate').onclick = ()=>{
        if(currentPos && map) map.panTo(currentPos);
      };
      document.getElementById('btnPause').onclick = ()=>{ /* 仕様維持：動作は本体側 */ };
      document.getElementById('btnReroute').onclick = ()=>{ /* 仕様維持：動作は本体側 */ };

      // 検索ボタンはコールのみ（本体のハンドラが存在する前提／無ければ何もしない）
      const safeCall = (name)=>{ try{ if(typeof window[name]==='function') window[name](); }catch{} };
      document.getElementById('btnText').onclick  = ()=>safeCall('handleTextSearch');
      document.getElementById('btnVoice').onclick = ()=>safeCall('handleVoiceSearch');
      document.getElementById('btnReset').onclick = ()=>safeCall('handleReset');

      // 下バナーの簡易アニメ（診断バーの進捗っぽく）
      const fill = document.getElementById('barFill');
      let p = 0; setInterval(()=>{ p=(p+4)%96; fill.style.width = (28 + p/4)+'%'; }, 800);
    }

    // ====== 起動 ======
    (function start(){
      // UIは日本語を初期値（強制）
      document.documentElement.lang = 'ja';
      bindUI();
      acquireLocation();
      console.debug('[WalkNav] ISSUE', ISSUE_ID, 'boot');
    })();
  </script>

  <!-- Google Maps JS API（AdvancedMarkerElement 利用） -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk&v=weekly&libraries=marker"
    async defer></script>
</body>
</html>
