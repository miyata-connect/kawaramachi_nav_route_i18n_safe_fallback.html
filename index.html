<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalkNav v5</title>
  <style>
:root{
  --glass: rgba(20,28,44,.78);
  --glass-strong: rgba(16,22,36,.9);
  --stroke: rgba(255,255,255,.16);
  --text:#eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0}

/* Top banners */
#guideBar, #incidentBar, #weatherBar{
  position:absolute; left:50%; transform:translateX(-50%);
  top:8px; z-index:6; display:flex; align-items:center; gap:8px;
  background:var(--glass); border:1px solid var(--stroke); border-radius:16px; padding:10px 14px;
  backdrop-filter: blur(10px);
}
#incidentBar{ top:56px; }
#weatherBar{ top:104px; white-space:nowrap; }

/* Control panel */
.control-panel{
  position:absolute; left:12px; right:12px; top:152px; z-index:5;
  background:var(--glass); border:1px solid var(--stroke); border-radius:20px; padding:14px;
  backdrop-filter: blur(10px);
}
.row{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
.full{flex:1 1 100%}
.input{
  width:100%; padding:14px 16px; border-radius:12px; border:1px solid var(--stroke);
  background:rgba(255,255,255,.06); color:var(--text); outline:none;
}
.chips{display:flex; gap:8px; margin-left:auto}
.chip{
  padding:8px 14px; border-radius:24px; border:1px solid var(--stroke);
  background:rgba(255,255,255,.1); cursor:pointer; user-select:none;
}
.chip.active{background:var(--primary); color:#001527; border-color:transparent}

/* options */
.opt{display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:16px; border:1px solid var(--stroke); background:rgba(255,255,255,.05)}
.opt input{width:18px;height:18px}

/* buttons */
.btn{
  padding:12px 18px; border-radius:16px; border:1px solid var(--stroke);
  background:rgba(255,255,255,.1); color:var(--text); cursor:pointer; user-select:none;
}
.btn.primary{background:var(--primary); color:#001527; border-color:transparent}
.btn.danger{background:rgba(255,0,0,.14); border-color:rgba(255,0,0,.25)}
.btn.ghost{background:rgba(255,255,255,.06)}
.btn-block{width:100%}

/* right side buttons */
.side{
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  display:flex; flex-direction:column; gap:12px; z-index:4;
}
.side .btn{width:96px; text-align:center; background:var(--glass);}

/* bottom toast */
.toast{
  position:absolute; left:50%; transform:translateX(-50%); bottom:18px; z-index:7;
  background:rgba(255,90,90,.96); color:#fff; border-radius:14px; padding:12px 16px; box-shadow:0 8px 30px rgba(0,0,0,.35);
}

/* pulsating current marker */
.pulse{
  position:absolute; width:16px; height:16px; border-radius:50%; background:#ff3b3b; box-shadow:0 0 0 rgba(255,59,59,.6);
  animation:pulse 2s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 0 0 rgba(255,59,59,.6)}
  70%{box-shadow:0 0 0 18px rgba(255,59,59,0)}
  100%{box-shadow:0 0 0 0 rgba(255,59,59,0)}
}

/* overlay during geoloc */
#blackout{
  position:absolute; inset:0; background:#000; z-index:10; display:none; align-items:center; justify-content:center;
}
#blackout .msg{
  background:rgba(255,255,255,.08); color:#fff; border:1px solid rgba(255,255,255,.18);
  padding:14px 18px; border-radius:14px;
}

/* hide panel while routing or results */
.hidden{display:none !important}
  </style>
</head>
<body>
<div class="app">
  <div id="map"></div>

  <!-- Top bars -->
  <div id="guideBar" class="hidden">案内：—</div>
  <div id="incidentBar" class="hidden">インシデント：—</div>
  <div id="weatherBar" class="hidden">現在→3時間後→6時間後→明日：—</div>

  <!-- Control Panel -->
  <div id="panel" class="control-panel">
    <div class="row" style="align-items:center;">
      <div style="font-weight:700; font-size:20px;">近くを検索</div>
      <div class="chips" id="kmChips">
        <div class="chip active" data-km="10">10km</div>
        <div class="chip" data-km="20">20km</div>
        <div class="chip" data-km="30">30km</div>
      </div>
    </div>

    <div class="row full">
      <input id="q" class="input" placeholder="店舗名・電話番号・カテゴリ・住所・座標・施設名" />
    </div>

    <div class="row">
      <label class="opt"><input id="usePick" type="checkbox" /> 任意の場所を検索</label>
      <label class="opt"><input id="openNow" type="checkbox" /> 現在営業中</label>
      <label class="opt"><input id="byRating" type="checkbox" /> レビュー順</label>
    </div>

    <div class="row">
      <button id="voiceBtn" class="btn ghost">音声案内</button>
      <button id="searchBtn" class="btn primary">入力検索</button>
      <button id="resetBtn" class="btn danger">リセット</button>
    </div>

    <div class="row">
      <button id="saveHere" class="btn ghost btn-block">現在地点登録</button>
      <button id="editSaved" class="btn ghost btn-block">登録地点修正</button>
    </div>

    <div class="row" style="opacity:.9; font-size:14px;">
      <div id="coord">現在地： 緯度:— / 経度:—</div>
    </div>
  </div>

  <!-- Right side buttons -->
  <div class="side">
    <button id="btnHere" class="btn">現在地</button>
    <button id="btnPause" class="btn">一時停止</button>
    <button id="btnReroute" class="btn">リルート</button>
  </div>

  <!-- blackout while locating -->
  <div id="blackout"><div class="msg">現在地取得中です。ご迷惑をお掛けします。現在地表示まで30秒程お待ちください。</div></div>

  <div id="toast" class="toast hidden"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_BROWSER_API_KEY&libraries=geometry&v=weekly" defer></script>
<script>
(() => {
  "use strict";

  const WORKER = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";
  const mapEl = document.getElementById("map");
  const panel = document.getElementById("panel");
  const toastEl = document.getElementById("toast");
  const guideBar = document.getElementById("guideBar");
  const incidentBar = document.getElementById("incidentBar");
  const weatherBar = document.getElementById("weatherBar");
  const blackout = document.getElementById("blackout");

  let map, meMarker, pickMarker, routePoly, watchId=null, km=10, center, routing=false;

  // UI refs
  const q = document.getElementById("q");
  const kmChips = document.getElementById("kmChips");
  const usePick = document.getElementById("usePick");
  const openNow = document.getElementById("openNow");
  const byRating = document.getElementById("byRating");
  const searchBtn = document.getElementById("searchBtn");
  const resetBtn = document.getElementById("resetBtn");
  const voiceBtn = document.getElementById("voiceBtn");
  const saveHere = document.getElementById("saveHere");
  const editSaved = document.getElementById("editSaved");
  const coord = document.getElementById("coord");
  const btnHere = document.getElementById("btnHere");
  const btnPause = document.getElementById("btnPause");
  const btnReroute = document.getElementById("btnReroute");

  window.initMap = () => {}; // not used; defer script

  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.remove("hidden");
    clearTimeout(showToast.t);
    showToast.t = setTimeout(()=>toastEl.classList.add("hidden"), 4000);
  }

  function showPanel(flag) {
    if (flag) panel.classList.remove("hidden"); else panel.classList.add("hidden");
  }
  function showGuide(text){ guideBar.textContent = "案内：" + text; guideBar.classList.remove("hidden"); }
  function hideGuide(){ guideBar.classList.add("hidden"); }
  function showIncident(text){ incidentBar.textContent = "インシデント：" + text; incidentBar.classList.remove("hidden"); }
  function hideIncident(){ incidentBar.classList.add("hidden"); }
  function showWeather(text){ weatherBar.textContent = text; weatherBar.classList.remove("hidden"); }
  function hideWeather(){ weatherBar.classList.add("hidden"); }

  function init() {
    map = new google.maps.Map(mapEl, {
      center: {lat:35.681236, lng:139.767125},
      zoom: 16,
      tilt: 0,
      heading: 0,
      clickableIcons: true,
      mapId: ""
    });

    // Pulsating marker for current position
    meMarker = new google.maps.Marker({
      map, position: map.getCenter(), zIndex: 5,
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 6,
        fillColor: "#ff3b3b", fillOpacity: 1,
        strokeColor: "#ffffff", strokeWeight: 2
      }
    });

    // route polyline
    routePoly = new google.maps.Polyline({
      map, strokeColor: "#5fb1ff", strokeOpacity: 0.9, strokeWeight: 6
    });

    // km chips
    kmChips.querySelectorAll(".chip").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        kmChips.querySelectorAll(".chip").forEach(c=>c.classList.remove("active"));
        ch.classList.add("active");
        km = Number(ch.dataset.km);
        updatePanelTitle();
      });
    });
    updatePanelTitle();

    // long-press logic for pick
    let pressTimer=null;
    map.addListener("mousedown", e=>startPress(e.latLng));
    map.addListener("mouseup", cancelPress);
    map.addListener("touchstart", e=>{
      const latLng = e.latLng || (e.touches && e.touches.length? map.getProjection().fromPointToLatLng(e.touches[0]) : null);
      startPress(latLng);
    });
    map.addListener("touchend", cancelPress);

    function startPress(latLng){
      if(!usePick.checked) return;
      if(!latLng) return;
      pressTimer = setTimeout(()=>{
        setPick(latLng);
        showToast("ポイント確定");
      }, 450);
    }
    function cancelPress(){ clearTimeout(pressTimer); }

    // buttons
    searchBtn.addEventListener("click", doSearch);
    resetBtn.addEventListener("click", resetAll);
    voiceBtn.addEventListener("click", ()=>showToast("音声入力は端末の音声認識に接続予定"));
    btnHere.addEventListener("click", centerOnMe);
    btnPause.addEventListener("click", ()=>showToast("案内を一時停止しました"));
    btnReroute.addEventListener("click", ()=>{ if (routing) { showToast("リルート中…"); /* re-calc here */ }});
    saveHere.addEventListener("click", ()=>showToast("現在地点を登録しました"));
    editSaved.addEventListener("click", ()=>showToast("登録地点の修正/消去UIは準備中"));

    // Geolocate with up to 30s overlay
    startGeolocate();
  }

  function updatePanelTitle(){
    const title = panel.querySelector(".row:first-child div");
    title.textContent = `近くを検索（${km}km / 5件）`;
  }

  function setPick(latLng){
    if (!pickMarker) pickMarker = new google.maps.Marker({map, draggable:true, zIndex:5});
    pickMarker.setPosition(latLng);
    center = { lat: latLng.lat(), lng: latLng.lng() };
    map.panTo(center);
  }

  function centerOnMe(){
    if(center) map.panTo(center);
  }

  function startGeolocate(){
    blackout.style.display = "flex";
    let done=false;
    const timeout = setTimeout(()=>{
      if(!done){
        blackout.style.display = "none";
        showToast("現在地を取得出来ませんでした。屋外に出られるか、なるべく空が開けた場所へ移動してください。");
      }
    }, 30000);

    if(navigator.geolocation){
      watchId = navigator.geolocation.watchPosition(
        pos=>{
          done=true; blackout.style.display = "none";
          const {latitude, longitude} = pos.coords;
          center = {lat:latitude, lng:longitude};
          map.setCenter(center);
          meMarker.setPosition(center);
          coord.textContent = `現在地： 緯度:${latitude.toFixed(6)} / 経度:${longitude.toFixed(6)}`;
          // refresh weather/incidents when we first get a position
          fetchWeather();
          fetchIncidents();
        },
        err=>{
          console.warn(err);
        },
        {enableHighAccuracy:true, maximumAge:0, timeout:10000}
      );
    }else{
      clearTimeout(timeout);
      blackout.style.display = "none";
    }
  }

  async function doSearch(){
    try{
      if(!center){ showToast("現在地未取得です"); return; }
      const text = q.value.trim();
      if(!text && !usePick.checked){
        showToast("検索したい文字を入力してください。");
        return;
      }
      const body = {
        textQuery: text || "",
        languageCode: "ja",
        regionCode: "JP",
        pageSize: 5
      };

      // bias or restriction by km
      const rMeters = km * 1000;
      if(usePick.checked && pickMarker){
        const p = pickMarker.getPosition();
        body.locationBias = {
          circle:{
            center:{ latitude: p.lat(), longitude: p.lng() },
            radius: rMeters
          }
        };
      }else{
        body.locationBias = {
          circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius: rMeters }
        };
      }

      if(openNow.checked){
        // filter on client after get (Places New has open status in result)
      }

      showPanel(false); // hide while showing results/route
      const res = await fetch(WORKER + "/places:searchText", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify(body)
      });
      if(!res.ok){
        showPanel(true);
        showToast("検索エラー：HTTP " + res.status);
        return;
      }
      const data = await res.json();
      if(!data.places || !data.places.length){
        showPanel(true);
        showToast("該当なし");
        return;
      }

      // sort by rating if needed
      let places = data.places;
      if(byRating.checked){
        places = [...places].sort((a,b)=>(b.rating||0)-(a.rating||0));
      }

      // pick first result and start route (demo)
      const first = places[0];
      const dest = {lat: first.location.latitude, lng: first.location.longitude};
      startRoute(center, dest);
      showGuide(`目的地：${first.displayName?.text || "不明"} / ${first.formattedAddress || ""}`);
    }catch(e){
      console.error(e);
      showPanel(true);
      showToast("検索エラー");
    }
  }

  function resetAll(){
    showPanel(true);
    hideGuide();
    routePoly.setPath([]);
  }

  function startRoute(src, dst){
    routing = true;
    // simple polyline (client demo). Real app should call Directions API via Worker.
    routePoly.setPath([src, dst]);
    map.fitBounds(new google.maps.LatLngBounds().extend(src).extend(dst), 80);
  }

  async function fetchWeather(){
    try{
      if(!center) return;
      const u = new URL(WORKER + "/weather");
      u.searchParams.set("lat", center.lat);
      u.searchParams.set("lng", center.lng);
      const res = await fetch(u, {method:"GET"});
      if(!res.ok) return;
      const w = await res.json();

      const curT = (w.current_weather?.temperature ?? "-") + "°";
      // find +3h, +6h
      const nowIso = w.current_weather?.time;
      const idx = w.hourly?.time?.indexOf?.(nowIso) ?? -1;
      const t3 = idx>=0 ? (w.hourly.temperature_2m[idx+3] ?? "-") + "°" : "-";
      const t6 = idx>=0 ? (w.hourly.temperature_2m[idx+6] ?? "-") + "°" : "-";
      const p3 = idx>=0 ? (w.hourly.precipitation_probability[idx+3] ?? "-") + "%" : "-";
      const p6 = idx>=0 ? (w.hourly.precipitation_probability[idx+6] ?? "-") + "%" : "-";
      const tmrMax = w.daily?.temperature_2m_max?.[0];
      const tmrMin = w.daily?.temperature_2m_min?.[0];
      const pTmr = w.daily?.precipitation_probability_max?.[0];
      const tmr = (tmrMin!=null && tmrMax!=null) ? `${tmrMin}°/${tmrMax}°` : "-";
      const txt = `現在 ${curT}・降水${w.hourly?.precipitation_probability?.[idx] ?? "-"}% → 3時間後 ${t3}・${p3} → 6時間後 ${t6}・${p6} → 明日 ${tmr}・${pTmr ?? "-"}%`;
      showWeather(txt);
    }catch(e){/*ignore*/}
  }

  async function fetchIncidents(){
    try{
      if(!center) return;
      const u = new URL(WORKER + "/incidents");
      u.searchParams.set("lat", center.lat);
      u.searchParams.set("lng", center.lng);
      u.searchParams.set("radius", km*1000);
      const res = await fetch(u);
      if(!res.ok) return;
      const d = await res.json();
      const count = d.items?.length || 0;
      showIncident(count ? `半径${km}kmで${count}件` : "半径内の歩行者向けインシデントはありません");
    }catch(e){/*ignore*/}
  }

  // start
  window.addEventListener("load", init);
})();
</script>
</body>
</html>