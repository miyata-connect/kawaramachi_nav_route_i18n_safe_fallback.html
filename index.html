<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>WALK NAV</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{ --bg:rgba(255,255,255,.96); --shadow:0 10px 25px rgba(0,0,0,.15); --r:14px; }
  html,body{height:100%;margin:0}
  #map{position:fixed;inset:0}

  /* â”€â”€ ä¸Šéƒ¨UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #panel{
    position:fixed;left:max(8px,env(safe-area-inset-left));right:max(8px,env(safe-area-inset-right));
    top:calc(8px + env(safe-area-inset-top));z-index:1000;
    background:var(--bg);backdrop-filter:blur(6px);border-radius:var(--r);box-shadow:var(--shadow);
    padding:8px;display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;
  }
  #q{width:100%;height:44px;border:1px solid #cbd5e1;border-radius:12px;padding:0 12px;font-size:16px}
  .btn,select{
    height:44px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:15px;
    padding:0 12px;display:inline-flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;
  }
  #mic{width:44px;padding:0}
  #lang{width:116px}
  @media (max-width:460px){ #lang{grid-column:1 / -1} }

  /* â”€â”€ å³å´å›ºå®šãƒœã‚¿ãƒ³ï¼ˆã‚ºãƒ¼ãƒ ã¨è¢«ã‚‰ãªã„ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .fixed-controls{
    position:fixed;right:max(10px,env(safe-area-inset-right));
    top:calc(66px + env(safe-area-inset-top));display:flex;flex-direction:column;gap:8px;z-index:999;
  }
  .fixed-controls .btn{box-shadow:var(--shadow);}

  /* æ¤œç´¢çµæœ / ãƒˆãƒ¼ã‚¹ãƒˆ */
  #results{position:fixed;left:max(8px,env(safe-area-inset-left));right:max(8px,env(safe-area-inset-right));
    top:calc(64px + env(safe-area-inset-top));z-index:999;background:var(--bg);border-radius:12px;box-shadow:var(--shadow);display:none;overflow:hidden}
  #results ul{list-style:none;margin:0;padding:0}
  #results li{padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;gap:8px}
  #results li:first-child{border-top:none}
  #results small{color:#6b7280}
  #toast{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(12px + env(safe-area-inset-bottom));
    background:var(--bg);border-radius:12px;box-shadow:var(--shadow);padding:8px 12px;z-index:1000;font-size:14px;display:none;max-width:92vw}

  /* é€²è¡Œæ–¹å‘ãƒ”ãƒ³ */
  .heading-pin{width:24px;height:24px;border-radius:50%;background:#2563eb;border:3px solid #fff;box-shadow:0 0 0 2px rgba(37,99,235,.35);position:relative}
  .heading-pin::after{content:"";position:absolute;left:50%;top:-12px;transform:translateX(-50%);
    width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #2563eb;
    filter:drop-shadow(0 1px 1px rgba(0,0,0,.4))}
  .route-shadow{filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}

  /* â”€â”€ ã‚¿ãƒ¼ãƒ³ç›´å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆæ‹¡å¤§çŸ¢å°ï¼‹è·é›¢ï¼‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #turnPrompt{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(96px + env(safe-area-inset-bottom));
    background:rgba(255,255,255,.98);border-radius:18px;box-shadow:var(--shadow);
    padding:10px 14px;display:none;align-items:center;gap:12px;z-index:1200;
  }
  #turnPrompt .meter{font-size:22px;font-weight:700;min-width:84px;text-align:right}
  #turnPrompt .label{font-size:12px;color:#6b7280;margin-left:-8px}
  .arrow{
    width:64px;height:64px;display:grid;place-items:center;border-radius:14px;background:#fef3c7;border:2px solid #f59e0b;
    box-shadow:0 6px 16px rgba(0,0,0,.12);
  }
  .arrow svg{width:46px;height:46px}
  .arrow .left{fill:#d97706}
  .arrow .right{fill:#d97706; transform: scaleX(-1); transform-origin:center}
</style>
</head>
<body>
  <div id="map" aria-label="åœ°å›³"></div>

  <div id="panel" role="group" aria-label="æ¤œç´¢">
    <input id="q" placeholder="åº—åãƒ»ä½æ‰€ãƒ»é›»è©±ï¼ˆä¾‹: ãƒ­ãƒ¼ã‚½ãƒ³ / 087-xxx-xxxxï¼‰">
    <button id="mic" class="btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
    <button id="search" class="btn" title="æ¤œç´¢">æ¤œç´¢</button>
    <select id="lang" title="è¨€èª">
      <option value="ja-JP" selected>æ—¥æœ¬èª</option>
      <option value="en-US">English</option>
      <option value="ko-KR">í•œêµ­ì–´</option>
      <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
      <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
    </select>
  </div>

  <div class="fixed-controls">
    <button id="locate" class="btn">ğŸ“ ç¾åœ¨åœ°</button>
    <button id="follow" class="btn" aria-pressed="true">ğŸ§­ è¿½å¾“ON</button>
  </div>

  <div id="results" role="listbox" aria-label="æ¤œç´¢çµæœ"><ul></ul></div>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ã‚¿ãƒ¼ãƒ³ç›´å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
  <div id="turnPrompt" aria-live="assertive">
    <div class="arrow" id="turnArrow" aria-hidden="true">
      <!-- å·¦çŸ¢å°SVGï¼ˆå³ã¯å·¦å³åè»¢ï¼‰ -->
      <svg viewBox="0 0 256 256" id="arrowSvg">
        <path class="left" d="M240 160h-92.7l28.7 49.7c4.2 7.3 1.7 16.7-5.6 20.9s-16.7 1.7-20.9-5.6L93.9 156.7c-3.4-5.9-3.4-13.2 0-19.1L149.5 30c4.2-7.3 13.6-9.9 20.9-5.6s9.9 13.6 5.6 20.9L147.3 96H240c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16z"/>
      </svg>
    </div>
    <div>
      <div class="meter"><span id="turnRemain">3</span> m</div>
      <div class="label" id="turnType">æ›²ãŒã‚‹</div>
    </div>
  </div>

<script>
(function(){
  const REROUTE_M = 3;          // â˜… 3m ã§è‡ªå‹•ãƒªãƒ«ãƒ¼ãƒˆ
  const TURN_ALERT_M = 3;       // â˜… æ›²ãŒã‚Šè§’ 3m æ‰‹å‰ã§è¡¨ç¤º

  const map=L.map('map',{zoomControl:true,attributionControl:true}).setView([34.342,134.046],16);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);

  const $=s=>document.querySelector(s);
  const qEl=$('#q'),micEl=$('#mic'),searchEl=$('#search'),langEl=$('#lang');
  const locateEl=$('#locate'),followEl=$('#follow');
  const resultsEl=$('#results'),resultsUL=resultsEl.querySelector('ul'),toastEl=$('#toast');
  const turnEl=$('#turnPrompt'),turnRemainEl=$('#turnRemain'),turnTypeEl=$('#turnType'),arrowSvg=$('#arrowSvg');

  // â† å¿…è¦ãªã‚‰è‡ªåˆ†ã® Worker URL ã«å¤‰æ›´
  const ORS_PROXY='https://ors-proxy.miyata-connect-jp.workers.dev/proxy';

  function toast(m,ms=2000){ toastEl.textContent=m; toastEl.style.display='block'; clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display='none',ms); }

  // ç¾åœ¨åœ°ãƒ»heading
  let meLatLng=null, meMarker=null, headingDeg=null, follow=true;
  const MeIcon=L.divIcon({className:'',html:'<div class="heading-pin"></div>',iconSize:[24,24],iconAnchor:[12,12]});
  function setMeMarker(latlng){
    if(!meMarker){ meMarker=L.marker(latlng,{icon:MeIcon,zIndexOffset:1000}).addTo(map); }
    else{ meMarker.setLatLng(latlng); }
    rotateHeading();
  }
  function rotateHeading(){
    if(!meMarker) return;
    const container=meMarker.getElement();
    if(!container) return;
    const inner=container.querySelector('.heading-pin');
    if(!inner) return;
    const deg=(headingDeg==null)?0:headingDeg;
    inner.style.transform=`rotate(${deg}deg)`;
  }
  function bearing(from,to){
    const Ï†1=from.lat*Math.PI/180,Ï†2=to.lat*Math.PI/180,Î»1=from.lng*Math.PI/180,Î»2=to.lng*Math.PI/180;
    const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
  }

  if(navigator.geolocation){
    navigator.geolocation.watchPosition(p=>{
      meLatLng=L.latLng(p.coords.latitude,p.coords.longitude);
      if(typeof p.coords.heading==='number' && !isNaN(p.coords.heading)) headingDeg=p.coords.heading;
      setMeMarker(meLatLng);
      if(follow) map.panTo(meLatLng,{animate:true,duration:.4});
      maybeRerouteOnMove();            // â˜… ä½ç½®æ›´æ–°ã§åˆ¤å®š
      maybeShowTurnAlert();            // â˜… æ›²ãŒã‚Šè§’ã®æ‰‹å‰è¡¨ç¤º
    },err=>console.warn(err),{enableHighAccuracy:true,maximumAge:2000,timeout:10000});
  }
  locateEl.addEventListener('click',()=>{ if(meLatLng) map.flyTo(meLatLng,18,{duration:.6}); else toast('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦'); });
  followEl.addEventListener('click',()=>{ follow=!follow; followEl.setAttribute('aria-pressed',String(follow)); followEl.textContent= follow?'ğŸ§­ è¿½å¾“ON':'ğŸ§­ è¿½å¾“OFF'; if(follow&&meLatLng) map.panTo(meLatLng); });

  // éŸ³å£°å…¥åŠ›ï¼ˆé¸æŠè¨€èªã§ï¼‰
  let recog=null;
  micEl.addEventListener('click',()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«æœªå¯¾å¿œ'); return; }
    if(!recog){
      recog=new SR(); recog.interimResults=false; recog.maxAlternatives=1;
      recog.addEventListener('result',e=>{ const t=e.results[0][0].transcript.trim(); qEl.value=t; doSearch(); });
      recog.addEventListener('error',e=>toast('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: '+e.error));
    }
    try{ recog.lang=langEl.value||'ja-JP'; recog.start(); }catch(_){}
  });

  // è¿‘è·é›¢ ä¸Šä½5ä»¶
  async function geocodeTop5(term,centerLatLng,langTag){
    const lat=centerLatLng.lat,lon=centerLatLng.lng;
    const R=800,dLat=R/111320,dLon=R/(111320*Math.cos(lat*Math.PI/180));
    const url=new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2'); url.searchParams.set('q',term);
    url.searchParams.set('limit','20'); url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language',langTag||'ja-JP');
    url.searchParams.set('viewbox',`${lon-dLon},${lat+dLat},${lon+dLon},${lat-dLat}`);
    url.searchParams.set('bounded','1');
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const arr=await res.json();

    // ç°¡æ˜“é›»è©±æ¤œç´¢ï¼ˆå‘¨è¾ºï¼‰
    const digits=term.replace(/[^\d]/g,''); let overpassArr=[];
    if(digits.length>=7){
      try{
        const q=`
          [out:json][timeout:25];
          (
            node(around:${R},${lat},${lon})["phone"~"${digits}"];
            node(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            way(around:${R},${lat},${lon})["phone"~"${digits}"];
            way(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
          ); out center 30;
        `;
        const r=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},body:new URLSearchParams({data:q})});
        const j=await r.json();
        overpassArr=(j.elements||[]).map(el=>{
          const y=el.lat||el.center?.lat,x=el.lon||el.center?.lon; if(!y||!x) return null;
          return {lat:y,lon:x,display_name:el.tags?.name||el.tags?.brand||'ç›®çš„åœ°(é›»è©±)',via:'overpass'};
        }).filter(Boolean);
      }catch(e){ console.warn('overpass',e); }
    }

    const center=L.latLng(lat,lon);
    const merged=[...arr.map(a=>({lat:parseFloat(a.lat),lon:parseFloat(a.lon),display_name:a.display_name,via:'nominatim'})),...overpassArr];
    const uniq=new Map();
    merged.forEach(p=>{ const key=p.lat.toFixed(6)+','+p.lon.toFixed(6); if(!uniq.has(key)) uniq.set(key,p); });
    return [...uniq.values()].map(p=>{p._d=map.distance(center,[p.lat,p.lon]);return p;})
             .sort((a,b)=>a._d-b._d).slice(0,5);
  }

  // ORS ãƒ«ãƒ¼ãƒˆï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã‚‚å–å¾—ï¼‰
  let dstMarker=null,routeLine=null,routeShadow=null,lastRouteTo=null,lastRouteAt=0;
  let steps=[];               // {latlng, instruction, distance}
  async function routeWalk(from,to,langTag){
    const body={coordinates:[[from.lng,from.lat],[to.lng,to.lat]],instructions:true,language:langTag||'ja-JP'};
    const url=`${ORS_PROXY}?profile=foot-walking&format=geojson`;
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('ORSã‚¨ãƒ©ãƒ¼ '+r.status);
    const geo=await r.json(); const feat=geo.features?.[0]; if(!feat) throw new Error('ãƒ«ãƒ¼ãƒˆãªã—');
    const latlngs=feat.geometry.coordinates.map(([x,y])=>L.latLng(y,x));
    // ã‚¹ãƒ†ãƒƒãƒ—å–ã‚Šå‡ºã—ï¼ˆway_points ã®å¾Œå´ã‚’æ›²ãŒã‚Šä½ç½®ã¨ã—ã¦æ¡ç”¨ï¼‰
    steps=[];
    try{
      const rawSteps=(feat.properties?.segments?.[0]?.steps)||[];
      rawSteps.forEach(s=>{
        const idx=s.way_points?.[1] ?? 0;
        const ll=latlngs[Math.min(Math.max(idx,0),latlngs.length-1)];
        steps.push({latlng:ll,instruction:s.instruction||"",distance:s.distance||0, type:s.type||""});
      });
    }catch(_){}
    const sum=feat.properties?.summary||{}; return {latlngs,dist:sum.distance||0,dur:sum.duration||0};
  }
  function drawRoute(latlngs){
    if(routeLine){ map.removeLayer(routeLine); map.removeLayer(routeShadow); }
    routeShadow=L.polyline(latlngs,{color:'#000',weight:8,opacity:.25,className:'route-shadow'}).addTo(map);
    routeLine=L.polyline(latlngs,{color:'#2563eb',weight:5,opacity:.95}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[80,40]});
  }

  // ãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®è·é›¢ï¼ˆmï¼‰
  function distanceToPolylineMeters(latlng,latlngs){
    if(!latlngs||latlngs.length<2) return Infinity;
    const p=map.latLngToLayerPoint(latlng); let min=Infinity;
    for(let i=1;i<latlngs.length;i++){
      const p1=map.latLngToLayerPoint(latlngs[i-1]),p2=map.latLngToLayerPoint(latlngs[i]);
      const d=L.LineUtil.pointToSegmentDistance(p,p1,p2); if(d<min) min=d;
    }
    const mPerPx=map.distance(map.layerPointToLatLng([0,0]),map.layerPointToLatLng([1,0]));
    return min*mPerPx;
  }

  async function maybeRerouteOnMove(){
    if(!routeLine||!meLatLng||!lastRouteTo) return;
    const off=distanceToPolylineMeters(meLatLng,routeLine.getLatLngs());
    const t=Date.now();
    if(off>REROUTE_M || (t-lastRouteAt)>20000){
      try{
        const r=await routeWalk(meLatLng,lastRouteTo,langEl.value);
        drawRoute(r.latlngs); lastRouteAt=Date.now();
        if(r.latlngs.length>1 && (headingDeg==null)){ headingDeg=bearing(meLatLng,r.latlngs[1]); rotateHeading(); }
      }catch(e){ console.warn('reroute',e); }
    }
  }

  // â”€â”€ æ›²ãŒã‚Šè§’ 3m æ‰‹å‰ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let shownStepIndex=-1;
  function decideLR(text,type){
    const t=(text||'').toLowerCase();
    if(t.includes('left')) return 'left';
    if(t.includes('right')) return 'right';
    // type ãŒã‚ã‚Œã°è¶…ç°¡æ˜“åˆ¤å®š
    if((type||'').toString().includes('left')) return 'left';
    if((type||'').toString().includes('right')) return 'right';
    return 'left'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå·¦
  }
  function showTurn(dir,remain,raw){
    // çŸ¢å°æ–¹å‘åˆ‡æ›¿ï¼ˆå³ã¯ SVG ã‚’å·¦å³åè»¢ï¼‰
    if(dir==='right'){ arrowSvg.style.transform='scaleX(-1)'; }
    else{ arrowSvg.style.transform=''; }
    turnRemainEl.textContent=Math.max(0,Math.round(remain));
    turnTypeEl.textContent= raw || (dir==='left'?'å·¦ã«æ›²ãŒã‚‹':'å³ã«æ›²ãŒã‚‹');
    turnEl.style.display='flex';
    clearTimeout(turnEl._hide); turnEl._hide=setTimeout(()=>turnEl.style.display='none',1800);
  }
  function maybeShowTurnAlert(){
    if(!meLatLng || !steps.length) return;
    // æ¬¡ã«è¿‘ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ¢ã™ï¼ˆå‰å›ã‚ˆã‚Šå¾Œã‚å„ªå…ˆï¼‰
    let idxStart=Math.max(shownStepIndex,0), target=-1, min=1e9, dist=0;
    for(let i=idxStart;i<steps.length;i++){
      const d=map.distance(meLatLng,steps[i].latlng);
      if(d<min){ min=d; target=i; }
      if(min<=TURN_ALERT_M) break;
    }
    if(target<0) return;
    if(min<=TURN_ALERT_M){
      shownStepIndex=target;
      const dir=decideLR(steps[target].instruction,steps[target].type);
      showTurn(dir,min,steps[target].instruction||'');
    }
  }

  // æ¤œç´¢ â†’ ä¸Šä½5ä»¶ â†’ ç›®çš„åœ°ã‚¿ãƒƒãƒ—ã§çµŒè·¯
  async function doSearch(){
    const term=qEl.value.trim(); if(!term){toast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›');return;}
    const center=meLatLng||map.getCenter();
    try{
      toast('æ¤œç´¢ä¸­â€¦');
      const list=await geocodeTop5(term,center,langEl.value);
      if(!list.length){ resultsEl.style.display='none'; toast('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }
      resultsUL.innerHTML=list.map((p,i)=>`<li data-i="${i}"><span>${p.display_name}</span><small>${(p._d/1000).toFixed(2)}km</small></li>`).join('');
      resultsEl.style.display='block';
      resultsUL.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click',async ()=>{
          const p=list[+li.getAttribute('data-i')]; resultsEl.style.display='none';
          const to=L.latLng(p.lat,p.lon);
          if(!dstMarker) dstMarker=L.marker(to,{title:'ç›®çš„åœ°'}).addTo(map); else dstMarker.setLatLng(to).bindPopup(p.display_name||'ç›®çš„åœ°');
          if(meLatLng && (headingDeg==null)){ headingDeg=bearing(meLatLng,to); rotateHeading(); }
          if(meLatLng){
            const r=await routeWalk(meLatLng,to,langEl.value); drawRoute(r.latlngs);
            lastRouteTo=to; lastRouteAt=Date.now(); shownStepIndex=-1; // ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            toast(`å¾’æ­© ç´„${Math.round(r.dur/60)}åˆ† / ${(r.dist/1000).toFixed(2)}km`);
          }else{ map.flyTo(to,18); }
        });
      });
    }catch(e){ console.error(e); toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
  }
  searchEl.addEventListener('click',doSearch);
  qEl.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });

  // URL ?q= ã§èµ·å‹•
  const sp=new URLSearchParams(location.search);
  if(sp.get('q')){ qEl.value=sp.get('q'); setTimeout(doSearch,300); }
})();
</script>
</body>
</html>
