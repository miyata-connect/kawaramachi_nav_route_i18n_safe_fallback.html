<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321; --text:#eaf2ff; --muted:#a7b8ce; --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78); --stroke: rgba(255,255,255,.12);
      --ok:#25d07a; --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}
    .overlay{position:absolute;left:12px;right:12px;top:12px;padding:16px 18px;border-radius:16px;background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px)}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{position:fixed;right:12px;display:flex;flex-direction:column;gap:14px;bottom:18px;z-index:3}
    .btn{width:96px;height:96px;border-radius:24px;background:rgba(255,255,255,.08);display:flex;align-items:center;justify-content:center;border:1px solid var(--stroke);color:var(--text);text-decoration:none;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;background:#ff6b6b;color:#fff;border:0;display:none;z-index:5}
    .sheet{position:fixed;left:12px;right:12px;bottom:12px;max-height:55vh;overflow:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:16px;backdrop-filter:blur(6px);padding:12px 8px;display:none}
    .item{padding:14px 16px;border-radius:12px;border:1px solid var(--stroke);margin:8px;background:rgba(255,255,255,.04)}
    .item h4{margin:0 0 6px 0;font-size:16px}
    .item p{margin:0;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div id="panel" class="overlay">
      <div class="row">
        <strong id="panel-title">Set your destination</strong>
        <span id="coord" style="font-variant-numeric:tabular-nums;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
    </div>

    <div class="pill">
      <button id="btn-current" class="btn" title="Current">Current</button>
      <button id="btn-search" class="btn" title="Search">Search</button>
      <button id="btn-stop" class="btn" title="Stop">Stop</button>
      <button id="btn-dest" class="btn" title="Destination">Dest</button>
      <button id="btn-reroute" class="btn" title="Reroute">Reroute</button>
      <button id="btn-ops" class="btn" title="Ops">Ops</button>
    </div>

    <div id="sheet" class="sheet" role="dialog" aria-label="Search results"></div>
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Google Maps JS API (auto-embedded key per governance) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=en&region=JP&loading=async"></script>

  <script type="module">
    // --- constants ---
    const PROXY = "https://ors-proxy.miyata-connect-jp.workers.dev";
    const ALLOWED_ORIGIN = "https://miyata-connect.github.io";
    const RADIUS_M = 10000; // 10km fixed
    const MAX_RESULTS = 5;

    // --- helpers ---
    const toast = (msg, ok=false) => {
      const el = document.getElementById('toast');
      el.style.background = ok ? "#25d07a" : "#ff6b6b";
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 3000);
    };

    const waitForGoogleMaps = async (timeout=15000)=>{
      const t0 = performance.now();
      while(performance.now()-t0 < timeout){
        if (globalThis.google?.maps?.importLibrary) return;
        await new Promise(r=>setTimeout(r,50));
      }
      throw new Error("Google Maps failed to load");
    };

    // distance in meters using haversine
    function haversine(a, b){
      const toRad = d => d*Math.PI/180;
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s1 = Math.sin(dLat/2), s2 = Math.sin(dLng/2);
      const aa = s1*s1 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*s2*s2;
      return 2*R*Math.asin(Math.sqrt(aa));
    }

    // rectangle from center + radius (meters)
    function rectFromCircle(center, radiusM){
      const latDeg = radiusM / 111320; // approx meters per degree lat
      const lngDeg = radiusM / (111320 * Math.cos(center.lat * Math.PI/180) || 1e-6);
      return {
        low:  { latitude: center.lat - latDeg, longitude: center.lng - lngDeg },
        high: { latitude: center.lat + latDeg, longitude: center.lng + lngDeg }
      };
    }

    // --- globals ---
    let map, marker, destMarker;
    let currentPos = { lat: 35.681236, lng: 139.767125 };
    const setCoord = (pos)=>{
      const c = document.getElementById("coord");
      c.textContent = `Lat: ${pos.lat.toFixed(6)} / Lng: ${pos.lng.toFixed(6)}`;
    };

    // --- bootstrap ---
    try{
      await waitForGoogleMaps();
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: currentPos, zoom: 16, mapId: "WALKNAV_V5", disableDefaultUI: true,
      });

      marker = new AdvancedMarkerElement({ map, position: currentPos });
      setCoord(currentPos);

      // geolocate
      const getLocation = () => new Promise((resolve,reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation unsupported"));
        navigator.geolocation.getCurrentPosition(
          pos=>resolve({ lat:pos.coords.latitude, lng:pos.coords.longitude }),
          err=>reject(new Error(err.message||"Location error")),
          { enableHighAccuracy:true, timeout:10000, maximumAge:0 }
        );
      });

      try{
        currentPos = await getLocation();
        map.setCenter(currentPos);
        marker.position = currentPos;
        setCoord(currentPos);
        toast("Location updated", true);
      }catch(e){ toast(`Location error: ${e.message}`); }

      // buttons
      document.getElementById("btn-current").addEventListener("click", async ()=>{
        try{
          const p = await getLocation();
          currentPos = p; map.setCenter(p); marker.position = p; setCoord(p);
          toast("Centered to current position", true);
        }catch(e){ toast(`Location error: ${e.message}`); }
      });

      // search flow
      document.getElementById("btn-search").addEventListener("click", async ()=>{
        const q = prompt("Search text (e.g., Ramen Tokushima):")?.trim();
        if(!q) return;

        const rect = rectFromCircle(currentPos, RADIUS_M);
        const body = {
          textQuery: q,
          locationRestriction: { rectangle: rect },
          pageSize: MAX_RESULTS
        };

        try{
          const res = await fetch(`${PROXY}/places:searchText`, {
            method: "POST",
            headers: { "Content-Type":"application/json", "Origin": ALLOWED_ORIGIN },
            body: JSON.stringify(body)
          });

          if(!res.ok){
            const t = await res.text().catch(()=> "");
            throw new Error(`Places API error (${res.status}) ${t || ""}`.trim());
          }

          const data = await res.json();
          const list = Array.isArray(data.places) ? data.places : [];

          // strict client-side radius filter (<=10km), then take up to 5 nearest
          const candidates = list
            .map(p=>{
              const loc = { lat: p.location?.latitude ?? 0, lng: p.location?.longitude ?? 0 };
              return { raw:p, loc, dist: haversine(currentPos, loc) };
            })
            .filter(x => isFinite(x.dist) && x.dist <= RADIUS_M)
            .sort((a,b)=>a.dist-b.dist)
            .slice(0, MAX_RESULTS);

          if(candidates.length === 0){
            toast("No results within 10km");
            document.getElementById("sheet").style.display = "none";
            return;
          }

          // render sheet
          const sheet = document.getElementById("sheet");
          sheet.innerHTML = `<div style="padding:6px 10px 10px 12px;font-weight:600">Search results (≤10km)</div>`;
          candidates.forEach(c=>{
            const name = c.raw.displayName?.text || "(no name)";
            const addr = c.raw.formattedAddress || "";
            const km = (c.dist/1000).toFixed(2);
            const el = document.createElement("div");
            el.className = "item";
            el.innerHTML = `<h4>${name} — ${km} km</h4><p>${addr}</p>`;
            el.addEventListener("click", ()=>{
              if(!destMarker) destMarker = new google.maps.marker.AdvancedMarkerElement({map});
              destMarker.position = c.loc;
              map.setCenter(c.loc);
              map.setZoom(16);
              sheet.style.display = "none";
              toast(`Destination set: ${name}`, true);
            });
            sheet.appendChild(el);
          });
          sheet.style.display = "block";
        }catch(e){
          console.error(e);
          toast(`Search error: ${e.message}`);
          document.getElementById("sheet").style.display = "none";
        }
      });

      ["btn-stop","btn-dest","btn-reroute","btn-ops"].forEach(id=>{
        document.getElementById(id).addEventListener("click", ()=>toast(`${id} tapped`));
      });

    }catch(e){
      console.error(e);
      toast("Map initialization error: " + e.message);
    }
  </script>
</body>
</html>