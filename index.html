<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walk-Nav（Cloudflare Worker中継・Google Maps版）</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
:root{
  --bg:#0f1a25; --panel:#132235; --panel2:#0f1e30;
  --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b; --accent:#4ac8ff;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Helvetica Neue",Arial,"メイリオ",Meiryo,sans-serif}
.wrap{max-width:1100px;margin:0 auto;padding:12px}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.28)}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1 1 200px}
input,button,select{border-radius:12px;border:1px solid rgba(255,255,255,.08);
  background:var(--panel2);color:var(--text);padding:12px 14px;font-size:16px;outline:none}
input::placeholder{color:#8aa2bc}
button.primary{background:var(--primary);border:none;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
.hint{color:var(--muted);font-size:14px}
.small{font-size:13px;color:var(--muted)}
.badge{display:inline-block;background:rgba(255,255,255,.08);padding:3px 8px;border-radius:999px;margin-left:6px}
#busy{color:var(--accent);font-weight:700;display:none}

/* Map */
.mapwrap{position:relative}
#map{height:64vh;border-radius:16px;overflow:hidden}

/* Compass */
.compass{position:absolute;left:16px;top:16px;z-index:450;width:82px;height:82px;
  border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.35);pointer-events:none}
.compass svg{display:block;width:100%;height:100%}
.compass text{font-size:10px;fill:#f6d365;letter-spacing:.1em}
#needle{transform-box:fill-box;transform-origin:37px 37px;transition:transform 0s}
#needle polygon{fill:#ff4e4e;filter:drop-shadow(0 4px 8px rgba(0,0,0,.35))}

/* Leaflet: move zoom to bottom-left, attribution bottom-left */
.leaflet-control-zoom{left:10px!important;right:auto!important;bottom:14px!important;top:auto!important}
.leaflet-control-attribution{left:8px!important;right:auto!important;bottom:10px!important}

/* Right floating buttons */
.fab-col{position:absolute;right:12px;bottom:88px;z-index:460;display:flex;flex-direction:column;gap:10px}
.fab-col button{min-width:126px;padding:10px 12px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.fab-col .danger{margin-bottom:4px}

/* Results panel */
.results{margin-top:10px}
.result{background:#0b1624;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.result small{color:#a9bed5}
.results .body{max-height:44vh;overflow:auto;margin-top:8px}

/* Save modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1000}
.modal .box{background:var(--panel);border-radius:16px;max-width:520px;width:92vw;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.5)}
.modal .title{font-weight:800;margin-bottom:8px}
.modal .row{margin-top:8px}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}

@media (max-width:640px){
  #map{height:68vh}
  .fab-col button{min-width:118px;padding:9px 11px;font-size:15px}
}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <input id="q" class="grow" placeholder="店舗名・住所・電話番号で検索" autocomplete="off">
      <button id="mic" class="ghost">🎤 音声</button>
      <button id="search" class="primary">検索</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="clearHistory" class="ghost">履歴をクリア</button>
      <span id="busy">検索中…</span>
      <span class="hint">候補をタップ → 目的地設定 → ルート取得 → 案内開始（自動）</span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="grow">
        <div class="hint">開始地点（経度・緯度）</div>
        <div class="row">
          <input id="startLon" class="grow" placeholder="経度" inputmode="decimal">
          <input id="startLat" class="grow" placeholder="緯度" inputmode="decimal">
        </div>
      </div>
      <div class="grow">
        <div class="hint">目的地（経度・緯度）</div>
        <div class="row">
          <input id="destLon" class="grow" placeholder="経度" inputmode="decimal">
          <input id="destLat" class="grow" placeholder="緯度" inputmode="decimal">
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="modeWalk"  class="primary">徒歩</button>
      <div class="grow"></div>
      <button id="getRoute" class="primary">ルート取得</button>
      <button id="clear" class="ghost">クリア</button>
    </div>

    <div class="row" style="margin-top:12px">
      <div class="grow">
        <div class="hint">記憶地点（この端末に保存）</div>
        <div class="row">
          <select id="savedList" class="grow"></select>
          <button id="openSaveModal" class="ok">現在地を保存</button>
          <button id="setFromSaved" class="primary">目的地に設定</button>
          <button id="delSaved" class="danger">削除</button>
        </div>
      </div>
    </div>

    <div id="msg" class="hint" style="margin-top:6px;">準備完了。目的地を設定してください</div>
  </div>

  <div class="card mapwrap" style="margin-top:12px">
    <div id="map"></div>

    <div class="compass" aria-hidden="true">
      <svg viewBox="0 0 74 74">
        <defs>
          <radialGradient id="g1" cx="50%" cy="50%" r="60%">
            <stop offset="0%"  stop-color="#0b1624"/>
            <stop offset="60%" stop-color="#0a1320"/>
            <stop offset="100%" stop-color="#07121e"/>
          </radialGradient>
        </defs>
        <circle cx="37" cy="37" r="36" fill="url(#g1)" stroke="rgba(255,255,255,.15)"/>
        <text x="37" y="12" text-anchor="middle">N</text>
        <g id="needle">
          <polygon points="37,11 31.5,37 42.5,37"/>
        </g>
        <text x="37" y="66" text-anchor="middle" fill="#b8cce2">進行方向</text>
      </svg>
    </div>

    <div class="fab-col">
      <button id="navStart" class="ok">案内開始</button>
      <button id="gotoStart" class="primary">現在地</button>
      <button id="gotoDest"  class="primary">目的地</button>
      <button id="reroute"   class="danger">リルート</button>
    </div>
  </div>

  <div class="card results" id="results" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div><span class="badge">検索結果（近隣 上位5件）</span></div>
      <button id="closeResults" class="ghost">閉じる</button>
    </div>
    <div id="resultList" class="body"></div>
  </div>
</div>

<div class="modal" id="saveModal">
  <div class="box">
    <div class="title">現在地を保存</div>
    <div class="row">
      <input id="saveName" class="grow" placeholder="地点名を入力（例：自宅・公園）">
    </div>
    <div class="row">
      <input id="saveLon" class="grow" placeholder="経度" inputmode="decimal">
      <input id="saveLat" class="grow" placeholder="緯度" inputmode="decimal">
    </div>
    <div class="actions">
      <button id="cancelSave" class="ghost">キャンセル</button>
      <button id="doSave" class="ok">保存</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ===== 固定設定（あなたの Cloudflare Worker URL） ===== */
const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev'; // ← ここはあなたの Worker に合わせて

/* ===== 状態 ===== */
let profile='walking'; // Google Directionsのmode
const $=id=>document.getElementById(id);
const els={
  q:$('q'), mic:$('mic'), search:$('search'), clearHistory:$('clearHistory'), busy:$('busy'),
  results:$('results'), resultList:$('resultList'), closeResults:$('closeResults'),
  startLat:$('startLat'), startLon:$('startLon'), destLat:$('destLat'), destLon:$('destLon'),
  modeWalk:$('modeWalk'),
  getRoute:$('getRoute'), clear:$('clear'), msg:$('msg'),
  navStart:$('navStart'), gotoStart:$('gotoStart'), gotoDest:$('gotoDest'), reroute:$('reroute'),
  needle:document.getElementById('needle'),
  savedList:$('savedList'),
  openSaveModal:$('openSaveModal'), saveModal:$('saveModal'),
  saveName:$('saveName'), saveLon:$('saveLon'), saveLat:$('saveLat'),
  cancelSave:$('cancelSave'), doSave:$('doSave'),
  setFromSaved:$('setFromSaved'), delSaved:$('delSaved')
};

/* ===== 地図 ===== */
const map = L.map('map',{zoomControl:false});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
L.control.zoom({position:'bottomleft'}).addTo(map);
const routeGroup=L.layerGroup().addTo(map);
let currentMarker=null, destMarker=null, routeLine=null, lastRoute=null;
let watchId=null, prevPos=null;

/* ===== コンパス（安定化） ===== */
const compass={angle:0,target:0,lastUpdate:0,raf:null};
function norm360(x){x%=360;if(x<0)x+=360;return x;}
function shortDiff(a,b){let d=norm360(b)-norm360(a);if(d>180)d-=360;if(d<-180)d+=360;return d;}
function setCompassTarget(deg){
  if
