<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
      --btnbg: rgba(80,88,98,.45);
      --btnfg: #ffffff;
      --phSize:16px;
      --phMin:11px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .overlay{
      position:absolute;left:12px;right:12px;top:12px;z-index:5;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px)
    }
    .overlay h2{margin:0 0 10px 0;font-weight:700;font-size:clamp(16px,2.6vw,22px);letter-spacing:.3px}
    .grid{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .input-wrap input[type="text"]{
      width:100%;height:44px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);padding:0 14px;font-size:16px;outline:none
    }
    .input-wrap input::placeholder{
      font-size:var(--phSize);
      white-space:nowrap;
    }
    select{
      height:44px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);padding:0 12px;font-size:15px
    }
    .btn{
      height:44px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.1);color:var(--text);padding:0 16px;font-weight:700;cursor:pointer
    }
    .btn:active{transform:translateY(1px)}
    .check{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);user-select:none
    }

    /* --- coordinate display --- */
    .coord{
      margin-top:10px;
      font-variant-numeric:tabular-nums;
      color:var(--muted);
      display:flex;
      align-items:center;
      gap:10px;
      white-space:nowrap;
      font-size:clamp(12px,2.1vw,15px);
    }
    .coord span{display:inline-block;}

    /* --- bottom sheet --- */
    .sheet{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:4;
      background:var(--glass);border:1px solid var(--stroke);border-radius:16px;
      backdrop-filter:blur(6px);max-height:46vh;overflow:auto;display:none;
    }
    .sheet-header{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:700;display:flex;justify-content:space-between;align-items:center;font-size:15px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);cursor:pointer}
    .item:last-child{border-bottom:none}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .go{min-width:70px;height:38px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.1);color:var(--text);font-weight:700;cursor:pointer}

    /* --- side buttons (glass gray Japanese) --- */
    .side{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      display:flex;flex-direction:column;gap:12px;z-index:3;
    }
    .sbtn{
      width:68px;height:68px;border-radius:18px;
      border:1px solid rgba(255,255,255,.2);
      background:linear-gradient(145deg,rgba(80,80,90,.45),rgba(30,30,40,.35));
      color:var(--btnfg);font-weight:700;font-size:15px;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 14px rgba(0,0,0,.3);
      backdrop-filter:blur(6px);
      cursor:pointer;user-select:none;
    }
    .sbtn:active{transform:scale(.96);}

    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:7;text-align:center}
    .toast.ok{background:var(--ok)}

    .blackout{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:6;color:#fff;text-align:center;padding:24px}
    .blackout .box{max-width:min(680px,90vw);border:1px solid rgba(255,255,255,.18);border-radius:16px;background:rgba(255,255,255,.06);padding:18px 16px;font-size:16px;line-height:1.7}
    .hidden{display:none !important}

    /* ripple marker */
    .pin-wrap{position:relative;width:34px;height:34px;display:grid;place-items:center;transform:translate(-50%,-100%)}
    .pin{width:26px;height:26px;border-radius:50%;background:#ff4949;border:3px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.35)}
    .ripple{position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:18px;height:6px;border-radius:50%;background:rgba(0,0,0,.25);filter:blur(1px)}
    .wave{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:2px solid rgba(255,73,73,.55);border-radius:50%;animation:wave 1.8s ease-out infinite;}
    .wave.wave2{animation-delay:.45s}
    .wave.wave3{animation-delay:.9s}
    @keyframes wave{
      0%{opacity:.55;transform:translate(-50%,-50%) scale(.35)}
      70%{opacity:.08}
      100%{opacity:0;transform:translate(-50%,-50%) scale(1.25)}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <div id="blackout" class="blackout"><div class="box" id="blackout-text"></div></div>

    <div id="panel" class="overlay">
      <h2 id="panel-title"></h2>
      <div class="grid">
        <div class="input-wrap"><input id="q" type="text" autocomplete="off" /></div>
        <select id="radius">
          <option value="10000">10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>
        <button id="btn-search" class="btn"></button>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="check"><input id="use-center" type="checkbox" /> <span id="use-center-label"></span></label>
        <label class="check"><input id="open-now" type="checkbox" /> <span id="open-now-label"></span></label>
        <label class="check"><input id="top-rated" type="checkbox" /> <span id="top-rated-label"></span></label>
        <label class="check"><input id="has-photo" type="checkbox" /> <span id="has-photo-label"></span></label>
      </div>
      <div class="coord">
        <span id="coord-tail"></span><span id="coord"></span>
      </div>
    </div>

    <div id="sheet" class="sheet">
      <div class="sheet-header">
        <span id="sheet-title"></span>
        <button id="sheet-close" class="btn" style="height:34px;padding:0 10px">×</button>
      </div>
      <div id="sheet-body"></div>
    </div>

    <div class="side">
      <div id="btn-current" class="sbtn">現在地</div>
      <div id="btn-stop" class="sbtn">停止</div>
      <div id="btn-reroute" class="sbtn">再探索</div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    const JA={
      title:(km)=>`近くを検索（${km} km / 5件）`,
      placeholder:"店舗 名・電話番号・カテゴリ・住所・座標・施設 名",
      search:"検索",
      useCenter:"地図中心で検索",
      openNow:"営業中",topRated:"高レビュー順",hasPhoto:"画像あり",
      lat:"緯度",lng:"経度",currentTail:"現在地：",
      toastEnter:"検索したい文字を入力してください。",
      toastCenter:"地図中心を基準に検索しました。",
      gnav:"ルート開始",
      loading:"現在地取得中です。ご迷惑をお掛けします。現在地表示まで30秒程お待ちください。",
      timeout:"現在地を取得出来ませんでした。屋外や空が開けた場所で再試行してください。"
    };

    const el=id=>document.getElementById(id);
    const toastEl=el("toast");
    const showToast=(msg,ok=false)=>{
      toastEl.textContent=msg;
      toastEl.style.background=ok?"#25d07a":"#ff6565";
      toastEl.style.display="block";
      clearTimeout(toastEl._t);
      toastEl._t=setTimeout(()=>toastEl.style.display="none",3000);
    };

    const q=el("q"),radiusSel=el("radius"),btnSearch=el("btn-search"),useCenter=el("use-center");
    const openNow=el("open-now"),topRated=el("top-rated"),hasPhoto=el("has-photo");
    const coord=el("coord"),coordTail=el("coord-tail"),panelTitle=el("panel-title");
    const sheet=el("sheet"),sheetTitle=el("sheet-title"),sheetBody=el("sheet-body");

    q.placeholder=JA.placeholder;btnSearch.textContent=JA.search;
    el("use-center-label").textContent=JA.useCenter;
    el("open-now-label").textContent=JA.openNow;
    el("top-rated-label").textContent=JA.topRated;
    el("has-photo-label").textContent=JA.hasPhoto;
    coordTail.textContent=JA.currentTail;

    const refreshTitle=()=>{const km=radiusSel.options[radiusSel.selectedIndex].text.replace("km","").trim();panelTitle.textContent=JA.title(km);};
    refreshTitle();radiusSel.addEventListener("change",refreshTitle);

    const blackout=el("blackout"),blackoutText=el("blackout-text");
    blackoutText.textContent=JA.loading;

    const PROXY_BASE="https://ors-proxy.miyata-connect-jp.workers.dev";
    let map,currentPos=null,currentMarker=null,destPolyline=null;

    function buildRipple(){
      const wrap=document.createElement("div");wrap.className="pin-wrap";
      const p=document.createElement("div");p.className="pin";
      const r=document.createElement("div");r.className="ripple";
      const w1=document.createElement("div");w1.className="wave";
      const w2=document.createElement("div");w2.className="wave wave2";
      const w3=document.createElement("div");w3.className="wave wave3";
      wrap.append(w1,w2,w3,p,r);return wrap;
    }

    async function getLoc(){return new Promise((res,rej)=>{
      if(!navigator.geolocation) return rej();
      navigator.geolocation.getCurrentPosition(
        p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
        ()=>rej(),{enableHighAccuracy:true,timeout:30000});
    });}

    async function init(){
      await new Promise(r=>setTimeout(r,100));
      const {Map}=await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");
      let pos;
      try{pos=await getLoc();}catch{}
      currentPos=pos||{lat:35.681236,lng:139.767125};
      map=new Map(el("map"),{center:currentPos,zoom:16,disableDefaultUI:true});
      currentMarker=new AdvancedMarkerElement({map,position:currentPos,content:buildRipple()});
      blackout.classList.add("hidden");
      coord.textContent=`${JA.lat}:${currentPos.lat.toFixed(6)} / ${JA.lng}:${currentPos.lng.toFixed(6)}`;
    }
    init();

    btnSearch.addEventListener("click",async()=>{
      if(!q.value.trim()) return showToast(JA.toastEnter);
      if(useCenter.checked) showToast(JA.toastCenter,true);
    });

    el("btn-current").addEventListener("click",async()=>{
      try{const p=await getLoc();map.panTo(p);currentPos=p;coord.textContent=`${JA.lat}:${p.lat.toFixed(6)} / ${JA.lng}:${p.lng.toFixed(6)}`;showToast("現在地へ移動",true);}catch{showToast("位置情報エラー");}
    });
    el("btn-stop").addEventListener("click",()=>{if(destPolyline){destPolyline.setMap(null);destPolyline=null;}showToast("案内停止",true);});
    el("btn-reroute").addEventListener("click",()=>showToast("再探索しました",true));
  </script>
</body>
</html>