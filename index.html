<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav Diagnostic Edition</title>
  <style>
    :root{
      --glass: rgba(20,28,44,.7);
      --glass-strong: rgba(16,22,36,.85);
      --stroke: rgba(255,255,255,.14);
      --text: #eaf2ff;
      --muted:#a7b8ce;
      --primary:#5fb1ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --bg:#0a1321;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}
    .overlay{
      position:absolute;left:10px;right:10px;top:10px;
      padding:16px;border-radius:14px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px);
      z-index:2;
    }
    .progress{
      position:fixed;right:10px;top:10px;width:160px;height:12px;
      border-radius:6px;background:rgba(255,255,255,.15);overflow:hidden;
    }
    .progress-bar{height:100%;width:100%;background:var(--ok);transition:width .4s linear}
    .pill{
      position:fixed;right:12px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:3
    }
    .btn{
      width:90px;height:90px;border-radius:22px;
      background:rgba(255,255,255,.08);
      border:1px solid var(--stroke);color:var(--text);
      display:flex;align-items:center;justify-content:center;
      font-size:14px;text-decoration:none;backdrop-filter:blur(4px)
    }
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:10px 14px;border-radius:12px;background:var(--danger);color:#fff;display:none;z-index:5
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    <div class="overlay">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <span id="coord">現在地: 取得中…</span>
        <span id="score" style="font-size:14px;color:var(--muted)">診断: --点</span>
      </div>
    </div>
    <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
    <div class="pill">
      <button class="btn" id="btn-voice">音声検索</button>
      <button class="btn" id="btn-search">入力検索</button>
      <button class="btn" id="btn-reset">リセット</button>
      <button class="btn" id="btn-save">地点登録</button>
      <button class="btn" id="btn-edit">地点修正</button>
    </div>
    <div id="toast" class="toast"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP"></script>
  <script type="module">
    const Diag={score:{entry:0,live:100,exit:0},events:[],log:[],add(e){this.log.push({...e,ts:Date.now()});},report(){return JSON.stringify(this.log,null,2);}};
    function toast(msg,ok=false){const t=document.getElementById("toast");t.style.background=ok?"#25d07a":"#ff6565";t.textContent=msg;t.style.display="block";clearTimeout(t._t);t._t=setTimeout(()=>t.style.display="none",3000);}
    const bar=document.getElementById("progress-bar"),scoreView=document.getElementById("score");
    function updateProgress(val){bar.style.width=`${val}%`;if(val>89)bar.style.background="#25d07a";else if(val>59)bar.style.background="#ffb347";else bar.style.background="#ff6565";}
    updateProgress(100);

    async function entryDiag(){
      let total=0;
      try{if(window.google)total+=25;}catch{Diag.add({err:"maps"});}
      try{const r=await fetch("https://ors-proxy.miyata-connect-jp.workers.dev/healthz");if(r.ok)total+=25;}catch{Diag.add({err:"worker"});}
      try{if(document.querySelector(".overlay"))total+=25;}catch{Diag.add({err:"ui"});}
      total+=25;Diag.score.entry=total;scoreView.textContent=`診断:${total}点`;return total;
    }

    let map,marker;let cur={lat:0,lng:0};
    async function init(){
      await entryDiag();
      updateProgress(95);
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(p=>{
          cur={lat:p.coords.latitude,lng:p.coords.longitude};
          map=new google.maps.Map(document.getElementById("map"),{center:cur,zoom:17,mapId:"DEMO_MAP",disableDefaultUI:true});
          marker=new google.maps.marker.AdvancedMarkerElement({map,position:cur});
          document.getElementById("coord").textContent=`現在地: ${cur.lat.toFixed(6)}, ${cur.lng.toFixed(6)}`;
          toast("現在地を取得しました。",true);
        },()=>toast("現在地の取得に失敗しました。"));
      }else toast("位置情報が利用できません。");
    }

    document.getElementById("btn-search").onclick=()=>toast("検索開始（未実装）");
    document.getElementById("btn-voice").onclick=()=>toast("音声検索開始（未実装）");
    document.getElementById("btn-reset").onclick=()=>toast("リセット完了",true);
    document.getElementById("btn-save").onclick=()=>toast("地点登録",true);
    document.getElementById("btn-edit").onclick=()=>toast("地点修正",true);

    init().then(()=>{Diag.score.exit=Diag.score.entry- (100-Diag.score.live)/2;Diag.add({phase:"exit",score:Diag.score.exit});fetch("https://ors-proxy.miyata-connect-jp.workers.dev/report",{method:"POST",headers:{"Content-Type":"application/json"},body:Diag.report()});});
  </script>
</body>
</html>