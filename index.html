<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav v5 â€“ Minimal D</title>
  <style>
    html,body{height:100%;margin:0;background:#0a1321;color:#eaf2ff;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;display:none} /* hidden until first fix */
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>
  </div>

  <script>
    // --- Config ---
    const FALLBACK = { lat: 35.681236, lng: 139.767125 }; // Tokyo Station

    // Wait until the new async loader is ready
    async function waitForGoogleMaps(timeoutMs = 15000){
      const start = performance.now();
      while (performance.now() - start < timeoutMs){
        if (window.google && google.maps && google.maps.importLibrary) return true;
        await new Promise(r=>setTimeout(r,50));
      }
      throw new Error("Google Maps loader timeout");
    }

    function getFirstFix(opts = { enableHighAccuracy:true, timeout:15000, maximumAge:0 }){
      return new Promise((resolve, reject)=>{
        if (!navigator.geolocation){
          reject(new Error("Geolocation unsupported"));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve, reject, opts);
      });
    }

    async function initAfterFix(position){
      const [{ Map }, { AdvancedMarkerElement }] = await Promise.all([
        google.maps.importLibrary("maps"),
        google.maps.importLibrary("marker"),
      ]);

      const p = { lat: position.coords.latitude, lng: position.coords.longitude };
      const mapEl = document.getElementById("map");
      const map = new Map(mapEl, {
        center: p,
        zoom: 16,
        disableDefaultUI: true,
        clickableIcons: true,
        heading: 0,
        tilt: 0,
      });

      const marker = new AdvancedMarkerElement({ map, position: p });

      // Show map only now (no Tokyo flash)
      mapEl.style.display = "block";

      // Keep following the user
      navigator.geolocation.watchPosition(pos=>{
        const np = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        marker.position = np;
        map.panTo(np);
      }, ()=>{/* ignore watch errors to stay silent */}, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
    }

    async function initFallback(reason){
      // Silent fallback: show map at Tokyo (only when user explicitly denies or hard-fails)
      const [{ Map }, { AdvancedMarkerElement }] = await Promise.all([
        google.maps.importLibrary("maps"),
        google.maps.importLibrary("marker"),
      ]);
      const mapEl = document.getElementById("map");
      const map = new Map(mapEl, {
        center: FALLBACK,
        zoom: 16,
        disableDefaultUI: true,
        clickableIcons: true,
        heading: 0,
        tilt: 0,
      });
      new AdvancedMarkerElement({ map, position: FALLBACK });
      mapEl.style.display = "block";
      // We still try to get a live fix in the background; if it arrives, jump once.
      navigator.geolocation && navigator.geolocation.getCurrentPosition(pos=>{
        const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.panTo(p);
        new AdvancedMarkerElement({ map, position: p });
      });
      console.warn("Fallback shown:", reason && reason.message ? reason.message : reason);
    }

    (async function main(){
      try{
        await waitForGoogleMaps();
        try{
          const pos = await getFirstFix();
          await initAfterFix(pos);
        }catch(firstErr){
          // If denied or timed out, show fallback but keep quiet
          await initFallback(firstErr);
        }
      }catch(e){
        // Hard loader error: keep page blank (no UI), but log for diagnostics
        console.error(e);
      }
    })();
  </script>

  <!-- Single async loader: no libraries=, no callback -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAC8S1q0X9qaUz08kZiGFxkcwmdTi-_hlo&v=weekly&language=ja&region=JP&loading=async"></script>
</body>
</html>