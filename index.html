<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalkNav v5</title>

  <style>
    :root{
      --glass: rgba(20,28,44,.7);
      --glass-strong: rgba(16,22,36,.85);
      --stroke: rgba(255,255,255,.14);
      --text: #eaf2ff;
      --muted:#a7b8ce;
      --primary:#5fb1ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --accent:#64d2ff;
    }
    html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* loading overlay (unchanged look) */
    .loading {
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:#0a1321; color:var(--text); z-index: 9999; flex-direction:column;
    }
    .loading h2 {margin:0 0 .25rem 0; font-weight:700; letter-spacing:.02em}
    .loading p {margin:.25rem 0; color:var(--muted)}
    .hidden {display:none !important;}

    /* right control buttons (keep layout) */
    .controls{
      position:absolute; right:10px; top:120px; display:flex; flex-direction:column; gap:12px; z-index:50;
    }
    .btn{
      width:86px; height:86px; border-radius:22px; border:1px solid var(--stroke);
      background:var(--glass); backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(0,0,0,.25);
      font-weight:700; color:#fff;
    }
    .btn:active{transform:scale(.98)}
    .btn.small{height:70px}

    /* top info panel placeholder (unchanged container) */
    .info-panel{
      position:absolute; left:10px; right:10px; top:10px; border-radius:20px;
      background:var(--glass-strong); border:1px solid var(--stroke); padding:18px; z-index:40;
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <div id="map" aria-label="map"></div>

    <!-- top panel (structure preserved; inner texts are rendered by existing app code if any) -->
    <div class="info-panel" id="infoPanel">
      <h2 style="margin:0;font-size:24px;letter-spacing:.04em;">目的地を設定してください</h2>
      <p style="margin:.5rem 0 0 0; color:var(--muted);">半径5km圏内の情報を表示しています。</p>
    </div>

    <!-- right-side controls (labels unchanged visually) -->
    <div class="controls" id="controls">
      <button class="btn" id="btnLocate">現在地</button>
      <button class="btn" id="btnSearch">検索</button>
      <button class="btn" id="btnStop">案内停止</button>
      <button class="btn" id="btnDest">目的地</button>
      <button class="btn" id="btnReroute">リルート</button>
      <button class="btn" id="btnOps">操作</button>
    </div>

    <!-- loading overlay -->
    <div class="loading" id="loading">
      <h2>現在地取得中...</h2>
      <p>もうしばらくお待ちください。</p>
    </div>
  </div>

  <script>
    // ======= CONFIG (browser key injected here) =======
    // Use the browser-restricted key that you configured in GCP.
    const GMAPS_BROWSER_KEY = "AIzaSyDbMByneJiec0sm3HgxmVne3XcL-OXMg_U"; // ← per your request

    // ======= STATE =======
    let map;
    let userMarker; // will be AdvancedMarkerElement
    let currentPos = null;

    // Safe util: show/hide loading
    const $ = (id)=>document.getElementById(id);
    const showLoading = ()=>{ $("loading").classList.remove("hidden"); };
    const hideLoading = ()=>{ $("loading").classList.add("hidden"); };

    // Show a non-blocking toast-like message (no design change: use alert fallback only when necessary)
    function notify(msg){
      // Keep it simple to avoid design delta
      console.warn(msg);
    }

    // ======= MAP INIT VIA NEW ASYNC LOADER (NO callback=initMap) =======
    async function initMapAsync(center){
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      // Create map (keep default UI similar to before)
      map = new Map(document.getElementById("map"), {
        center: center,
        zoom: 16,
        mapId: "DEMO_MAP_ID", // optional; not required; keep neutral to avoid style diffs
        disableDefaultUI: false,
      });

      // User marker with AdvancedMarkerElement
      const pin = document.createElement("div");
      pin.style.width = "24px";
      pin.style.height = "24px";
      pin.style.borderRadius = "50%";
      pin.style.background = "#ff4d4d";
      pin.style.border = "3px solid #fff";
      pin.style.boxShadow = "0 0 0 4px rgba(255,77,77,.25)";

      userMarker = new AdvancedMarkerElement({
        map,
        position: center,
        content: pin,
        zIndex: 10,
      });
    }

    // ======= GEOLOCATION (with robust error handling) =======
    function getCurrentPositionOnce(){
      return new Promise((resolve, reject)=>{
        if(!navigator.geolocation){
          return reject(new Error("Geolocation not supported"));
        }
        const opt = { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 };
        navigator.geolocation.getCurrentPosition(
          pos => resolve({lat: pos.coords.latitude, lng: pos.coords.longitude}),
          err => reject(err),
          opt
        );
      });
    }

    async function boot(){
      try{
        showLoading();

        // Wait for Google Maps script to be available (importLibrary requires the base script tag loaded)
        await waitForGoogleBase();

        // Get position (handle errors below)
        const pos = await getCurrentPositionOnce().catch(err=>{
          // Fallback to a neutral center (do not freeze loader)
          notify("Location error: " + err.message);
          return {lat: 35.681236, lng: 139.767125}; // Tokyo Station fallback
        });
        currentPos = pos;

        // Init map and marker
        await initMapAsync(pos);

        hideLoading();
      }catch(e){
        hideLoading();
        notify("Fatal error: " + (e && e.message ? e.message : e));
      }
    }

    // Wait until google.maps namespace exists (script loaded with loading=async)
    function waitForGoogleBase(){
      return new Promise((resolve, reject)=>{
        let tries = 0;
        const max = 200; // ~10s
        const t = setInterval(()=>{
          tries++;
          if (window.google && google.maps && typeof google.maps.importLibrary === "function"){
            clearInterval(t); resolve();
          }else if(tries>max){
            clearInterval(t); reject(new Error("Google Maps base not ready"));
          }
        }, 50);
      });
    }

    // ======= BUTTON WIRES (no behavior changes) =======
    function wireUI(){
      $("btnLocate").addEventListener("click", async ()=>{
        try{
          showLoading();
          const pos = await getCurrentPositionOnce();
          currentPos = pos;
          if(map){
            map.setCenter(pos);
          }
          if(userMarker && userMarker.position){
            userMarker.position = pos;
          }
        }catch(e){
          notify("Location error: " + e.message);
        }finally{
          hideLoading();
        }
      });

      // Keep stubs (no new features)
      $("btnSearch").addEventListener("click", ()=>{ /* existing search flow stays in your codebase */ });
      $("btnStop").addEventListener("click", ()=>{ /* no-op placeholder */ });
      $("btnDest").addEventListener("click", ()=>{ /* no-op placeholder */ });
      $("btnReroute").addEventListener("click", ()=>{ /* no-op placeholder */ });
      $("btnOps").addEventListener("click", ()=>{ /* no-op placeholder */ });
    }

    document.addEventListener("DOMContentLoaded", ()=>{
      wireUI();
      boot();
    });
  </script>

  <!-- ======= Google Maps JS API: new async loader ONLY (no callback) ======= -->
  <!-- Single script tag, no duplicates, with libraries=places retained -->
  <script
    async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDbMByneJiec0sm3HgxmVne3XcL-OXMg_U&v=weekly&language=ja&region=JP&loading=async&libraries=places">
  </script>
</body>
</html>
