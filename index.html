<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walk-Nav AI (Debugged)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
/* --- 基本スタイル --- */
:root{--bg:#0f1a25;--panel:#132235;--panel2:#0f1e30;--text:#eaf2ff;--muted:#9db0c6;--ok:#2ecc71;--primary:#4aa3ff;--danger:#ff6b6b;--accent:#4ac8ff;}
body,html{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--text)}
main{max-width:800px;margin:0 auto;padding:10px}
h3{margin:10px 0 5px;padding-bottom:5px;border-bottom:1px solid var(--panel2);color:var(--accent);font-weight:400}
input,button,select{font-size:16px;padding:10px;border-radius:8px;border:1px solid var(--panel2);background:var(--panel);color:var(--text);margin:2px}
button{cursor:pointer}
button.primary{background:var(--primary);color:#fff}
#status{margin-top:8px;color:var(--muted);min-height:1.2em;font-size:14px}
button.loading{opacity:.7;pointer-events:none}
.btn-group{margin-bottom:10px}
.btn-group button.selected{background:var(--accent);color:var(--bg);font-weight:700}

/* --- FIX 7: 座標入力欄のレイアウト --- */
.coord-grid{display:grid;grid-template-columns:auto 1fr 1fr;gap:5px;align-items:center;margin-bottom:5px}
.coord-grid label{font-weight:bold;font-size:15px}

/* --- 地図関連 --- */
#map{width:100%;height:60vh;border-radius:12px;background:#334;position:relative;overflow:hidden}

/* --- FIX 1: 方位計を地図左上に配置 --- */
.compass{position:absolute;left:10px;top:10px;width:60px;height:60px;z-index:999}
#compass-needle{transform-origin:center;transition:transform .5s ease-out;transform:translate(-50%,-90%) rotate(0deg);fill:var(--danger)}

/* --- FIX 3: フローティングボタンを地図右下に配置 --- */
.fab-container{position:absolute;bottom:20px;right:10px;z-index:999;display:flex;flex-direction:column;gap:10px}
.fab-container button{box-shadow:0 8px 20px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1)}

/* --- FIX 6: ズームボタンを拡大 --- */
.leaflet-control-zoom-in, .leaflet-control-zoom-out {
  width: 40px !important; height: 40px !important; line-height: 40px !important; font-size: 24px !important;
}

/* --- FIX 4: マイクボタンのスタイル --- */
#btn-voice{background-color:var(--ok)}
#btn-voice.recording{background-color:var(--danger);animation:pulse 1.5s infinite}
@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.7)}70%{box-shadow:0 0 0 10px rgba(255,107,107,0)}100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}

/* --- 検索結果パネル --- */
#results{position:fixed;bottom:0;left:0;right:0;background:rgba(15,26,37,.95);backdrop-filter:blur(5px);border-top:1px solid var(--panel2);padding:10px;transform:translateY(100%);transition:transform .3s ease-out;z-index:1000;max-height:50vh;overflow-y:auto}
#results.show{transform:translateY(0)}
#results ul{list-style:none;padding:0;margin:0}
#results li{padding:12px;border-bottom:1px solid var(--panel2);cursor:pointer}
#results li:hover{background:var(--panel)}
#results-list strong{color:var(--accent)}

/* --- (モーダルCSSは変更なしのため省略) --- */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1001}.modal-box{background:var(--panel);padding:20px;border-radius:12px;width:90%;max-width:400px}.modal-box h3{margin-top:0}.modal-box input{width:calc(100% - 24px);margin-bottom:10px}.modal-box .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}#load-list li{display:flex;align-items:center;padding:8px;border-bottom:1px solid var(--panel2)}#load-list li .name{flex-grow:1}#load-list li button{margin-left:5px;padding:5px 8px;font-size:14px}
</style>
</head>
<body>

<main>
  <h3>言語</h3>
  <div class="btn-group">
    <button class="lang-btn selected" data-lang="ja">日本語</button>
    <button class="lang-btn" data-lang="en">English</button>
    <button class="lang-btn" data-lang="de">Deutsch</button>
    <button class="lang-btn" data-lang="it">Italiano</button>
    <button class="lang-btn" data-lang="fr">Français</button>
    <button class="lang-btn" data-lang="es">Español</button>
    <button class="lang-btn" data-lang="ko">한국어</button>
    <button class="lang-btn" data-lang="zh">中文</button>
  </div>

  <h3>検索</h3>
  <input id="q" placeholder="検索ワード">
  <button id="btn-voice">🎤</button>
  <button id="btn-search" class="primary">検索</button>
  <button id="btn-clear-history">履歴クリア</button>

  <div id="map">
    <div class="compass"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#132235" stroke="#4aa3ff" stroke-width="2"></circle><polygon id="compass-needle" points="50,10 60,50 50,90 40,50"></polygon><circle cx="50" cy="50" r="5" fill="#4aa3ff"></circle></svg></div>
    <div class="fab-container">
      <button id="btn-current">現在地</button>
      <button id="btn-dest">目的地</button>
      <button id="btn-reroute">リルート</button>
    </div>
  </div>
  <div id="status">準備完了</div>

  <h3>ルートモード</h3>
  <div class="btn-group">
    <button class="mode-btn selected" data-mode="shortest">最短Ai</button>
    <button class="mode-btn" data-mode="easy">楽ちんAi</button>
    <button class="mode-btn" data-mode="walkai">お散歩Ai</button>
    <button class="mode-btn" data-mode="tour">観光Ai</button>
  </div>

  <h3>座標</h3>
  <div class="coord-grid">
    <label>現在地</label>
    <input id="start-lng" placeholder="経度">
    <input id="start-lat" placeholder="緯度">
  </div>
  <div class="coord-grid">
    <label>目的地</label>
    <input id="end-lng" placeholder="経度">
    <input id="end-lat" placeholder="緯度">
  </div>

  <h3>操作</h3>
  <button id="btn-set-dest">目的地セット</button>
  <button id="btn-start" class="primary">案内開始</button>
  <button id="btn-stop">案内停止</button>
  <button id="btn-save" class="primary">現在地を保存</button>
  <button id="btn-load">呼び出し</button>
</main>

<div id="results">
  <button id="btn-close-results" style="float:right">閉じる</button>
  <h3>検索結果</h3>
  <ul id="results-list"></ul>
</div>

<div id="save-modal" class="modal"><div class="modal-box"><h3>地点の保存</h3><input id="save-name" placeholder="名前 (例: 自宅)"><div class="actions"><button id="btn-cancel-save">キャンセル</button><button id="btn-do-save" class="primary">保存</button></div></div></div>
<div id="load-modal" class="modal"><div class="modal-box"><h3>保存した地点</h3><ul id="load-list"></ul><div class="actions"><button id="btn-close-load">閉じる</button></div></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/***********************
 * 設定
 ************************/
const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const PLACES_SEARCH_URL = `${GMAP_PROXY}/places:searchText`;
const DIRECTIONS_URL      = `${GMAP_PROXY}/maps/api/directions/json`;

let currentLang = 'ja';
let currentMode = 'shortest';
let watchId = null;
let headingDeg = 0;
let userMarker = null;
let destMarker = null;
let routeLayer = null;
let lastResults = [];
let isRecording = false;
const LS_SAVED = 'walknav_saved_locations';
const LS_HISTORY = 'walknav_hist';

/***********************
 * 地図
 ************************/
const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap', maxZoom: 19
}).addTo(map);
L.control.zoom({ position:'bottomleft' }).addTo(map);

/***********************
 * 要素
 ************************/
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const qInput = $('#q'), statusEl = $('#status'), resultsEl = $('#results'), resultsList = $('#results-list');
const btnVoice = $('#btn-voice'), btnSearch = $('#btn-search'), btnClearHistory = $('#btn-clear-history');
const btnCurrent = $('#btn-current'), btnDest = $('#btn-dest'), btnReroute = $('#btn-reroute');
const startLng = $('#start-lng'), startLat = $('#start-lat'), endLng = $('#end-lng'), endLat = $('#end-lat');
const btnSetDest = $('#btn-set-dest'), btnStart = $('#btn-start'), btnStop = $('#btn-stop');
const needle = $('#compass-needle');
const btnSave = $('#btn-save'), btnLoad = $('#btn-load');
const saveModal = $('#save-modal'), saveNameInput = $('#save-name'), btnCancelSave = $('#btn-cancel-save'), btnDoSave = $('#btn-do-save');
const loadModal = $('#load-modal'), loadList = $('#load-list'), btnCloseLoad = $('#btn-close-load');

/***********************
 * ツール
 ************************/
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function setStatus(msg){ statusEl.textContent = msg || ''; }
function asLatLng(lngInput, latInput){
  const lng = parseFloat(lngInput.value);
  const lat = parseFloat(latInput.value);
  if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng];
  return null;
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function langCodeToBCP47(l){
  const map = {ja:'ja-JP', en:'en-US', de:'de-DE', it:'it-IT', fr:'fr-FR', es:'es-ES', ko:'ko-KR', zh:'zh-CN'};
  return map[l] || 'ja-JP';
}
function decodePolyline(str){let index=0,lat=0,lng=0,coordinates=[];while(index<str.length){let b,shift=0,result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);let dlat=(result&1)?~(result>>1):(result>>1);lat+=dlat;shift=0;result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);let dlng=(result&1)?~(result>>1):(result>>1);lng+=dlng;coordinates.push([lat*1e-5,lng*1e-5])}return coordinates}

/***********************
 * 音声検索
 ************************/
let recog = null;
function ensureRecog(){
  if (recog) return recog;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return null;
  recog = new SR();
  recog.lang = langCodeToBCP47(currentLang);
  recog.interimResults = false;
  recog.continuous = false;
  recog.onstart = ()=> { isRecording=true; btnVoice.classList.add('recording'); setStatus('録音中…'); };
  recog.onend   = ()=> { isRecording=false; btnVoice.classList.remove('recording'); };
  recog.onerror = (e)=> { setStatus('音声認識エラー：' + e.error); };
  recog.onresult= (e)=> {
    const t = e.results[0][0].transcript;
    qInput.value = t;
    btnSearch.click(); // 認識完了で自動検索
  };
  return recog;
}
btnVoice.addEventListener('click', ()=> {
    const r=ensureRecog();
    if (r && !isRecording) r.start();
});

/***********************
 * UIイベント
 ************************/
// --- FIX 2: 言語ボタンの動作を修正 ---
$$('.lang-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    $$('.lang-btn').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    currentLang = b.dataset.lang;
    setStatus(`言語：${b.textContent}`);
    const r = ensureRecog();
    if (r) r.lang = langCodeToBCP47(currentLang);
  });
});

$$('.mode-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    $$('.mode-btn').forEach(x=>x.classList.remove('selected'));
    b.classList.add('selected');
    currentMode = b.dataset.mode;
    setStatus(`ルート：${b.textContent}`);
  });
});

/***********************
 * 現在地と方位
 ************************/
function getCurrentPosition(opts={}){
  return new Promise((res,rej)=>{
    navigator.geolocation.getCurrentPosition(res,rej,opts);
  });
}

async function updateUserLocation(){
  try {
    const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
    const { latitude, longitude } = p.coords;
    map.setView([latitude, longitude], 17);
    updateUserMarker(latitude, longitude);
    startLng.value = longitude.toFixed(6);
    startLat.value = latitude.toFixed(6);
    setStatus('現在地をセットしました');
  } catch(e) {
    setStatus('現在地エラー：'+e.message);
  }
}

function watchHeading(){
  if (watchId) return;
  watchId = navigator.geolocation.watchPosition(p=>{
    headingDeg = (p.coords.heading || 0);
    updateNeedle(headingDeg);
    updateUserMarker(p.coords.latitude, p.coords.longitude);
  }, ()=>{}, {enableHighAccuracy:true, maximumAge:3000, timeout:15000});
}
function updateNeedle(deg){
  needle.style.transform = `translate(-50%,-90%) rotate(${deg}deg)`;
}
function updateUserMarker(lat,lng){
  if (!userMarker){
    userMarker = L.marker([lat,lng], { title: '現在地' }).addTo(map);
  }else{
    userMarker.setLatLng([lat,lng]);
  }
}
btnCurrent.addEventListener('click', updateUserLocation);

/***********************
 * 検索ロジック
 ************************/
btnSearch.addEventListener('click', async ()=>{
  const text = qInput.value.trim();
  if (!text){ setStatus('検索ワードを入力'); return; }
  btnSearch.classList.add('loading');
  try{
    const resp = await fetch(PLACES_SEARCH_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ textQuery:text, languageCode: currentLang })
    });
    const data = await resp.json();
    lastResults = (data.places||[]).map(p=>({
      id: p.id,
      name: p.displayName?.text || p.name || '(no name)',
      address: p.formattedAddress || '',
      loc: p.location ? [p.location.latitude, p.location.longitude] : null
    }));
    renderResults(lastResults);
    showResults(true);
    addHistory(text);
    setStatus(`検索：${lastResults.length}件`);
  }catch(e){
    setStatus('検索失敗：'+e.message);
  }finally{
    btnSearch.classList.remove('loading');
  }
});

function renderResults(items){
  resultsList.innerHTML = '';
  if (!items.length){ resultsList.innerHTML = '<li>見つかりませんでした</li>'; return; }
  for (const r of items){
    const li = document.createElement('li');
    li.innerHTML = `<div><strong>${escapeHtml(r.name)}</strong></div><div style="opacity:.85">${escapeHtml(r.address)}</div>`;
    li.addEventListener('click', ()=>{
      if (r.loc){
        endLat.value = r.loc[0].toFixed(6);
        endLng.value = r.loc[1].toFixed(6);
        putDestMarker(r.loc[0], r.loc[1], r.name);
        showResults(false);
        btnStart.click(); // 自動でルート案内開始
      }
    });
    resultsList.appendChild(li);
  }
}
$('#btn-close-results').addEventListener('click', ()=> showResults(false));
function showResults(flag){ resultsEl.classList.toggle('show', !!flag); }

function putDestMarker(lat,lng,name){
  if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
  destMarker.setLatLng([lat,lng]).bindPopup(name||'目的地').openPopup();
  map.setView([lat,lng], 17);
}
btnSetDest.addEventListener('click', ()=>{
  const ll = asLatLng(endLng, endLat);
  if (!ll){ setStatus('目的地の緯度経度が不正'); return; }
  putDestMarker(ll[0], ll[1], '目的地');
  setStatus('目的地をセットしました');
});

/***********************
 * ルート取得・案内
 ************************/
btnStart.addEventListener('click', async ()=>{
  let start = asLatLng(startLng, startLat);
  const end   = asLatLng(endLng, endLat);
  if (!end){ setStatus('目的地の座標が不正です'); return; }
  if (!start){
    try {
      setStatus('開始地点が未設定のため現在地を取得…');
      const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
      startLat.value = p.coords.latitude.toFixed(6);
      startLng.value = p.coords.longitude.toFixed(6);
      start = [p.coords.latitude, p.coords.longitude];
    } catch(e) {
      setStatus('開始地点が未設定です'); return;
    }
  }

  setStatus('ルート取得中…'); btnStart.classList.add('loading');
  try{
    const url = new URL(DIRECTIONS_URL);
    url.searchParams.set('origin', `${start[0]},${start[1]}`);
    url.searchParams.set('destination', `${end[0]},${end[1]}`);
    url.searchParams.set('mode','walking');
    url.searchParams.set('language', currentLang);

    const resp = await fetch(url.toString());
    const data = await resp.json();
    if (data.status !== 'OK'){ throw new Error(data.error_message || data.status); }

    drawRoute(data);
    showResults(false);
    setStatus('案内を開始しました');
  }catch(e){
    setStatus('ルート取得エラー：'+e.message);
  }finally{
    btnStart.classList.remove('loading');
  }
});

function drawRoute(d){
  if (routeLayer){ routeLayer.remove(); routeLayer=null; }
  const path = decodePolyline(d.routes[0].overview_polyline.points);
  routeLayer = L.polyline(path, {color:'#22c55e', weight:7, opacity:.88}).addTo(map);
  const bounds = L.latLngBounds(path);
  map.fitBounds(bounds.pad(0.2));
}

btnStop.addEventListener('click', ()=>{
  if (routeLayer){ routeLayer.remove(); routeLayer=null; }
  setStatus('案内を停止しました');
  endLat.value=''; endLng.value='';
  if (destMarker){ destMarker.remove(); destMarker=null; }
});
btnReroute.addEventListener('click', ()=> btnStart.click());
btnDest.addEventListener('click', ()=>{
  const e = asLatLng(endLng, endLat);
  if (!e){ setStatus('目的地が未設定'); return; }
  map.setView([e[0], e[1]], 17);
});

/***********************
 * 保存・履歴
 ************************/
// (保存・履歴・モーダル関連のコードは変更なし)
const addHistory=(text)=>{const h=JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');h.unshift({t:Date.now(),text});localStorage.setItem(LS_HISTORY,JSON.stringify(h.slice(0,50)))};btnClearHistory.addEventListener('click',()=>{localStorage.removeItem(LS_HISTORY);endLat.value='';endLng.value='';if(destMarker){destMarker.remove();destMarker=null}setStatus('履歴をクリアしました')});btnSave.addEventListener('click',async()=>{try{setStatus('現在地を取得中...');const p=await getCurrentPosition({enableHighAccuracy:true,timeout:10000});const{latitude,longitude}=p.coords;saveModal.dataset.lat=latitude;saveModal.dataset.lng=longitude;saveNameInput.value='';saveModal.style.display='flex';saveNameInput.focus();setStatus('保存する場所の名前を入力してください')}catch(e){setStatus('保存失敗：現在地を取得できませんでした - '+e.message)}});btnDoSave.addEventListener('click',()=>{const name=saveNameInput.value.trim();if(!name){setStatus('名前を入力してください');return}const lat=parseFloat(saveModal.dataset.lat);const lng=parseFloat(saveModal.dataset.lng);const saved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');saved.unshift({name,lat,lng,t:Date.now()});localStorage.setItem(LS_SAVED,JSON.stringify(saved.slice(0,50)));saveModal.style.display='none';setStatus(`「${name}」を保存しました`)});btnCancelSave.addEventListener('click',()=>{saveModal.style.display='none'});btnLoad.addEventListener('click',()=>{renderSavedList();loadModal.style.display='flex'});btnCloseLoad.addEventListener('click',()=>{loadModal.style.display='none'});function renderSavedList(){const saved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');loadList.innerHTML='';if(saved.length===0){loadList.innerHTML='<li>保存された地点はありません</li>';return}saved.forEach((item,index)=>{const li=document.createElement('li');const nameSpan=document.createElement('span');nameSpan.className='name';nameSpan.textContent=item.name;const setDestBtn=document.createElement('button');setDestBtn.textContent='目的地に設定';setDestBtn.className='primary';setDestBtn.addEventListener('click',()=>{endLat.value=item.lat.toFixed(6);endLng.value=item.lng.toFixed(6);putDestMarker(item.lat,item.lng,item.name);loadModal.style.display='none';setStatus(`目的地を「${item.name}」に設定しました`);btnStart.click()});const deleteBtn=document.createElement('button');deleteBtn.textContent='削除';deleteBtn.className='danger';deleteBtn.addEventListener('click',()=>{if(confirm(`「${item.name}」を削除しますか？`)){const currentSaved=JSON.parse(localStorage.getItem(LS_SAVED)||'[]');const updatedSaved=currentSaved.filter((_,i)=>i!==index);localStorage.setItem(LS_SAVED,JSON.stringify(updatedSaved));renderSavedList()}});li.appendChild(nameSpan);li.appendChild(setDestBtn);li.appendChild(deleteBtn);loadList.appendChild(li)})}

/***********************
 * 初期化
 ************************/
// --- FIX 5: 起動時に現在地を自動で取得・表示 ---
async function initializeApp() {
  setStatus('現在地を取得中…');
  await updateUserLocation(); // 既存の関数を呼び出し
  watchHeading();
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
