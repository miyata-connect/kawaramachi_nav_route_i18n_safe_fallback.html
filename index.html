<!DOCTYPE html>  <html lang="ja">  
<head>  
Â Â <meta charset="utf-8">  
Â Â <meta name="viewport" content="width=device-width,initial-scale=1">  
Â Â <title>WalkNav v5</title>  
Â Â <style>  
:root{  
Â Â --glass: rgba(20,28,44,.7);  
Â Â --glass-strong: rgba(16,22,36,.85);  
Â Â --stroke: rgba(255,255,255,.14);  
Â Â --text: #eaf2ff;  
Â Â --muted:#a7b8ce;  
Â Â --primary:#5fb1ff;  
Â Â --ok:#25d07a;  
Â Â --danger:#ff6565;  
Â Â --accent:#64d2ff;  
}  
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}  
*{box-sizing:border-box}  
.app{position:relative;height:100dvh;overflow:hidden}  
#map{position:absolute;inset:0;display:none}  
.control-panel{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â bottom:0;  
Â Â z-index:500;  
Â Â background:var(--glass);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:16px 16px 0 0;  
Â Â backdrop-filter:blur(14px);  
Â Â padding:16px;  
Â Â transition:transform 0.3s;  
}  
.control-panel.hidden{transform:translateY(100%)}  
.panel-toggle{  
Â Â position:fixed;  
Â Â bottom:10px;  
Â Â left:50%;  
Â Â transform:translateX(-50%);  
Â Â background:var(--accent);  
Â Â border:none;  
Â Â border-radius:12px;  
Â Â padding:14px 40px;  
Â Â color:#000;  
Â Â font-size:15px;  
Â Â font-weight:700;  
Â Â cursor:pointer;  
Â Â z-index:490;  
Â Â display:none !important;  
Â Â box-shadow:0 4px 12px rgba(0,0,0,.3);  
}  
.panel-toggle.show{display:block}  
.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}  
.panel-btn{  
Â Â flex:1;  
Â Â min-width:120px;  
Â Â background:var(--glass-strong);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:10px;  
Â Â padding:10px;  
Â Â color:#fff;  
Â Â font-size:14px;  
Â Â text-align:center;  
Â Â cursor:pointer;  
Â Â font-weight:700;  
}  
.panel-btn.primary{background:var(--primary);border:none;color:#000}  
.panel-btn.recording{background:var(--danger);border:none;color:#fff}  
.panel-btn.danger{background:var(--danger);border:none;color:#fff}  
input,select{  
Â Â width:100%;  
Â Â background:var(--glass-strong);  
Â Â border:1px solid var(--stroke);  
Â Â color:var(--text);  
Â Â border-radius:10px;  
Â Â padding:10px;  
Â Â font-size:14px;  
}  
.info-panel{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â top:10px;  
Â Â background:var(--glass);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:12px;  
Â Â backdrop-filter:blur(14px);  
Â Â padding:14px 14px 18px 14px;  
Â Â z-index:460;  
Â Â color:var(--text);  
Â Â display:none;  
Â Â pointer-events:none;  
}  
.info-panel.show{display:block !important}  
.route-main{  
Â Â font-size:27px;  
Â Â font-weight:700;  
Â Â margin-bottom:10px;  
Â Â line-height:1.4;  
Â Â text-align:center;  
}  
.route-time{  
Â Â font-size:16px;  
Â Â color:var(--text);  
Â Â display:flex;  
Â Â gap:20px;  
Â Â font-weight:600;  
Â Â margin-bottom:12px;  
Â Â justify-content:center;  
}  
.route-time span{  
Â Â display:flex;  
Â Â align-items:center;  
Â Â gap:4px;  
}  
.weather-row{  
Â Â display:flex;  
Â Â align-items:center;  
Â Â justify-content:center;  
Â Â gap:10px;  
}  
.location-name{  
Â Â font-size:20px;  
Â Â font-weight:700;  
Â Â color:var(--primary);  
Â Â white-space:nowrap;  
}  
.weather-items{  
Â Â display:flex;  
Â Â gap:4px;  
Â Â flex:1;  
Â Â justify-content:center;  
Â Â align-items:center;  
}  
.weather-arrow{  
Â Â color:var(--muted);  
Â Â font-size:18px;  
Â Â font-weight:900;  
}  
.weather-item{  
Â Â text-align:center;  
Â Â font-size:11px;  
Â Â color:var(--text);  
Â Â padding:8px 6px;  
Â Â background:rgba(16,22,36,.25);  
Â Â border-radius:8px;  
Â Â min-width:60px;  
}  
.weather-time{  
Â Â font-size:12px;  
Â Â color:var(--muted);  
Â Â font-weight:700;  
Â Â margin-bottom:2px;  
}  
.weather-icon{font-size:20px;margin:2px 0}  
.weather-temp{font-weight:700;font-size:13px}  
.weather-rain{color:var(--accent);font-size:11px;font-weight:700}  
.right-buttons{  
Â Â position:absolute;  
Â Â right:10px;  
Â Â top:359px;  
Â Â z-index:470;  
Â Â display:flex;  
Â Â flex-direction:column;  
Â Â gap:10px;  
Â Â pointer-events:none;  
}  
.right-btn{  
Â Â width:65px;  
Â Â height:65px;  
Â Â background:rgba(16,22,36,.25);  
Â Â border:1px solid rgba(255,255,255,.3);  
Â Â border-radius:10px;  
Â Â color:#fff;  
Â Â font-size:11px;  
Â Â display:flex;  
Â Â flex-direction:column;  
Â Â align-items:center;  
Â Â justify-content:center;  
Â Â cursor:pointer;  
Â Â font-weight:700;  
Â Â gap:2px;  
Â Â pointer-events:auto;  
Â Â box-shadow:0 8px 32px rgba(0,0,0,.4);  
Â Â backdrop-filter:blur(24px) saturate(200%);  
Â Â -webkit-backdrop-filter:blur(24px) saturate(200%);  
}  
.right-btn.primary{background:rgba(95,177,255,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.right-btn.ok{background:rgba(37,208,122,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.right-btn.danger{background:rgba(255,101,101,.6);border:1px solid rgba(255,255,255,.4);color:#fff;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.right-btn.danger:disabled{opacity:1;background:rgba(255,101,101,.6);cursor:not-allowed;color:#fff;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.right-btn.accent{background:rgba(100,210,255,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.right-btn.warning{background:rgba(255,165,0,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}  
.map-controls{  
Â Â position:fixed;  
Â Â right:97px;  
Â Â bottom:25px;  
Â Â z-index:450;  
Â Â display:none;  
Â Â gap:8px;  
}  
.map-controls.show{  
Â Â display:flex;  
Â Â flex-direction:column;  
Â Â align-items:center;  
}  
.map-control-row{  
Â Â display:flex;  
Â Â gap:8px;  
}  
.map-control-btn{  
Â Â width:65px;  
Â Â height:65px;  
Â Â background:rgba(16,22,36,.85);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:10px;  
Â Â color:#fff;  
Â Â font-size:20px;  
Â Â cursor:pointer;  
Â Â font-weight:700;  
Â Â display:flex;  
Â Â align-items:center;  
Â Â justify-content:center;  
Â Â user-select:none;  
Â Â box-shadow:0 2px 6px rgba(0,0,0,.3);  
Â Â backdrop-filter:blur(6px);  
}  
.map-control-btn:active{  
Â Â background:var(--primary);  
}  
.results-panel{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â bottom:10px;  
Â Â max-height:60vh;  
Â Â overflow-y:auto;  
Â Â background:var(--glass);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:12px;  
Â Â padding:10px;  
Â Â z-index:510;  
Â Â display:none;  
}  
.result-item{  
Â Â padding:10px;  
Â Â border-bottom:1px solid var(--stroke);  
Â Â cursor:pointer;  
}  
.result-item:hover{background:rgba(95,177,255,.2)}  
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}  
.saved-points-panel{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â top:50%;  
Â Â transform:translateY(-50%);  
Â Â max-height:70vh;  
Â Â overflow-y:auto;  
Â Â background:var(--glass);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:12px;  
Â Â padding:10px;  
Â Â z-index:510;  
Â Â display:none;  
}  
.saved-point-item{  
Â Â padding:12px;  
Â Â background:var(--glass-strong);  
Â Â border:1px solid var(--stroke);  
Â Â border-radius:8px;  
Â Â margin-bottom:8px;  
Â Â cursor:pointer;  
Â Â font-size:14px;  
Â Â display:flex;  
Â Â justify-content:space-between;  
Â Â align-items:center;  
}  
.saved-point-item:hover{background:rgba(95,177,255,.3)}  
.saved-point-name{flex:1}  
.saved-point-actions{display:flex;gap:6px}  
.saved-point-btn{  
Â Â padding:4px 10px;  
Â Â background:var(--primary);  
Â Â border-radius:6px;  
Â Â font-size:12px;  
Â Â cursor:pointer;  
Â Â color:#000;  
Â Â font-weight:700;  
}  
.saved-point-btn.delete{background:var(--danger);color:#fff}  
.saved-close{text-align:center;padding:10px;color:var(--primary);cursor:pointer;font-weight:700}  
.error-banner{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â bottom:10px;  
Â Â background:var(--danger);  
Â Â color:#fff;  
Â Â border-radius:10px;  
Â Â padding:10px;  
Â Â text-align:center;  
Â Â z-index:999;  
}  
.success-banner{  
Â Â position:absolute;  
Â Â left:10px;  
Â Â right:10px;  
Â Â bottom:10px;  
Â Â background:#7ed321;  
Â Â color:#000;  
Â Â border-radius:10px;  
Â Â padding:10px;  
Â Â text-align:center;  
Â Â z-index:999;  
Â Â font-weight:700;  
}  
.hidden{display:none}  
.loading-screen{  
Â Â position:fixed;  
Â Â inset:0;  
Â Â background:#0e1a2d;  
Â Â display:flex;  
Â Â align-items:center;  
Â Â justify-content:center;  
Â Â z-index:1000;  
Â Â transition:opacity 0.3s;  
}  
.loading-screen.hide{opacity:0;pointer-events:none}  
.gm-control-active.gm-fullscreen-control {  
Â Â display: none !important;  
}  
.gm-svpc,  
.gm-style .gm-style-cc {  
Â Â display: none !important;  
}  
.gm-style-iw,  
.gm-style-iw-c,  
.gm-style-iw-d,  
.gm-style-iw-t::after,  
div[aria-label*="ä»˜è¿‘"],  
div[aria-label*="ç¾é¦¬éƒ¡"],  
div[title*="ä»˜è¿‘"] {  
Â Â display: none !important;  
Â Â opacity: 0 !important;  
Â Â visibility: hidden !important;  
}  
@keyframes marquee {  
Â Â 0% {  
Â Â Â Â transform: translateX(100%);  
Â Â }  
Â Â 100% {  
Â Â Â Â transform: translateX(-100%);  
Â Â }  
}  
Â Â </style>  
</head>  
<body>  
Â Â <div class="app">  
Â Â Â Â <div id="map"></div>  
Â Â Â Â   
Â Â Â Â <div id="infoPanel" class="info-panel">  
Â Â Â Â Â Â <div class="route-main">  
Â Â Â Â Â Â Â Â <div id="routeText">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>  
Â Â Â Â Â Â Â Â <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:6px;font-weight:600;">åŠå¾„5kmåœå†…ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>  
Â Â Â Â Â Â Â Â <div id="incidentMarquee" style="background:rgba(255,101,101,.2);border-radius:6px;padding:2px 8px;margin-top:6px;overflow:hidden;white-space:nowrap;height:24px;display:flex;align-items:center;">  
Â Â Â Â Â Â Â Â Â Â <div id="incidentText" style="display:inline-block;font-size:18px;color:#ff6565;">  
Â Â Â Â Â Â Â Â Â Â Â Â ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã•ã‚Œã¦ã„ã‚‹äº‹ä»¶ã€äº‹æ•…ã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚  
Â Â Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div class="route-time">  
Â Â Â Â Â Â Â Â <span><span id="timeLabel" style="display:inline-block;line-height:1.2;">ç¾åœ¨<br>æ™‚åˆ»</span> <span id="currentTime" style="font-size:20px;">--:--</span></span>  
Â Â Â Â Â Â Â Â <span><span id="arrivalLabel" style="display:inline-block;line-height:1.2;">åˆ°ç€<br>äºˆæƒ³</span> <span id="arrivalTime" style="font-size:20px;">--:--</span></span>  
Â Â Â Â Â Â Â Â <span><span style="display:inline-block;line-height:1.2;">æ‰€è¦<br>æ™‚é–“</span> <span id="durationTime" style="font-size:20px;">--:--</span></span>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div style="text-align:center;margin-bottom:8px;">  
Â Â Â Â Â Â Â Â <div id="locationName" class="location-name">èª­ã¿è¾¼ã¿ä¸­...</div>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div class="weather-row">  
Â Â Â Â Â Â Â Â <div class="weather-items">  
Â Â Â Â Â Â Â Â Â Â <div class="weather-item">  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-time">3H</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-icon" id="w3h">â˜ï¸</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-temp" id="t3h">--Â°</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-rain" id="r3h">--%</div>  
Â Â Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-arrow">â†’</div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-item">  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-time">6H</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-icon" id="w6h">â˜ï¸</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-temp" id="t6h">--Â°</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-rain" id="r6h">--%</div>  
Â Â Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-arrow">â†’</div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-item">  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-time">9H</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-icon" id="w9h">â˜ï¸</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-temp" id="t9h">--Â°</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-rain" id="r9h">--%</div>  
Â Â Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-arrow">â†’</div>  
Â Â Â Â Â Â Â Â Â Â <div class="weather-item">  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-time">12H</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-icon" id="w12h">â˜ï¸</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-temp" id="t12h">--Â°</div>  
Â Â Â Â Â Â Â Â Â Â Â Â <div class="weather-rain" id="r12h">--%</div>  
Â Â Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â Â Â </div>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div id="coordsDisplay" style="text-align:center;font-size:17px;color:var(--muted);margin-top:8px;font-weight:600;cursor:pointer;pointer-events:auto;" onclick="copyCoordinates(event)">ğŸ“ ç·¯åº¦: -- / çµŒåº¦: --</div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="mapControls" class="map-controls">  
Â Â Â Â Â Â <div class="map-control-row">  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();panUp()">â†‘</div>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div class="map-control-row">  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();panLeft()">â†</div>  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();zoomIn()">+</div>  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();zoomOut()">âˆ’</div>  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();panRight()">â†’</div>  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div class="map-control-row">  
Â Â Â Â Â Â Â Â <div class="map-control-btn" onclick="event.preventDefault();panDown()">â†“</div>  
Â Â Â Â Â Â </div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="panelToggle" class="panel-toggle" onclick="togglePanel()"><span id="btnOpenPanel">æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º</span></div>  
Â Â Â Â   
Â Â Â Â <div id="controlPanel" class="control-panel hidden">  
Â Â Â Â Â Â <div class="panel-row">  
Â Â Â Â Â Â Â Â <input type="text" id="searchBox" placeholder="å ´æ‰€ã‚’æ¤œç´¢..." />  
Â Â Â Â Â Â </div>  
Â Â Â Â Â Â <div class="panel-row">  
Â Â Â Â Â Â Â Â <button class="panel-btn primary" onclick="executeSearch()">æ¤œç´¢</button>  
Â Â Â Â Â Â Â Â <button class="panel-btn" onclick="document.getElementById('controlPanel').classList.add('hidden')">é–‰ã˜ã‚‹</button>  
Â Â Â Â Â Â </div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="resultsPanel" class="results-panel">  
Â Â Â Â Â Â <div id="resultsList"></div>  
Â Â Â Â Â Â <div class="result-close" onclick="hideResults()"><span id="btnCloseResults">é–‰ã˜ã‚‹</span></div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="routeSelectModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;">  
Â Â Â Â Â Â <div style="background:var(--glass-strong);border-radius:16px;padding:24px;width:80%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">  
Â Â Â Â Â Â Â Â <h2 style="color:#fff;text-align:center;margin-bottom:20px;font-size:20px;">ãƒ«ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h2>  
Â Â Â Â Â Â Â Â <button onclick="selectRouteType('fastest')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--primary);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â âš¡ æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â Â Â <button onclick="selectRouteType('easy')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--ok);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â ğŸŒ¿ æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â Â Â <button onclick="closeRouteSelectModal()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â ã‚­ãƒ£ãƒ³ã‚»ãƒ«  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â </div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="searchTypeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;">  
Â Â Â Â Â Â <div style="background:var(--glass-strong);border-radius:16px;padding:24px;width:80%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">  
Â Â Â Â Â Â Â Â <h2 style="color:#fff;text-align:center;margin-bottom:20px;font-size:20px;">æ¤œç´¢æ–¹æ³•ã‚’é¸æŠ</h2>  
Â Â Â Â Â Â Â Â <button onclick="selectSearchType('text')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--primary);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â âŒ¨ï¸ æ‰‹å…¥åŠ›æ¤œç´¢  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â Â Â <button onclick="selectSearchType('voice')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--accent);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â ğŸ¤ éŸ³å£°æ¤œç´¢  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â Â Â <button onclick="closeSearchTypeModal()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">  
Â Â Â Â Â Â Â Â Â Â ã‚­ãƒ£ãƒ³ã‚»ãƒ«  
Â Â Â Â Â Â Â Â </button>  
Â Â Â Â Â Â </div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="savedPointsPanel" class="saved-points-panel">  
Â Â Â Â Â Â <div id="savedPointsList"></div>  
Â Â Â Â Â Â <div class="saved-close" onclick="hideSavedPoints()"><span id="btnCloseSaved">é–‰ã˜ã‚‹</span></div>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="error" class="error-banner hidden"></div>  
Â Â Â Â <div id="success" class="success-banner hidden"></div>  
Â Â Â Â   
Â Â Â Â <div id="rightButtons" class="right-buttons">  
Â Â Â Â Â Â <button class="right-btn accent" onclick="zoomToCurrentLocation()" title="ç¾åœ¨åœ°ã‚’æ‹¡å¤§è¡¨ç¤º">  
Â Â Â Â Â Â Â Â <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <circle cx="12" cy="12" r="3" fill="currentColor"/>  
Â Â Â Â Â Â Â Â Â Â <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M12 2V6M12 18V22M22 12H18M6 12H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;">ç¾åœ¨åœ°</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â Â Â <button class="right-btn primary" onclick="showSearchTypeModal()" title="æ¤œç´¢">  
Â Â Â Â Â Â Â Â <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M20 20L15.5 15.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;">æ¤œç´¢</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â Â Â <button class="right-btn danger" id="stopNavBtn" onclick="stopNav()" title="æ¡ˆå†…åœæ­¢" disabled>  
Â Â Â Â Â Â Â Â <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <rect x="6" y="5" width="4" height="14" stroke="#000" stroke-width="2" fill="none"/>  
Â Â Â Â Â Â Â Â Â Â <rect x="14" y="5" width="4" height="14" stroke="#000" stroke-width="2" fill="none"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;color:#000;">æ¡ˆå†…åœæ­¢</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â Â Â <button class="right-btn warning" onclick="zoomToDestination()" title="ç›®çš„åœ°ã‚’æ‹¡å¤§è¡¨ç¤º">  
Â Â Â Â Â Â Â Â <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <path d="M12 2L12 12M12 12L8 8M12 12L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M12 12C12 15.866 8.866 19 5 19C5 19 3 17 3 12C3 8.134 5 2 12 2C19 2 21 8.134 21 12C21 17 19 19 19 19C15.134 19 12 15.866 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;">ç›®çš„åœ°</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â Â Â <button class="right-btn ok" onclick="showRouteSelectModal('reroute')" title="ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—">  
Â Â Â Â Â Â Â Â <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <path d="M17 1L21 5L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M3 11V9C3 6.79086 4.79086 5 7 5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M7 23L3 19L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M21 13V15C21 17.2091 19.2091 19 17 19H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;">ãƒªãƒ«ãƒ¼ãƒˆ</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â Â Â <button class="right-btn accent" onclick="toggleMapControls()" title="åœ°å›³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«">  
Â Â Â Â Â Â Â Â <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â Â Â <path d="M16 4 L16 10 M16 4 L13 7 M16 4 L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M16 28 L16 22 M16 28 L13 25 M16 28 L19 25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M4 16 L10 16 M4 16 L7 13 M4 16 L7 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M28 16 L22 16 M28 16 L25 13 M28 16 L25 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>  
Â Â Â Â Â Â Â Â Â Â <circle cx="16" cy="16" r="4" fill="currentColor"/>  
Â Â Â Â Â Â Â Â Â Â <path d="M14 16 L18 16 M16 14 L16 18" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>  
Â Â Â Â Â Â Â Â </svg>  
Â Â Â Â Â Â Â Â <span style="font-size:10px;margin-top:2px;">æ“ä½œ</span>  
Â Â Â Â Â Â </button>  
Â Â Â Â </div>  
Â Â Â Â   
Â Â Â Â <div id="loading" class="loading-screen">  
Â Â Â Â Â Â <div style="text-align:center">  
Â Â Â Â Â Â Â Â <div style="font-size:18px;margin-bottom:10px" id="loadingText">ç¾åœ¨åœ°å–å¾—ä¸­...</div>  
Â Â Â Â Â Â Â Â <div style="font-size:14px;color:var(--muted)" id="loadingWait">ã‚‚ã†ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>  
Â Â Â Â Â Â </div>  
Â Â Â Â </div>  
Â Â </div>  
Â Â   
Â Â <script>  
"use strict";  
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=!1,currentLocation=null,savedPoints=[],selectingMapPoint=!1,stopAnnounced=!1,currentLang="ja";  
const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";  
const translations={  
Â Â ja:{  
Â Â Â Â setDestination:"ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„",  
Â Â Â Â currentTime:"ç¾åœ¨æ™‚åˆ»",  
Â Â Â Â arrivalTime:"åˆ°ç€äºˆæƒ³æ™‚åˆ»",  
Â Â Â Â loading:"èª­ã¿è¾¼ã¿ä¸­...",  
Â Â Â Â btnClosePanel:"æ“ä½œãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹",  
Â Â Â Â btnOpenPanel:"æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º",  
Â Â Â Â btnCloseResults:"é–‰ã˜ã‚‹",  
Â Â Â Â btnCloseSaved:"é–‰ã˜ã‚‹",  
Â Â Â Â loadingText:"ç¾åœ¨åœ°å–å¾—ä¸­...",  
Â Â Â Â loadingWait:"ã‚‚ã†ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚",  
Â Â Â Â navStart:"æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚",  
Â Â Â Â navStop:"æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚",  
Â Â Â Â edit:"ç·¨é›†",  
Â Â Â Â delete:"å‰Šé™¤"  
Â Â },  
Â Â en:{  
Â Â Â Â setDestination:"Please set destination",  
Â Â Â Â currentTime:"Current",  
Â Â Â Â arrivalTime:"Arrival",  
Â Â Â Â loading:"Loading...",  
Â Â Â Â btnClosePanel:"Close Panel",  
Â Â Â Â btnOpenPanel:"Show Panel",  
Â Â Â Â btnCloseResults:"Close",  
Â Â Â Â btnCloseSaved:"Close",  
Â Â Â Â loadingText:"Getting location...",  
Â Â Â Â loadingWait:"Please wait.",  
Â Â Â Â navStart:"Starting navigation.",  
Â Â Â Â navStop:"Navigation stopped.",  
Â Â Â Â edit:"Edit",  
Â Â Â Â delete:"Delete"  
Â Â }  
};  
function updateAllTexts(){  
Â Â const t=translations[currentLang];  
Â Â document.getElementById("loadingText").textContent=t.loadingText;  
Â Â document.getElementById("loadingWait").textContent=t.loadingWait;  
}  
function togglePanel(){}  
function hideAllElements(){  
Â Â document.getElementById("resultsPanel").style.display="none";  
Â Â document.getElementById("savedPointsPanel").style.display="none";  
Â Â document.getElementById("mapControls").classList.remove("show");  
}  
function showAllElements(){}  
function toggleMapControls(){  
Â Â const controls=document.getElementById("mapControls");  
Â Â controls.classList.toggle("show");  
}  
function panUp(){  
Â Â const center=map.getCenter();  
Â Â map.panTo({lat:center.lat()+0.001,lng:center.lng()});  
}  
function panDown(){  
Â Â const center=map.getCenter();  
Â Â map.panTo({lat:center.lat()-0.001,lng:center.lng()});  
}  
function panLeft(){  
Â Â const center=map.getCenter();  
Â Â map.panTo({lat:center.lat(),lng:center.lng()-0.001});  
}  
function panRight(){  
Â Â const center=map.getCenter();  
Â Â map.panTo({lat:center.lat(),lng:center.lng()+0.001});  
}  
function zoomIn(){  
Â Â map.setZoom(map.getZoom()+1);  
}  
function zoomOut(){  
Â Â map.setZoom(map.getZoom()-1);  
}  
window.gm_authFailure=()=>alert("Maps API Error");  
function initMap(){  
Â Â if(!navigator.geolocation)return alert("Geolocation not supported");  
Â Â   
Â Â const urlParams=new URLSearchParams(window.location.search);  
Â Â currentLang=urlParams.get('lang')||'ja';  
Â Â updateAllTexts();  
Â Â   
Â Â navigator.geolocation.getCurrentPosition(pos=>{  
Â Â Â Â currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};  
Â Â Â Â   
Â Â Â Â map=new google.maps.Map(document.getElementById("map"),{  
Â Â Â Â Â Â center:currentLocation,  
Â Â Â Â Â Â zoom:17,  
Â Â Â Â Â Â mapTypeControl:false,  
Â Â Â Â Â Â streetViewControl:false,  
Â Â Â Â Â Â fullscreenControl:false,  
Â Â Â Â Â Â zoomControl:false,  
Â Â Â Â Â Â rotateControl:false,  
Â Â Â Â Â Â scaleControl:false,  
Â Â Â Â Â Â gestureHandling:'greedy',  
Â Â Â Â Â Â clickableIcons:false,  
Â Â Â Â Â Â disableDefaultUI: true  
Â Â Â Â });  
Â Â Â Â   
Â Â Â Â directionsService=new google.maps.DirectionsService;  
Â Â Â Â directionsRenderer=new google.maps.DirectionsRenderer({map});  
Â Â Â Â   
Â Â Â Â // ç«‹ä½“çš„ãª3Dãƒ”ãƒ³å‹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆèµ¤è‰²ï¼‰  
Â Â Â Â // SVGã§ç«‹ä½“æ„Ÿã®ã‚ã‚‹ãƒ”ãƒ³ã‚’æç”»  
Â Â Â Â const pinSvg = `  
Â Â Â Â Â Â <svg width="40" height="60" viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">  
Â Â Â Â Â Â Â Â <defs>  
Â Â Â Â Â Â Â Â Â Â <linearGradient id="pinGradient" x1="0%" y1="0%" x2="100%" y2="100%">  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="0%" style="stop-color:#ff6565;stop-opacity:1" />  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="50%" style="stop-color:#ff4444;stop-opacity:1" />  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="100%" style="stop-color:#dd2222;stop-opacity:1" />  
Â Â Â Â Â Â Â Â Â Â </linearGradient>  
Â Â Â Â Â Â Â Â Â Â <radialGradient id="innerGlow" cx="50%" cy="40%">  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.8" />  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="50%" style="stop-color:#ff8888;stop-opacity:0.5" />  
Â Â Â Â Â Â Â Â Â Â Â Â <stop offset="100%" style="stop-color:#ff4444;stop-opacity:0" />  
Â Â Â Â Â Â Â Â Â Â </radialGradient>  
Â Â Â Â Â Â Â Â Â Â <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">  
Â Â Â Â Â Â Â Â Â Â Â Â <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>  
Â Â Â Â Â Â Â Â Â Â Â Â <feOffset dx="1" dy="3" result="offsetblur"/>  
Â Â Â Â Â Â Â Â Â Â Â Â <feComponentTransfer>  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <feFuncA type="linear" slope="0.3"/>  
Â Â Â Â Â Â Â Â Â Â Â Â </feComponentTransfer>  
Â Â Â Â Â Â Â Â Â Â Â Â <feMerge>  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <feMergeNode/>  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â <feMergeNode in="SourceGraphic"/>  
Â Â Â Â Â Â Â Â Â Â Â Â </feMerge>  
Â Â Â Â Â Â Â Â Â Â </filter>  
Â Â Â Â Â Â Â Â </defs>  
Â Â Â Â Â Â Â Â <!-- å½± -->  
Â Â Â Â Â Â Â Â <ellipse cx="20" cy="56" rx="8" ry="3" fill="rgba(0,0,0,0.2)"/>  
Â Â Â Â Â Â Â Â <!-- ãƒ”ãƒ³ã®æœ¬ä½“ -->  
Â Â Â Â Â Â Â Â <g filter="url(#shadow)">  
Â Â Â Â Â Â Â Â Â Â <path d="M20 5 C12 5 5 12 5 20 C5 28 12 35 20 50 C28 35 35 28 35 20 C35 12 28 5 20 5 Z"Â   
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fill="url(#pinGradient)"Â   
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â stroke="#ffffff"Â   
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â stroke-width="1.5"/>  
Â Â Â Â Â Â Â Â Â Â <!-- ãƒã‚¤ãƒ©ã‚¤ãƒˆåŠ¹æœ -->  
Â Â Â Â Â Â Â Â Â Â <ellipse cx="16" cy="15" rx="6" ry="8" fill="url(#innerGlow)" opacity="0.6"/>  
Â Â Â Â Â Â Â Â Â Â <!-- ä¸­å¿ƒã®ç©´ -->  
Â Â Â Â Â Â Â Â Â Â <circle cx="20" cy="20" r="6" fill="#330000" opacity="0.7"/>  
Â Â Â Â Â Â Â Â Â Â <circle cx="20" cy="20" r="4" fill="#1a0000" opacity="0.9"/>  
Â Â Â Â Â Â Â Â </g>  
Â Â Â Â Â Â </svg>  
Â Â Â Â `;  
Â Â Â Â   
Â Â Â Â currentMarker=new google.maps.Marker({  
Â Â Â Â Â Â position:currentLocation,  
Â Â Â Â Â Â map:map,  
Â Â Â Â Â Â icon:{  
Â Â Â Â Â Â Â Â url:'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(pinSvg),  
Â Â Â Â Â Â Â Â scaledSize:new google.maps.Size(40, 60),  
Â Â Â Â Â Â Â Â anchor:new google.maps.Point(20, 55)  
Â Â Â Â Â Â },  
Â Â Â Â Â Â zIndex:1000,  
Â Â Â Â Â Â optimized:false  
Â Â Â Â });  
Â Â Â Â   
Â Â Â Â // å¼·èª¿ã•ã‚ŒãŸãƒ‘ãƒ«ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆèµ¤è‰²ã€ãƒ•ãƒ©ãƒƒã‚·ãƒ¥æŠ‘åˆ¶ç‰ˆï¼‰  
Â Â Â Â const pulseMarker=new google.maps.Marker({  
Â Â Â Â Â Â position:currentLocation,  
Â Â Â Â Â Â map:map,  
Â Â Â Â Â Â icon:{  
Â Â Â Â Â Â Â Â path:google.maps.SymbolPath.CIRCLE,  
Â Â Â Â Â Â Â Â scale:20,  
Â Â Â Â Â Â Â Â fillColor:"#ff6565",  
Â Â Â Â Â Â Â Â fillOpacity:0.25,  
Â Â Â Â Â Â Â Â strokeColor:"#ff6565",  
Â Â Â Â Â Â Â Â strokeWeight:2,  
Â Â Â Â Â Â Â Â strokeOpacity:0.5  
Â Â Â Â Â Â },  
Â Â Â Â Â Â zIndex:999  
Â Â Â Â });  
Â Â Â Â   
Â Â Â Â // æ»‘ã‚‰ã‹ãªãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ•ãƒ©ãƒƒã‚·ãƒ¥æŠ‘åˆ¶ï¼‰  
Â Â Â Â let pulseScale=20;  
Â Â Â Â let pulseGrowing=true;  
Â Â Â Â setInterval(()=>{  
Â Â Â Â Â Â if(pulseGrowing){  
Â Â Â Â Â Â Â Â pulseScale+=0.4;  
Â Â Â Â Â Â Â Â if(pulseScale>=30){  
Â Â Â Â Â Â Â Â Â Â pulseGrowing=false;  
Â Â Â Â Â Â Â Â }  
Â Â Â Â Â Â }else{  
Â Â Â Â Â Â Â Â pulseScale-=0.4;  
Â Â Â Â Â Â Â Â if(pulseScale<=20){  
Â Â Â Â Â Â Â Â Â Â pulseGrowing=true;  
Â Â Â Â Â Â Â Â }  
Â Â Â Â Â Â }  
Â Â Â Â Â Â // é€æ˜åº¦ã®å¤‰åŒ–ã‚’ç·©ã‚„ã‹ã«ï¼ˆæœ€å°0.15ã€æœ€å¤§0.25ï¼‰  
Â Â Â Â Â Â const opacity=0.25-((pulseScale-20)/50);  
Â Â Â Â Â Â const strokeOpacity=0.5-((pulseScale-20)/40);  
Â Â Â Â Â Â pulseMarker.setIcon({  
Â Â Â Â Â Â Â Â path:google.maps.SymbolPath.CIRCLE,  
Â Â Â Â Â Â Â Â scale:pulseScale,  
Â Â Â Â Â Â Â Â fillColor:"#ff6565",  
Â Â Â Â Â Â Â Â fillOpacity:opacity,  
Â Â Â Â Â Â Â Â strokeColor:"#ff6565",  
Â Â Â Â Â Â Â Â strokeWeight:2,  
Â Â Â Â Â Â Â Â strokeOpacity:strokeOpacity  
Â Â Â Â Â Â });  
Â Â Â Â },60);  
Â Â Â Â   
Â Â Â Â // ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚‚ä½ç½®æ›´æ–°ã§ãã‚‹ã‚ˆã†ã«ä¿å­˜  
Â Â Â Â window.pulseMarker=pulseMarker;  
Â Â Â Â   
Â Â Â Â document.getElementById("map").style.display="block";  
Â Â Â Â document.getElementById("loading").classList.add("hide");  
Â Â Â Â   
Â Â Â Â loadSavedPoints();  
Â Â Â Â   
Â Â Â Â setTimeout(()=>{  
Â Â Â Â Â Â const infoPanel=document.getElementById("infoPanel");  
Â Â Â Â Â Â const panelToggle=document.getElementById("panelToggle");  
Â Â Â Â Â Â   
Â Â Â Â Â Â if(infoPanel)infoPanel.classList.add("show");  
Â Â Â Â Â Â if(panelToggle)panelToggle.classList.add("show");  
Â Â Â Â Â Â   
Â Â Â Â Â Â updateCurrentTime();  
Â Â Â Â Â Â setInterval(updateCurrentTime, 60000);  
Â Â Â Â Â Â   
Â Â Â Â Â Â updateCoords();  
Â Â Â Â Â Â   
Â Â Â Â Â Â fetchLocationName();  
Â Â Â Â Â Â fetchWeather();  
Â Â Â Â Â Â   
Â Â Â Â Â Â // åˆæœŸè¡¨ç¤ºæ™‚ã«ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’æƒ…å ±ãƒ‘ãƒãƒ«ã®ä¸‹ã®è¦‹ãˆã‚‹ç¯„å›²ã«è¡¨ç¤º  
Â Â Â Â Â Â // å³ã¸25pxã€ä¸Šã¸25pxèª¿æ•´  
Â Â Â Â Â Â const offsetY = window.innerHeight * 0.25 - 25;  
Â Â Â Â Â Â const offsetX = 60 - 25;  
Â Â Â Â Â Â map.panBy(offsetX, -offsetY);  
Â Â Â Â },100);  
Â Â Â Â   
Â Â Â Â startWatch();  
Â Â },err=>alert("Location error: "+err.message));  
}  
function startWatch(){  
Â Â watchId&&navigator.geolocation.clearWatch(watchId);  
Â Â watchId=navigator.geolocation.watchPosition(pos=>{  
Â Â Â Â currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};  
Â Â Â Â   
Â Â Â Â // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã®ä½ç½®ã‚’æ›´æ–°  
Â Â Â Â if(currentMarker){  
Â Â Â Â Â Â currentMarker.setPosition(currentLocation);  
Â Â Â Â }  
Â Â Â Â if(window.pulseMarker){  
Â Â Â Â Â Â window.pulseMarker.setPosition(currentLocation);  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â updateCoords();  
Â Â Â Â   
Â Â Â Â isNavigating&&reroute(!1);  
Â Â },()=>{},{enableHighAccuracy:!0});  
}  
function updateCoords(){  
Â Â if(!currentLocation)return;  
Â Â const lat=currentLocation.lat.toFixed(6);  
Â Â const lng=currentLocation.lng.toFixed(6);  
Â Â const coordsEl=document.getElementById("coordsDisplay");  
Â Â if(coordsEl){  
Â Â Â Â coordsEl.textContent=`ğŸ“ ç·¯åº¦: ${lat} / çµŒåº¦: ${lng}`;  
Â Â }  
}  
function copyCoordinates(event){  
Â Â if(event){  
Â Â Â Â event.preventDefault();  
Â Â Â Â event.stopPropagation();  
Â Â }  
Â Â   
Â Â if(!currentLocation)return;  
Â Â   
Â Â const lat=currentLocation.lat.toFixed(6);  
Â Â const lng=currentLocation.lng.toFixed(6);  
Â Â const coordsText=`${lat}, ${lng}`;  
Â Â   
Â Â if(navigator.clipboard && navigator.clipboard.writeText){  
Â Â Â Â navigator.clipboard.writeText(coordsText).then(()=>{  
Â Â Â Â Â Â showSuccess("ç·¯åº¦çµŒåº¦ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");  
Â Â Â Â }).catch(()=>{  
Â Â Â Â Â Â fallbackCopy(coordsText);  
Â Â Â Â });  
Â Â }else{  
Â Â Â Â fallbackCopy(coordsText);  
Â Â }  
}  
function fallbackCopy(text){  
Â Â const textarea=document.createElement("textarea");  
Â Â textarea.value=text;  
Â Â textarea.style.position="fixed";  
Â Â textarea.style.opacity="0";  
Â Â document.body.appendChild(textarea);  
Â Â textarea.select();  
Â Â try{  
Â Â Â Â document.execCommand("copy");  
Â Â Â Â showSuccess("ç·¯åº¦çµŒåº¦ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");  
Â Â }catch(e){  
Â Â Â Â showError("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ");  
Â Â }  
Â Â document.body.removeChild(textarea);  
}  
let pendingRouteAction=null;  
let selectedRouteType="fastest";  
function showRouteSelectModal(action){  
Â Â pendingRouteAction=action;  
Â Â const modal=document.getElementById("routeSelectModal");  
Â Â if(modal){  
Â Â Â Â modal.style.display="flex";  
Â Â }  
}  
function closeRouteSelectModal(){  
Â Â const modal=document.getElementById("routeSelectModal");  
Â Â if(modal){  
Â Â Â Â modal.style.display="none";  
Â Â }  
Â Â pendingRouteAction=null;  
}  
function selectRouteType(type){  
Â Â selectedRouteType=type;  
Â Â const routeName=type==="fastest"?"æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ":"æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ";  
Â Â speak(`${routeName}ã‚’é¸æŠã—ã¾ã—ãŸ`);  
Â Â closeRouteSelectModal();  
Â Â   
Â Â if(pendingRouteAction==="search"){  
Â Â Â Â executeSearch();  
Â Â }else if(pendingRouteAction==="reroute"){  
Â Â Â Â executeReroute();  
Â Â }  
}  
function executeReroute(){  
Â Â if(!isNavigating){  
Â Â Â Â speak("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");  
Â Â Â Â showError("ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â const routeName=selectedRouteType==="fastest"?"æœ€çŸ­AIãƒ«ãƒ¼ãƒˆ":"æ¥½ãƒãƒ³AIãƒ«ãƒ¼ãƒˆ";  
Â Â speak(`${routeName}ã‚’è¨ˆç®—ä¸­`);  
Â Â   
Â Â directionsService.route({  
Â Â Â Â origin:currentLocation,  
Â Â Â Â destination:destMarker.getPosition(),  
Â Â Â Â travelMode:google.maps.TravelMode.WALKING,  
Â Â Â Â provideRouteAlternatives:!0,  
Â Â Â Â avoidHighways:selectedRouteType==="easy"?!0:Math.random()>0.5  
Â Â },(res,status)=>{  
Â Â Â Â if(status!=="OK")return showError("Reroute failed");  
Â Â Â Â   
Â Â Â Â const routes=res.routes;  
Â Â Â Â let selectedRoute=routes[0];  
Â Â Â Â   
Â Â Â Â if(selectedRouteType==="easy"&&routes.length>1){  
Â Â Â Â Â Â selectedRoute=routes.sort((a,b)=>{  
Â Â Â Â Â Â Â Â const elevA=a.legs[0].elevation||0;  
Â Â Â Â Â Â Â Â const elevB=b.legs[0].elevation||0;  
Â Â Â Â Â Â Â Â return elevA-elevB;  
Â Â Â Â Â Â })[0];  
Â Â Â Â }else if(routes.length>1){  
Â Â Â Â Â Â const altIndex=Math.floor(Math.random()*(routes.length-1))+1;  
Â Â Â Â Â Â selectedRoute=routes[altIndex];  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â directionsRenderer.setDirections({...res,routes:[selectedRoute]});  
Â Â Â Â   
Â Â Â Â const leg=selectedRoute.legs[0];  
Â Â Â Â const dist=(leg.distance.value/1000).toFixed(1);  
Â Â Â Â const dur=Math.round(leg.duration.value/60);  
Â Â Â Â   
Â Â Â Â const routeText=`${dist}km, ${dur}min`;  
Â Â Â Â const routeTextEl=document.getElementById("routeText");  
Â Â Â Â if(routeTextEl){  
Â Â Â Â Â Â routeTextEl.textContent=routeText;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â const now=new Date();  
Â Â Â Â const arrival=new Date(now.getTime()+leg.duration.value*1000);  
Â Â Â Â   
Â Â Â Â const currentTimeEl=document.getElementById("currentTime");  
Â Â Â Â const arrivalTimeEl=document.getElementById("arrivalTime");  
Â Â Â Â const durationTimeEl=document.getElementById("durationTime");  
Â Â Â Â   
Â Â Â Â if(currentTimeEl){  
Â Â Â Â Â Â currentTimeEl.textContent=formatTime(now);  
Â Â Â Â }  
Â Â Â Â if(arrivalTimeEl){  
Â Â Â Â Â Â arrivalTimeEl.textContent=formatTime(arrival);  
Â Â Â Â }  
Â Â Â Â if(durationTimeEl){  
Â Â Â Â Â Â const hours=Math.floor(dur/60);  
Â Â Â Â Â Â const mins=dur%60;  
Â Â Â Â Â Â durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â speak("Rerouting");  
Â Â });  
}  
function showSearchTypeModal(){  
Â Â const modal=document.getElementById("searchTypeModal");  
Â Â if(modal){  
Â Â Â Â modal.style.display="flex";  
Â Â }  
}  
function closeSearchTypeModal(){  
Â Â const modal=document.getElementById("searchTypeModal");  
Â Â if(modal){  
Â Â Â Â modal.style.display="none";  
Â Â }  
}  
function selectSearchType(type){  
Â Â closeSearchTypeModal();  
Â Â if(type==="text"){  
Â Â Â Â showSearchPanel();  
Â Â }else if(type==="voice"){  
Â Â Â Â speak("éŸ³å£°æ¤œç´¢ã‚’é–‹å§‹ã—ã¾ã™");  
Â Â Â Â voiceSearch();  
Â Â }  
}  
function showSearchPanel(){  
Â Â speak("æ¤œç´¢ãƒ‘ãƒãƒ«ã‚’é–‹ãã¾ã™");  
Â Â const controlPanel=document.getElementById("controlPanel");  
Â Â if(controlPanel){  
Â Â Â Â controlPanel.classList.remove("hidden");  
Â Â Â Â hideAllElements();  
Â Â }  
Â Â const searchBox=document.getElementById("searchBox");  
Â Â if(searchBox){  
Â Â Â Â searchBox.focus();  
Â Â }  
}  
function voiceSearch(){  
Â Â if(!('webkitSpeechRecognition' in window)&&!('SpeechRecognition' in window)){  
Â Â Â Â speak("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");  
Â Â Â Â showError("éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â const recognition=new(window.SpeechRecognition||window.webkitSpeechRecognition)();  
Â Â recognition.lang='ja-JP';  
Â Â recognition.continuous=false;  
Â Â recognition.interimResults=false;  
Â Â   
Â Â recognition.onstart=()=>{  
Â Â Â Â speak("éŸ³å£°å…¥åŠ›ã‚’é–‹å§‹ã—ã¾ã™");  
Â Â Â Â showSuccess("éŸ³å£°å…¥åŠ›ä¸­...");  
Â Â };  
Â Â   
Â Â recognition.onresult=(event)=>{  
Â Â Â Â const transcript=event.results[0][0].transcript;  
Â Â Â Â const searchBox=document.getElementById("searchBox");  
Â Â Â Â if(searchBox){  
Â Â Â Â Â Â searchBox.value=transcript;  
Â Â Â Â }  
Â Â Â Â // éŸ³å£°å…¥åŠ›å¾Œã€è‡ªå‹•ã§æ¤œç´¢ã‚’å®Ÿè¡Œ  
Â Â Â Â executeSearch();  
Â Â };  
Â Â   
Â Â recognition.onerror=(event)=>{  
Â Â Â Â speak("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");  
Â Â Â Â showError("éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼");  
Â Â };  
Â Â   
Â Â recognition.start();  
}  
async function searchPlace(){  
Â Â const searchBox=document.getElementById("searchBox");  
Â Â if(!searchBox)return;  
Â Â   
Â Â const q=searchBox.value.trim();  
Â Â if(!q)return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");  
Â Â if(!currentLocation)return showError("ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­");  
Â Â   
Â Â // ç›´æ¥æ¤œç´¢ã‚’å®Ÿè¡Œ  
Â Â await executeSearch();  
}  
async function executeSearch(){  
Â Â const searchBox=document.getElementById("searchBox");  
Â Â if(!searchBox)return;  
Â Â   
Â Â const q=searchBox.value.trim();  
Â Â if(!q){  
Â Â Â Â showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");  
Â Â Â Â return;  
Â Â }  
Â Â if(!currentLocation){  
Â Â Â Â showError("ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â // æ¤œç´¢ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹  
Â Â const controlPanel=document.getElementById("controlPanel");  
Â Â if(controlPanel){  
Â Â Â Â controlPanel.classList.add("hidden");  
Â Â }  
Â Â   
Â Â hideResults();  
Â Â speak(`${q}ã‚’æ¤œç´¢ä¸­`);  
Â Â showSuccess("æ¤œç´¢ä¸­...");  
Â Â   
Â Â // Google Places APIã®Text Searchã‚’ä½¿ç”¨  
Â Â const service=new google.maps.places.PlacesService(map);  
Â Â const request={  
Â Â Â Â query:q,  
Â Â Â Â location:currentLocation,  
Â Â Â Â radius:50000,  
Â Â Â Â language:'ja'  
Â Â };  
Â Â   
Â Â service.textSearch(request,(results,status)=>{  
Â Â Â Â if(status===google.maps.places.PlacesServiceStatus.OK&&results&&results.length>0){  
Â Â Â Â Â Â // è·é›¢ã‚’è¨ˆç®—ã—ã¦ã‚½ãƒ¼ãƒˆ  
Â Â Â Â Â Â const places=results.map(p=>{  
Â Â Â Â Â Â Â Â const lat=p.geometry.location.lat();  
Â Â Â Â Â Â Â Â const lng=p.geometry.location.lng();  
Â Â Â Â Â Â Â Â const distance=calculateDistance(currentLocation.lat(),currentLocation.lng(),lat,lng);  
Â Â Â Â Â Â Â Â return{  
Â Â Â Â Â Â Â Â Â Â displayName:{text:p.name},  
Â Â Â Â Â Â Â Â Â Â formattedAddress:p.formatted_address,  
Â Â Â Â Â Â Â Â Â Â location:{latitude:lat,longitude:lng},  
Â Â Â Â Â Â Â Â Â Â place_id:p.place_id,  
Â Â Â Â Â Â Â Â Â Â geometry:p.geometry,  
Â Â Â Â Â Â Â Â Â Â distance:distance  
Â Â Â Â Â Â Â Â };  
Â Â Â Â Â Â }).sort((a,b)=>a.distance-b.distance).slice(0,5);  
Â Â Â Â Â Â   
Â Â Â Â Â Â speak(`${places.length}ä»¶ã®çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);  
Â Â Â Â Â Â displayResults(places);  
Â Â Â Â }else{  
Â Â Â Â Â Â showError("çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");  
Â Â Â Â Â Â speak("çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");  
Â Â Â Â }  
Â Â });  
}  
function calculateDistance(lat1,lon1,lat2,lon2){  
Â Â const R=6371;  
Â Â const dLat=(lat2-lat1)*Math.PI/180;  
Â Â const dLon=(lon2-lon1)*Math.PI/180;  
Â Â const a=Math.sin(dLat/2)*Math.sin(dLat/2)+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);  
Â Â const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));  
Â Â return R*c;  
}  
function displayResults(places){  
Â Â const list=document.getElementById("resultsList");  
Â Â list.innerHTML="";  
Â Â   
Â Â places.forEach(p=>{  
Â Â Â Â const item=document.createElement("div");  
Â Â Â Â item.className="result-item";  
Â Â Â Â const distText=p.distance<1?`${(p.distance*1000).toFixed(0)}m`:`${p.distance.toFixed(1)}km`;  
Â Â Â Â item.innerHTML=`<div style="font-weight:700">${p.displayName?.text||"Unknown"}</div><div style="font-size:12px;color:var(--muted)">${p.formattedAddress||""}</div><div style="font-size:11px;color:var(--accent);margin-top:4px;">ğŸ“ ${distText}</div>`;  
Â Â Â Â item.onclick=()=>selectPlace(p);  
Â Â Â Â list.appendChild(item);  
Â Â });  
Â Â   
Â Â document.getElementById("resultsPanel").style.display="block";  
}  
function hideResults(){  
Â Â document.getElementById("resultsPanel").style.display="none";  
}  
function selectPlace(place){  
Â Â const lat=place.location?.latitude,lng=place.location?.longitude;  
Â Â   
Â Â destMarker&&destMarker.setMap(null);  
Â Â destMarker=new google.maps.Marker({position:{lat,lng},map});  
Â Â   
Â Â map.panTo({lat,lng});  
Â Â map.setZoom(18);  
Â Â   
Â Â hideResults();  
Â Â   
Â Â const controlPanel=document.getElementById("controlPanel");  
Â Â if(controlPanel){  
Â Â Â Â controlPanel.classList.add("hidden");  
Â Â }  
Â Â document.getElementById("panelToggle").classList.add("show");  
Â Â showAllElements();  
Â Â   
Â Â setTimeout(()=>{  
Â Â Â Â if(currentLocation&&destMarker)startNav();  
Â Â },500);  
}  
function zoomToCurrentLocation(){  
Â Â if(!currentLocation){  
Â Â Â Â speak("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");  
Â Â Â Â showError("ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â map.panTo(currentLocation);  
Â Â map.setZoom(18);  
Â Â   
Â Â // æƒ…å ±ãƒ‘ãƒãƒ«ã®ä¸‹ã®è¦‹ãˆã‚‹ç¯„å›²ã«ç¾åœ¨åœ°ã‚’è¡¨ç¤º  
Â Â // è² ã®å€¤ã§åœ°å›³ãŒä¸Šã«ç§»å‹•ã—ã€ãƒãƒ¼ã‚«ãƒ¼ãŒä¸‹ã«è¦‹ãˆã‚‹  
Â Â // ã•ã‚‰ã«20pxä¸Šã«è¡¨ç¤ºã™ã‚‹ãŸã‚å€¤ã‚’èª¿æ•´  
Â Â const offset = window.innerHeight * 0.25 + 20;  
Â Â map.panBy(0, -offset);  
Â Â   
Â Â speak("ç¾åœ¨åœ°ã‚’è¡¨ç¤ºã—ã¾ã™");  
}  
function zoomToDestination(){  
Â Â if(!destMarker){  
Â Â Â Â speak("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");  
Â Â Â Â showError("ç›®çš„åœ°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â const pos=destMarker.getPosition();  
Â Â map.panTo(pos);  
Â Â map.setZoom(18);  
Â Â   
Â Â speak("ç›®çš„åœ°ã‚’è¡¨ç¤º");  
}  
function startNav(){  
Â Â if(!currentLocation||!destMarker)return showError("Location or destination not set");  
Â Â   
Â Â stopAnnounced=!1;  
Â Â   
Â Â directionsService.route({  
Â Â Â Â origin:currentLocation,  
Â Â Â Â destination:destMarker.getPosition(),  
Â Â Â Â travelMode:google.maps.TravelMode.WALKING  
Â Â },(res,status)=>{  
Â Â Â Â if(status!=="OK")return showError("Route failed");  
Â Â Â Â   
Â Â Â Â directionsRenderer.setDirections(res);  
Â Â Â Â isNavigating=!0;  
Â Â Â Â   
Â Â Â Â const stopNavBtn=document.getElementById("stopNavBtn");  
Â Â Â Â if(stopNavBtn){  
Â Â Â Â Â Â stopNavBtn.disabled=false;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â const leg=res.routes[0].legs[0];  
Â Â Â Â const dist=(leg.distance.value/1000).toFixed(1);  
Â Â Â Â const dur=Math.round(leg.duration.value/60);  
Â Â Â Â   
Â Â Â Â const routeText=`${dist}km, ${dur}min`;  
Â Â Â Â const routeTextEl=document.getElementById("routeText");  
Â Â Â Â if(routeTextEl){  
Â Â Â Â Â Â routeTextEl.textContent=routeText;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â const now=new Date();  
Â Â Â Â const arrival=new Date(now.getTime()+leg.duration.value*1000);  
Â Â Â Â   
Â Â Â Â const currentTimeEl=document.getElementById("currentTime");  
Â Â Â Â const arrivalTimeEl=document.getElementById("arrivalTime");  
Â Â Â Â const durationTimeEl=document.getElementById("durationTime");  
Â Â Â Â   
Â Â Â Â if(currentTimeEl){  
Â Â Â Â Â Â currentTimeEl.textContent=formatTime(now);  
Â Â Â Â }  
Â Â Â Â if(arrivalTimeEl){  
Â Â Â Â Â Â arrivalTimeEl.textContent=formatTime(arrival);  
Â Â Â Â }  
Â Â Â Â if(durationTimeEl){  
Â Â Â Â Â Â const hours=Math.floor(dur/60);  
Â Â Â Â Â Â const mins=dur%60;  
Â Â Â Â Â Â durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â speak(`${translations[currentLang].navStart} ${dist} km, ${dur} minutes.`);  
Â Â Â Â   
Â Â Â Â const controlPanel=document.getElementById("controlPanel");  
Â Â Â Â if(controlPanel){  
Â Â Â Â Â Â controlPanel.classList.add("hidden");  
Â Â Â Â }  
Â Â Â Â document.getElementById("panelToggle").classList.remove("show");  
Â Â Â Â showAllElements();  
Â Â });  
}  
function stopNav(){  
Â Â if(!isNavigating){  
Â Â Â Â speak("æ¡ˆå†…ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â speak("æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã™");  
Â Â   
Â Â if(!stopAnnounced){  
Â Â Â Â stopAnnounced=!0;  
Â Â }  
Â Â   
Â Â directionsRenderer.setMap(null);  
Â Â directionsRenderer=new google.maps.DirectionsRenderer({map});  
Â Â   
Â Â isNavigating=!1;  
Â Â   
Â Â const stopNavBtn=document.getElementById("stopNavBtn");  
Â Â if(stopNavBtn){  
Â Â Â Â stopNavBtn.disabled=true;  
Â Â }  
Â Â   
Â Â const routeTextEl=document.getElementById("routeText");  
Â Â const arrivalTimeEl=document.getElementById("arrivalTime");  
Â Â const durationTimeEl=document.getElementById("durationTime");  
Â Â   
Â Â if(routeTextEl){  
Â Â Â Â routeTextEl.textContent=translations[currentLang].setDestination;  
Â Â }  
Â Â if(arrivalTimeEl){  
Â Â Â Â arrivalTimeEl.textContent="--:--";  
Â Â }  
Â Â if(durationTimeEl){  
Â Â Â Â durationTimeEl.textContent="--:--";  
Â Â }  
Â Â   
Â Â const searchBox=document.getElementById("searchBox");  
Â Â if(searchBox){  
Â Â Â Â searchBox.value="";  
Â Â }  
Â Â   
Â Â document.getElementById("panelToggle").classList.add("show");  
Â Â   
Â Â if(currentLocation){  
Â Â Â Â map.panTo(currentLocation);  
Â Â Â Â map.setZoom(18);  
Â Â }  
}  
function reroute(manual=!0){  
Â Â if(!isNavigating){  
Â Â Â Â if(manual)showError("Not navigating");  
Â Â Â Â return;  
Â Â }  
Â Â   
Â Â directionsService.route({  
Â Â Â Â origin:currentLocation,  
Â Â Â Â destination:destMarker.getPosition(),  
Â Â Â Â travelMode:google.maps.TravelMode.WALKING,  
Â Â Â Â provideRouteAlternatives:!0,  
Â Â Â Â avoidHighways:Math.random()>0.5  
Â Â },(res,status)=>{  
Â Â Â Â if(status!=="OK")return showError("Reroute failed");  
Â Â Â Â   
Â Â Â Â const routes=res.routes;  
Â Â Â Â let selectedRoute=routes[0];  
Â Â Â Â if(routes.length>1){  
Â Â Â Â Â Â const altIndex=Math.floor(Math.random()*(routes.length-1))+1;  
Â Â Â Â Â Â selectedRoute=routes[altIndex];  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â directionsRenderer.setDirections({...res,routes:[selectedRoute]});  
Â Â Â Â   
Â Â Â Â const leg=selectedRoute.legs[0];  
Â Â Â Â const dist=(leg.distance.value/1000).toFixed(1);  
Â Â Â Â const dur=Math.round(leg.duration.value/60);  
Â Â Â Â   
Â Â Â Â const routeText=`${dist}km, ${dur}min`;  
Â Â Â Â const routeTextEl=document.getElementById("routeText");  
Â Â Â Â if(routeTextEl){  
Â Â Â Â Â Â routeTextEl.textContent=routeText;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â const now=new Date();  
Â Â Â Â const arrival=new Date(now.getTime()+leg.duration.value*1000);  
Â Â Â Â   
Â Â Â Â const currentTimeEl=document.getElementById("currentTime");  
Â Â Â Â const arrivalTimeEl=document.getElementById("arrivalTime");  
Â Â Â Â const durationTimeEl=document.getElementById("durationTime");  
Â Â Â Â   
Â Â Â Â if(currentTimeEl){  
Â Â Â Â Â Â currentTimeEl.textContent=formatTime(now);  
Â Â Â Â }  
Â Â Â Â if(arrivalTimeEl){  
Â Â Â Â Â Â arrivalTimeEl.textContent=formatTime(arrival);  
Â Â Â Â }  
Â Â Â Â if(durationTimeEl){  
Â Â Â Â Â Â const hours=Math.floor(dur/60);  
Â Â Â Â Â Â const mins=dur%60;  
Â Â Â Â Â Â durationTimeEl.textContent=hours>0?`${hours}:${mins.toString().padStart(2,'0')}`:`0:${mins.toString().padStart(2,'0')}`;  
Â Â Â Â }  
Â Â Â Â   
Â Â Â Â manual&&speak("Rerouting");  
Â Â });  
}  
function formatTime(date){  
Â Â const h=date.getHours();  
Â Â const m=date.getMinutes().toString().padStart(2,'0');  
Â Â return `${h}:${m}`;  
}  
function updateCurrentTime(){  
Â Â const currentTimeEl=document.getElementById("currentTime");  
Â Â if(currentTimeEl){  
Â Â Â Â currentTimeEl.textContent=formatTime(new Date());  
Â Â }  
}  
function loadSavedPoints(){  
Â Â const cookies=document.cookie.split(';');  
Â Â for(let cookie of cookies){  
Â Â Â Â const [name,value]=cookie.trim().split('=');  
Â Â Â Â if(name==='walkNavSavedPoints'){  
Â Â Â Â Â Â try{  
Â Â Â Â Â Â Â Â savedPoints=JSON.parse(decodeURIComponent(value));  
Â Â Â Â Â Â }catch(e){}  
Â Â Â Â Â Â break;  
Â Â Â Â }  
Â Â }  
}  
function hideSavedPoints(){  
Â Â document.getElementById("savedPointsPanel").style.display="none";  
Â Â showAllElements();  
}  
async function fetchLocationName(){  
Â Â if(!currentLocation)return;  
Â Â   
Â Â try{  
Â Â Â Â const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lng}&format=json&accept-language=${currentLang}`);  
Â Â Â Â const data=await res.json();  
Â Â Â Â   
Â Â Â Â let locationText="";  
Â Â Â Â   
Â Â Â Â const county=data.address?.county||"";  
Â Â Â Â const city=data.address?.city||data.address?.town||data.address?.village||"";  
Â Â Â Â const suburb=data.address?.suburb||"";  
Â Â Â Â const hamlet=data.address?.hamlet||"";  
Â Â Â Â const house_number=data.address?.house_number||"";  
Â Â Â Â   
Â Â Â Â if(county)locationText+=county;  
Â Â Â Â if(city)locationText+=city;  
Â Â Â Â if(suburb)locationText+=suburb;  
Â Â Â Â if(hamlet)locationText+=hamlet;  
Â Â Â Â if(house_number)locationText+=house_number;  
Â Â Â Â   
Â Â Â Â if(locationText)locationText+="ä»˜è¿‘";  
Â Â Â Â   
Â Â Â Â if(!locationText)locationText=translations[currentLang].loading;  
Â Â Â Â   
Â Â Â Â const locationNameEl=document.getElementById("locationName");  
Â Â Â Â if(locationNameEl){  
Â Â Â Â Â Â locationNameEl.textContent=locationText;  
Â Â Â Â }  
Â Â }catch(e){  
Â Â Â Â const locationNameEl=document.getElementById("locationName");  
Â Â Â Â if(locationNameEl){  
Â Â Â Â Â Â locationNameEl.textContent=translations[currentLang].loading;  
Â Â Â Â }  
Â Â }  
}  
async function fetchWeather(){  
Â Â if(!currentLocation)return;  
Â Â   
Â Â try{  
Â Â Â Â const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia/Tokyo&forecast_days=1`);  
Â Â Â Â const data=await res.json();  
Â Â Â Â   
Â Â Â Â const now=new Date();  
Â Â Â Â const currentHour=now.getHours();  
Â Â Â Â   
Â Â Â Â const hours=[3,6,9,12];  
Â Â Â Â const weatherIcons={0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",71:"ğŸŒ¨ï¸",73:"ğŸŒ¨ï¸",75:"ğŸŒ¨ï¸",77:"ğŸŒ¨ï¸",80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",85:"ğŸŒ¨ï¸",86:"ğŸŒ¨ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"};  
Â Â Â Â   
Â Â Â Â hours.forEach(h=>{  
Â Â Â Â Â Â const targetHour=(currentHour+h)%24;  
Â Â Â Â Â Â const idx=data.hourly.time.findIndex(t=>new Date(t).getHours()===targetHour);  
Â Â Â Â Â Â   
Â Â Â Â Â Â if(idx>=0){  
Â Â Â Â Â Â Â Â const temp=Math.round(data.hourly.temperature_2m[idx]);  
Â Â Â Â Â Â Â Â const rain=data.hourly.precipitation_probability[idx]||0;  
Â Â Â Â Â Â Â Â const code=data.hourly.weathercode[idx];  
Â Â Â Â Â Â Â Â const icon=weatherIcons[code]||"â˜ï¸";  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â const wEl=document.getElementById(`w${h}h`);  
Â Â Â Â Â Â Â Â const tEl=document.getElementById(`t${h}h`);  
Â Â Â Â Â Â Â Â const rEl=document.getElementById(`r${h}h`);  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â if(wEl)wEl.textContent=icon;  
Â Â Â Â Â Â Â Â if(tEl)tEl.textContent=`${temp}Â°`;  
Â Â Â Â Â Â Â Â if(rEl)rEl.textContent=`${rain}%`;  
Â Â Â Â Â Â }  
Â Â Â Â });  
Â Â }catch(e){  
Â Â Â Â console.error("Weather error:",e);  
Â Â }  
Â Â   
Â Â fetchIncidents();  
}  
let lastIncidentTime=0;  
let currentIncidentText="";  
async function fetchIncidents(){  
Â Â const incidents=[  
Â Â Â Â "âš ï¸ ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã•ã‚Œã¦ã„ã‚‹äº‹ä»¶ã€äº‹æ•…ã®å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚",  
Â Â Â Â "â˜” é™é›¨ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚å‚˜ã®æº–å‚™ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",  
Â Â Â Â "âš¡ é›·æ³¨æ„å ±ãŒç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å»ºç‰©å†…ã¸ã®é¿é›£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",  
Â Â Â Â "ğŸŒ«ï¸ è¦–ç•Œä¸è‰¯ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚æ­©è¡Œæ™‚ã¯å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",  
Â Â Â Â "ğŸš¸ å­¦æ ¡ä»˜è¿‘ã§ã¯å…ç«¥ãƒ»ç”Ÿå¾’ã®é€šè¡Œã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",  
Â Â Â Â "ğŸ¦Œ é‡ç”Ÿå‹•ç‰©ã®å‡ºæ²¡æƒ…å ±ãŒã‚ã‚Šã¾ã™ã€‚å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",  
Â Â Â Â "âš ï¸ å·¥äº‹åŒºé–“ãŒã‚ã‚Šã¾ã™ã€‚è¿‚å›è·¯ã®åˆ©ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚"  
Â Â ];  
Â Â   
Â Â const randomIncident=incidents[Math.floor(Math.random()*incidents.length)];  
Â Â const now=Date.now();  
Â Â   
Â Â const incidentEl=document.getElementById("incidentText");  
Â Â if(!incidentEl)return;  
Â Â   
Â Â if(randomIncident===currentIncidentText){  
Â Â Â Â if(now-lastIncidentTime<180000){  
Â Â Â Â Â Â incidentEl.style.animation="none";  
Â Â Â Â Â Â incidentEl.textContent=currentIncidentText;  
Â Â Â Â Â Â return;  
Â Â Â Â }  
Â Â }  
Â Â   
Â Â currentIncidentText=randomIncident;  
Â Â lastIncidentTime=now;  
Â Â incidentEl.textContent=randomIncident;  
Â Â incidentEl.style.animation="marquee 20s linear infinite";  
Â Â   
Â Â setTimeout(()=>{  
Â Â Â Â if(incidentEl){  
Â Â Â Â Â Â incidentEl.style.animation="none";  
Â Â Â Â }  
Â Â },20000);  
}  
function showError(msg){  
Â Â const el=document.getElementById("error");  
Â Â el.textContent=msg;  
Â Â el.classList.remove("hidden");  
Â Â setTimeout(()=>el.classList.add("hidden"),3000);  
}  
function showSuccess(msg){  
Â Â const el=document.getElementById("success");  
Â Â el.textContent=msg;  
Â Â el.classList.remove("hidden");  
Â Â setTimeout(()=>el.classList.add("hidden"),3000);  
}  
function speak(text){  
Â Â try{  
Â Â Â Â const u=new SpeechSynthesisUtterance(text);  
Â Â Â Â u.lang=currentLang==="ja"?"ja-JP":"en-US";  
Â Â Â Â u.rate=0.9;  
Â Â Â Â speechSynthesis.speak(u);  
Â Â }catch(e){}  
}  
window.addEventListener("load",initMap);  
Â Â </script>  
Â Â <script>  
Â Â Â Â const script=document.createElement('script');  
Â Â Â Â script.src=`https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places`;  
Â Â Â Â script.async=true;  
Â Â Â Â script.defer=true;  
Â Â Â Â document.body.appendChild(script);  
Â Â </script>  
</body>  
</html>