<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.88);
      --stroke: rgba(255,255,255,.14);
      --ok:#25d07a;
      --danger:#ff6565;
      --btn-bg: rgba(255,255,255,.06);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .overlay{
      position:absolute;left:12px;right:12px;top:12px;z-index:3;
      padding:14px 14px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(8px)
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .col{display:flex;gap:10px;align-items:center}
    .grow{flex:1}

    .searchbar{
      display:flex;gap:8px;align-items:center;width:100%;
      background:rgba(0,0,0,.24);border:1px solid var(--stroke);
      border-radius:12px;padding:8px 10px
    }
    .searchbar input{
      flex:1;border:0;outline:0;background:transparent;color:var(--text);
      font-size:14px;min-width:120px
    }
    .searchbar input::placeholder{color:var(--muted)}
    .select{appearance:none;background:rgba(0,0,0,.24);color:var(--text);
      border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font-size:13px}

    .pill{
      position:absolute;right:12px;bottom:18px;z-index:4;display:flex;flex-direction:column;gap:10px
    }
    .btn{
      min-width:96px;height:48px;border-radius:14px;background:var(--btn-bg);
      display:flex;align-items:center;justify-content:center;padding:0 12px;
      border:1px solid var(--stroke);color:#111;font-weight:600;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .btn.small{min-width:auto;height:40px}
    .btn.ghost{background:transparent;color:var(--text)}
    .btn:disabled{opacity:.5}

    .results{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:4;
      background:var(--glass);border:1px solid var(--stroke);border-radius:14px;
      max-height:40vh;overflow:auto;padding:8px 8px;backdrop-filter:blur(8px)
    }
    .result-item{
      padding:10px;border-radius:10px;border:1px solid var(--stroke);
      margin:6px 0;background:rgba(0,0,0,.18);cursor:pointer
    }
    .result-item:hover{background:rgba(0,0,0,.28)}

    .toast{
      position:absolute;left:16px;right:16px;bottom:16px;padding:12px 14px;
      border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:10
    }

    .curtain{
      position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:5
    }
    .curtain .box{color:#fff;text-align:center;max-width:90vw;line-height:1.6}

    .hint{text-align:center;color:var(--muted);font-size:12px;margin-top:6px}

    .pulse{position:absolute;transform:translate(-50%,-50%);
      width:16px;height:16px;border-radius:50%;background:#ff4d4d;border:2px solid #fff}
    .pulse::after{content:"";position:absolute;inset:-10px;border-radius:50%;
      border:2px solid rgba(255,77,77,.6);animation:pulse 1.6s infinite}
    @keyframes pulse{0%{transform:scale(0.8);opacity:1}100%{transform:scale(1.6);opacity:0}}

    .hidden{display:none !important}
  </style>
</head>
<body>
<div class="app">
  <div id="map" aria-label="map"></div>

  <div id="curtain" class="curtain">
    <div class="box">
      <div style="font-size:18px;margin-bottom:8px">現在地取得中です。</div>
      <div style="opacity:.9">ご迷惑をお掛けします。現在地表示まで <strong>30秒</strong> 程お待ちください。</div>
    </div>
  </div>

  <div id="panel" class="overlay">
    <div class="row">
      <div class="col grow">
        <div class="searchbar">
          <input id="q" maxlength="140" placeholder="店舗名・電話番号・カテゴリ・住所・座標・施設名" />
          <select id="radius" class="select" title="半径">
            <option value="10000">10km</option>
            <option value="20000">20km</option>
            <option value="30000">30km</option>
          </select>
          <select id="sort" class="select" title="並び順">
            <option value="relevance">おすすめ</option>
            <option value="rating">高レビュー順</option>
          </select>
          <button id="btn-go" class="btn small">Go</button>
        </div>
      </div>
    </div>

    <div class="hint">
      <span id="coord-label">現在地：</span>
      <span id="coord">緯度 -- / 経度 --</span>
    </div>

    <div class="hint" id="center-hint">
      任意の場所を検索：赤い現在地が非表示になります。地図上で<strong>長押し</strong>して地点を確定してください。
    </div>
  </div>

  <div class="pill">
    <button id="btn-current" class="btn">現在地</button>
    <button id="btn-pick" class="btn">任意の場所を検索</button>
    <button id="btn-voice-top" class="btn">音声検索</button>
    <button id="btn-stop" class="btn">案内停止</button>
    <button id="btn-reroute" class="btn">リルート</button>
  </div>

  <div id="results" class="results hidden"></div>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
</div>

<script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

<script type="module">
  const PROXY = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";
  const $ = (s)=>document.querySelector(s);
  const toast = (m,ok=false)=>{const el=$("#toast");el.style.background=ok?"#25d07a":"#ff6b6b";el.textContent=m;el.style.display="block";clearTimeout(el._t);el._t=setTimeout(()=>el.style.display="none",2600);};

  async function waitForMaps(t=15000){const t0=performance.now();while(performance.now()-t0<t){if(window.google?.maps?.importLibrary)return true;await new Promise(r=>setTimeout(r,50));}throw new Error("Google Maps failed to load.");}

  let map,currentOverlay,currentPos=null,destPos=null,directionsService,directionsRenderer,centerPickMode=false;

  function setCoordText(pos,label="現在地："){ $("#coord-label").textContent=label; $("#coord").textContent=`緯度 ${pos.lat.toFixed(6)} / 経度 ${pos.lng.toFixed(6)}`; }

  function addPulseMarker(position){
    class Pulse extends google.maps.OverlayView{
      constructor(pos){super();this.pos=pos;this.div=null;}
      onAdd(){this.div=document.createElement("div");this.div.className="pulse";this.getPanes().overlayMouseTarget.appendChild(this.div);}
      draw(){const p=this.getProjection();if(!p||!this.div)return;const pt=p.fromLatLngToDivPixel(this.pos);this.div.style.left=pt.x+"px";this.div.style.top=pt.y+"px";}
      onRemove(){this.div?.remove();this.div=null;}
      setPosition(pos){this.pos=pos;this.draw();}
    }
    if(currentOverlay) currentOverlay.setMap(null);
    currentOverlay=new Pulse(new google.maps.LatLng(position.lat,position.lng));
    currentOverlay.setMap(map);
  }

  async function init(){
    await waitForMaps();
    const { Map } = await google.maps.importLibrary("maps");
    map = new Map($("#map"), { center:{lat:35.681236,lng:139.767125}, zoom:16, mapId:"DEMO_MAP", disableDefaultUI:true });

    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({ suppressMarkers:true });
    directionsRenderer.setMap(map);

    try{
      const pos=await getCurrentPositionWithTimeout(30000);
      currentPos=pos; map.setCenter(pos); addPulseMarker(pos); setCoordText(pos,"現在地："); $("#curtain").classList.add("hidden"); toast("現在地を取得しました",true);
    }catch(e){ $("#curtain").classList.add("hidden"); toast("現在地を取得出来ませんでした。屋外や空が開けた場所へ移動してください。"); }

    let pressTimer=null;
    map.addListener("mousedown",(e)=>{ if(!centerPickMode)return; pressTimer=setTimeout(()=>{ destPos={lat:e.latLng.lat(),lng:e.latLng.lng()}; map.setCenter(destPos); setCoordText(destPos,"任意地点："); toast("地点を確定しました。検索できます。",true); },550); });
    map.addListener("mouseup",()=>clearTimeout(pressTimer));

    $("#btn-current").addEventListener("click",async()=>{ try{const p=await getCurrentPositionWithTimeout(12000); currentPos=p; map.setCenter(p); addPulseMarker(p); setCoordText(p,"現在地："); toast("現在地へ移動",true);}catch(e){toast(e.message||"現在地エラー");} });
    $("#btn-pick").addEventListener("click",()=>{ centerPickMode=!centerPickMode; if(centerPickMode){ if(currentOverlay){currentOverlay.setMap(null);currentOverlay=null;} $("#center-hint").classList.remove("hidden"); toast("任意地点モード：長押しで地点を確定",true);} else { if(currentPos){addPulseMarker(currentPos);setCoordText(currentPos,"現在地：");} $("#center-hint").classList.add("hidden"); toast("任意地点モードを終了",true);} });
    $("#btn-voice-top").addEventListener("click",handleVoice);
    $("#btn-reroute").addEventListener("click",()=>{ if(destPos) routeTo(destPos); });
    $("#btn-stop").addEventListener("click",()=>{ directionsRenderer.setDirections({routes:[]}); });
    $("#btn-go").addEventListener("click",onSearchGo);

    $("#results").addEventListener("click",(ev)=>{ const li=ev.target.closest(".result-item"); if(!li)return; const lat=parseFloat(li.dataset.lat); const lng=parseFloat(li.dataset.lng); destPos={lat,lng}; routeTo(destPos); $("#results").classList.add("hidden"); });
  }

  async function getCurrentPositionWithTimeout(ms){
    return new Promise((resolve,reject)=>{
      let done=false; const timer=setTimeout(()=>{ if(done)return; done=true; reject(new Error("現在地を取得出来ませんでした。屋外や空が開けた場所へ移動してください。")); },ms);
      if(!navigator.geolocation){ clearTimeout(timer); return reject(new Error("Geolocation unsupported")); }
      navigator.geolocation.getCurrentPosition(
        pos=>{ if(done)return; done=true; clearTimeout(timer); resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}); },
        err=>{ if(done)return; done=true; clearTimeout(timer); reject(new Error(err.message||"現在地エラー")); },
        { enableHighAccuracy:true, timeout:ms, maximumAge:0 }
      );
    });
  }

  async function onSearchGo(){
    const q=$("#q").value.trim();
    if(!q){ toast("検索したい文字を入力してください。"); return; }
    const radiusMeters=parseInt($("#radius").value,10);
    const sort=$("#sort").value;
    const pageSize=5;
    const base = destPos || currentPos || map.getCenter().toJSON();

    const body={ textQuery:q, languageCode:"ja", regionCode:"JP", pageSize,
      locationBias:{ circle:{ center:{ latitude:base.lat, longitude:base.lng }, radius:radiusMeters } } };

    try{
      const res=await fetch(`${PROXY}/places`,{ method:"POST", headers:{ "Content-Type":"application/json" }, body:JSON.stringify(body) });
      const data=await res.json();
      const places=Array.isArray(data.places)?data.places.slice():[];
      if(sort==="rating"){ places.sort((a,b)=>(b.rating||0)-(a.rating||0)); }
      renderResults(places,radiusMeters);
    }catch(e){ toast("検索エラー: "+(e.message||"")); }
  }

  function renderResults(places){
    const box=$("#results");
    if(!places.length){ box.innerHTML=`<div class="result-item">該当なし</div>`; box.classList.remove("hidden"); return; }
    box.innerHTML=places.slice(0,5).map(p=>{
      const name=p.displayName?.text||"(名称不明)";
      const addr=p.formattedAddress||p.shortFormattedAddress||"";
      const lat=p.location?.latitude,lng=p.location?.longitude;
      const rating=p.rating?`★${p.rating} (${p.userRatingCount||0})`:"";
      return `<div class="result-item" data-lat="${lat}" data-lng="${lng}">
        <div style="font-weight:700">${name}</div>
        <div style="opacity:.85">${addr}</div>
        <div style="opacity:.75;font-size:12px">${rating}</div>
      </div>`;
    }).join("");
    box.classList.remove("hidden");
  }

  async function routeTo(dst){
    try{
      const origin=currentPos||map.getCenter().toJSON();
      const params=new URLSearchParams({ origin:`${origin.lat},${origin.lng}`, destination:`${dst.lat},${dst.lng}`, mode:"walking", language:"ja", region:"JP" });
      const r=await fetch(`${PROXY}/directions?`+params.toString());
      const data=await r.json();
      if(data.status!=="OK"||!data.routes?.length){ toast("ルートを取得できませんでした。"); return; }
      const route=data.routes[0];
      directionsRenderer.setDirections(data);
      map.fitBounds(new google.maps.LatLngBounds(route.bounds.southwest,route.bounds.northeast));
      toast("ルート案内を開始します。",true);
    }catch(e){ toast("ルートエラー: "+(e.message||"")); }
  }

  async function handleVoice(){
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ toast("音声検索は未対応の環境です。"); return; }
    const rec=new SR(); rec.lang="ja-JP";
    rec.onresult=(ev)=>{ const text=ev.results[0][0].transcript||""; if(text){ $("#q").value=text; onSearchGo(); } };
    rec.onerror=()=>toast("音声認識エラー"); rec.start();
  }

  init().catch(e=>toast("初期化エラー: "+e.message));
</script>
</body>
</html>