<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
  <title>Walk-NAV</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-o9N1j7kG9kG8a9kaK2vNhbbX6YsJh8e3toDnN2DXW8A="
    crossorigin=""
    defer
  ></script>

  <style>
    /* ===== レイアウト基礎 ===== */
    html, body { height:100%; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "游ゴシック体", Meiryo, sans-serif; }

    /* 地図 */
    #map { position:fixed; inset:0; z-index:0; }

    /* ガラス板（右上固定：現状のデザイン維持） */
    .glass {
      position: fixed;
      top: 12px;
      right: 12px;
      width: min(92vw, 720px);
      max-height: calc(100vh - 24px);
      overflow: auto;
      padding: 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.62);
      box-shadow: 0 8px 28px rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      z-index: 5;
    }

    .row { display:flex; align-items:center; }
    .gap { gap:10px; margin-top:10px; flex-wrap: wrap; }
    .mini-gap { gap:8px; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .section { margin-top: 12px; }
    .section-title { font-weight:600; margin-bottom:6px; }

    .input {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,.18);
      background: rgba(255,255,255,.85);
      outline: none;
    }

    .btn {
      cursor:pointer;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      background:#f2f2f2;
    }
    .btn.primary { background:#2563eb; color:#fff; }
    .btn.secondary { background:#e5e7eb; }
    .btn.green { background:#16a34a; color:#fff; }
    .btn.blue { background:#0ea5e9; color:#fff; }
    .btn.red { background:#ef4444; color:#fff; }
    .btn.big { padding: 12px 18px; }
    .btn.mic { font-size: 14px; }
    .btn.mic.green { background:#16a34a; color:#fff; }
    .btn.mic.recording, .btn.loading { background:#ef4444 !important; color:#fff; }
    .btn.ghost { background:transparent; border:1px solid rgba(0,0,0,.2); }

    .mode-btn, .lang-btn {
      cursor:pointer;
      border-radius: 999px;
      border:1px solid rgba(0,0,0,.2);
      background:#fff;
      padding:8px 12px;
      font-weight:600;
    }
    .mode-btn.selected, .lang-btn.selected { background:#0ea5e9; color:#fff; border-color: transparent; }

    .lang-accordion summary { cursor:pointer; list-style:none; }
    .summary-center { text-align:center; font-weight:700; }
    .langs { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; justify-content:center; }

    /* 右サイド縦ボタン（地図上） */
    .right-stack {
      position: fixed;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 4;
      pointer-events: auto;
    }
    .btn-right {
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      cursor: pointer;
    }

    /* 方位計（左側） */
    .compass-wrap {
      position: fixed;
      left: 12px;
      top: 12px;
      z-index: 4;
      display: flex;
      align-items: center;
      gap: 8px;
      pointer-events: none;
    }
    .compass-dial {
      width: 84px; height: 84px;
      border-radius: 50%;
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(0,0,0,.15);
      position: relative;
      box-shadow: 0 4px 18px rgba(0,0,0,.16);
      pointer-events: auto;
    }
    .compass-needle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 2px;
      height: 70%;
      background: #ef4444;
      transform-origin: 50% calc(100% - 8px); /* 針の基点を盤中心寄りに */
      transform: translate(-50%,-90%) rotate(0deg);
      border-radius: 2px;
    }
    .heading-buttons { display:flex; flex-direction: column; gap:8px; pointer-events: auto; }
    .btn-mini { padding: 6px 8px; border-radius: 8px; background:rgba(255,255,255,.92); border:1px solid rgba(0,0,0,.15); cursor:pointer; }

    /* 検索結果スライド */
    .results {
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0,0,0,.12);
      background: rgba(255,255,255,.9);
      transform: translateY(-8px);
      transition: transform .22s ease;
      display:none;
    }
    .results.show { display:block; transform: translateY(0); }
    .results-head {
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 12px; border-bottom: 1px solid rgba(0,0,0,.08);
    }
    #results-list { list-style:none; padding:8px 12px; margin:0; }
    #results-list li { padding: 8px 4px; cursor:pointer; border-bottom:1px dashed rgba(0,0,0,.08); }
    #results-list li:last-child { border-bottom: none; }

    .status { margin-top: 10px; font-size: 13px; opacity:.9; }

    /* ===== 変更点1：Leafletズームを左下へ（板と干渉させない） ===== */
    .leaflet-bottom.leaflet-left { bottom: 12px !important; left: 12px !important; }
    .leaflet-bottom .leaflet-control { margin-bottom: 0 !important; }
    .leaflet-left .leaflet-control  { margin-left: 0 !important; }

    /* ===== 変更点2：開始/目的 地点の経度・緯度入力のハミ出し防止 ===== */
    #start-lng, #start-lat, #end-lng, #end-lat {
      width: 100%;
      max-width: 100%;
      min-width: 0;
      box-sizing: border-box;
      display: block;
      text-align: center;
    }
    .grid2.mini-gap { grid-template-columns: 1fr 1fr; }
    @media (max-width: 520px) {
      .grid2 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Map -->
  <div id="map"></div>

  <!-- 右サイド縦ボタン（地図上。板と干渉しない位置/余白済み） -->
  <div class="right-stack">
    <button id="btn-current" class="btn-right">現在地</button>
    <button id="btn-dest"    class="btn-right">目的地</button>
    <button id="btn-reroute" class="btn-right">リルート</button>
  </div>

  <!-- 方位計（針は中心回転・盤内に収める） -->
  <div class="compass-wrap">
    <div class="compass-dial">
      <div class="compass-needle" id="compass-needle"></div>
    </div>
    <div class="heading-buttons">
      <button id="btn-north"  class="btn-mini">北を向く</button>
      <button id="btn-heading" class="btn-mini">進行方向</button>
    </div>
  </div>

  <!-- ガラス板（1枚に統合） -->
  <div id="panel" class="glass">
    <!-- 検索バー -->
    <div class="row search-row">
      <input id="q" class="input" placeholder="名称・住所・電話番号で検索" />
      <button id="btn-voice" class="btn mic green" title="音声検索（長押しで録音開始）">🎤 音声</button>
    </div>

    <!-- 上段：検索＋履歴クリア -->
    <div class="row gap">
      <button id="btn-search" class="btn primary">検索</button>
      <button id="btn-clear-history" class="btn secondary">履歴をクリア</button>
    </div>

    <!-- ルートモード：最短/楽チン/お散歩Ai/観光案内（横並び） -->
    <div class="row gap">
      <button class="mode-btn selected" data-mode="shortest">最短</button>
      <button class="mode-btn" data-mode="easy">楽チン</button>
      <button class="mode-btn" data-mode="walkai">お散歩Ai</button>
      <button class="mode-btn" data-mode="tour">観光案内</button>
    </div>

    <!-- 言語：縦トグル（省スペース） -->
    <details class="lang-accordion">
      <summary class="summary-center">言語 / Language</summary>
      <div class="langs">
        <button class="lang-btn selected" data-lang="ja">日本語</button>
        <button class="lang-btn" data-lang="en">English</button>
        <button class="lang-btn" data-lang="de">Deutsch</button>
        <button class="lang-btn" data-lang="it">Italiano</button>
        <button class="lang-btn" data-lang="fr">Français</button>
        <button class="lang-btn" data-lang="es">Español</button>
        <button class="lang-btn" data-lang="ko">한국어</button>
        <button class="lang-btn" data-lang="zh">中文</button>
      </div>
    </details>

    <!-- 位置入力（開始/目的） -->
    <div class="grid2 gap section">
      <div>
        <div class="section-title">開始地点</div>
        <div class="grid2 mini-gap">
          <input id="start-lng" class="input" placeholder="経度" />
          <input id="start-lat" class="input" placeholder="緯度" />
        </div>
      </div>
      <div>
        <div class="section-title">目的地点</div>
        <div class="grid2 mini-gap">
          <input id="end-lng" class="input" placeholder="経度" />
          <input id="end-lat" class="input" placeholder="緯度" />
        </div>
      </div>
    </div>

    <!-- 保存/設定/案内 -->
    <div class="row gap">
      <button id="btn-save" class="btn green">現在地を保存</button>
      <button id="btn-set-dest" class="btn blue">目的地に設定</button>
      <button id="btn-start" class="btn green big">案内開始</button>
      <button id="btn-stop"  class="btn red big">案内を停止</button>
    </div>

    <!-- 検索結果ビュー（スライド切替） -->
    <div id="results" class="results">
      <div class="results-head">
        <div class="results-title">検索結果</div>
        <button id="btn-close-results" class="btn ghost">×</button>
      </div>
      <ul id="results-list"></ul>
    </div>

    <!-- ステータス -->
    <div id="status" class="status"></div>
  </div>

  <script>
    window.addEventListener('load', () => {
      /***********************
       * 設定
       ************************/
      // ← 必ずあなたの Worker URL に書き換え（既存の値を維持）
      const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';

      // 検索：Places API (New) の searchText を Worker 経由
      const PLACES_SEARCH_URL = \`\${GMAP_PROXY}/places:searchText\`;
      // ルート：Directions API
      const DIRECTIONS_URL     = \`\${GMAP_PROXY}/maps/api/directions/json\`;

      // 状態
      let currentLang = 'ja';
      let currentMode = 'shortest'; // shortest|easy|walkai|tour
      let watchId = null;
      let headingDeg = 0; // 針の角度
      let userMarker = null;
      let destMarker = null;
      let routeLayer = null;
      let lastResults = [];
      let isRecording = false;

      /***********************
       * 地図
       ************************/
      const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
      L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap',
        maxZoom: 19
      }).addTo(map);

      // ズーム左下（指定通り）
      L.control.zoom({ position:'bottomleft' }).addTo(map);

      /***********************
       * 要素
       ************************/
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));

      const qInput = $('#q');
      const statusEl = $('#status');
      const resultsEl = $('#results');
      const resultsList = $('#results-list');

      const btnVoice = $('#btn-voice');
      const btnSearch = $('#btn-search');
      const btnClearHistory = $('#btn-clear-history');

      const btnNorth = $('#btn-north');
      const btnHeading = $('#btn-heading');

      const btnCurrent = $('#btn-current');
      const btnDest = $('#btn-dest');
      const btnReroute = $('#btn-reroute');

      const startLng = $('#start-lng');
      const startLat = $('#start-lat');
      const endLng = $('#end-lng');
      const endLat = $('#end-lat');

      const btnSave = $('#btn-save');
      const btnSetDest = $('#btn-set-dest');
      const btnStart = $('#btn-start');
      const btnStop = $('#btn-stop');

      const needle = $('#compass-needle');

      /***********************
       * ツール
       ************************/
      const sleep = ms => new Promise(r=>setTimeout(r,ms));
      function setStatus(msg){ statusEl.textContent = msg || ''; }
      function asLatLng(lngInput, latInput){
        const lng = parseFloat(lngInput.value);
        const lat = parseFloat(latInput.value);
        if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng];
        return null;
      }

      /***********************
       * 音声検索（Web Speech API 簡易）
       ************************/
      let recog = null;
      function ensureRecog(){
        if (recog) return recog;
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) return null;
        recog = new SR();
        recog.lang = langCodeToBCP47(currentLang);
        recog.interimResults = false;
        recog.continuous = false;
        recog.onstart = ()=> { isRecording=true; btnVoice.classList.add('recording'); setStatus('録音中…'); };
        recog.onend   = ()=> { isRecording=false; btnVoice.classList.remove('recording'); };
        recog.onerror = (e)=> { setStatus('音声認識エラー：' + e.error); };
        recog.onresult= (e)=> {
          const t = e.results[0][0].transcript;
          qInput.value = t;
          setStatus(\`検索準備：\${t}\`);
        };
        return recog;
      }
      btnVoice.addEventListener('mousedown', ()=> { const r=ensureRecog(); if (r) r.start(); });
      btnVoice.addEventListener('touchstart', (ev)=> { ev.preventDefault(); const r=ensureRecog(); if (r) r.start(); });

      /***********************
       * 言語
       ************************/
      $$('.lang-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          $$('.lang-btn').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          currentLang = b.dataset.lang;
          setStatus(\`言語：\${b.textContent}\`);
          const r = ensureRecog();
          if (r) r.lang = langCodeToBCP47(currentLang);
        });
      });

      /***********************
       * ルートモード
       ************************/
      $$('.mode-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          $$('.mode-btn').forEach(x=>x.classList.remove('selected'));
          b.classList.add('selected');
          currentMode = b.dataset.mode;
          setStatus(\`ルート：\${b.textContent}\`);
        });
      });

      /***********************
       * 現在地と方位
       ************************/
      btnCurrent.addEventListener('click', async ()=>{
        try{
          const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
          map.setView([p.coords.latitude, p.coords.longitude], 17);
          updateUserMarker(p.coords.latitude, p.coords.longitude);
          startLng.value = p.coords.longitude.toFixed(6);
          startLat.value = p.coords.latitude.toFixed(6);
          setStatus('現在地をセットしました');
        }catch(e){
          setStatus('現在地エラー：'+e.message);
        }
      });

      function getCurrentPosition(opts={}){
        return new Promise((res,rej)=>{
          navigator.geolocation.getCurrentPosition(res,rej,opts);
        });
      }
      function watchHeading(){
        if (watchId) return;
        watchId = navigator.geolocation.watchPosition(p=>{
          headingDeg = (p.coords.heading || 0);
          updateNeedle(headingDeg);
          if (btnHeading.dataset.active === '1'){
            map.panTo([p.coords.latitude, p.coords.longitude], {animate:true});
            updateUserMarker(p.coords.latitude, p.coords.longitude);
          }
        }, ()=>{}, {enableHighAccuracy:true, maximumAge:3000, timeout:15000});
      }
      function updateNeedle(deg){
        needle.style.transform = \`translate(-50%,-90%) rotate(\${deg}deg)\`;
      }
      function updateUserMarker(lat,lng){
        if (!userMarker){
          userMarker = L.marker([lat,lng]).addTo(map);
        }else{
          userMarker.setLatLng([lat,lng]);
        }
      }
      btnNorth.addEventListener('click', ()=>{
        btnHeading.dataset.active = '0';
        setStatus('北固定');
      });
      btnHeading.addEventListener('click', ()=>{
        btnHeading.dataset.active = (btnHeading.dataset.active === '1' ? '0' : '1');
        setStatus(btnHeading.dataset.active==='1'?'進行方向モード':'進行方向OFF');
      });
      watchHeading();

      /***********************
       * 検索 → 結果スライド → 目的地セット → ルート取得
       ************************/
      btnSearch.addEventListener('click', async ()=>{
        const text = qInput.value.trim();
        if (!text){ setStatus('検索ワードを入力'); return; }
        btnSearch.classList.add('loading'); btnVoice.classList.add('loading');
        try{
          const resp = await fetch(PLACES_SEARCH_URL,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ textQuery:text, languageCode: langCodeToBCP47(currentLang) })
          });
          const data = await resp.json();
          lastResults = (data.places||[]).map(p=>({
            id: p.id,
            name: p.displayName?.text || p.name || '(no name)',
            address: p.formattedAddress || '',
            loc: p.location ? [p.location.latitude, p.location.longitude] : null
          }));
          renderResults(lastResults);
          showResults(true); // スライド表示
          addHistory(text);
          setStatus(\`検索：\${lastResults.length}件\`);
        }catch(e){
          setStatus('検索失敗：'+e.message);
        }finally{
          btnSearch.classList.remove('loading'); btnVoice.classList.remove('loading');
        }
      });

      function renderResults(items){
        resultsList.innerHTML = '';
        if (!items.length){
          resultsList.innerHTML = '<li>見つかりませんでした</li>';
          return;
        }
        for (const r of items){
          const li = document.createElement('li');
          li.innerHTML = \`<div><strong>\${escapeHtml(r.name)}</strong></div>
                          <div style="opacity:.85">\${escapeHtml(r.address)}</div>\`;
          li.addEventListener('click', ()=>{
            if (r.loc){
              endLat.value = r.loc[0].toFixed(6);
              endLng.value = r.loc[1].toFixed(6);
              putDestMarker(r.loc[0], r.loc[1], r.name);
              showResults(false);
              // ルート取得に自動遷移（仕様通り）
              btnStart.click();
            }
          });
          resultsList.appendChild(li);
        }
      }

      $('#btn-close-results').addEventListener('click', ()=> showResults(false));
      function showResults(flag){
        resultsEl.classList.toggle('show', !!flag);
      }

      function putDestMarker(lat,lng,name){
        if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
        destMarker.setLatLng([lat,lng]).bindPopup(name||'目的地').openPopup();
        map.setView([lat,lng], 17);
      }

      btnSetDest.addEventListener('click', ()=>{
        const ll = asLatLng(endLng, endLat);
        if (!ll){ setStatus('目的地の緯度経度が不正'); return; }
        putDestMarker(ll[0], ll[1], '目的地');
        setStatus('目的地をセットしました');
      });

      /***********************
       * ルート取得・案内
       ************************/
      btnStart.addEventListener('click', async ()=>{
        const start = asLatLng(startLng, startLat);
        const end   = asLatLng(endLng, endLat);

        if (!start){
          try{
            const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
            startLat.value = p.coords.latitude.toFixed(6);
            startLng.value = p.coords.longitude.toFixed(6);
          }catch(e){
            setStatus('開始地点が未設定です'); return;
          }
        }
        const s = asLatLng(startLng, startLat);
        const e = asLatLng(endLng, endLat);
        if (!s || !e){ setStatus('緯度経度の入力を確認'); return; }

        setStatus('ルート取得中…'); btnStart.classList.add('loading');
        try{
          const url = new URL(DIRECTIONS_URL);
          url.searchParams.set('origin', \`\${s[0]},\${s[1]}\`);
          url.searchParams.set('destination', \`\${e[0]},\${e[1]}\`);
          url.searchParams.set('mode','walking');
          url.searchParams.set('language', langCodeToBCP47(currentLang));

          const resp = await fetch(url.toString());
          const data = await resp.json();
          if (data.status !== 'OK'){ throw new Error(data.error_message || data.status); }

          drawRoute(data);
          showResults(false);
          setStatus('案内を開始しました');
        }catch(e){
          setStatus('ルート取得エラー：'+e.message);
        }finally{
          btnStart.classList.remove('loading');
        }
      });

      function drawRoute(d){
        if (routeLayer){ routeLayer.remove(); routeLayer=null; }
        const path = decodePolyline(d.routes[0].overview_polyline.points);
        routeLayer = L.polyline(path, {color:'#22c55e', weight:7, opacity:.88}).addTo(map);
        const bounds = L.latLngBounds(path);
        map.fitBounds(bounds.pad(0.2));
      }

      btnStop.addEventListener('click', ()=>{
        if (routeLayer){ routeLayer.remove(); routeLayer=null; }
        setStatus('案内を停止しました');
        endLat.value=''; endLng.value='';
        if (destMarker){ destMarker.remove(); destMarker=null; }
      });

      btnReroute.addEventListener('click', ()=>{ btnStart.click(); });

      /***********************
       * 保存・履歴
       ************************/
      const LS_SAVED = 'walknav_saved';
      const LS_HISTORY = 'walknav_hist';

      btnSave.addEventListener('click', async ()=>{
        try{
          const p = await getCurrentPosition({enableHighAccuracy:true,timeout:10000});
          const store = JSON.parse(localStorage.getItem(LS_SAVED)||'[]');
          store.unshift({ t:Date.now(), lat:p.coords.latitude, lng:p.coords.longitude });
          localStorage.setItem(LS_SAVED, JSON.stringify(store.slice(0,50)));
          setStatus('現在地を保存しました');
        }catch(e){
          setStatus('保存失敗：'+e.message);
        }
      });

      function addHistory(text){
        const h = JSON.parse(localStorage.getItem(LS_HISTORY)||'[]');
        h.unshift({ t:Date.now(), text });
        localStorage.setItem(LS_HISTORY, JSON.stringify(h.slice(0,50)));
      }
      btnClearHistory.addEventListener('click', ()=>{
        localStorage.removeItem(LS_HISTORY);
        endLat.value=''; endLng.value='';
        if (destMarker){ destMarker.remove(); destMarker=null; }
        setStatus('履歴をクリアしました');
      });

      /***********************
       * 目的地ボタン（座標→地図中心へ）
       ************************/
      btnDest.addEventListener('click', ()=>{
        const e = asLatLng(endLng, endLat);
        if (!e){ setStatus('目的地が未設定'); return; }
        map.setView([e[0], e[1]], 17);
      });

      /***********************
       * ユーティリティ
       ************************/
      function decodePolyline(str){
        let index = 0, lat = 0, lng = 0, coordinates = [];
        while (index < str.length) {
          let b, shift = 0, result = 0;
          do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
          let dlat = (result & 1) ? ~(result >> 1) : (result >> 1);
          lat += dlat;
          shift = 0; result = 0;
          do { b = str.charCodeAt(index++) - 63; result |= (b & 0x1f) << shift; shift += 5; } while (b >= 0x20);
          let dlng = (result & 1) ? ~(result >> 1) : (result >> 1);
          lng += dlng;
          coordinates.push([lat * 1e-5, lng * 1e-5]);
        }
        return coordinates;
      }
      function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
      function langCodeToBCP47(l){
        switch(l){
          case 'ja': return 'ja';
          case 'en': return 'en';
          case 'de': return 'de';
          case 'it': return 'it';
          case 'fr': return 'fr';
          case 'es': return 'es';
          case 'ko': return 'ko';
          case 'zh': return 'zh';
          default: return 'ja';
        }
      }
    });
  </script>
</body>
</html>
