<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>

  <!-- ç™ºè¡Œç•ªå· / ISSUE -->
  <meta name="x-issue" content="idx202511011945" />
  <meta name="description" content="WalkNav - è¿‘ãã‚’æ¤œç´¢ & ãƒ«ãƒ¼ãƒˆæ¡ˆå†…" />

  <style>
    :root{
      --bg:#0b1220;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.9);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --primary:#62b5ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --shadow:0 10px 35px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}

    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* å³å´ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ */
    .fab-stack{
      position:fixed;right:16px;bottom:96px;display:flex;flex-direction:column;gap:12px;
      z-index:2600;
    }
    .panel{
      position:absolute;left:16px;right:110px;top:16px;
      background:var(--glass-strong);border:1px solid var(--stroke);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px 14px 12px;backdrop-filter:blur(10px);
    }
    .panel h2{margin:0 0 10px;font-size:20px;letter-spacing:.5px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);font-size:14px;cursor:pointer;user-select:none}
    .chip.active{background:var(--primary);color:#05233a;border-color:transparent}
    .input{
      flex:1;min-width:220px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);outline:none
    }
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;user-select:none
    }
    .btn.primary{background:var(--primary);color:#051a2a;border-color:transparent}
    .btn.danger{background:var(--danger);color:#240808;border-color:transparent}
    .btn:disabled{opacity:.5;pointer-events:none}

    /* å³å´ã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ */
    .fab-stack{
      position:fixed;right:16px;bottom:96px;display:flex;flex-direction:column;gap:12px;
      z-index:2600;
    }
    .fab{
      min-width:112px; height:56px; display:flex;align-items:center;justify-content:center;
      background:var(--glass-strong); border:1px solid var(--stroke); border-radius:18px;
      color:var(--text); box-shadow:var(--shadow); cursor:pointer; user-select:none;
    }
    .fab:active{transform:translateY(1px)}

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å…¨ç”»é¢ï¼ˆåˆæœŸä½ç½®å–å¾—æ™‚ã®ã¿ï¼‰ */
    .loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000; color:#fff; font-size:20px; z-index:3000
    }

    /* ãƒˆãƒ¼ã‚¹ãƒˆ/ã‚¨ãƒ©ãƒ¼æŠ‘æ­¢ï¼ˆç”»é¢ã«ä¹—ã›ãªã„ï¼‰ */
    .toast, .error-banner{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="åœ°å›³"></div>

    <!-- æ¤œç´¢ãƒ‘ãƒãƒ«ï¼ˆå¿…è¦æœ€ä½é™ã€‚æ©Ÿèƒ½ã¯è§¦ã‚‰ãšUIã®ã¿ï¼‰ -->
    <section class="panel" id="searchPanel" aria-label="æ¤œç´¢ãƒ‘ãƒãƒ«">
      <h2>è¿‘ãã‚’æ¤œç´¢ï¼ˆ<span id="radiusLabel">10km</span> / 5ä»¶ï¼‰</h2>
      <div class="row" style="margin-bottom:8px">
        <button class="chip active" id="r10">10km</button>
        <button class="chip" id="r20">20km</button>
        <button class="chip" id="btnPointSearch" style="margin-left:auto">ğŸ“ åœ°ç‚¹æ¤œç´¢</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="q" class="input" placeholder="åº—èˆ—åãƒ»é›»è©±ç•ªå·ãƒ»ä½æ‰€ãƒ»åº§æ¨™ãªã©" />
        <button id="btnText" class="btn primary">å…¥åŠ›æ¤œç´¢</button>
        <button id="btnVoice" class="btn">éŸ³å£°æ¤œç´¢</button>
        <button id="btnReset" class="btn danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="row" style="font-size:13px;color:var(--muted)">
        ç¾åœ¨åœ°ï¼š<span id="locLabel">ç·¯åº¦ -- / çµŒåº¦ --</span>
      </div>
    </section>

    <!-- å³å´ FAB ç¾¤ï¼ˆè¡¨ç¤ºã®ã¿å¾©æ´»ï¼‰ -->
    <div class="fab-stack" id="fabStack">
      <div class="fab" id="btnLocate">ç¾åœ¨åœ°</div>
      <div class="fab" id="btnPause">ä¸€æ™‚åœæ­¢</div>
      <div class="fab" id="btnReroute">ãƒªãƒ«ãƒ¼ãƒˆ</div>
    </div>

    <!-- åˆæœŸãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼ˆç¾åœ¨åœ°å–å¾—å®Œäº†ã¾ã§è¡¨ç¤ºï¼‰ -->
    <div class="loading" id="loading">
      <div style="text-align:center">
        <div style="font-size:24px;margin-bottom:16px">ğŸ“ ç¾åœ¨åœ°å–å¾—ä¸­</div>
        <div style="font-size:16px;opacity:0.8">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</div>
      </div>
    </div>
  </div>

  <script>
    // ====== ç™ºè¡Œç•ªå·ï¼ˆç”»é¢ä¸‹éƒ¨ãƒãƒŠãƒ¼ã«ãƒ¡ãƒ¢ï¼‰ ======
    const ISSUE_ID = 'idx202511011945';

    // ====== Google Maps åˆæœŸåŒ– ======
    let map, userMarker;
    let currentPos = null;
    let pointSearchMode = false; // åœ°ç‚¹æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰
    let searchPoint = null; // æ¤œç´¢åœ°ç‚¹
    let searchPointMarker = null; // æ¤œç´¢åœ°ç‚¹ãƒãƒ¼ã‚«ãƒ¼

    // AdvancedMarkerElement ã‚’ä½¿ã£ãŸæ³¢ç´‹ä»˜ãç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
    function setUserMarker(lat, lng){
      currentPos = {lat, lng};
      // æ³¢ç´‹ CSS ã‚’ ShadowRoot ã§ä½œã‚‹
      const pin = document.createElement('div');
      pin.style.width='22px'; pin.style.height='22px'; pin.style.borderRadius='50%';
      pin.style.background='#3aa0ff'; pin.style.boxShadow='0 0 0 6px rgba(98,181,255,.25)';
      pin.style.border='2px solid #fff';

      if(!userMarker){
        userMarker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: {lat,lng},
          content: pin,
          zIndex: 1000
        });
      }else{
        userMarker.position = {lat,lng};
      }
    }

    function initMap(center){
      map = new google.maps.Map(document.getElementById('map'),{
        center,
        zoom: 17,           // æ‹¡å¤§ï¼ˆåˆæœŸã¯å¤§ãã‚ï¼‰
        mapId: 'DEMO_MAP',  // ä»»æ„ã®ID
        gestureHandling:'greedy',
        clickableIcons:true,
        disableDefaultUI:true
      });
    }

    // ====== ç¾åœ¨åœ°ã®å–å¾—ï¼ˆåˆæœŸå€¤=ç¾åœ¨åœ°ä¸€æŠãƒ»å¤±æ•—æ™‚ã¯åœ°å›³éè¡¨ç¤ºã®ã¾ã¾ï¼‰ ======
    function acquireLocation(){
      const onOk = (pos)=>{
        const {latitude, longitude} = pos.coords;
        document.getElementById('loading')?.remove(); // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’æ¶ˆã™
        if(!map) initMap({lat:latitude, lng:longitude});
        map.setCenter({lat:latitude,lng:longitude});
        setUserMarker(latitude, longitude);

        // ãƒ©ãƒ™ãƒ«æ›´æ–°ï¼ˆåº§æ¨™ã®ã¿ä¸€æ—¦è¡¨ç¤ºï¼‰
        document.getElementById('locLabel').textContent = `ç·¯åº¦ ${latitude.toFixed(6)} / çµŒåº¦ ${longitude.toFixed(6)}`;
        
        // åœ°åã‚’å–å¾—ï¼ˆNominatim Reverse Geocodingï¼‰
        fetchLocationName(latitude, longitude);
      };
      const onErr = (_e)=>{
        // ç”»é¢ã¸ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯ç¦æ­¢ï¼šã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã¿ã«å‡ºã™
        console.log('[WalkNav] geolocation error', _e?.message||_e);
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã¯æ®‹ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–¹é‡ã«åˆã‚ã›ã¦éè¡¨ç¤ºã§ã‚‚å¯ï¼‰
        // ãŸã ã—åœ°å›³ã¯æœ€ä½é™è¡¨ç¤ºã—ã¦ãŠãï¼ˆç¾åœ¨åœ°ä¸æ˜ï¼‰
        if(!map) initMap({lat:35.0,lng:135.0}); // å‚ç…§ç”¨ï¼šå³åº§ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç¾åœ¨åœ°å–å¾—ã§ä¸Šæ›¸ãã•ã‚Œã‚‹
      };
      try{
        navigator.geolocation.getCurrentPosition(onOk,onErr,{enableHighAccuracy:true,timeout:30000,maximumAge:0});
      }catch(e){
        console.log('[WalkNav] geolocation exception', e);
      }
    }

    // ====== åœ°åå–å¾— ======
    async function fetchLocationName(lat, lng){
      try{
        const response = await fetch(
          `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&accept-language=ja`
        );
        const data = await response.json();
        
        // åœ°åã‚’æ§‹ç¯‰
        const addr = data.address || {};
        let locationName = '';
        
        // å„ªå…ˆé †ä½: å¸‚ç”ºæ‘ > éƒ¡ > éƒ½é“åºœçœŒ
        if(addr.city) locationName = addr.city;
        else if(addr.town) locationName = addr.town;
        else if(addr.village) locationName = addr.village;
        else if(addr.county) locationName = addr.county;
        else if(addr.state) locationName = addr.state;
        
        // åœ°åŒºåãŒã‚ã‚Œã°è¿½åŠ 
        if(addr.suburb) locationName += addr.suburb;
        else if(addr.hamlet) locationName += addr.hamlet;
        
        if(locationName) locationName += 'ä»˜è¿‘';
        else locationName = 'ä½ç½®æƒ…å ±å–å¾—å®Œäº†';
        
        // ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°
        document.getElementById('locLabel').textContent = locationName;
        
      }catch(e){
        console.log('[WalkNav] location name fetch error', e);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åº§æ¨™è¡¨ç¤ºã®ã¾ã¾
      }
    }

    // ====== UIï¼ˆæœ€å°é™ã€‚æ©Ÿèƒ½æœ¬ä½“ã¯è§¦ã‚‰ãªã„ï¼‰ ======
    function bindUI(){
      const radiusLabel = document.getElementById('radiusLabel');
      const r10 = document.getElementById('r10');
      const r20 = document.getElementById('r20');
      r10.onclick = ()=>{ r10.classList.add('active'); r20.classList.remove('active'); radiusLabel.textContent='10km'; };
      r20.onclick = ()=>{ r20.classList.add('active'); r10.classList.remove('active'); radiusLabel.textContent='20km'; };

      // å³ã‚µã‚¤ãƒ‰ FAB - ã™ã¹ã¦æœ‰åŠ¹åŒ–
      document.getElementById('btnLocate').onclick = ()=>{
        if(currentPos && map) {
          map.panTo(currentPos);
          map.setZoom(17);
        }
      };
      
      document.getElementById('btnPause').onclick = ()=>{ 
        console.log('ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      };
      
      document.getElementById('btnReroute').onclick = ()=>{ 
        console.log('ãƒªãƒ«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      };

      // æ¤œç´¢ãƒœã‚¿ãƒ³ - ã™ã¹ã¦æœ‰åŠ¹åŒ–
      document.getElementById('btnText').onclick = ()=>{
        const q = document.getElementById('q').value.trim();
        if(q) console.log('ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢:', q);
      };
      
      document.getElementById('btnVoice').onclick = ()=>{
        console.log('éŸ³å£°æ¤œç´¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      };
      
      document.getElementById('btnReset').onclick = ()=>{
        document.getElementById('q').value = '';
        console.log('ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      };
    }

    // ====== èµ·å‹• ======
    window.addEventListener('DOMContentLoaded', function(){
      // UIã¯æ—¥æœ¬èªã‚’åˆæœŸå€¤ï¼ˆå¼·åˆ¶ï¼‰
      document.documentElement.lang = 'ja';
      bindUI();
      acquireLocation();
      console.log('[WalkNav] ISSUE', ISSUE_ID, 'boot');
    });
  </script>

  <!-- Google Maps JS APIï¼ˆAdvancedMarkerElement åˆ©ç”¨ï¼‰ -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk&v=weekly&libraries=marker"
    async defer></script>
</body>
</html>
