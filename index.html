<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>

  <!-- ç™ºè¡Œç•ªå· / ISSUE -->
  <meta name="x-issue" content="idx202511011945" />
  <meta name="description" content="WalkNav - è¿‘ãã‚’æ¤œç´¢ & ãƒ«ãƒ¼ãƒˆæ¡ˆå†…" />

  <style>
    :root{
      --bg:#0b1220;
      --glass: rgba(20,28,44,.78);
      --glass-strong: rgba(16,22,36,.9);
      --stroke: rgba(255,255,255,.12);
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --primary:#62b5ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --shadow:0 10px 35px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.06);
      --radius:18px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}

    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    .fab-stack{
      position:fixed;right:16px;bottom:96px;display:flex;flex-direction:column;gap:12px;
      z-index:2600;
    }
    .panel{
      position:absolute;left:16px;right:110px;top:16px;
      background:var(--glass-strong);border:1px solid var(--stroke);
      border-radius:var(--radius);box-shadow:var(--shadow);
      padding:14px 14px 12px;backdrop-filter:blur(10px);
      z-index:2500;
      max-height:calc(100vh - 32px);
      overflow-y:auto;
    }
    .panel h2{margin:0 0 10px;font-size:20px;letter-spacing:.5px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .chip{padding:8px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);font-size:14px;cursor:pointer;user-select:none}
    .chip.active{background:var(--primary);color:#05233a;border-color:transparent}
    .input{
      flex:1;min-width:220px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);outline:none
    }
    .btn{
      padding:10px 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      cursor:pointer;user-select:none;border:none;
    }
    .btn.primary{background:var(--primary);color:#051a2a;border-color:transparent}
    .btn.danger{background:var(--danger);color:#240808;border-color:transparent}
    .btn:disabled{opacity:.5;pointer-events:none}

    .fab{
      min-width:112px; height:56px; display:flex;align-items:center;justify-content:center;
      background:var(--glass-strong); border:1px solid var(--stroke); border-radius:18px;
      color:var(--text); box-shadow:var(--shadow); cursor:pointer; user-select:none;
      font-size:14px;
    }
    .fab:active{transform:translateY(1px)}

    .loading{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000; color:#fff; font-size:20px; z-index:3000
    }

    .results{
      margin-top:12px;
      background:rgba(0,0,0,.3);
      border-radius:12px;
      padding:8px;
    }
    .result-item{
      padding:10px;
      margin-bottom:6px;
      background:rgba(255,255,255,.05);
      border-radius:8px;
      cursor:pointer;
      transition:background .2s;
    }
    .result-item:hover{
      background:rgba(255,255,255,.1);
    }
    .result-name{
      font-weight:600;
      margin-bottom:4px;
      font-size:16px;
    }
    .result-address{
      font-size:12px;
      color:var(--muted);
    }

    .route-panel{
      position:absolute;
      left:16px;
      bottom:16px;
      right:110px;
      background:var(--glass-strong);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter:blur(10px);
      z-index:2500;
      display:none;
    }
    .route-info{
      font-size:14px;
      margin-bottom:8px;
    }
    .route-distance{
      font-size:24px;
      font-weight:bold;
      color:var(--primary);
    }
    .route-time{
      font-size:16px;
      color:var(--muted);
      margin-left:12px;
    }

    .toast, .error-banner{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="åœ°å›³"></div>

    <section class="panel" id="searchPanel" aria-label="æ¤œç´¢ãƒ‘ãƒãƒ«">
      <h2>è¿‘ãã‚’æ¤œç´¢ï¼ˆ<span id="radiusLabel">10km</span> / 5ä»¶ï¼‰</h2>
      <div class="row" style="margin-bottom:8px">
        <button class="chip active" id="r10">10km</button>
        <button class="chip" id="r20">20km</button>
        <button class="chip" id="btnPointSearch" style="margin-left:auto">ğŸ“ åœ°ç‚¹æ¤œç´¢</button>
      </div>
      <div class="row" style="margin-bottom:8px">
        <input id="q" class="input" placeholder="åº—èˆ—åãƒ»é›»è©±ç•ªå·ãƒ»ä½æ‰€ãƒ»åº§æ¨™ãªã©" />
        <button id="btnText" class="btn primary">å…¥åŠ›æ¤œç´¢</button>
        <button id="btnVoice" class="btn">ğŸ¤ éŸ³å£°æ¤œç´¢</button>
        <button id="btnReset" class="btn danger">ãƒªã‚»ãƒƒãƒˆ</button>
      </div>
      <div class="row" style="font-size:13px;color:var(--muted)">
        ç¾åœ¨åœ°ï¼š<span id="locLabel">ç·¯åº¦ -- / çµŒåº¦ --</span>
      </div>
      
      <div id="results" class="results" style="display:none"></div>
    </section>

    <div class="route-panel" id="routePanel">
      <div class="route-info">
        <span id="destinationName">ç›®çš„åœ°</span>ã¸ã®ãƒ«ãƒ¼ãƒˆ
      </div>
      <div>
        <span class="route-distance" id="routeDistance">--</span>
        <span class="route-time" id="routeTime">å¾’æ­© --åˆ†</span>
      </div>
      <button id="btnStopRoute" class="btn danger" style="margin-top:10px;width:100%">ãƒ«ãƒ¼ãƒˆçµ‚äº†</button>
    </div>

    <div class="fab-stack" id="fabStack">
      <div class="fab" id="btnLocate">ç¾åœ¨åœ°</div>
      <div class="fab" id="btnPause">ä¸€æ™‚åœæ­¢</div>
      <div class="fab" id="btnReroute">ãƒªãƒ«ãƒ¼ãƒˆ</div>
    </div>

    <div class="loading" id="loading">
      <div style="text-align:center">
        <div style="font-size:24px;margin-bottom:16px">ğŸ“ ç¾åœ¨åœ°å–å¾—ä¸­</div>
        <div style="font-size:16px;opacity:0.8">ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„...</div>
      </div>
    </div>
  </div>

  <script>
    const ISSUE_ID = 'idx202511011945';
    const API_KEY = 'AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk'; // Mapsè¡¨ç¤ºç”¨ã®ã¿
    const WORKER_ORIGIN = 'https://ors-proxy.miyata-connect-jp.workers.dev'; // æ—¢å­˜Worker

    let map, userMarker, directionsRenderer, geocoder;
    let currentPos = null;
    let pointSearchMode = false;
    let searchPoint = null;
    let searchPointMarker = null;
    let longPressTimer = null;
    let mapInitialized = false;
    let searchMarkers = [];
    let currentDestination = null;
    let recognition = null;

    const DEFAULT_MASK = 'places.displayName,places.formattedAddress,places.location,places.id,places.types';

    // Cloudflare WorkerçµŒç”± - Text Search
    async function placesTextSearch(payload, fieldMask) {
      const resp = await fetch(`${WORKER_ORIGIN}/places:searchText`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(fieldMask ? { 'X-Goog-FieldMask': fieldMask } : {})
        },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const t = await resp.text();
        throw new Error(`TextSearch ${resp.status}: ${t}`);
      }
      return resp.json();
    }

    // Cloudflare WorkerçµŒç”± - Nearby Search
    async function placesNearby(payload, fieldMask) {
      const resp = await fetch(`${WORKER_ORIGIN}/places:searchNearby`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          ...(fieldMask ? { 'X-Goog-FieldMask': fieldMask } : {})
        },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) {
        const t = await resp.text();
        throw new Error(`Nearby ${resp.status}: ${t}`);
      }
      return resp.json();
    }

    function setUserMarker(lat, lng){
      currentPos = {lat, lng};
      const pin = document.createElement('div');
      pin.style.width='22px'; pin.style.height='22px'; pin.style.borderRadius='50%';
      pin.style.background='#3aa0ff'; pin.style.boxShadow='0 0 0 6px rgba(98,181,255,.25)';
      pin.style.border='2px solid #fff';

      if(!userMarker){
        userMarker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: {lat,lng},
          content: pin,
          zIndex: 1000
        });
      }else{
        userMarker.position = {lat,lng};
      }
    }

    function initMap(center){
      map = new google.maps.Map(document.getElementById('map'),{
        center,
        zoom: 17,
        mapId: 'DEMO_MAP',
        gestureHandling:'greedy',
        clickableIcons:true,
        disableDefaultUI:true
      });

      // DirectionsRenderer ã®ã¿åˆæœŸåŒ–ï¼ˆDirectionsServiceã¯ä¸è¦ï¼‰
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        suppressMarkers: false,
        polylineOptions: {
          strokeColor: '#62b5ff',
          strokeWeight: 6,
          strokeOpacity: 0.8
        }
      });

      geocoder = new google.maps.Geocoder();

      map.addListener('mousedown', (e) => {
        if(!pointSearchMode) return;
        longPressTimer = setTimeout(() => {
          setSearchPoint(e.latLng.lat(), e.latLng.lng());
        }, 1000);
      });

      map.addListener('mouseup', () => {
        if(longPressTimer){
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      map.addListener('touchstart', (e) => {
        if(!pointSearchMode || !e.latLng) return;
        longPressTimer = setTimeout(() => {
          setSearchPoint(e.latLng.lat(), e.latLng.lng());
        }, 1000);
      });

      map.addListener('touchend', () => {
        if(longPressTimer){
          clearTimeout(longPressTimer);
          longPressTimer = null;
        }
      });

      mapInitialized = true;
      console.log('[WalkNav] Map initialized');
    }

    function setSearchPoint(lat, lng){
      searchPoint = {lat, lng};
      
      if(searchPointMarker){
        searchPointMarker.map = null;
      }

      const pin = document.createElement('div');
      pin.style.width='30px';
      pin.style.height='30px';
      pin.style.borderRadius='50% 50% 50% 0';
      pin.style.background='#ff6565';
      pin.style.border='3px solid #fff';
      pin.style.transform='rotate(-45deg)';
      pin.style.boxShadow='0 4px 8px rgba(0,0,0,.3)';

      searchPointMarker = new google.maps.marker.AdvancedMarkerElement({
        map,
        position: {lat, lng},
        content: pin,
        zIndex: 999
      });

      console.log(`[WalkNav] æ¤œç´¢åœ°ç‚¹è¨­å®š: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
      map.panTo({lat, lng});
    }

    async function startNavigation(destination){
      if(!currentPos){
        alert('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“');
        return;
      }

      currentDestination = destination;

      try {
        // WorkerçµŒç”±ã§Directions APIã‚’å‘¼ã³å‡ºã—
        const params = new URLSearchParams({
          origin: `${currentPos.lat},${currentPos.lng}`,
          destination: `${destination.lat},${destination.lng}`,
          mode: 'walking',
          language: 'ja'
        });

        const response = await fetch(`${WORKER_ORIGIN}/directions?${params.toString()}`);
        
        if(!response.ok){
          throw new Error(`Directions API Error: ${response.status}`);
        }

        const result = await response.json();

        if(result.status === 'OK' && result.routes && result.routes.length > 0){
          // DirectionsRendererã«ã‚»ãƒƒãƒˆï¼ˆGoogleå½¢å¼ã«æ•´å½¢ï¼‰
          const directionsResult = {
            routes: result.routes,
            request: {
              origin: { lat: currentPos.lat, lng: currentPos.lng },
              destination: { lat: destination.lat, lng: destination.lng },
              travelMode: 'WALKING'
            }
          };
          directionsRenderer.setDirections(directionsResult);
          
          const route = result.routes[0].legs[0];
          const distance = route.distance.text;
          const duration = route.duration.text;

          document.getElementById('destinationName').textContent = destination.name;
          document.getElementById('routeDistance').textContent = distance;
          document.getElementById('routeTime').textContent = `å¾’æ­© ${duration}`;
          document.getElementById('routePanel').style.display = 'block';

          document.getElementById('searchPanel').style.display = 'none';
          document.getElementById('results').style.display = 'none';

          map.panTo({lat: destination.lat, lng: destination.lng});
          map.setZoom(18);

          console.log(`[Navigation] ãƒ«ãƒ¼ãƒˆæ¡ˆå†…é–‹å§‹: ${destination.name}`);
        }else{
          console.error('[Navigation] ãƒ«ãƒ¼ãƒˆå–å¾—å¤±æ•—:', result.status);
          alert('ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
        }
      } catch(error) {
        console.error('[Navigation] Error:', error);
        alert('ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
      }
    }

    function stopNavigation(){
      directionsRenderer.setDirections({routes: []});
      currentDestination = null;
      document.getElementById('routePanel').style.display = 'none';
      document.getElementById('searchPanel').style.display = 'block';
      console.log('[Navigation] ãƒ«ãƒ¼ãƒˆæ¡ˆå†…çµ‚äº†');
    }

    function initSpeechRecognition(){
      if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
        console.log('[Voice] éŸ³å£°èªè­˜ã¯éå¯¾å¿œã§ã™');
        return false;
      }

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.continuous = false;
      recognition.interimResults = false;

      recognition.onstart = () => {
        console.log('[Voice] éŸ³å£°èªè­˜é–‹å§‹');
        document.getElementById('btnVoice').textContent = 'ğŸ¤ èã„ã¦ã„ã¾ã™...';
        document.getElementById('btnVoice').style.background = 'var(--ok)';
      };

      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        console.log('[Voice] èªè­˜çµæœ:', transcript);
        document.getElementById('q').value = transcript;
        performSearch(transcript);
      };

      recognition.onerror = (event) => {
        console.error('[Voice] ã‚¨ãƒ©ãƒ¼:', event.error);
        document.getElementById('btnVoice').textContent = 'ğŸ¤ éŸ³å£°æ¤œç´¢';
        document.getElementById('btnVoice').style.background = '';
      };

      recognition.onend = () => {
        console.log('[Voice] éŸ³å£°èªè­˜çµ‚äº†');
        document.getElementById('btnVoice').textContent = 'ğŸ¤ éŸ³å£°æ¤œç´¢';
        document.getElementById('btnVoice').style.background = '';
      };

      return true;
    }

    function startVoiceSearch(){
      if(!recognition){
        if(!initSpeechRecognition()){
          alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
          return;
        }
      }

      try{
        recognition.start();
      }catch(e){
        console.error('[Voice] é–‹å§‹ã‚¨ãƒ©ãƒ¼:', e);
        recognition.stop();
        setTimeout(() => {
          try{
            recognition.start();
          }catch(e2){
            console.error('[Voice] å†é–‹ã‚¨ãƒ©ãƒ¼:', e2);
          }
        }, 100);
      }
    }

    const TYPE_MAP = {
      "ã‚³ãƒ³ãƒ“ãƒ‹":"convenience_store",
      "ã‚¹ãƒ¼ãƒ‘ãƒ¼":"supermarket",
      "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³":"restaurant",
      "ã‚«ãƒ•ã‚§":"cafe",
      "ãƒ›ãƒ†ãƒ«":"lodging",
      "ç—…é™¢":"hospital",
      "è–¬å±€":"pharmacy",
      "ã‚¬ã‚½ãƒªãƒ³ã‚¹ã‚¿ãƒ³ãƒ‰":"gas_station",
      "é§è»Šå ´":"parking",
      "éŠ€è¡Œ":"bank"
    };

    async function performSearch(query){
      if(!query || !query.trim()) {
        console.log('[Search] æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã§ã™');
        return;
      }

      let centerLat, centerLng;
      
      if(pointSearchMode && searchPoint){
        centerLat = searchPoint.lat;
        centerLng = searchPoint.lng;
        console.log(`[Search] åœ°ç‚¹æ¤œç´¢: "${query}"`);
      }else if(currentPos){
        centerLat = currentPos.lat;
        centerLng = currentPos.lng;
        console.log(`[Search] ç¾åœ¨åœ°æ¤œç´¢: "${query}"`);
      }else{
        console.log('[Search] æ¤œç´¢ã®åŸºæº–åœ°ç‚¹ãŒä¸æ˜ã§ã™');
        return;
      }

      const radiusKm = parseInt(document.getElementById('radiusLabel').textContent);
      const radiusMeters = radiusKm * 1000;

      // Text Searchå„ªå…ˆ
      try {
        const data = await placesTextSearch({
          textQuery: query.trim(),
          locationBias: {
            circle: { center: { latitude: centerLat, longitude: centerLng }, radius: radiusMeters }
          },
          maxResultCount: 20,
          languageCode: 'ja'
        }, DEFAULT_MASK);

        if (data.places?.length) {
          displayResults(data.places, centerLat, centerLng);
          return;
        }
      } catch (e) {
        console.error('[Search] Text Search Error:', e);
      }

      // Nearby Searchï¼ˆã‚¿ã‚¤ãƒ—ãŒä¸€è‡´ã™ã‚‹å ´åˆã®ã¿ï¼‰
      const typeKey = TYPE_MAP[query.trim()] || TYPE_MAP[query.trim().replace(/\s/g,'')];

      if (typeKey) {
        try {
          const data = await placesNearby({
            includedTypes: [typeKey],
            maxResultCount: 20,
            locationRestriction: {
              circle: { center: { latitude: centerLat, longitude: centerLng }, radius: radiusMeters }
            },
            languageCode: 'ja'
          }, DEFAULT_MASK);

          if (data.places?.length) {
            displayResults(data.places, centerLat, centerLng);
            return;
          }
        } catch (e) {
          console.error('[Search] Nearby Error:', e);
        }
      }

      alert('æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      document.getElementById('results').style.display = 'none';
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function displayResults(places, centerLat, centerLng){
      searchMarkers.forEach(marker => marker.map = null);
      searchMarkers = [];

      const placesWithDistance = places.map(place => {
        const lat = place.location.latitude;
        const lng = place.location.longitude;
        const distance = calculateDistance(centerLat, centerLng, lat, lng);
        return {...place, distance};
      });

      placesWithDistance.sort((a, b) => a.distance - b.distance);

      const limitedResults = placesWithDistance.slice(0, 5);

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = '';
      resultsDiv.style.display = 'block';

      limitedResults.forEach((place, index) => {
        const name = place.displayName?.text || place.displayName || 'åç§°ä¸æ˜';
        const address = place.formattedAddress || 'ä½æ‰€ä¸æ˜';
        const lat = place.location.latitude;
        const lng = place.location.longitude;
        const distanceKm = (place.distance / 1000).toFixed(2);

        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
          <div class="result-name">${index + 1}. ${name}</div>
          <div class="result-address">${address}</div>
          <div style="font-size:11px;color:#62b5ff;margin-top:4px">
            ğŸ“ ${distanceKm}km
          </div>
        `;
        
        item.onclick = () => {
          startNavigation({
            name: name,
            lat: lat,
            lng: lng
          });
        };

        resultsDiv.appendChild(item);

        const markerPin = document.createElement('div');
        markerPin.style.width='24px';
        markerPin.style.height='24px';
        markerPin.style.borderRadius='50%';
        markerPin.style.background='#25d07a';
        markerPin.style.border='2px solid #fff';
        markerPin.style.boxShadow='0 2px 6px rgba(0,0,0,.3)';
        markerPin.style.display='flex';
        markerPin.style.alignItems='center';
        markerPin.style.justifyContent='center';
        markerPin.style.color='#fff';
        markerPin.style.fontSize='12px';
        markerPin.style.fontWeight='bold';
        markerPin.textContent = index + 1;

        const marker = new google.maps.marker.AdvancedMarkerElement({
          map,
          position: {lat, lng},
          content: markerPin,
          zIndex: 500 + index,
          title: name
        });

        searchMarkers.push(marker);
      });

      console.log(`[Search] ${limitedResults.length}ä»¶ã®çµæœã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
    }

    function acquireLocation(){
      const onOk = (pos)=>{
        const {latitude, longitude} = pos.coords;
        document.getElementById('loading')?.remove();
        if(!map) initMap({lat:latitude, lng:longitude});
        map.setCenter({lat:latitude,lng:longitude});
        setUserMarker(latitude, longitude);

        fetchLocationNameGoogle(latitude, longitude);
      };
      const onErr = (_e)=>{
        console.log('[WalkNav] geolocation error', _e?.message||_e);
        document.getElementById('loading')?.remove();
        if(!map) initMap({lat:35.0,lng:135.0});
      };
      try{
        navigator.geolocation.getCurrentPosition(onOk,onErr,{enableHighAccuracy:true,timeout:30000,maximumAge:0});
      }catch(e){
        console.log('[WalkNav] geolocation exception', e);
      }
    }

    function fetchLocationNameGoogle(lat, lng){
      if(!geocoder) return;

      const latlng = {lat, lng};
      geocoder.geocode({location: latlng, language: 'ja'}, (results, status) => {
        if(status === 'OK' && results[0]){
          const address = results[0].formatted_address;
          document.getElementById('locLabel').textContent = address;
          console.log('[Location] åœ°å:', address);
        }else{
          document.getElementById('locLabel').textContent = `ç·¯åº¦ ${lat.toFixed(6)} / çµŒåº¦ ${lng.toFixed(6)}`;
        }
      });
    }

    function bindUI(){
      console.log('[WalkNav] Binding UI...');
      
      const radiusLabel = document.getElementById('radiusLabel');
      const r10 = document.getElementById('r10');
      const r20 = document.getElementById('r20');
      const btnPointSearch = document.getElementById('btnPointSearch');
      
      r10.onclick = ()=>{ 
        r10.classList.add('active'); 
        r20.classList.remove('active'); 
        radiusLabel.textContent='10km'; 
      };
      
      r20.onclick = ()=>{ 
        r20.classList.add('active'); 
        r10.classList.remove('active'); 
        radiusLabel.textContent='20km'; 
      };

      btnPointSearch.onclick = ()=>{
        pointSearchMode = !pointSearchMode;
        if(pointSearchMode){
          btnPointSearch.classList.add('active');
          btnPointSearch.textContent = 'ğŸ“ åœ°ç‚¹æ¤œç´¢ä¸­...';
        }else{
          btnPointSearch.classList.remove('active');
          btnPointSearch.textContent = 'ğŸ“ åœ°ç‚¹æ¤œç´¢';
        }
      };

      document.getElementById('btnLocate').onclick = ()=>{
        if(currentPos && map) {
          map.panTo(currentPos);
          map.setZoom(18);
        }
      };
      
      document.getElementById('btnPause').onclick = ()=>{ 
        console.log('ä¸€æ™‚åœæ­¢ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      };
      
      document.getElementById('btnReroute').onclick = ()=>{ 
        if(currentDestination){
          startNavigation(currentDestination);
        }
      };

      document.getElementById('btnText').onclick = ()=>{
        const q = document.getElementById('q').value.trim();
        if(!q){
          alert('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        performSearch(q);
      };
      
      document.getElementById('q').addEventListener('keypress', (e) => {
        if(e.key === 'Enter'){
          const q = document.getElementById('q').value.trim();
          if(q) performSearch(q);
        }
      });
      
      document.getElementById('btnVoice').onclick = ()=>{
        startVoiceSearch();
      };
      
      document.getElementById('btnReset').onclick = ()=>{
        document.getElementById('q').value = '';
        document.getElementById('results').style.display = 'none';
        document.getElementById('results').innerHTML = '';
        
        searchMarkers.forEach(marker => marker.map = null);
        searchMarkers = [];
        
        searchPoint = null;
        if(searchPointMarker){
          searchPointMarker.map = null;
          searchPointMarker = null;
        }
        
        pointSearchMode = false;
        btnPointSearch.classList.remove('active');
        btnPointSearch.textContent = 'ğŸ“ åœ°ç‚¹æ¤œç´¢';
        
        stopNavigation();
        
        console.log('[WalkNav] ãƒªã‚»ãƒƒãƒˆå®Œäº†');
      };

      document.getElementById('btnStopRoute').onclick = ()=>{
        stopNavigation();
      };

      console.log('[WalkNav] UI binding complete');
    }

    function startApp(){
      console.log('[WalkNav] Starting app...');
      document.documentElement.lang = 'ja';
      bindUI();
      acquireLocation();
      initSpeechRecognition();
      console.log('[WalkNav] ISSUE', ISSUE_ID, 'boot');
    }

    function initializeWhenReady(){
      if(typeof google !== 'undefined' && google.maps && google.maps.Map){
        startApp();
      }else{
        setTimeout(initializeWhenReady, 100);
      }
    }

    window.addEventListener('DOMContentLoaded', initializeWhenReady);
  </script>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBXC6CB2yaUkrJ5UYj3mymAsruQe4MzGPk&v=weekly&libraries=marker"
    async defer></script>
</body>
</html>
