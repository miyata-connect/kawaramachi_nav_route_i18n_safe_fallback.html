<!DOCTYPE html>
<!-- issue: idx202511011955 -->
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="x-issue" content="idx202511011955">
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321; --text:#eaf2ff; --muted:#a7b8ce; --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78); --stroke: rgba(255,255,255,.12);
      --ok:#25d07a; --danger:#ff6565; --panel: rgba(16,22,36,.85);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* 起動ブロッカー */
    #bootmask{position:absolute;inset:0;background:#000;display:flex;
      align-items:center;justify-content:center;z-index:30;padding:24px;text-align:center;color:#fff}
    #bootmask .msg{max-width:640px;line-height:1.6}

    /* 上パネル */
    #panel{position:absolute;left:12px;right:12px;top:12px;z-index:10;
      background:var(--panel);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      border-radius:16px;padding:12px}
    .row{display:flex;gap:10px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .grow{flex:1 1 0}
    .center{justify-content:center}
    .label{font-weight:600}
    input[type="text"].search{width:100%;height:40px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);padding:0 12px;outline:none}
    input::placeholder{color:var(--muted)}
    .btn{height:40px;min-width:96px;padding:0 14px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);color:var(--text);cursor:pointer}
    .btn.ghost{background:transparent}
    .chip{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 10px;border-radius:999px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.06);cursor:pointer;min-width:64px}
    .chip.on{outline:2px solid var(--accent)}
    .muted{color:var(--muted)}

    /* 右側FAB */
    #side{position:absolute;right:12px;top:50%;transform:translateY(-50%);
      display:flex;flex-direction:column;gap:12px;z-index:12}
    .fab{width:52px;height:52px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;cursor:pointer}

    /* 検索結果 */
    #results{position:absolute;left:12px;right:12px;bottom:12px;z-index:11;
      background:var(--panel);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      border-radius:14px;max-height:40vh;overflow:auto;display:none}
    .item{padding:10px 12px;border-top:1px solid var(--stroke);cursor:pointer}
    .item:first-child{border-top:0}
    .item:hover{background:rgba(255,255,255,.06)}
    .title{font-weight:600}.addr{font-size:12px;color:var(--muted)}.meta{font-size:12px;display:flex;gap:10px;color:var(--muted)}

    /* 成功トースト（恒常エラーは出さない） */
    #toast{position:absolute;left:50%;transform:translateX(-50%);top:72px;
      background:var(--ok);color:#04110a;border-radius:10px;padding:10px 14px;display:none;z-index:40}

    /* 現在地バッジ（パネルと干渉しない位置） */
    #locBadge{position:absolute;left:14px;top:86px;z-index:13;background:rgba(16,22,36,.9);
      border:1px solid var(--stroke);border-radius:10px;padding:6px 10px;color:var(--text);display:none}

    /* 波紋マーカー */
    .pulse{position:absolute;transform:translate(-50%,-50%);width:16px;height:16px;border-radius:999px;background:#ff4d4d;box-shadow:0 0 0 rgba(255,77,77,.6);animation:pulse 2s infinite}
    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,77,77,.6)}70%{box-shadow:0 0 0 20px rgba(255,77,77,0)}100%{box-shadow:0 0 0 0 rgba(255,77,77,0)}}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <!-- 起動ブロッカー（必ず解除される） -->
    <div id="bootmask"><div class="msg" id="bootmsg">
      現在地取得中です。ご迷惑をお掛けします。<br>現在地表示まで <strong>30秒</strong> 程お待ちください。
    </div></div>

    <div id="locBadge">現在地を取得しました。</div>

    <!-- 上部パネル -->
    <section id="panel">
      <div class="row wrap" style="gap:8px 10px">
        <div class="label">任意の場所を検索</div>
        <div class="grow"><input id="q" class="search" type="text" placeholder="店舗名・電話番号・カテゴリ・住所・座標・施設名"></div>
        <button id="btn-input-search" class="btn">入力検索</button>
        <button id="btn-voice-search" class="btn">音声検索</button>
        <button id="btn-reset" class="btn ghost">リセット</button>
      </div>
      <div class="row center" style="margin-top:8px">
        <span class="muted" style="margin-right:8px">近くを検索</span>
        <button class="chip on" id="km10" data-km="10">10km</button>
        <button class="chip"     id="km20" data-km="20">20km</button>
        <button class="chip"     id="km30" data-km="30">30km</button>
        <span id="rangeView" class="muted" style="margin-left:10px">(10km/5件)</span>
      </div>
      <div class="row center" style="margin-top:8px">
        <button id="btn-nearby" class="btn">近くを検索</button>
        <button id="btn-center-pick" class="btn ghost">地図中心で検索</button>
      </div>
      <div class="row center" style="margin-top:8px">
        <span class="muted">現在地：</span><span id="latlng" class="muted">緯度 -- / 経度 --</span>
      </div>
    </section>

    <!-- 右側FAB -->
    <aside id="side">
      <button id="fab-current" class="fab" title="現在地">●</button>
      <button id="fab-pause"   class="fab" title="一時停止">Ⅱ</button>
      <button id="fab-reroute" class="fab" title="リルート">↻</button>
    </aside>

    <section id="results" role="listbox" aria-label="検索結果"></section>
    <div id="toast"></div>
  </div>

  <!-- Maps（日本語/日本） ※キーは必ず差し替え -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=YOUR_BROWSER_API_KEY&v=weekly&language=ja&region=JP"></script>

  <!-- 監査フック最小 -->
  <script>
    window.AUDIT = {
      endpoint: "https://ors-proxy-dev.miyata-connect-jp.workers.dev",
      runStart(p){ try{ fetch(this.endpoint+"/audit/run",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({phase:"start",...p})}); }catch{} },
      runEvent(p){ try{ fetch(this.endpoint+"/audit/event",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify(p)}); }catch{} },
      runEnd(p){ try{ fetch(this.endpoint+"/audit/run",{method:"POST",headers:{'Content-Type':'application/json'},body:JSON.stringify({phase:"end",...p})}); }catch{} }
    };
  </script>

  <!-- 本体 -->
  <script type="module">
    const MAPS_LANG="ja", MAPS_REGION="JP";
    const PLACES_ENDPOINT="https://ors-proxy-dev.miyata-connect-jp.workers.dev/places:searchText";
    const ALLOWED_ORIGIN=location.origin;

    AUDIT.runStart({score:100,errorRate:0,issue:"idx202511011955",note:"index boot"});

    const elMap=document.getElementById("map");
    const elPanel=document.getElementById("panel");
    const elResults=document.getElementById("results");
    const elToast=document.getElementById("toast");
    const elBoot=document.getElementById("bootmask");
    const elBootMsg=document.getElementById("bootmsg");
    const elLatLng=document.getElementById("latlng");
    const elRangeView=document.getElementById("rangeView");
    const elLocBadge=document.getElementById("locBadge");

    const elQ=document.getElementById("q");
    const elBtnInputSearch=document.getElementById("btn-input-search");
    const elBtnVoiceSearch=document.getElementById("btn-voice-search");
    const elBtnReset=document.getElementById("btn-reset");
    const elBtnNearby=document.getElementById("btn-nearby");
    const elBtnCenterPick=document.getElementById("btn-center-pick");
    const elKm10=document.getElementById("km10");
    const elKm20=document.getElementById("km20");
    const elKm30=document.getElementById("km30");

    const elFabCurrent=document.getElementById("fab-current");
    const elFabPause=document.getElementById("fab-pause");
    const elFabReroute=document.getElementById("fab-reroute");

    let map, AdvancedMarkerElement, DirectionsService, DirectionsRenderer;
    let currentPos=null, searchKm=10, pageSize=5, pickingMode=false;
    let pulseMarker=null, centerMarker=null, voiceRec=null;

    const fmtLatLng=(p)=>`緯度 ${p.lat.toFixed(6)} / 経度 ${p.lng.toFixed(6)}`;

    function toast(msg, ok=true, ms=1400){
      elToast.style.background= ok? "var(--ok)":"var(--danger)";
      elToast.textContent=msg; elToast.style.display="block";
      clearTimeout(elToast._t); elToast._t=setTimeout(()=>{elToast.style.display="none"},ms);
    }
    function setRangeUI(){
      [elKm10,elKm20,elKm30].forEach(c=>c.classList.remove("on"));
      (searchKm===10?elKm10:searchKm===20?elKm20:elKm30).classList.add("on");
      elRangeView.textContent=`(${searchKm}km/${pageSize}件)`;
    }
    function showResults(items){
      elResults.innerHTML=""; if(!items||!items.length){elResults.style.display="none";return;}
      items.forEach(p=>{
        const d=document.createElement("div"); d.className="item";
        d.innerHTML=`<div class="title">${p.displayName?.text||"名称不明"}</div>
                     <div class="addr">${p.formattedAddress||"住所不明"}</div>
                     <div class="meta"><span>評価:${p.rating??"-"}</span>
                     <span>種類:${(p.types||[])[0]||"-"}</span></div>`;
        elResults.appendChild(d);
      });
      elPanel.style.display="none"; elResults.style.display="block";
    }
    function hideResults(){ elResults.style.display="none"; elPanel.style.display="block"; }

    function ensurePulseMarker(){
      if(pulseMarker) return;
      const div=document.createElement("div"); div.className="pulse";
      pulseMarker=new AdvancedMarkerElement({map,content:div,position:{lat:0,lng:0}});
    }
    function setPulsePosition(p){ ensurePulseMarker(); pulseMarker.position=p; }

    function ensureCenterMarker(){
      if(centerMarker) return;
      const pin=document.createElement("div");
      pin.style.width="14px";pin.style.height="14px";pin.style.borderRadius="999px";
      pin.style.background="#64d2ff";pin.style.border="2px solid white";
      centerMarker=new AdvancedMarkerElement({map,content:pin,position:map.getCenter(),zIndex:2});
    }
    function toggleCenterMarker(on){ ensureCenterMarker(); centerMarker.map=on?map:null; if(on) centerMarker.position=map.getCenter(); }

    function startVoice(){
      const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
      if(!SR){ toast("音声検索に未対応のブラウザです。",false); return; }
      if(voiceRec){ try{voiceRec.abort()}catch{} }
      voiceRec=new SR(); voiceRec.lang="ja-JP";
      voiceRec.onresult=(e)=>{ elQ.value=e.results[0][0].transcript||""; doTextSearch(); };
      voiceRec.onerror=()=>{}; voiceRec.start();
    }

    function initDirections(){
      DirectionsService=new google.maps.DirectionsService();
      DirectionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true,map});
    }

    async function placesSearch(params){
      try{
        const r=await fetch(PLACES_ENDPOINT,{method:"POST",headers:{"Origin":ALLOWED_ORIGIN,"Content-Type":"application/json"},body:JSON.stringify(params)});
        if(!r.ok) return {places:[]}; return await r.json();
      }catch{ return {places:[]}; }
    }

    async function doTextSearch(){
      const text=(elQ.value||"").trim(); if(!text){ toast("検索したい文字を入力してください。",false); return; }
      if(!map) return;
      const c=map.getCenter(); const payload={textQuery:text,languageCode:"ja",regionCode:"JP",pageSize,locationBias:{circle:{center:{latitude:c.lat(),longitude:c.lng()},radius:searchKm*1000}}};
      const data=await placesSearch(payload); showResults(data.places||[]);
    }
    async function doNearby(){
      if(!map) return;
      const c=map.getCenter(); const text=(elQ.value||"").trim()||"コンビニ";
      const payload={textQuery:text,languageCode:"ja",regionCode:"JP",pageSize,locationBias:{circle:{center:{latitude:c.lat(),longitude:c.lng()},radius:searchKm*1000}}};
      const data=await placesSearch(payload); showResults(data.places||[]);
    }

    async function waitForMaps(timeout=12000){
      const t=performance.now();
      while(performance.now()-t<timeout){
        if(window.google&&google.maps&&google.maps.importLibrary) return true;
        await new Promise(r=>setTimeout(r,50));
      }
      return false;
    }
    function moveBadge(){ elLocBadge.style.display="block"; clearTimeout(elLocBadge._t); elLocBadge._t=setTimeout(()=>elLocBadge.style.display="none",1500); }
    async function getCurrent(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error("no geo"));
        const to=setTimeout(()=>rej(new Error("geo timeout")),10000);
        navigator.geolocation.getCurrentPosition(p=>{clearTimeout(to);res({lat:p.coords.latitude,lng:p.coords.longitude});},
          e=>{clearTimeout(to);rej(new Error(e.message||"geo err"));},
          {enableHighAccuracy:true,timeout:10000,maximumAge:0});
      });
    }

    function bindUI(){
      [elKm10,elKm20,elKm30].forEach(ch=>ch.addEventListener("click",()=>{searchKm=Number(ch.dataset.km||"10");setRangeUI()}));
      elBtnInputSearch.addEventListener("click",doTextSearch);
      elBtnVoiceSearch.addEventListener("click",startVoice);
      elBtnReset.addEventListener("click",()=>{elQ.value="";hideResults(); if(DirectionsRenderer) DirectionsRenderer.set("directions",null);});
      elBtnNearby.addEventListener("click",doNearby);
      elBtnCenterPick.addEventListener("click",()=>{pickingMode=true;toggleCenterMarker(true);toast("地図を動かし、中心を長押しで場所確定",true,1200);});
      elFabCurrent.addEventListener("click",async ()=>{try{const p=await getCurrent();currentPos=p;map.setCenter(p);setPulsePosition(p);elLatLng.textContent=fmtLatLng(p);moveBadge();}catch{}});
      elFabPause.addEventListener("click",()=>toast("案内を一時停止しました",true));
      elFabReroute.addEventListener("click",()=>toast("リルートを実行しました",true));
      elResults.addEventListener("click",(e)=>{if(e.target===elResults) hideResults();});
    }
    function bindMapGestures(){
      let timer=null;
      elMap.addEventListener("pointerdown",()=>{timer=setTimeout(()=>{if(pickingMode){doNearby();pickingMode=false;toggleCenterMarker(false);}},600);});
      ["pointerup","pointerleave","pointercancel"].forEach(ev=>elMap.addEventListener(ev,()=>clearTimeout(timer)));
      map.addListener("center_changed",()=>{ if(centerMarker&&centerMarker.map){centerMarker.position=map.getCenter();} });
    }

    // --- ブロッカー安全解除（必ず外す） ---
    function forceOpenUI(){
      if(elBoot.style.display!=="none"){ elBoot.style.display="none"; }
    }

    (async function main(){
      // フォース解除タイマー（最大8秒でUI開放）
      const hardOpen=setTimeout(forceOpenUI, 8000);

      const mapsOk=await waitForMaps(); // Maps未読込でもUIは開く
      try{
        if(mapsOk){
          const { Map } = await google.maps.importLibrary("maps");
          const markerLib = await google.maps.importLibrary("marker");
          AdvancedMarkerElement=markerLib.AdvancedMarkerElement;
          map=new Map(elMap,{center:{lat:35,lng:135},zoom:17,disableDefaultUI:true,mapId:"DEMO_MAP"});
          DirectionsService=new google.maps.DirectionsService();
          DirectionsRenderer=new google.maps.DirectionsRenderer({suppressMarkers:true,map});
        }
        bindUI(); setRangeUI();

        // 位置取得（成功/失敗どちらでもUIを開放）
        try{
          const p=await getCurrent();
          currentPos=p;
          if(map){ map.setCenter(p); ensurePulseMarker(); setPulsePosition(p); }
          elLatLng.textContent=fmtLatLng(p);
          moveBadge();
        }catch{
          // 取得できなくても続行
        }
      }catch(e){
        AUDIT.runEvent({type:"boot_error",message:String(e&&e.message||e)});
      }finally{
        forceOpenUI(); clearTimeout(hardOpen); // 必ず解除
        AUDIT.runEnd({score:100,errorRate:0,issue:"idx202511011955",note:"index init done"});
      }
    })();
  </script>
</body>
</html>