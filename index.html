<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Cloudflare Workers ナビ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<style>
:root{
  --bg:#0b1220;--panel:#111a2c;--fg:#eaf1ff;--muted:#9fb0d6;
  --accent:#35a8ff;--btn:#18233b;--line:#22304e;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
header{position:sticky;top:0;z-index:600;background:linear-gradient(180deg,var(--bg),#0d1730 70%);padding:10px 12px 8px;border-bottom:1px solid var(--line)}
h1{margin:0 0 10px 0;font-size:20px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.search{display:flex;align-items:center;gap:6px;background:var(--panel);
  border:1px solid var(--line);border-radius:12px;padding:6px 8px;flex:1;min-width:260px}
.search input{background:transparent;border:none;outline:none;color:var(--fg);width:100%;font-size:16px}
.icon-btn{background:var(--btn);border:1px solid var(--line);color:var(--fg);
  border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer;white-space:nowrap}
.icon-btn:disabled{opacity:.6;cursor:not-allowed}
#mic{font-size:20px;padding:12px 14px;min-width:44px;min-height:44px;border-radius:12px}
.group{display:flex;align-items:center;gap:6px;background:#0f1a31;border:1px solid var(--line);
  border-radius:12px;padding:6px 8px}
.label{color:var(--muted);font-size:12px;margin-right:2px;white-space:nowrap}
.num,select{appearance:none;background:#0f1a31;border:1px solid var(--line);
  border-radius:10px;color:var(--fg);padding:8px 10px;font-size:14px}
.num{width:120px}
.primary{background:var(--accent);border-color:#2b7fcc;color:#031225}
.sm{font-size:13px;padding:6px 8px;border-radius:9px}
.hintRow{color:var(--muted);font-size:14px;margin-top:6px}
.status{margin-top:8px;color:#cfe2ff;font-size:14px}
.list{background:#0f172a;border:1px solid var(--line);border-radius:12px;max-height:40vh;overflow:auto;display:none}
.listHead{padding:8px 12px;border-bottom:1px solid #1a2745;color:#cfe2ff}
.item{padding:10px 12px;border-top:1px solid #1a2745;cursor:pointer}
.item:first-child{border-top:none}
.item:hover{background:#121f3b}
.muted{color:var(--muted)}
#map{height:55vh;min-height:320px;background:#0a1120;position:relative}
#mapCover{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(6,10,20,.85);color:#cfe2ff;z-index:450;font-size:16px}

/* 浮動ボタン */
.floating{position:fixed;right:14px;bottom:20px;z-index:500;display:flex;flex-direction:column;gap:10px}
.fab{background:#0e162c;border:1px solid var(--line);color:var(--fg);border-radius:14px;
  padding:10px 14px;font-weight:700;cursor:pointer;min-width:120px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.fab:active{transform:translateY(1px)}
.leaflet-control-container .leaflet-bottom.leaflet-left{bottom:16px;left:12px}
.leaflet-control-zoom{border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
.leaflet-control-zoom a{width:34px;height:34px;line-height:34px;font-size:18px}
.leaflet-control-attribution{margin-bottom:96px;margin-right:8px;font-size:11px}

/* ★ コンパス（方位計） */
#compassCtl{
  position:absolute;top:10px;right:10px;z-index:460;
  width:68px;height:68px;border-radius:50%;
  background:#0e162c;border:1px solid var(--line);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.35);user-select:none;cursor:pointer;
}
#compassFace{
  position:relative;width:56px;height:56px;border-radius:50%;
  border:1px solid #2a3a5e;background:#0b1220;
}
.dir{position:absolute;font-size:11px;color:#9fb0d6;letter-spacing:.05em}
.dir.n{top:2px;left:50%;transform:translateX(-50%)}
.dir.s{bottom:2px;left:50%;transform:translateX(-50%)}
.dir.e{right:4px;top:50%;transform:translateY(-50%)}
.dir.w{left:4px;top:50%;transform:translateY(-50%)}
/* 針（デバイス方位が取れれば回転、無ければ上向き） */
#needle{
  position:absolute;top:6px;left:50%;width:3px;height:22px;background:#ff5757;
  transform-origin:50% 100%;transform:translateX(-50%) rotate(0deg);border-radius:2px;
  box-shadow:0 0 6px rgba(255,80,80,.4);
}
#needleTail{
  position:absolute;bottom:6px;left:50%;width:3px;height:12px;background:#35a8ff;
  transform-origin:50% 0%;transform:translateX(-50%) rotate(0deg);border-radius:2px;opacity:.9
}
#compassBadge{
  position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);
  font-size:11px;color:#cfe2ff;background:#0f1a31;padding:1px 6px;border-radius:8px;border:1px solid var(--line)
}

@media (max-width:480px){
  .fab{min-width:110px}
  .num{width:110px}
}
</style>
</head>
<body>
<header id="appHeader">
  <h1>Cloudflare Workers ナビ</h1>

  <!-- 検索行 -->
  <div class="row">
    <div class="search">
      <span>🔎</span>
      <input id="q" type="search" placeholder="店舗名・住所・電話番号で検索…" autocomplete="off">
      <button id="mic" class="icon-btn" title="音声入力">🎤</button>
      <button id="searchBtn" class="icon-btn">検索</button>
    </div>
  </div>

  <!-- 座標行 -->
  <div class="row" style="margin-top:8px">
    <div class="group">
      <div class="label">開始地点（経度・緯度）</div>
      <input id="lon1" class="num" type="number" step="0.000001" placeholder="経度">
      <input id="lat1" class="num" type="number" step="0.000001" placeholder="緯度">
    </div>
    <div class="group">
      <div class="label">目的地（経度・緯度）</div>
      <input id="lon2" class="num" type="number" step="0.000001" placeholder="経度">
      <input id="lat2" class="num" type="number" step="0.000001" placeholder="緯度">
    </div>
  </div>

  <!-- モード/言語/操作 -->
  <div class="row" style="margin-top:8px">
    <div class="group"><div class="label">モード</div>
      <select id="profile">
        <option value="foot-walking" selected>徒歩</option>
        <option value="wheelchair">車いす</option>
      </select>
    </div>
    <div class="group"><div class="label">移動モード</div>
      <select id="moveMode">
        <option value="walk" selected>徒歩</option>
        <option value="transit">公共交通</option>
      </select>
    </div>
    <div class="group"><div class="label">言語</div>
      <select id="lang">
        <option value="ja" selected>日本語</option>
        <option value="en">英語</option>
        <option value="zh">中国語</option>
        <option value="ko">韓国語</option>
      </select>
    </div>
    <button id="routeBtn" class="icon-btn primary">ルート取得</button>
    <button id="clearBtn" class="icon-btn">クリア</button>
  </div>

  <!-- 記憶地点 -->
  <div class="row" style="margin-top:8px">
    <div class="group" style="flex:1;min-width:220px">
      <div class="label">記憶地点（この端末に保存）</div>
      <select id="saved" style="min-width:220px;flex:1">
        <option value="">（未選択）</option>
      </select>
    </div>
    <div class="row" style="gap:6px">
      <button id="saveDestBtn" class="icon-btn sm">目的地を保存</button>
      <button id="useSavedBtn" class="icon-btn sm">目的地に設定</button>
      <button id="delSavedBtn" class="icon-btn sm" title="選択した記憶地点を削除">削除</button>
    </div>
  </div>

  <!-- ヒント＆ステータス -->
  <div class="row" style="margin-top:6px">
    <button id="saveHereBtn" class="icon-btn sm">現在地を保存</button>
    <div class="hintRow" id="hint">地図を長押しすると目的地に設定できます</div>
  </div>
  <div id="statusText" class="status">準備完了。目的地を設定してください</div>

  <!-- 検索結果 -->
  <div id="resultWrap"><div id="list" class="list"></div></div>
</header>

<!-- 地図 -->
<div id="map">
  <div id="mapCover">現在地を取得しています…</div>

  <!-- ★方位計（地図右上） -->
  <div id="compassCtl" title="タップで方位センサーON/OFF">
    <div id="compassFace">
      <div class="dir n">N</div>
      <div class="dir e">E</div>
      <div class="dir s">S</div>
      <div class="dir w">W</div>
      <div id="needle"></div>
      <div id="needleTail"></div>
    </div>
    <div id="compassBadge">方位OFF</div>
  </div>
</div>

<!-- 浮動ボタン -->
<div class="floating">
  <button id="guideBtn" class="fab">案内開始</button>
  <button id="locBtn" class="fab">現在地</button>
  <button id="dstBtn" class="fab">目的地</button>
  <button id="rerouteBtn" class="fab">リルート</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ========= 設定 ========= */
const WORKER_URL='https://ors-proxy.miyata-connect-jp.workers.dev'; // ←必要なら変更
const ORS_ENDPOINT=WORKER_URL+'/proxy';
const LANG_SPEECH={ja:'ja-JP',en:'en-US',zh:'zh-CN',ko:'ko-KR'};

/* オフルート/案内閾値など */
const OFF_THRESH=5, ON_THRESH=3, REROUTE_COOLDOWN=15000;
const WARMUP_MS=8000, ONROUTE_CONSEC=2, OFFROUTE_CONSEC=2, REROUTE_MIN_GAP_MS=25000;
const SNAP_TOL_AT_START_M=12, MIN_MOVE_BEFORE_RER=4, MIN_SPEED_FOR_REROUTE=0.4;
const FAR_TURN=30, NEAR_TURN=8, AT_TURN=5;

/* ========= 要素 & 状態 ========= */
const $=s=>document.querySelector(s);
const status=t=>$('#statusText').textContent=t;
let map,youMarker,accCircle,destMarker,routeLine;
let routePoints=[],routeSteps=[];
let lastPos=null,watchId=null,isGuiding=false;
let stepStage={},lastNearestIdx=0,onRoute=false,lastRerouteAt=0;
let selectDestMode=false,audioCtx;
let warmupUntil=0,onCnt=0,offCnt=0,lastTickAt=0,lastTickPos=null,distanceSinceStart=0;

/* ========= レイアウト ========= */
function setMapHeight(){
  const header=document.getElementById('appHeader');
  const bottom=header.getBoundingClientRect().bottom;
  let h=Math.floor(window.innerHeight-bottom);
  if(!Number.isFinite(h)||h<240) h=Math.max(240,Math.round(window.innerHeight*0.55));
  document.getElementById('map').style.height=h+'px';
}
function invalidateMapSoon(){ setMapHeight(); if(map){ setTimeout(()=>map.invalidateSize(true),100); } }
window.addEventListener('resize',invalidateMapSoon);
window.addEventListener('orientationchange',invalidateMapSoon);

/* ========= 地図/位置 ========= */
function initMap(){
  setMapHeight();
  map=L.map('map',{zoomControl:false});
  L.control.zoom({position:'bottomleft'}).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  map.setView([0,0],2);

  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(p=>{
      lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
      setStartFields(lastPos); showYou(lastPos);
      map.setView([lastPos.lat,lastPos.lng],17);
      document.getElementById('mapCover').style.display='none';
      invalidateMapSoon();
    },()=>{
      status('現在地は許可されませんでした');
      document.getElementById('mapCover').style.display='none';
      invalidateMapSoon();
    },{enableHighAccuracy:true,timeout:8000,maximumAge:30000});
  }else{
    document.getElementById('mapCover').style.display='none';
    status('位置情報に未対応の端末です');
  }

  map.on('click',e=>{ if(selectDestMode){ setDestination(e.latlng,true); selectDestMode=false; }});
  map.on('contextmenu',e=> setDestination(e.latlng,true)); // PC長押し代替
  new ResizeObserver(invalidateMapSoon).observe(document.getElementById('appHeader'));
}
function showYou(pos){
  if(!youMarker){
    youMarker=L.marker([pos.lat,pos.lng],{title:'現在地'}).addTo(map);
    accCircle=L.circle([pos.lat,pos.lng],{radius:pos.accuracy||20,color:'#3ea8ff',fillColor:'#3ea8ff',fillOpacity:.15}).addTo(map);
  }else{
    youMarker.setLatLng([pos.lat,pos.lng]);
    accCircle.setLatLng([pos.lat,pos.lng]).setRadius(pos.accuracy||20);
  }
}
function ensureWatch(){
  if(watchId!=null) return;
  if(!('geolocation' in navigator)){ status('この端末は位置情報に未対応'); return; }
  watchId=navigator.geolocation.watchPosition(p=>{
    lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
    showYou(lastPos);
    if(!$('#lat1').value||!$('#lon1').value) setStartFields(lastPos);
    if(isGuiding) guideTick();
  },err=>status('位置取得に失敗: '+err.message),{enableHighAccuracy:true,maximumAge:3000,timeout:10000});
}
function clearWatch(){ if(watchId!=null){navigator.geolocation.clearWatch(watchId);watchId=null;} }
function setStartFields(latlng){ $('#lat1').value=latlng.lat.toFixed(6); $('#lon1').value=latlng.lng.toFixed(6); }
function setDestination(latlng,autoGuide=false){
  if(!destMarker){ destMarker=L.marker(latlng,{draggable:true}).addTo(map);
    destMarker.on('dragend',()=>{const p=destMarker.getLatLng();$('#lon2').value=p.lng.toFixed(6);$('#lat2').value=p.lat.toFixed(6);});
  }else destMarker.setLatLng(latlng);
  $('#lon2').value=latlng.lng.toFixed(6); $('#lat2').value=latlng.lat.toFixed(6);
  status('目的地を設定しました');
  if(autoGuide){ autoRouteAndGuide(); }
}

/* ========= 方位計（デバイス方位） ========= */
let headingEnabled=false;
async function toggleHeading(){
  if(headingEnabled){
    window.removeEventListener('deviceorientation',onDeviceOrientation);
    headingEnabled=false; $('#compassBadge').textContent='方位OFF'; status('方位センサーをOFFにしました');
    return;
  }
  // iOS Safari は明示許可が必要
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    try{
      const perm = await DeviceOrientationEvent.requestPermission();
      if (perm !== 'granted'){ status('方位センサーは許可されませんでした'); return; }
    }catch(e){ status('方位センサー要求に失敗'); return; }
  }
  window.addEventListener('deviceorientation',onDeviceOrientation);
  headingEnabled=true; $('#compassBadge').textContent='方位ON'; status('方位センサーをONにしました');
}
function onDeviceOrientation(e){
  let alpha = e.alpha;
  if (typeof e.webkitCompassHeading === 'number') alpha = e.webkitCompassHeading; // iOS: 0=北
  if (alpha == null) return;
  $('#needle').style.transform = `translateX(-50%) rotate(${alpha}deg)`;
  $('#needleTail').style.transform = `translateX(-50%) rotate(${alpha}deg)`;
}
$('#compassCtl').addEventListener('click',toggleHeading);

/* ========= ルート ========= */
function decodePolyline(str,precision=5){
  let index=0,lat=0,lng=0,coords=[],shift=0,result=0,b=0,factor=Math.pow(10,precision);
  while(index<str.length){
    shift=0;result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);
    lat+=((result&1)?~(result>>1):(result>>1));
    shift=0;result=0;do{b=str.charCodeAt(index++)-63;result|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);
    lng+=((result&0x1)?~(result>>1):(result>>1));
    coords.push({lat:lat/factor,lng:lng/factor});
  }return coords;
}
function decodeORS(data){
  const r=data?.routes?.[0]; if(!r) return {points:[],steps:[]};
  let pts=[];
  if(typeof r.geometry==='string'){
    pts=decodePolyline(r.geometry,5);
    if(!pts.length){ pts=decodePolyline(r.geometry,6); }
  }else if(Array.isArray(r.geometry)){
    const first=r.geometry[0]; const lonFirst=Math.abs(first[0])>Math.abs(first[1]);
    pts=r.geometry.map(pt=>({lat:lonFirst?pt[1]:pt[0],lng:lonFirst?pt[0]:pt[1]}));
  }
  const steps=(r.segments?.[0]?.steps)||[];
  return {points:pts,steps};
}
async function requestRoute(){
  const profile=$('#profile').value, lang=$('#lang').value||'ja';
  const start=getStart(), goal=getGoal();
  if(!start || !goal){ status('開始/目的地が未設定です'); return false; }
  status('ルート取得中…');
  const body={coordinates:[[+start.lng,+start.lat],[+goal.lng,+goal.lat]],instructions:true,language:lang};
  try{
    const res=await fetch(`${ORS_ENDPOINT}?profile=${encodeURIComponent(profile)}`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json(); if(!res.ok) throw new Error(data?.message||data?.error||res.statusText);
    const d=decodeORS(data);
    drawRoute(d.points,d.steps);
    status('HTTP 200 / 成功');
    return true;
  }catch(e){ console.error(e); status('ルート取得に失敗: '+String(e.message||e)); return false; }
}
function drawRoute(points,steps){
  if(!points?.length){ status('ルートなし'); return; }
  routePoints=points; routeSteps=steps||[];
  if(routeLine) routeLine.remove();
  routeLine=L.polyline(routePoints,{color:'#30b4ff',weight:6,opacity:.9}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  stepStage={}; onRoute=false; lastNearestIdx=0;
}
async function ensureRouteReady(){
  const goal=getGoal(); if(!goal){ alert('まず目的地を設定してください。（地図長押し／検索／記憶地点）'); return false; }
  const mode=$('#moveMode').value;
  if(mode==='transit'){
    if(routePoints.length<2 || !routeLine){ const ok=await requestTransit(); if(!ok) return false; }
    else if(routeLine && !map.hasLayer(routeLine)){ routeLine.addTo(map); }
    return true;
  }else{
    if(routePoints.length<2 || !routeLine){ const ok=await requestRoute(); if(!ok) return false; }
    else if(routeLine && !map.hasLayer(routeLine)){ routeLine.addTo(map); }
    return true;
  }
}
function previewRouteThenCenter(){
  if(routeLine){
    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
    setTimeout(()=>{ if(lastPos) map.setView([lastPos.lat,lastPos.lng],18); },1000);
  }
}

/* ========= 公共交通（Google Directions を Worker 経由） ========= */
async function requestTransit(){
  const lang=$('#lang').value||'ja';
  const goal=getGoal();
  if(!goal){ status('目的地が未設定です'); return false; }
  if(!lastPos && 'geolocation' in navigator){
    try{
      const p=await new Promise((ok,ng)=>navigator.geolocation.getCurrentPosition(ok,ng,{enableHighAccuracy:true,timeout:8000}));
      lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
      showYou(lastPos); setStartFields(lastPos);
    }catch{}
  }
  const start=lastPos||getStart(); if(!start){ status('現在地が取得できません'); return false; }
  status('公共交通ルート取得中…');
  try{
    const res=await fetch(`${WORKER_URL}/transit`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({origin:start,destination:goal,language:lang})});
    const data=await res.json(); if(!res.ok) throw new Error(data?.message||data?.error||res.statusText);
    const pts=data.geometry?decodePolyline(data.geometry,5):[];
    const steps=(data.steps||[]).map((s,i)=>({instruction:s.instruction,name:s.line||'-',way_points:[i,i]}));
    drawRoute(pts,steps);
    status('公共交通ルート取得：成功');
    return true;
  }catch(e){ console.error(e); status('公共交通ルート取得に失敗：'+String(e.message||e)); return false; }
}

/* ========= 幾何 & 近傍 ========= */
function metersBetween(a,b){
  const R=6371000,dLat=(b.lat-a.lat)*Math.PI/180,dLon=(b.lng-a.lng)*Math.PI/180;
  const lat1=a.lat*Math.PI/180,lat2=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}
function pointToSegDist(p,a,b){
  const x0=p.lng,y0=p.lat,x1=a.lng,y1=a.lat,x2=b.lng,y2=b.lat;
  const A={x:x0-x1,y:y0-y1},B={x:x2-x1,y:y2-y1};
  const t=Math.max(0,Math.min(1,(A.x*B.x+A.y*B.y)/(B.x*B.x+B.y*B.y)));
  const proj={lng:x1+t*B.x,lat:y1+t*B.y};
  return metersBetween({lat:y0,lng:x0},{lat:proj.lat,lng:proj.lng});
}
function nearestOnRoute(p,line){
  let min=Infinity,idx=0;
  for(let i=1;i<line.length;i++){
    const d=pointToSegDist(p,line[i-1],line[i]);
    if(d<min){min=d;idx=i;}
  }
  return {dist:min,idx};
}
function nextTurnFromIndex(currIdx){
  for(let i=0;i<routeSteps.length;i++){
    const st=routeSteps[i]; const idx=st.way_points?.[1];
    if(typeof idx==='number' && idx>currIdx) return {index:i,step:st,idx,latlng:routePoints[idx]};
  } return null;
}

/* ========= 音声/ビープ ========= */
function beep(ms=120,freq=880){try{audioCtx=audioCtx||(new (window.AudioContext||window.webkitAudioContext)());const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sine';o.frequency.value=freq;o.connect(g);g.connect(audioCtx.destination);g.gain.setValueAtTime(0.12,audioCtx.currentTime);o.start();o.stop(audioCtx.currentTime+ms/1000);}catch{}}
function speak(text,lang){if(!('speechSynthesis' in window))return;const u=new SpeechSynthesisUtterance(text);u.lang=LANG_SPEECH[lang]||'ja-JP';window.speechSynthesis.cancel();window.speechSynthesis.speak(u);}
function turnSpeech(step){
  const s=step?.instruction||''; let dir='';
  if(s.includes('右')) dir='右'; else if(s.includes('左')) dir='左';
  const name=(step?.name && step.name!=='-')? step.name : 'この通り';
  if(dir) return `${name}を${dir}です`;
  if(s.includes('直進')||s.includes('そのまま')) return 'そのまま直進です';
  return s||'そのまま直進です';
}

/* ========= ガイダンス ========= */
function announceFirstInstruction(){
  if(!lastPos || routePoints.length<2) return;
  const near=nearestOnRoute(lastPos,routePoints);
  const next=nextTurnFromIndex(near.idx);
  let text='そのまま直進です';
  if(next){ text = turnSpeech(next.step); }
  beep(140,900);
  speak(text,$('#lang').value);
  status('最初の案内：'+text);
}

function guideTick(){
  if (!lastPos || routePoints.length < 2) return;
  const now = Date.now();
  let speed = 0;
  if (lastTickPos && lastTickAt) {
    const dt = Math.max(0.001, (now - lastTickAt)/1000);
    const dm = metersBetween(lastTickPos, lastPos);
    speed = dm / dt;
    distanceSinceStart += dm;
  }
  lastTickPos = { ...lastPos };
  lastTickAt = now;

  const near = nearestOnRoute(lastPos, routePoints);

  if (now < warmupUntil) {
    if (near.dist <= ON_THRESH) onCnt++;
    status('案内準備中… ルートに沿って進んでください');
    return;
  }

  if (near.dist <= ON_THRESH) { onCnt++; offCnt = 0; if (onCnt >= ONROUTE_CONSEC) onRoute = true; }
  else if (near.dist >= OFF_THRESH) { offCnt++; onCnt = 0; }

  if (!onRoute && distanceSinceStart < MIN_MOVE_BEFORE_RER && near.dist < SNAP_TOL_AT_START_M) {
    status('ルート付近です。案内に従って進んでください');
  }

  const canReroute =
    (offCnt >= OFFROUTE_CONSEC) &&
    onRoute &&
    (now - lastRerouteAt > Math.max(REROUTE_COOLDOWN, REROUTE_MIN_GAP_MS)) &&
    (distanceSinceStart > MIN_MOVE_BEFORE_RER) &&
    (speed > MIN_SPEED_FOR_REROUTE);

  if (canReroute) {
    lastRerouteAt = now;
    status('通り過ぎました。リルートします。');
    speak('通り過ぎました。リルートします。', $('#lang').value);
    beep(140, 740);
    doReroute();
    offCnt = 0;
    return;
  }

  const next=nextTurnFromIndex(near.idx);
  if(next){
    const dist=metersBetween(lastPos,next.latlng);
    const idx=next.index; const stage=stepStage[idx]||'none'; const text=turnSpeech(next.step);
    if(dist<=AT_TURN && stage!=='at'){ stepStage[idx]='at'; beep(140,900); speak(text,$('#lang').value); status(text+'（0m）'); }
    else if(dist<=NEAR_TURN && (stage==='far'||stage==='none')){ stepStage[idx]='near'; beep(120,820); speak('まもなく、'+text,$('#lang').value); status('まもなく '+text+`（約${Math.round(dist)}m）`); }
    else if(dist<=FAR_TURN && stage==='none'){ stepStage[idx]='far'; status('次の案内：'+text+`（約${Math.round(dist)}m）`); }
  }
}

async function guideStart(opts={forcePreview:true}){
  if(!lastPos && 'geolocation' in navigator){
    try{
      const p=await new Promise((ok,ng)=>navigator.geolocation.getCurrentPosition(ok,ng,{enableHighAccuracy:true,timeout:8000}));
      lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
      showYou(lastPos); setStartFields(lastPos);
    }catch{}
  }
  const ok=await ensureRouteReady(); if(!ok) return false;

  warmupUntil = Date.now() + WARMUP_MS;
  onCnt = offCnt = 0;
  distanceSinceStart = 0;
  lastTickPos = null; lastTickAt = 0;

  ensureWatch();
  isGuiding=true; $('#guideBtn').textContent='案内停止';

  if(opts.forcePreview) previewRouteThenCenter(); else if(lastPos) map.setView([lastPos.lat,lastPos.lng],18);

  speak('案内を開始します',$('#lang').value);
  announceFirstInstruction();

  guideTick();
  status('案内を開始しました');
  return true;
}
function guideStop(){ clearWatch(); isGuiding=false; $('#guideBtn').textContent='案内開始'; status('案内を停止しました'); }
async function autoRouteAndGuide(){ const ok=await requestRoute(); if(!ok) return; previewRouteThenCenter(); await guideStart({forcePreview:false}); }
async function doReroute(){ const g=getGoal(); if(!g){ status('目的地が未設定です'); return; } const s=getStart(); if(!s){ status('開始位置が不明です'); return; } await requestRoute(); previewRouteThenCenter(); }

/* ========= 検索（上位5件・距離表記なし） ========= */
function buildListHeader(text){return `<div class="listHead">${text}</div>`;}
function uniqByLatLon(items){const seen=new Set(),out=[];for(const it of items){const k=`${(+it.lon).toFixed(5)},${(+it.lat).toFixed(5)}`;if(!seen.has(k)){seen.add(k);out.push(it);}}return out;}
async function searchPhoton(q,lang){const bias=(lastPos?`&lat=${lastPos.lat}&lon=${lastPos.lng}`:'');const url=`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}${bias}&lang=${encodeURIComponent(lang)}&limit=30`;const res=await fetch(url,{headers:{'Accept':'application/json'}});const data=await res.json();return (data?.features||[]).map(f=>{const [lon,lat]=f.geometry.coordinates,p=f.properties||{};const name=[p.name,p.street,p.housenumber,p.city,p.country].filter(Boolean).join(' ')||p.label||'(名称不明)';return {name,lon,lat,kind:p.osm_value||p.osm_key||''};});}
async function searchNominatim(q,lang){const headers={'Accept':'application/json','Accept-Language':lang};const bbox=lastPos?`&viewbox=${lastPos.lng-0.2},${lastPos.lat+0.2},${lastPos.lng+0.2},${lastPos.lat-0.2}&bounded=1`:'';const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=30&addressdetails=1&extratags=1&namedetails=1&q=${encodeURIComponent(q)}${bbox}`;const res=await fetch(url,{headers});const data=await res.json();return (data||[]).map(r=>({name:r.display_name||r.name||'(名称不明)',lon:+r.lon,lat:+r.lat,kind:r.category||r.type||''}));}
async function doSearch(){
  const q=$('#q').value.trim(), lang=$('#lang').value||'ja', phoneLike=/[\d-+]{6,}/.test(q);
  const list=$('#list'); list.style.display='block'; list.innerHTML=buildListHeader('検索結果')+'<div class="item muted">検索中…</div>'; invalidateMapSoon();
  try{
    let results = q ? await searchPhoton(q,lang) : [];
    if(phoneLike || results.length<3){ const extra=await searchNominatim(q||'poi',lang); results=uniqByLatLon(results.concat(extra)); } else { results=uniqByLatLon(results); }
    if(lastPos){ results.forEach(r=> r.__dist=metersBetween(lastPos,{lat:r.lat,lng:r.lon})); results.sort((a,b)=>(a.__dist||1e12)-(b.__dist||1e12)); }
    results=results.slice(0,5);
    if(!results.length){ list.innerHTML=buildListHeader('検索結果')+'<div class="item muted">該当なし</div>'; status('該当なし'); return; }
    const head=buildListHeader(lastPos?'近い順（上位5件）':'検索結果（上位5件）');
    list.innerHTML=head+results.map(r=>{
      return `<div class="item" data-lat="${r.lat}" data-lon="${r.lon}">
        <div>${r.name}</div>
        <div class="muted">${r.kind||''}　<span>${r.lon.toFixed(5)}, ${r.lat.toFixed(5)}</span></div>
      </div>`;
    }).join('');
    list.querySelectorAll('.item').forEach(el=> el.addEventListener('click',()=>{
      const lat=+el.dataset.lat,lon=+el.dataset.lon; setDestination({lat,lng:lon},true);
      list.style.display='none'; invalidateMapSoon();
    }));
  }catch(e){ list.innerHTML=buildListHeader('検索結果')+`<div class="item">検索エラー: ${String(e.message||e)}</div>`; }
}

/* ========= 記憶地点 ========= */
const LS_KEY='cw_nav_saved_places_v1';
function loadSavedPlaces(){ const arr=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); const sel=$('#saved'); sel.innerHTML='<option value="">（未選択）</option>'; arr.forEach((p,i)=>{const opt=document.createElement('option'); opt.value=String(i); opt.textContent=`${p.name}（${p.lon.toFixed(5)}, ${p.lat.toFixed(5)}）`; sel.appendChild(opt);});}
function savePlace(name,lat,lon){ const arr=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); arr.push({name,lat,lon,savedAt:Date.now()}); localStorage.setItem(LS_KEY,JSON.stringify(arr)); loadSavedPlaces(); }

/* ========= 補助 ========= */
function getStart(){ const lon=parseFloat($('#lon1').value),lat=parseFloat($('#lat1').value); if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon}; if(lastPos) return lastPos; return null; }
function getGoal(){ const lon=parseFloat($('#lon2').value),lat=parseFloat($('#lat2').value); if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon}; if(destMarker) return destMarker.getLatLng(); return null; }

/* ========= マイク（言語連動） ========= */
(function setupMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition, mic=$('#mic');
  if(!SR){ mic.style.display='none'; return; }
  const rec=new SR();
  const setRecLang=()=> rec.lang = LANG_SPEECH[$('#lang').value||'ja'] || 'ja-JP';
  setRecLang(); $('#lang').addEventListener('change',setRecLang);
  rec.interimResults=false; rec.maxAlternatives=1;
  mic.addEventListener('click',()=>{ try{rec.start();}catch{} status('音声を聞き取っています…'); });
  rec.onresult=e=>{ const text=e.results[0][0].transcript; $('#q').value=text; status('音声入力：'+text); doSearch(); };
  rec.onerror=e=>status('音声入力エラー：'+(e.error||'')); })();

/* ========= ボタン配線 ========= */
$('#routeBtn').addEventListener('click',async()=>{
  const mode=$('#moveMode').value;
  const ok=(mode==='transit')?await requestTransit():await requestRoute();
  if(ok) previewRouteThenCenter();
});
$('#guideBtn').addEventListener('click',async()=>{ if(!isGuiding){ await guideStart(); } else { guideStop(); } });
$('#rerouteBtn').addEventListener('click',async()=>{ if(await requestRoute()){ onRoute=false; lastNearestIdx=0; previewRouteThenCenter(); }});
$('#clearBtn').addEventListener('click',()=>{ if(routeLine){routeLine.remove();routeLine=null;} routePoints=[];routeSteps=[];stepStage={};onRoute=false;lastNearestIdx=0; $('#q').value='';$('#list').style.display='none';$('#list').innerHTML=''; status('クリアしました。目的地を設定してください'); invalidateMapSoon(); });
$('#locBtn').addEventListener('click',()=>{ ensureWatch(); if(lastPos) map.setView([lastPos.lat,lastPos.lng],18); });
$('#dstBtn').addEventListener('click',()=>{ selectDestMode=true; status('地図をタップして目的地を設定'); setTimeout(()=>{selectDestMode=false},7000); });
$('#searchBtn').addEventListener('click',doSearch);
$('#q').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

$('#saveHereBtn').addEventListener('click',()=>{ if(!lastPos){alert('現在地が取得できていません');return;} const name=prompt('現在地に名前を付けて保存します：','マイ地点'); if(!name) return; savePlace(name,lastPos.lat,lastPos.lng); status(`「${name}」を保存しました`); });
$('#saveDestBtn').addEventListener('click',()=>{ const g=getGoal(); if(!g){alert('目的地が未設定です');return;} const name=prompt('目的地に名前を付けて保存します：','目的地'); if(!name) return; savePlace(name,g.lat,g.lng); status(`目的地「${name}」を保存しました`); });
$('#useSavedBtn').addEventListener('click',()=>{ const arr=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); const idx=$('#saved').value; if(idx===''){alert('記憶地点を選択してください');return;} const p=arr[+idx]; if(!p) return; setDestination({lat:p.lat,lng:p.lon},true); $('#list').style.display='none'; invalidateMapSoon(); });
$('#delSavedBtn').addEventListener('click',()=>{ const arr=JSON.parse(localStorage.getItem(LS_KEY)||'[]'); const idx=$('#saved').value; if(idx===''){alert('削除する記憶地点を選択してください');return;} const p=arr[+idx]; if(!confirm(`選択した記憶地点「${p?.name||'地点'}」を削除します。よろしいですか？`)) return; arr.splice(+idx,1); localStorage.setItem(LS_KEY,JSON.stringify(arr)); loadSavedPlaces(); status(`「${p?.name||'地点'}」を削除しました`); });

/* ========= 起動 ========= */
(function boot(){ loadSavedPlaces(); initMap(); })();
</script>
</body>
</html>