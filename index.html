<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v5</title>
  <style>
    /* 元のスタイルそのまま */
    :root{
      --glass: rgba(20,28,44,.7);
      --glass-strong: rgba(16,22,36,.85);
      --stroke: rgba(255,255,255,.14);
      --text: #eaf2ff;
      --muted:#a7b8ce;
      --primary:#5fb1ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --accent:#64d2ff;
    }
    html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;display:none}

    .control-panel{
      position:absolute;
      left:10px;
      right:10px;
      bottom:0;
      z-index:500;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:16px 16px 0 0;
      backdrop-filter:blur(14px);
      padding:16px;
      transition:transform 0.3s;
    }
    .control-panel.hidden{transform:translateY(100%)}
    .panel-toggle{
      position:fixed;
      bottom:10px;
      left:50%;
      transform:translateX(-50%);
      background:var(--accent);
      border:none;
      border-radius:12px;
      padding:14px 40px;
      color:#000;
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      z-index:490;
      display:none !important;
      box-shadow:0 4px 12px rgba(0,0,0,.3);
    }
    .panel-toggle.show{display:block}
    .panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
    .panel-btn{
      flex:1;
      min-width:120px;
      background:var(--glass-strong);
      border:1px solid var(--stroke);
      border-radius:10px;
      padding:10px;
      color:#fff;
      font-size:14px;
      text-align:center;
      cursor:pointer;
      font-weight:700;
    }
    .panel-btn.primary{background:var(--primary);border:none;color:#000}
    .panel-btn.recording{background:var(--danger);border:none;color:#fff}
    .panel-btn.danger{background:var(--danger);border:none;color:#fff}
    input,select{
      width:100%;
      background:var(--glass-strong);
      border:1px solid var(--stroke);
      color:var(--text);
      border-radius:10px;
      padding:10px;
      font-size:14px;
    }

    .info-panel{
      position:absolute;
      left:10px;
      right:10px;
      top:10px;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:12px;
      backdrop-filter:blur(14px);
      padding:14px 14px 18px 14px;
      z-index:460;
      color:var(--text);
      display:none;
      pointer-events:none;
    }
    .info-panel.show{display:block !important}
    .route-main{
      font-size:27px;
      font-weight:700;
      margin-bottom:10px;
      line-height:1.4;
      text-align:center;
    }
    .route-time{
      font-size:16px;
      color:var(--text);
      display:flex;
      gap:20px;
      font-weight:600;
      margin-bottom:12px;
      justify-content:center;
    }
    .route-time span{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .weather-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
    }
    .location-name{
      font-size:20px;
      font-weight:700;
      color:var(--primary);
      white-space:nowrap;
    }
    .weather-items{
      display:flex;
      gap:4px;
      flex:1;
      justify-content:center;
      align-items:center;
    }
    .weather-arrow{
      color:var(--muted);
      font-size:18px;
      font-weight:900;
    }
    .weather-item{
      text-align:center;
      font-size:11px;
      color:var(--text);
      padding:8px 6px;
      background:rgba(16,22,36,.25);
      border-radius:8px;
      min-width:60px;
    }
    .weather-time{
      font-size:12px;
      color:var(--muted);
      font-weight:700;
      margin-bottom:2px;
    }
    .weather-icon{font-size:20px;margin:2px 0}
    .weather-temp{font-weight:700;font-size:13px}
    .weather-rain{color:var(--accent);font-size:11px;font-weight:700}

    .right-buttons{
      position:absolute;
      right:10px;
      top:359px;
      z-index:470;
      display:flex;
      flex-direction:column;
      gap:10px;
      pointer-events:none;
    }
    .right-btn{
      width:65px;
      height:65px;
      background:rgba(16,22,36,.25);
      border:1px solid rgba(255,255,255,.3);
      border-radius:10px;
      color:#fff;
      font-size:11px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-weight:700;
      gap:2px;
      pointer-events:auto;
      box-shadow:0 8px 32px rgba(0,0,0,.4);
      backdrop-filter:blur(24px) saturate(200%);
      -webkit-backdrop-filter:blur(24px) saturate(200%);
    }
    .right-btn.primary{background:rgba(95,177,255,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}
    .right-btn.ok{background:rgba(37,208,122,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}
    .right-btn.danger{background:rgba(255,101,101,.6);border:1px solid rgba(255,255,255,.4);color:#fff;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}
    .right-btn.danger:disabled{opacity:1;background:rgba(255,101,101,.6);cursor:not-allowed;color:#fff;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}
    .right-btn.accent{background:rgba(100,210,255,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}
    .right-btn.warning{background:rgba(255,165,0,.6);border:1px solid rgba(255,255,255,.4);color:#000;backdrop-filter:blur(24px) saturate(200%);-webkit-backdrop-filter:blur(24px) saturate(200%);}

    .map-controls{
      position:fixed;
      right:97px;
      bottom:25px;
      z-index:450;
      display:none;
      gap:8px;
    }
    .map-controls.show{
      display:flex;
      flex-direction:column;
      align-items:center;
    }
    .map-control-row{
      display:flex;
      gap:8px;
    }
    .map-control-btn{
      width:65px;
      height:65px;
      background:rgba(16,22,36,.85);
      border:1px solid var(--stroke);
      border-radius:10px;
      color:#fff;
      font-size:20px;
      cursor:pointer;
      font-weight:700;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      box-shadow:0 2px 6px rgba(0,0,0,.3);
      backdrop-filter:blur(6px);
    }
    .map-control-btn:active{
      background:var(--primary);
    }

    .results-panel{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      max-height:60vh;
      overflow-y:auto;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px;
      z-index:510;
      display:none;
    }
    .result-item{
      padding:10px;
      border-bottom:1px solid var(--stroke);
      cursor:pointer;
    }
    .result-item:hover{background:rgba(95,177,255,.2)}
    .result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

    .saved-points-panel{
      position:absolute;
      left:10px;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      max-height:70vh;
      overflow-y:auto;
      background:var(--glass);
      border:1px solid var(--stroke);
      border-radius:12px;
      padding:10px;
      z-index:510;
      display:none;
    }
    .saved-point-item{
      padding:12px;
      background:var(--glass-strong);
      border:1px solid var(--stroke);
      border-radius:8px;
      margin-bottom:8px;
      cursor:pointer;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .saved-point-item:hover{background:rgba(95,177,255,.3)}
    .saved-point-name{flex:1}
    .saved-point-actions{display:flex;gap:6px}
    .saved-point-btn{
      padding:4px 10px;
      background:var(--primary);
      border-radius:6px;
      font-size:12px;
      cursor:pointer;
      color:#000;
      font-weight:700;
    }
    .saved-point-btn.delete{background:var(--danger);color:#fff}
    .saved-close{text-align:center;padding:10px;color:var(--primary);cursor:pointer;font-weight:700}

    .error-banner{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      background:var(--danger);
      color:#fff;
      border-radius:10px;
      padding:10px;
      text-align:center;
      z-index:999;
    }
    .success-banner{
      position:absolute;
      left:10px;
      right:10px;
      bottom:10px;
      background:#7ed321;
      color:#000;
      border-radius:10px;
      padding:10px;
      text-align:center;
      z-index:999;
      font-weight:700;
    }
    .hidden{display:none}
    .loading-screen{
      position:fixed;
      inset:0;
      background:#0e1a2d;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      transition:opacity 0.3s;
    }
    .loading-screen.hide{opacity:0;pointer-events:none}

    .gm-control-active.gm-fullscreen-control {
      display: none !important;
    }
    .gm-svpc,
    .gm-style .gm-style-cc {
      display: none !important;
    }

    .gm-style-iw,
    .gm-style-iw-c,
    .gm-style-iw-d,
    .gm-style-iw-t::after,
    div[aria-label*="付近"],
    div[aria-label*="美馬郡"],
    div[title*="付近"] {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
    }

    @keyframes marquee {
      0% {
        transform: translateX(100%);
      }
      100% {
        transform: translateX(-100%);
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    
    <div id="infoPanel" class="info-panel">
      <div class="route-main">
        <div id="routeText">目的地を設定してください</div>
        <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:6px;font-weight:600;">半径5km圏内の情報を表示しています。</div>
        <div id="incidentMarquee" style="background:rgba(255,101,101,.2);border-radius:6px;padding:2px 8px;margin-top:6px;overflow:hidden;white-space:nowrap;height:24px;display:flex;align-items:center;">
          <div id="incidentText" style="display:inline-block;font-size:18px;color:#ff6565;">
            現在、周辺半径5km圏内で特に報告されている事件、事故の報告はありません。
          </div>
        </div>
      </div>
      <div class="route-time">
        <span><span id="timeLabel" style="display:inline-block;line-height:1.2;">現在<br>時刻</span> <span id="currentTime" style="font-size:20px;">--:--</span></span>
        <span><span id="arrivalLabel" style="display:inline-block;line-height:1.2;">到着<br>予想</span> <span id="arrivalTime" style="font-size:20px;">--:--</span></span>
        <span><span style="display:inline-block;line-height:1.2;">所要<br>時間</span> <span id="durationTime" style="font-size:20px;">--:--</span></span>
      </div>
      <div style="text-align:center;margin-bottom:8px;">
        <div id="locationName" class="location-name">読み込み中...</div>
      </div>
      <div class="weather-row">
        <div class="weather-items">
          <div class="weather-item">
            <div class="weather-time">3H</div>
            <div class="weather-icon" id="w3h">☁️</div>
            <div class="weather-temp" id="t3h">--°</div>
            <div class="weather-rain" id="r3h">--%</div>
          </div>
          <div class="weather-arrow">→</div>
          <div class="weather-item">
            <div class="weather-time">6H</div>
            <div class="weather-icon" id="w6h">☁️</div>
            <div class="weather-temp" id="t6h">--°</div>
            <div class="weather-rain" id="r6h">--%</div>
          </div>
          <div class="weather-arrow">→</div>
          <div class="weather-item">
            <div class="weather-time">9H</div>
            <div class="weather-icon" id="w9h">☁️</div>
            <div class="weather-temp" id="t9h">--°</div>
            <div class="weather-rain" id="r9h">--%</div>
          </div>
          <div class="weather-arrow">→</div>
          <div class="weather-item">
            <div class="weather-time">12H</div>
            <div class="weather-icon" id="w12h">☁️</div>
            <div class="weather-temp" id="t12h">--°</div>
            <div class="weather-rain" id="r12h">--%</div>
          </div>
        </div>
      </div>
      <div id="coordsDisplay" style="text-align:center;font-size:17px;color:var(--muted);margin-top:8px;font-weight:600;cursor:pointer;pointer-events:auto;" onclick="copyCoordinates(event)">📍 緯度: -- / 経度: --</div>
    </div>
    
    <div id="mapControls" class="map-controls">
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panUp()">↑</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panLeft()">←</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomIn()">+</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomOut()">−</div>
        <div class="map-control-btn" onclick="event.preventDefault();panRight()">→</div>
      </div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panDown()">↓</div>
      </div>
    </div>
    
    <div id="panelToggle" class="panel-toggle" onclick="togglePanel()"><span id="btnOpenPanel">操作パネルを表示</span></div>
    
    <div id="controlPanel" class="control-panel hidden">
      <div class="panel-row">
        <input type="text" id="searchBox" placeholder="場所を検索..." />
      </div>
      <div class="panel-row">
        <button class="panel-btn primary" onclick="executeSearch()">検索</button>
        <button class="panel-btn" onclick="document.getElementById('controlPanel').classList.add('hidden')">閉じる</button>
      </div>
    </div>
    
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()"><span id="btnCloseResults">閉じる</span></div>
    </div>
    
    <div id="routeSelectModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;">
      <div style="background:var(--glass-strong);border-radius:16px;padding:24px;width:80%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
        <h2 style="color:#fff;text-align:center;margin-bottom:20px;font-size:20px;">ルートタイプを選択</h2>
        <button onclick="selectRouteType('fastest')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--primary);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          ⚡ 最短AIルート
        </button>
        <button onclick="selectRouteType('easy')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--ok);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          🌿 楽チンAIルート
        </button>
        <button onclick="closeRouteSelectModal()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">
          キャンセル
        </button>
      </div>
    </div>
    
    <div id="searchTypeModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:9999;justify-content:center;align-items:center;">
      <div style="background:var(--glass-strong);border-radius:16px;padding:24px;width:80%;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,0.5);">
        <h2 style="color:#fff;text-align:center;margin-bottom:20px;font-size:20px;">検索方法を選択</h2>
        <button onclick="selectSearchType('text')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--primary);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          ⌨️ 手入力検索
        </button>
        <button onclick="selectSearchType('voice')" style="width:100%;padding:16px;margin-bottom:12px;background:var(--accent);border:none;border-radius:10px;color:#000;font-size:16px;font-weight:700;cursor:pointer;">
          🎤 音声検索
        </button>
        <button onclick="closeSearchTypeModal()" style="width:100%;padding:12px;background:rgba(255,255,255,0.1);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:14px;cursor:pointer;">
          キャンセル
        </button>
      </div>
    </div>
    
    <div id="savedPointsPanel" class="saved-points-panel">
      <div id="savedPointsList"></div>
      <div class="saved-close" onclick="hideSavedPoints()"><span id="btnCloseSaved">閉じる</span></div>
    </div>
    
    <div id="error" class="error-banner hidden"></div>
    <div id="success" class="success-banner hidden"></div>
    
    <div id="rightButtons" class="right-buttons">
      <button class="right-btn accent" onclick="zoomToCurrentLocation()" title="現在地を拡大表示">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="3" fill="currentColor"/>
          <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="2"/>
          <path d="M12 2V6M12 18V22M22 12H18M6 12H2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">現在地</span>
      </button>
      <button class="right-btn primary" onclick="showSearchTypeModal()" title="検索">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2"/>
          <path d="M20 20L15.5 15.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">検索</span>
      </button>
      <button class="right-btn danger" id="stopNavBtn" onclick="stopNav()" title="案内停止" disabled>
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="6" y="5" width="4" height="14" stroke="#000" stroke-width="2" fill="none"/>
          <rect x="14" y="5" width="4" height="14" stroke="#000" stroke-width="2" fill="none"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;color:#000;">案内停止</span>
      </button>
      <button class="right-btn warning" onclick="zoomToDestination()" title="目的地を拡大表示">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L12 12M12 12L8 8M12 12L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 12C12 15.866 8.866 19 5 19C5 19 3 17 3 12C3 8.134 5 2 12 2C19 2 21 8.134 21 12C21 17 19 19 19 19C15.134 19 12 15.866 12 12Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">目的地</span>
      </button>
      <button class="right-btn ok" onclick="showRouteSelectModal('reroute')" title="ルート再計算">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 1L21 5L17 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M3 11V9C3 6.79086 4.79086 5 7 5H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M7 23L3 19L7 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M21 13V15C21 17.2091 19.2091 19 17 19H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">リルート</span>
      </button>
      <button class="right-btn accent" onclick="toggleMapControls()" title="地図コントロール">
        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 4 L16 10 M16 4 L13 7 M16 4 L19 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M16 28 L16 22 M16 28 L13 25 M16 28 L19 25" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M4 16 L10 16 M4 16 L7 13 M4 16 L7 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M28 16 L22 16 M28 16 L25 13 M28 16 L25 19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="16" cy="16" r="4" fill="currentColor"/>
          <path d="M14 16 L18 16 M16 14 L16 18" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <span style="font-size:10px;margin-top:2px;">操作</span>
      </button>
    </div>
    
    <div id="loading" class="loading-screen">
      <div style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px" id="loadingText">現在地取得中...</div>
        <div style="font-size:14px;color:var(--muted)" id="loadingWait">もうしばらくお待ちください。</div>
      </div>
    </div>
  </div>
  
  <script>
    "use strict";
    let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=!1,currentLocation=null,savedPoints=[],selectingMapPoint=!1,stopAnnounced=!1,currentLang="ja";
    let placesService = null; // 修正: PlacesServiceをグローバルに初期化

    const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";

    const translations={
      ja:{
        setDestination:"目的地を設定してください",
        currentTime:"現在時刻",
        arrivalTime:"到着予想時刻",
        loading:"読み込み中...",
        btnClosePanel:"操作パネルを閉じる",
        btnOpenPanel:"操作パネルを表示",
        btnCloseResults:"閉じる",
        btnCloseSaved:"閉じる",
        loadingText:"現在地取得中...",
        loadingWait:"もうしばらくお待ちください。",
        navStart:"案内を開始します。",
        navStop:"案内を終了します。",
        edit:"編集",
        delete:"削除"
      },
      en:{
        setDestination:"Please set destination",
        currentTime:"Current",
        arrivalTime:"Arrival",
        loading:"Loading...",
        btnClosePanel:"Close Panel",
        btnOpenPanel:"Show Panel",
        btnCloseResults:"Close",
        btnCloseSaved:"Close",
        loadingText:"Getting location...",
        loadingWait:"Please wait.",
        navStart:"Starting navigation.",
        navStop:"Navigation stopped.",
        edit:"Edit",
        delete:"Delete"
      }
    };

    function updateAllTexts(){
      const t=translations[currentLang];
      document.getElementById("loadingText").textContent=t.loadingText;
      document.getElementById("loadingWait").textContent=t.loadingWait;
    }

    function togglePanel(){
      const panel = document.getElementById("controlPanel");
      if (panel) {
        panel.classList.toggle("hidden"); // 修正: パネルの表示制御を強化
      }
    }

    function hideAllElements(){
      document.getElementById("resultsPanel").style.display="none";
      document.getElementById("savedPointsPanel").style.display="none";
      document.getElementById("mapControls").classList.remove("show");
    }

    function showAllElements(){}

    function toggleMapControls(){
      const controls=document.getElementById("mapControls");
      controls.classList.toggle("show");
    }

    function panUp(){
      const center=map.getCenter();
      map.panTo({lat:center.lat()+0.001,lng:center.lng()});
    }

    function panDown(){
      const center=map.getCenter();
      map.panTo({lat:center.lat()-0.001,lng:center.lng()});
    }

    function panLeft(){
      const center=map.getCenter();
      map.panTo({lat:center.lat(),lng:center.lng()-0.001});
    }

    function panRight(){
      const center=map.getCenter();
      map.panTo({lat:center.lat(),lng:center.lng()+0.001});
    }

    function zoomIn(){
      map.setZoom(map.getZoom()+1);
    }

    function zoomOut(){
      map.setZoom(map.getZoom()-1);
    }

    window.gm_authFailure=()=>alert("Maps API Error");

    function initMap(){
      if(!navigator.geolocation)return alert("Geolocation not supported");
      
      const urlParams=new URLSearchParams(window.location.search);
      currentLang=urlParams.get('lang')||'ja';
      updateAllTexts();
      
      navigator.geolocation.getCurrentPosition(pos=>{
        currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
        
        map=new google.maps.Map(document.getElementById("map"),{
          center:currentLocation,
          zoom:17,
          mapTypeControl:false,
          streetViewControl:false,
          fullscreenControl:false,
          zoomControl:false,
          rotateControl:false,
          scaleControl:false,
          gestureHandling:'greedy',
          clickableIcons:false,
          disableDefaultUI: true
        });
        
        directionsService=new google.maps.DirectionsService;
        directionsRenderer=new google.maps.DirectionsRenderer({map});
        
        // 修正: PlacesServiceをここで初期化
        placesService = new google.maps.places.PlacesService(map);
        
        // 立体的な3Dピン型マーカーを作成（赤色）
        // ... (元のマーカーコードそのまま)
        const pinSvg = `
          <svg width="40" height="60" viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">
            <!-- 元のSVGコードそのまま -->
          </svg>
        `;
        
        currentMarker=new google.maps.Marker({
          position:currentLocation,
          map:map,
          icon:{
            url:'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(pinSvg),
            scaledSize:new google.maps.Size(40, 60),
            anchor:new google.maps.Point(20, 55)
          },
          zIndex:1000,
          optimized:false
        });
        
        // 強調されたパルスエフェクト（赤色、フラッシュ抑制版）
        // ... (元のパルスコードそのまま)
        
        document.getElementById("map").style.display="block";
        document.getElementById("loading").classList.add("hide");
        
        loadSavedPoints();
        
        setTimeout(()=>{
          const infoPanel=document.getElementById("infoPanel");
          const panelToggle=document.getElementById("panelToggle");
          
          if(infoPanel)infoPanel.classList.add("show");
          if(panelToggle)panelToggle.classList.add("show");
          
          updateCurrentTime();
          setInterval(updateCurrentTime, 60000);
          
          updateCoords();
          
          fetchLocationName();
          fetchWeather();
          
          // 初期表示時に現在地マーカーを情報パネルの下の見える範囲に表示
          // ... (元の調整コードそのまま)
        },100);
        
        startWatch();
      },err=>alert("Location error: "+err.message));
    }

    // 修正: debugLog関数を実装
    function debugLog(message) {
      console.log('[DEBUG] ' + message);
      // デザインを崩さないよう、画面出力はオプション（例: 非表示divに追加可能）
      // const debugEl = document.createElement('div');
      // debugEl.textContent = message;
      // debugEl.style.display = 'none'; // 隠す
      // document.body.appendChild(debugEl);
    }

    // ... (元の関数群そのまま: startWatch, updateCoords, copyCoordinates, fallbackCopy, etc.)

    // 修正: emergencySearch関数を新規実装
    async function emergencySearch() {
      const emergencyBox = document.getElementById("emergencySearchBox"); // HTMLに存在するIDを仮定（原因に基づく）
      if (!emergencyBox) return showError("緊急検索バーが見つかりません");
      
      const q = emergencyBox.value.trim();
      if (!q) return showError("検索ワードを入力してください");
      
      debugLog(`緊急検索開始: ${q}`); // デバッグログ
      
      try {
        const request = {
          query: q,
          location: currentLocation,
          radius: 5000, // 5kmに調整
          language: 'ja'
        };
        
        placesService.textSearch(request, (results, status) => {
          if (status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0) {
            // 10km以内にフィルタ
            const filteredPlaces = results.filter(p => {
              const lat = p.geometry.location.lat();
              const lng = p.geometry.location.lng();
              const distance = calculateDistance(currentLocation.lat, currentLocation.lng, lat, lng);
              return distance <= 10;
            }).map(p => {
              const lat = p.geometry.location.lat();
              const lng = p.geometry.location.lng();
              const distance = calculateDistance(currentLocation.lat, currentLocation.lng, lat, lng);
              return {
                displayName: { text: p.name },
                formattedAddress: p.formatted_address,
                location: { latitude: lat, longitude: lng },
                place_id: p.place_id,
                geometry: p.geometry,
                distance: distance
              };
            }).sort((a, b) => a.distance - b.distance).slice(0, 5);
            
            displayResults(filteredPlaces);
          } else {
            showError("結果が見つかりませんでした");
          }
        });
      } catch (e) {
        debugLog(`緊急検索エラー: ${e.message}`);
        showError("検索に失敗しました");
      }
    }

    async function executeSearch(){
      const searchBox=document.getElementById("searchBox");
      if(!searchBox)return;
      
      const q=searchBox.value.trim();
      if(!q){
        showError("検索ワードを入力してください");
        return;
      }
      if(!currentLocation){
        showError("位置情報を取得中");
        return;
      }
      
      // 修正: パネルを正しく閉じる
      const controlPanel=document.getElementById("controlPanel");
      if(controlPanel){
        controlPanel.classList.add("hidden");
      }
      
      hideResults();
      speak(`${q}を検索中`);
      showSuccess("検索中...");
      
      debugLog(`検索開始: ${q}`); // デバッグログ
      
      // 修正: 非同期でPlaces APIを待機
      try {
        const request={
          query:q,
          location:currentLocation,
          radius:5000, // 修正: 5kmに調整
          language:'ja'
        };
        
        placesService.textSearch(request,(results,status)=>{
          if(status===google.maps.places.PlacesServiceStatus.OK&&results&&results.length>0){
            // 修正: 10km以内にフィルタリング
            const filteredPlaces = results.filter(p => {
              const lat = p.geometry.location.lat();
              const lng = p.geometry.location.lng();
              const distance = calculateDistance(currentLocation.lat, currentLocation.lng, lat, lng);
              return distance <= 10;
            });
            
            const places=filteredPlaces.map(p=>{
              const lat=p.geometry.location.lat();
              const lng=p.geometry.location.lng();
              const distance=calculateDistance(currentLocation.lat,currentLocation.lng,lat,lng);
              return{
                displayName:{text:p.name},
                formattedAddress:p.formatted_address,
                location:{latitude:lat,longitude:lng},
                place_id:p.place_id,
                geometry:p.geometry,
                distance:distance
              };
            }).sort((a,b)=>a.distance-b.distance).slice(0,5);
            
            speak(`${places.length}件の結果が見つかりました`);
            displayResults(places);
          }else{
            showError("結果が見つかりませんでした");
            speak("結果が見つかりませんでした");
          }
        });
      } catch (e) {
        debugLog(`検索エラー: ${e.message}`);
        showError("検索に失敗しました");
      }
    }

    // ... (元の残りの関数群そのまま: calculateDistance, displayResults, hideResults, selectPlace, etc.)

    window.addEventListener("load",initMap);
  </script>
  <script>
    const script=document.createElement('script');
    script.src=`https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places`;
    script.async=true;
    script.defer=true;
    document.body.appendChild(script);
  </script>
</body>
</html>