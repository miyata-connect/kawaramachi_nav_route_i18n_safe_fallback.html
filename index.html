<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>WALK NAV</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg: rgba(255,255,255,.96);
    --shadow: 0 10px 25px rgba(0,0,0,.15);
    --r: 14px;
  }
  html,body{height:100%;margin:0}
  #map{position:fixed;inset:0}

  /* ── 上部 UI（ぎゅっと圧縮） ───────────────────────── */
  #panel{
    position:fixed;left:max(8px,env(safe-area-inset-left));right:max(8px,env(safe-area-inset-right));
    top:calc(8px + env(safe-area-inset-top));
    z-index:1000;background:var(--bg);backdrop-filter:blur(6px);
    border-radius:var(--r);box-shadow:var(--shadow);padding:8px;
    display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;
  }
  #q{
    width:100%;height:44px;border:1px solid #cbd5e1;border-radius:12px;padding:0 12px;font-size:16px;
  }
  .btn, select{
    height:44px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:15px;
    padding:0 12px;display:inline-flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;
  }
  #mic{width:44px;padding:0}
  #search{white-space:nowrap}
  #lang{width:116px}
  /* 2段目は極力出さないため、モバイル1段構成。幅が狭い時だけ言語が下に回る */
  @media (max-width:460px){
    #panel{grid-template-columns:1fr auto auto}
    #lang{grid-column:1 / -1}
  }

  /* 現在地＆追従トグル（ズームと被らない固定位置） */
  .fixed-controls{
    position:fixed;right:max(10px,env(safe-area-inset-right));
    top:calc(66px + env(safe-area-inset-top));
    display:flex;flex-direction:column;gap:8px;z-index:999;
  }
  .fixed-controls .btn{box-shadow:var(--shadow);}

  /* トースト／結果リスト */
  #toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(12px + env(safe-area-inset-bottom));
    background:var(--bg);border-radius:12px;box-shadow:var(--shadow);
    padding:8px 12px;z-index:1000;font-size:14px;display:none;max-width:92vw;
  }
  #results{
    position:fixed;left:max(8px,env(safe-area-inset-left));right:max(8px,env(safe-area-inset-right));
    top:calc(64px + env(safe-area-inset-top));
    z-index:999;background:var(--bg);border-radius:12px;box-shadow:var(--shadow);display:none;
    overflow:hidden;
  }
  #results ul{list-style:none;margin:0;padding:0}
  #results li{
    padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;gap:8px
  }
  #results li:first-child{border-top:none}
  #results small{color:#6b7280}

  /* 進行方向マーカー（回転） */
  .heading-pin{
    width:24px;height:24px;border-radius:50%;
    background:#2563eb;border:3px solid #fff;box-shadow:0 0 0 2px rgba(37,99,235,.35);
    position:relative;
  }
  .heading-pin::after{
    content:"";position:absolute;left:50%;top:-12px;transform:translateX(-50%);
    width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #2563eb;
    filter:drop-shadow(0 1px 1px rgba(0,0,0,.4));
  }

  /* ルート線 */
  .route-shadow{filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}
</style>
</head>
<body>
  <div id="map" aria-label="地図"></div>

  <div id="panel" role="group" aria-label="検索">
    <input id="q" placeholder="店名・住所・電話（例: ローソン / 087-xxx-xxxx）">
    <button id="mic" class="btn" title="音声入力">🎤</button>
    <button id="search" class="btn" title="検索">検索</button>
    <select id="lang" title="言語">
      <option value="ja-JP" selected>日本語</option>
      <option value="en-US">English</option>
      <option value="ko-KR">한국어</option>
      <option value="zh-CN">简体中文</option>
      <option value="zh-TW">繁體中文</option>
    </select>
  </div>

  <div class="fixed-controls">
    <button id="locate" class="btn">📍 現在地</button>
    <button id="follow" class="btn" aria-pressed="true">🧭 追従ON</button>
  </div>

  <div id="results" role="listbox" aria-label="検索結果"><ul></ul></div>
  <div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ========= 基本 =========
  const map = L.map('map',{zoomControl:true,attributionControl:true}).setView([34.342,134.046],16);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);

  const $ = s=>document.querySelector(s);
  const qEl=$('#q'), micEl=$('#mic'), searchEl=$('#search'), langEl=$('#lang');
  const locateEl=$('#locate'), followEl=$('#follow');
  const resultsEl=$('#results'), resultsUL=resultsEl.querySelector('ul');
  const toastEl=$('#toast');

  const ORS_PROXY='https://ors-proxy.miyata-connect-jp.workers.dev/proxy';

  // ========= トースト =========
  function toast(m,ms=2000){ toastEl.textContent=m; toastEl.style.display='block';
    clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display='none',ms); }

  // ========= 現在地 & heading =========
  let meLatLng=null, meMarker=null, headingDeg=null, follow=true;
  const MeIcon=L.divIcon({className:'',html:'<div class="heading-pin"></div>',iconSize:[24,24],iconAnchor:[12,12]});

  function setMeMarker(latlng){
    if(!meMarker){ meMarker=L.marker(latlng,{icon:MeIcon}).addTo(map); }
    else{ meMarker.setLatLng(latlng); }
    rotateHeading();
  }
  function rotateHeading(){
    if(!meMarker) return;
    const el = meMarker.getElement();
    if(!el) return;
    const deg = (headingDeg==null)?0:headingDeg;
    el.style.transform = `rotate(${deg}deg)`;
  }
  function bearing(from, to){
    const φ1=from.lat*Math.PI/180, φ2=to.lat*Math.PI/180;
    const λ1=from.lng*Math.PI/180, λ2=to.lng*Math.PI/180;
    const y=Math.sin(λ2-λ1)*Math.cos(φ2);
    const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
  }

  if(navigator.geolocation){
    navigator.geolocation.watchPosition(p=>{
      meLatLng = L.latLng(p.coords.latitude,p.coords.longitude);
      if(typeof p.coords.heading==='number' && !isNaN(p.coords.heading)) headingDeg = p.coords.heading;
      setMeMarker(meLatLng);
      if(follow) map.panTo(meLatLng,{animate:true,duration:.4});
      maybeRerouteOnMove();
    }, err=>console.warn(err), {enableHighAccuracy:true,maximumAge:5000,timeout:10000});
  }

  locateEl.addEventListener('click',()=>{
    if(meLatLng){ map.flyTo(meLatLng,18,{duration:.6}); }
    else toast('現在地を取得中…');
  });
  followEl.addEventListener('click',()=>{
    follow=!follow; followEl.setAttribute('aria-pressed', String(follow));
    followEl.textContent = follow ? '🧭 追従ON' : '🧭 追従OFF';
    if(follow && meLatLng) map.panTo(meLatLng);
  });

  // ========= 音声入力（BCP-47 言語） =========
  let recog=null;
  micEl.addEventListener('click',()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ toast('このブラウザは音声入力に未対応'); return; }
    if(!recog){
      recog=new SR(); recog.interimResults=false; recog.maxAlternatives=1;
      recog.addEventListener('result',e=>{
        const txt=e.results[0][0].transcript.trim(); qEl.value=txt; doSearch();
      });
      recog.addEventListener('error',e=>toast('音声入力エラー: '+e.error));
    }
    try{ recog.lang=langEl.value||'ja-JP'; recog.start(); }catch(_){}
  });

  // ========= 検索（上位5件まで、近い順） =========
  async function geocodeTop5(term, centerLatLng, langTag){
    const lat=centerLatLng.lat, lon=centerLatLng.lng;
    const R=800; // 収集半径(内部) 〜800m
    const dLat=R/111320, dLon=R/(111320*Math.cos(lat*Math.PI/180));
    const url=new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2');
    url.searchParams.set('q',term);
    url.searchParams.set('limit','20'); // まずは多めに取る
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language',langTag||'ja-JP');
    url.searchParams.set('viewbox',`${lon-dLon},${lat+dLat},${lon+dLon},${lat-dLat}`);
    url.searchParams.set('bounded','1');
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const arr=await res.json();
    // 電話番号を含む入力なら Overpass を混ぜる
    const digits=term.replace(/[^\d]/g,'');
    let overpassArr=[];
    if(digits.length>=7){
      try{
        const q=`
          [out:json][timeout:25];
          (
            node(around:${R},${lat},${lon})["phone"~"${digits}"];
            node(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            way(around:${R},${lat},${lon})["phone"~"${digits}"];
            way(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
          ); out center 30;
        `;
        const r=await fetch('https://overpass-api.de/api/interpreter',{
          method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body:new URLSearchParams({data:q})
        });
        const j=await r.json();
        overpassArr = (j.elements||[]).map(el=>{
          const y=el.lat||el.center?.lat, x=el.lon||el.center?.lon;
          if(!y||!x) return null;
          return { lat:y, lon:x, display_name: el.tags?.name || el.tags?.brand || '目的地(電話)', via:'overpass' };
        }).filter(Boolean);
      }catch(e){ console.warn('overpass',e); }
    }
    // 距離計算して結合→近い順→重複除去→上位5
    const center=L.latLng(lat,lon);
    const merged=[...arr.map(a=>({lat:parseFloat(a.lat),lon:parseFloat(a.lon),display_name:a.display_name,via:'nominatim'})),...overpassArr];
    const uniq=new Map();
    merged.forEach(p=>{
      const key=p.lat.toFixed(6)+','+p.lon.toFixed(6);
      if(!uniq.has(key)) uniq.set(key,p);
    });
    const list=[...uniq.values()].map(p=>{
      p._d=map.distance(center,[p.lat,p.lon]); return p;
    }).sort((a,b)=>a._d-b._d).slice(0,5);
    return list;
  }

  // ========= ORS ルート =========
  let dstMarker=null, routeLine=null, routeShadow=null, lastRouteTo=null, lastRouteAt=0;

  async function routeWalk(from, to, langTag){
    const body={coordinates:[[from.lng,from.lat],[to.lng,to.lat]],instructions:true,language:(langTag||'ja-JP')};
    const url=`${ORS_PROXY}?profile=foot-walking&format=geojson`;
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('ORSエラー '+r.status);
    const geo=await r.json();
    const feat=geo.features?.[0]; if(!feat) throw new Error('ルートなし');
    const coords=feat.geometry.coordinates.map(([x,y])=>L.latLng(y,x));
    const sum=feat.properties?.summary||{};
    return {latlngs:coords, dist:sum.distance||0, dur:sum.duration||0};
  }
  function drawRoute(latlngs){
    if(routeLine){ map.removeLayer(routeLine); map.removeLayer(routeShadow); }
    routeShadow=L.polyline(latlngs,{color:'#000',weight:8,opacity:.25,className:'route-shadow'}).addTo(map);
    routeLine=L.polyline(latlngs,{color:'#2563eb',weight:5,opacity:.95}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[80,40]});
  }

  // ルート逸脱検出 → 25m超でリルート / 20秒ごとに更新
  function distanceToPolylineMeters(latlng, latlngs){
    if(!latlngs||latlngs.length<2) return Infinity;
    const p=map.latLngToLayerPoint(latlng);
    let min=Infinity;
    for(let i=1;i<latlngs.length;i++){
      const p1=map.latLngToLayerPoint(latlngs[i-1]), p2=map.latLngToLayerPoint(latlngs[i]);
      const d=L.LineUtil.pointToSegmentDistance(p,p1,p2);
      if(d<min) min=d;
    }
    // ピクセル→メートル粗変換: 現在ズームの1pxに相当するメートルを近似
    const p0=map.layerPointToLatLng([0,0]), p1LL=map.layerPointToLatLng([1,0]);
    const mPerPx=map.distance(p0,p1LL);
    return min*mPerPx;
  }
  async function maybeRerouteOnMove(){
    if(!routeLine || !meLatLng || !lastRouteTo) return;
    const off=distanceToPolylineMeters(meLatLng, routeLine.getLatLngs());
    const t=Date.now();
    if(off>25 || (t-lastRouteAt)>20000){
      try{
        const r=await routeWalk(meLatLng,lastRouteTo,langEl.value);
        drawRoute(r.latlngs);
        lastRouteAt=Date.now();
        // heading が無いときは次区間から推定
        if(r.latlngs.length>1 && (headingDeg==null)){
          headingDeg=bearing(meLatLng,r.latlngs[1]); rotateHeading();
        }
      }catch(e){ console.warn('reroute',e); }
    }
  }

  // ========= 検索 → 上位5件リスト → タップで経路 =========
  async function doSearch(){
    const term=qEl.value.trim(); if(!term){toast('キーワードを入力');return;}
    const center=meLatLng || map.getCenter();
    try{
      toast('検索中…');
      const list=await geocodeTop5(term, center, langEl.value);
      if(!list.length){ resultsEl.style.display='none'; toast('見つかりませんでした'); return; }
      // リスト描画
      resultsUL.innerHTML = list.map((p,i)=>`
        <li data-i="${i}">
          <span>${p.display_name}</span>
          <small>${(p._d/1000).toFixed(2)}km</small>
        </li>`).join('');
      resultsEl.style.display='block';

      // クリックで目的地→経路
      resultsUL.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click', async ()=>{
          const i=+li.getAttribute('data-i'); const p=list[i];
          resultsEl.style.display='none';
          const to=L.latLng(p.lat,p.lon);
          if(!dstMarker) dstMarker=L.marker(to,{title:'目的地'}).addTo(map);
          else dstMarker.setLatLng(to).bindPopup(p.display_name||'目的地');
          // heading 推定（端末が返さない場合）
          if(meLatLng && (headingDeg==null)){
            headingDeg=bearing(meLatLng,to); rotateHeading();
          }
          if(meLatLng){
            const r=await routeWalk(meLatLng,to,langEl.value);
            drawRoute(r.latlngs);
            lastRouteTo=to; lastRouteAt=Date.now();
            toast(`徒歩 約${Math.round(r.dur/60)}分 / ${(r.dist/1000).toFixed(2)}km`);
          }else{
            map.flyTo(to,18);
          }
        });
      });
    }catch(e){ console.error(e); toast('エラー: '+(e.message||e)); }
  }
  searchEl.addEventListener('click',doSearch);
  qEl.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });

  // 初期 q= で検索
  const sp=new URLSearchParams(location.search);
  if(sp.get('q')){ qEl.value=sp.get('q'); setTimeout(doSearch,300); }
})();
</script>
</body>
</html>
