<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>歩行ナビ（Workers経由 ORS）</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
  html,body {height:100%; margin:0; background:#0b1220; color:#fff; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;}
  header {padding:14px 16px; font-weight:800; font-size:20px;}
  #panel {padding:12px 16px;}
  .row {display:flex; flex-wrap:wrap; gap:8px; align-items:center;}
  .row > * {flex:0 0 auto}
  input, select, button {
    background:#0f172a; color:#fff; border:1px solid #334155; border-radius:12px;
    padding:10px 12px; font-size:16px; outline:none;
  }
  input{width:140px; text-align:center}
  button.primary{background:#111827; border-color:#1f2937; font-weight:700}
  #map { position:fixed; inset:220px 0 0 0; }
  .log {position:fixed; left:16px; right:16px; top:180px; height:28px; background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:4px 10px; font-size:13px; opacity:.85}
  .nav-controls { position:fixed; right:12px; bottom:88px; display:grid; gap:8px; z-index:1000; }
  .nav-controls button { padding:10px 12px; border-radius:12px; border:none; box-shadow:0 6px 16px rgba(0,0,0,.35);
    background:#111827; color:#fff; font-weight:700}
  .badge {font-size:12px; color:#a3a3a3;}
  a {color:#93c5fd;}
</style>
</head>
<body>
<header>Cloudflare Workers 経由 ORS 歩行ナビ</header>

<section id="panel">
  <div class="row" style="gap:12px">
    <div class="badge">開始 Lon,Lat</div>
    <input id="lon1" value="134.046">
    <input id="lat1" value="34.342">
    <div class="badge">目的地 Lon,Lat</div>
    <input id="lon2" value="134.049">
    <input id="lat2" value="34.341">
    <div class="badge">プロファイル</div>
    <select id="profile">
      <option value="foot-walking" selected>foot-walking</option>
      <option value="driving-car">driving-car</option>
      <option value="cycling-regular">cycling-regular</option>
    </select>
    <div class="badge">言語</div>
    <select id="lang">
      <option value="ja" selected>ja</option>
      <option value="en">en</option>
      <option value="de">de</option>
      <option value="zh">zh</option>
    </select>
    <button id="btn-route" class="primary">ルート取得</button>
  </div>
  <div class="badge" style="margin-top:6px">
    ※ このページは GitHub Pages（origin: <code id="origin"></code>）から Cloudflare Worker を CORS で呼びます。
  </div>
</section>

<div id="map"></div>
<div id="log" class="log">準備中…</div>

<!-- 右下：現在地/目的地/リルート -->
<div class="nav-controls">
  <button id="btn-locate">現在地</button>
  <button id="btn-dest">目的地</button>
  <button id="btn-reroute">リルート</button>
</div>

<script>
/*** ====== 設定 ====== ***/
// ★あなたの Cloudflare Worker URL（変更可）
const WORKER_ORIGIN = 'https://ors-proxy.miyata-connect-jp.workers.dev';

document.getElementById('origin').textContent = location.origin;

/*** ====== 共有状態 ====== ***/
let map, routeLine, currentPosMarker;
let route = null;              // ORSレスポンス
let announcedStepIds = new Set();
let watchId = null;
let keepAliveId = null;
let LANG = 'ja';
let PROFILE = 'foot-walking';

/*** ====== 便利 ====== ***/
function log(msg){ const el=document.getElementById('log'); el.textContent = msg; }
function sleep(ms){return new Promise(r=>setTimeout(r,ms));}

/*** ====== ORS呼び出し（Workers経由） ====== ***/
async function fetchRoute([lon1,lat1],[lon2,lat2]) {
  const url = `${WORKER_ORIGIN}/proxy?profile=${encodeURIComponent(PROFILE)}`;
  const body = { coordinates: [[lon1,lat1],[lon2,lat2]], instructions: true, language: LANG };
  const res  = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body),
    cache:'no-store',
    credentials:'omit'
  });
  if (!res.ok) throw new Error(`route HTTP ${res.status}`);
  return await res.json();
}

/*** ====== polyline decode（ORS polyline5） ====== ***/
function decodePolyline(str, precision=5) {
  let index = 0, lat = 0, lon = 0, coordinates = [];
  const factor = Math.pow(10, precision);
  while (index < str.length) {
    let result = 1, shift = 0, b;
    do { b = str.charCodeAt(index++) - 63 - 1; result += b << shift; shift += 5; } while (b >= 0x1f);
    lat += (result & 1) ? ~(result >> 1) : (result >> 1);
    result = 1; shift = 0;
    do { b = str.charCodeAt(index++) - 63 - 1; result += b << shift; shift += 5; } while (b >= 0x1f);
    lon += (result & 1) ? ~(result >> 1) : (result >> 1);
    coordinates.push([lat / factor, lon / factor]); // [lat,lon]
  }
  return coordinates;
}

/*** ====== 描画 ====== ***/
function drawRoute(ors) {
  route = ors;
  announcedStepIds.clear();
  const line = decodePolyline(ors.routes[0].geometry);
  if (routeLine) routeLine.remove();
  routeLine = L.polyline(line, {weight:6, opacity:0.92, color:'#38bdf8'}).addTo(map);
  map.fitBounds(routeLine.getBounds(), {padding:[40,40]});
}

/*** ====== 地理 ====== ***/
function haversine([lat1,lon1],[lat2,lon2]) {
  const R=6371000, toRad = d => d*Math.PI/180;
  const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}

/*** ====== 音（ピーコン＋TTS） ====== ***/
function beep() {
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.frequency.value = 880; g.gain.value = 0.08;
    o.start(); setTimeout(()=>{o.stop(); ctx.close();}, 120);
  }catch{}
}
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = LANG; u.rate = 1; u.pitch = 1;
  window.speechSynthesis.cancel(); // 前の発話を中断して被りを防止
  window.speechSynthesis.speak(u);
}

/*** ====== 5m手前案内 ====== ***/
function handleTurnByTurn(pos) {
  if (!route) return;
  const steps = route.routes[0].segments[0].steps;
  const poly = decodePolyline(route.routes[0].geometry);

  for (let i=0;i<steps.length;i++){
    const step = steps[i];
    const endIdx = step.way_points[1];
    const end = poly[endIdx]; // [lat,lon]
    const d = haversine([pos.lat,pos.lng], [end[0], end[1]]);
    if (d <= 6 && d >= 4 && !announcedStepIds.has(i)) {
      announcedStepIds.add(i);
      beep(); speak(step.instruction);
    }
  }
}

/*** ====== 5m外れたら自動リルート ====== ***/
async function maybeReroute(pos) {
  if (!routeLine) return;
  const latlngs = routeLine.getLatLngs();
  let min = Infinity;
  for (const p of latlngs) {
    const d = haversine([pos.lat,pos.lng],[p.lat,p.lng]);
    if (d < min) min = d;
  }
  if (min > 5) {
    await rerouteFromHere();
  }
}

/*** ====== 現在地追従 + KeepAlive ====== ***/
function startWatch() {
  if (watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(p=>{
    const {latitude, longitude} = p.coords;
    const latlng = {lat: latitude, lng: longitude};

    if (!currentPosMarker) currentPosMarker = L.marker(latlng).addTo(map);
    currentPosMarker.setLatLng(latlng);

    handleTurnByTurn(latlng);
    maybeReroute(latlng);
  },{
    enableHighAccuracy:true, maximumAge:0, timeout:10000
  });

  if (keepAliveId) clearInterval(keepAliveId);
  keepAliveId = setInterval(()=>{
    fetch(`${WORKER_ORIGIN}/debug`, {cache:'no-store'}).catch(()=>{});
  }, 25000);
}

/*** ====== 手動リルート ====== ***/
async function rerouteFromHere() {
  if (!currentPosMarker || !route) return;
  const cur = currentPosMarker.getLatLng();
  const poly = decodePolyline(route.routes[0].geometry);
  const last = poly[poly.length-1]; // [lat,lon]
  log('リルート中…');
  const json = await fetchRoute([cur.lng, cur.lat], [last[1], last[0]]);
  drawRoute(json);
  speak('ルートを再検索しました');
  log('リルート完了');
}

/*** ====== UIイベント ====== ***/
document.getElementById('btn-route').addEventListener('click', async ()=>{
  const lon1 = parseFloat(document.getElementById('lon1').value);
  const lat1 = parseFloat(document.getElementById('lat1').value);
  const lon2 = parseFloat(document.getElementById('lon2').value);
  const lat2 = parseFloat(document.getElementById('lat2').value);
  LANG    = document.getElementById('lang').value;
  PROFILE = document.getElementById('profile').value;

  try{
    log('ルート取得中…');
    const json = await fetchRoute([lon1,lat1],[lon2,lat2]);
    drawRoute(json);
    log('HTTP 200 / 成功');
  }catch(e){
    log('エラー: ' + e.message);
  }
});

document.getElementById('btn-locate').addEventListener('click', ()=>{
  if (currentPosMarker) map.setView(currentPosMarker.getLatLng(), 18, {animate:true});
});
document.getElementById('btn-dest').addEventListener('click', ()=>{
  if (!route) return;
  const poly = decodePolyline(route.routes[0].geometry);
  const last = L.latLng(poly[poly.length-1][0], poly[poly.length-1][1]);
  map.setView(last, 18, {animate:true});
});
document.getElementById('btn-reroute').addEventListener('click', rerouteFromHere);

/*** ====== 初期化 ====== ***/
async function init() {
  map = L.map('map', { zoomControl: true }).setView([34.342,134.046], 16);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  log('準備OK。ボタンを押してください。');

  // 位置追従スタート
  startWatch();
}
init();
</script>
</body>
</html>
