<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>WALK NAV（徒歩ナビ）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --panel-bg: rgba(255,255,255,.96);
      --shadow: 0 6px 20px rgba(0,0,0,.15);
      --radius: 14px;
      --ui-gap: 8px;
    }
    html,body{ height:100%; margin:0; }
    #map{ position:fixed; inset:0; }

    /* 上部コントロール（モバイルは縦並び） */
    #panel{
      position:fixed; z-index:1000;
      left: max(8px, env(safe-area-inset-left));
      right: max(8px, env(safe-area-inset-right));
      top: calc(8px + env(safe-area-inset-top));
      display:grid; gap: var(--ui-gap);
      grid-template-columns: 1fr auto;
      align-items:center;
      background: var(--panel-bg);
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    #panel .row{ display: contents; }
    #q{
      width:100%;
      padding:12px 14px;
      border-radius: 12px;
      border:1px solid #cbd5e1;
      font-size:16px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:44px; min-width:44px; padding:0 14px; gap:8px;
      border-radius: 12px; border:1px solid #cbd5e1; background:#fff;
      cursor:pointer; user-select:none; font-size:15px;
    }
    select{
      height:44px; border-radius:12px; border:1px solid #cbd5e1;
      padding:0 10px; background:#fff; font-size:15px;
    }
    #radius{ width:110px; }
    #lang{ width:110px; }
    #mic{ width:44px; }
    #search{ white-space:nowrap; }

    /* レイアウト：モバイルは縦積み（被り対策） */
    @media (max-width: 680px){
      #panel{
        grid-template-columns: 1fr;
      }
      #panel .row{
        display:grid; grid-template-columns: 1fr 1fr; gap: var(--ui-gap);
      }
      #q{ grid-column: 1 / -1; }
      #mic{ grid-column: 1 / 1; }
      #search{ grid-column: 2 / 2; }
      #lang { grid-column: 1 / 1; }
      #radius{ grid-column: 2 / 2; }
    }

    /* 現在地ボタン（ズームと被らないように右上へ固定） */
    .locate-control{
      position: fixed;
      top: calc(72px + env(safe-area-inset-top)); /* 上のパネルの下にくるようオフセット */
      right: max(10px, env(safe-area-inset-right));
      z-index: 999; /* ズームより上 */
    }
    .locate-control .btn{ box-shadow: var(--shadow); }

    /* ルート情報トースト */
    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(14px + env(safe-area-inset-bottom));
      background: var(--panel-bg); padding:10px 14px;
      border-radius: 12px; box-shadow: var(--shadow);
      z-index:1000; font-size:14px; display:none;
      max-width: min(92vw, 680px);
    }

    /* ルート線と出発/目的地マーカーの色味 */
    .route-line{ filter: drop-shadow(0 1px 1px rgba(0,0,0,.35)); }
  </style>
</head>

<body>
  <div id="map" aria-label="地図"></div>

  <!-- 上部パネル -->
  <div id="panel" role="group" aria-label="検索・設定">
    <input id="q" type="text" placeholder="店名・住所・電話番号を入力（例：ローソン / 087-xxx-xxxx）" />
    <button id="search" class="btn" title="検索">検索</button>

    <div class="row">
      <select id="radius" title="周辺検索半径">
        <option value="100">100m</option>
        <option value="300" selected>300m</option>
        <option value="500">500m</option>
      </select>

      <button id="mic" class="btn" title="音声入力">🎤</button>

      <select id="lang" title="音声・案内言語">
        <option value="ja" selected>日本語</option>
        <option value="en">English</option>
        <option value="ko">한국어</option>
        <option value="zh-CN">简体中文</option>
        <option value="zh-TW">繁體中文</option>
      </select>
    </div>
  </div>

  <!-- 現在地ボタン（ズームと被らない固定位置） -->
  <div class="locate-control">
    <button id="locate" class="btn" title="現在地へ移動">📍 現在地</button>
  </div>

  <!-- 簡易トースト -->
  <div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ====== Leaflet 基本セットアップ ======
  const map = L.map('map', { zoomControl: true, attributionControl: true })
      .setView([34.342, 134.046], 16);  // 初回は高松付近、後で現在地へ

  // ベースタイル（軽く色味がある方をデフォルト）
  const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // 目立つ現在地マーカー
  const meIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    shadowAnchor:[12,41]
  });
  const dstIcon = L.divIcon({
    className:'', html:'<div style="width:16px;height:16px;border-radius:50%;background:#e11d48;border:3px solid #fff;box-shadow:0 0 0 2px rgba(225,29,72,.35)"></div>',
    iconSize:[16,16], iconAnchor:[8,8]
  });

  let meMarker, dstMarker, routeLine, routeShadow;
  let lastPosition = null;

  // ====== DOM 参照 ======
  const $ = sel => document.querySelector(sel);
  const qEl = $('#q');
  const radiusEl = $('#radius');
  const micEl = $('#mic');
  const searchEl = $('#search');
  const langEl = $('#lang');
  const locateEl = $('#locate');
  const toastEl = $('#toast');

  // ====== 画面ユーティリティ ======
  function toast(msg, ms=2200){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
  }
  function metersToTime(m){ // 秒→表示
    const min = Math.round(m/60);
    if(min < 60) return `徒歩 約${min}分`;
    const h = Math.floor(min/60), r = min%60;
    return `徒歩 約${h}時間${r}分`;
  }

  // ====== 現在地取得（watch） ======
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(
      pos=>{
        const {latitude, longitude} = pos.coords;
        lastPosition = [latitude, longitude];
        if(!meMarker){
          meMarker = L.marker(lastPosition, {icon: meIcon}).addTo(map).bindPopup('現在地');
          // 初回だけ中心へ
          map.setView(lastPosition, 17);
        }else{
          meMarker.setLatLng(lastPosition);
        }
      },
      err=>{ console.warn('geolocation', err); },
      { enableHighAccuracy:true, maximumAge:10000, timeout:10000 }
    );
  }else{
    toast('この端末は位置情報に対応していません');
  }
  locateEl.addEventListener('click', ()=>{
    if(lastPosition){ map.flyTo(lastPosition, 18, {duration:.6}); meMarker?.openPopup(); }
    else toast('現在地を取得中です…');
  });

  // ====== 音声入力 ======
  let recog;
  micEl.addEventListener('click', ()=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ toast('このブラウザは音声入力に対応していません'); return; }
    if(!recog){
      recog = new SR();
      recog.lang = langEl.value || 'ja';
      recog.interimResults = false;
      recog.maxAlternatives = 1;
      recog.addEventListener('result', e=>{
        const text = e.results[0][0].transcript.trim();
        qEl.value = text;
        doSearch();
      });
      recog.addEventListener('error', e=> toast('音声入力エラー: ' + e.error));
    }
    try{ recog.lang = langEl.value || 'ja'; recog.start(); }catch(_){}
  });

  // ====== 検索 → 近傍Nominatim（バウンディングボックス） or 電話番号はOverpass ======
  async function geocodeAround(term, centerLatLng, radiusM, lang){
    const [lat, lon] = centerLatLng;

    // 1) 電話番号らしければ Overpass (phone / contact:phone)
    const digits = term.replace(/[^\d]/g,'');
    if(digits.length >= 7){
      try{
        const overpass = 'https://overpass-api.de/api/interpreter';
        const q = `
          [out:json][timeout:25];
          (
            node(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            node(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
            way(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            way(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
            relation(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            relation(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
          );
          out center 20;
        `;
        const res = await fetch(overpass, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: new URLSearchParams({ data: q })
        });
        const json = await res.json();
        if(json.elements && json.elements.length){
          // 一番近いものを採用
          let best = null, bestD=Infinity;
          json.elements.forEach(el=>{
            const y = el.lat || el.center?.lat;
            const x = el.lon || el.center?.lon;
            if(y && x){
              const d = map.distance([lat,lon],[y,x]);
              if(d < bestD){ bestD=d; best={lat:y, lon:x, display_name: el.tags?.name || '目的地'}; }
            }
          });
          if(best) return [best];
        }
      }catch(e){ console.warn('overpass phone', e); }
    }

    // 2) Nominatim（viewbox + bounded=1）: 周辺ボックスだけで絞る
    const dLat = radiusM / 111320;                 // 1deg ≒ 111.32km
    const dLon = radiusM / (111320 * Math.cos(lat*Math.PI/180));
    const minLon = lon - dLon, maxLon = lon + dLon;
    const minLat = lat - dLat, maxLat = lat + dLat;
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2');
    url.searchParams.set('q', term);
    url.searchParams.set('limit','10');
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language', lang || 'ja');
    url.searchParams.set('viewbox', `${minLon},${maxLat},${maxLon},${minLat}`); // left,top,right,bottom
    url.searchParams.set('bounded','1');

    const res = await fetch(url, { headers:{'Accept':'application/json'} });
    const list = await res.json();
    return list;
  }

  // ====== ORS ルーティング（Cloudflare Worker プロキシ） ======
  const ORS_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';

  async function routeWalk(fromLatLng, toLatLng, lang='ja'){
    const body = {
      coordinates: [[fromLatLng[1], fromLatLng[0]],[toLatLng[1], toLatLng[0]]], // [lon,lat]
      instructions: true,
      language: lang
    };
    const url = `${ORS_PROXY}?profile=foot-walking&format=geojson`;
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok){ throw new Error('ORS応答エラー '+r.status); }
    const geo = await r.json(); // GeoJSON
    // feature 抽出
    const feat = geo.features?.[0];
    if(!feat) throw new Error('ルートなし');
    const coords = feat.geometry.coordinates.map(([x,y])=> [y,x]);
    const durSec = feat.properties?.summary?.duration || 0;
    const distM  = feat.properties?.summary?.distance || 0;
    return { coords, durSec, distM, raw: feat };
  }

  // ====== ルート描画 ======
  function drawRoute(latlngs){
    if(routeLine){ map.removeLayer(routeLine); map.removeLayer(routeShadow); }
    routeShadow = L.polyline(latlngs, {color:'#000', weight:8, opacity:.25, className:'route-line'}).addTo(map);
    routeLine   = L.polyline(latlngs, {color:'#2563eb', weight:5, opacity:.9, className:'route-line'}).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[80, 40] });
  }

  // ====== 検索 → ルート ======
  async function doSearch(){
    const term = qEl.value.trim();
    if(!term){ toast('キーワードを入力'); return; }
    const center = lastPosition || map.getCenter();
    const r = parseInt(radiusEl.value,10) || 300;
    const lang = langEl.value || 'ja';

    try{
      toast('検索中…');
      const list = await geocodeAround(term, [center.lat, center.lng], r, lang);
      if(!list || !list.length){ toast('見つかりませんでした'); return; }

      const best = list[0];
      const to = [parseFloat(best.lat), parseFloat(best.lon)];
      if(!dstMarker){
        dstMarker = L.marker(to, {icon: dstIcon}).addTo(map);
      }else{
        dstMarker.setLatLng(to);
      }
      dstMarker.bindPopup(best.display_name || '目的地').openPopup();

      const from = lastPosition ? lastPosition : [center.lat, center.lng];
      const route = await routeWalk(from, to, lang);
      drawRoute(route.coords);
      toast(`${(route.distM/1000).toFixed(2)} km｜${metersToTime(route.durSec)}`);
    }catch(e){
      console.error(e);
      toast('エラー：' + (e.message || e));
    }
  }
  searchEl.addEventListener('click', doSearch);
  qEl.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

  // ====== URLパラメータ ?q= で初期検索（ブックマーク用） ======
  const usp = new URLSearchParams(location.search);
  const initQ = usp.get('q');
  if(initQ){ qEl.value = initQ; setTimeout(doSearch, 400); }

})();
</script>
</body>
</html>