<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ナビゲーションシステム</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* モード表示 */
        #mode-display {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        /* ボタン共通スタイル */
        .control-button {
            position: absolute;
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s;
        }

        .control-button:hover {
            background: #f0f0f0;
            transform: scale(1.05);
        }

        .control-button:active {
            transform: scale(0.95);
        }

        /* ボタン配置 - 等間隔に統一 */
        #location-btn {
            bottom: 280px;
            right: 20px;
            width: 50px;
            height: 50px;
        }

        #search-btn {
            bottom: 220px; /* 60px間隔 */
            right: 20px;
            width: 50px;
            height: 50px;
        }

        #reroute-btn {
            bottom: 160px; /* 60px間隔 */
            right: 20px;
            width: 50px;
            height: 50px;
            display: none;
        }

        #voice-guide-btn {
            bottom: 100px; /* 60px間隔 */
            right: 20px;
            width: 50px;
            height: 50px;
            display: none;
        }

        /* コントロールボタン（ロケーションボタン押下後） */
        #control-buttons {
            position: absolute;
            bottom: 340px; /* ロケーションボタンから60px上 */
            right: 20px;
            display: none;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        #control-buttons.active {
            display: flex;
        }

        .mode-button {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-size: 13px;
            white-space: nowrap;
            min-width: 120px;
            transition: all 0.3s;
        }

        .mode-button:hover {
            background: #f0f0f0;
            transform: translateX(-5px);
        }

        .mode-button.active {
            background: #4CAF50;
            color: white;
        }

        /* 検索パネル */
        #search-panel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #search-panel.active {
            display: flex;
        }

        .search-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .search-header h2 {
            font-size: 20px;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            line-height: 1;
        }

        .search-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #search-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        #search-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .search-button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        #execute-search-btn {
            background: #4CAF50;
            color: white;
        }

        #execute-search-btn:hover {
            background: #45a049;
        }

        #voice-search-btn {
            background: #2196F3;
            color: white;
            padding: 12px 16px;
        }

        #voice-search-btn:hover {
            background: #1976D2;
        }

        #voice-search-btn.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* 案内中止ボタン */
        #stop-navigation-btn {
            background: #f44336;
            color: white;
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: none;
        }

        #stop-navigation-btn:hover {
            background: #d32f2f;
        }

        .saved-locations {
            margin-top: 20px;
        }

        .saved-locations h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #333;
        }

        .location-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .location-item:hover {
            background: #e0e0e0;
            transform: translateX(5px);
        }

        .location-info {
            flex: 1;
        }

        .location-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }

        .location-address {
            font-size: 12px;
            color: #666;
        }

        .location-actions {
            display: flex;
            gap: 8px;
        }

        .location-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
        }

        .edit-btn:hover {
            background: #1976D2;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        .delete-btn:hover {
            background: #d32f2f;
        }

        .no-locations {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* 編集ダイアログ */
        #edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        #edit-dialog.active {
            display: flex;
        }

        .edit-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            width: 90%;
            max-width: 400px;
        }

        .edit-content h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .edit-content input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
        }

        .edit-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .save-edit-btn {
            background: #4CAF50;
            color: white;
        }

        .cancel-edit-btn {
            background: #999;
            color: white;
        }

        /* 情報ウィンドウ */
        .info-window {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 80%;
            text-align: center;
        }

        .info-window.success {
            border-left: 4px solid #4CAF50;
        }

        .info-window.error {
            border-left: 4px solid #f44336;
        }

        /* アイコン */
        .icon {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- モード表示 -->
    <div id="mode-display">現在地登録前</div>

    <!-- コントロールボタン -->
    <button id="location-btn" class="control-button" title="現在地">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
        </svg>
    </button>

    <button id="search-btn" class="control-button" title="検索">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
        </svg>
    </button>

    <button id="reroute-btn" class="control-button" title="再探索">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/>
        </svg>
    </button>

    <button id="voice-guide-btn" class="control-button" title="音声案内">
        <svg class="icon" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
    </button>

    <!-- ロケーションボタン押下後のコントロール -->
    <div id="control-buttons">
        <button class="mode-button" id="north-up-btn">ノースアップ</button>
        <button class="mode-button" id="heading-up-btn">ヘディングアップ</button>
        <button class="mode-button" id="register-current-btn">現在地を登録</button>
        <button class="mode-button" id="register-map-btn">地図上を登録</button>
        <button class="mode-button" id="edit-location-btn">登録地点編集</button>
    </div>

    <!-- 検索パネル -->
    <div id="search-panel">
        <div class="search-content">
            <div class="search-header">
                <h2>目的地検索</h2>
                <button class="close-btn" id="close-search-btn">&times;</button>
            </div>
            
            <div class="search-input-wrapper">
                <input type="text" id="search-input" placeholder="目的地を入力">
                <button id="voice-search-btn" class="search-button">
                    <svg class="icon" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                        <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                    </svg>
                </button>
                <button id="execute-search-btn" class="search-button">検索</button>
            </div>

            <button id="stop-navigation-btn">案内中止</button>

            <div class="saved-locations">
                <h3>登録地点</h3>
                <div id="saved-locations-list"></div>
            </div>
        </div>
    </div>

    <!-- 編集ダイアログ -->
    <div id="edit-dialog">
        <div class="edit-content">
            <h3>地点名を編集</h3>
            <input type="text" id="edit-location-name" placeholder="地点名を入力">
            <div class="edit-actions">
                <button class="save-edit-btn" id="save-edit-btn">保存</button>
                <button class="cancel-edit-btn" id="cancel-edit-btn">キャンセル</button>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let map;
        let currentPosition = null;
        let watchId = null;
        let currentMarker = null;
        let destinationMarker = null;
        let routePolyline = null;
        let isNavigating = false;
        let isVoiceGuideEnabled = false;
        let mapMode = 'north-up'; // 'north-up' or 'heading-up'
        let registrationMode = null; // null, 'current', 'map'
        let savedLocations = [];
        let currentHeading = 0;
        let editingLocationIndex = null;
        let mapClickListener = null;
        let recognizing = false;

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            loadSavedLocations();
            setupEventListeners();
            startLocationTracking();
        });

        // 地図初期化
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([35.6762, 139.6503], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // ロケーションボタン
            document.getElementById('location-btn').addEventListener('click', function() {
                const controlButtons = document.getElementById('control-buttons');
                controlButtons.classList.toggle('active');
            });

            // 検索ボタン
            document.getElementById('search-btn').addEventListener('click', function() {
                document.getElementById('search-panel').classList.add('active');
            });

            // 検索パネルクローズ
            document.getElementById('close-search-btn').addEventListener('click', function() {
                document.getElementById('search-panel').classList.remove('active');
            });

            // 検索実行
            document.getElementById('execute-search-btn').addEventListener('click', executeSearch);
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    executeSearch();
                }
            });

            // 音声検索
            document.getElementById('voice-search-btn').addEventListener('click', startVoiceSearch);

            // 案内中止ボタン
            document.getElementById('stop-navigation-btn').addEventListener('click', stopNavigation);

            // モードボタン
            document.getElementById('north-up-btn').addEventListener('click', function() {
                setMapMode('north-up');
            });

            document.getElementById('heading-up-btn').addEventListener('click', function() {
                setMapMode('heading-up');
            });

            document.getElementById('register-current-btn').addEventListener('click', function() {
                startRegistrationMode('current');
            });

            document.getElementById('register-map-btn').addEventListener('click', function() {
                startRegistrationMode('map');
            });

            document.getElementById('edit-location-btn').addEventListener('click', function() {
                openLocationEditor();
            });

            // リルートボタン
            document.getElementById('reroute-btn').addEventListener('click', function() {
                if (isNavigating && destinationMarker) {
                    const dest = destinationMarker.getLatLng();
                    calculateRoute(currentPosition, dest);
                    showInfo('ルートを再計算しました', 'success');
                }
            });

            // 音声案内ボタン
            document.getElementById('voice-guide-btn').addEventListener('click', function() {
                isVoiceGuideEnabled = !isVoiceGuideEnabled;
                this.style.background = isVoiceGuideEnabled ? '#4CAF50' : 'white';
                showInfo(isVoiceGuideEnabled ? '音声案内ON' : '音声案内OFF', 'success');
            });

            // 編集ダイアログ
            document.getElementById('save-edit-btn').addEventListener('click', saveLocationEdit);
            document.getElementById('cancel-edit-btn').addEventListener('click', function() {
                document.getElementById('edit-dialog').classList.remove('active');
            });
        }

        // 位置追跡開始
        function startLocationTracking() {
            if ('geolocation' in navigator) {
                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleLocationError,
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        // 位置更新
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            currentPosition = L.latLng(lat, lng);
            
            if (position.coords.heading !== null) {
                currentHeading = position.coords.heading;
            }

            if (!currentMarker) {
                currentMarker = L.circleMarker(currentPosition, {
                    radius: 8,
                    fillColor: '#4285F4',
                    color: 'white',
                    weight: 2,
                    fillOpacity: 1
                }).addTo(map);
                map.setView(currentPosition, 16);
                updateModeDisplay();
            } else {
                currentMarker.setLatLng(currentPosition);
            }

            // ヘディングアップモード時の地図回転
            if (mapMode === 'heading-up' && currentHeading !== null) {
                map.setBearing(-currentHeading);
            }

            // ナビゲーション中の処理
            if (isNavigating && destinationMarker) {
                const distance = currentPosition.distanceTo(destinationMarker.getLatLng());
                if (distance < 50) {
                    showInfo('目的地に到着しました', 'success');
                    stopNavigation();
                }
            }
        }

        // 位置エラー処理
        function handleLocationError(error) {
            console.error('位置情報エラー:', error);
            showInfo('位置情報の取得に失敗しました', 'error');
        }

        // 地図モード設定
        function setMapMode(mode) {
            mapMode = mode;
            
            // ボタンのアクティブ状態更新
            document.getElementById('north-up-btn').classList.toggle('active', mode === 'north-up');
            document.getElementById('heading-up-btn').classList.toggle('active', mode === 'heading-up');
            
            if (mode === 'north-up') {
                map.setBearing(0);
                showInfo('ノースアップモードに設定', 'success');
            } else {
                if (currentHeading !== null) {
                    map.setBearing(-currentHeading);
                }
                showInfo('ヘディングアップモードに設定', 'success');
            }
            
            document.getElementById('control-buttons').classList.remove('active');
        }

        // 登録モード開始
        function startRegistrationMode(mode) {
            registrationMode = mode;
            document.getElementById('control-buttons').classList.remove('active');

            if (mode === 'current') {
                if (currentPosition) {
                    registerLocation(currentPosition, '現在地');
                } else {
                    showInfo('現在地が取得できていません', 'error');
                }
            } else if (mode === 'map') {
                updateModeDisplay();
                showInfo('地図上の登録したい場所をタップしてください', 'success');
                
                // マップクリックリスナーを設定
                if (mapClickListener) {
                    map.off('click', mapClickListener);
                }
                mapClickListener = function(e) {
                    registerLocation(e.latlng, '地図上の地点');
                    map.off('click', mapClickListener);
                    mapClickListener = null;
                };
                map.on('click', mapClickListener);
            }
        }

        // 地点登録
        function registerLocation(latlng, defaultName) {
            const name = prompt('地点名を入力してください:', defaultName);
            if (name && name.trim() !== '') {
                const location = {
                    name: name.trim(),
                    lat: latlng.lat,
                    lng: latlng.lng,
                    address: `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`
                };
                
                savedLocations.push(location);
                localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
                updateSavedLocationsList();
                showInfo(`"${name}"を登録しました`, 'success');
                
                // マーカー追加
                L.marker([latlng.lat, latlng.lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '📍',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup(name);
            }
            
            registrationMode = null;
            updateModeDisplay();
        }

        // 保存地点読み込み
        function loadSavedLocations() {
            const saved = localStorage.getItem('savedLocations');
            if (saved) {
                savedLocations = JSON.parse(saved);
                updateSavedLocationsList();
                
                // 地図上にマーカー表示
                savedLocations.forEach(loc => {
                    L.marker([loc.lat, loc.lng], {
                        icon: L.divIcon({
                            className: 'custom-marker',
                            html: '📍',
                            iconSize: [30, 30]
                        })
                    }).addTo(map).bindPopup(loc.name);
                });
            }
        }

        // 保存地点リスト更新
        function updateSavedLocationsList() {
            const list = document.getElementById('saved-locations-list');
            
            if (savedLocations.length === 0) {
                list.innerHTML = '<div class="no-locations">登録地点がありません</div>';
                return;
            }
            
            list.innerHTML = savedLocations.map((loc, index) => `
                <div class="location-item" onclick="navigateToSavedLocation(${index})">
                    <div class="location-info">
                        <div class="location-name">${loc.name}</div>
                        <div class="location-address">${loc.address}</div>
                    </div>
                    <div class="location-actions">
                        <button class="location-action-btn edit-btn" onclick="event.stopPropagation(); editLocation(${index})">編集</button>
                        <button class="location-action-btn delete-btn" onclick="event.stopPropagation(); deleteLocation(${index})">削除</button>
                    </div>
                </div>
            `).join('');
        }

        // 保存地点へナビゲート
        function navigateToSavedLocation(index) {
            const loc = savedLocations[index];
            const destination = L.latLng(loc.lat, loc.lng);
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }
            
            destinationMarker = L.marker(destination, {
                icon: L.divIcon({
                    className: 'custom-marker',
                    html: '🎯',
                    iconSize: [40, 40]
                })
            }).addTo(map);
            
            if (currentPosition) {
                calculateRoute(currentPosition, destination);
                isNavigating = true;
                document.getElementById('reroute-btn').style.display = 'block';
                document.getElementById('voice-guide-btn').style.display = 'block';
                document.getElementById('stop-navigation-btn').style.display = 'block';
                showInfo(`"${loc.name}"へのルートを計算中...`, 'success');
            }
            
            document.getElementById('search-panel').classList.remove('active');
            updateModeDisplay();
        }

        // 地点編集
        function editLocation(index) {
            editingLocationIndex = index;
            const loc = savedLocations[index];
            document.getElementById('edit-location-name').value = loc.name;
            document.getElementById('edit-dialog').classList.add('active');
        }

        // 地点編集保存
        function saveLocationEdit() {
            if (editingLocationIndex !== null) {
                const newName = document.getElementById('edit-location-name').value.trim();
                if (newName) {
                    savedLocations[editingLocationIndex].name = newName;
                    localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
                    updateSavedLocationsList();
                    showInfo('地点名を更新しました', 'success');
                }
            }
            document.getElementById('edit-dialog').classList.remove('active');
            editingLocationIndex = null;
        }

        // 地点削除
        function deleteLocation(index) {
            if (confirm(`"${savedLocations[index].name}"を削除しますか？`)) {
                savedLocations.splice(index, 1);
                localStorage.setItem('savedLocations', JSON.stringify(savedLocations));
                updateSavedLocationsList();
                showInfo('地点を削除しました', 'success');
            }
        }

        // 登録地点編集を開く
        function openLocationEditor() {
            document.getElementById('search-panel').classList.add('active');
            document.getElementById('control-buttons').classList.remove('active');
        }

        // 検索実行
        function executeSearch() {
            const query = document.getElementById('search-input').value.trim();
            if (!query) {
                showInfo('検索語を入力してください', 'error');
                return;
            }
            
            // Nominatim APIで検索
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const result = data[0];
                        const destination = L.latLng(result.lat, result.lon);
                        
                        if (destinationMarker) {
                            map.removeLayer(destinationMarker);
                        }
                        
                        destinationMarker = L.marker(destination, {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: '🎯',
                                iconSize: [40, 40]
                            })
                        }).addTo(map);
                        
                        if (currentPosition) {
                            calculateRoute(currentPosition, destination);
                            isNavigating = true;
                            document.getElementById('reroute-btn').style.display = 'block';
                            document.getElementById('voice-guide-btn').style.display = 'block';
                            document.getElementById('stop-navigation-btn').style.display = 'block';
                        }
                        
                        map.setView(destination, 15);
                        document.getElementById('search-panel').classList.remove('active');
                        showInfo('目的地を設定しました', 'success');
                        updateModeDisplay();
                    } else {
                        showInfo('検索結果が見つかりませんでした', 'error');
                    }
                })
                .catch(error => {
                    console.error('検索エラー:', error);
                    showInfo('検索中にエラーが発生しました', 'error');
                });
        }

        // 音声検索開始
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showInfo('音声認識に対応していません', 'error');
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const recognition = new SpeechRecognition();
            recognition.lang = 'ja-JP';
            recognition.continuous = false;
            recognition.interimResults = false;

            const voiceBtn = document.getElementById('voice-search-btn');
            
            if (recognizing) {
                recognition.stop();
                return;
            }

            recognizing = true;
            voiceBtn.classList.add('recording');

            recognition.onstart = function() {
                showInfo('音声を認識中...', 'success');
            };

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('search-input').value = transcript;
                showInfo(`"${transcript}" と認識しました`, 'success');
                recognizing = false;
                voiceBtn.classList.remove('recording');
            };

            recognition.onerror = function(event) {
                console.error('音声認識エラー:', event.error);
                showInfo('音声認識に失敗しました', 'error');
                recognizing = false;
                voiceBtn.classList.remove('recording');
            };

            recognition.onend = function() {
                recognizing = false;
                voiceBtn.classList.remove('recording');
            };

            try {
                recognition.start();
            } catch (error) {
                console.error('音声認識開始エラー:', error);
                showInfo('音声認識を開始できませんでした', 'error');
                recognizing = false;
                voiceBtn.classList.remove('recording');
            }
        }

        // ルート計算
        function calculateRoute(start, end) {
            if (routePolyline) {
                map.removeLayer(routePolyline);
            }
            
            // OSRM APIでルート計算
            const url = `https://router.project-osrm.org/route/v1/driving/${start.lng},${start.lat};${end.lng},${end.lat}?overview=full&geometries=geojson`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                        
                        routePolyline = L.polyline(coordinates, {
                            color: '#4285F4',
                            weight: 5,
                            opacity: 0.7
                        }).addTo(map);
                        
                        map.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
                        
                        const distance = (route.distance / 1000).toFixed(1);
                        const duration = Math.round(route.duration / 60);
                        showInfo(`距離: ${distance}km, 所要時間: ${duration}分`, 'success');
                    }
                })
                .catch(error => {
                    console.error('ルート計算エラー:', error);
                    showInfo('ルート計算に失敗しました', 'error');
                });
        }

        // 案内中止
        function stopNavigation() {
            isNavigating = false;
            
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }
            
            if (routePolyline) {
                map.removeLayer(routePolyline);
                routePolyline = null;
            }
            
            document.getElementById('search-input').value = '';
            document.getElementById('reroute-btn').style.display = 'none';
            document.getElementById('voice-guide-btn').style.display = 'none';
            document.getElementById('stop-navigation-btn').style.display = 'none';
            isVoiceGuideEnabled = false;
            
            showInfo('案内を中止しました', 'success');
            updateModeDisplay();
        }

        // モード表示更新
        function updateModeDisplay() {
            const modeDisplay = document.getElementById('mode-display');
            
            if (isNavigating) {
                modeDisplay.textContent = '案内中';
            } else if (registrationMode === 'map') {
                modeDisplay.textContent = '地図上を登録時';
            } else if (currentPosition && savedLocations.length > 0) {
                modeDisplay.textContent = '現在地登録完了';
            } else if (currentPosition) {
                modeDisplay.textContent = '現在地登録時';
            } else {
                modeDisplay.textContent = '現在地登録前';
            }
        }

        // 情報表示
        function showInfo(message, type) {
            const existingInfo = document.querySelector('.info-window');
            if (existingInfo) {
                existingInfo.remove();
            }
            
            const info = document.createElement('div');
            info.className = `info-window ${type}`;
            info.textContent = message;
            document.body.appendChild(info);
            
            setTimeout(() => {
                info.remove();
            }, 3000);
        }

        // Leafletの setBearing メソッドを追加（存在しない場合）
        if (!L.Map.prototype.setBearing) {
            L.Map.prototype.setBearing = function(bearing) {
                const container = this.getContainer();
                container.style.transform = `rotate(${bearing}deg)`;
            };
        }
    </script>
</body>
</html>
