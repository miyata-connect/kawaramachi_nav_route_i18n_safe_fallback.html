<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cloudflare Workers ナビ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>

<style>
  :root{
    --bg:#0b1220;--panel:#121a2b;--fg:#e8eefc;--muted:#98a4c5;--accent:#3ea8ff;
    --btn:#18233b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}

  header{position:sticky;top:0;z-index:600;background:linear-gradient(180deg,var(--bg),#0c1527 70%);padding:10px 12px 8px}
  h1{margin:0 0 10px 0;font-size:20px}

  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .search{display:flex;align-items:center;gap:6px;background:var(--panel);border:1px solid #243150;border-radius:12px;padding:6px 8px;flex:1;min-width:260px}
  .search input{background:transparent;border:none;outline:none;color:var(--fg);width:100%;font-size:16px}
  .icon-btn{background:var(--btn);border:1px solid #22304e;color:var(--fg);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
  .icon-btn:disabled{opacity:.6;cursor:not-allowed}
  #mic{font-size:20px;padding:12px 14px;min-width:44px;min-height:44px;border-radius:12px}

  .group{display:flex;align-items:center;gap:6px;background:#0f1a31;border:1px solid #22304e;border-radius:12px;padding:6px 8px}
  .label{color:var(--muted);font-size:12px;margin-right:2px;white-space:nowrap}
  .num,select{appearance:none;background:#0f1a31;border:1px solid #22304e;border-radius:10px;color:var(--fg);padding:8px 10px;font-size:14px}
  .num{width:120px}
  .primary{background:var(--accent);border-color:#2b7fcc;color:#031225}

  .hintRow{color:var(--muted);font-size:14px;margin-top:8px}
  .status{margin-top:6px;color:#cfe2ff;font-size:14px}

  #resultWrap{margin-top:6px}
  .list{background:#0f172a;border:1px solid #22304e;border-radius:12px;max-height:40vh;overflow:auto;display:none}
  .item{padding:10px 12px;border-top:1px solid #1a2745;cursor:pointer}
  .item:first-child{border-top:none}
  .item:hover{background:#121f3b}
  .muted{color:var(--muted)}
  .listHead{padding:8px 12px;border-bottom:1px solid #1a2745;color:#cfe2ff}

  #map{height:58dvh;min-height:380px}

  .floating{position:fixed;right:14px;bottom:20px;z-index:500;display:flex;flex-direction:column;gap:10px}
  .fab{background:#0e162c;border:1px solid #22304e;color:var(--fg);border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;min-width:120px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  .fab:active{transform:translateY(1px)}

  .leaflet-control-container .leaflet-bottom.leaflet-left{bottom:16px;left:12px}
  .leaflet-control-zoom{border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
  .leaflet-control-zoom a{width:34px;height:34px;line-height:34px;font-size:18px}
</style>
</head>
<body>
  <header>
    <h1>Cloudflare Workers ナビ</h1>

    <!-- 検索 -->
    <div class="row">
      <div class="search">
        <span>🔎</span>
        <input id="q" type="search" placeholder="店舗名・住所・電話番号で検索…" autocomplete="off">
        <button id="mic" class="icon-btn" title="音声入力">🎤</button>
        <button id="searchBtn" class="icon-btn">検索</button>
      </div>
    </div>

    <!-- 座標入力 -->
    <div class="row" style="margin-top:8px">
      <div class="group">
        <div class="label">開始地点（経度・緯度）</div>
        <input id="lon1" class="num" type="number" step="0.000001" placeholder="経度">
        <input id="lat1" class="num" type="number" step="0.000001" placeholder="緯度">
      </div>
      <div class="group">
        <div class="label">目的地（経度・緯度）</div>
        <input id="lon2" class="num" type="number" step="0.000001" placeholder="経度">
        <input id="lat2" class="num" type="number" step="0.000001" placeholder="緯度">
      </div>
    </div>

    <!-- モード・言語・操作 -->
    <div class="row" style="margin-top:8px">
      <div class="group"><div class="label">モード</div>
        <select id="profile" title="経路タイプ">
          <option value="foot-walking" selected>foot-walking（徒歩）</option>
          <option value="wheelchair">wheelchair（車いす）</option>
        </select>
      </div>
      <div class="group"><div class="label">言語</div>
        <select id="lang">
          <option value="ja" selected>日本語</option>
          <option value="en">英語</option>
          <option value="zh">中国語</option>
          <option value="ko">韓国語</option>
        </select>
      </div>
      <button id="routeBtn" class="icon-btn primary">ルート取得</button>
      <button id="clearBtn" class="icon-btn">クリア</button>
    </div>

    <!-- 記憶地点（ここに“現在地を保存”を移動） -->
    <div class="row" style="margin-top:8px">
      <div class="group" style="flex:1">
        <div class="label">記憶地点</div>
        <select id="saved" style="min-width:220px;flex:1">
          <option value="">（未選択）</option>
        </select>
      </div>
      <button id="saveHereBtn" class="icon-btn" title="現在地を保存">現在地を保存</button>
      <button id="useSavedBtn" class="icon-btn">目的地に設定</button>
      <button id="delSavedBtn" class="icon-btn">削除</button>
    </div>

    <!-- ヒント・ステータス -->
    <div class="hintRow">地図を長押しすると目的地に設定できます</div>
    <div id="statusText" class="status">準備完了。目的地を設定してください</div>

    <!-- 検索結果 -->
    <div id="resultWrap">
      <div id="list" class="list"></div>
    </div>
  </header>

  <div id="map"></div>

  <!-- 右下の操作ボタン -->
  <div class="floating">
    <button id="guideBtn" class="fab">案内開始</button>
    <button id="locBtn" class="fab">現在地</button>
    <button id="dstBtn" class="fab">目的地</button>
    <button id="rerouteBtn" class="fab">リルート</button>
  </div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
const WORKER_URL = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const ORS_ENDPOINT = WORKER_URL + '/proxy';
const SEARCH_URL = 'https://photon.komoot.io/api/';

const LANG_SPEECH = { ja:'ja-JP', en:'en-US', zh:'zh-CN', ko:'ko-KR' };

let map, youMarker, accCircle, destMarker, routeLine;
let routePoints = [], routeSteps = [];
let lastPos = null, watchId = null;
let announcedTurnIdx = -1, passedWarned = false;
let selectDestMode = false, audioCtx;

const $ = s => document.querySelector(s);
const status = t => $('#statusText').textContent = t;

function metersBetween(a,b){
  const R=6371000, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const lat1=a.lat*Math.PI/180, lat2=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}
function pointToSegDist(p, a, b){
  const x0=p.lng,y0=p.lat,x1=a.lng,y1=a.lat,x2=b.lng,y2=b.lat;
  const A={x:x0-x1,y:y0-y1}, B={x:x2-x1,y:y2-y1};
  const t=Math.max(0,Math.min(1,(A.x*B.x + A.y*B.y)/(B.x*B.x + B.y*B.y)));
  const proj={lng:x1+t*B.x, lat:y1+t*B.y};
  return metersBetween({lat:y0,lng:x0},{lat:proj.lat,lng:proj.lng});
}
function nearestDistOnLine(p, line){
  let min=Infinity;
  for(let i=1;i<line.length;i++){ min=Math.min(min, pointToSegDist(p,line[i-1],line[i])); }
  return min;
}
function decodePolyline(str, precision=6){
  let index=0, lat=0, lng=0, coords=[], shift=0, result=0, b=0, factor=Math.pow(10,precision);
  while(index<str.length){
    shift=0; result=0; do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5 }while(b>=0x20);
    lat += ((result&1)?~(result>>1):(result>>1));
    shift=0; result=0; do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5 }while(b>=0x20);
    lng += ((result&1)?~(result>>1):(result>>1));
    coords.push({lat:lat/factor,lng:lng/factor});
  } return coords;
}
function beep(ms=120, freq=880){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.12, audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime+ms/1000);
  }catch{}
}
function speak(text, lang){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = LANG_SPEECH[lang] || 'ja-JP';
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

initMap();
function initMap(){
  map = L.map('map', {zoomControl:false});
  L.control.zoom({ position:'bottomleft' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(map);

  const fallback = {lat:34.342000,lng:134.046000};
  map.setView([fallback.lat,fallback.lng], 16);
  setTimeout(()=> map.invalidateSize(), 150);

  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(p=>{
      const {latitude,longitude,accuracy}=p.coords;
      lastPos={lat:latitude,lng:longitude,accuracy};
      setStartFields(lastPos);
      showYou(lastPos);
      map.setView([latitude,longitude], 17);
      setTimeout(()=> map.invalidateSize(), 100);
    },()=>{ status('現在地は許可されませんでした（フォールバック表示）'); },
    {enableHighAccuracy:true,timeout:8000,maximumAge:30000});
  }else{
    status('位置情報に未対応の端末（フォールバック表示）');
  }

  map.on('click', e=>{ if(selectDestMode){ setDestination(e.latlng); selectDestMode=false; status('目的地を設定しました'); }});
  map.on('contextmenu', e=>{ setDestination(e.latlng); status('目的地を設定しました'); });

  window.addEventListener('resize', ()=> setTimeout(()=> map.invalidateSize(), 100));

  loadSavedPlaces();
}

function showYou(pos){
  if(!youMarker){
    youMarker=L.marker([pos.lat,pos.lng],{title:'現在地'}).addTo(map);
    accCircle=L.circle([pos.lat,pos.lng],{radius:pos.accuracy||20,color:'#3ea8ff',fillColor:'#3ea8ff',fillOpacity:.15}).addTo(map);
  }else{
    youMarker.setLatLng([pos.lat,pos.lng]);
    accCircle.setLatLng([pos.lat,pos.lng]).setRadius(pos.accuracy||20);
  }
}

function ensureWatch(){
  if(watchId!=null) return;
  if(!('geolocation' in navigator)){ status('この端末は位置情報に未対応'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
    showYou(lastPos);
    if(!$('#lat1').value || !$('#lon1').value) setStartFields(lastPos);
    maybeWarnAndGuide();
  }, err=> status('位置取得に失敗: '+err.message),
  {enableHighAccuracy:true,maximumAge:3000,timeout:10000});
}
function clearWatch(){
  if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
}

function setStartFields(latlng){ $('#lat1').value=latlng.lat.toFixed(6); $('#lon1').value=latlng.lng.toFixed(6); }
function setDestination(latlng){
  if(!destMarker){
    destMarker=L.marker(latlng,{draggable:true}).addTo(map);
    destMarker.on('dragend',()=>{ const p=destMarker.getLatLng(); $('#lon2').value=p.lng.toFixed(6); $('#lat2').value=p.lat.toFixed(6); });
  }else destMarker.setLatLng(latlng);
  $('#lon2').value=latlng.lng.toFixed(6); $('#lat2').value=latlng.lat.toFixed(6);
}

async function requestRoute(){
  const profile = $('#profile').value, lang=$('#lang').value||'ja';
  const start = getStart(), goal=getGoal();
  if(!start || !goal){ status('開始/目的地が未設定です'); return; }
  status('ルート取得中…');
  const body={coordinates:[[+start.lng,+start.lat],[+goal.lng,+goal.lat]],instructions:true,language:lang};
  try{
    const res=await fetch(`${ORS_ENDPOINT}?profile=${encodeURIComponent(profile)}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json(); if(!res.ok) throw new Error(data?.message||data?.error||res.statusText);
    drawRoute(data); status('HTTP 200 / 成功');
  }catch(e){ console.error(e); status('ルート取得に失敗: '+String(e.message||e)); }
}
function drawRoute(data){
  const route=data.routes?.[0]; if(!route){ status('ルートなし'); return; }
  routePoints=decodePolyline(route.geometry,6);
  routeSteps=(route.segments?.[0]?.steps)||[];
  if(routeLine){ routeLine.remove(); }
  routeLine=L.polyline(routePoints,{color:'#30b4ff',weight:6,opacity:.85}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  announcedTurnIdx=-1; passedWarned=false;
}
function getStart(){
  const lon=parseFloat($('#lon1').value), lat=parseFloat($('#lat1').value);
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon};
  if(lastPos) return lastPos; return null;
}
function getGoal(){
  const lon=parseFloat($('#lon2').value), lat=parseFloat($('#lat2').value);
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon};
  if(destMarker) return destMarker.getLatLng(); return null;
}

function nextTurnPoint(){
  if(!routeSteps.length) return null;
  for(let i=0;i<routeSteps.length;i++){
    const st=routeSteps[i], idx=st.way_points?.[1]; if(typeof idx!=='number') continue;
    const ll=routePoints[idx]; if(!ll) continue;
    if(lastPos && metersBetween(lastPos,ll) < 60) return {index:i, step:st, latlng:ll};
  } return null;
}
function turnSpeech(step){
  const s=step?.instruction||''; let dir='';
  if(s.includes('右')) dir='右'; else if(s.includes('左')) dir='左';
  const name=(step?.name && step.name!=='-')? step.name : 'この通り';
  return dir? `${name}を${dir}です`: (s||'直進です');
}
function maybeWarnAndGuide(){
  if(!lastPos || routePoints.length<2) return;
  const off=nearestDistOnLine(lastPos,routePoints);
  if(off>5 && !passedWarned){
    passedWarned=true; beep(140,740); speak('通り過ぎました。リルートを開始しますか？',$('#lang').value);
    setTimeout(()=>{ if(confirm('通り過ぎました。リルートを開始しますか？')) requestRoute(); },10);
  }
  const next=nextTurnPoint();
  if(next){
    const d=metersBetween(lastPos,next.latlng);
    if(d<=5 && announcedTurnIdx!==next.index){
      announcedTurnIdx=next.index; beep(120,880);
      const text=turnSpeech(next.step); speak(text,$('#lang').value); status(text+'（0m）');
    }else if(d<40 && d>5){ status(`曲がりまで 約 ${Math.round(d)} m：${next.step.instruction||''}`); }
  }
}

/*** 検索（Photon）— 近い順 上位5件 ***/
const LANG_SPEECH = { ja:'ja-JP', en:'en-US', zh:'zh-CN', ko:'ko-KR' }; // 参照用
function buildListHeader(text){ return `<div class="listHead">${text}</div>`; }

async function doSearch(){
  const q=$('#q').value.trim();
  const langVal=$('#lang').value||'ja';
  $('#list').style.display='block';
  $('#list').innerHTML=buildListHeader('検索結果')+'<div class="item muted">検索中…</div>';

  try{
    const bias = (lastPos ? `&lat=${lastPos.lat}&lon=${lastPos.lng}` : '');
    const url=`https://photon.komoot.io/api/?q=${encodeURIComponent(q||'poi')}${bias}&lang=${encodeURIComponent(langVal)}&limit=20`;
    const res=await fetch(url,{headers:{'Accept':'application/json'}}); const data=await res.json();

    let feats=data?.features||[];
    if(lastPos){
      feats = feats.map(f=>{
        const [lon,lat]=f.geometry.coordinates;
        const d = metersBetween({lat:lastPos.lat,lng:lastPos.lng},{lat, lng:lon});
        return {...f, __dist:d};
      }).sort((a,b)=>a.__dist-b.__dist).slice(0,5);
    }else{
      feats = feats.slice(0,5);
    }

    if(!feats.length){
      $('#list').innerHTML=buildListHeader('検索結果')+'<div class="item muted">該当なし</div>';
      return;
    }

    const head = buildListHeader(lastPos ? '近い順（上位5件）' : '検索結果（上位5件）');
    $('#list').innerHTML = head + feats.map(f=>{
      const p=f.properties||{};
      const name=[p.name,p.street,p.housenumber,p.city,p.country].filter(Boolean).join(' ') || p.label || '(名称不明)';
      const [lon,lat]=f.geometry.coordinates;
      const dist = (f.__dist!=null)? ` — 約${Math.round(f.__dist)}m` : '';
      return `<div class="item" data-lat="${lat}" data-lon="${lon}">
        <div>${name}</div>
        <div class="muted">${(p.osm_value||p.osm_key||'')}　<span>${lon.toFixed(5)}, ${lat.toFixed(5)}${dist}</span></div>
      </div>`;
    }).join('');

    $('#list').querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click',()=>{
        const lat=+el.dataset.lat, lon=+el.dataset.lon;
        setDestination({lat,lng:lon});
        map.setView([lat,lon],17);
        $('#list').style.display='none';
      });
    });
  }catch(e){
    $('#list').innerHTML=buildListHeader('検索結果')+`<div class="item">検索エラー: ${String(e.message||e)}</div>`;
  }
}

/*** 音声入力 ***/
(function setupMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition, mic=$('#mic');
  if(!SR){ mic.style.display='none'; return; }
  const rec=new SR();
  const setRecLang=()=> rec.lang = LANG_SPEECH[$('#lang').value||'ja'] || 'ja-JP';
  setRecLang();
  $('#lang').addEventListener('change', setRecLang);

  rec.interimResults=false; rec.maxAlternatives=1;

  mic.addEventListener('click',()=>{ try{rec.start();}catch{} status('音声を聞き取っています…'); });
  rec.onresult=e=>{ const text=e.results[0][0].transcript; $('#q').value=text; status('音声入力：'+text); doSearch(); };
  rec.onerror=e=>status('音声入力エラー：'+(e.error||''));
})();

/*** ボタン ***/
$('#routeBtn').addEventListener('click', requestRoute);
$('#rerouteBtn').addEventListener('click', requestRoute);

$('#clearBtn').addEventListener('click', ()=>{
  if(routeLine){ routeLine.remove(); routeLine=null; }
  routePoints=[]; routeSteps=[]; announcedTurnIdx=-1; passedWarned=false;
  $('#q').value='';
  $('#list').style.display='none';
  $('#list').innerHTML='';
  status('クリアしました。目的地を設定してください');
});

$('#locBtn').addEventListener('click', ()=>{ ensureWatch(); if(lastPos) map.setView([lastPos.lat,lastPos.lng],18); });
$('#dstBtn').addEventListener('click', ()=>{ selectDestMode=true; status('地図をタップして目的地を設定'); setTimeout(()=>{selectDestMode=false},7000); });
$('#searchBtn').addEventListener('click', doSearch);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

/*** 案内開始/停止 ***/
$('#guideBtn').addEventListener('click', ()=>{
  if(watchId==null){
    ensureWatch();
    $('#guideBtn').textContent='案内停止';
    status('案内を開始しました');
    if(lastPos) map.setView([lastPos.lat,lastPos.lng],18);
  }else{
    clearWatch();
    $('#guideBtn').textContent='案内開始';
    status('案内を停止しました');
  }
});

/*** 現在地を保存（ローカル） & 記憶地点の利用 ***/
const LS_KEY='cw_nav_saved_places_v1';

function loadSavedPlaces(){
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const sel=$('#saved'); sel.innerHTML='<option value="">（未選択）</option>';
  arr.forEach((p,i)=>{
    const opt=document.createElement('option');
    opt.value=String(i); opt.textContent=`${p.name}（${p.lon.toFixed(5)}, ${p.lat.toFixed(5)}）`;
    sel.appendChild(opt);
  });
}
function savePlaceHere(){
  if(!lastPos){ alert('現在地が取得できていません'); return; }
  const name = prompt('現在地に名前を付けて保存します。名称を入力してください：','マイ地点');
  if(!name) return;
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  arr.push({name, lat:lastPos.lat, lon:lastPos.lng, savedAt:Date.now()});
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
  loadSavedPlaces();
  status(`「${name}」を保存しました`);
}
$('#saveHereBtn').addEventListener('click', savePlaceHere);

$('#useSavedBtn').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const idx = $('#saved').value; if(idx===''){ alert('記憶地点を選択してください'); return; }
  const p = arr[+idx]; if(!p) return;
  setDestination({lat:p.lat,lng:p.lon});
  map.setView([p.lat,p.lon],17);
  status(`目的地を「${p.name}」に設定しました`);
  $('#list').style.display='none';
});

$('#delSavedBtn').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const idx = $('#saved').value; if(idx===''){ alert('削除する記憶地点を選択してください'); return; }
  const p = arr.splice(+idx,1)[0]; localStorage.setItem(LS_KEY, JSON.stringify(arr));
  loadSavedPlaces(); status(`「${p?.name||'地点'}」を削除しました`);
});

/*** デモ用目的地（空のときだけ） ***/
(function preset(){
  if(!$('#lon2').value && !$('#lat2').value){ $('#lon2').value='134.049'; $('#lat2').value='34.341'; }
})();
</script>
</body>
</html>