<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav v5 â€“ CurrentOnly</title>
  <style>
    html,body{height:100%;margin:0;background:#0a1321;color:#eaf2ff;font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;display:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
  </div>

  <script>
    async function waitForGoogleMaps(timeoutMs=15000){
      const start=performance.now();
      while(performance.now()-start<timeoutMs){
        if(window.google&&google.maps&&google.maps.importLibrary)return true;
        await new Promise(r=>setTimeout(r,50));
      }
      throw new Error("Google Maps loader timeout");
    }

    function getFirstFix(opts={enableHighAccuracy:true,timeout:15000,maximumAge:0}){
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation){
          reject(new Error("Geolocation unsupported"));
          return;
        }
        navigator.geolocation.getCurrentPosition(resolve,reject,opts);
      });
    }

    async function initMap(position){
      const [{Map},{AdvancedMarkerElement}] = await Promise.all([
        google.maps.importLibrary("maps"),
        google.maps.importLibrary("marker"),
      ]);

      const p = { lat: position.coords.latitude, lng: position.coords.longitude };
      const mapEl = document.getElementById("map");
      const map = new Map(mapEl, {
        center: p,
        zoom: 16,
        disableDefaultUI: true,
        clickableIcons: true,
        heading: 0,
        tilt: 0,
      });

      const marker = new AdvancedMarkerElement({ map, position: p });
      mapEl.style.display = "block";

      navigator.geolocation.watchPosition(pos=>{
        const np = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        marker.position = np;
        map.panTo(np);
      }, ()=>{}, { enableHighAccuracy:true, maximumAge:0, timeout:15000 });
    }

    (async function main(){
      try{
        await waitForGoogleMaps();
        const pos = await getFirstFix();
        await initMap(pos);
      }catch(e){
        console.error("Location or map initialization failed:", e);
        // No fallback, no UI. Map remains hidden.
      }
    })();
  </script>

  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAC8S1q0X9qaUz08kZiGFxkcwmdTi-_hlo&v=weekly&language=ja&region=JP&loading=async"></script>
</body>
</html>