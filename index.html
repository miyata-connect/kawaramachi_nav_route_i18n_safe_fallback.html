<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
      --btnbg: rgba(80,88,98,.45);
      --btnfg: #ffffff;
      --phSize:16px;
      --phMin:11px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* top panel centered */
    .overlay{
      position:absolute;
      left:0; right:0; top:12px; z-index:5;
      width:min(980px, calc(100% - 24px));
      margin:0 auto;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px)
    }
    .overlay h2{margin:0 0 10px 0;font-weight:700;font-size:clamp(16px,2.6vw,22px);letter-spacing:.3px;text-align:center}
    .grid{
      display:grid;
      grid-template-columns: 1fr auto auto auto; /* input | radius | mic | search */
      gap:10px;align-items:center
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}

    .input-wrap input[type="text"]{
      width:100%;height:46px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);padding:0 14px;font-size:16px;outline:none
    }
    .input-wrap input::placeholder{
      font-size:var(--phSize);
      white-space:nowrap;
    }
    select{
      height:46px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(0,0,0,.25);color:var(--text);padding:0 12px;font-size:15px
    }
    .btn{
      height:46px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.1);color:var(--text);padding:0 16px;font-weight:700;cursor:pointer
    }
    .btn:active{transform:translateY(1px)}
    .btn-mic{
      width:46px;height:46px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.12);display:grid;place-items:center;cursor:pointer;font-weight:700
    }
    .check{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:10px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);user-select:none
    }

    /* coord center */
    .coord{
      margin-top:10px;
      font-variant-numeric:tabular-nums;
      color:var(--muted);
      display:flex;justify-content:center;align-items:center;
      gap:10px;white-space:nowrap;
      font-size:clamp(12px,2.1vw,15px);
      text-align:center;
    }
    .coord span{display:inline-block;}

    /* bottom sheet */
    .sheet{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:4;
      background:var(--glass);border:1px solid var(--stroke);border-radius:16px;
      backdrop-filter:blur(6px);max-height:46vh;overflow:auto;display:none;
    }
    .sheet-header{padding:14px 16px;border-bottom:1px solid var(--stroke);font-weight:700;display:flex;justify-content:space-between;align-items:center;font-size:15px}
    .item{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid var(--stroke);cursor:pointer}
    .item:last-child{border-bottom:none}
    .meta{color:var(--muted);font-size:13px;margin-top:4px}
    .go{min-width:70px;height:38px;border-radius:10px;border:1px solid var(--stroke);background:rgba(255,255,255,.1);color:var(--text);font-weight:700;cursor:pointer}

    /* right side buttons (glass gray, Japanese) */
    .side{
      position:absolute;right:12px;top:50%;transform:translateY(-50%);
      display:flex;flex-direction:column;gap:12px;z-index:3;
    }
    .sbtn{
      width:72px;height:72px;border-radius:18px;
      border:1px solid rgba(255,255,255,.2);
      background:linear-gradient(145deg,rgba(80,80,90,.45),rgba(30,30,40,.35));
      color:var(--btnfg);font-weight:700;font-size:15px;
      display:flex;align-items:center;justify-content:center;
      box-shadow:0 4px 14px rgba(0,0,0,.3);
      backdrop-filter:blur(6px);
      cursor:pointer;user-select:none;
    }
    .sbtn:active{transform:scale(.96);}

    .toast{position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:7;text-align:center}
    .toast.ok{background:var(--ok)}

    .blackout{position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:6;color:#fff;text-align:center;padding:24px}
    .blackout .box{max-width:min(680px,90vw);border:1px solid rgba(255,255,255,.18);border-radius:16px;background:rgba(255,255,255,.06);padding:18px 16px;font-size:16px;line-height:1.7}
    .hidden{display:none !important}

    /* ripple marker */
    .pin-wrap{position:relative;width:34px;height:34px;display:grid;place-items:center;transform:translate(-50%,-100%)}
    .pin{width:26px;height:26px;border-radius:50%;background:#ff4949;border:3px solid #fff;box-shadow:0 6px 14px rgba(0,0,0,.35)}
    .ripple{position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);width:18px;height:6px;border-radius:50%;background:rgba(0,0,0,.25);filter:blur(1px)}
    .wave{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:40px;height:40px;border:2px solid rgba(255,73,73,.55);border-radius:50%;animation:wave 1.8s ease-out infinite;}
    .wave.wave2{animation-delay:.45s}
    .wave.wave3{animation-delay:.9s}
    @keyframes wave{
      0%{opacity:.55;transform:translate(-50%,-50%) scale(.35)}
      70%{opacity:.08}
      100%{opacity:0;transform:translate(-50%,-50%) scale(1.25)}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <div id="blackout" class="blackout"><div class="box" id="blackout-text"></div></div>

    <div id="panel" class="overlay">
      <h2 id="panel-title"></h2>

      <div class="grid">
        <div class="input-wrap">
          <input id="q" type="text" autocomplete="off" />
        </div>

        <select id="radius">
          <option value="10000">10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>

        <button id="btn-mic" class="btn-mic" title="Èü≥Â£∞">üéô</button>
        <button id="btn-search" class="btn" title="Ê§úÁ¥¢">Ê§úÁ¥¢</button>
      </div>

      <div class="row" style="margin-top:10px">
        <label class="check"><input id="use-center" type="checkbox" /> <span id="use-center-label"></span></label>
        <label class="check"><input id="open-now" type="checkbox" /> <span id="open-now-label"></span></label>
        <label class="check"><input id="top-rated" type="checkbox" /> <span id="top-rated-label"></span></label>
        <label class="check"><input id="has-photo" type="checkbox" /> <span id="has-photo-label"></span></label>
      </div>

      <div class="coord">
        <span id="coord-tail"></span><span id="coord"></span>
      </div>
    </div>

    <div id="sheet" class="sheet">
      <div class="sheet-header">
        <span id="sheet-title"></span>
        <button id="sheet-close" class="btn" style="height:34px;padding:0 10px">√ó</button>
      </div>
      <div id="sheet-body"></div>
    </div>

    <div class="side">
      <div id="btn-current" class="sbtn">ÁèæÂú®Âú∞</div>
      <div id="btn-voice" class="sbtn">Èü≥Â£∞</div>
      <div id="btn-stop" class="sbtn">ÂÅúÊ≠¢</div>
      <div id="btn-reroute" class="sbtn">ÂÜçÊé¢Á¥¢</div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Google Maps JS API loader (browser key) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    /* ---------- Text (JP) ---------- */
    const JA={
      title:(km)=>`Ëøë„Åè„ÇíÊ§úÁ¥¢Ôºà${km} km / 5‰ª∂Ôºâ`,
      placeholder:"Â∫óËàó Âêç„ÉªÈõªË©±Áï™Âè∑„Éª„Ç´„ÉÜ„Ç¥„É™„Éª‰ΩèÊâÄ„ÉªÂ∫ßÊ®ô„ÉªÊñΩË®≠ Âêç",
      search:"Ê§úÁ¥¢",
      useCenter:"‰ªªÊÑè„ÅÆÂ†¥ÊâÄ„ÇíÊ§úÁ¥¢",
      openNow:"Âñ∂Ê•≠‰∏≠",topRated:"È´ò„É¨„Éì„É•„ÉºÈ†Ü",hasPhoto:"ÁîªÂÉè„ÅÇ„Çä",
      lat:"Á∑ØÂ∫¶",lng:"ÁµåÂ∫¶",currentTail:"ÁèæÂú®Âú∞Ôºö",
      toastEnter:"Ê§úÁ¥¢„Åó„Åü„ÅÑÊñáÂ≠ó„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      toastCenterHint:"Âú∞Âõ≥„ÇíÈï∑Êäº„Åó„Åó„Å¶Ê§úÁ¥¢Âú∞ÁÇπ„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ",
      toastCenterDone:"Âú∞Âõ≥‰∏≠ÂøÉÔºà‰ªªÊÑèÂú∞ÁÇπÔºâ„ÇíÂü∫Ê∫ñ„Å´Ê§úÁ¥¢„Åó„Åæ„Åô„ÄÇ",
      loading:"ÁèæÂú®Âú∞ÂèñÂæó‰∏≠„Åß„Åô„ÄÇ„ÅîËø∑ÊÉë„Çí„ÅäÊéõ„Åë„Åó„Åæ„Åô„ÄÇÁèæÂú®Âú∞Ë°®Á§∫„Åæ„Åß30ÁßíÁ®ã„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ",
      timeout:"ÁèæÂú®Âú∞„ÇíÂèñÂæóÂá∫Êù•„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇÂ±ãÂ§ñ„ÇÑÁ©∫„ÅåÈñã„Åë„ÅüÂ†¥ÊâÄ„ÅßÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"
    };

    /* ---------- helpers ---------- */
    const el=id=>document.getElementById(id);
    const toastEl=el("toast");
    const showToast=(msg,ok=false)=>{
      toastEl.textContent=msg;
      toastEl.style.background=ok?"#25d07a":"#ff6565";
      toastEl.style.display="block";
      clearTimeout(toastEl._t);
      toastEl._t=setTimeout(()=>toastEl.style.display="none",3000);
    };

    /* ---------- wire UI text ---------- */
    const q=el("q"),radiusSel=el("radius"),btnSearch=el("btn-search"),useCenter=el("use-center");
    const openNow=el("open-now"),topRated=el("top-rated"),hasPhoto=el("has-photo");
    const coord=el("coord"),coordTail=el("coord-tail"),panelTitle=el("panel-title");
    const btnMic=el("btn-mic"),btnVoiceSide=el("btn-voice");
    q.placeholder=JA.placeholder;btnSearch.textContent=JA.search;
    el("use-center-label").textContent=JA.useCenter;
    el("open-now-label").textContent=JA.openNow;
    el("top-rated-label").textContent=JA.topRated;
    el("has-photo-label").textContent=JA.hasPhoto;
    coordTail.textContent=JA.currentTail;
    const refreshTitle=()=>{const km=radiusSel.options[radiusSel.selectedIndex].text.replace("km","").trim();panelTitle.textContent=JA.title(km);};
    refreshTitle();radiusSel.addEventListener("change",refreshTitle);

    /* ---------- blackout (initial locate) ---------- */
    const blackout=el("blackout"),blackoutText=el("blackout-text");
    blackoutText.textContent=JA.loading;

    /* ---------- Maps ---------- */
    const PROXY_BASE="https://ors-proxy.miyata-connect-jp.workers.dev";
    let map,currentPos=null,currentMarker=null,destPolyline=null,customCenter=null,centerMarker=null;

    function buildRipple(){
      const wrap=document.createElement("div");wrap.className="pin-wrap";
      const p=document.createElement("div");p.className="pin";
      const r=document.createElement("div");r.className="ripple";
      const w1=document.createElement("div");w1.className="wave";
      const w2=document.createElement("div");w2.className="wave wave2";
      const w3=document.createElement("div");w3.className="wave wave3";
      wrap.append(w1,w2,w3,p,r);return wrap;
    }

    async function getLoc(){
      return new Promise((res,rej)=>{
        if(!navigator.geolocation) return rej(new Error("Geolocation unsupported"));
        navigator.geolocation.getCurrentPosition(
          p=>res({lat:p.coords.latitude,lng:p.coords.longitude}),
          e=>rej(e),{enableHighAccuracy:true,timeout:30000});
      });
    }

    async function init(){
      await new Promise(r=>setTimeout(r,60));
      const {Map}=await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement}=await google.maps.importLibrary("marker");

      let pos;
      try{ pos=await Promise.race([getLoc(), new Promise((_,rej)=>setTimeout(()=>rej(new Error("timeout")),30000))]); }
      catch{ /* keep undefined */ }

      currentPos=pos||{lat:35.681236,lng:139.767125};
      map=new Map(el("map"),{center:currentPos,zoom:16,disableDefaultUI:true});
      currentMarker=new AdvancedMarkerElement({map,position:currentPos,content:buildRipple()});
      blackout.classList.add("hidden");
      coord.textContent=`${JA.lat}:${currentPos.lat.toFixed(6)} / ${JA.lng}:${currentPos.lng.toFixed(6)}`;
      if(!pos) showToast(JA.timeout);

      // Long press to pick a custom point
      let pressTimer=null;
      map.addListener("mousedown", e=>{
        if(!useCenter.checked) return;
        pressTimer=setTimeout(()=>setCustomCenter(e.latLng),600);
      });
      map.addListener("mouseup", ()=> pressTimer && clearTimeout(pressTimer));
      map.addListener("dragstart", ()=> pressTimer && clearTimeout(pressTimer));

      function setCustomCenter(latLng){
        customCenter={lat:latLng.lat(),lng:latLng.lng()};
        if(centerMarker){centerMarker.map=null;}
        centerMarker=new AdvancedMarkerElement({map,position:customCenter,content:buildRipple()});
        map.panTo(customCenter);
        showToast(JA.toastCenterDone,true);
      }
    }
    init();

    /* ---------- voice search (panel & side) ---------- */
    function startVoice(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR){ showToast("Èü≥Â£∞Ë™çË≠ò„Å´Êú™ÂØæÂøú„ÅÆ„Éñ„É©„Ç¶„Ç∂„Åß„Åô"); return; }
      const rec=new SR();
      rec.lang="ja-JP"; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult=(ev)=>{ const text=ev.results[0][0].transcript; q.value=text; showToast("Èü≥Â£∞„ÇíË™çË≠ò„Åó„Åæ„Åó„Åü: "+text,true); };
      rec.onerror=()=>showToast("Èü≥Â£∞Ë™çË≠ò„Ç®„É©„Éº");
      rec.start();
    }
    btnMic.addEventListener("click", startVoice);
    btnVoiceSide.addEventListener("click", startVoice);

    /* ---------- simple search wire (UI only) ---------- */
    btnSearch.addEventListener("click", async ()=>{
      if(!q.value.trim()) return showToast(JA.toastEnter);
      if(useCenter.checked && !customCenter){ showToast(JA.toastCenterHint); }

      const center = useCenter.checked && customCenter ? customCenter : (useCenter.checked ? map.getCenter().toJSON() : currentPos);
      const radius = Number(radiusSel.value);

      // show what we're doing (UI demo)
      el("sheet-title").textContent = `Ê§úÁ¥¢ÁµêÊûúÔºàÂçäÂæÑ ${(radius/1000)|0} kmÔºâ`;
      const body=el("sheet-body");
      body.innerHTML = "";
      el("sheet").style.display="block";
      showToast(JA.search,true);

      // NOTE: ÂÆüÈÅãÁî®„Åß„ÅØ‰∏ãË®ò fetch „ÇíÊúâÂäπ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàPlaces API proxyÔºâ
      // try{
      //   const resp = await fetch(`${PROXY_BASE}/places:searchText`,{
      //     method:"POST",
      //     headers:{"Content-Type":"application/json","Origin":location.origin},
      //     body:JSON.stringify({
      //       textQuery:q.value.trim(),
      //       languageCode:"ja",
      //       regionCode:"JP",
      //       pageSize:5,
      //       locationBias:{ circle:{ center, radius } },
      //       openNow: !!openNow.checked
      //     })
      //   });
      //   const data = await resp.json();
      //   renderResults(data.places||[], center);
      // }catch(e){ showToast("Ê§úÁ¥¢„Ç®„É©„Éº"); }
      renderResults([], center); // „ÉÄ„Éü„ÉºÊèèÁîªÔºàUIÂãï‰ΩúÁ∂≠ÊåÅÔºâ
    });

    function renderResults(places, center){
      const body=el("sheet-body");
      if(!places.length){
        // Á©∫„Åß„ÇÇ UI ÂΩ¢Áä∂„ÇíÁ∂≠ÊåÅ
        const div=document.createElement("div");
        div.className="item"; div.innerHTML=`<div><div>Ê§úÁ¥¢ÂÆüË°å</div><div class="meta">‰ªªÊÑèÂú∞ÁÇπÔºèÁèæÂú®Âú∞„ÇíÂü∫Ê∫ñ„Å´Ê§úÁ¥¢„Åó„Åæ„Åó„Åü</div></div>`;
        const btn=document.createElement("button"); btn.className="go"; btn.textContent="OK";
        btn.onclick=()=>{ el("sheet").style.display="none"; };
        div.append(btn); body.append(div);
        return;
      }
      places.forEach(p=>{
        const div=document.createElement("div");
        div.className="item";
        const name=p.displayName?.text||"(ÂêçÁß∞‰∏çÊòé)";
        const addr=p.formattedAddress||"";
        div.innerHTML=`<div><div>${name}</div><div class="meta">${addr}</div></div>`;
        const btn=document.createElement("button"); btn.className="go"; btn.textContent="Go";
        btn.onclick=()=>{ el("sheet").style.display="none"; };
        div.onclick=btn.onclick;
        div.append(btn); body.append(div);
      });
    }

    el("sheet-close").addEventListener("click", ()=>el("sheet").style.display="none");

    /* ---------- side buttons ---------- */
    el("btn-current").addEventListener("click", async ()=>{
      try{
        const p=await getLoc();
        map.panTo(p); currentPos=p;
        coord.textContent=`${JA.lat}:${p.lat.toFixed(6)} / ${JA.lng}:${p.lng.toFixed(6)}`;
        showToast("ÁèæÂú®Âú∞„Å∏ÁßªÂãï",true);
      }catch{ showToast("‰ΩçÁΩÆÊÉÖÂ†±„Ç®„É©„Éº"); }
    });
    el("btn-stop").addEventListener("click", ()=>{
      if(destPolyline){ destPolyline.setMap(null); destPolyline=null; }
      showToast("Ê°àÂÜÖÂÅúÊ≠¢",true);
    });
    el("btn-reroute").addEventListener("click", ()=>showToast("ÂÜçÊé¢Á¥¢„Åó„Åæ„Åó„Åü",true));

    /* ---------- use-center hint ---------- */
    useCenter.addEventListener("change", ()=>{
      if(useCenter.checked){ showToast(JA.toastCenterHint); }
      else { customCenter=null; if(centerMarker){centerMarker.map=null; centerMarker=null;} }
    });

    /* ---------- initial title ---------- */
    function setPanelTitleByRadius(){
      const km = radiusSel.options[radiusSel.selectedIndex].text.replace("km","").trim();
      panelTitle.textContent = JA.title(km);
    }
    setPanelTitleByRadius();
  </script>
</body>
</html>