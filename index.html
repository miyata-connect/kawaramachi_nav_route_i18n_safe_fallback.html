<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    /* ===== Design rollback: Glass UI (no functional changes) ===== */
    :root{
      --bg:#0a1321;
      --glass: rgba(20,28,44,.70);
      --glass-strong: rgba(16,22,36,.85);
      --stroke: rgba(255,255,255,.14);
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --radius:16px;
      --radius-lg:20px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}

    /* Top search panel (glass card) */
    .panel{
      position:absolute;left:16px;right:16px;top:16px;z-index:6;
      background:var(--glass);backdrop-filter:blur(8px);
      border:1px solid var(--stroke);border-radius:var(--radius-lg);
      box-shadow:var(--shadow);padding:16px 16px 14px;
    }
    .panel-title{
      font-weight:800;margin:0 0 10px 0;font-size:20px;letter-spacing:.2px
    }
    .row{display:flex;gap:12px;align-items:center}
    .row.wrap{flex-wrap:wrap}
    .input{
      flex:1;min-width:180px;height:44px;padding:0 14px;border-radius:12px;
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);
      outline:none
    }
    .input::placeholder{color:#ced8e6;opacity:.7}
    .select{
      height:44px;padding:0 12px;border-radius:12px;min-width:112px;
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text)
    }
    .btn{
      height:44px;min-width:96px;padding:0 16px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.10);color:var(--text);cursor:pointer;
      box-shadow:var(--shadow)
    }
    .btn:hover{background:rgba(255,255,255,.14)}
    .chip{
      height:40px;display:inline-flex;align-items:center;gap:10px;padding:0 14px;border-radius:999px;
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text)
    }
    .chip input{width:18px;height:18px}

    .coords{
      margin-top:12px;text-align:left;font-variant-numeric:tabular-nums;color:var(--muted);
      font-size:13px
    }

    /* Right-side action buttons (glass stack) */
    .actions{
      position:absolute;right:12px;top:140px;z-index:5;display:flex;flex-direction:column;gap:12px
    }
    .fab{
      width:72px;height:72px;border-radius:22px;border:1px solid var(--stroke);
      background:var(--glass-strong);backdrop-filter:blur(8px);color:var(--text);
      display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);
    }

    /* Bottom sheet for results (glass) */
    .sheet{
      position:absolute;left:12px;right:12px;bottom:12px;z-index:6;display:none;
      background:var(--glass-strong);border:1px solid var(--stroke);border-radius:18px;box-shadow:var(--shadow)
    }
    .sheet-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
    .sheet-title{font-weight:700}
    .list{max-height:52vh;overflow:auto;padding:8px 0}
    .item{padding:14px 16px;border-top:1px solid var(--stroke);display:flex;gap:12px;align-items:center}
    .item:first-child{border-top:none}
    .item-main{flex:1}
    .item-title{font-weight:700;margin-bottom:2px}
    .item-sub{color:var(--muted);font-size:13px}
    .go{min-width:72px;height:40px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.10);color:var(--text)}

    /* Toast */
    .toast{
      position:absolute;left:12px;right:12px;bottom:12px;padding:14px 16px;border-radius:12px;
      border:0;display:none;z-index:20;color:#fff;box-shadow:var(--shadow)
    }

    /* Loading (black screen with message) */
    .loading{
      position:absolute;inset:0;background:#000;display:none;align-items:flex-end;justify-content:center;z-index:50
    }
    .loading .msg{
      margin-bottom:18vh;background:rgba(255,255,255,.08);border:1px solid var(--stroke);
      color:var(--text);padding:14px 16px;border-radius:12px
    }

    /* Current marker ripple (dynamic) */
    .pulse-wrap{position:absolute;transform:translate(-50%,-50%);pointer-events:none}
    .pulse-dot{width:16px;height:16px;background:#ff4d4d;border-radius:999px;border:2px solid #fff}
    .pulse{
      position:absolute;left:50%;top:50%;width:16px;height:16px;border-radius:999px;border:2px solid rgba(255,77,77,.7);
      transform:translate(-50%,-50%);animation:pulse 2s infinite
    }
    @keyframes pulse{
      0%{opacity:.8;transform:translate(-50%,-50%) scale(1)}
      70%{opacity:0;transform:translate(-50%,-50%) scale(3.2)}
      100%{opacity:0}
    }

    @media (max-width:480px){
      .btn{min-width:86px}
      .fab{width:68px;height:68px}
      .panel-title{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <!-- Loading overlay -->
    <div id="loading" class="loading">
      <div class="msg">現在地取得中です。ご迷惑をお掛けします。現在地表示まで30秒程お待ちください。</div>
    </div>

    <!-- Top search panel (design rollback) -->
    <section class="panel" id="search-panel" aria-label="search">
      <h3 class="panel-title" id="panel-title">近くを検索（<span id="hdr-radius">10km</span> / <span id="hdr-count">5件</span>）</h3>
      <div class="row">
        <input id="q" class="input" type="text"
               placeholder="店舗名・電話番号・カテゴリ・住所・座標・施設名" />
        <select id="radius" class="select" aria-label="radius">
          <option value="5000">5km</option>
          <option value="10000" selected>10km</option>
          <option value="20000">20km</option>
          <option value="30000">30km</option>
        </select>
        <button id="btn-search" class="btn">検索</button>
      </div>
      <div class="row wrap" style="margin-top:10px">
        <label class="chip"><input id="use-center" type="checkbox" /> 任意の場所を検索</label>
        <label class="chip"><input id="open-now" type="checkbox" /> 営業中</label>
        <label class="chip"><input id="by-rating" type="checkbox" /> 高レビュー順</label>
        <label class="chip"><input id="with-photo" type="checkbox" /> 画像あり</label>
        <button id="btn-voice" class="chip" title="音声検索">🎤 音声</button>
      </div>
      <div class="coords" id="coord-line">現在地： 緯度: -- / 経度: --</div>
    </section>

    <!-- Right-side actions -->
    <div class="actions">
      <button id="act-current" class="fab">現在地</button>
      <button id="act-stop" class="fab">停止</button>
      <button id="act-reroute" class="fab">再探索</button>
    </div>

    <!-- Bottom results sheet -->
    <div id="sheet" class="sheet" role="dialog" aria-modal="false">
      <div class="sheet-header">
        <div class="sheet-title" id="sheet-title">検索結果</div>
        <button id="sheet-close" class="btn" style="height:36px;min-width:72px">閉じる</button>
      </div>
      <div id="list" class="list"></div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Google Maps loader (maps + marker only). No JS Places. -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <script>
    /* === Functionality preserved. Only the CSS above was rolled back. === */

    // ----- Utilities -----
    const $ = (id)=>document.getElementById(id);
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    const toast = (msg, ok=false)=>{
      const el=$("toast");
      el.style.background = ok ? "#25d07a" : "#ff6565";
      el.textContent = msg; el.style.display = "block";
      clearTimeout(el._t); el._t=setTimeout(()=>el.style.display="none",3000);
    };
    const showSheet = (on)=>{ $("sheet").style.display = on ? "block":"none"; };
    const setHdr = ()=>{ $("hdr-radius").textContent = (Number($("radius").value)/1000)+"km"; };

    // ----- Maps -----
    let map, currentMarker, pulseDiv, marker, dirSvc, dirRenderer;
    let currentPos = null;
    let centerSelectMode = false;

    async function waitMaps(timeout=15000){
      const t0=performance.now();
      while(performance.now()-t0<timeout){
        if (window.google && google.maps && google.maps.importLibrary) return;
        await sleep(50);
      }
      throw new Error("Google Maps failed to load");
    }

    function setCoordLine(pos){
      $("coord-line").textContent = `現在地： 緯度: ${pos.lat.toFixed(6)} / 経度: ${pos.lng.toFixed(6)}`;
    }

    function mountPulseMarker(){
      pulseDiv = document.createElement("div");
      pulseDiv.className="pulse-wrap";
      pulseDiv.innerHTML = `<div class="pulse"></div><div class="pulse-dot"></div>`;
      currentMarker = new google.maps.marker.AdvancedMarkerElement({ map, position: currentPos, content:pulseDiv });
    }

    async function getGeolocationOnce(signal){
      return new Promise((resolve,reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation unsupported"));
        navigator.geolocation.getCurrentPosition(
          p=>resolve({lat:p.coords.latitude,lng:p.coords.longitude}),
          e=>reject(new Error(e.message||"位置情報エラー")),
          { enableHighAccuracy:true, timeout:30000, maximumAge:0 }
        );
      });
    }

    async function acquireLocationWithTimeout(){
      $("loading").style.display="flex";
      try{
        const ctl = new AbortController();
        const t = setTimeout(()=>ctl.abort(), 30000);
        const pos = await getGeolocationOnce(ctl.signal);
        clearTimeout(t);
        return pos;
      }catch(e){
        return null;
      }finally{
        $("loading").style.display="none";
      }
    }

    async function init(){
      setHdr();
      await waitMaps();
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      dirSvc = new google.maps.DirectionsService();
      dirRenderer = new google.maps.DirectionsRenderer({ suppressMarkers:true });

      // Fallback (Tokyo) until real position
      currentPos = { lat: 35.681236, lng: 139.767125 };

      map = new Map($("map"),{
        center: currentPos, zoom:16, mapId:"WALKNAV_MAP",
        disableDefaultUI:true
      });
      dirRenderer.setMap(map);

      // Current marker (pulse)
      mountPulseMarker();
      setCoordLine(currentPos);

      // Try 30s acquisition (auto-show if obtained; else message)
      const real = await acquireLocationWithTimeout();
      if(real){
        currentPos = real;
        map.setCenter(real);
        currentMarker.position = real;
        setCoordLine(real);
        toast("現在地を取得しました", true);
      }else{
        toast("現在地を取得出来ませんでした。屋外に出るか空が開けた場所へ移動してください。");
      }

      wireUI();
    }

    // ----- Worker (Places API New via HTTPS only) -----
    const WORKER_BASE = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";

    async function searchPlaces(){
      const text = $("q").value.trim();
      if(!text){ toast("検索したい文字を入力してください。"); return; }

      const useCenter = $("use-center").checked;
      const openNow = $("open-now").checked;
      const byRating= $("by-rating").checked;
      const withPhoto=$("with-photo").checked;
      const radius = Number($("radius").value);

      // Center for bias / restriction
      let center = useCenter ? map.getCenter().toJSON() : currentPos;

      const body = {
        textQuery: text,
        languageCode: "ja",
        regionCode: "JP",
        pageSize: 5,
        locationBias: { circle:{ center:{ latitude:center.lat, longitude:center.lng }, radius } },
        openNow: openNow || undefined,
        includedType: undefined
      };

      try{
        const res = await fetch(`${WORKER_BASE}/places:searchText`,{
          method:"POST",
          headers:{ "Content-Type":"application/json", "Origin": location.origin },
          body: JSON.stringify(body)
        });
        if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
        const data = await res.json();
        const places = (data.places||[])
          .filter(p=>withPhoto ? (p.photos?.length) : true)
          .sort((a,b)=> byRating ? ((b.rating||0)-(a.rating||0)) : 0);

        renderResults(places.slice(0,5), center);
        $("hdr-count").textContent = `${Math.min(5,places.length)}件`;
        showSheet(true);
      }catch(e){
        toast(`検索エラー: ${e.message}`);
      }
    }

    function renderResults(places, origin){
      const list = $("list"); list.innerHTML = "";
      if(!marker){
        marker = new google.maps.marker.AdvancedMarkerElement({ map, position: origin });
      }
      places.forEach((p,idx)=>{
        const li = document.createElement("div");
        li.className="item";
        const dist = haversine(origin,{lat:p.location.latitude,lng:p.location.longitude});
        li.innerHTML = `
          <div class="item-main">
            <div class="item-title">${escapeHtml(p.displayName?.text||"(名称未取得)")}</div>
            <div class="item-sub">${dist.toFixed(2)} km ・ ${escapeHtml(p.formattedAddress||"")} ${p.rating?`・ ★${p.rating}`:""}</div>
          </div>
          <button class="go">Go</button>
        `;
        li.querySelector(".go").onclick = ()=>startRoute(origin, { lat:p.location.latitude, lng:p.location.longitude }, p.displayName?.text);
        li.onclick = (ev)=>{ if(!ev.target.classList.contains("go")) li.querySelector(".go").click(); };
        list.appendChild(li);
      });
      $("sheet-title").textContent = `検索結果（${$("hdr-radius").textContent} / ${$("hdr-count").textContent}）`;
      // results panel shows from bottom; panel stays on top; no overlap with actions.
    }

    function startRoute(origin, dest, label){
      showSheet(false);
      dirRenderer.setDirections({ routes:[] });
      dirSvc.route({
        origin, destination: dest, travelMode: google.maps.TravelMode.WALKING
      }, (res, status)=>{
        if(status === google.maps.DirectionsStatus.OK){
          dirRenderer.setDirections(res);
          map.setCenter(dest);
          marker.position = dest;
          toast("ルート案内準備中", true);
        }else{
          toast(`経路取得エラー: ${status}`);
        }
      });
    }

    // ----- UI wiring -----
    function wireUI(){
      $("btn-search").onclick = searchPlaces;
      $("radius").onchange = ()=>{ setHdr(); };
      $("sheet-close").onclick = ()=>showSheet(false);

      $("act-current").onclick = async ()=>{
        try{
          const pos = await getGeolocationOnce();
          currentPos = pos; map.setCenter(pos);
          currentMarker.position = pos; setCoordLine(pos);
          toast("現在地へ移動", true);
        }catch(e){ toast("位置情報を取得できません"); }
      };
      $("act-reroute").onclick = ()=>{ if(marker?.position){ startRoute(currentPos, marker.position, ""); } };
      $("act-stop").onclick = ()=>{ dirRenderer.setDirections({routes:[]}); toast("案内を停止しました", true); };

      // 任意地点検索ガイド
      $("use-center").addEventListener("change",(e)=>{
        centerSelectMode = e.target.checked;
        if(centerSelectMode){
          toast("地図上で長押しして検索中心を指定できます。", true);
          const listener = map.addListener("longpress" in map ? "longpress" : "click", (ev)=>{
            map.setCenter(ev.latLng); marker.position = ev.latLng.toJSON();
          });
          $("use-center")._listener = listener;
        }else{
          if($("use-center")._listener){ google.maps.event.removeListener($("use-center")._listener); $("use-center")._listener=null; }
          if(currentPos){ map.setCenter(currentPos); if(marker) marker.position=currentPos; }
        }
      });

      // 音声検索（Web Speech API）
      $("btn-voice").onclick = ()=>{
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR){ toast("音声認識は未対応です"); return; }
        const rec = new SR(); rec.lang="ja-JP"; rec.interimResults=false; rec.maxAlternatives=1;
        rec.onresult = (e)=>{ $("q").value = e.results[0][0].transcript; searchPlaces(); };
        rec.onerror = ()=>toast("音声認識エラー");
        rec.start();
      };
    }

    // helpers
    function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function haversine(a,b){
      const R=6371, toRad=(d)=>d*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLng=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    }

    init();
  </script>
</body>
</html>