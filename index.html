<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v4</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}

/* æ“ä½œãƒ‘ãƒãƒ« */
.control-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:0;
  z-index:500;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:16px 16px 0 0;
  backdrop-filter:blur(14px);
  padding:16px;
  transition:transform 0.3s;
}
.control-panel.hidden{transform:translateY(100%)}
.panel-toggle{
  position:fixed;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  border:none;
  border-radius:12px;
  padding:14px 40px;
  color:#fff;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  z-index:490;
  display:none;
  box-shadow:0 4px 12px rgba(0,0,0,.3);
}
.panel-toggle.show{display:block}
.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.panel-btn{
  flex:1;
  min-width:120px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  padding:10px;
  color:var(--text);
  font-size:14px;
  text-align:center;
  cursor:pointer;
}
.panel-btn.primary{background:var(--primary);border:none}
.panel-btn.recording{background:var(--danger);border:none}
input,select{
  width:100%;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  color:var(--text);
  border-radius:10px;
  padding:10px;
  font-size:14px;
}

/* çµ±åˆæƒ…å ±ãƒ‘ãƒãƒ« */
.info-panel{
  position:absolute;
  left:10px;
  right:80px;
  top:10px;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  backdrop-filter:blur(14px);
  padding:14px 14px 18px 14px;
  z-index:460;
  color:var(--text);
  display:none;
}
.info-panel.show{display:block}
.route-main{
  font-size:18px;
  font-weight:700;
  margin-bottom:10px;
  line-height:1.4;
  text-align:center;
}
.route-time{
  font-size:16px;
  color:var(--text);
  display:flex;
  gap:20px;
  font-weight:600;
  margin-bottom:12px;
  justify-content:center;
}
.route-time span{
  display:flex;
  align-items:center;
  gap:4px;
}
.weather-row{
  display:flex;
  align-items:center;
  gap:10px;
}
.location-name{
  font-size:16px;
  font-weight:700;
  color:var(--primary);
  white-space:nowrap;
}
.weather-items{
  display:flex;
  gap:4px;
  flex:1;
  justify-content:center;
  align-items:center;
}
.weather-arrow{
  color:var(--muted);
  font-size:18px;
  font-weight:900;
}
.weather-item{
  text-align:center;
  font-size:11px;
  color:var(--text);
  padding:6px 4px;
  background:var(--glass-strong);
  border-radius:8px;
  min-width:48px;
}
.weather-icon{font-size:20px;margin:2px 0}
.weather-temp{font-weight:700;font-size:13px}
.weather-rain{color:var(--accent);font-size:10px}

/* ãƒŠãƒ“ãƒœã‚¿ãƒ³ï¼ˆå³å´ç¸¦ä¸€åˆ—ï¼‰ */
.nav-buttons{
  position:absolute;
  right:10px;
  top:190px;
  z-index:450;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.nav-buttons.hidden{display:none}
.nav-btn{
  width:60px;
  height:60px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:10px;
  color:var(--text);
  font-size:11px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  font-weight:700;
  flex-direction:column;
  gap:2px;
}
.nav-btn.compass-btn{
  position:relative;
}
.compass-n{
  position:absolute;
  top:6px;
  font-size:10px;
  font-weight:700;
  color:var(--danger);
}
.nav-btn.primary{background:var(--primary);border:none}
.nav-btn.ok{background:var(--ok);border:none}
.nav-btn.danger{background:var(--danger);border:none}
.nav-btn.accent{background:var(--accent);border:none}
.nav-btn.active{background:var(--ok);border:2px solid #fff}

/* æ¤œç´¢çµæœ */
.results-panel{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  max-height:60vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z-index:480;
  display:none;
}
.result-item{
  padding:10px;
  border-bottom:1px solid var(--stroke);
  cursor:pointer;
}
.result-item:hover{background:rgba(95,177,255,.2)}
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

/* ç™»éŒ²åœ°ç‚¹ãƒ‘ãƒãƒ« */
.saved-points-panel{
  position:absolute;
  left:10px;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  max-height:70vh;
  overflow-y:auto;
  background:var(--glass);
  border:1px solid var(--stroke);
  border-radius:12px;
  padding:10px;
  z:index:490;
  display:none;
}
.saved-point-item{
  padding:12px;
  background:var(--glass-strong);
  border:1px solid var(--stroke);
  border-radius:8px;
  margin-bottom:8px;
  cursor:pointer;
  font-size:14px;
}
.saved-point-item:hover{background:rgba(95,177,255,.3)}
.saved-close{text-align:center;padding:10px;color:var(--primary);cursor:pointer;font-weight:700}

.error-banner{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  background:var(--danger);
  color:#fff;
  border-radius:10px;
  padding:10px;
  text-align:center;
  z-index:999;
}
.hidden{display:none}
.loading-screen{
  position:fixed;
  inset:0;
  background:#0e1a2d;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  transition:opacity 0.3s;
}
.loading-screen.hide{opacity:0;pointer-events:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    
    <!-- çµ±åˆæƒ…å ±ãƒ‘ãƒãƒ« -->
    <div id="infoPanel" class="info-panel show">
      <div class="route-main" id="routeText">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
      <div class="route-time">
        <span>ğŸ• ç¾åœ¨æ™‚åˆ»: <span id="currentTime">--:--</span></span>
        <span>ğŸ¯ åˆ°ç€äºˆæƒ³æ™‚åˆ»: <span id="arrivalTime">--:--</span></span>
      </div>
      <div class="weather-row">
        <div class="location-name" id="locationName">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="weather-items">
          <div class="weather-item">
            <div>3h</div>
            <div class="weather-icon" id="w3h">â˜€ï¸</div>
            <div class="weather-temp" id="t3h">--Â°</div>
            <div class="weather-rain" id="r3h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div>6h</div>
            <div class="weather-icon" id="w6h">â˜ï¸</div>
            <div class="weather-temp" id="t6h">--Â°</div>
            <div class="weather-rain" id="r6h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div>9h</div>
            <div class="weather-icon" id="w9h">ğŸŒ§ï¸</div>
            <div class="weather-temp" id="t9h">--Â°</div>
            <div class="weather-rain" id="r9h">--%</div>
          </div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item">
            <div>12h</div>
            <div class="weather-icon" id="w12h">â˜ï¸</div>
            <div class="weather-temp" id="t12h">--Â°</div>
            <div class="weather-rain" id="r12h">--%</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ãƒŠãƒ“ãƒœã‚¿ãƒ³ï¼ˆå³å´ç¸¦ä¸€åˆ—ï¼‰ -->
    <div id="navButtons" class="nav-buttons">
      <!-- æ–¹ä½è¨ˆ -->
      <div class="nav-btn compass-btn" id="compassBtn">
        <div class="compass-n">N</div>
        <svg width="40" height="40" viewBox="0 0 50 50" style="margin-top:8px">
          <path id="compassNeedle" d="M25 5 L27 25 L25 23 L23 25 Z" fill="#ff6565" stroke="#fff" stroke-width="1"/>
          <path d="M25 45 L27 25 L25 27 L23 25 Z" fill="#eaf2ff" stroke="#444" stroke-width="1"/>
          <circle cx="25" cy="25" r="2.5" fill="#5fb1ff" stroke="#fff" stroke-width="1.5"/>
        </svg>
      </div>
      
      <!-- N-UP -->
      <div class="nav-btn" id="nupBtn" onclick="setNorthUp()">N-UP</div>
      
      <!-- H-UP -->
      <div class="nav-btn active" id="hupBtn" onclick="setHeadingUp()">H-UP</div>
      
      <!-- ç¾åœ¨åœ° -->
      <div class="nav-btn primary" onclick="goToCurrent()">ç¾åœ¨åœ°</div>
      
      <!-- ç›®çš„åœ° -->
      <div class="nav-btn primary" onclick="goToDestination()">ç›®çš„åœ°</div>
      
      <!-- æ¡ˆå†…é–‹å§‹ -->
      <div class="nav-btn ok" onclick="startNav()">æ¡ˆå†…<br>é–‹å§‹</div>
      
      <!-- æ¡ˆå†…åœæ­¢ -->
      <div class="nav-btn danger" onclick="stopNav()">æ¡ˆå†…<br>åœæ­¢</div>
      
      <!-- ãƒªãƒ«ãƒ¼ãƒˆ -->
      <div class="nav-btn accent" onclick="reroute()">ãƒªãƒ«ãƒ¼ãƒˆ</div>
      
      <!-- éŸ³å£°æ¤œç´¢ -->
      <div class="nav-btn primary" id="quickVoiceBtn" onclick="quickVoiceSearch()">ğŸ¤</div>
    </div>
    
    <!-- æ“ä½œãƒ‘ãƒãƒ« -->
    <div id="controlPanel" class="control-panel hidden">
      <div style="text-align:center;font-size:15px;color:var(--text);font-weight:700;margin-bottom:12px;background:var(--glass-strong);padding:10px;border-radius:8px" id="coordsDisplay">
        ğŸ“ ç·¯åº¦: ---.------ / çµŒåº¦: ---.------
      </div>
      
      <input id="searchBox" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" style="margin-bottom:10px">
      
      <div class="panel-row">
        <div class="panel-btn primary" onclick="searchPlace()">æ¤œç´¢</div>
        <div class="panel-btn primary" id="voiceBtn" onclick="voiceSearch()">éŸ³å£°æ¤œç´¢</div>
        <div class="panel-btn" onclick="relocalize()">ç¾åœ¨åœ°</div>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="saveCurrentPoint()">ç¾åœ¨åœ°ã‚’ç™»éŒ²</div>
        <div class="panel-btn" onclick="saveMapPoint()">åœ°å›³ä¸Šã‚’ç™»éŒ²</div>
        <div class="panel-btn" onclick="showSavedPoints()">ç™»éŒ²åœ°ç‚¹</div>
      </div>
      
      <div class="panel-row">
        <select id="langSelect" onchange="changeLanguage()" style="flex:1">
          <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
          <option value="en">ğŸ‡ºğŸ‡¸ English</option>
          <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
          <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
          <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
          <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
          <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
          <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
        </select>
      </div>
      
      <div class="panel-row">
        <div class="panel-btn" onclick="togglePanel()" style="width:100%">æ“ä½œãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹</div>
      </div>
    </div>
    
    <!-- æ“ä½œãƒ‘ãƒãƒ«è¡¨ç¤ºã‚¿ãƒ– -->
    <div id="panelToggle" class="panel-toggle" onclick="togglePanel()">æ“ä½œãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º</div>
    
    <!-- æ¤œç´¢çµæœ -->
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()">é–‰ã˜ã‚‹</div>
    </div>
    
    <!-- ç™»éŒ²åœ°ç‚¹ãƒ‘ãƒãƒ« -->
    <div id="savedPointsPanel" class="saved-points-panel">
      <div id="savedPointsList"></div>
      <div class="saved-close" onclick="hideSavedPoints()">é–‰ã˜ã‚‹</div>
    </div>
    
    <div id="error" class="error-banner hidden"></div>
    <div id="loading" class="loading-screen">
      <div style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px">ç¾åœ¨åœ°å–å¾—ä¸­...</div>
        <div style="font-size:14px;color:var(--muted)">ã‚‚ã†ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</div>
      </div>
    </div>
  </div>
  
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=!1,currentLocation=null,savedPoints=[],selectingMapPoint=!1,stopAnnounced=!1,compassAlpha=0,targetAlpha=0,headingMode="heading",currentLang="ja";

const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/v1/places";

const translations={
  ja:{setDestination:"ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„",currentTime:"ç¾åœ¨æ™‚åˆ»",arrivalTime:"åˆ°ç€äºˆæƒ³æ™‚åˆ»",loading:"èª­ã¿è¾¼ã¿ä¸­..."},
  en:{setDestination:"Please set destination",currentTime:"Current",arrivalTime:"Arrival",loading:"Loading..."},
  ko:{setDestination:"ëª©ì ì§€ë¥¼ ì„¤ì •í•˜ì„¸ìš”",currentTime:"í˜„ì¬ ì‹œê°",arrivalTime:"ë„ì°© ì˜ˆì •",loading:"ë¡œë”© ì¤‘..."},
  zh:{setDestination:"è¯·è®¾ç½®ç›®çš„åœ°",currentTime:"å½“å‰æ—¶é—´",arrivalTime:"é¢„è®¡åˆ°è¾¾",loading:"åŠ è½½ä¸­..."},
  fr:{setDestination:"DÃ©finir la destination",currentTime:"Actuel",arrivalTime:"ArrivÃ©e",loading:"Chargement..."},
  it:{setDestination:"Imposta destinazione",currentTime:"Attuale",arrivalTime:"Arrivo",loading:"Caricamento..."},
  de:{setDestination:"Ziel festlegen",currentTime:"Aktuell",arrivalTime:"Ankunft",loading:"LÃ¤dt..."},
  es:{setDestination:"Establecer destino",currentTime:"Actual",arrivalTime:"Llegada",loading:"Cargando..."}
};

function changeLanguage(){
  currentLang=document.getElementById("langSelect").value;
  document.getElementById("routeText").textContent=translations[currentLang].setDestination;
  document.getElementById("locationName").textContent=translations[currentLang].loading;
  fetchLocationName();
}

function togglePanel(){
  const panel=document.getElementById("controlPanel");
  const tab=document.getElementById("panelToggle");
  
  const isHidden=panel.classList.contains("hidden");
  
  if(isHidden){
    panel.classList.remove("hidden");
    tab.classList.remove("show");
    hideAllElements();
  }else{
    panel.classList.add("hidden");
    tab.classList.add("show");
    showAllElements();
  }
}

function hideAllElements(){
  document.getElementById("navButtons").classList.add("hidden");
  document.getElementById("infoPanel").classList.remove("show");
}

function showAllElements(){
  document.getElementById("navButtons").classList.remove("hidden");
  document.getElementById("infoPanel").classList.add("show");
}

window.gm_authFailure=()=>alert("Maps APIã‚¨ãƒ©ãƒ¼");

function initMap(){
  if(!navigator.geolocation)return alert("ä½ç½®æƒ…å ±éå¯¾å¿œ");
  
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    
    map=new google.maps.Map(document.getElementById("map"),{
      center:currentLocation,
      zoom:17,
      mapTypeControl:!1,
      streetViewControl:!1,
      fullscreenControl:!1,
      zoomControl:!1,
      heading:0,
      tilt:45
    });
    
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    
    currentMarker=new google.maps.Marker({
      position:currentLocation,
      map,
      icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"}
    });
    
    headingMode="heading";
    
    document.getElementById("map").style.display="block";
    document.getElementById("loading").classList.add("hide");
    
    setTimeout(()=>{
      document.getElementById("navButtons").classList.remove("hidden");
      document.getElementById("infoPanel").classList.add("show");
      document.getElementById("panelToggle").classList.add("show");
      
      updateCurrentTime();
      setInterval(updateCurrentTime, 60000);
      
      updateCoords();
      
      fetchLocationName();
      fetchWeather();
    },100);
    
    setupCompass();
    startWatch();
  },err=>alert("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—: "+err.message));
}

function setupCompass(){
  const needle=document.getElementById("compassNeedle");
  if(!needle)return;
  
  function animate(){
    compassAlpha=.8*compassAlpha+.2*targetAlpha;
    needle.style.transform=`rotate(${compassAlpha}deg)`;
    needle.style.transformOrigin="25px 25px";
    requestAnimationFrame(animate);
  }
  animate();
  
  if(typeof DeviceOrientationEvent!=="undefined"){
    window.addEventListener("deviceorientation",e=>{
      if(typeof e.alpha==="number"){
        targetAlpha=e.alpha;
        
        if(headingMode==="heading"){
          map.setHeading(360-e.alpha);
        }
      }
    });
  }
}

function setNorthUp(){
  headingMode="north";
  map.setHeading(0);
  map.setTilt(0);
  document.getElementById("nupBtn").classList.add("active");
  document.getElementById("hupBtn").classList.remove("active");
  speak("ãƒãƒ¼ã‚¹ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰");
}

function setHeadingUp(){
  headingMode="heading";
  if(typeof targetAlpha==="number"){
    map.setHeading(360-targetAlpha);
  }
  map.setTilt(45);
  document.getElementById("nupBtn").classList.remove("active");
  document.getElementById("hupBtn").classList.add("active");
  speak("ãƒ˜ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒƒãƒ—ãƒ¢ãƒ¼ãƒ‰");
}

function startWatch(){
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    currentMarker&&currentMarker.setPosition(currentLocation);
    
    updateCoords();
    
    isNavigating&&reroute(!1);
  },()=>{},{enableHighAccuracy:!0});
}

function updateCoords(){
  if(!currentLocation)return;
  const lat=currentLocation.lat.toFixed(6);
  const lng=currentLocation.lng.toFixed(6);
  document.getElementById("coordsDisplay").textContent=`ğŸ“ ç·¯åº¦: ${lat} / çµŒåº¦: ${lng}`;
}

async function searchPlace(){
  const q=document.getElementById("searchBox").value.trim();
  if(!q)return showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!currentLocation)return showError("ç¾åœ¨åœ°å–å¾—ä¸­");
  
  hideResults();
  
  try{
    const res=await fetch(PLACES_PROXY,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-Goog-FieldMask":"places.id,places.displayName,places.formattedAddress,places.location"},
      body:JSON.stringify({
        textQuery:q,
        locationBias:{circle:{center:{latitude:currentLocation.lat,longitude:currentLocation.lng},radius:5000}},
        maxResultCount:5
      })
    });
    
    if(!res.ok)throw new Error("æ¤œç´¢å¤±æ•—");
    
    const data=await res.json();
    const places=data?.places||[];
    
    if(places.length===0){
      showError("çµæœãªã—");
      speak("è©²å½“ã™ã‚‹åœ°ç‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");
      return;
    }
    
    displayResults(places);
  }catch(e){
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: "+e.message);
  }
}

function displayResults(places){
  const list=document.getElementById("resultsList");
  list.innerHTML="";
  
  places.forEach(p=>{
    const item=document.createElement("div");
    item.className="result-item";
    item.innerHTML=`<div style="font-weight:700">${p.displayName?.text||"ä¸æ˜"}</div><div style="font-size:12px;color:var(--muted)">${p.formattedAddress||""}</div>`;
    item.onclick=()=>selectPlace(p);
    list.appendChild(item);
  });
  
  document.getElementById("resultsPanel").style.display="block";
  
  document.getElementById("controlPanel").classList.add("hidden");
  document.getElementById("panelToggle").classList.remove("show");
  hideAllElements();
}

function hideResults(){
  document.getElementById("resultsPanel").style.display="none";
  showAllElements();
}

function selectPlace(place){
  const lat=place.location?.latitude,lng=place.location?.longitude;
  
  destMarker&&destMarker.setMap(null);
  destMarker=new google.maps.Marker({position:{lat,lng},map});
  
  map.panTo({lat,lng});
  map.setZoom(18);
  
  hideResults();
  
  document.getElementById("controlPanel").classList.add("hidden");
  document.getElementById("panelToggle").classList.add("show");
  showAllElements();
  
  setTimeout(()=>{
    if(currentMarker&&destMarker)startNav();
  },500);
}

function voiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("éŸ³å£°èªè­˜éå¯¾å¿œ");
  
  const btn=document.getElementById("voiceBtn");
  const rec=new SR;
  rec.lang="ja-JP";
  
  btn.classList.add("recording");
  btn.textContent="éŒ²éŸ³ä¸­...";
  
  rec.onresult=e=>{
    document.getElementById("searchBox").value=e.results[0][0].transcript;
    btn.classList.remove("recording");
    btn.textContent="éŸ³å£°æ¤œç´¢";
    searchPlace();
  };
  rec.onerror=()=>{
    showError("éŸ³å£°èªè­˜å¤±æ•—");
    btn.classList.remove("recording");
    btn.textContent="éŸ³å£°æ¤œç´¢";
  };
  rec.onend=()=>{
    btn.classList.remove("recording");
    btn.textContent="éŸ³å£°æ¤œç´¢";
  };
  rec.start();
}

function quickVoiceSearch(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR)return showError("éŸ³å£°èªè­˜éå¯¾å¿œ");
  
  const btn=document.getElementById("quickVoiceBtn");
  const rec=new SR;
  rec.lang="ja-JP";
  
  btn.style.background="var(--danger)";
  btn.textContent="â—";
  
  rec.onresult=e=>{
    const query=e.results[0][0].transcript;
    btn.style.background="";
    btn.textContent="ğŸ¤";
    
    document.getElementById("searchBox").value=query;
    searchPlace();
  };
  rec.onerror=()=>{
    showError("éŸ³å£°èªè­˜å¤±æ•—");
    btn.style.background="";
    btn.textContent="ğŸ¤";
  };
  rec.onend=()=>{
    btn.style.background="";
    btn.textContent="ğŸ¤";
  };
  rec.start();
}

function relocalize(){
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    currentMarker&&currentMarker.setPosition(currentLocation);
    map.panTo(currentLocation);
    map.setZoom(18);
  },()=>showError("ä½ç½®æƒ…å ±å–å¾—å¤±æ•—"));
}

function goToCurrent(){
  if(!currentMarker)return showError("ç¾åœ¨åœ°æœªè¨­å®š");
  const pos=currentMarker.getPosition();
  map.panTo(pos);
  map.setZoom(18);
}

function goToDestination(){
  if(!destMarker)return showError("ç›®çš„åœ°æœªè¨­å®š");
  map.panTo(destMarker.getPosition());
  map.setZoom(18);
}

function startNav(){
  if(!currentMarker||!destMarker)return showError("ç¾åœ¨åœ°ã¾ãŸã¯ç›®çš„åœ°ãŒæœªè¨­å®š");
  
  stopAnnounced=!1;
  
  directionsService.route({
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  },(res,status)=>{
    if(status!=="OK")return showError("çµŒè·¯å–å¾—å¤±æ•—");
    
    directionsRenderer.setDirections(res);
    isNavigating=!0;
    
    const leg=res.routes[0].legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    const routeText=`ç›®çš„åœ°ã¾ã§ç´„${dist}kmã€æ‰€è¦æ™‚é–“ã¯ç´„${dur}åˆ†`;
    document.getElementById("routeText").textContent=routeText;
    
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    
    document.getElementById("currentTime").textContent=formatTime(now);
    document.getElementById("arrivalTime").textContent=formatTime(arrival);
    
    speak(`æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚${routeText}ã§ã™ã€‚`);
    
    document.getElementById("controlPanel").classList.add("hidden");
    document.getElementById("panelToggle").classList.remove("show");
    showAllElements();
  });
}

function stopNav(){
  if(!stopAnnounced){
    stopAnnounced=!0;
    speak("æ¡ˆå†…åœæ­¢ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸã®ã§ã€æ¡ˆå†…ã‚’çµ‚äº†ã—ã¾ã™ã€‚");
  }
  
  directionsRenderer.setMap(null);
  directionsRenderer=new google.maps.DirectionsRenderer({map});
  
  isNavigating=!1;
  
  document.getElementById("routeText").textContent=translations[currentLang].setDestination;
  document.getElementById("arrivalTime").textContent="--:--";
  
  document.getElementById("panelToggle").classList.add("show");
  
  if(currentMarker){
    map.panTo(currentMarker.getPosition());
    map.setZoom(18);
  }
}

function reroute(manual=!0){
  if(!isNavigating){
    if(manual)showError("æ¡ˆå†…ä¸­ã§ã¯ã‚ã‚Šã¾ã›ã‚“");
    return;
  }
  
  directionsService.route({
    origin:currentMarker.getPosition(),
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING,
    provideRouteAlternatives:!0,
    avoidHighways:Math.random()>0.5
  },(res,status)=>{
    if(status!=="OK")return showError("ãƒªãƒ«ãƒ¼ãƒˆå¤±æ•—");
    
    const routes=res.routes;
    let selectedRoute=routes[0];
    if(routes.length>1){
      const altIndex=Math.floor(Math.random()*(routes.length-1))+1;
      selectedRoute=routes[altIndex];
    }
    
    directionsRenderer.setDirections({...res,routes:[selectedRoute]});
    
    const leg=selectedRoute.legs[0];
    const dist=(leg.distance.value/1000).toFixed(1);
    const dur=Math.round(leg.duration.value/60);
    
    const routeText=`åˆ¥ãƒ«ãƒ¼ãƒˆ: ç´„${dist}kmã€æ‰€è¦æ™‚é–“ã¯ç´„${dur}åˆ†`;
    document.getElementById("routeText").textContent=routeText;
    
    const now=new Date();
    const arrival=new Date(now.getTime()+leg.duration.value*1000);
    document.getElementById("currentTime").textContent=formatTime(now);
    document.getElementById("arrivalTime").textContent=formatTime(arrival);
    
    manual&&speak("åˆ¥ã®ãƒ«ãƒ¼ãƒˆã§æ¡ˆå†…ã—ã¾ã™");
  });
}

function formatTime(date){
  const h=date.getHours();
  const m=date.getMinutes().toString().padStart(2,'0');
  return `${h}:${m}`;
}

function updateCurrentTime(){
  document.getElementById("currentTime").textContent=formatTime(new Date());
}

function saveCurrentPoint(){
  if(!currentLocation)return showError("ç¾åœ¨åœ°å–å¾—ä¸­");
  const name=prompt("åœ°ç‚¹åã‚’å…¥åŠ›");
  if(!name)return;
  savedPoints.push({name,lat:currentLocation.lat,lng:currentLocation.lng});
  alert("ç™»éŒ²ã—ã¾ã—ãŸ");
}

function saveMapPoint(){
  alert("åœ°å›³ä¸Šã®ä»»æ„ã®å ´æ‰€ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ãã ã•ã„");
  selectingMapPoint=!0;
  
  const listener=map.addListener("click",e=>{
    const name=prompt("åœ°ç‚¹åã‚’å…¥åŠ›");
    if(name){
      savedPoints.push({name,lat:e.latLng.lat(),lng:e.latLng.lng()});
      alert("ç™»éŒ²ã—ã¾ã—ãŸ");
    }
    selectingMapPoint=!1;
    google.maps.event.removeListener(listener);
  });
}

function showSavedPoints(){
  if(savedPoints.length===0)return alert("ç™»éŒ²åœ°ç‚¹ãªã—");
  
  const panel=document.getElementById("savedPointsPanel");
  const list=document.getElementById("savedPointsList");
  list.innerHTML="";
  
  savedPoints.forEach((p,i)=>{
    const item=document.createElement("div");
    item.className="saved-point-item";
    item.textContent=`${i+1}. ${p.name}`;
    item.onclick=()=>{
      destMarker&&destMarker.setMap(null);
      destMarker=new google.maps.Marker({position:{lat:p.lat,lng:p.lng},map});
      map.panTo({lat:p.lat,lng:p.lng});
      map.setZoom(18);
      hideSavedPoints();
      
      document.getElementById("controlPanel").classList.add("hidden");
      document.getElementById("panelToggle").classList.add("show");
      showAllElements();
      
      setTimeout(()=>{
        if(currentMarker&&destMarker)startNav();
      },500);
    };
    list.appendChild(item);
  });
  
  panel.style.display="block";
  
  hideAllElements();
}

function hideSavedPoints(){
  document.getElementById("savedPointsPanel").style.display="none";
  showAllElements();
}

async function fetchLocationName(){
  if(!currentLocation)return;
  
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lng}&format=json&accept-language=${currentLang}`);
    const data=await res.json();
    
    const city=data.address?.city||data.address?.town||data.address?.village||"";
    const ward=data.address?.suburb||"";
    const locationText=ward?`${city}${ward}`:city?`${city}`:translations[currentLang].loading;
    
    document.getElementById("locationName").textContent=locationText;
  }catch(e){
    document.getElementById("locationName").textContent=translations[currentLang].loading;
  }
}

async function fetchWeather(){
  if(!currentLocation)return;
  
  try{
    const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia/Tokyo&forecast_days=1`);
    const data=await res.json();
    
    const now=new Date();
    const currentHour=now.getHours();
    
    const hours=[3,6,9,12];
    const weatherIcons={0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",71:"ğŸŒ¨ï¸",73:"ğŸŒ¨ï¸",75:"ğŸŒ¨ï¸",77:"ğŸŒ¨ï¸",80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",85:"ğŸŒ¨ï¸",86:"ğŸŒ¨ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"};
    
    hours.forEach(h=>{
      const targetHour=(currentHour+h)%24;
      const idx=data.hourly.time.findIndex(t=>new Date(t).getHours()===targetHour);
      
      if(idx>=0){
        const temp=Math.round(data.hourly.temperature_2m[idx]);
        const rain=data.hourly.precipitation_probability[idx]||0;
        const code=data.hourly.weathercode[idx];
        const icon=weatherIcons[code]||"â˜ï¸";
        
        document.getElementById(`w${h}h`).textContent=icon;
        document.getElementById(`t${h}h`).textContent=`${temp}Â°`;
        document.getElementById(`r${h}h`).textContent=`${rain}%`;
      }
    });
  }catch(e){
    console.error("Weather fetch error:",e);
  }
}

function showError(msg){
  const el=document.getElementById("error");
  el.textContent=msg;
  el.classList.remove("hidden");
  setTimeout(()=>el.classList.add("hidden"),3000);
}

function speak(text){
  try{
    const u=new SpeechSynthesisUtterance(text);
    u.lang="ja-JP";
    u.rate=0.9;
    speechSynthesis.speak(u);
  }catch(e){}
}

window.addEventListener("load",initMap);
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places" async defer></script>
</body>
</html>
