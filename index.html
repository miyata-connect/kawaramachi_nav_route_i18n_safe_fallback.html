<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Cloudflare Workers çµŒç”± ORS æ­©è¡ŒãƒŠãƒ“</title>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin
  />
  <style>
    :root{
      --bg:#0b1220;--panel:#121a2b;--fg:#e8eefc;--muted:#98a4c5;--accent:#3ea8ff;
      --btn:#18233b;--danger:#ff5a5a;--ok:#0bb67d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}
    header{
      padding:10px 12px 6px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      background:linear-gradient(180deg,var(--bg),#0c1527 70%, transparent);
      position:sticky;top:0;z-index:600;
    }
    h1{margin:0 8px 0 0;font-size:20px;white-space:nowrap}
    .ctrl-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;width:100%}
    .search{
      display:flex;align-items:center;gap:6px;background:var(--panel);border:1px solid #243150;border-radius:12px;padding:6px 8px;flex:1;min-width:220px;
    }
    .search input{background:transparent;border:none;outline:none;color:var(--fg);width:100%;font-size:16px}
    .icon-btn{background:var(--btn);border:1px solid #22304e;color:var(--fg);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .icon-btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{background:#0f1a31;border:1px solid #22304e;border-radius:10px;padding:6px 10px;color:var(--muted)}
    select, .num{
      appearance:none;background:#0f1a31;border:1px solid #22304e;border-radius:10px;color:var(--fg);
      padding:8px 10px;font-size:14px
    }
    .nums{display:flex;gap:8px;flex-wrap:wrap}
    .nums .num{width:120px}
    #map{height:calc(100% - 165px);min-height:420px}
    @media (max-width:680px){ #map{height:calc(100% - 190px)} }
    .floating{
      position:absolute;right:14px;bottom:20px;z-index:500;display:flex;flex-direction:column;gap:10px;
    }
    .fab{background:#0e162c;border:1px solid #22304e;color:var(--fg);border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;min-width:110px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
    .fab:active{transform:translateY(1px)}
    .toast{
      position:fixed;left:16px;right:16px;bottom:10px;z-index:900;background:#0f172a;border:1px solid #22304e;color:var(--fg);
      border-radius:12px;padding:10px 12px;display:flex;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(0,0,0,.35)
    }
    .toast small{color:var(--muted)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#142242;color:#9db8ff;border:1px solid #22304e;margin-left:6px}
    .ok{color:#a7ffcf}
    .err{color:#ffb9b9}
    .list{
      position:absolute;left:12px;right:12px;top:86px;z-index:700;background:#0f172a;border:1px solid #22304e;border-radius:12px;
      max-height:300px;overflow:auto;display:none
    }
    .item{padding:10px 12px;border-top:1px solid #1a2745;cursor:pointer}
    .item:first-child{border-top:none}
    .item:hover{background:#121f3b}
    .hint{color:var(--muted);font-size:12px}
    .legend{
      position:absolute;left:12px;top:168px;z-index:650;background:#0f172a;border:1px solid #22304e;border-radius:10px;padding:6px 8px;color:#a9b7dd
    }
  </style>
</head>
<body>
  <header>
    <h1>Cloudflare Workers çµŒç”± ORS æ­©è¡ŒãƒŠãƒ“</h1>

    <div class="ctrl-row">
      <!-- æ¤œç´¢æ¬„ï¼ˆåº—å/ä½æ‰€/é›»è©±ï¼‰ -->
      <div class="search" style="flex:1.6;min-width:260px">
        <span>ğŸ”</span>
        <input id="q" type="search" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢â€¦" autocomplete="off">
        <button id="mic" class="icon-btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
        <button id="searchBtn" class="icon-btn">æ¤œç´¢</button>
      </div>

      <div class="nums">
        <input id="lon1" class="num" type="number" step="0.000001" placeholder="é–‹å§‹ Lon" title="é–‹å§‹ Lon">
        <input id="lat1" class="num" type="number" step="0.000001" placeholder="é–‹å§‹ Lat" title="é–‹å§‹ Lat">
        <input id="lon2" class="num" type="number" step="0.000001" placeholder="ç›®çš„åœ° Lon" title="ç›®çš„åœ° Lon">
        <input id="lat2" class="num" type="number" step="0.000001" placeholder="ç›®çš„åœ° Lat" title="ç›®çš„åœ° Lat">
      </div>

      <label class="pill">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        <select id="profile">
          <option value="foot-walking" selected>foot-walking</option>
          <option value="wheelchair">wheelchair</option>
        </select>
      </label>
      <label class="pill">è¨€èª
        <select id="lang">
          <option value="ja" selected>ja</option>
          <option value="en">en</option>
          <option value="zh">zh</option>
          <option value="ko">ko</option>
        </select>
      </label>

      <button id="routeBtn" class="icon-btn" style="background:var(--accent);border-color:#2b7fcc;color:#031225">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
      <button id="clearBtn" class="icon-btn">ã‚¯ãƒªã‚¢</button>
    </div>
  </header>

  <div id="list" class="list"></div>
  <div id="map"></div>

  <div class="legend hint">åœ°å›³ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ç›®çš„åœ°ã‚’è¨­å®šã§ãã¾ã™</div>

  <div class="floating">
    <button id="locBtn" class="fab">ç¾åœ¨åœ°</button>
    <button id="dstBtn" class="fab">ç›®çš„åœ°</button>
    <button id="rerouteBtn" class="fab">ãƒªãƒ«ãƒ¼ãƒˆ</button>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <div id="status">æº–å‚™OKã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>
    <small id="meta"></small>
  </div>

  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin
  ></script>
  <script>
  /************** è¨­å®š **************/
  const WORKER_URL = 'https://ors-proxy.miyata-connect-jp.workers.dev'; // â†ã‚ãªãŸã® Worker
  const ORS_ENDPOINT = WORKER_URL + '/proxy'; // POST ?profile=foot-walking
  const SEARCH_URL = 'https://photon.komoot.io/api/'; // ä½æ‰€/POIæ¤œç´¢ï¼ˆã‚­ãƒ¼ä¸è¦ï¼‰

  /************** ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹ **************/
  let map, routeLine, routePoints = [], routeSteps = [];
  let youMarker, accCircle, destMarker, selectDestMode = false;
  let lastPos = null, watchId = null;
  let announcedTurnIdx = -1;
  let passedWarned = false; // ã€Œé€šã‚Šéãã¾ã—ãŸã€ã¯1å›ã®ã¿
  let audioCtx;

  /************** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ **************/
  const $ = sel => document.querySelector(sel);
  function toast(msg, meta=''){ $('#status').textContent = msg; $('#meta').textContent = meta; }
  function metersBetween(a,b){
    const R=6371000, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
    const lat1=a.lat*Math.PI/180, lat2=b.lat*Math.PI/180;
    const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    return 2*R*Math.asin(Math.sqrt(x));
  }
  function pointToSegDist(p, a, b){
    const toRad = x=>x*Math.PI/180;
    // å¹³é¢è¿‘ä¼¼ï¼ˆçŸ­è·é›¢ç”¨ï¼‰
    const x0=p.lng, y0=p.lat, x1=a.lng, y1=a.lat, x2=b.lng, y2=b.lat;
    const A = {x:x0-x1,y:y0-y1}, B = {x:x2-x1,y:y2-y1};
    const t = Math.max(0, Math.min(1, (A.x*B.x + A.y*B.y)/(B.x*B.x + B.y*B.y)));
    const proj = {lng:x1 + t*B.x, lat:y1 + t*B.y};
    return metersBetween({lat:y0,lng:x0},{lat:proj.lat,lng:proj.lng});
  }
  function nearestDistOnLine(p, line){
    let min=Infinity;
    for(let i=1;i<line.length;i++){
      const d = pointToSegDist(p, line[i-1], line[i]);
      if(d<min) min=d;
    }
    return min;
  }
  function decodePolyline(str, precision=6){
    let index=0, lat=0, lng=0, coordinates=[], shift=0, result=0, b=0;
    const factor=Math.pow(10,precision);
    while(index<str.length){
      shift=0; result=0;
      do{ b=str.charCodeAt(index++)-63; result |= (b & 0x1f) << shift; shift += 5 }while(b>=0x20);
      const dlat = ((result & 1) ? ~(result>>1) : (result>>1));
      lat += dlat;

      shift=0; result=0;
      do{ b=str.charCodeAt(index++)-63; result |= (b & 0x1f) << shift; shift += 5 }while(b>=0x20);
      const dlng = ((result & 1) ? ~(result>>1) : (result>>1));
      lng += dlng;
      coordinates.push({lat: lat/factor, lng: lng/factor});
    }
    return coordinates;
  }
  function beep(ms=120, freq=880){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
      g.gain.setValueAtTime(0.12, audioCtx.currentTime);
      o.start(); o.stop(audioCtx.currentTime + ms/1000);
    }catch{}
  }
  function speak(text, lang){
    if(!('speechSynthesis' in window)) return;
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang || $('#lang').value || 'ja';
    u.rate = 1; u.pitch=1; u.volume = 1;
    window.speechSynthesis.cancel(); // å‰ã®ç™ºè©±ã‚’ä¸­æ–­
    window.speechSynthesis.speak(u);
  }

  /************** åœ°å›³ **************/
  initMap();
  function initMap(){
    map = L.map('map', {zoomControl:false}).setView([34.342,134.046], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.control.zoom({position:'topleft'}).addTo(map);

    map.on('click', (e)=>{
      if(selectDestMode){ setDestination(e.latlng); selectDestMode=false; toast('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸ','åœ°å›³ã‚¿ãƒƒãƒ—'); }
    });
    map.on('contextmenu', (e)=>{ setDestination(e.latlng); toast('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸ','åœ°å›³é•·æŠ¼ã—'); });

    // åˆæœŸä½ç½®ã®è¿½å°¾ã¯ãƒœã‚¿ãƒ³ã§é–‹å§‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿…é ˆï¼‰
    toast('æº–å‚™OKã€‚ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', 'GitHub Pages â†’ Workers â†’ ORS');
  }

  /************** ç›®çš„åœ°ã‚»ãƒƒãƒˆ **************/
  function setDestination(latlng){
    if(!destMarker){
      destMarker = L.marker(latlng, {draggable:true}).addTo(map);
      destMarker.on('dragend', ()=> { const p = destMarker.getLatLng(); $('#lon2').value=p.lng.toFixed(6); $('#lat2').value=p.lat.toFixed(6); });
    }else{ destMarker.setLatLng(latlng); }
    $('#lon2').value = latlng.lng.toFixed(6);
    $('#lat2').value = latlng.lat.toFixed(6);
  }

  /************** ç¾åœ¨åœ° **************/
  function ensureWatch(){
    if(watchId!=null) return;
    if(!('geolocation' in navigator)){ toast('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«æœªå¯¾å¿œã§ã™','Geolocation not supported'); return; }
    watchId = navigator.geolocation.watchPosition(pos=>{
      const {latitude, longitude, accuracy} = pos.coords;
      lastPos = {lat:latitude, lng:longitude, accuracy};
      if(!youMarker){
        youMarker = L.marker([latitude, longitude], {title:'ç¾åœ¨åœ°'}).addTo(map);
        accCircle = L.circle([latitude, longitude], {radius:accuracy, color:'#3ea8ff', fillColor:'#3ea8ff', fillOpacity:.15}).addTo(map);
      }else{
        youMarker.setLatLng([latitude, longitude]);
        accCircle.setLatLng([latitude, longitude]).setRadius(accuracy);
      }
      // è‡ªå‹•æ¡ˆå†…ï¼ˆã‚ã‚‹ç¨‹åº¦å‹•ã„ãŸã‚‰ï¼‰
      maybeWarnAndGuide();
    }, err=>{
      toast('ä½ç½®å–å¾—ã«å¤±æ•—: ' + err.message, 'è¨­å®šâ†’ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„');
    }, {enableHighAccuracy:true, maximumAge:3000, timeout:10000});
  }

  /************** ãƒ«ãƒ¼ãƒˆ **************/
  async function requestRoute(){
    const profile = $('#profile').value;
    const lang = $('#lang').value || 'ja';

    const start = getStart();
    const goal  = getGoal();
    if(!start || !goal){ toast('é–‹å§‹/ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™','ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ or æ¤œç´¢/é•·æŠ¼ã—ã§ç›®çš„åœ°'); return; }

    const body = {
      coordinates: [[+start.lng, +start.lat], [+goal.lng, +goal.lat]],
      instructions: true,
      language: lang
    };

    toast('ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦','ORS ' + profile);
    try{
      const res = await fetch(`${ORS_ENDPOINT}?profile=${encodeURIComponent(profile)}`, {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      const ok = res.ok;
      const data = await res.json();
      if(!ok) throw new Error((data && (data.message||data.error)) || res.statusText);
      drawRoute(data);
      toast('HTTP 200 / æˆåŠŸ', new Date().toLocaleTimeString());
    }catch(e){
      toast('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—', String(e.message||e));
      console.error(e);
    }
  }

  function drawRoute(data){
    const route = data.routes?.[0];
    if(!route){ toast('ãƒ«ãƒ¼ãƒˆãªã—','response empty'); return; }
    routePoints = decodePolyline(route.geometry, 6);
    routeSteps = (route.segments?.[0]?.steps)||[];

    if(routeLine){ routeLine.remove(); }
    routeLine = L.polyline(routePoints, {color:'#30b4ff', weight:6, opacity:.85}).addTo(map);
    map.fitBounds(routeLine.getBounds(), {padding:[40,40]});

    announcedTurnIdx = -1; passedWarned = false;
  }

  function getStart(){
    // 1) å…¥åŠ›æ¬„å„ªå…ˆ 2) ç¾åœ¨åœ°
    const lon = parseFloat($('#lon1').value), lat = parseFloat($('#lat1').value);
    if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat, lng:lon};
    if(lastPos) return lastPos;
    return null;
  }
  function getGoal(){
    const lon = parseFloat($('#lon2').value), lat = parseFloat($('#lat2').value);
    if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat, lng:lon};
    if(destMarker) return destMarker.getLatLng();
    return null;
  }

  /************** 5m è­¦å‘Š & äº¤å·®ç‚¹æ¡ˆå†… **************/
  function maybeWarnAndGuide(){
    if(!lastPos || routePoints.length<2) return;

    // ã€Œé€šã‚Šéãã€ãƒã‚§ãƒƒã‚¯ï¼ˆ5mä»¥ä¸Šã‚³ãƒ¼ã‚¹ã‹ã‚‰å¤–ã‚Œ/å…ˆã«é€²ã‚“ã§ã„ãŸã‚‰ï¼‰
    const off = nearestDistOnLine(lastPos, routePoints);
    if(off > 5 && !passedWarned){
      passedWarned = true;
      beep(140, 740);
      speak('é€šã‚Šéãã¾ã—ãŸã€‚ãƒªãƒ«ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ', $('#lang').value);
      setTimeout(()=>{
        if(confirm('é€šã‚Šéãã¾ã—ãŸã€‚ãƒªãƒ«ãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ')){
          requestRoute();
        }
      }, 10);
    }

    // æ¬¡ã®æ›²ãŒã‚Šã¾ã§ã®æ¡ˆå†…ï¼ˆ5mã§ç™ºè©±ï¼‰
    const next = nextTurnPoint();
    if(next){
      const dist = metersBetween(lastPos, next.latlng);
      if(dist <= 5 && announcedTurnIdx !== next.index){
        announcedTurnIdx = next.index;
        beep(120, 880);
        const text = turnSpeech(next.step);
        speak(text, $('#lang').value);
        toast(text, 'ã‚ã¨ 0 m');
      }else if(dist < 40 && dist > 5){
        // è¿‘ã¥ã„ãŸã‚‰äºˆå‘Šã‚’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«è¡¨ç¤º
        toast(`æ›²ãŒã‚Šã¾ã§ ç´„ ${Math.round(dist)} m`, next.step.instruction || '');
      }
    }
  }
  function nextTurnPoint(){
    if(!routeSteps.length) return null;
    // é€²è¡Œä¸­ã®æœ€åˆã®ã€Œturnã€ã‚’æ‹¾ã†
    for(let i=0;i<routeSteps.length;i++){
      const st = routeSteps[i];
      const idx = st.way_points?.[1]; // ãã®ã‚¹ãƒ†ãƒƒãƒ—ã®çµ‚ç‚¹ index
      if(typeof idx!=='number') continue;
      const latlng = routePoints[idx];
      if(!latlng) continue;
      // ã™ã§ã«é€šéã—ãŸæ¡ˆå†…ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç¾åœ¨åœ°ã‹ã‚‰ã®è·é›¢ãŒå¢—åŠ å‚¾å‘ãªã‚‰é€šéæ‰±ã„ï¼‰
      if(lastPos && metersBetween(lastPos, latlng) < 60){ // 60mä»¥å†…ã®æ¬¡ã‚¿ãƒ¼ãƒ³ã‚’å¯¾è±¡
        return {index:i, step:st, latlng};
      }
    }
    return null;
  }
  function turnSpeech(step){
    // æ—¥æœ¬èª instruction ã‚’ç°¡æ˜“è§£é‡ˆã—ã¦ã€Œã“ã®é€šã‚Šã‚’å³/å·¦ã§ã™ã€ã‚’ç”Ÿæˆ
    const s = step?.instruction || '';
    let dir = '';
    if(s.includes('å³')) dir = 'å³';
    else if(s.includes('å·¦')) dir = 'å·¦';
    const name = (step?.name && step.name!=='-') ? step.name : 'ã“ã®é€šã‚Š';
    if(dir) return `${name}ã‚’${dir}ã§ã™`;
    return s || 'ç›´é€²ã§ã™';
  }

  /************** æ¤œç´¢ï¼ˆPhotonï¼‰ **************/
  async function doSearch(){
    const q = $('#q').value.trim();
    if(!q){ $('#list').style.display='none'; return; }
    $('#list').innerHTML = '<div class="item hint">æ¤œç´¢ä¸­â€¦</div>'; $('#list').style.display='block';
    try{
      const url = `${SEARCH_URL}?q=${encodeURIComponent(q)}&lang=${encodeURIComponent($('#lang').value||'ja')}&limit=8`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      const data = await res.json();
      const feats = data?.features || [];
      if(!feats.length){ $('#list').innerHTML = '<div class="item hint">è©²å½“ãªã—</div>'; return; }
      $('#list').innerHTML = feats.map(f=>{
        const p = f.properties||{};
        const name = [p.name, p.street, p.housenumber, p.city, p.country].filter(Boolean).join(' ');
        const label = name || p.label || q;
        const [lon,lat] = f.geometry.coordinates;
        return `<div class="item" data-lat="${lat}" data-lon="${lon}">
          <div>${label}</div>
          <div class="hint">${p.osm_value||p.osm_key||''} <span class="badge">${lon.toFixed(5)}, ${lat.toFixed(5)}</span></div>
        </div>`;
      }).join('');
      $('#list').querySelectorAll('.item').forEach(el=>{
        el.addEventListener('click', ()=>{
          const lat = +el.dataset.lat, lon = +el.dataset.lon;
          setDestination({lat, lng:lon});
          map.setView([lat,lon], 17);
          $('#list').style.display='none';
        });
      });
    }catch(e){
      $('#list').innerHTML = `<div class="item err">æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${String(e.message||e)}</div>`;
    }
  }

  /************** éŸ³å£°å…¥åŠ› **************/
  (function setupMic(){
    const mic = $('#mic');
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ mic.style.display='none'; return; }
    const rec = new SR();
    rec.lang = $('#lang').value||'ja';
    rec.interimResults = false; rec.maxAlternatives = 1;
    mic.addEventListener('click', ()=>{
      try{ rec.start(); }catch{}
      toast('èãå–ã‚Šä¸­â€¦','è©±ã—ã‹ã‘ã¦ãã ã•ã„');
    });
    rec.onresult = (e)=>{
      const text = e.results[0][0].transcript;
      $('#q').value = text;
      doSearch();
      toast('éŸ³å£°å…¥åŠ›ï¼š' + text);
    };
    rec.onerror = e=> toast('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼', e.error||'');
  })();

  /************** ãƒœã‚¿ãƒ³é¡ **************/
  $('#routeBtn').addEventListener('click', requestRoute);
  $('#rerouteBtn').addEventListener('click', requestRoute);
  $('#clearBtn').addEventListener('click', ()=>{
    if(routeLine){ routeLine.remove(); routeLine=null; }
    routePoints=[]; routeSteps=[]; announcedTurnIdx=-1; passedWarned=false;
    toast('ãƒ«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
  });
  $('#locBtn').addEventListener('click', ()=>{
    ensureWatch();
    if(lastPos) map.setView([lastPos.lat,lastPos.lng], 18);
  });
  $('#dstBtn').addEventListener('click', ()=>{
    selectDestMode = true;
    toast('åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›®çš„åœ°ã‚’è¨­å®š','ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«');
    setTimeout(()=>{selectDestMode=false}, 8000);
  });
  $('#searchBtn').addEventListener('click', doSearch);
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });
  document.addEventListener('click', (e)=>{
    if(!$('#list').contains(e.target) && e.target!==$('#q')) $('#list').style.display='none';
  });

  // åˆå›ãƒ’ãƒ³ãƒˆ
  (function preset(){
    // ãƒ‡ãƒ¢åº§æ¨™ï¼ˆå¾³å³¶åŸå…¬åœ’ã‚ãŸã‚Šï¼‰
    $('#lon1').value = '134.046';
    $('#lat1').value = '34.342';
    $('#lon2').value = '134.049';
    $('#lat2').value = '34.341';
  })();

  </script>
</body>
</html>