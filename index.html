<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav v5 (Fixed)</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}
.results-panel{z-index:1001!important;}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <div id="controlPanel" class="control-panel hidden">
      <div class="panel-row">
        <input type="text" id="searchBox" placeholder="場所を検索..." />
      </div>
      <div class="panel-row">
        <button class="panel-btn primary" onclick="executeSearch()">検索</button>
        <button class="panel-btn" onclick="document.getElementById('controlPanel').classList.add('hidden')">閉じる</button>
      </div>
    </div>

    <div id="resultsPanel" class="results-panel" style="position:absolute;left:10px;right:10px;bottom:10px;max-height:60vh;overflow-y:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:12px;padding:10px;display:none;">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()" style="text-align:center;padding:8px;color:var(--primary);cursor:pointer;">閉じる</div>
    </div>

    <div id="loading" class="loading-screen" style="position:fixed;inset:0;background:#0e1a2d;display:flex;align-items:center;justify-content:center;z-index:1000;">
      <div style="text-align:center">
        <div style="font-size:18px;margin-bottom:10px" id="loadingText">現在地取得中...</div>
        <div style="font-size:14px;color:var(--muted)" id="loadingWait">もうしばらくお待ちください。</div>
      </div>
    </div>
  </div>

  <script>
"use strict";
let map, currentLocation = null;

function initMap(){
  if(!navigator.geolocation){ alert("Geolocation not supported"); return; }

  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation = {lat: pos.coords.latitude, lng: pos.coords.longitude};

    map = new google.maps.Map(document.getElementById("map"), {
      center: currentLocation,
      zoom: 17,
      mapTypeControl: false,
      streetViewControl: false,
      fullscreenControl: false,
      zoomControl: false
    });

    new google.maps.Marker({
      position: currentLocation,
      map: map,
      title: "現在地"
    });

    document.getElementById("map").style.display = "block";
    document.getElementById("loading").style.display = "none";
  }, err=>{
    alert("Location error: " + err.message);
  });
}

function executeSearch(){
  const q = document.getElementById("searchBox").value.trim();
  if(!q){ showError("検索ワードを入力してください"); return; }
  if(!currentLocation){ showError("位置情報を取得中"); return; }

  const service = new google.maps.places.PlacesService(map);
  const request = {
    query: q,
    location: currentLocation,
    radius: 50000,
    language: 'ja'
  };

  service.textSearch(request, (results, status) => {
    if(status === google.maps.places.PlacesServiceStatus.OK && results && results.length > 0){
      displayResults(results);
      showSuccess("検索完了");
    } else if(status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
      showError("結果が見つかりませんでした");
    } else {
      showError("検索エラー: " + status);
    }
  });
}

function displayResults(places){
  const list = document.getElementById("resultsList");
  list.innerHTML = "";
  places.slice(0,5).forEach(p=>{
    const lat = p.geometry.location.lat();
    const lng = p.geometry.location.lng();
    const item = document.createElement("div");
    item.style.padding = "10px";
    item.style.borderBottom = "1px solid var(--stroke)";
    item.style.cursor = "pointer";
    item.innerHTML = `<div style="font-weight:700">${p.name}</div><div style="font-size:12px;color:var(--muted)">${p.formatted_address||""}</div>`;
    item.onclick = ()=>{
      new google.maps.Marker({position:{lat,lng}, map});
      map.panTo({lat,lng});
      map.setZoom(18);
      hideResults();
    };
    list.appendChild(item);
  });
  document.getElementById("resultsPanel").style.display = "block";
}

function hideResults(){
  document.getElementById("resultsPanel").style.display = "none";
}

function showError(msg){
  console.error(msg);
  alert(msg);
}
function showSuccess(msg){
  console.log(msg);
}
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places&callback=initMap" async defer></script>
</body>
</html>
