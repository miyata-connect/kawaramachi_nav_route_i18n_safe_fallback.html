<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>WalkNav</title>
  <style>
:root{
  --glass: rgba(20,28,44,.54);
  --glass-strong: rgba(16,22,36,.68);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
  --mic-green:#0cb35a;
  --mic-red:#d53d3d;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",Meiryo,sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0}
.glassbar{position:absolute;left:0;right:0;top:0;z-index:420;padding:10px 12px;pointer-events:none}
.card{pointer-events:auto;background:var(--glass);border:1px solid var(--stroke);border-radius:16px;backdrop-filter: blur(14px) saturate(120%);-webkit-backdrop-filter: blur(14px) saturate(120%);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:10px 12px;width:min(1100px,96vw);margin:0 auto}
.row{display:flex;gap:10px;align-items:center;justify-content:center;flex-wrap:wrap}
.grow{flex:1 1 220px}
input,button{background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px;outline:none;min-height:44px}
button.primary{background:rgba(95,177,255,.92);border:none;font-weight:700}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button.reroute{background:var(--accent);border:none;color:#fff;font-weight:700}
button.reroute:hover{background:#00c2ff}
#micBtn{background:var(--mic-green)}
#micBtn.rec{background:var(--mic-red)}
.hint{color:var(--muted);font-size:13px}
.comp-wrap{position:absolute;left:10px;top:150px;z-index:425}
.compass{width:90px;height:90px;background:var(--glass);border:1px solid var(--stroke);border-radius:50%;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 10px 26px rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center}
.compass .needle{transform-origin:38px 38px}
.gm-fab-col{display:flex;flex-direction:column;gap:10px;transform:translateY(40px);z-index:430}
.gm-fab-col .btn-wide{min-width:150px;box-shadow:0 12px 26px rgba(0,0,0,.45);background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:12px;padding:11px 13px;font-size:16px}
.gm-fab-col .btn-wide.ok{background:var(--ok);border:none}
.gm-fab-col .btn-wide.danger{background:var(--danger);border:none}
.gm-fab-col .btn-wide.reroute{background:var(--accent);border:none;color:#fff}
.gm-fab-col .zooms{display:flex;flex-direction:column;gap:8px;align-items:center}
.gm-fab-col .btn-zoom{width:44px;height:44px;border-radius:8px;border:1px solid var(--stroke);background:var(--glass-strong);color:#fff;font-size:18px;line-height:44px;text-align:center;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.loading-screen{position:fixed;inset:0;background:#0e1a2d;display:flex;align-items:center;justify-content:center;z-index:1000;opacity:1;transition:opacity .4s;flex-direction:column;gap:20px}
.loading-screen.hide{opacity:0;pointer-events:none}
.loading-inner{text-align:center;padding:28px 24px}
.loading-sub{font-size:18px;line-height:1.6;color:#cfe0ff;white-space:pre-line}
.debug-log{background:rgba(0,0,0,.7);border:1px solid #444;border-radius:8px;padding:12px;max-width:90vw;max-height:200px;overflow-y:auto;font-size:11px;text-align:left;color:#0f0}
.debug-log div{margin:2px 0;font-family:monospace}
.error-banner{position:absolute;left:12px;right:12px;bottom:12px;z-index:999;background:#d53d3d;color:#fff;border-radius:10px;padding:10px 12px;text-align:center;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35)}
.hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>
    <div id="glassbar" class="glassbar">
      <div class="card row">
        <input id="searchBox" class="grow" placeholder="行き先を検索">
        <button id="searchBtn" class="primary">検索</button>
        <button id="micBtn">🎤</button>
        <button id="locBtn">📍</button>
      </div>
      <div class="hint">音声検索・再測位に対応しています。</div>
    </div>
    <div class="comp-wrap">
      <div class="compass">
        <svg class="needle" width="76" height="76" viewBox="0 0 76 76" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M38 8 L42 38 L38 36 L34 38 Z" fill="#ff6565" stroke="#fff" stroke-width="1"/>
          <path d="M38 68 L42 38 L38 40 L34 38 Z" fill="#eaf2ff" stroke="#444" stroke-width="1"/>
          <circle cx="38" cy="38" r="4" fill="#5fb1ff" stroke="#fff" stroke-width="2"/>
        </svg>
      </div>
    </div>
    <div id="loading" class="loading-screen">
      <div class="loading-inner">
        <div class="loading-sub">データ通信料削減のため、<br>現在地の地図表示中です。<br>表示まで、このままお待ちください…</div>
      </div>
      <div id="debugLog" class="debug-log"></div>
    </div>
    <div id="error-banner" class="error-banner hidden">
      <div id="error-text">エラーが発生しました。</div>
    </div>
    <div id="status" style="position:absolute;left:10px;bottom:10px;z-index:999;color:#cfe0ff;font-size:12px;"></div>
  </div>
  <script>
"use strict";
let map,directionsService,directionsRenderer,currentPositionMarker=null,destinationMarker=null,watchId=null,isNavigating=false,initDone=false,hasLocationFix=false;
const PLACES_PROXY="https://ors-proxy.miyata-connect-jp.workers.dev/places/text",GEO_TIMEOUT_MS=8000,FALLBACK_CENTER={lat:35.681236,lng:139.767125},LS_LAST_LOC="WALKNAV_LAST_LOCATION";

function log(msg){console.log(msg);const el=document.getElementById("debugLog");if(el){const d=document.createElement("div");d.textContent=new Date().toLocaleTimeString()+" "+msg;el.appendChild(d);el.scrollTop=el.scrollHeight}}

log("スクリプト読み込み完了");

window.gm_authFailure=function(){log("ERROR: Google Maps認証失敗");showError("APIキーエラー：設定を確認してください")};

function waitForGoogleMaps(){
  log("Google Maps API読み込み待機開始");
  let attempts=0;
  const maxAttempts=50;
  const checkInterval=setInterval(()=>{
    attempts++;
    log(`チェック ${attempts}/${maxAttempts}`);
    if(typeof google!=="undefined"&&google.maps){
      clearInterval(checkInterval);
      log("Google Maps API読み込み確認！");
      initMap();
    }else if(attempts>=maxAttempts){
      clearInterval(checkInterval);
      log("ERROR: タイムアウト - Google Maps APIが読み込めません");
      showError("地図の読み込みに失敗しました。ページを再読み込みしてください。");
      hideLoading();
    }
  },200);
}

function initMap(){
  log("initMap呼び出し");
  if(initDone){log("既に初期化済み");return}
  initDone=!0;
  
  if(typeof google==="undefined"||!google.maps){log("ERROR: google.mapsが未定義");showError("Google Maps APIの読み込みに失敗しました");return}
  
  log("Google Maps API読み込み成功");
  const center=readLastLocation()||FALLBACK_CENTER;
  log("中心座標: "+center.lat+","+center.lng);
  
  try{
    map=new google.maps.Map(document.getElementById("map"),{center,zoom:15,mapTypeControl:!1,streetViewControl:!1,fullscreenControl:!1,clickableIcons:!1,zoomControl:!1});
    log("地図オブジェクト作成成功");
    directionsService=new google.maps.DirectionsService;
    directionsRenderer=new google.maps.DirectionsRenderer({map});
    log("Directions初期化完了");
    
    let tilesLoaded=!1;
    google.maps.event.addListenerOnce(map,"tilesloaded",()=>{log("タイル読み込み完了");tilesLoaded=!0;hideLoading()});
    setTimeout(()=>{if(!tilesLoaded){log("タイムアウト：強制ローディング解除");hideLoading()}},5e3);
    
    mountRightControls();
    bindUI();
    setupCompass();
    log("UI初期化完了");
    
    if(navigator.geolocation){
      log("位置情報取得開始");
      navigator.geolocation.getCurrentPosition(pos=>{
        log("位置情報取得成功");
        const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
        hasLocationFix=!0;
        saveLastLocation(here);
        map.setCenter(here);
        placeOrMoveCurrent(here);
        startLocationWatch();
      },err=>{
        log("位置情報取得失敗: "+err.message);
        console.warn("位置情報取得失敗。FALLBACK適用。",err.message);
        placeOrMoveCurrent(center);
      },{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0})
    }else{
      log("位置情報非対応ブラウザ");
      console.warn("このブラウザは位置情報に対応していません。")
    }
  }catch(e){
    log("ERROR: 初期化例外 - "+e.message);
    console.error(e);
    showError("地図の初期化に失敗しました: "+e.message)
  }
}

function hideLoading(){
  const el=document.getElementById("loading");
  if(el&&"none"!==el.style.display){
    log("ローディング非表示");
    el.classList.add("hide");
    setTimeout(()=>el.style.display="none",400)
  }
}

function mountRightControls(){
  const c=document.createElement("div");
  c.className="gm-fab-col";
  const btnStart=mkBtn("案内開始","ok","gm-start-nav"),btnStop=mkBtn("案内を停止","danger","gm-stop-nav"),btnReroute=mkBtn("リルート","reroute","gm-reroute"),zooms=document.createElement("div");
  zooms.className="zooms";
  zooms.append(mkBtn("＋","btn-zoom","gm-zoom-in"),mkBtn("－","btn-zoom","gm-zoom-out"));
  c.append(btnStart,btnStop,btnReroute,zooms);
  map.controls[google.maps.ControlPosition.RIGHT_CENTER].push(c);
  const gb=q("#glassbar"),toggle=()=>{const visible=gb&&"none"!==getComputedStyle(gb).display;c.style.display=visible?"none":""};
  new MutationObserver(toggle).observe(document.body,{attributes:!0,childList:!0,subtree:!0});
  addEventListener("resize",toggle);
  setTimeout(toggle,100);
}

function mkBtn(label,cls,id){
  const b=document.createElement("button");
  b.textContent=label;
  b.className=cls.includes("btn-zoom")?cls:`btn-wide ${cls}`;
  b.id=id;
  return b;
}

function bindUI(){
  q("#searchBtn").onclick=searchPlace;
  q("#micBtn").onclick=initVoiceRecognition;
  q("#locBtn").onclick=relocalize;
  q("#searchBox").addEventListener("keydown",e=>{"Enter"===e.key&&searchPlace()});
  document.addEventListener("click",e=>{
    const id=e.target?.id||"";
    "gm-start-nav"===id?startNav():"gm-stop-nav"===id?stopNav():"gm-reroute"===id?reroute(!0):"gm-zoom-in"===id?map.setZoom(map.getZoom()+1):"gm-zoom-out"===id&&map.setZoom(map.getZoom()-1);
  });
}

function relocalize(){
  setStatus("現在地を再取得中…");
  if(!navigator.geolocation)return void showError("位置情報が利用できません。");
  navigator.geolocation.getCurrentPosition(pos=>{
    const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
    hasLocationFix=!0;
    saveLastLocation(here);
    placeOrMoveCurrent(here);
    map.panTo(here);
    setStatus("現在地を更新しました。");
  },err=>showError("現在地取得失敗: "+err.message),{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function startLocationWatch(){
  if(!navigator.geolocation)return;
  watchId&&navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    const here={lat:pos.coords.latitude,lng:pos.coords.longitude};
    hasLocationFix=!0;
    saveLastLocation(here);
    placeOrMoveCurrent(here);
    isNavigating&&reroute(!1);
  },err=>console.warn("watchPosition:",err.message),{enableHighAccuracy:!0,timeout:GEO_TIMEOUT_MS,maximumAge:0});
}

function placeOrMoveCurrent(latlng){
  currentPositionMarker?currentPositionMarker.setPosition(latlng):currentPositionMarker=new google.maps.Marker({position:latlng,map,icon:{path:google.maps.SymbolPath.CIRCLE,scale:8,fillColor:"#5fb1ff",fillOpacity:1,strokeWeight:2,strokeColor:"#fff"},title:"現在地"});
}

async function searchPlace(){
  const qv=q("#searchBox").value.trim();
  if(!qv)return showError("検索ワードを入力してください。");
  if(!currentPositionMarker)return showError("現在地の取得を待っています。");
  setStatus("検索中…");
  try{
    const pos=currentPositionMarker.getPosition(),payload={textQuery:qv,locationBias:pos?{circle:{center:{latitude:pos.lat(),longitude:pos.lng()},radius:2e4}}:void 0};
    const res=await fetch(PLACES_PROXY,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    if(!res.ok)throw new Error(await res.text());
    const data=await res.json(),place=data?.places?.[0];
    if(!place)return showError("該当する地点が見つかりません。");
    const lat=place.location?.latitude,lng=place.location?.longitude,name=place.displayName?.text||qv;
    destinationMarker&&destinationMarker.setMap(null);
    destinationMarker=new google.maps.Marker({position:{lat,lng},map,title:name});
    map.panTo({lat,lng});
    setStatus(`検索完了: ${name}`);
  }catch(e){
    console.error(e);
    showError("検索エラーが発生しました。");
  }
}

function startNav(){
  if(!currentPositionMarker||!destinationMarker)return showError("現在地または目的地が未設定です。");
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  setStatus("経路計算中…");
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    "OK"!==status?showError("経路を取得できません。"):(directionsRenderer.setDirections(res),isNavigating=!0,speak("案内を開始します。"),setStatus("案内中"));
  });
}

function stopNav(){
  directionsRenderer.setDirections({routes:[]});
  isNavigating=!1;
  speak("案内を終了します。");
  setStatus("案内を停止しました。");
}

function reroute(manual){
  if(!isNavigating)return void(manual&&showError("案内が開始されていません。"));
  const origin=currentPositionMarker.getPosition(),dest=destinationMarker.getPosition();
  directionsService.route({origin,destination:dest,travelMode:google.maps.TravelMode.WALKING},(res,status)=>{
    "OK"!==status?showError("リルートに失敗しました。"):(directionsRenderer.setDirections(res),manual&&speak("リルートしました。"),setStatus("案内更新中"));
  });
}

function initVoiceRecognition(){
  const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SpeechRecognition)return showError("音声認識に対応していません。");
  const recognition=new SpeechRecognition,micBtn=q("#micBtn");
  recognition.lang="ja-JP";
  recognition.continuous=!1;
  recognition.interimResults=!1;
  micBtn.classList.add("rec");
  recognition.onresult=e=>{const transcript=e.results[0][0].transcript;q("#searchBox").value=transcript;searchPlace();micBtn.classList.remove("rec")};
  recognition.onerror=e=>{console.error("音声認識エラー:",e.error);showError("音声認識に失敗しました。");micBtn.classList.remove("rec")};
  recognition.onend=()=>micBtn.classList.remove("rec");
  recognition.start();
}

let compassAlpha=0,targetAlpha=0;
function setupCompass(){
  const needle=document.querySelector(".needle");
  if(!needle)return;
  !function animate(){compassAlpha=.8*compassAlpha+.2*targetAlpha;needle.style.transform=`rotate(${compassAlpha}deg)`;requestAnimationFrame(animate)}();
  const useAlpha=a=>{"number"==typeof a&&(targetAlpha=a)};
  "undefined"!=typeof DeviceOrientationEvent&&window.addEventListener("deviceorientation",e=>{"number"==typeof e.alpha&&useAlpha(e.alpha)});
}

function q(s){return document.querySelector(s)}
function setStatus(s){const el=q("#status");el&&(el.textContent=s||"")}
function showError(msg){
  log("ERROR: "+msg);
  const b=q("#error-banner"),t=q("#error-text");
  t&&(t.textContent=msg);
  b&&(b.classList.remove("hidden"),setTimeout(()=>b.classList.add("hidden"),4e3));
  speak(msg);
}
function speak(t){try{const u=new SpeechSynthesisUtterance(t);u.lang="ja-JP";speechSynthesis.speak(u)}catch{}}
function saveLastLocation(latlng){try{localStorage.setItem(LS_LAST_LOC,JSON.stringify(latlng))}catch{}}
function readLastLocation(){try{const s=localStorage.getItem(LS_LAST_LOC);if(!s)return null;const v=JSON.parse(s);if("number"==typeof v?.lat&&"number"==typeof v?.lng)return v}catch{}return null}

waitForGoogleMaps();
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=places" async defer></script>
</body>
</html>