<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Walk-Nav AI</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
/* (CSSは変更なしのため省略) */
:root{--bg:#0f1a25;--panel:#132235;--panel2:#0f1e30;--text:#eaf2ff;--muted:#9db0c6;--ok:#2ecc71;--primary:#4aa3ff;--danger:#ff6b6b;--accent:#4ac8ff;}.btn-group button.selected{background:var(--accent);color:var(--bg);font-weight:700}.compass{position:absolute;left:10px;top:10px;width:60px;height:60px;z-index:450}#compass-needle{transform-origin:center;transition:transform .5s ease-out;transform:translate(-50%,-90%) rotate(0deg);fill:#ff6b6b}#map{width:100%;height:60vh;border-radius:12px;background:#334}.fab{position:absolute;bottom:20px;z-index:450;display:flex;gap:10px;width:100%;justify-content:center}.fab button{box-shadow:0 8px 20px rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.1)}body,html{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",sans-serif;background:var(--bg);color:var(--text)}main{max-width:800px;margin:0 auto;padding:10px}h1,h2,h3{margin:0 0 10px;padding:0;color:var(--accent);font-weight:400}input,button,select{font-size:16px;padding:10px;border-radius:8px;border:1px solid var(--panel2);background:var(--panel);color:var(--text);margin:2px}button{cursor:pointer}button.primary{background:var(--primary);color:#fff}button.recording{animation:pulse 1.5s infinite}#results{position:fixed;bottom:0;left:0;right:0;background:rgba(15,26,37,.95);backdrop-filter:blur(5px);border-top:1px solid var(--panel2);padding:10px;transform:translateY(100%);transition:transform .3s ease-out;z-index:500;max-height:50vh;overflow-y:auto}#results.show{transform:translateY(0)}#results ul{list-style:none;padding:0;margin:0}#results li{padding:12px;border-bottom:1px solid var(--panel2);cursor:pointer}#results li:hover{background:var(--panel)}#results-list strong{color:var(--accent)}#status{margin-top:8px;color:var(--muted);min-height:1.2em}button.loading{opacity:.7;pointer-events:none}.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}.modal-box{background:var(--panel);padding:20px;border-radius:12px;width:90%;max-width:400px}.modal-box h3{margin-top:0}.modal-box input{width:calc(100% - 24px);margin-bottom:10px}.modal-box .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:10px}#load-list li{display:flex;align-items:center;padding:8px;border-bottom:1px solid var(--panel2)}#load-list li .name{flex-grow:1}#load-list li button{margin-left:5px;padding:5px 8px;font-size:14px}@keyframes pulse{0%{box-shadow:0 0 0 0 rgba(255,107,107,.7)}70%{box-shadow:0 0 0 10px rgba(255,107,107,0)}100%{box-shadow:0 0 0 0 rgba(255,107,107,0)}}
</style>
</head>
<body>

<main>
  <div class="btn-group">
    <button class="lang-btn selected" data-lang="ja">日本語</button>
    <button class="lang-btn" data-lang="en">English</button>
  </div>
  <input id="q" placeholder="検索ワード">
  <button id="btn-voice">🎤</button>
  <button id="btn-search" class="primary">検索</button>
  <button id="btn-clear-history">履歴クリア</button>
  <div id="map"></div>
  <div class="compass"><svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="48" fill="#132235" stroke="#4aa3ff" stroke-width="2"></circle><polygon id="compass-needle" points="50,10 60,50 50,90 40,50"></polygon><circle cx="50" cy="50" r="5" fill="#4aa3ff"></circle></svg></div>
  <div id="status">準備完了</div>
  <div class="fab">
    <button id="btn-current">現在地</button>
    <button id="btn-dest">目的地</button>
    <button id="btn-reroute">リルート</button>
  </div>
  <div class="btn-group">
    <button class="mode-btn selected" data-mode="shortest">最短Ai</button>
    <button class="mode-btn" data-mode="easy">楽ちんAi</button>
    <button class="mode-btn" data-mode="walkai">お散歩Ai</button>
  </div>
  <hr>
  <div>
    開始: <input id="start-lng" placeholder="経度"> <input id="start-lat" placeholder="緯度">
  </div>
  <div>
    終了: <input id="end-lng" placeholder="経度"> <input id="end-lat" placeholder="緯度">
  </div>
  <button id="btn-set-dest">目的地セット</button>
  <button id="btn-start" class="primary">案内開始</button>
  <button id="btn-stop">案内停止</button>
  <hr>
  <button id="btn-save" class="primary">現在地を保存</button>
  <button id="btn-load">呼び出し</button>
</main>

<div id="results">
  <button id="btn-close-results" style="float:right">閉じる</button>
  <h3>検索結果</h3>
  <ul id="results-list"></ul>
</div>

<div id="save-modal" class="modal">
  <div class="modal-box">
    <h3>地点の保存</h3>
    <input id="save-name" placeholder="名前 (例: 自宅)">
    <div class="actions">
      <button id="btn-cancel-save">キャンセル</button>
      <button id="btn-do-save" class="primary">保存</button>
    </div>
  </div>
</div>

<div id="load-modal" class="modal">
  <div class="modal-box">
    <h3>保存した地点</h3>
    <ul id="load-list"></ul>
    <div class="actions">
      <button id="btn-close-load">閉じる</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/***********************
 * 設定
 ************************/
// (設定部分は変更なしのため省略)
const GMAP_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const PLACES_SEARCH_URL = `${GMAP_PROXY}/places:searchText`;
const DIRECTIONS_URL      = `${GMAP_PROXY}/maps/api/directions/json`;
let currentLang = 'ja';
let currentMode = 'shortest';
let watchId = null;
let headingDeg = 0;
let userMarker = null;
let destMarker = null;
let routeLayer = null;
let lastResults = [];
let isRecording = false;
const LS_SAVED = 'walknav_saved_locations'; // NEW: キー名を変更
const LS_HISTORY = 'walknav_hist';

/***********************
 * 地図
 ************************/
// (地図部分は変更なしのため省略)
const map = L.map('map', { zoomControl:false, center:[35.680,139.76], zoom:15 });
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap',
  maxZoom: 19
}).addTo(map);
L.control.zoom({ position:'bottomleft' }).addTo(map);

/***********************
 * 要素
 ************************/
// (要素取得部分は変更なしのため省略)
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const qInput = $('#q');
const statusEl = $('#status');
const resultsEl = $('#results');
const resultsList = $('#results-list');
const btnVoice = $('#btn-voice');
const btnSearch = $('#btn-search');
const btnClearHistory = $('#btn-clear-history');
const btnCurrent = $('#btn-current');
const btnDest = $('#btn-dest');
const btnReroute = $('#btn-reroute');
const startLng = $('#start-lng');
const startLat = $('#start-lat');
const endLng = $('#end-lng');
const endLat = $('#end-lat');
const btnSetDest = $('#btn-set-dest');
const btnStart = $('#btn-start');
const btnStop = $('#btn-stop');
const needle = $('#compass-needle');
// NEW: 保存・呼び出し関連の要素
const btnSave = $('#btn-save');
const btnLoad = $('#btn-load');
const saveModal = $('#save-modal');
const saveNameInput = $('#save-name');
const btnCancelSave = $('#btn-cancel-save');
const btnDoSave = $('#btn-do-save');
const loadModal = $('#load-modal');
const loadList = $('#load-list');
const btnCloseLoad = $('#btn-close-load');

/***********************
 * ツール
 ************************/
// (ツール部分は変更なしのため省略)
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function setStatus(msg){ statusEl.textContent = msg || ''; }
function asLatLng(lngInput, latInput){
  const lng = parseFloat(lngInput.value);
  const lat = parseFloat(latInput.value);
  if (Number.isFinite(lng) && Number.isFinite(lat)) return [lat,lng];
  return null;
}

/***********************
 * JAVASCRIPT - ここからロジックの変更・追加
 ************************/

// (既存の音声検索、言語・モード設定、現在地取得、検索ロジック等は変更なしのため省略)

/***********************
 * NEW: 保存・呼び出し機能
 ************************/

// --- 保存モーダルを開く ---
btnSave.addEventListener('click', async () => {
  try {
    // 保存時には現在地を強制的に取得して基準にする
    setStatus('現在地を取得中...');
    const p = await getCurrentPosition({ enableHighAccuracy: true, timeout: 10000 });
    const { latitude, longitude } = p.coords;
    
    // 緯度経度を保存モーダルにセット (ユーザーは編集不可)
    saveModal.dataset.lat = latitude;
    saveModal.dataset.lng = longitude;
    saveNameInput.value = ''; // 名前入力欄はクリア
    saveModal.style.display = 'flex';
    saveNameInput.focus();
    setStatus('保存する場所の名前を入力してください');
  } catch(e) {
    setStatus('保存失敗：現在地を取得できませんでした - ' + e.message);
  }
});

// --- 保存処理の実行 ---
btnDoSave.addEventListener('click', () => {
  const name = saveNameInput.value.trim();
  if (!name) {
    setStatus('名前を入力してください');
    return;
  }
  const lat = parseFloat(saveModal.dataset.lat);
  const lng = parseFloat(saveModal.dataset.lng);
  
  const saved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
  saved.unshift({ name, lat, lng, t: Date.now() });
  localStorage.setItem(LS_SAVED, JSON.stringify(saved.slice(0, 50))); // 50件まで保存
  
  saveModal.style.display = 'none';
  setStatus(`「${name}」を保存しました`);
});

// --- 保存モーダルを閉じる ---
btnCancelSave.addEventListener('click', () => {
  saveModal.style.display = 'none';
});

// --- 呼び出しモーダルを開く ---
btnLoad.addEventListener('click', () => {
  renderSavedList();
  loadModal.style.display = 'flex';
});

// --- 呼び出しモーダルを閉じる ---
btnCloseLoad.addEventListener('click', () => {
  loadModal.style.display = 'none';
});

// --- 保存済みリストの描画 ---
function renderSavedList() {
  const saved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
  loadList.innerHTML = ''; // リストをクリア
  
  if (saved.length === 0) {
    loadList.innerHTML = '<li>保存された地点はありません</li>';
    return;
  }
  
  saved.forEach((item, index) => {
    const li = document.createElement('li');
    
    const nameSpan = document.createElement('span');
    nameSpan.className = 'name';
    nameSpan.textContent = item.name;
    
    const setDestBtn = document.createElement('button');
    setDestBtn.textContent = '目的地に設定';
    setDestBtn.className = 'primary';
    setDestBtn.addEventListener('click', () => {
      endLat.value = item.lat.toFixed(6);
      endLng.value = item.lng.toFixed(6);
      putDestMarker(item.lat, item.lng, item.name);
      loadModal.style.display = 'none';
      setStatus(`目的地を「${item.name}」に設定しました`);
      // 自動でルート案内を開始
      btnStart.click();
    });
    
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = '削除';
    deleteBtn.className = 'danger';
    deleteBtn.addEventListener('click', () => {
      if (confirm(`「${item.name}」を削除しますか？`)) {
        const currentSaved = JSON.parse(localStorage.getItem(LS_SAVED) || '[]');
        const updatedSaved = currentSaved.filter((_, i) => i !== index);
        localStorage.setItem(LS_SAVED, JSON.stringify(updatedSaved));
        renderSavedList(); // リストを再描画
      }
    });
    
    li.appendChild(nameSpan);
    li.appendChild(setDestBtn);
    li.appendChild(deleteBtn);
    loadList.appendChild(li);
  });
}

// (既存の各種イベントリスナーや初期化関数は変更なしのため省略)
// ... 既存のコード ...
function putDestMarker(lat,lng,name){
  if(!destMarker) destMarker = L.marker([lat,lng]).addTo(map);
  destMarker.setLatLng([lat,lng]).bindPopup(name||'目的地').openPopup();
  map.setView([lat,lng], 17);
}
// ... 既存のコード ...
// 初期化時に一度リストを読み込む (ただしUIは非表示)
document.addEventListener('DOMContentLoaded', () => {
    // 既存の初期化処理
});
</script>

</body>
</html>
