<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cloudflare Workers ナビ</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>

<style>
:root{
  --bg:#0f1b33; --panel:#142748; --panel-2:#17305a;
  --text:#eaf2ff; --muted:#b7c6e6; --bright:#fff;
  --btn:#2ea8ff; --btn2:#00c2a8; --btn3:#ff6b6b; --btnText:#071422;
  --chip:#20365f; --shadow:0 10px 22px rgba(0,0,0,.25);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo; color:var(--text);
 background:radial-gradient(1200px 700px at 50% -100px,#1a2d55 0%,var(--bg) 52%) fixed;}
.wrap{max-width:1050px;margin:0 auto;padding:14px}
h1{margin:4px 0 14px;font-size:28px;letter-spacing:.04em;font-weight:800;text-shadow:0 6px 14px rgba(0,0,0,.25)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.card{width:100%;background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);border:1px solid rgba(255,255,255,.08);
 border-radius:16px;padding:12px;box-shadow:var(--shadow)}
.input,.selectlike{background:#0f2142;border:1px solid rgba(255,255,255,.18);color:var(--text);padding:12px 14px;border-radius:12px;width:100%;font-size:16px}
.input::placeholder{color:#94a9cd}
.group{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.group3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
.label{color:var(--muted);font-size:13px;margin:6px 2px 6px;font-weight:700}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:var(--chip);color:#cfe3ff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);font-weight:800;cursor:pointer}
.chip.on{background:linear-gradient(180deg,#2a56a7,#1e4294);color:#fff;border-color:rgba(255,255,255,.22)}
.btns{display:flex;gap:10px;flex-wrap:wrap}
.btn{background:linear-gradient(180deg,#5ed0ff,#2ea8ff);color:var(--btnText);font-weight:900;padding:12px 18px;border-radius:12px;border:none;cursor:pointer;
 box-shadow:0 10px 20px rgba(46,168,255,.25);font-size:16px}
.btn.secondary{background:linear-gradient(180deg,#9ec2ff,#6ea0ff);box-shadow:0 10px 20px rgba(110,160,255,.28)}
.btn.green{background:linear-gradient(180deg,#3de0c8,#00c2a8);box-shadow:0 10px 20px rgba(0,194,168,.28)}
.btn.red{background:linear-gradient(180deg,#ffa59b,#ff6b6b);box-shadow:0 10px 20px rgba(255,107,107,.28)}
.info{color:#d1def7;font-size:14px;margin-top:8px}
.small{font-size:12px;color:#9fb1d6}

#mapWrap{position:relative;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.14);box-shadow:var(--shadow)}
#map{height:66vh;min-height:420px}
.leaflet-top.leaflet-left{top:14px !important;left:14px !important}

#status{margin:10px 0 2px;font-weight:700;color:#eaf2ff}
#results{margin-top:8px;background:#0f2142;border:1px solid rgba(255,255,255,.16);border-radius:12px;padding:6px;max-height:240px;overflow:auto}
.rItem{padding:10px;border-radius:10px;cursor:pointer}
.rItem:hover{background:#122b54}
.rName{font-weight:800}
.rMeta{color:#aecdff;font-size:12px}

/* 方位計（小型・右上） */
#cmp{position:absolute;top:10px;right:10px;z-index:460;display:flex;flex-direction:column;align-items:center;gap:2px;pointer-events:none}
#cmpSvg{display:block}
#cmpInfo{margin-top:2px;padding:2px 8px;border-radius:10px;background:rgba(27,68,151,.9);border:1px solid rgba(255,255,255,.22);
 color:#fff;font-weight:800;font-size:12px;box-shadow:0 6px 12px rgba(0,0,0,.25)}
#cmpInfo #cmpDir{margin-right:6px}

/* 右側のフローティングボタン群 */
#floatingBtns{position:absolute;right:12px;bottom:12px;z-index:450;display:flex;flex-direction:column;gap:12px;align-items:flex-end}
.fbtn{min-width:150px;text-align:center;padding:14px 16px;border-radius:16px;font-weight:900;border:1px solid rgba(255,255,255,.18);color:#fff;
 box-shadow:0 10px 18px rgba(0,0,0,.25);cursor:pointer;background:linear-gradient(180deg,#30d98f,#2ab572)}
.fbtn.loc{background:linear-gradient(180deg,#3d8cff,#1767ff)}
.fbtn.dest{background:linear-gradient(180deg,#8e9dff,#5468ff)}
.fbtn.reroute{background:linear-gradient(180deg,#ff8b7f,#ff5d5d)}

@media (max-width:720px){.group{grid-template-columns:1fr}.group3{grid-template-columns:1fr 1fr}#map{height:64vh}}
</style>
</head>
<body>
<div class="wrap">
  <h1>Cloudflare Workers ナビ</h1>

  <!-- 検索 -->
  <div class="card">
    <div class="row">
      <input id="q" class="input" placeholder="店舗名・住所・電話番号で検索（現在地付近 上位5件）" />
      <button id="micBtn" class="btn green" style="min-width:72px">🎤</button>
      <button id="searchBtn" class="btn">検索</button>
    </div>
    <div id="results" hidden></div>
  </div>

  <!-- 位置とモード -->
  <div class="card">
    <div class="label">開始地点（経度・緯度）</div>
    <div class="group">
      <input id="startLon" class="input" readonly />
      <input id="startLat" class="input" readonly />
    </div>

    <div class="label" style="margin-top:10px">目的地（経度・緯度）</div>
    <div class="group">
      <input id="destLon" class="input" placeholder="経度" />
      <input id="destLat" class="input" placeholder="緯度" />
    </div>

    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <div class="label">モード</div>
        <div class="chips" id="modeChips">
          <div data-mode="foot-walking" class="chip on">徒歩</div>
          <div data-mode="wheelchair" class="chip">車椅子</div>
        </div>
        <div class="small" id="modeHint" style="margin-top:6px">
          徒歩：最短を優先 ／ 車椅子：急勾配や段差・階段を避けます
        </div>
      </div>
    </div>

    <div class="btns" style="margin-top:14px">
      <button id="routeBtn" class="btn">ルート取得</button>
      <button id="clearBtn" class="btn secondary">クリア</button>
    </div>

    <div class="info" style="margin-top:10px"><b>地図を長押し</b>すると目的地に設定できます</div>
    <div id="status">準備完了。目的地を設定してください</div>
  </div>

  <!-- 開始地点の保存／呼出し -->
  <div class="card">
    <div class="label">開始地点の記憶（この端末に保存）</div>
    <div class="group3">
      <select id="savedStartSelect" class="selectlike"></select>
      <button id="saveStartBtn" class="btn secondary">現在地を保存</button>
      <button id="applyStartBtn" class="btn">開始地点に設定</button>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="delStartBtn" class="btn red">選択した現在地を削除</button>
    </div>
  </div>

  <!-- 目的地の保存／呼出し -->
  <div class="card">
    <div class="label">目的地の記憶（この端末に保存）</div>
    <div class="group3">
      <select id="savedSelect" class="selectlike"></select>
      <button id="saveBtn" class="btn secondary">目的地を保存</button>
      <button id="applySavedBtn" class="btn">目的地に設定</button>
    </div>
    <div class="btns" style="margin-top:10px">
      <button id="delSavedBtn" class="btn red">選択した記憶地点を削除</button>
    </div>
  </div>

  <!-- 地図 -->
  <div id="mapWrap" class="card" style="padding:0">
    <div id="map"></div>

    <!-- 方位計 -->
    <div id="cmp" aria-hidden="true">
      <svg id="cmpSvg" viewBox="0 0 120 120" width="66" height="66">
        <defs>
          <filter id="cmpShadow" x="-50%" y="-50%" width="200%" height="200%">
            <feDropShadow dx="0" dy="2" stdDeviation="2" flood-color="#000" flood-opacity="0.35"/>
          </filter>
          <radialGradient id="gradBG" cx="50%" cy="40%">
            <stop offset="0%" stop-color="#1a3e86"/><stop offset="70%" stop-color="#133574"/><stop offset="100%" stop-color="#0f2e69"/>
          </radialGradient>
        </defs>
        <circle cx="60" cy="60" r="56" fill="url(#gradBG)" stroke="rgba(255,255,255,.25)" stroke-width="1.5" filter="url(#cmpShadow)"/>
        <g fill="#cfe3ff" opacity=".9" font-weight="800" font-size="12" text-anchor="middle" dominant-baseline="middle">
          <text x="60" y="12">N</text><text x="60" y="108">S</text><text x="108" y="60">E</text><text x="12" y="60">W</text>
        </g>
        <line x1="60" y1="6" x2="60" y2="18" stroke="#ff7676" stroke-width="3" stroke-linecap="round"/>
        <g id="cmpArrow" transform="rotate(0 60 60)">
          <polygon points="60,18 74,54 60,48 46,54" fill="#00e6ff" stroke="#e8fbff" stroke-width="1"/>
          <polygon points="60,102 46,66 60,72 74,66" fill="#ff6161" stroke="#ffecec" stroke-width="1"/>
        </g>
      </svg>
      <div id="cmpInfo"><span id="cmpDir">N/A</span> <span id="cmpDeg">0°</span></div>
    </div>

    <!-- 右側の操作 -->
    <div id="floatingBtns">
      <div id="startGuideBtn" class="fbtn">案内開始</div>
      <div id="locBtn" class="fbtn loc">現在地</div>
      <div id="toDestBtn" class="fbtn dest">目的地</div>
      <div id="rerouteBtn" class="fbtn reroute">リルート</div>
    </div>
  </div>

  <div class="small" style="margin-top:10px;opacity:.75">
    OpenStreetMap © contributors ／ ルーティング: openrouteservice（Cloudflare Workers 経由）
  </div>
</div>

<script>
/* ====== 設定 ====== */
const WORKER_PROXY_URL = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
const DEFAULT_LANG = 'ja';
const OFF_ROUTE_M = 5;     // 5mでオフルート
const NEAR_TURN_M  = 12;   // 次アクション読み上げ距離
const OVERVIEW_MS  = 1800; // 俯瞰表示

/* ====== 参照 ====== */
const qEl=document.getElementById('q'), micBtn=document.getElementById('micBtn'), searchBtn=document.getElementById('searchBtn'), resultsEl=document.getElementById('results');
const startLonEl=document.getElementById('startLon'), startLatEl=document.getElementById('startLat'), destLonEl=document.getElementById('destLon'), destLatEl=document.getElementById('destLat');
const modeChips=document.getElementById('modeChips'), routeBtn=document.getElementById('routeBtn'), clearBtn=document.getElementById('clearBtn'), statusEl=document.getElementById('status');
const savedSelect=document.getElementById('savedSelect'), saveBtn=document.getElementById('saveBtn'), applySavedBtn=document.getElementById('applySavedBtn'), delSavedBtn=document.getElementById('delSavedBtn');
const savedStartSelect=document.getElementById('savedStartSelect'), saveStartBtn=document.getElementById('saveStartBtn'), applyStartBtn=document.getElementById('applyStartBtn'), delStartBtn=document.getElementById('delStartBtn');
const startGuideBtn=document.getElementById('startGuideBtn'), locBtn=document.getElementById('locBtn'), toDestBtn=document.getElementById('toDestBtn'), rerouteBtn=document.getElementById('rerouteBtn');
const cmpArrow=document.getElementById('cmpArrow'), cmpDeg=document.getElementById('cmpDeg'), cmpDir=document.getElementById('cmpDir');

/* ====== 地図 ====== */
let map, startMarker, destMarker, routeLine;
let currentRoute=null, instructionSteps=[];
let guideOn=false, watchId=null, lastPos=null, lastHeading=null, reroutePending=false, profile='foot-walking';

/*** GPSフィルタ用 ***/
let filtLat=null, filtLon=null, lastLL=null, lastTs=0;
const ACC_LIMIT=80;         // 80mより悪い精度は無視
const JUMP_M=50;            // 急激ジャンプのしきい値
const EMA_ALPHA=0.2;        // 位置の平滑化係数

function setStatus(msg){ statusEl.textContent=msg; }

/* ====== 地図初期化 ====== */
function initMap(){
  map=L.map('map',{zoomControl:true,attributionControl:false}).setView([35.681,139.767],16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  // 長押しで目的地
  let timer;
  map.on('mousedown touchstart',e=>{ timer=setTimeout(()=>setDestination(e.latlng.lng,e.latlng.lat,true),550); });
  map.on('mouseup touchend touchcancel',()=>clearTimeout(timer));
}
function setDestination(lon,lat,fromMap=false){
  destLonEl.value=Number(lon).toFixed(6); destLatEl.value=Number(lat).toFixed(6);
  if(!destMarker){
    destMarker=L.marker([lat,lon],{draggable:true}).addTo(map)
      .on('moveend',ev=>{const c=ev.target.getLatLng();destLonEl.value=c.lng.toFixed(6);destLatEl.value=c.lat.toFixed(6);});
  }else destMarker.setLatLng([lat,lon]);
  if(fromMap) speak('目的地を設定しました');
  setStatus('目的地を設定しました。ルート取得を実行します。');
  getRoute();
}

/* ====== 現在地取得（高精度＋平滑化） ====== */
function geolocOptions(){ return {enableHighAccuracy:true, timeout:15000, maximumAge:0}; }

function filterPosition(pos){
  const {latitude:lat, longitude:lon, accuracy} = pos.coords;
  if(accuracy && accuracy > ACC_LIMIT) return null;
  const now=pos.timestamp||Date.now();
  if(lastLL){
    const jump = map.distance(lastLL, L.latLng(lat,lon));
    const dt = (now-lastTs)/1000;
    if(jump>JUMP_M && dt<2) return null;
  }
  lastTs=now; lastLL=L.latLng(lat,lon);
  if(filtLat==null){filtLat=lat;filtLon=lon;}else{
    filtLat = EMA_ALPHA*lat + (1-EMA_ALPHA)*filtLat;
    filtLon = EMA_ALPHA*lon + (1-EMA_ALPHA)*filtLon;
  }
  return {lat:filtLat, lon:filtLon, raw:pos};
}

function requestLocation(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) {reject(new Error('Geolocation unsupported'));return;}
    navigator.geolocation.getCurrentPosition(p=>{
      const f=filterPosition(p); if(!f){reject(new Error('精度不足'));return;}
      resolve(f);
    }, reject, geolocOptions());
  });
}
async function setStartToCurrent(center=true){
  try{
    const f=await requestLocation();
    startLatEl.value=f.lat.toFixed(6); startLonEl.value=f.lon.toFixed(6);
    lastPos=f.raw;
    if(!startMarker) startMarker=L.marker([f.lat,f.lon]).addTo(map);
    else startMarker.setLatLng([f.lat,f.lon]);
    if(center) map.setView([f.lat,f.lon],18,{animate:true});
  }catch(e){ setStatus('現在地を取得できませんでした（精度不足/権限）。'); }
}
locBtn.addEventListener('click',()=>setStartToCurrent(true));
toDestBtn.addEventListener('click',()=>{ if(destMarker) map.setView(destMarker.getLatLng(),18,{animate:true}); });

/* ====== ORSルート ====== */
async function getRoute(){
  const slon=parseFloat(startLonEl.value), slat=parseFloat(startLatEl.value);
  const dlon=parseFloat(destLonEl.value), dlat=parseFloat(destLatEl.value);
  if(!isFinite(slon)||!isFinite(slat)||!isFinite(dlon)||!isFinite(dlat)){ setStatus('開始地点/目的地が未設定です。'); return; }
  setStatus('ルート取得中…');
  const body={coordinates:[[slon,slat],[dlon,dlat]],instructions:true,language:DEFAULT_LANG,profile};
  try{
    const res=await fetch(WORKER_PROXY_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!res.ok) throw new Error('fetch error');
    const data=await res.json();
    currentRoute=data; drawRoute(data);
    setTimeout(()=>{ if(startMarker) map.setView(startMarker.getLatLng(),18,{animate:true}); },OVERVIEW_MS);
    setStatus('ルートを表示しました。案内を開始できます。');
  }catch(e){ console.error(e); setStatus('ルートの取得に失敗しました。'); }
}
routeBtn.addEventListener('click',getRoute);

function drawRoute(data){
  const coords=decodePolyline(data.routes[0].geometry);
  instructionSteps=data.routes[0].segments[0].steps||[];
  if(routeLine){map.removeLayer(routeLine);}
  routeLine=L.polyline(coords,{color:'#27a3ff',weight:6,opacity:.9}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[30,30]});
}

/* ====== 音声案内 ====== */
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='ja-JP'; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
function startGuidance(){
  if(!currentRoute){ setStatus('まずルートを取得してください。'); return; }
  guideOn=true; reroutePending=false; setStatus('案内を開始します'); speak('案内を開始します'); announceNextAction();
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(p=>{
    const f=filterPosition(p); if(!f) return; lastPos=p;
    const ll=[f.lat,f.lon];
    if(!startMarker) startMarker=L.marker(ll).addTo(map); else startMarker.setLatLng(ll);
    try{
      const dist = distanceToPolylineMeters(L.latLng(f.lat,f.lon), routeLine);
      if(dist>OFF_ROUTE_M){
        if(!reroutePending){
          reroutePending=true; speak('通り過ぎました。リルートします。'); setStatus('オフルート：リルート中…');
          startLonEl.value=f.lon.toFixed(6); startLatEl.value=f.lat.toFixed(6);
          getRoute().then(()=>{ reroutePending=false; announceNextAction(); });
        }
      }else{ announceNextAction(); }
    }catch(_){}
  }, err=>console.warn(err), geolocOptions());
}
function stopGuidance(){ guideOn=false; if(watchId) navigator.geolocation.clearWatch(watchId); watchId=null; }
startGuideBtn.addEventListener('click',startGuidance);
rerouteBtn.addEventListener('click',()=>{ if(lastPos){ startLonEl.value=(filtLon??lastPos.coords.longitude).toFixed(6);
 startLatEl.value=(filtLat??lastPos.coords.latitude).toFixed(6); getRoute().then(announceNextAction);} });

function announceNextAction(){
  if(!guideOn||!instructionSteps.length||!startMarker) return;
  const my=startMarker.getLatLng(); let nearestIdx=0,nearestD=Infinity;
  instructionSteps.forEach((st,i)=>{ if(st.way_points&&routeLine){ const wp=st.way_points[0]; const latlng=routeLine.getLatLngs()[wp]; const d=map.distance(my,latlng); if(d<nearestD){nearestD=d;nearestIdx=i;} }});
  if(nearestD<=NEAR_TURN_M){ const t=(instructionSteps[nearestIdx].instruction||'').replace('です。','です'); if(t) speak(t); }
}

/* ====== クリア ====== */
function clearAll(){
  if(routeLine){map.removeLayer(routeLine);routeLine=null;}
  currentRoute=null; instructionSteps=[];
  if(destMarker){map.removeLayer(destMarker);destMarker=null;}
  destLonEl.value=''; destLatEl.value='';
  resultsEl.innerHTML=''; resultsEl.hidden=true;
  setStatus('クリアしました。目的地を設定してください。');
  document.getElementById('map').scrollIntoView({block:'nearest'});
}
clearBtn.addEventListener('click',clearAll);

/* ====== 検索（近隣 5 件：距離ソート） ====== */
function toRad(v){return v*Math.PI/180;}
function haversineMeters(a,b){const R=6371000;const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lon-a.lon);const lat1=toRad(a.lat), lat2=toRad(b.lat);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2);const h=s1*s1+Math.cos(lat1)*Math.cos(lat2)*s2*s2;return 2*R*Math.asin(Math.sqrt(h));}
function fmtDist(m){return m<1000?`${Math.round(m)}m`:`${(m/1000).toFixed(1)}km`; }

async function doSearch(){
  const text=(qEl.value||'').trim();
  if(!text){ resultsEl.hidden=true; resultsEl.innerHTML=''; return; }
  // 現在地が未取得なら一度捕まえる
  if(!startLatEl.value || !startLonEl.value){ try{ await setStartToCurrent(false); }catch{} }

  const baseLat=parseFloat(startLatEl.value)||0, baseLon=parseFloat(startLonEl.value)||0;
  try{
    // まず広めに 20 件取る（bounded は使わない）
    const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&addressdetails=1&extratags=1&limit=20&accept-language=ja&q=${encodeURIComponent(text)}`;
    const res=await fetch(url,{headers:{'User-Agent':'miyata-connect-github-io-navi'}});
    const raw=await res.json();

    // 重複（同一座標）を丸めて排除
    const uniq = [];
    const keyset = new Set();
    for(const r of raw){
      const lat=Number(r.lat), lon=Number(r.lon);
      const k=`${lat.toFixed(5)},${lon.toFixed(5)}`;
      if(!keyset.has(k)){ keyset.add(k); uniq.push({...r, lat, lon}); }
    }

    // 距離計算して近い順に並べ替え → 上位 5 件
    const withD = uniq.map(r=>({r, d:haversineMeters({lat:baseLat,lon:baseLon},{lat:r.lat,lon:r.lon})}))
                      .sort((a,b)=>a.d-b.d)
                      .slice(0,5);

    resultsEl.innerHTML = withD.length
      ? withD.map(({r,d})=>`
         <div class="rItem" data-lon="${r.lon}" data-lat="${r.lat}">
           <div class="rName">${(r.display_name||'').split(',')[0]} <span class="rMeta">（${fmtDist(d)}）</span></div>
           <div class="rMeta">${r.display_name||''}</div>
         </div>`).join('')
      : '<div class="rItem">該当なし</div>';

    resultsEl.hidden=false;
    [...resultsEl.querySelectorAll('.rItem')].forEach(el=>el.addEventListener('click',()=>{
      const lon=el.dataset.lon, lat=el.dataset.lat;
      setDestination(lon,lat,true);
      resultsEl.hidden=true;
    }));
  }catch(e){
    console.warn(e);
    resultsEl.hidden=false;
    resultsEl.innerHTML='<div class="rItem">検索に失敗しました</div>';
  }
}
searchBtn.addEventListener('click',doSearch);

/* 音声入力 */
(function(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ micBtn.disabled=true; micBtn.textContent='🎤×'; return; }
  const rec=new SR(); rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1;
  micBtn.addEventListener('click',()=>{try{rec.start();}catch(_){}}); rec.onresult=e=>{const t=e.results[0][0].transcript||''; qEl.value=t; speak(`音声入力。${t}`); doSearch(); };
})();

/* ====== 記憶地点（目的地） ====== */
function loadSaved(){ const items=JSON.parse(localStorage.getItem('savedPlaces')||'[]');
  savedSelect.innerHTML=items.map((it,i)=>`<option value="${i}">${it.name}（${it.lon.toFixed(4)}, ${it.lat.toFixed(4)}）</option>`).join(''); }
function saveCurrentDest(){
  const lon=parseFloat(destLonEl.value), lat=parseFloat(destLatEl.value);
  if(!isFinite(lon)||!isFinite(lat)){ speak('目的地が設定されていません'); return; }
  const name=prompt('この場所の名前', new Date().toLocaleString()); if(!name) return;
  const items=JSON.parse(localStorage.getItem('savedPlaces')||'[]'); items.push({name,lon,lat});
  localStorage.setItem('savedPlaces',JSON.stringify(items)); loadSaved(); speak('保存しました');
}
function applySaved(){ const items=JSON.parse(localStorage.getItem('savedPlaces')||'[]'); const idx=savedSelect.value|0; const it=items[idx]; if(it) setDestination(it.lon,it.lat,true); }
function deleteSaved(){ const items=JSON.parse(localStorage.getItem('savedPlaces')||'[]'); const idx=savedSelect.value|0; if(items[idx]==null) return;
  if(!confirm(`「${items[idx].name}」を削除しますか？`)) return; items.splice(idx,1); localStorage.setItem('savedPlaces',JSON.stringify(items)); loadSaved(); }
saveBtn.addEventListener('click',saveCurrentDest); applySavedBtn.addEventListener('click',applySaved); delSavedBtn.addEventListener('click',deleteSaved);

/* ====== 記憶地点（開始地点） ====== */
function loadSavedStarts(){ const items=JSON.parse(localStorage.getItem('savedStarts')||'[]');
  savedStartSelect.innerHTML=items.map((it,i)=>`<option value="${i}">${it.name}（${it.lon.toFixed(4)}, ${it.lat.toFixed(4)}）</option>`).join(''); }
function saveCurrentStart(){
  const lon=parseFloat(startLonEl.value), lat=parseFloat(startLatEl.value);
  if(!isFinite(lon)||!isFinite(lat)){ speak('開始地点が未取得です'); return; }
  const name=prompt('現在地に名前を付けて保存', new Date().toLocaleString()); if(!name) return;
  const items=JSON.parse(localStorage.getItem('savedStarts')||'[]'); items.push({name,lon,lat});
  localStorage.setItem('savedStarts',JSON.stringify(items)); loadSavedStarts(); speak('保存しました');
}
function applySavedStart(){ const items=JSON.parse(localStorage.getItem('savedStarts')||'[]'); const idx=savedStartSelect.value|0; const it=items[idx];
  if(it){ startLonEl.value=it.lon.toFixed(6); startLatEl.value=it.lat.toFixed(6); if(!startMarker) startMarker=L.marker([it.lat,it.lon]).addTo(map); else startMarker.setLatLng([it.lat,it.lon]); map.setView([it.lat,it.lon],18); } }
function deleteSavedStart(){ const items=JSON.parse(localStorage.getItem('savedStarts')||'[]'); const idx=savedStartSelect.value|0; if(items[idx]==null) return;
  if(!confirm(`開始地点「${items[idx].name}」を削除しますか？`)) return; items.splice(idx,1); localStorage.setItem('savedStarts',JSON.stringify(items)); loadSavedStarts(); }
saveStartBtn.addEventListener('click',saveCurrentStart); applyStartBtn.addEventListener('click',applySavedStart); delStartBtn.addEventListener('click',deleteSavedStart);

/* ====== モード切替 ====== */
modeChips.addEventListener('click',e=>{
  const chip=e.target.closest('.chip'); if(!chip) return; [...modeChips.children].forEach(c=>c.classList.remove('on')); chip.classList.add('on'); profile=chip.dataset.mode;
  document.getElementById('modeHint').textContent = (profile==='wheelchair') ? '車椅子：急勾配・段差（階段）を避けたルートを案内します'
                                                                             : '徒歩：最短や分かりやすさを優先します';
  if(currentRoute) getRoute();
});

/* ====== ユーティリティ ====== */
function decodePolyline(str){ let index=0,lat=0,lng=0,coordinates=[]; while(index<str.length){ let b,shift=0,result=0;
  do{b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5;}while(b>=0x20); const dlat=((result&1)?~(result>>1):(result>>1)); lat+=dlat;
  shift=0;result=0; do{b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5;}while(b>=0x20); const dlng=((result&1)?~(result>>1):(result>>1)); lng+=dlng;
  coordinates.push([lat/1e5,lng/1e5]); } return coordinates; }
function toRad2(v){return v*Math.PI/180;}
function haversine(a,b){const R=6371000; const dLat=toRad2(b.lat-a.lat), dLon=toRad2(b.lng-a.lng); const lat1=toRad2(a.lat), lat2=toRad2(b.lat);
  const s1=Math.sin(dLat/2), s2=Math.sin(dLon/2); const h=s1*s1+Math.cos(lat1)*Math.cos(lat2)*s2*s2; return 2*R*Math.asin(Math.sqrt(h));}
function pointToSegmentDistance(p,a,b){const φ=toRad2((a.lat+b.lat)/2); const x=v=>v.lng*Math.cos(φ); const A={x:x(a),y:a.lat},B={x:x(b),y:b.lat},P={x:x(p),y:p.lat};
  const ABx=B.x-A.x,ABy=B.y-A.y; const t=Math.max(0,Math.min(1,((P.x-A.x)*ABx+(P.y-A.y)*ABy)/(ABx*ABx+ABy*ABy)));
  const proj={lat:A.y+ABy*t,lng:(A.x+ABx*t)/Math.cos(φ)}; return haversine({lat:p.lat,lng:p.lng},proj);}
function distanceToPolylineMeters(latlng,poly){const pts=poly.getLatLngs(); let min=Infinity; for(let i=1;i<pts.length;i++){const d=pointToSegmentDistance(latlng,pts[i-1],pts[i]); if(d<min) min=d;} return min;}
function dirName(deg){const dirs=['北','北北東','北東','東北東','東','東南東','南東','南南東','南','南南西','南西','西南西','西','西北西','北西','北北西','北']; const idx=Math.round(((deg%360)+360)%360/22.5); return dirs[idx];}
function setNeedle(deg){ if(typeof deg!=='number'||isNaN(deg))return; const n=((deg%360)+360)%360; cmpArrow.setAttribute('transform',`rotate(${n} 60 60)`); cmpDir.textContent=dirName(n); cmpDeg.textContent=`${Math.round(n)}°`; }
/* device orientation */
if(window.DeviceOrientationEvent && DeviceOrientationEvent.requestPermission){ document.addEventListener('click',async()=>{ try{await DeviceOrientationEvent.requestPermission();}catch{} },{once:true}); }
window.addEventListener('deviceorientation',e=>{ if(e.absolute||e.webkitCompassHeading!=null){ const hdg=e.webkitCompassHeading!=null?e.webkitCompassHeading:(360-(e.alpha||0)); lastHeading=lastHeading==null?hdg:(0.8*lastHeading+0.2*hdg); setNeedle(lastHeading);} });

/* ====== 初期化 ====== */
(async function main(){
  initMap();
  loadSaved(); loadSavedStarts();
  await setStartToCurrent(true);
})();
qEl.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });
startGuideBtn.addEventListener('dblclick',stopGuidance);
</script>
</body>
</html>