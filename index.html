<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
      --ok:#25d07a;
      --danger:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}
    .overlay{
      position:absolute;left:12px;right:12px;top:12px;
      padding:16px 18px;border-radius:16px;background:var(--glass);
      border:1px solid var(--stroke);backdrop-filter:blur(6px);z-index:3
    }
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .row input{
      flex:1;min-width:0;background:rgba(255,255,255,.08);border:1px solid var(--stroke);
      color:var(--text);padding:10px 12px;border-radius:10px;outline:none
    }
    .row button{
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);
      color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer
    }
    .pill{
      position:fixed;right:12px;display:flex;flex-direction:column;gap:14px;
      bottom:18px;z-index:3
    }
    .btn{
      width:96px;height:96px;border-radius:24px;background:rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--stroke);color:var(--text);text-decoration:none;
      box-shadow:0 10px 30px rgba(0,0,0,.25)
    }
    .results{
      position:absolute;left:12px;right:12px;top:86px;
      max-height:45vh;overflow:auto;padding:8px;border-radius:12px;
      background:var(--glass);border:1px solid var(--stroke);backdrop-filter:blur(6px);
      z-index:3;display:none
    }
    .item{
      display:flex;gap:10px;align-items:flex-start;justify-content:space-between;
      padding:10px 8px;border-bottom:1px solid var(--stroke)
    }
    .item:last-child{border-bottom:none}
    .item .meta{font-size:.9rem;color:var(--muted)}
    .toast{
      position:fixed;left:16px;right:16px;bottom:16px;padding:14px 16px;
      border-radius:12px;background:#ff6b6b;color:white;border:0;display:none;z-index:5
    }
    .hidden{display:none !important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map" aria-label="map"></div>

    <div id="panel" class="overlay">
      <div class="row" style="margin-bottom:10px">
        <strong id="panel-title">Search nearby (10 km / 5 results)</strong>
        <span id="coord" style="font-variant-numeric:tabular-nums;color:var(--muted)">Lat: -- / Lng: --</span>
      </div>
      <div class="row">
        <input id="q" type="search" placeholder="e.g., ラーメン / コンビニ / カフェ" />
        <button id="btn-search">Search</button>
      </div>
    </div>

    <div id="results" class="results" aria-live="polite"></div>

    <div class="pill">
      <button id="btn-current" class="btn" title="Current">Current</button>
      <button id="btn-stop" class="btn" title="Stop">Stop</button>
      <button id="btn-dest" class="btn" title="Destination">Dest</button>
      <button id="btn-reroute" class="btn" title="Reroute">Reroute</button>
      <button id="btn-ops" class="btn" title="Ops">Ops</button>
    </div>

    <div id="toast" class="toast" role="status" aria-live="polite"></div>
  </div>

  <!-- Google Maps JS API loader (use the user's required browser key) -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&v=weekly&language=ja&region=JP&loading=async"></script>

  <!-- App code -->
  <script type="module">
    // --- constants ---
    const PROXY = "https://ors-proxy.miyata-connect-jp.workers.dev";
    const MAX_RADIUS_M = 10000; // 10km
    const MAX_RESULTS = 5;

    // --- toast helper ---
    const toast = (msg, ok=false) => {
      const el = document.getElementById('toast');
      el.style.background = ok ? "#25d07a" : "#ff6b6b";
      el.textContent = msg;
      el.style.display = "block";
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.display="none"; }, 3000);
    };

    // --- wait for maps ---
    async function waitForGoogleMaps(timeout = 15000) {
      const start = performance.now();
      while (performance.now() - start < timeout) {
        if (window.google && google.maps && google.maps.importLibrary) return true;
        await new Promise(r => setTimeout(r, 50));
      }
      throw new Error("Google Maps failed to load within timeout.");
    }

    // --- utils ---
    const toRad = (d) => d * Math.PI / 180;
    function haversineMeters(a, b){
      const R = 6371000;
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const s = Math.sin(dLat/2)**2 +
                Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*
                Math.sin(dLng/2)**2;
      return 2 * R * Math.asin(Math.sqrt(s));
    }

    // --- main ---
    let map, marker;
    let currentPos = { lat: 35.681236, lng: 139.767125 }; // fallback: Tokyo

    try {
      await waitForGoogleMaps();
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: currentPos,
        zoom: 16,
        mapId: "DEMO_MAP",
        disableDefaultUI: true,
      });

      marker = new AdvancedMarkerElement({ map, position: currentPos });

      const $coord = document.getElementById("coord");
      const setCoord = (pos) => {
        $coord.textContent = `Lat: ${pos.lat.toFixed(6)} / Lng: ${pos.lng.toFixed(6)}`;
      };
      setCoord(currentPos);

      // geolocation
      const getLocation = () => new Promise((resolve,reject)=>{
        if(!navigator.geolocation) return reject(new Error("Geolocation unsupported"));
        navigator.geolocation.getCurrentPosition(
          pos=>resolve({lat:pos.coords.latitude,lng:pos.coords.longitude}),
          err=>reject(new Error(err.message||"Location error")),
          {enableHighAccuracy:true,timeout:10000,maximumAge:0}
        );
      });

      try {
        currentPos = await getLocation();
        map.setCenter(currentPos);
        marker.position = currentPos;
        setCoord(currentPos);
        toast("Location updated", true);
      } catch(e) {
        toast(`Location error: ${e.message}`);
      }

      // UI wiring
      document.getElementById("btn-current").addEventListener("click", async ()=>{
        try{
          const p = await getLocation();
          currentPos = p;
          map.setCenter(p);
          marker.position = p;
          setCoord(p);
          toast("Centered to current position", true);
        }catch(e){ toast(`Location error: ${e.message}`); }
      });

      // search
      const $q = document.getElementById("q");
      const $btnSearch = document.getElementById("btn-search");
      const $results = document.getElementById("results");

      async function searchAround() {
        const textQuery = ($q.value || "").trim() || "ラーメン";
        const center = map.getCenter() ? { lat: map.getCenter().lat(), lng: map.getCenter().lng() } : currentPos;

        // server-side bias to 10km + limit 5
        const body = {
          textQuery,
          languageCode: "ja",
          regionCode: "JP",
          pageSize: MAX_RESULTS,
          locationBias: {
            circle: {
              center: { latitude: center.lat, longitude: center.lng },
              radius: MAX_RADIUS_M
            }
          }
        };

        const resp = await fetch(`${PROXY}/places:searchText`, {
          method: "POST",
          headers: { "Origin":"https://miyata-connect.github.io", "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });

        if (!resp.ok) {
          const t = await resp.text().catch(()=> "");
          throw new Error(`Proxy error ${resp.status}: ${t}`);
        }

        const data = await resp.json();
        const raw = Array.isArray(data.places) ? data.places : [];

        // strict client-side radius filter (<=10km), then cap 5
        const within = raw.filter(p=>{
          if (!p.location) return false;
          const d = haversineMeters(center, { lat: p.location.latitude, lng: p.location.longitude });
          p.__distance_m = d;
          return d <= MAX_RADIUS_M;
        }).sort((a,b)=> (a.__distance_m||1e12) - (b.__distance_m||1e12))
          .slice(0, MAX_RESULTS);

        renderResults(within, center);
        toast(`Found ${within.length} result(s) within 10km`, true);
      }

      function renderResults(list, center){
        if (!list.length){
          $results.innerHTML = `<div class="item"><div>No results within 10 km.</div></div>`;
          $results.style.display = "block";
          return;
        }
        $results.innerHTML = list.map(p=>{
          const name = p.displayName?.text || "(no name)";
          const addr = p.formattedAddress || "";
          const pos = p.location ? { lat:p.location.latitude, lng:p.location.longitude } : null;
          const dist = (p.__distance_m ?? (pos ? haversineMeters(center,pos) : NaN));
          const km = isFinite(dist) ? (dist/1000).toFixed(2) : "—";
          return `
            <div class="item">
              <div>
                <div><strong>${name}</strong></div>
                <div class="meta">${km} km · ${addr}</div>
              </div>
              <div>
                <button data-lat="${pos?.lat ?? ""}" data-lng="${pos?.lng ?? ""}" class="go">Go</button>
              </div>
            </div>
          `;
        }).join("");
        $results.style.display = "block";

        // bind Go buttons
        $results.querySelectorAll("button.go").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const lat = parseFloat(btn.getAttribute("data-lat"));
            const lng = parseFloat(btn.getAttribute("data-lng"));
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              const p = { lat, lng };
              map.setCenter(p);
              marker.position = p;
              toast("Moved to selection", true);
            }
          });
        });
      }

      $btnSearch.addEventListener("click", searchAround);
      $q.addEventListener("keydown", (e)=>{ if (e.key === "Enter") searchAround(); });

    } catch (e) {
      console.error(e);
      toast("Initialization error: " + e.message);
    }
  </script>
</body>
</html>
