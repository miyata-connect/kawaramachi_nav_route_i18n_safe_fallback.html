<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin>
<style>
:root{
  --bg:#0b1220;--panel:#121a2b;--fg:#e8eefc;--muted:#98a4c5;--accent:#3ea8ff;--btn:#18233b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Meiryo",sans-serif}

header{position:sticky;top:0;z-index:600;background:linear-gradient(180deg,var(--bg),#0c1527 70%);padding:10px 12px 8px}
h1{margin:0 0 10px 0;font-size:20px}

.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.search{display:flex;align-items:center;gap:6px;background:var(--panel);border:1px solid #243150;border-radius:12px;padding:6px 8px;flex:1;min-width:260px}
.search input{background:transparent;border:none;outline:none;color:var(--fg);width:100%;font-size:16px}
.icon-btn{background:var(--btn);border:1px solid #22304e;color:var(--fg);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer;white-space:nowrap}
.icon-btn:disabled{opacity:.6;cursor:not-allowed}
#mic{font-size:20px;padding:12px 14px;min-width:44px;min-height:44px;border-radius:12px}

.group{display:flex;align-items:center;gap:6px;background:#0f1a31;border:1px solid #22304e;border-radius:12px;padding:6px 8px}
.label{color:var(--muted);font-size:12px;margin-right:2px;white-space:nowrap}
.num,select{appearance:none;background:#0f1a31;border:1px solid #22304e;border-radius:10px;color:var(--fg);padding:8px 10px;font-size:14px}
.num{width:120px}
.primary{background:var(--accent);border-color:#2b7fcc;color:#031225}
.sm{font-size:13px;padding:6px 8px;border-radius:9px}

.hintRow{color:var(--muted);font-size:14px;margin-top:8px}
.status{margin-top:6px;color:#cfe2ff;font-size:14px}

#resultWrap{margin-top:6px}
.list{background:#0f172a;border:1px solid #22304e;border-radius:12px;max-height:40vh;overflow:auto;display:none}
.item{padding:10px 12px;border-top:1px solid #1a2745;cursor:pointer}
.item:first-child{border-top:none}
.item:hover{background:#121f3b}
.muted{color:var(--muted)}
.listHead{padding:8px 12px;border-bottom:1px solid #1a2745;color:#cfe2ff}

#map{height:55vh;min-height:320px;background:#0a1120;position:relative}

/* ä½ç½®å–å¾—ä¸­ã‚«ãƒãƒ¼ */
#mapCover{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
  background:rgba(6,10,20,.85);color:#cfe2ff;z-index:450;font-size:16px}

/* å³ä¸‹ã®æ“ä½œãƒœã‚¿ãƒ³ */
.floating{position:fixed;right:14px;bottom:20px;z-index:500;display:flex;flex-direction:column;gap:10px}
.fab{background:#0e162c;border:1px solid #22304e;color:var(--fg);border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;min-width:120px;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
.fab:active{transform:translateY(1px)}

/* ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ã¯å·¦ä¸‹ã€‚å¸°å±è¡¨ç¤ºã¯é‡ãªã‚‰ãªã„ã‚ˆã†ä¸Šã’ã‚‹ */
.leaflet-control-container .leaflet-bottom.leaflet-left{bottom:16px;left:12px}
.leaflet-control-zoom{border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.35)}
.leaflet-control-zoom a{width:34px;height:34px;line-height:34px;font-size:18px}

/* ğŸ‡ºğŸ‡¦ å«ã‚€å¸°å±è¡¨ç¤ºã‚’è¦‹åˆ‡ã‚‰ã›ãªã„ */
.leaflet-control-attribution{margin-bottom:96px;margin-right:8px;font-size:11px}
</style>
</head>
<body>
<header id="appHeader">
  <h1>Cloudflare Workers ãƒŠãƒ“</h1>

  <!-- æ¤œç´¢ -->
  <div class="row">
    <div class="search">
      <span>ğŸ”</span>
      <input id="q" type="search" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢â€¦" autocomplete="off">
      <button id="mic" class="icon-btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
      <button id="searchBtn" class="icon-btn">æ¤œç´¢</button>
    </div>
  </div>

  <!-- åº§æ¨™å…¥åŠ› -->
  <div class="row" style="margin-top:8px">
    <div class="group">
      <div class="label">é–‹å§‹åœ°ç‚¹ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</div>
      <input id="lon1" class="num" type="number" step="0.000001" placeholder="çµŒåº¦">
      <input id="lat1" class="num" type="number" step="0.000001" placeholder="ç·¯åº¦">
    </div>
    <div class="group">
      <div class="label">ç›®çš„åœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</div>
      <input id="lon2" class="num" type="number" step="0.000001" placeholder="çµŒåº¦">
      <input id="lat2" class="num" type="number" step="0.000001" placeholder="ç·¯åº¦">
    </div>
  </div>

  <!-- ãƒ¢ãƒ¼ãƒ‰ãƒ»è¨€èªãƒ»æ“ä½œ -->
  <div class="row" style="margin-top:8px">
    <div class="group"><div class="label">ãƒ¢ãƒ¼ãƒ‰</div>
      <select id="profile">
        <option value="foot-walking" selected>foot-walkingï¼ˆå¾’æ­©ï¼‰</option>
        <option value="wheelchair">wheelchairï¼ˆè»Šã„ã™ï¼‰</option>
      </select>
    </div>
    <div class="group"><div class="label">è¨€èª</div>
      <select id="lang">
        <option value="ja" selected>æ—¥æœ¬èª</option>
        <option value="en">è‹±èª</option>
        <option value="zh">ä¸­å›½èª</option>
        <option value="ko">éŸ“å›½èª</option>
      </select>
    </div>
    <button id="routeBtn" class="icon-btn primary">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
    <button id="clearBtn" class="icon-btn">ã‚¯ãƒªã‚¢</button>
  </div>

  <!-- è¨˜æ†¶åœ°ç‚¹ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
  <div class="row" style="margin-top:8px">
    <div class="group" style="flex:1;min-width:220px">
      <div class="label">è¨˜æ†¶åœ°ç‚¹ï¼ˆã“ã®ç«¯æœ«ã«ä¿å­˜ï¼‰</div>
      <select id="saved" style="min-width:220px;flex:1">
        <option value="">ï¼ˆæœªé¸æŠï¼‰</option>
      </select>
    </div>
    <div class="row" style="gap:6px">
      <button id="saveDestBtn" class="icon-btn sm">ç›®çš„åœ°ã‚’ä¿å­˜</button>
      <button id="useSavedBtn" class="icon-btn sm">ç›®çš„åœ°ã«è¨­å®š</button>
      <button id="delSavedBtn" class="icon-btn sm" title="é¸æŠã—ãŸè¨˜æ†¶åœ°ç‚¹ã‚’å‰Šé™¤">å‰Šé™¤</button>
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <button id="saveHereBtn" class="icon-btn sm">ç¾åœ¨åœ°ã‚’ä¿å­˜</button>
    <div class="hintRow">åœ°å›³ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ç›®çš„åœ°ã«è¨­å®šã§ãã¾ã™</div>
  </div>

  <div id="statusText" class="status">æº–å‚™å®Œäº†ã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>

  <!-- æ¤œç´¢çµæœ -->
  <div id="resultWrap"><div id="list" class="list"></div></div>
</header>

<div id="map">
  <div id="mapCover">ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦</div>
</div>

<!-- å³ä¸‹ã®æ“ä½œ -->
<div class="floating">
  <button id="guideBtn" class="fab">æ¡ˆå†…é–‹å§‹</button>
  <button id="locBtn" class="fab">ç¾åœ¨åœ°</button>
  <button id="dstBtn" class="fab">ç›®çš„åœ°</button>
  <button id="rerouteBtn" class="fab">ãƒªãƒ«ãƒ¼ãƒˆ</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin></script>
<script>
/* ========= è¨­å®š ========= */
const WORKER_URL = 'https://ors-proxy.miyata-connect-jp.workers.dev';
const ORS_ENDPOINT = WORKER_URL + '/proxy';
const LANG_SPEECH = { ja:'ja-JP', en:'en-US', zh:'zh-CN', ko:'ko-KR' };

/* ========= è¦ç´ /çŠ¶æ…‹ ========= */
const $ = s => document.querySelector(s);
const status = t => $('#statusText').textContent = t;

let map, youMarker, accCircle, destMarker, routeLine;
let routePoints = [], routeSteps = [];
let lastPos = null, watchId = null;
let isGuiding = false;
let stepStage = {};           // æ›²ãŒã‚Šæ¡ˆå†…æ®µéšç®¡ç†
let lastNearestIdx = 0;       // é€²æ—
let onRoute = false;
let lastReroutePromptAt = 0;

const PRE_ANNOUNCE = 35;  // m ã§ã€Œã¾ã‚‚ãªãã€
const NEAR_ANNOUNCE = 10; // m ã§å†å‘ŠçŸ¥
const ON_THRESH = 12;     // 12mä»¥å†…ã§ã‚ªãƒ³ãƒ«ãƒ¼ãƒˆ
const OFF_THRESH = 25;    // 25mä»¥ä¸Šã§ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆ
const REROUTE_COOLDOWN = 20000; // 20ç§’
let selectDestMode = false, audioCtx;

/* ========= ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè£œæ­£ ========= */
function setMapHeight(){
  const header = document.getElementById('appHeader');
  const bottom = header.getBoundingClientRect().bottom;
  let h = Math.floor(window.innerHeight - bottom);
  if(!Number.isFinite(h) || h < 240) h = Math.max(240, Math.round(window.innerHeight*0.55));
  const el = document.getElementById('map');
  el.style.height = h + 'px';
}
function invalidateMapSoon(){
  setMapHeight();
  if(map){ setTimeout(()=> map.invalidateSize(true), 100); }
}
window.addEventListener('resize', invalidateMapSoon);
window.addEventListener('orientationchange', invalidateMapSoon);

/* ========= åœ°å›³/ä½ç½® ========= */
function initMap(){
  setMapHeight();
  map = L.map('map', { zoomControl:false });
  L.control.zoom({ position:'bottomleft' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  // ã¾ãšã¯ä¸–ç•Œä¿¯ç°ï¼ˆã‚«ãƒãƒ¼ã§éš ã™ã®ã§ãƒãƒ©ã¤ãã‚’æŠ‘åˆ¶ï¼‰
  map.setView([0,0], 2);

  if('geolocation' in navigator){
    navigator.geolocation.getCurrentPosition(p=>{
      const {latitude,longitude,accuracy}=p.coords;
      lastPos={lat:latitude,lng:longitude,accuracy};
      setStartFields(lastPos);
      showYou(lastPos);
      map.setView([latitude,longitude], 17);
      document.getElementById('mapCover').style.display='none';
      invalidateMapSoon();
    },()=>{
      status('ç¾åœ¨åœ°ã¯è¨±å¯ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ'); document.getElementById('mapCover').style.display='none'; invalidateMapSoon();
    },{enableHighAccuracy:true,timeout:8000,maximumAge:30000});
  }else{
    document.getElementById('mapCover').style.display='none';
    status('ä½ç½®æƒ…å ±ã«æœªå¯¾å¿œã®ç«¯æœ«ã§ã™');
  }

  map.on('click', e=>{ if(selectDestMode){ setDestination(e.latlng,true); selectDestMode=false; }});
  map.on('contextmenu', e=> setDestination(e.latlng,true));

  new ResizeObserver(invalidateMapSoon).observe(document.getElementById('appHeader'));
}

function metersBetween(a,b){
  const R=6371000, dLat=(b.lat-a.lat)*Math.PI/180, dLon=(b.lng-a.lng)*Math.PI/180;
  const lat1=a.lat*Math.PI/180, lat2=b.lat*Math.PI/180;
  const x=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(x));
}
function pointToSegDist(p, a, b){
  const x0=p.lng,y0=p.lat,x1=a.lng,y1=a.lat,x2=b.lng,y2=b.lat;
  const A={x:x0-x1,y:y0-y1}, B={x:x2-x1,y:y2-y1};
  const t=Math.max(0,Math.min(1,(A.x*B.x + A.y*B.y)/(B.x*B.x + B.y*B.y)));
  const proj={lng:x1+t*B.x, lat:y1+t*B.y};
  return metersBetween({lat:y0,lng:x0},{lat:proj.lat,lng:proj.lng});
}
function nearestOnRoute(p, line){
  let min=Infinity, idx=0;
  for(let i=1;i<line.length;i++){
    const d = pointToSegDist(p,line[i-1],line[i]);
    if(d<min){min=d; idx=i;}
  }
  return {dist:min, idx};
}
function decodePolyline(str, precision=6){
  let index=0, lat=0, lng=0, coords=[], shift=0, result=0, b=0, factor=Math.pow(10,precision);
  while(index<str.length){
    shift=0; result=0; do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5 }while(b>=0x20);
    lat += ((result&1)?~(result>>1):(result>>1));
    shift=0; result=0; do{ b=str.charCodeAt(index++)-63; result|=(b&0x1f)<<shift; shift+=5 }while(b>=0x20);
    lng += ((result&1)?~(result>>1):(result>>1));
    coords.push({lat:lat/factor,lng:lng/factor});
  } return coords;
}

function beep(ms=120,freq=880){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type='sine'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
    g.gain.setValueAtTime(0.12,audioCtx.currentTime); o.start(); o.stop(audioCtx.currentTime+ms/1000);
  }catch{}
}
function speak(text, lang){
  if(!('speechSynthesis' in window)) return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang = ({ja:'ja-JP',en:'en-US',zh:'zh-CN',ko:'ko-KR'})[lang] || 'ja-JP';
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}

function showYou(pos){
  if(!youMarker){
    youMarker=L.marker([pos.lat,pos.lng],{title:'ç¾åœ¨åœ°'}).addTo(map);
    accCircle=L.circle([pos.lat,pos.lng],{radius:pos.accuracy||20,color:'#3ea8ff',fillColor:'#3ea8ff',fillOpacity:.15}).addTo(map);
  }else{
    youMarker.setLatLng([pos.lat,pos.lng]);
    accCircle.setLatLng([pos.lat,pos.lng]).setRadius(pos.accuracy||20);
  }
}
function ensureWatch(){
  if(watchId!=null) return;
  if(!('geolocation' in navigator)){ status('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«æœªå¯¾å¿œ'); return; }
  watchId = navigator.geolocation.watchPosition(p=>{
    lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
    showYou(lastPos); if(!$('#lat1').value || !$('#lon1').value) setStartFields(lastPos);
    if(isGuiding) guideTick();
  }, err=> status('ä½ç½®å–å¾—ã«å¤±æ•—: '+err.message),
  {enableHighAccuracy:true,maximumAge:3000,timeout:10000});
}
function clearWatch(){ if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } }

function setStartFields(latlng){ $('#lat1').value=latlng.lat.toFixed(6); $('#lon1').value=latlng.lng.toFixed(6); }
function setDestination(latlng, autoGuide=false){
  if(!destMarker){
    destMarker=L.marker(latlng,{draggable:true}).addTo(map);
    destMarker.on('dragend',()=>{ const p=destMarker.getLatLng(); $('#lon2').value=p.lng.toFixed(6); $('#lat2').value=p.lat.toFixed(6); });
  }else destMarker.setLatLng(latlng);
  $('#lon2').value=latlng.lng.toFixed(6); $('#lat2').value=latlng.lat.toFixed(6);
  status('ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸ');

  if(autoGuide){ autoRouteAndGuide(); }
}

/* ========= ãƒ«ãƒ¼ãƒˆ ========= */
async function requestRoute(){
  const profile=$('#profile').value, lang=$('#lang').value||'ja';
  const start=getStart(), goal=getGoal();
  if(!start || !goal){ status('é–‹å§‹/ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™'); return false; }
  status('ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦');
  const body={coordinates:[[+start.lng,+start.lat],[+goal.lng,+goal.lat]],instructions:true,language:lang};
  try{
    const res=await fetch(`${ORS_ENDPOINT}?profile=${encodeURIComponent(profile)}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const data=await res.json(); if(!res.ok) throw new Error(data?.message||data?.error||res.statusText);
    drawRoute(data);
    status('HTTP 200 / æˆåŠŸ');
    return true;
  }catch(e){ console.error(e); status('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—: '+String(e.message||e)); return false; }
}
function drawRoute(data){
  const route=data.routes?.[0]; if(!route){ status('ãƒ«ãƒ¼ãƒˆãªã—'); return; }
  routePoints=decodePolyline(route.geometry,6);
  routeSteps=(route.segments?.[0]?.steps)||[];
  if(routeLine){ routeLine.remove(); }
  routeLine=L.polyline(routePoints,{color:'#30b4ff',weight:6,opacity:.85}).addTo(map);
  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});

  // ãƒªã‚»ãƒƒãƒˆ
  stepStage={}; onRoute=false; lastNearestIdx=0;
}

/* ========= æ¡ˆå†… ========= */
function nextTurnFromIndex(currIdx){
  for(let i=0;i<routeSteps.length;i++){
    const st=routeSteps[i];
    const idx=st.way_points?.[1];
    if(typeof idx==='number' && idx>currIdx) return {index:i, step:st, idx, latlng:routePoints[idx]};
  } return null;
}
function turnSpeech(step){
  const s=step?.instruction||''; let dir='';
  if(s.includes('å³')) dir='å³';
  else if(s.includes('å·¦')) dir='å·¦';
  const name=(step?.name && step.name!=='-')? step.name : 'ã“ã®é€šã‚Š';
  if(dir) return `${name}ã‚’${dir}ã§ã™`;
  if(s.includes('ç›´é€²')||s.includes('ãã®ã¾ã¾')) return 'ãã®ã¾ã¾ç›´é€²ã§ã™';
  return s||'ãã®ã¾ã¾ç›´é€²ã§ã™';
}

function guideTick(){
  if(!lastPos || routePoints.length<2) return;

  const near = nearestOnRoute(lastPos, routePoints);

  // ã‚ªãƒ³/ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆåˆ¤å®šï¼ˆãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼‰
  if(near.dist <= ON_THRESH){ onRoute=true; }
  else if(near.dist >= OFF_THRESH){
    if(onRoute){
      const now=Date.now();
      if(now - lastReroutePromptAt > REROUTE_COOLDOWN){
        lastReroutePromptAt = now;
        status('é€šã‚Šéãã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ã€Œãƒªãƒ«ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„');
        speak('é€šã‚Šéãã¾ã—ãŸã€‚å¿…è¦ãªã‚‰ãƒªãƒ«ãƒ¼ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚',$('#lang').value);
        beep(140,740);
      }
    }
    onRoute=false;
  }

  // æ›²ãŒã‚Šæ¡ˆå†…
  const next = nextTurnFromIndex(near.idx);
  if(next){
    const dist = metersBetween(lastPos, next.latlng);
    const idx  = next.index;
    const stage = stepStage[idx] || 'none';
    const text = turnSpeech(next.step);

    if(dist <= 5 && stage !== 'at'){
      stepStage[idx]='at';
      beep(140,900); speak(text,$('#lang').value);
      status(text+'ï¼ˆ0mï¼‰');
    }else if(dist <= NEAR_ANNOUNCE && stage==='far'){
      stepStage[idx]='near';
      beep(120,820); speak('ã¾ã‚‚ãªãã€'+text,$('#lang').value);
      status('ã¾ã‚‚ãªã '+text+`ï¼ˆç´„${Math.round(dist)}mï¼‰`);
    }else if(dist <= PRE_ANNOUNCE && stage==='none'){
      stepStage[idx]='far';
      status('æ¬¡ã®æ¡ˆå†…ï¼š'+text+`ï¼ˆç´„${Math.round(dist)}mï¼‰`);
    }else if(dist > PRE_ANNOUNCE && stage!=='none'){
      if(stage==='near') stepStage[idx]='far';
    }
  }

  if(near.idx >= lastNearestIdx) lastNearestIdx = near.idx;
}

/* ãƒœã‚¿ãƒ³ï¼šæ¡ˆå†…é–‹å§‹ */
async function guideStart(){
  // ç¾åœ¨åœ°ã‚’ä¸€åº¦å¼·åˆ¶å–å¾—ï¼ˆæ¡ˆå†…é–‹å§‹ã—ãªã„å•é¡Œã®äºˆé˜²ï¼‰
  if(!lastPos && 'geolocation' in navigator){
    try{
      const p = await new Promise((ok,ng)=> navigator.geolocation.getCurrentPosition(ok,ng,{enableHighAccuracy:true,timeout:8000}));
      lastPos={lat:p.coords.latitude,lng:p.coords.longitude,accuracy:p.coords.accuracy};
      showYou(lastPos); setStartFields(lastPos);
    }catch{}
  }
  // ãƒ«ãƒ¼ãƒˆãŒç„¡ã‘ã‚Œã°å–å¾—
  if(routePoints.length<2){
    const ok = await requestRoute();
    if(!ok) return false;
  }
  // ç›£è¦–é–‹å§‹
  ensureWatch();
  isGuiding = true;
  $('#guideBtn').textContent='æ¡ˆå†…åœæ­¢';
  speak('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™',$('#lang').value);

  // ä¸€åº¦ä¿¯ç°ã‚’è¦‹ã›ã¦ã‹ã‚‰ç¾åœ¨åœ°ã¸æˆ»ã‚‹ï¼ˆ0.9ç§’å¾Œï¼‰
  if(routeLine){
    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
    setTimeout(()=>{ if(lastPos) map.setView([lastPos.lat,lastPos.lng], 18); }, 900);
  }
  status('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
  return true;
}
function guideStop(){
  clearWatch(); isGuiding=false;
  $('#guideBtn').textContent='æ¡ˆå†…é–‹å§‹';
  status('æ¡ˆå†…ã‚’åœæ­¢ã—ã¾ã—ãŸ');
}

/* ç›®çš„åœ°è¨­å®š â†’ è‡ªå‹•ã§ãƒ«ãƒ¼ãƒˆï¼‹ä¿¯ç°â†’ç¾åœ¨åœ°â†’æ¡ˆå†…é–‹å§‹ */
async function autoRouteAndGuide(){
  const ok = await requestRoute();
  if(!ok) return;
  // ä¿¯ç°ã¯ drawRoute å†…ã§å®Ÿæ–½ã€å°‘ã—å¾…ã£ã¦ç¾åœ¨åœ°ã¸æˆ»ã‚Šã¤ã¤ã‚¬ã‚¤ãƒ‰
  setTimeout(()=>{ if(lastPos) map.setView([lastPos.lat,lastPos.lng], 18); }, 900);
  await guideStart();
}

/* ========= æ¤œç´¢ï¼ˆå‘¨è¾ºå„ªå…ˆãƒ»ä¸Šä½5ï¼‰ ========= */
function buildListHeader(text){ return `<div class="listHead">${text}</div>`; }
function uniqByLatLon(items){
  const seen=new Set(); const out=[];
  for(const it of items){
    const key = `${(+it.lon).toFixed(5)},${(+it.lat).toFixed(5)}`;
    if(!seen.has(key)){ seen.add(key); out.push(it); }
  } return out;
}
async function searchPhoton(q, lang){
  const bias = (lastPos ? `&lat=${lastPos.lat}&lon=${lastPos.lng}` : '');
  const url=`https://photon.komoot.io/api/?q=${encodeURIComponent(q)}${bias}&lang=${encodeURIComponent(lang)}&limit=30`;
  const res=await fetch(url,{headers:{'Accept':'application/json'}});
  const data=await res.json();
  const arr=(data?.features||[]).map(f=>{
    const [lon,lat]=f.geometry.coordinates, p=f.properties||{};
    const name=[p.name,p.street,p.housenumber,p.city,p.country].filter(Boolean).join(' ') || p.label || '(åç§°ä¸æ˜)';
    return {name,lon,lat,kind:p.osm_value||p.osm_key||''};
  });
  return arr;
}
async function searchNominatim(q, lang){
  const headers={'Accept':'application/json','Accept-Language':lang};
  const bbox = lastPos ? `&viewbox=${lastPos.lng-0.2},${lastPos.lat+0.2},${lastPos.lng+0.2},${lastPos.lat-0.2}&bounded=1` : '';
  const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&limit=30&addressdetails=1&extratags=1&namedetails=1&q=${encodeURIComponent(q)}${bbox}`;
  const res=await fetch(url,{headers});
  const data=await res.json();
  const arr=(data||[]).map(r=>{
    const name=r.display_name || r.name || '(åç§°ä¸æ˜)';
    return {name,lon:+r.lon,lat:+r.lat,kind:r.category||r.type||''};
  });
  return arr;
}
async function doSearch(){
  const q=$('#q').value.trim();
  const langVal=$('#lang').value||'ja';
  const phoneLike=/[\d-+]{6,}/.test(q);
  $('#list').style.display='block';
  $('#list').innerHTML=buildListHeader('æ¤œç´¢çµæœ')+'<div class="item muted">æ¤œç´¢ä¸­â€¦</div>';
  invalidateMapSoon();

  try{
    let results = q ? await searchPhoton(q, langVal) : [];
    if(phoneLike || results.length < 3){
      const extra = await searchNominatim(q || 'poi', langVal);
      results = uniqByLatLon(results.concat(extra));
    }else{
      results = uniqByLatLon(results);
    }
    if(lastPos){
      results.forEach(r=> r.__dist = metersBetween(lastPos,{lat:r.lat,lng:r.lon}));
      results.sort((a,b)=> (a.__dist||1e12)-(b.__dist||1e12));
    }
    results = results.slice(0,5);

    if(!results.length){
      $('#list').innerHTML=buildListHeader('æ¤œç´¢çµæœ')+'<div class="item muted">è©²å½“ãªã—</div>';
      status('è©²å½“ãªã—'); return;
    }

    const head = buildListHeader(lastPos ? 'è¿‘ã„é †ï¼ˆä¸Šä½5ä»¶ï¼‰' : 'æ¤œç´¢çµæœï¼ˆä¸Šä½5ä»¶ï¼‰');
    $('#list').innerHTML = head + results.map(r=>{
      const dist=(r.__dist!=null)? ` â€” ç´„${Math.round(r.__dist)}m` : '';
      return `<div class="item" data-lat="${r.lat}" data-lon="${r.lon}">
        <div>${r.name}</div>
        <div class="muted">${r.kind||''}ã€€<span>${r.lon.toFixed(5)}, ${r.lat.toFixed(5)}${dist}</span></div>
      </div>`;
    }).join('');

    $('#list').querySelectorAll('.item').forEach(el=>{
      el.addEventListener('click',()=>{
        const lat=+el.dataset.lat, lon=+el.dataset.lon;
        setDestination({lat,lng:lon}, true); // â† è‡ªå‹•æ¡ˆå†…ã¸
        $('#list').style.display='none';
        invalidateMapSoon();
      });
    });
  }catch(e){
    $('#list').innerHTML=buildListHeader('æ¤œç´¢çµæœ')+`<div class="item">æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ${String(e.message||e)}</div>`;
  }
}

/* ========= ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ä»– ========= */
const LS_KEY='cw_nav_saved_places_v1';
function loadSavedPlaces(){
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const sel=$('#saved'); sel.innerHTML='<option value="">ï¼ˆæœªé¸æŠï¼‰</option>';
  arr.forEach((p,i)=>{
    const opt=document.createElement('option');
    opt.value=String(i); opt.textContent=`${p.name}ï¼ˆ${p.lon.toFixed(5)}, ${p.lat.toFixed(5)}ï¼‰`;
    sel.appendChild(opt);
  });
}
function savePlace(name, lat, lon){
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  arr.push({name, lat, lon, savedAt:Date.now()});
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
  loadSavedPlaces();
}

/* ========= ã‚¤ãƒ™ãƒ³ãƒˆ ========= */
$('#routeBtn').addEventListener('click', requestRoute);
$('#rerouteBtn').addEventListener('click', async ()=>{ if(await requestRoute()){ onRoute=false; lastNearestIdx=0; } });
$('#clearBtn').addEventListener('click', ()=>{
  if(routeLine){ routeLine.remove(); routeLine=null; }
  routePoints=[]; routeSteps=[]; stepStage={}; onRoute=false; lastNearestIdx=0;
  $('#q').value=''; $('#list').style.display='none'; $('#list').innerHTML='';
  status('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„'); invalidateMapSoon();
});
$('#locBtn').addEventListener('click', ()=>{ ensureWatch(); if(lastPos) map.setView([lastPos.lat,lastPos.lng],18); });
$('#dstBtn').addEventListener('click', ()=>{ selectDestMode=true; status('åœ°å›³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç›®çš„åœ°ã‚’è¨­å®š'); setTimeout(()=>{selectDestMode=false},7000); });
$('#searchBtn').addEventListener('click', doSearch);
$('#q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

$('#guideBtn').addEventListener('click', async ()=>{
  if(!isGuiding){ await guideStart(); } else { guideStop(); }
});

$('#saveHereBtn').addEventListener('click', ()=>{
  if(!lastPos){ alert('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“'); return; }
  const name = prompt('ç¾åœ¨åœ°ã«åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ï¼š','ãƒã‚¤åœ°ç‚¹');
  if(!name) return;
  savePlace(name, lastPos.lat, lastPos.lng);
  status(`ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
});
$('#saveDestBtn').addEventListener('click', ()=>{
  const g=getGoal(); if(!g){ alert('ç›®çš„åœ°ãŒæœªè¨­å®šã§ã™'); return; }
  const name = prompt('ç›®çš„åœ°ã«åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜ã—ã¾ã™ï¼š','ç›®çš„åœ°');
  if(!name) return;
  savePlace(name, g.lat, g.lng);
  status(`ç›®çš„åœ°ã€Œ${name}ã€ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
});
$('#useSavedBtn').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const idx = $('#saved').value; if(idx===''){ alert('è¨˜æ†¶åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const p = arr[+idx]; if(!p) return;
  setDestination({lat:p.lat,lng:p.lon}, true);
  $('#list').style.display='none'; invalidateMapSoon();
});
$('#delSavedBtn').addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  const idx = $('#saved').value; if(idx===''){ alert('å‰Šé™¤ã™ã‚‹è¨˜æ†¶åœ°ç‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const p = arr[+idx];
  if(!confirm(`é¸æŠã—ãŸè¨˜æ†¶åœ°ç‚¹ã€Œ${p?.name||'åœ°ç‚¹'}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;
  arr.splice(+idx,1);
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
  loadSavedPlaces(); status(`ã€Œ${p?.name||'åœ°ç‚¹'}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
});

/* ========= è£œåŠ© ========= */
function getStart(){
  const lon=parseFloat($('#lon1').value), lat=parseFloat($('#lat1').value);
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon};
  if(lastPos) return lastPos; return null;
}
function getGoal(){
  const lon=parseFloat($('#lon2').value), lat=parseFloat($('#lat2').value);
  if(Number.isFinite(lat)&&Number.isFinite(lon)) return {lat,lng:lon};
  if(destMarker) return destMarker.getLatLng(); return null;
}

/* ========= ãƒã‚¤ã‚¯ ========= */
(function setupMic(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition, mic=$('#mic');
  if(!SR){ mic.style.display='none'; return; }
  const rec=new SR();
  const setRecLang=()=> rec.lang = LANG_SPEECH[$('#lang').value||'ja'] || 'ja-JP';
  setRecLang(); $('#lang').addEventListener('change', setRecLang);
  rec.interimResults=false; rec.maxAlternatives=1;
  mic.addEventListener('click',()=>{ try{rec.start();}catch{} status('éŸ³å£°ã‚’èãå–ã£ã¦ã„ã¾ã™â€¦'); });
  rec.onresult=e=>{ const text=e.results[0][0].transcript; $('#q').value=text; status('éŸ³å£°å…¥åŠ›ï¼š'+text); doSearch(); };
  rec.onerror=e=>status('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼ï¼š'+(e.error||'')); })();

/* ========= èµ·å‹• ========= */
(function boot(){
  loadSavedPlaces();
  initMap();
})();
</script>
</body>
</html>