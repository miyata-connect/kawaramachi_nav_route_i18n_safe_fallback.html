<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ISSUE: idx202511012115（発行番号） -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x-issue" content="idx202511012115">
  <title>WalkNav</title>
  <style>
    :root{
      --glass: rgba(20,28,44,.82);
      --glass-strong: rgba(16,22,36,.92);
      --stroke: rgba(255,255,255,.14);
      --text: #eaf2ff;
      --muted:#a7b8ce;
      --primary:#5fb1ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --accent:#64d2ff;
      --shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}

    /* ---------- レイヤ順序（被り防止の固定表） ---------- */
    /* 900: トースト/ダイアログ（下部のみ表示） */
    /* 800: 検索パネル */
    /* 740: 右側の丸ボタン群（FAB） */
    /* 100: マップ */
    #map{position:absolute;inset:0;z-index:100}

    /* 検索パネル（左上） */
    .panel{
      position:absolute;left:14px;top:14px;right:auto;max-width:min(560px,92vw);
      background:linear-gradient(180deg, var(--glass), var(--glass-strong));
      border:1px solid var(--stroke);border-radius:22px;padding:18px 18px 14px;
      box-shadow:var(--shadow);backdrop-filter: blur(10px);
      z-index:800; pointer-events:auto;
    }
    .title{font-weight:800;font-size:28px;letter-spacing:.02em;margin:0 0 10px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:10px 0}
    .seg{display:flex;gap:10px}
    .seg .pill{
      padding:10px 16px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);color:var(--text);font-weight:700;min-width:74px;text-align:center;
    }
    .seg .pill.active{background:#5fb1ff;color:#0b1b2f;border-color:transparent}
    .input{
      flex:1;min-width:260px;height:44px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.12);padding:0 14px;color:var(--text);outline:none;
    }
    .btn{
      height:44px;border-radius:14px;border:1px solid var(--stroke);
      background:rgba(255,255,255,.1);padding:0 18px;color:var(--text);font-weight:800;
      display:inline-flex;align-items:center;justify-content:center;gap:8px;cursor:pointer;
      box-shadow:0 8px 24px rgba(0,0,0,.25)
    }
    .btn.primary{background:#5fb1ff;color:#0b1b2f;border-color:transparent}
    .btn.danger{background:#ff6565;color:#2a0f12;border-color:transparent}
    .hint{font-size:14px;color:var(--muted)}
    .coord{
      margin-top:10px;background:rgba(10,19,33,.85);border:1px solid var(--stroke);border-radius:14px;padding:10px 14px
    }

    /* 右側の丸ボタン群（FAB） */
    .fab-col{
      position:absolute;right:14px;bottom:14px;display:flex;flex-direction:column;gap:14px;z-index:740
    }
    .fab{
      width:138px;height:64px;border-radius:18px;background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.06));
      border:1px solid var(--stroke);backdrop-filter: blur(8px);color:var(--text);font-weight:800;box-shadow:var(--shadow);
      display:flex;align-items:center;justify-content:center
    }

    /* 下部トースト（画面下＝パネルと干渉しない） */
    .toast{
      position:absolute;left:14px;right:14px;bottom:8px;z-index:900;
      display:flex;align-items:center;gap:12px;
    }
    .toast .bubble{
      flex:1;min-height:40px;border-radius:12px;background:rgba(20,28,44,.9);border:1px solid var(--stroke);
      display:flex;align-items:center;padding:8px 12px;font-size:14px;color:var(--text)
    }

    /* 現在地マーカー（波紋付き） */
    .pulse{
      position:absolute;width:24px;height:24px;border-radius:50%;transform:translate(-50%,-50%);
      background:#2689ff;border:3px solid #fff
    }
    .pulse::after{
      content:"";position:absolute;left:50%;top:50%;width:12px;height:12px;border-radius:50%;transform:translate(-50%,-50%);
      background:#0b1b2f;opacity:.9
    }
    .wave{
      position:absolute;left:50%;top:50%;width:12px;height:12px;border-radius:50%;transform:translate(-50%,-50%);
      box-shadow:0 0 0 0 rgba(38,137,255,.45);animation:wave 2s infinite
    }
    @keyframes wave{0%{box-shadow:0 0 0 0 rgba(38,137,255,.45)}70%{box-shadow:0 0 0 26px rgba(38,137,255,0)}100%{box-shadow:0 0 0 0 rgba(38,137,255,0)}}

    /* モバイル安全域 */
    @supports (padding: env(safe-area-inset-bottom)){
      .toast{padding-bottom:calc(env(safe-area-inset-bottom))}
      .fab-col{bottom:calc(14px + env(safe-area-inset-bottom))}
    }

    /* 初期ブロッカー（ロード完了で自動解除） */
    .blocker{position:absolute;inset:0;z-index:730;pointer-events:none}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <!-- 透明ブロッカー：mapReadyで確実撤去（被り防止） -->
    <div id="uiBlocker" class="blocker"></div>

    <!-- 検索パネル（点数UIは完全削除済み） -->
    <section class="panel" aria-label="検索パネル">
      <h1 class="title">近くを検索（10km / 5件）</h1>

      <div class="row">
        <div class="seg">
          <button class="pill active" data-radius="10000">10km</button>
          <button class="pill" data-radius="20000">20km</button>
        </div>
      </div>

      <div class="row">
        <input id="q" class="input" type="text" inputmode="search" placeholder="店舗名・電話番号・住所・座標など">
        <button id="btnText" class="btn primary">入力検索</button>
      </div>

      <div class="row">
        <button id="btnVoice" class="btn">音声検索</button>
        <button id="btnReset" class="btn danger">リセット</button>
      </div>

      <div id="coord" class="coord">現在地： <span id="lat">--</span> / <span id="lng">--</span></div>
      <div class="hint">※ マップエラーは画面に表示しません（ログのみ）。</div>
    </section>

    <!-- 右側のボタン群（FAB） -->
    <div class="fab-col" aria-label="操作ボタン">
      <button id="btnHere" class="fab">現在地</button>
      <button id="btnPause" class="fab">一時停止</button>
      <button id="btnReroute" class="fab">リルート</button>
    </div>

    <!-- 画面下トースト（情報のみ） -->
    <div class="toast"><div id="toast" class="bubble">現在地取得中です。ご迷惑をお掛けします。現在地表示まで30秒程度お待ちください。</div></div>
  </div>

  <script>
  // ===== 発行番号（JS側にも保持） =====
  const ISSUE_ID = "idx202511012115";

  // ====== Google Maps 初期化 ======
  let map, meMarker, meWave, currentPos=null, distance=10000;

  function logSilent(...args){ try{ console.debug("[WalkNav]", ...args);}catch(_){} }

  function showToast(msg){
    const el=document.getElementById('toast');
    if(!el) return;
    el.textContent = msg;
  }

  function setCoords(p){
    document.getElementById('lat').textContent = p ? p.lat.toFixed(6) : '--';
    document.getElementById('lng').textContent = p ? p.lng.toFixed(6) : '--';
  }

  function readyUI(){
    // 透明ブロッカー除去（被り防止の最終保険）
    const b=document.getElementById('uiBlocker');
    if(b){ b.remove(); }
  }

  function placeMeMarker(pos){
    if(!map) return;
    if(!meMarker){
      const div=document.createElement('div');
      div.className='pulse';
      const wave=document.createElement('div');
      wave.className='wave';
      div.appendChild(wave);
      meWave=wave;
      meMarker = new google.maps.marker.AdvancedMarkerElement({
        map, position: pos, content: div, zIndex: 600
      });
    }else{
      meMarker.position = pos;
    }
  }

  function fitWithBottomPadding(pos){
    // パネル高さ＋安全余白分だけ下にオフセットして表示（マーカーが隠れない）
    const panel=document.querySelector('.panel');
    const px = (panel? panel.getBoundingClientRect().height : 0) + 60; // 60px 余白
    const scale = Math.pow(2, map.getZoom());
    const worldPoint = map.getProjection().fromLatLngToPoint(pos);
    const pixelOffsetY = px/scale;
    const target = new google.maps.Point(worldPoint.x, worldPoint.y - pixelOffsetY);
    const latlng = map.getProjection().fromPointToLatLng(target);
    map.setZoom(18);
    map.setCenter(latlng);
  }

  function initMap(){
    try{
      map = new google.maps.Map(document.getElementById('map'), {
        center:{lat:35.0,lng:135.0}, zoom:17, mapId:'4504f8b37365c3d0', clickableIcons:true,
        gestureHandling:'greedy', disableDefaultUI:true
      });

      // 位置取得（初期値は現在地一択・非表示でも可）
      if(navigator.geolocation){
        const opt={enableHighAccuracy:true,timeout:30000,maximumAge:0};
        navigator.geolocation.getCurrentPosition((p)=>{
          currentPos = {lat:p.coords.latitude, lng:p.coords.longitude};
          setCoords(currentPos);
          placeMeMarker(currentPos);
          // プロジェクション有効化待ち
          google.maps.event.addListenerOnce(map, 'projection_changed', ()=>{
            fitWithBottomPadding(currentPos);
          });
          showToast(`現在地：${currentPos.lat.toFixed(6)}, ${currentPos.lng.toFixed(6)}`);
          readyUI();
        }, (_err)=>{
          // 画面にエラーは出さない（トーストは情報文言のみ）
          showToast("現在地の取得に時間がかかっています。");
          readyUI();
        }, opt);
      }else{
        showToast("現在地取得に対応していない端末です。");
        readyUI();
      }

    }catch(e){
      // Google の白い警告は出さない。ここで握りつぶし、画面は静かに維持。
      logSilent("map init error", e);
      showToast("地図の準備をしています。しばらくお待ちください。");
      readyUI();
    }
  }

  // ====== UIイベント ======
  document.addEventListener('click', (ev)=>{
    const t=ev.target;
    if(t.matches('.pill')){
      document.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
      t.classList.add('active');
      distance = Number(t.getAttribute('data-radius'))||10000;
      logSilent("半径", distance);
    }
    if(t.id==='btnReset'){
      document.getElementById('q').value='';
      showToast('入力をリセットしました。');
    }
    if(t.id==='btnHere' && currentPos){
      fitWithBottomPadding(currentPos);
      showToast(`現在地へ移動しました。`);
    }
    if(t.id==='btnText'){
      const q=document.getElementById('q').value.trim();
      if(!q){ showToast('検索語を入力してください。'); return; }
      // ここでは UI 実行のみ（検索システム本線には触れない）
      logSilent("テキスト検索:", q, "半径:", distance);
      showToast('検索を実行しました。');
    }
    if(t.id==='btnVoice'){
      // 画面にエラーは出さない方針。対応端末のみ軽く案内して何もしない。
      if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)){
        showToast('音声検索に対応していない端末です。');
        return;
      }
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec=new SR(); rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onresult=(e)=>{ const txt=e.results[0][0].transcript||''; document.getElementById('q').value=txt; showToast('音声をテキスト化しました。'); };
      rec.onerror=()=>{ showToast('音声の取得に失敗しました。'); };
      rec.start();
      showToast('音声入力を開始しました。');
    }
  }, {passive:true});

  window.addEventListener('DOMContentLoaded', initMap);
  </script>

  <!-- Google Maps（ユーザー指定のブラウザAPIキーを使用） -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&libraries=marker"></script>
</body>
</html>