<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WalkNav</title>
  <style>
    :root{
      --bg:#0a1321;
      --text:#eaf2ff;
      --muted:#a7b8ce;
      --accent:#5fb1ff;
      --glass: rgba(20,28,44,.78);
      --stroke: rgba(255,255,255,.12);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0;display:none}
    .loading{
      position:absolute;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;
    }
    .spinner{
      width:48px;height:48px;border-radius:50%;
      border:3px solid rgba(255,255,255,.2);
      border-top-color:#fff;animation:spin 1s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .pulse{
      position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:14px;height:14px;border-radius:50%;background:#ff3b3b;border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.2)
    }
    .pulse::after{
      content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:14px;height:14px;border-radius:50%;border:2px solid rgba(255,59,59,.7);
      animation:ripple 1.8s ease-out infinite;
    }
    @keyframes ripple{
      0%{opacity:.8;transform:translate(-50%,-50%) scale(1)}
      100%{opacity:0;transform:translate(-50%,-50%) scale(2.6)}
    }
  </style>
</head>
<body>
  <div class="app">
    <div id="loading" class="loading" role="status" aria-live="polite">
      <div class="spinner"></div>
    </div>
    <div id="map"></div>
  </div>

  <script async src="https://maps.googleapis.com/maps/api/js?key=YOUR_BROWSER_KEY&v=weekly&language=ja&region=JP&loading=async"></script>

  <script type="module">
    const wait = (ms)=>new Promise(r=>setTimeout(r,ms));
    const Diag = {
      _buf:[],
      log(o){try{
        const t = typeof o==='string'?o:JSON.stringify(o);
        this._buf.push(`[${new Date().toISOString()}] ${t}`);
        console.log('[WN]',t);
      }catch(e){}},
      report(){return this._buf.join('\n');}
    };

    async function getLocation(timeoutMs=30000){
      return new Promise((resolve,reject)=>{
        const t=setTimeout(()=>reject(new Error('timeout')),timeoutMs);
        if(!navigator.geolocation){clearTimeout(t);reject(new Error('unsupported'));return;}
        navigator.geolocation.getCurrentPosition(
          pos=>{clearTimeout(t);resolve({lat:pos.coords.latitude,lng:pos.coords.longitude});},
          err=>{clearTimeout(t);reject(new Error(err.message||'geo error'));},
          {enableHighAccuracy:true,timeout:timeoutMs,maximumAge:0}
        );
      });
    }

    async function loadMaps(){
      while(!(window.google&&google.maps&&google.maps.importLibrary)){await wait(25);}
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement } = await google.maps.importLibrary("marker");
      return { Map, AdvancedMarkerElement };
    }

    function makeMarker(AdvancedMarkerElement,pos,map){
      const div=document.createElement('div');div.className='pulse';
      return new AdvancedMarkerElement({map,position:pos,content:div});
    }

    (async function main(){
      try{
        Diag.log({phase:'boot'});
        const cur=await getLocation(30000);
        const { Map,AdvancedMarkerElement }=await loadMaps();
        const map=new Map(document.getElementById('map'),{
          center:cur,zoom:18,disableDefaultUI:true,mapId:"WALKNAV_MAP",gestureHandling:"greedy",
        });
        document.getElementById('map').style.display='block';
        document.getElementById('loading').style.display='none';
        makeMarker(AdvancedMarkerElement,cur,map);
        Diag.log({event:'ready',cur});
      }catch(e){
        Diag.log({fatal:e.message});
      }
    })();
  </script>
</body>
</html>