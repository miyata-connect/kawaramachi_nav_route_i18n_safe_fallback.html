<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>WALK NAV</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  :root{
    --bg: rgba(255,255,255,.96);
    --shadow: 0 10px 25px rgba(0,0,0,.15);
    --r: 14px;
    --resultsTop: 120px; /* JSãŒå®Ÿæ¸¬ã—ã¦æ›´æ–° */
  }
  html,body{height:100%;margin:0}
  #map{position:fixed;inset:0}

  /* â”€â”€ æ¤œç´¢ãƒ‘ãƒãƒ« â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #panel{
    position:fixed;
    left:max(8px,env(safe-area-inset-left));
    right:max(8px,env(safe-area-inset-right));
    top:calc(8px + env(safe-area-inset-top));
    z-index:1000;background:var(--bg);backdrop-filter:blur(6px);
    border-radius:var(--r);box-shadow:var(--shadow);padding:8px;
    display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;
  }
  #q{
    width:100%;height:44px;border:1px solid #cbd5e1;border-radius:12px;padding:0 12px;font-size:16px;
  }
  .btn, select{
    height:44px;border:1px solid #cbd5e1;border-radius:12px;background:#fff;font-size:15px;
    padding:0 12px;display:inline-flex;align-items:center;justify-content:center;gap:6px;cursor:pointer;
  }
  #mic{width:44px;padding:0}
  #search{white-space:nowrap}
  #lang{width:116px}
  @media (max-width:460px){
    #panel{grid-template-columns:1fr auto auto}
    #lang{grid-column:1 / -1}
  }

  /* å³ä¸Šã®å›ºå®šãƒœã‚¿ãƒ³ï¼ˆã‚ºãƒ¼ãƒ ã¨ã‹ã¶ã‚‰ãªã„ï¼‰ */
  .fixed-controls{
    position:fixed;right:max(10px,env(safe-area-inset-right));
    top:calc(66px + env(safe-area-inset-top));
    display:flex;flex-direction:column;gap:8px;z-index:999;
  }
  .fixed-controls .btn{box-shadow:var(--shadow);}

  /* æ¤œç´¢çµæœï¼šæ¤œç´¢çª“ã®ç›´ä¸‹ã«è‡ªå‹•é…ç½®ï¼ˆJSãŒ--resultsTopã‚’æ›´æ–°ï¼‰ */
  #results{
    position:fixed;
    left:max(8px,env(safe-area-inset-left));
    right:max(8px,env(safe-area-inset-right));
    top:var(--resultsTop);
    z-index:999;background:var(--bg);border-radius:12px;box-shadow:var(--shadow);
    display:none;overflow:auto;max-height:calc(60vh - env(safe-area-inset-bottom));
  }
  #results header{
    padding:8px 12px;font-size:13px;color:#6b7280;border-bottom:1px solid #e5e7eb;
    display:flex;justify-content:space-between;gap:8px;align-items:center;
  }
  #results ul{list-style:none;margin:0;padding:0}
  #results li{
    padding:10px 12px;border-top:1px solid #e5e7eb;display:flex;justify-content:space-between;gap:8px;
    cursor:pointer;
  }
  #results li:first-child{border-top:none}
  #results small{color:#6b7280}

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  #toast{
    position:fixed;left:50%;transform:translateX(-50%);
    bottom:calc(12px + env(safe-area-inset-bottom));
    background:var(--bg);border-radius:12px;box-shadow:var(--shadow);
    padding:8px 12px;z-index:1000;font-size:14px;display:none;max-width:92vw;
  }

  /* é€²è¡Œæ–¹å‘ãƒ”ãƒ³ */
  .heading-pin{
    width:24px;height:24px;border-radius:50%;
    background:#2563eb;border:3px solid #fff;box-shadow:0 0 0 2px rgba(37,99,235,.35);
    position:relative;
  }
  .heading-pin::after{
    content:"";position:absolute;left:50%;top:-12px;transform:translateX(-50%);
    width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-bottom:12px solid #2563eb;
    filter:drop-shadow(0 1px 1px rgba(0,0,0,.4));
  }

  .route-shadow{filter:drop-shadow(0 1px 1px rgba(0,0,0,.35))}
</style>
</head>
<body>
  <div id="map" aria-label="åœ°å›³"></div>

  <div id="panel" role="group" aria-label="æ¤œç´¢">
    <input id="q" placeholder="åº—åãƒ»ä½æ‰€ãƒ»é›»è©±ï¼ˆä¾‹: ãƒ­ãƒ¼ã‚½ãƒ³ / 087-xxx-xxxxï¼‰">
    <button id="mic" class="btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
    <button id="search" class="btn" title="æ¤œç´¢">æ¤œç´¢</button>
    <select id="lang" title="è¨€èª">
      <option value="ja-JP" selected>æ—¥æœ¬èª</option>
      <option value="en-US">English</option>
      <option value="ko-KR">í•œêµ­ì–´</option>
      <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
      <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
    </select>
  </div>

  <div class="fixed-controls">
    <button id="locate" class="btn">ğŸ“ ç¾åœ¨åœ°</button>
    <button id="follow" class="btn" aria-pressed="true">ğŸ§­ è¿½å¾“ON</button>
  </div>

  <div id="results" role="listbox" aria-label="æ¤œç´¢çµæœ">
    <header><span>è¿‘ã„é † ä¸Šä½5ä»¶</span><button id="closeResults" class="btn" style="height:32px;padding:0 10px;">é–‰ã˜ã‚‹</button></header>
    <ul></ul>
  </div>
  <div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ========= åœ°å›³ =========
  const map = L.map('map',{zoomControl:true,attributionControl:true}).setView([34.342,134.046],16);
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; OpenStreetMap'}).addTo(map);

  const $ = s=>document.querySelector(s);
  const qEl=$('#q'), micEl=$('#mic'), searchEl=$('#search'), langEl=$('#lang');
  const locateEl=$('#locate'), followEl=$('#follow');
  const resultsEl=$('#results'), resultsUL=resultsEl.querySelector('ul');
  const toastEl=$('#toast'), closeResultsEl=$('#closeResults');
  const panelEl=$('#panel');

  const ORS_PROXY='https://ors-proxy.miyata-connect-jp.workers.dev/proxy';

  // ========= æ¤œç´¢ãƒ‘ãƒãƒ«ã®å®Ÿé«˜ã§çµæœã‚’ãšã‚‰ã™ =========
  function updateResultsOffset(){
    const r = panelEl.getBoundingClientRect();
    document.documentElement.style.setProperty('--resultsTop', (Math.round(r.bottom)+8) + 'px');
  }
  ['load','resize','orientationchange'].forEach(ev=>window.addEventListener(ev,updateResultsOffset));
  langEl.addEventListener('change',updateResultsOffset);
  new ResizeObserver(updateResultsOffset).observe(panelEl);

  // ========= ãƒˆãƒ¼ã‚¹ãƒˆ =========
  function toast(m,ms=2000){ toastEl.textContent=m; toastEl.style.display='block';
    clearTimeout(toastEl._t); toastEl._t=setTimeout(()=>toastEl.style.display='none',ms); }

  // ========= ç¾åœ¨åœ° & heading =========
  let meLatLng=null, meMarker=null, headingDeg=null, follow=true;
  const MeIcon=L.divIcon({className:'',html:'<div class="heading-pin"></div>',iconSize:[24,24],iconAnchor:[12,12]});
  function setMeMarker(latlng){
    if(!meMarker){ meMarker=L.marker(latlng,{icon:MeIcon}).addTo(map); }
    else{ meMarker.setLatLng(latlng); }
    rotateHeading();
  }
  function rotateHeading(){
    if(!meMarker) return;
    const el = meMarker.getElement();
    if(!el) return;
    el.style.transform = `rotate(${(headingDeg??0)}deg)`;
  }
  function bearing(from, to){
    const Ï†1=from.lat*Math.PI/180, Ï†2=to.lat*Math.PI/180;
    const Î»1=from.lng*Math.PI/180, Î»2=to.lng*Math.PI/180;
    const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2);
    const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1);
    return (Math.atan2(y,x)*180/Math.PI+360)%360;
  }
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(p=>{
      meLatLng = L.latLng(p.coords.latitude,p.coords.longitude);
      if(typeof p.coords.heading==='number' && !isNaN(p.coords.heading)) headingDeg = p.coords.heading;
      setMeMarker(meLatLng);
      if(follow) map.panTo(meLatLng,{animate:true,duration:.4});
      maybeRerouteOnMove();
    }, err=>console.warn(err), {enableHighAccuracy:true,maximumAge:5000,timeout:10000});
  }
  locateEl.addEventListener('click',()=>{ meLatLng? map.flyTo(meLatLng,18,{duration:.6}) : toast('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­â€¦'); });
  followEl.addEventListener('click',()=>{
    follow=!follow; followEl.setAttribute('aria-pressed', String(follow));
    followEl.textContent = follow ? 'ğŸ§­ è¿½å¾“ON' : 'ğŸ§­ è¿½å¾“OFF';
    if(follow && meLatLng) map.panTo(meLatLng);
  });

  // ========= éŸ³å£°å…¥åŠ›ï¼ˆUIã®è¨€èªã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼‰ =========
  let recog=null;
  micEl.addEventListener('click',()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR){ toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«æœªå¯¾å¿œ'); return; }
    if(!recog){
      recog=new SR(); recog.interimResults=false; recog.maxAlternatives=1;
      recog.addEventListener('result',e=>{
        qEl.value=e.results[0][0].transcript.trim(); doSearch();
      });
      recog.addEventListener('error',e=>toast('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: '+e.error));
    }
    try{ recog.lang=langEl.value||'ja-JP'; recog.start(); }catch(_){}
  });

  // ========= æ¤œç´¢ï¼ˆè¿‘ã„é † ä¸Šä½5ä»¶ï¼‰ =========
  async function geocodeTop5(term, centerLatLng, langTag){
    const lat=centerLatLng.lat, lon=centerLatLng.lng;
    const R=800;
    const dLat=R/111320, dLon=R/(111320*Math.cos(lat*Math.PI/180));
    const url=new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2');
    url.searchParams.set('q',term);
    url.searchParams.set('limit','20');
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language',langTag||'ja-JP');
    url.searchParams.set('viewbox',`${lon-dLon},${lat+dLat},${lon+dLon},${lat-dLat}`);
    url.searchParams.set('bounded','1');
    const res=await fetch(url,{headers:{'Accept':'application/json'}});
    const arr=await res.json();

    // é›»è©±ç•ªå·ã£ã½ã„æ™‚ã¯Overpassã‚‚ä½µç”¨
    const digits=term.replace(/[^\d]/g,'');
    let overpassArr=[];
    if(digits.length>=7){
      try{
        const q=`
          [out:json][timeout:25];
          (
            node(around:${R},${lat},${lon})["phone"~"${digits}"];
            node(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            way(around:${R},${lat},${lon})["phone"~"${digits}"];
            way(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["phone"~"${digits}"];
            relation(around:${R},${lat},${lon})["contact:phone"~"${digits}"];
          ); out center 30;`;
        const r=await fetch('https://overpass-api.de/api/interpreter',{
          method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body:new URLSearchParams({data:q})
        });
        const j=await r.json();
        overpassArr=(j.elements||[]).map(el=>{
          const y=el.lat||el.center?.lat, x=el.lon||el.center?.lon;
          if(!y||!x) return null;
          return { lat:y, lon:x, display_name: el.tags?.name || el.tags?.brand || 'ç›®çš„åœ°(é›»è©±)' };
        }).filter(Boolean);
      }catch(e){ console.warn('overpass',e); }
    }
    const center=L.latLng(lat,lon);
    const merged=[...arr.map(a=>({lat:+a.lat,lon:+a.lon,display_name:a.display_name})),...overpassArr];
    const uniq=new Map();
    merged.forEach(p=>{ const k=p.lat.toFixed(6)+','+p.lon.toFixed(6); if(!uniq.has(k)) uniq.set(k,p); });
    const list=[...uniq.values()].map(p=>{ p._d=map.distance(center,[p.lat,p.lon]); return p; })
      .sort((a,b)=>a._d-b._d).slice(0,5);
    return list;
  }

  // ========= çµŒè·¯ï¼ˆORSï¼‰ =========
  let dstMarker=null, routeLine=null, routeShadow=null, lastRouteTo=null, lastRouteAt=0;

  async function routeWalk(from, to, langTag){
    const body={coordinates:[[from.lng,from.lat],[to.lng,to.lat]],instructions:true,language:(langTag||'ja-JP')};
    const url=`${ORS_PROXY}?profile=foot-walking&format=geojson`;
    const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok) throw new Error('ORSã‚¨ãƒ©ãƒ¼ '+r.status);
    const geo=await r.json();
    const feat=geo.features?.[0]; if(!feat) throw new Error('ãƒ«ãƒ¼ãƒˆãªã—');
    const coords=feat.geometry.coordinates.map(([x,y])=>L.latLng(y,x));
    const sum=feat.properties?.summary||{};
    return {latlngs:coords, dist:sum.distance||0, dur:sum.duration||0};
  }
  function drawRoute(latlngs){
    if(routeLine){ map.removeLayer(routeLine); map.removeLayer(routeShadow); }
    routeShadow=L.polyline(latlngs,{color:'#000',weight:8,opacity:.25,className:'route-shadow'}).addTo(map);
    routeLine=L.polyline(latlngs,{color:'#2563eb',weight:5,opacity:.95}).addTo(map);
    map.fitBounds(routeLine.getBounds(),{padding:[80,40]});
  }
  function distanceToPolylineMeters(latlng, latlngs){
    if(!latlngs||latlngs.length<2) return Infinity;
    const p=map.latLngToLayerPoint(latlng);
    let min=Infinity;
    for(let i=1;i<latlngs.length;i++){
      const p1=map.latLngToLayerPoint(latlngs[i-1]), p2=map.latLngToLayerPoint(latlngs[i]);
      const d=L.LineUtil.pointToSegmentDistance(p,p1,p2);
      if(d<min) min=d;
    }
    const p0=map.layerPointToLatLng([0,0]), p1LL=map.layerPointToLatLng([1,0]);
    const mPerPx=map.distance(p0,p1LL);
    return min*mPerPx;
  }
  async function maybeRerouteOnMove(){
    if(!routeLine || !meLatLng || !lastRouteTo) return;
    const off=distanceToPolylineMeters(meLatLng, routeLine.getLatLngs());
    const t=Date.now();
    if(off>25 || (t-lastRouteAt)>20000){
      try{
        const r=await routeWalk(meLatLng,lastRouteTo,langEl.value);
        drawRoute(r.latlngs);
        lastRouteAt=Date.now();
        if(r.latlngs.length>1 && (headingDeg==null)){
          headingDeg=bearing(meLatLng,r.latlngs[1]); rotateHeading();
        }
      }catch(e){ console.warn('reroute',e); }
    }
  }

  // ========= æ¤œç´¢ â†’ ã‚¿ãƒƒãƒ—ã§æ¡ˆå†…ï¼ˆtry/catchã§ç¢ºå®Ÿã«å‹•ãï¼‰ =========
  async function doSearch(){
    const term=qEl.value.trim(); if(!term){toast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›');return;}
    const center=meLatLng || map.getCenter();
    try{
      toast('æ¤œç´¢ä¸­â€¦');
      const list=await geocodeTop5(term, center, langEl.value);
      if(!list.length){ resultsEl.style.display='none'; toast('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }
      resultsUL.innerHTML = list.map((p,i)=>`
        <li data-i="${i}">
          <span>${p.display_name}</span>
          <small>${(p._d/1000).toFixed(2)}km</small>
        </li>`).join('');
      updateResultsOffset();
      resultsEl.style.display='block';

      resultsUL.querySelectorAll('li').forEach(li=>{
        li.addEventListener('click', async ()=>{
          resultsEl.style.display='none';
          const i=+li.getAttribute('data-i'); const p=list[i];
          const to=L.latLng(p.lat,p.lon);

          try{
            // ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã¯å¿…ãšè¡¨ç¤º
            if(!dstMarker) dstMarker=L.marker(to,{title:'ç›®çš„åœ°'}).addTo(map);
            else dstMarker.setLatLng(to);
            dstMarker.bindPopup(p.display_name||'ç›®çš„åœ°');

            lastRouteTo=to;

            if(meLatLng){
              const r=await routeWalk(meLatLng,to,langEl.value);
              drawRoute(r.latlngs);
              lastRouteAt=Date.now();
              toast(`å¾’æ­© ç´„${Math.round(r.dur/60)}åˆ† / ${(r.dist/1000).toFixed(2)}km`);
            }else{
              map.flyTo(to,18,{duration:.6});
              toast('ç¾åœ¨åœ°æœªå–å¾—ã®ãŸã‚ç›®çš„åœ°ã®ã¿è¡¨ç¤ºã—ã¾ã—ãŸ');
            }
          }catch(e){
            console.error(e);
            // ORSã«å¤±æ•—ã—ã¦ã‚‚ç›®çš„åœ°ã¸ç§»å‹•ã¯ã™ã‚‹
            map.flyTo(to,18,{duration:.6});
            toast('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—: '+(e.message||e));
          }
        });
      });
    }catch(e){ console.error(e); toast('ã‚¨ãƒ©ãƒ¼: '+(e.message||e)); }
  }
  searchEl.addEventListener('click',doSearch);
  qEl.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });
  closeResultsEl.addEventListener('click',()=>{ resultsEl.style.display='none'; });

  // åˆæœŸé…ç½®
  updateResultsOffset();

  // åˆæœŸ q= ãŒã‚ã‚Œã°æ¤œç´¢
  const sp=new URLSearchParams(location.search);
  if(sp.get('q')){ qEl.value=sp.get('q'); setTimeout(()=>{ updateResultsOffset(); doSearch(); },300); }
})();
</script>
</body>
</html>