<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>WALK NAVï¼ˆå¾’æ­©ãƒŠãƒ“ï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

  <!-- Leaflet -->
  <link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --panel-bg: rgba(255,255,255,.96);
      --shadow: 0 6px 20px rgba(0,0,0,.15);
      --radius: 14px;
      --ui-gap: 8px;
    }
    html,body{ height:100%; margin:0; }
    #map{ position:fixed; inset:0; }

    /* ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¢ãƒã‚¤ãƒ«ã¯ç¸¦ä¸¦ã³ï¼‰ */
    #panel{
      position:fixed; z-index:1000;
      left: max(8px, env(safe-area-inset-left));
      right: max(8px, env(safe-area-inset-right));
      top: calc(8px + env(safe-area-inset-top));
      display:grid; gap: var(--ui-gap);
      grid-template-columns: 1fr auto;
      align-items:center;
      background: var(--panel-bg);
      padding: 10px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    #panel .row{ display: contents; }
    #q{
      width:100%;
      padding:12px 14px;
      border-radius: 12px;
      border:1px solid #cbd5e1;
      font-size:16px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:44px; min-width:44px; padding:0 14px; gap:8px;
      border-radius: 12px; border:1px solid #cbd5e1; background:#fff;
      cursor:pointer; user-select:none; font-size:15px;
    }
    select{
      height:44px; border-radius:12px; border:1px solid #cbd5e1;
      padding:0 10px; background:#fff; font-size:15px;
    }
    #radius{ width:110px; }
    #lang{ width:110px; }
    #mic{ width:44px; }
    #search{ white-space:nowrap; }

    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šãƒ¢ãƒã‚¤ãƒ«ã¯ç¸¦ç©ã¿ï¼ˆè¢«ã‚Šå¯¾ç­–ï¼‰ */
    @media (max-width: 680px){
      #panel{
        grid-template-columns: 1fr;
      }
      #panel .row{
        display:grid; grid-template-columns: 1fr 1fr; gap: var(--ui-gap);
      }
      #q{ grid-column: 1 / -1; }
      #mic{ grid-column: 1 / 1; }
      #search{ grid-column: 2 / 2; }
      #lang { grid-column: 1 / 1; }
      #radius{ grid-column: 2 / 2; }
    }

    /* ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ï¼ˆã‚ºãƒ¼ãƒ ã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«å³ä¸Šã¸å›ºå®šï¼‰ */
    .locate-control{
      position: fixed;
      top: calc(72px + env(safe-area-inset-top)); /* ä¸Šã®ãƒ‘ãƒãƒ«ã®ä¸‹ã«ãã‚‹ã‚ˆã†ã‚ªãƒ•ã‚»ãƒƒãƒˆ */
      right: max(10px, env(safe-area-inset-right));
      z-index: 999; /* ã‚ºãƒ¼ãƒ ã‚ˆã‚Šä¸Š */
    }
    .locate-control .btn{ box-shadow: var(--shadow); }

    /* ãƒ«ãƒ¼ãƒˆæƒ…å ±ãƒˆãƒ¼ã‚¹ãƒˆ */
    #toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(14px + env(safe-area-inset-bottom));
      background: var(--panel-bg); padding:10px 14px;
      border-radius: 12px; box-shadow: var(--shadow);
      z-index:1000; font-size:14px; display:none;
      max-width: min(92vw, 680px);
    }

    /* ãƒ«ãƒ¼ãƒˆç·šã¨å‡ºç™º/ç›®çš„åœ°ãƒãƒ¼ã‚«ãƒ¼ã®è‰²å‘³ */
    .route-line{ filter: drop-shadow(0 1px 1px rgba(0,0,0,.35)); }
  </style>
</head>

<body>
  <div id="map" aria-label="åœ°å›³"></div>

  <!-- ä¸Šéƒ¨ãƒ‘ãƒãƒ« -->
  <div id="panel" role="group" aria-label="æ¤œç´¢ãƒ»è¨­å®š">
    <input id="q" type="text" placeholder="åº—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã‚’å…¥åŠ›ï¼ˆä¾‹ï¼šãƒ­ãƒ¼ã‚½ãƒ³ / 087-xxx-xxxxï¼‰" />
    <button id="search" class="btn" title="æ¤œç´¢">æ¤œç´¢</button>

    <div class="row">
      <select id="radius" title="å‘¨è¾ºæ¤œç´¢åŠå¾„">
        <option value="100">100m</option>
        <option value="300" selected>300m</option>
        <option value="500">500m</option>
      </select>

      <button id="mic" class="btn" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>

      <select id="lang" title="éŸ³å£°ãƒ»æ¡ˆå†…è¨€èª">
        <option value="ja" selected>æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
      </select>
    </div>
  </div>

  <!-- ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ï¼ˆã‚ºãƒ¼ãƒ ã¨è¢«ã‚‰ãªã„å›ºå®šä½ç½®ï¼‰ -->
  <div class="locate-control">
    <button id="locate" class="btn" title="ç¾åœ¨åœ°ã¸ç§»å‹•">ğŸ“ ç¾åœ¨åœ°</button>
  </div>

  <!-- ç°¡æ˜“ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast" role="status" aria-live="polite"></div>

<script>
(function(){
  // ====== Leaflet åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ======
  const map = L.map('map', { zoomControl: true, attributionControl: true })
      .setView([34.342, 134.046], 16);  // åˆå›ã¯é«˜æ¾ä»˜è¿‘ã€å¾Œã§ç¾åœ¨åœ°ã¸

  // ãƒ™ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè»½ãè‰²å‘³ãŒã‚ã‚‹æ–¹ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  const osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20, attribution:'&copy; OpenStreetMap'
  }).addTo(map);

  // ç›®ç«‹ã¤ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
  const meIcon = L.icon({
    iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
    iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
    iconAnchor: [12, 41], popupAnchor: [1, -34], shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
    shadowAnchor:[12,41]
  });
  const dstIcon = L.divIcon({
    className:'', html:'<div style="width:16px;height:16px;border-radius:50%;background:#e11d48;border:3px solid #fff;box-shadow:0 0 0 2px rgba(225,29,72,.35)"></div>',
    iconSize:[16,16], iconAnchor:[8,8]
  });

  let meMarker, dstMarker, routeLine, routeShadow;
  let lastPosition = null;

  // ====== DOM å‚ç…§ ======
  const $ = sel => document.querySelector(sel);
  const qEl = $('#q');
  const radiusEl = $('#radius');
  const micEl = $('#mic');
  const searchEl = $('#search');
  const langEl = $('#lang');
  const locateEl = $('#locate');
  const toastEl = $('#toast');

  // ====== ç”»é¢ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ======
  function toast(msg, ms=2200){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    clearTimeout(toastEl._t);
    toastEl._t = setTimeout(()=> toastEl.style.display='none', ms);
  }
  function metersToTime(m){ // ç§’â†’è¡¨ç¤º
    const min = Math.round(m/60);
    if(min < 60) return `å¾’æ­© ç´„${min}åˆ†`;
    const h = Math.floor(min/60), r = min%60;
    return `å¾’æ­© ç´„${h}æ™‚é–“${r}åˆ†`;
  }

  // ====== ç¾åœ¨åœ°å–å¾—ï¼ˆwatchï¼‰ ======
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(
      pos=>{
        const {latitude, longitude} = pos.coords;
        lastPosition = [latitude, longitude];
        if(!meMarker){
          meMarker = L.marker(lastPosition, {icon: meIcon}).addTo(map).bindPopup('ç¾åœ¨åœ°');
          // åˆå›ã ã‘ä¸­å¿ƒã¸
          map.setView(lastPosition, 17);
        }else{
          meMarker.setLatLng(lastPosition);
        }
      },
      err=>{ console.warn('geolocation', err); },
      { enableHighAccuracy:true, maximumAge:10000, timeout:10000 }
    );
  }else{
    toast('ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“');
  }
  locateEl.addEventListener('click', ()=>{
    if(lastPosition){ map.flyTo(lastPosition, 18, {duration:.6}); meMarker?.openPopup(); }
    else toast('ç¾åœ¨åœ°ã‚’å–å¾—ä¸­ã§ã™â€¦');
  });

  // ====== éŸ³å£°å…¥åŠ› ======
  let recog;
  micEl.addEventListener('click', ()=>{
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(!SR){ toast('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°å…¥åŠ›ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“'); return; }
    if(!recog){
      recog = new SR();
      recog.lang = langEl.value || 'ja';
      recog.interimResults = false;
      recog.maxAlternatives = 1;
      recog.addEventListener('result', e=>{
        const text = e.results[0][0].transcript.trim();
        qEl.value = text;
        doSearch();
      });
      recog.addEventListener('error', e=> toast('éŸ³å£°å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ' + e.error));
    }
    try{ recog.lang = langEl.value || 'ja'; recog.start(); }catch(_){}
  });

  // ====== æ¤œç´¢ â†’ è¿‘å‚Nominatimï¼ˆãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹ï¼‰ or é›»è©±ç•ªå·ã¯Overpass ======
  async function geocodeAround(term, centerLatLng, radiusM, lang){
    const [lat, lon] = centerLatLng;

    // 1) é›»è©±ç•ªå·ã‚‰ã—ã‘ã‚Œã° Overpass (phone / contact:phone)
    const digits = term.replace(/[^\d]/g,'');
    if(digits.length >= 7){
      try{
        const overpass = 'https://overpass-api.de/api/interpreter';
        const q = `
          [out:json][timeout:25];
          (
            node(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            node(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
            way(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            way(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
            relation(around:${radiusM},${lat},${lon})["phone"~"${digits}"];
            relation(around:${radiusM},${lat},${lon})["contact:phone"~"${digits}"];
          );
          out center 20;
        `;
        const res = await fetch(overpass, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8'},
          body: new URLSearchParams({ data: q })
        });
        const json = await res.json();
        if(json.elements && json.elements.length){
          // ä¸€ç•ªè¿‘ã„ã‚‚ã®ã‚’æ¡ç”¨
          let best = null, bestD=Infinity;
          json.elements.forEach(el=>{
            const y = el.lat || el.center?.lat;
            const x = el.lon || el.center?.lon;
            if(y && x){
              const d = map.distance([lat,lon],[y,x]);
              if(d < bestD){ bestD=d; best={lat:y, lon:x, display_name: el.tags?.name || 'ç›®çš„åœ°'}; }
            }
          });
          if(best) return [best];
        }
      }catch(e){ console.warn('overpass phone', e); }
    }

    // 2) Nominatimï¼ˆviewbox + bounded=1ï¼‰: å‘¨è¾ºãƒœãƒƒã‚¯ã‚¹ã ã‘ã§çµã‚‹
    const dLat = radiusM / 111320;                 // 1deg â‰’ 111.32km
    const dLon = radiusM / (111320 * Math.cos(lat*Math.PI/180));
    const minLon = lon - dLon, maxLon = lon + dLon;
    const minLat = lat - dLat, maxLat = lat + dLat;
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','jsonv2');
    url.searchParams.set('q', term);
    url.searchParams.set('limit','10');
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('accept-language', lang || 'ja');
    url.searchParams.set('viewbox', `${minLon},${maxLat},${maxLon},${minLat}`); // left,top,right,bottom
    url.searchParams.set('bounded','1');

    const res = await fetch(url, { headers:{'Accept':'application/json'} });
    const list = await res.json();
    return list;
  }

  // ====== ORS ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆCloudflare Worker ãƒ—ãƒ­ã‚­ã‚·ï¼‰ ======
  const ORS_PROXY = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';

  async function routeWalk(fromLatLng, toLatLng, lang='ja'){
    const body = {
      coordinates: [[fromLatLng[1], fromLatLng[0]],[toLatLng[1], toLatLng[0]]], // [lon,lat]
      instructions: true,
      language: lang
    };
    const url = `${ORS_PROXY}?profile=foot-walking&format=geojson`;
    const r = await fetch(url, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok){ throw new Error('ORSå¿œç­”ã‚¨ãƒ©ãƒ¼ '+r.status); }
    const geo = await r.json(); // GeoJSON
    // feature æŠ½å‡º
    const feat = geo.features?.[0];
    if(!feat) throw new Error('ãƒ«ãƒ¼ãƒˆãªã—');
    const coords = feat.geometry.coordinates.map(([x,y])=> [y,x]);
    const durSec = feat.properties?.summary?.duration || 0;
    const distM  = feat.properties?.summary?.distance || 0;
    return { coords, durSec, distM, raw: feat };
  }

  // ====== ãƒ«ãƒ¼ãƒˆæç”» ======
  function drawRoute(latlngs){
    if(routeLine){ map.removeLayer(routeLine); map.removeLayer(routeShadow); }
    routeShadow = L.polyline(latlngs, {color:'#000', weight:8, opacity:.25, className:'route-line'}).addTo(map);
    routeLine   = L.polyline(latlngs, {color:'#2563eb', weight:5, opacity:.9, className:'route-line'}).addTo(map);
    map.fitBounds(routeLine.getBounds(), { padding:[80, 40] });
  }

  // ====== æ¤œç´¢ â†’ ãƒ«ãƒ¼ãƒˆ ======
  async function doSearch(){
    const term = qEl.value.trim();
    if(!term){ toast('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›'); return; }
    const center = lastPosition || map.getCenter();
    const r = parseInt(radiusEl.value,10) || 300;
    const lang = langEl.value || 'ja';

    try{
      toast('æ¤œç´¢ä¸­â€¦');
      const list = await geocodeAround(term, [center.lat, center.lng], r, lang);
      if(!list || !list.length){ toast('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return; }

      const best = list[0];
      const to = [parseFloat(best.lat), parseFloat(best.lon)];
      if(!dstMarker){
        dstMarker = L.marker(to, {icon: dstIcon}).addTo(map);
      }else{
        dstMarker.setLatLng(to);
      }
      dstMarker.bindPopup(best.display_name || 'ç›®çš„åœ°').openPopup();

      const from = lastPosition ? lastPosition : [center.lat, center.lng];
      const route = await routeWalk(from, to, lang);
      drawRoute(route.coords);
      toast(`${(route.distM/1000).toFixed(2)} kmï½œ${metersToTime(route.durSec)}`);
    }catch(e){
      console.error(e);
      toast('ã‚¨ãƒ©ãƒ¼ï¼š' + (e.message || e));
    }
  }
  searchEl.addEventListener('click', doSearch);
  qEl.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

  // ====== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ?q= ã§åˆæœŸæ¤œç´¢ï¼ˆãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç”¨ï¼‰ ======
  const usp = new URLSearchParams(location.search);
  const initQ = usp.get('q');
  if(initQ){ qEl.value = initQ; setTimeout(doSearch, 400); }

})();
</script>
</body>
</html>