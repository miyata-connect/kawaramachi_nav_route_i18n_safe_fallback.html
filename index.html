<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  :root{
    --bg:#0f1a25;
    --panel:#132235;
    --panel-2:#0f1e30;
    --text:#e8f1ff;
    --muted:#9db0c6;
    --ok:#2ecc71;
    --primary:#4aa3ff;
    --danger:#ff6b6b;
    --chip:#0b1624;
  }
  html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN","Noto Sans JP", "Helvetica Neue", Arial, "ãƒ¡ã‚¤ãƒªã‚ª", "Meiryo", sans-serif;}
  .wrap{max-width:1100px; margin:0 auto; padding:12px;}
  .card{background:var(--panel); border-radius:14px; padding:12px; box-shadow: 0 6px 20px rgba(0,0,0,.25);}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
  .grow{flex:1 1 200px}
  input,select,button{border-radius:12px; border:1px solid rgba(255,255,255,.08); background:var(--panel-2); color:var(--text); padding:12px 14px; font-size:16px; outline:none}
  input::placeholder{color:#88a0ba}
  button.primary{background:var(--primary); border:none; color:white; font-weight:700}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
  button.ok{background:var(--ok); border:none; color:white; font-weight:700}
  button.danger{background:var(--danger); border:none; color:white; font-weight:700}
  .hint{color:var(--muted); font-size:14px}
  #map{height:62vh; border-radius:16px; overflow:hidden; margin-top:12px}
  /* ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
  .fab-col{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:500}
  .fab-col button{min-width:150px; font-weight:700; box-shadow:0 10px 20px rgba(0,0,0,.35)}
  /* æ¤œç´¢çµæœ */
  .results{margin-top:10px}
  .result{background:var(--chip); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:12px; margin-bottom:8px; cursor:pointer}
  .result small{color:#a9bed5}
  .badge{display:inline-block; background:rgba(255,255,255,.08); padding:3px 8px; border-radius:999px; margin-right:6px}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  /* ã‚³ãƒ³ãƒ‘ã‚¹ï¼ˆå·¦ä¸Šå›ºå®šãƒ»ãƒ«ãƒ¼ãƒˆã‚„ãƒœã‚¿ãƒ³ã¨å¹²æ¸‰ã—ãªã„ï¼‰ */
  .compass{
    position:absolute; left:12px; top:12px; z-index:450;
    width:90px; height:90px; border-radius:50%;
    background: radial-gradient(ellipse at center, #0b1624 0%, #0a1320 60%, #07121e 100%);
    border:1px solid rgba(255,255,255,.15);
    box-shadow:0 6px 16px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center;
  }
  .compass .dial{position:absolute; width:74px; height:74px; border-radius:50%; border:1px solid rgba(255,255,255,.1)}
  .compass .north{position:absolute; top:6px; color:#f6d365; font-size:12px; letter-spacing:.1em}
  .compass .arrow{
    width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent;
    border-bottom:26px solid #ff5c5c; /* é€²è¡Œæ–¹å‘ã‚’èµ¤ä¸€è‰²ã§æ˜å¿«ã« */
    transform-origin:50% 24px; filter: drop-shadow(0 6px 8px rgba(0,0,0,.35));
  }
  .compass .label{position:absolute; bottom:6px; font-size:11px; color:#b8cce2}
  /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ– */
  @media (max-width:640px){
    #map{height:64vh}
    .fab-col button{min-width:130px}
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- æ¤œç´¢ -->
  <div class="card">
    <div class="row">
      <input id="q" class="grow" placeholder="åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢" autocomplete="off" />
      <button id="mic" class="ghost" aria-label="éŸ³å£°æ¤œç´¢">ğŸ¤ éŸ³å£°</button>
      <button id="search" class="primary">æ¤œç´¢</button>
    </div>
    <div class="row" style="margin-top:8px">
      <div class="toolbar">
        <button id="clearHistory" class="ghost">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
        <span class="hint">æ¤œç´¢å¾Œã¯è¿‘å ´5ä»¶ã‚’è¡¨ç¤º â†’ ç›®çš„åœ°ã«è¨­å®š â†’ ãƒ«ãƒ¼ãƒˆå–å¾— â†’ æ¡ˆå†…é–‹å§‹</span>
      </div>
    </div>
  </div>

  <!-- åº§æ¨™ï¼†ãƒ¢ãƒ¼ãƒ‰ -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="grow">
        <div class="hint">é–‹å§‹åœ°ç‚¹ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</div>
        <div class="row">
          <input id="startLon" class="grow" placeholder="çµŒåº¦" inputmode="decimal">
          <input id="startLat" class="grow" placeholder="ç·¯åº¦" inputmode="decimal">
        </div>
      </div>
      <div class="grow">
        <div class="hint">ç›®çš„åœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</div>
        <div class="row">
          <input id="destLon" class="grow" placeholder="çµŒåº¦" inputmode="decimal">
          <input id="destLat" class="grow" placeholder="ç·¯åº¦" inputmode="decimal">
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="toolbar">
        <button id="modeWalk"  class="primary">å¾’æ­©</button>
        <button id="modeWheel" class="ghost">è»Šæ¤…å­</button>
        <button id="getRoute" class="primary">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
        <button id="clear" class="ghost">ã‚¯ãƒªã‚¢</button>
      </div>
      <div class="grow"></div>
    </div>
    <div id="msg" class="hint" style="margin-top:6px;">æº–å‚™å®Œäº†ã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
  </div>

  <!-- åœ°å›³ -->
  <div class="card" style="margin-top:12px; position:relative">
    <div id="map"></div>
    <div class="compass" id="compass">
      <div class="dial"></div>
      <div class="north">N</div>
      <div class="arrow" id="compassArrow"></div>
      <div class="label">é€²è¡Œæ–¹å‘</div>
    </div>
  </div>

  <!-- æ¤œç´¢çµæœ -->
  <div class="card results" id="results" style="display:none">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div><span class="badge">æ¤œç´¢çµæœï¼ˆè¿‘éš£ ä¸Šä½5ä»¶ï¼‰</span></div>
      <button id="closeResults" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
    <div id="resultList" style="margin-top:8px"></div>
  </div>
</div>

<!-- FAB -->
<div class="fab-col">
  <button id="navStart" class="ok">æ¡ˆå†…é–‹å§‹</button>
  <button id="gotoStart" class="primary">ç¾åœ¨åœ°</button>
  <button id="gotoDest"  class="primary">ç›®çš„åœ°</button>
  <button id="reroute"   class="danger">ãƒªãƒ«ãƒ¼ãƒˆ</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* === è¨­å®š === */
const WORKER_ORIGIN = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy'; // â†è‡ªåˆ†ã®Workersã«å¤‰æ›´å¯
const ROUTE_LANG = 'ja';
let profile = 'foot-walking'; // 'wheelchair' ã«åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ï¼ˆAPIå´ãŒå¯¾å¿œï¼‰

/* === è¦ç´  === */
const els = {
  q: byId('q'),
  mic: byId('mic'),
  search: byId('search'),
  clearHistory: byId('clearHistory'),
  results: byId('results'),
  resultList: byId('resultList'),
  closeResults: byId('closeResults'),
  startLat: byId('startLat'),
  startLon: byId('startLon'),
  destLat: byId('destLat'),
  destLon: byId('destLon'),
  getRoute: byId('getRoute'),
  clear: byId('clear'),
  modeWalk: byId('modeWalk'),
  modeWheel: byId('modeWheel'),
  navStart: byId('navStart'),
  gotoStart: byId('gotoStart'),
  gotoDest: byId('gotoDest'),
  reroute: byId('reroute'),
  msg: byId('msg'),
  compassArrow: byId('compassArrow'),
};

/* === åœ°å›³ === */
const map = L.map('map', { zoomControl: true }).setView([34.342,134.046], 16);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);

// ãƒ¬ã‚¤ãƒ¤ç®¡ç†ï¼ˆç›®çš„åœ°ãƒœã‚¿ãƒ³ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ä¸€å…ƒåŒ–ï¼‰
const routeGroup = L.layerGroup().addTo(map);

let currentMarker = null;
let destMarker = null;
let routeLine = null;

let watchId = null;
let lastHeading = null;

/* === Util === */
function byId(id){return document.getElementById(id)}
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

function toNum(v){const n=Number(v);return Number.isFinite(n)?n:null;}
function haversine(a,b){
  const toRad = x=>x*Math.PI/180;
  const R=6371000;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lng - a.lng);
  const s1 = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(s1));
}

/* === ç¾åœ¨åœ° === */
async function initGeolocation(){
  if(!navigator.geolocation){
    els.msg.textContent='ã“ã®ç«¯æœ«ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
    return;
  }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude, heading} = pos.coords;
    setStart(longitude, latitude);
    updateCurrent({lat:latitude, lng:longitude});
    if(typeof heading==='number') updateCompass(heading);
    map.setView([latitude, longitude], 17);
  }, err=>{
    els.msg.textContent='ç¾åœ¨åœ°ã®å–å¾—ã«å¤±æ•—ï¼š'+err.message;
  }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});

  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition(pos=>{
    const {latitude, longitude, heading} = pos.coords;
    updateCurrent({lat:latitude, lng:longitude});
    if(typeof heading==='number') updateCompass(heading);
  }, ()=>{}, {enableHighAccuracy:true, maximumAge:3000, timeout:10000});
}
function updateCurrent(latlng){
  if(!currentMarker){
    currentMarker = L.marker(latlng, {title:'ç¾åœ¨åœ°'}).addTo(map);
  }else{
    currentMarker.setLatLng(latlng);
  }
}

function updateCompass(heading){
  lastHeading = heading;
  els.compassArrow.style.transform = `rotate(${heading}deg)`;
}
function setStart(lon,lat){
  els.startLon.value = (lon??'').toString();
  els.startLat.value = (lat??'').toString();
}
function setDest(lon,lat){
  els.destLon.value = (lon??'').toString();
  els.destLat.value = (lat??'').toString();
  if(Number.isFinite(lat) && Number.isFinite(lon)){
    if(!destMarker){
      destMarker = L.marker([lat,lon], {title:'ç›®çš„åœ°', draggable:false}).addTo(map);
    }else{
      destMarker.setLatLng([lat,lon]);
    }
  }
}

/* === ç›®çš„åœ°ã‚’é•·æŠ¼ã—ã§è¨­å®š === */
map.on('contextmenu',(e)=>{ // é•·æŠ¼ã—/å³ã‚¯ãƒªãƒƒã‚¯
  const {lat,lng} = e.latlng;
  setDest(lng, lat);
  els.msg.textContent='ç›®çš„åœ°ã‚’è¨­å®šã—ã¾ã—ãŸ';
});

/* === ãƒ«ãƒ¼ãƒˆå–å¾— === */
async function getRoute(){
  const slon = toNum(els.startLon.value), slat = toNum(els.startLat.value);
  const dlon = toNum(els.destLon.value), dlat = toNum(els.destLat.value);
  if([slon,slat,dlon,dlat].some(v=>v===null)){ els.msg.textContent='åº§æ¨™ãŒä¸è¶³ã—ã¦ã„ã¾ã™'; return}
  const body = {
    coordinates: [[slon, slat],[dlon, dlat]],
    instructions: true,
    language: ROUTE_LANG,
    profile: profile
  };
  els.msg.textContent='ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦';
  try{
    const res = await fetch(WORKER_ORIGIN, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status) }
    const json = await res.json();
    drawRoute(json);
    els.msg.textContent='ãƒ«ãƒ¼ãƒˆå–å¾—å®Œäº†';
    // ä¿¯ç°è¡¨ç¤º
    if(routeLine){ map.fitBounds(routeLine.getBounds(), {padding:[30,30]}); }
  }catch(e){
    console.error(e);
    els.msg.textContent='ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}
function drawRoute(json){
  routeGroup.clearLayers();
  const geom = json?.routes?.[0]?.geometry;
  if(!geom){ return }
  const coords = L.Polyline.fromEncoded(geom).getLatLngs?.() || decodePoly(geom); // äº’æ›
  routeLine = L.polyline(coords, {color:'#3fb5ff', weight:6, opacity:0.9}).addTo(routeGroup);
}
function decodePoly(encoded){ // äº’æ›ãƒ‡ã‚³ãƒ¼ãƒ€ï¼ˆå¿µã®ãŸã‚ï¼‰
  // Leaflet 1.9 ã«ã¯ fromEncoded ãŒç„¡ã„å ´åˆã‚ã‚Š â†’ ã“ã“ã§ã¯ORSã®polylineã‚’ç°¡æ˜“å¯¾å¿œ
  // å—ã‘å´ãŒpolyline6ã‹geojsonã‹ã§å·®ç•°ãŒã‚ã‚‹ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦ç½®æ›
  try{
    return L.Polyline.fromEncoded(encoded).getLatLngs();
  }catch{return []}
}

/* === æ¤œç´¢ï¼ˆPhotonï¼‰ === */
function normalizeQuery(q){
  const t = q.trim();
  if(!t) return t;
  // ã‚ˆãèª¤èªã™ã‚‹ãƒã‚§ãƒ¼ãƒ³ã«ã‚«ãƒ†ã‚´ãƒªã‚’è£œã†
  const chainHints = [
    {kw:/ãƒãƒ«ãƒŠã‚«|marunaka/i, add:' ã‚¹ãƒ¼ãƒ‘ãƒ¼'},
    {kw:/ã‚¤ã‚ªãƒ³/i, add:' ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«'},
    {kw:/ãƒ­ãƒ¼ã‚½ãƒ³|ãƒ•ã‚¡ãƒŸãƒ|ã‚»ãƒ–ãƒ³/i, add:' ã‚³ãƒ³ãƒ“ãƒ‹'},
  ];
  let out = t;
  for(const h of chainHints){ if(h.kw.test(t)) out = t + h.add }
  return out;
}
function isWaterish(feature){
  const name = (feature.properties?.name||'') + (feature.properties?.city||'');
  const waterWords = /(æ± |æ²¼|æ¹–|å·|æ²¢|ç”¨æ°´|ãƒ€ãƒ |æµ·|æ½Ÿ)/;
  const osmVal = (feature.properties?.osm_value||'').toLowerCase();
  const blockValues = ['water','reservoir','basin','river','lake','sea','dam','wetland'];
  if(waterWords.test(name)) return true;
  if(blockValues.some(v=>osmVal.includes(v))) return true;
  return false;
}
async function searchNearby(){
  const q0 = els.q.value || '';
  const q = normalizeQuery(q0);
  const lat = toNum(els.startLat.value);
  const lon = toNum(els.startLon.value);
  if(!q){ els.msg.textContent='æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'; return;}
  if(lat===null||lon===null){ els.msg.textContent='ã¾ãšç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãã ã•ã„'; return;}
  els.msg.textContent='æ¤œç´¢ä¸­â€¦';

  const url = new URL('https://photon.komoot.io/api/');
  url.searchParams.set('q', q);
  url.searchParams.set('lang', 'ja');
  url.searchParams.set('lat', lat);
  url.searchParams.set('lon', lon);
  url.searchParams.set('limit', '15');

  try{
    const res = await fetch(url.toString());
    const js = await res.json();

    // è¿‘è·é›¢å„ªå…ˆã§ä¸¦ã¹æ›¿ãˆï¼‹ãƒ•ã‚£ãƒ«ã‚¿
    const here = L.latLng(lat, lon);
    let items = (js.features||[])
      .filter(f=>!isWaterish(f))
      .map(f=>{
        const p = f.properties;
        const c = f.geometry.coordinates; // [lon,lat]
        const ll = L.latLng(c[1], c[0]);
        return {
          name: p.name || p.street || p.city || 'åç§°ä¸æ˜',
          addr: [p.city,p.street,p.housenumber].filter(Boolean).join(' '),
          lon: c[0], lat: c[1],
          dist: here.distanceTo(ll) // meters
        };
      })
      .sort((a,b)=>a.dist-b.dist)
      .slice(0,5);

    showResults(items, q);
    saveHistory(q0); // ç”Ÿã®å…¥åŠ›ã§å±¥æ­´ä¿å­˜
    els.msg.textContent = items.length? 'å€™è£œã‚’è¡¨ç¤ºã—ã¾ã—ãŸ' : 'è¿‘éš£ã«å€™è£œãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
  }catch(e){
    console.error(e);
    els.msg.textContent='æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ';
  }
}
function showResults(items, q){
  els.results.style.display = 'block';
  els.resultList.innerHTML = '';
  if(items.length===0){
    els.resultList.innerHTML = '<div class="hint">è©²å½“ãªã—</div>';
    return;
  }
  items.forEach((it, idx)=>{
    const div = document.createElement('div');
    div.className = 'result';
    div.innerHTML = `
      <div><strong>${idx+1}. ${escapeHtml(it.name)}</strong></div>
      <small>${(it.dist/1000).toFixed(2)} km ã€€${escapeHtml(it.addr)}ã€€<span class="badge">${it.lat.toFixed(5)}, ${it.lon.toFixed(5)}</span></small>
    `;
    div.addEventListener('click', ()=>{
      setDest(it.lon, it.lat);
      map.flyTo([it.lat, it.lon], 17);
      els.results.style.display='none';
      // ã™ããƒ«ãƒ¼ãƒˆå–å¾—
      getRoute();
    });
    els.resultList.appendChild(div);
  });
}
function escapeHtml(s){return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/* === å±¥æ­´ === */
const HISTORY_KEY = 'mc_search_history';
function loadHistory(){
  try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]') }catch{ return [] }
}
function saveHistory(q){
  if(!q) return;
  const arr = loadHistory().filter(x=>x!==q);
  arr.unshift(q);
  localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,20)));
}
function clearHistory(){
  localStorage.removeItem(HISTORY_KEY);
  els.q.value = '';
  els.results.style.display='none';
  els.resultList.innerHTML = '';
  els.msg.textContent = 'å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
}

/* === ã‚¤ãƒ™ãƒ³ãƒˆ === */
els.search.addEventListener('click', searchNearby);
els.mic.addEventListener('click', startVoice);
els.clearHistory.addEventListener('click', clearHistory);
els.closeResults.addEventListener('click', ()=> els.results.style.display='none');

els.modeWalk.addEventListener('click', ()=>{
  profile = 'foot-walking';
  els.modeWalk.className='primary';
  els.modeWheel.className='ghost';
});
els.modeWheel.addEventListener('click', ()=>{
  profile = 'wheelchair';
  els.modeWalk.className='ghost';
  els.modeWheel.className='primary';
});

els.getRoute.addEventListener('click', getRoute);
els.clear.addEventListener('click', ()=>{
  routeGroup.clearLayers();
  if(destMarker){ map.removeLayer(destMarker); destMarker=null; }
  els.destLat.value = els.destLon.value = '';
  els.msg.textContent='ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
});

els.navStart.addEventListener('click', async ()=>{
  if(!routeLine){ await getRoute(); await sleep(300); }
  if(routeLine){
    // ä¿¯ç° â†’ å°‘ã—å¾…ã£ã¦ã‹ã‚‰ç¾åœ¨åœ°ã«æˆ»ã™
    map.fitBounds(routeLine.getBounds(), {padding:[30,30]});
    await sleep(900);
    if(currentMarker) map.flyTo(currentMarker.getLatLng(), 18);
    els.msg.textContent='æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™';
  }else{
    els.msg.textContent='å…ˆã«ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„';
  }
});

els.gotoStart.addEventListener('click', ()=>{
  if(currentMarker){ map.flyTo(currentMarker.getLatLng(), 18); }
});
els.gotoDest.addEventListener('click', ()=>{
  if(destMarker){ map.flyTo(destMarker.getLatLng(), 18); }
  // ã“ã“ã§çµ¶å¯¾ã«ãƒ«ãƒ¼ãƒˆã‚„ãƒ¬ã‚¤ãƒ¤ã¯è§¦ã‚‰ãªã„ï¼ˆä»¥å‰ã®ä¸å…·åˆå¯¾ç­–ï¼‰
});
els.reroute.addEventListener('click', getRoute);

/* === éŸ³å£°å…¥åŠ› === */
function startVoice(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ els.msg.textContent='éŸ³å£°å…¥åŠ›ã«æœªå¯¾å¿œã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã™'; return;}
  const rec = new SR();
  rec.lang = 'ja-JP';
  rec.interimResults = false;
  rec.maxAlternatives = 1;
  rec.onresult = (ev)=>{
    const t = ev.results[0][0].transcript || '';
    els.q.value = t;
    searchNearby();
  };
  rec.onerror = ()=>{ els.msg.textContent='éŸ³å£°å…¥åŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ'; }
  rec.start();
}

/* === èµ·å‹•å‡¦ç† === */
initGeolocation();

/* === å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ === */
</script>
</body>
</html>