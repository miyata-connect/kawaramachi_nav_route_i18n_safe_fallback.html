<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalkNav v5</title>
  <style>
:root{
  --glass: rgba(20,28,44,.7);
  --glass-strong: rgba(16,22,36,.85);
  --stroke: rgba(255,255,255,.14);
  --text: #eaf2ff;
  --muted:#a7b8ce;
  --primary:#5fb1ff;
  --ok:#25d07a;
  --danger:#ff6565;
  --accent:#64d2ff;
}
html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
*{box-sizing:border-box}
.app{position:relative;height:100dvh;overflow:hidden}
#map{position:absolute;inset:0;display:none}

/* Info panel */
.info-panel{
  position:absolute;left:10px;right:10px;top:10px;
  background:var(--glass);border:1px solid var(--stroke);border-radius:12px;
  backdrop-filter:blur(14px);padding:14px 14px 18px;z-index:460;color:var(--text);
  display:none;pointer-events:none;
}
.info-panel.show{display:block!important}
.route-main{font-size:27px;font-weight:700;margin-bottom:10px;line-height:1.4;text-align:center}
.route-time{font-size:16px;color:var(--text);display:flex;gap:20px;font-weight:600;margin-bottom:12px;justify-content:center}
.route-time span{display:flex;align-items:center;gap:4px}
.location-name{font-size:20px;font-weight:700;color:var(--primary);white-space:nowrap;text-align:center}
.weather-row{display:flex;align-items:center;justify-content:center;gap:10px}
.weather-items{display:flex;gap:4px;flex:1;justify-content:center;align-items:center}
.weather-arrow{color:var(--muted);font-size:18px;font-weight:900}
.weather-item{text-align:center;font-size:11px;color:var(--text);padding:8px 6px;background:rgba(16,22,36,.25);border-radius:8px;min-width:60px}
.weather-time{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:2px}
.weather-icon{font-size:20px;margin:2px 0}
.weather-temp{font-weight:700;font-size:13px}
.weather-rain{color:var(--accent);font-size:11px;font-weight:700}

/* Right side buttons */
.right-buttons{
  position:absolute;right:10px;top:359px;z-index:470;display:flex;flex-direction:column;gap:10px;pointer-events:none;
}
.right-btn{
  width:65px;height:65px;background:rgba(16,22,36,.25);
  border:1px solid rgba(255,255,255,.3);border-radius:10px;color:#fff;font-size:11px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  cursor:pointer;font-weight:700;gap:2px;pointer-events:auto;
  box-shadow:0 8px 32px rgba(0,0,0,.4);backdrop-filter:blur(24px) saturate(200%);
}
.right-btn.primary{background:rgba(95,177,255,.6);border:1px solid rgba(255,255,255,.4);color:#000}
.right-btn.ok{background:rgba(37,208,122,.6);border:1px solid rgba(255,255,255,.4);color:#000}
.right-btn.danger{background:rgba(255,101,101,.6);border:1px solid rgba(255,255,255,.4);color:#fff}
.right-btn.danger:disabled{opacity:1;background:rgba(255,101,101,.6);cursor:not-allowed;color:#fff}
.right-btn.accent{background:rgba(100,210,255,.6);border:1px solid rgba(255,255,255,.4);color:#000}
.right-btn.warning{background:rgba(255,165,0,.6);border:1px solid rgba(255,255,255,.4);color:#000}

/* pictogram box */
.ic{width:24px;height:24px;background-repeat:no-repeat;background-position:center;background-size:24px;margin-bottom:2px}

/* monochrome SVGs */
.ico-target .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><path d="M12 1v4M12 19v4M1 12h4M19 12h4"/></svg>');}
.ico-search .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="6"/><path d="M20 20l-3.5-3.5"/></svg>');}
.ico-stop .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="5" width="4" height="14"/><rect x="14" y="5" width="4" height="14"/></svg>');}
.ico-pin .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s7-6.2 7-12a7 7 0 0 0-14 0c0 5.8 7 12 7 12z"/><circle cx="12" cy="10" r="3"/></svg>');}
.ico-reroute .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 15-6"/><path d="M18 3v6h-6"/><path d="M21 12a9 9 0 0 1-15 6"/><path d="M6 21v-6h6"/></svg>');}
.ico-move .ic{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l3 3-3 3-3-3 3-3zM12 16l3 3-3 3-3-3 3-3zM2 12l3-3 3 3-3 3-3-3zM22 12l-3-3-3 3 3 3 3-3z"/></svg>');}

/* Search panel */
.control-panel{
  position:absolute;left:10px;right:10px;bottom:0;z-index:500;background:var(--glass);
  border:1px solid var(--stroke);border-radius:16px 16px 0 0;backdrop-filter:blur(14px);
  padding:16px;transition:transform .3s
}
.control-panel.hidden{transform:translateY(100%)}
.panel-row{display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap}
.panel-btn{
  flex:1;min-width:120px;background:var(--glass-strong);border:1px solid var(--stroke);
  border-radius:10px;padding:10px;color:#fff;font-size:14px;text-align:center;cursor:pointer;font-weight:700
}
.panel-btn.primary{background:var(--primary);border:none;color:#000}
input{width:100%;background:var(--glass-strong);border:1px solid var(--stroke);color:var(--text);border-radius:10px;padding:10px;font-size:14px}

/* Map d-pad */
.map-controls{position:fixed;right:97px;bottom:25px;z-index:450;display:none;gap:8px}
.map-controls.show{display:flex;flex-direction:column;align-items:center}
.map-control-row{display:flex;gap:8px}
.map-control-btn{
  width:65px;height:65px;background:rgba(16,22,36,.85);border:1px solid var(--stroke);border-radius:10px;
  color:#fff;font-size:20px;cursor:pointer;font-weight:700;display:flex;align-items:center;justify-content:center;user-select:none;box-shadow:0 2px 6px rgba(0,0,0,.3);backdrop-filter:blur(6px)
}
.map-control-btn:active{background:var(--primary)}

/* Results */
.results-panel{
  position:absolute;left:10px;right:10px;bottom:10px;max-height:60vh;overflow-y:auto;
  background:var(--glass);border:1px solid var(--stroke);border-radius:12px;padding:10px;z-index:510;display:none
}
.result-item{padding:10px;border-bottom:1px solid var(--stroke);cursor:pointer}
.result-item:hover{background:rgba(95,177,255,.2)}
.result-close{text-align:center;padding:8px;color:var(--primary);cursor:pointer}

/* Banners */
.error-banner{position:absolute;left:10px;right:10px;bottom:10px;background:var(--danger);color:#fff;border-radius:10px;padding:10px;text-align:center;z-index:999}
.success-banner{position:absolute;left:10px;right:10px;bottom:10px;background:#7ed321;color:#000;border-radius:10px;padding:10px;text-align:center;z-index:999;font-weight:700}
.hidden{display:none}

/* Hide Google default */
.gm-control-active.gm-fullscreen-control{display:none!important}
.gm-svpc,.gm-style .gm-style-cc{display:none!important}

/* Misc */
.panel-toggle{display:none!important}
  </style>
</head>
<body>
  <div class="app">
    <div id="map"></div>

    <!-- Info panel -->
    <div id="infoPanel" class="info-panel">
      <div class="route-main">
        <div id="routeText">ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
        <div style="text-align:center;font-size:12px;color:var(--muted);margin-top:6px;font-weight:600;">åŠå¾„5kmåœå†…ã®æƒ…å ±ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</div>
        <div id="incidentMarquee" style="background:rgba(255,101,101,.2);border-radius:6px;padding:2px 8px;margin-top:6px;overflow:hidden;white-space:nowrap;height:24px;display:flex;align-items:center;">
          <div id="incidentText" style="display:inline-block;font-size:18px;color:#ff6565;">ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        </div>
      </div>
      <div class="route-time">
        <span><span style="display:inline-block;line-height:1.2;">ç¾åœ¨<br>æ™‚åˆ»</span> <span id="currentTime" style="font-size:20px;">--:--</span></span>
        <span><span style="display:inline-block;line-height:1.2;">åˆ°ç€<br>äºˆæƒ³</span> <span id="arrivalTime" style="font-size:20px;">--:--</span></span>
        <span><span style="display:inline-block;line-height:1.2;">æ‰€è¦<br>æ™‚é–“</span> <span id="durationTime" style="font-size:20px;">--:--</span></span>
      </div>
      <div class="location-name" id="locationName">èª­ã¿è¾¼ã¿ä¸­...</div>
      <div class="weather-row">
        <div class="weather-items">
          <div class="weather-item"><div class="weather-time">3H</div><div class="weather-icon" id="w3h">â˜ï¸</div><div class="weather-temp" id="t3h">--Â°</div><div class="weather-rain" id="r3h">--%</div></div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item"><div class="weather-time">6H</div><div class="weather-icon" id="w6h">â˜ï¸</div><div class="weather-temp" id="t6h">--Â°</div><div class="weather-rain" id="r6h">--%</div></div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item"><div class="weather-time">9H</div><div class="weather-icon" id="w9h">â˜ï¸</div><div class="weather-temp" id="t9h">--Â°</div><div class="weather-rain" id="r9h">--%</div></div>
          <div class="weather-arrow">â†’</div>
          <div class="weather-item"><div class="weather-time">12H</div><div class="weather-icon" id="w12h">â˜ï¸</div><div class="weather-temp" id="t12h">--Â°</div><div class="weather-rain" id="r12h">--%</div></div>
        </div>
      </div>
      <div id="coordsDisplay" style="text-align:center;font-size:17px;color:var(--muted);margin-top:8px;font-weight:600;">ğŸ“ ç·¯åº¦: -- / çµŒåº¦: --</div>
    </div>

    <!-- Right buttons -->
    <div class="right-buttons" id="rightButtons">
      <button class="right-btn ico-target" onclick="zoomToCurrentLocation()">
        <span class="ic"></span><div>ç¾åœ¨åœ°</div>
      </button>
      <button class="right-btn accent ico-search" onclick="showSearchPanel()">
        <span class="ic"></span><div>æ¤œç´¢</div>
      </button>
      <button class="right-btn danger ico-stop" id="stopNavBtn" onclick="stopNav()" disabled>
        <span class="ic"></span><div>æ¡ˆå†…åœæ­¢</div>
      </button>
      <button class="right-btn warning ico-pin" onclick="showSearchPanel()">
        <span class="ic"></span><div>ç›®çš„åœ°</div>
      </button>
      <button class="right-btn ok ico-reroute" onclick="reroute(true)">
        <span class="ic"></span><div>ãƒªãƒ«ãƒ¼ãƒˆ</div>
      </button>
      <button class="right-btn primary ico-move" onclick="toggleMapControls()">
        <span class="ic"></span><div>æ“ä½œ</div>
      </button>
    </div>

    <!-- Map d-pad -->
    <div id="mapControls" class="map-controls">
      <div class="map-control-row"><div class="map-control-btn" onclick="event.preventDefault();panUp()">â†‘</div></div>
      <div class="map-control-row">
        <div class="map-control-btn" onclick="event.preventDefault();panLeft()">â†</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomIn()">+</div>
        <div class="map-control-btn" onclick="event.preventDefault();zoomOut()">âˆ’</div>
        <div class="map-control-btn" onclick="event.preventDefault();panRight()">â†’</div>
      </div>
      <div class="map-control-row"><div class="map-control-btn" onclick="event.preventDefault();panDown()">â†“</div></div>
    </div>

    <!-- Search panel -->
    <div id="controlPanel" class="control-panel hidden">
      <div class="panel-row"><input type="text" id="searchBox" placeholder="å ´æ‰€ã‚’æ¤œç´¢..." /></div>
      <div class="panel-row">
        <button class="panel-btn primary" onclick="executeSearch()">æ¤œç´¢</button>
        <button class="panel-btn" onclick="document.getElementById('controlPanel').classList.add('hidden')">é–‰ã˜ã‚‹</button>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsPanel" class="results-panel">
      <div id="resultsList"></div>
      <div class="result-close" onclick="hideResults()">é–‰ã˜ã‚‹</div>
    </div>

    <div id="error" class="error-banner hidden"></div>
    <div id="success" class="success-banner hidden"></div>
  </div>

  <script>
"use strict";
let map,directionsService,directionsRenderer,currentMarker=null,destMarker=null,watchId=null,isNavigating=false,currentLocation=null;

/* --- UI helpers --- */
function showError(m){const e=document.getElementById("error");e.textContent=m;e.classList.remove("hidden");setTimeout(()=>e.classList.add("hidden"),3000)}
function showSuccess(m){const e=document.getElementById("success");e.textContent=m;e.classList.remove("hidden");setTimeout(()=>e.classList.add("hidden"),1500)}
function toggleMapControls(){document.getElementById("mapControls").classList.toggle("show")}
function showSearchPanel(){const p=document.getElementById("controlPanel");p.classList.remove("hidden");document.getElementById("searchBox").focus()}
function hideResults(){document.getElementById("resultsPanel").style.display="none"}

/* --- Map init --- */
function initMap(){
  if(!navigator.geolocation){showError("Geolocation not supported");return;}
  navigator.geolocation.getCurrentPosition(pos=>{
    currentLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
    map=new google.maps.Map(document.getElementById("map"),{
      center:currentLocation,zoom:17,mapTypeControl:false,streetViewControl:false,fullscreenControl:false,zoomControl:false,rotateControl:false,scaleControl:false,gestureHandling:"greedy",clickableIcons:false,disableDefaultUI:true
    });
    directionsService=new google.maps.DirectionsService();
    directionsRenderer=new google.maps.DirectionsRenderer({map});

    /* default red pin (no custom icon) */
    currentMarker=new google.maps.Marker({position:currentLocation,map});
    document.getElementById("map").style.display="block";

    document.getElementById("infoPanel").classList.add("show");
    document.getElementById("currentTime").textContent=formatTime(new Date());
    setInterval(()=>{document.getElementById("currentTime").textContent=formatTime(new Date())},60000);

    if(watchId) navigator.geolocation.clearWatch(watchId);
    watchId=navigator.geolocation.watchPosition(p=>{
      currentLocation={lat:p.coords.latitude,lng:p.coords.longitude};
      if(currentMarker) currentMarker.setPosition(currentLocation);
      updateCoordsText();
    });

    updateCoordsText();
    fetchLocationName();
    fetchWeather();
  },err=>showError("Location error: "+err.message));
}

function formatTime(d){const h=d.getHours();const m=String(d.getMinutes()).padStart(2,"0");return `${h}:${m}`}
function zoomToCurrentLocation(){ if(!currentLocation) return; map.panTo(currentLocation); map.setZoom(18) }
function panUp(){const c=map.getCenter();map.panTo({lat:c.lat()+0.001,lng:c.lng()})}
function panDown(){const c=map.getCenter();map.panTo({lat:c.lat()-0.001,lng:c.lng()})}
function panLeft(){const c=map.getCenter();map.panTo({lat:c.lat(),lng:c.lng()-0.001})}
function panRight(){const c=map.getCenter();map.panTo({lat:c.lat(),lng:c.lng()+0.001})}
function zoomIn(){map.setZoom(map.getZoom()+1)}
function zoomOut(){map.setZoom(map.getZoom()-1)}

/* --- Coords & misc --- */
function updateCoordsText(){
  if(!currentLocation) return;
  const el=document.getElementById("coordsDisplay");
  el.textContent=`ğŸ“ ç·¯åº¦: ${currentLocation.lat.toFixed(6)} / çµŒåº¦: ${currentLocation.lng.toFixed(6)}`;
}

/* --- New Places API (searchByText) --- */
async function searchPlacesByText(q){
  const { Place } = await google.maps.importLibrary("places");
  const request = {
    textQuery: q,
    language: "ja",
    locationBias: {
      center: { lat: currentLocation.lat, lng: currentLocation.lng },
      radius: 50000
    },
    fields: ["id","displayName","formattedAddress","location"]
  };
  const result = await Place.searchByText(request);
  const arr = (result?.places || []).map(p=>{
    const lat = typeof p.location?.lat === "function" ? p.location.lat() : p.location?.lat;
    const lng = typeof p.location?.lng === "function" ? p.location.lng() : p.location?.lng;
    return {
      displayName:{text:p.displayName?.text || "Unknown"},
      formattedAddress:p.formattedAddress || "",
      location:{latitude:lat,longitude:lng},
      place_id:p.id || "",
      distance:calculateDistance(currentLocation.lat,currentLocation.lng,lat,lng)
    };
  });
  return arr.sort((a,b)=>a.distance-b.distance);
}

/* --- Search (UI unchanged) --- */
async function executeSearch(){
  const sb=document.getElementById("searchBox");
  if(!sb){showError("æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");return;}
  const q=(sb.value||"").trim();
  if(!q){showError("æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");return;}
  if(!currentLocation){showError("ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­");return;}

  document.getElementById("controlPanel").classList.add("hidden");
  hideResults();
  showSuccess("æ¤œç´¢ä¸­...");

  try{
    const places=await searchPlacesByText(q);
    if(!places.length){showError("çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ");return;}
    displayResults(places.slice(0,5));
  }catch(err){
    console.error("searchByText error:",err);
    showError("æ¤œç´¢ã‚¨ãƒ©ãƒ¼: New Places API");
  }
}

/* --- Results render (unchanged) --- */
function displayResults(places){
  const list=document.getElementById("resultsList"); list.innerHTML="";
  places.forEach(p=>{
    const item=document.createElement("div");
    item.className="result-item";
    const distText=p.distance<1?`${(p.distance*1000).toFixed(0)}m`:`${p.distance.toFixed(1)}km`;
    item.innerHTML=`<div style="font-weight:700">${p.displayName?.text||"Unknown"}</div>
      <div style="font-size:12px;color:var(--muted)">${p.formattedAddress||""}</div>
      <div style="font-size:11px;color:var(--accent);margin-top:4px;">ğŸ“ ${distText}</div>`;
    item.onclick=()=>selectPlace(p);
    list.appendChild(item);
  });
  document.getElementById("resultsPanel").style.display="block";
}

function selectPlace(place){
  const lat=place.location?.latitude, lng=place.location?.longitude;
  if(destMarker) destMarker.setMap(null);
  destMarker=new google.maps.Marker({position:{lat,lng},map});
  map.panTo({lat,lng}); map.setZoom(18);
  hideResults();
  setTimeout(()=>{ if(currentLocation&&destMarker) startNav(); },300);
}

/* --- Routing (unchanged) --- */
function startNav(){
  if(!currentLocation||!destMarker){showError("Location or destination not set");return;}
  directionsService.route({
    origin:currentLocation,
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  },(res,status)=>{
    if(status!=="OK"){showError("Route failed");return;}
    directionsRenderer.setDirections(res); isNavigating=true;
    const btn=document.getElementById("stopNavBtn"); if(btn) btn.disabled=false;
    const leg=res.routes[0].legs[0]; updateRouteTimes(leg);
  });
}
function updateRouteTimes(leg){
  const dist=(leg.distance.value/1000).toFixed(1);
  const dur=Math.round(leg.duration.value/60);
  document.getElementById("routeText").textContent=`${dist}km, ${dur}min`;
  const now=new Date(); const arr=new Date(now.getTime()+leg.duration.value*1000);
  document.getElementById("arrivalTime").textContent=formatTime(arr);
  document.getElementById("durationTime").textContent=`0:${String(dur).padStart(2,"0")}`;
}
function stopNav(){
  if(!isNavigating) return;
  directionsRenderer.setMap(null); directionsRenderer=new google.maps.DirectionsRenderer({map});
  isNavigating=false; const btn=document.getElementById("stopNavBtn"); if(btn) btn.disabled=true;
  document.getElementById("routeText").textContent="ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„";
  document.getElementById("arrivalTime").textContent="--:--";
  document.getElementById("durationTime").textContent="--:--";
}
function reroute(){
  if(!isNavigating){showError("Not navigating");return;}
  directionsService.route({
    origin:currentLocation,
    destination:destMarker.getPosition(),
    travelMode:google.maps.TravelMode.WALKING
  },(res,status)=>{
    if(status!=="OK"){showError("Reroute failed");return;}
    directionsRenderer.setDirections(res);
    updateRouteTimes(res.routes[0].legs[0]);
  });
}

/* --- Utilities --- */
function calculateDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

/* --- OSM reverse & weather (unchanged) --- */
async function fetchLocationName(){
  if(!currentLocation) return;
  try{
    const res=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLocation.lat}&lon=${currentLocation.lng}&format=json&accept-language=ja`);
    const data=await res.json();
    let t="", county=data.address?.county||"", city=data.address?.city||data.address?.town||data.address?.village||"", suburb=data.address?.suburb||"", hamlet=data.address?.hamlet||"", house=data.address?.house_number||"";
    if(county) t+=county; if(city) t+=city; if(suburb) t+=suburb; if(hamlet) t+=hamlet; if(house) t+=house;
    if(t) t+="ä»˜è¿‘"; if(!t) t="èª­ã¿è¾¼ã¿ä¸­...";
    const el=document.getElementById("locationName"); if(el) el.textContent=t;
  }catch{ const el=document.getElementById("locationName"); if(el) el.textContent="èª­ã¿è¾¼ã¿ä¸­..."; }
}
async function fetchWeather(){
  if(!currentLocation) return;
  try{
    const res=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${currentLocation.lat}&longitude=${currentLocation.lng}&hourly=temperature_2m,precipitation_probability,weathercode&timezone=Asia/Tokyo&forecast_days=1`);
    const data=await res.json();
    const now=new Date(); const cur=now.getHours(); const hours=[3,6,9,12];
    const icons={0:"â˜€ï¸",1:"ğŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ğŸŒ«ï¸",48:"ğŸŒ«ï¸",51:"ğŸŒ¦ï¸",53:"ğŸŒ§ï¸",55:"ğŸŒ§ï¸",61:"ğŸŒ§ï¸",63:"ğŸŒ§ï¸",65:"ğŸŒ§ï¸",71:"ğŸŒ¨ï¸",73:"ğŸŒ¨ï¸",75:"ğŸŒ¨ï¸",77:"ğŸŒ¨ï¸",80:"ğŸŒ§ï¸",81:"ğŸŒ§ï¸",82:"ğŸŒ§ï¸",85:"ğŸŒ¨ï¸",86:"ğŸŒ¨ï¸",95:"â›ˆï¸",96:"â›ˆï¸",99:"â›ˆï¸"};
    hours.forEach(h=>{
      const tgt=(cur+h)%24;
      const idx=data.hourly.time.findIndex(t=>new Date(t).getHours()===tgt);
      if(idx>=0){
        const temp=Math.round(data.hourly.temperature_2m[idx]);
        const rain=data.hourly.precipitation_probability[idx]||0;
        const code=data.hourly.weathercode[idx];
        const icon=icons[code]||"â˜ï¸";
        const w=document.getElementById(`w${h}h`), t=document.getElementById(`t${h}h`), r=document.getElementById(`r${h}h`);
        if(w) w.textContent=icon; if(t) t.textContent=`${temp}Â°`; if(r) r.textContent=`${rain}%`;
      }
    });
  }catch(e){console.error("Weather error:",e)}
  fetchIncidents();
}
let lastIncidentTime=0, currentIncidentText="";
function fetchIncidents(){
  const msgs=[
    "âš ï¸ ç¾åœ¨ã€å‘¨è¾ºåŠå¾„5kmåœå†…ã§ç‰¹ã«å ±å‘Šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚",
    "â˜” é™é›¨ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚å‚˜ã®æº–å‚™ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
    "âš¡ é›·æ³¨æ„å ±ãŒç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã™ã€‚å»ºç‰©å†…ã¸ã®é¿é›£ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",
    "ğŸŒ«ï¸ è¦–ç•Œä¸è‰¯ãŒäºˆæƒ³ã•ã‚Œã¦ã„ã¾ã™ã€‚æ­©è¡Œæ™‚ã¯å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "ğŸš¸ å­¦æ ¡ä»˜è¿‘ã§ã¯å…ç«¥ãƒ»ç”Ÿå¾’ã®é€šè¡Œã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "ğŸ¦Œ é‡ç”Ÿå‹•ç‰©ã®å‡ºæ²¡æƒ…å ±ãŒã‚ã‚Šã¾ã™ã€‚å‘¨å›²ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚",
    "âš ï¸ å·¥äº‹åŒºé–“ãŒã‚ã‚Šã¾ã™ã€‚è¿‚å›è·¯ã®åˆ©ç”¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚"
  ];
  const msg=msgs[Math.floor(Math.random()*msgs.length)];
  const now=Date.now(); const el=document.getElementById("incidentText"); if(!el) return;
  if(msg===currentIncidentText && (now-lastIncidentTime)<180000){ el.style.animation="none"; el.textContent=currentIncidentText; return; }
  currentIncidentText=msg; lastIncidentTime=now; el.textContent=msg; el.style.animation="marquee 20s linear infinite";
  setTimeout(()=>{ if(el) el.style.animation="none"; },20000);
}
  </script>

  <!-- Maps JavaScript API (browser key) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4&callback=initMap" async defer></script>
</body>
</html>