<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ISSUE_ID: idx202511010915 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x-issue" content="idx202511010915">
  <title>WalkNav</title>
  <style>
    :root{
      --glass: rgba(20,28,44,.70);
      --glass-strong: rgba(16,22,36,.85);
      --stroke: rgba(255,255,255,.12);
      --text: #eaf2ff;
      --muted:#a7b8ce;
      --primary:#64b5ff;
      --ok:#25d07a;
      --danger:#ff6565;
      --accent:#64d2ff;
      --panel-z:3000;
      --fab-z:4000;
      --toast-z:9000;
    }
    html,body{height:100%;margin:0;background:#0a1321;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .app{position:relative;height:100dvh;overflow:hidden}
    #map{position:absolute;inset:0}
    /* Top info strip */
    .top-strip{
      position:absolute;left:12px;right:12px;top:10px;
      display:flex;gap:10px;align-items:center;
      z-index:var(--fab-z);
      pointer-events:none;
    }
    .chip{
      pointer-events:auto;
      background:var(--glass-strong);color:var(--text);
      border:1px solid var(--stroke);
      border-radius:14px;padding:10px 14px;backdrop-filter:blur(10px);
      box-shadow:0 6px 22px rgba(0,0,0,.28);
      display:flex;gap:10px;align-items:center;
    }
    .chip small{opacity:.8}
    .bar{flex:1;height:8px;border-radius:999px;background:rgba(255,255,255,.16);overflow:hidden}
    .bar>i{display:block;height:100%;width:60%;background:linear-gradient(90deg,#3ddc84,#20bd5f)}
    /* Control panel (bottom) */
    .panel{
      position:absolute;left:16px;right:16px;bottom:10px;z-index:var(--panel-z);
      background:linear-gradient(180deg,rgba(18,25,42,.92),rgba(10,18,33,.92));
      border:1px solid var(--stroke);border-radius:22px;backdrop-filter:blur(12px);
      box-shadow:0 10px 40px rgba(0,0,0,.35);padding:16px;
    }
    .panel h2{margin:0 0 14px;font-size:24px;letter-spacing:.04em}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .pill{
      background:rgba(255,255,255,.08);border:1px solid var(--stroke);color:var(--text);
      padding:10px 14px;border-radius:16px
    }
    .seg{display:flex;gap:10px}
    .seg button{min-width:92px}
    button{
      appearance:none;border:none;border-radius:16px;padding:12px 16px;
      color:var(--text);background:rgba(255,255,255,.09);
      border:1px solid var(--stroke);cursor:pointer;transition:transform .02s ease;
      box-shadow:0 6px 18px rgba(0,0,0,.22)
    }
    button:active{transform:translateY(1px)}
    .b-primary{background:#4ca9ff}
    .b-danger{background:#ff6b6b}
    .b-ok{background:#2bd07a}
    .muted{color:var(--muted)}
    input[type="text"]{
      flex:1;min-width:220px;
      background:rgba(255,255,255,.07);border:1px solid var(--stroke);
      color:var(--text);border-radius:16px;padding:12px 14px;outline:none;
    }
    /* Right FAB stack */
    .fab{position:absolute;right:14px;bottom:120px;display:flex;flex-direction:column;gap:12px;z-index:var(--fab-z)}
    .fab button{width:150px;text-align:center;border-radius:18px;background:rgba(14,22,38,.9)}
    /* Toast */
    .toast{
      position:absolute;right:12px;top:12px;z-index:var(--toast-z);
      background:rgba(0,0,0,.88);color:#fff;border-radius:12px;padding:10px 14px;border:1px solid rgba(255,255,255,.15);
      box-shadow:0 8px 24px rgba(0,0,0,.3)
    }
    /* Loading overlay (auto removed) */
    #loading{
      position:absolute;inset:0;background:#000;display:flex;align-items:center;justify-content:center;
      color:#fff;z-index:999999; /* but will be removed */
    }
    #loading.hidden{display:none;pointer-events:none}
    /* AdvancedMarker ripple */
    .pulse{
      width:18px;height:18px;background:#2aa7ff;border-radius:50%;position:relative;box-shadow:0 0 0 2px #fff inset
    }
    .pulse::after{
      content:"";position:absolute;inset:-10px;border-radius:50%;
      border:2px solid #2aa7ff;animation:pulse 1.6s ease-out infinite
    }
    @keyframes pulse {from{opacity:.9;transform:scale(.4)}to{opacity:0;transform:scale(1.8)}}
    /* Click-through safety when hidden */
    .pointer-none{pointer-events:none}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div id="loading"><div style="text-align:center;line-height:1.8">
      <div style="font-size:20px">現在地取得中です。ご迷惑をお掛けします。</div>
      <div style="opacity:.9">現在地表示まで <b>30秒</b> 程度お待ちください。</div>
    </div></div>

    <div id="map" aria-label="map"></div>

    <!-- top info: current coord + score bar -->
    <div class="top-strip">
      <div class="chip" id="coordChip"><small>現在地:</small><span id="coordText">--, --</span></div>
      <div class="chip" style="gap:12px"><div class="bar"><i id="scoreBar"></i></div><small>診断: <b id="scoreText">80点</b></small></div>
    </div>

    <!-- floating buttons -->
    <div class="fab">
      <button id="btnLocate">現在地</button>
      <button id="btnPause">一時停止</button>
      <button id="btnReroute">リルート</button>
    </div>

    <!-- bottom panel -->
    <section class="panel" id="panel">
      <h2>近くを検索（<span id="radiusView">10km</span> / 5件）</h2>
      <div class="row seg">
        <button class="pill b-primary" data-radius="10">10km</button>
        <button class="pill" data-radius="20">20km</button>
      </div>
      <div class="row" style="margin-top:12px">
        <input id="q" type="text" placeholder="店舗名・電話番号・住所・座標など">
        <button id="btnText" class="b-primary">入力検索</button>
        <button id="btnVoice" class="b-ok">音声検索</button>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnReset" class="b-danger">リセット</button>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="muted" id="now">現在地： 緯度 -- / 経度 --</div>
      </div>
    </section>

    <div id="toast" class="toast pointer-none" style="display:none"></div>
  </div>

  <!-- Maps JS API (AdvancedMarker) -->
  <script>
    // NOTE: Browser key per policy
    window.GMAPS_KEY = "AIzaSyBzojEE2142O8dWPd7gmcAj-FyWumYyFy4";
  </script>
  <script async src="https://maps.googleapis.com/maps/api/js?key=%7B%7BKEY%7D%7D&loading=async&v=weekly&libraries=marker,places".replace("%7B%7BKEY%7D%7D",window.GMAPS_KEY)></script>

  <!-- Minimal audit client -->
  <script>
  /* ISSUE_ID: aud202511011958 (client hook embedded) */
  const Audit = (() => {
    const state = {
      endpoint: "https://ors-proxy-dev.miyata-connect-jp.workers.dev",
      issueTag: "",
      enabled: true
    };
    function setIssue(tag){ state.issueTag = String(tag||""); }
    async function run(payload){
      if(!state.enabled) return;
      try{
        await fetch(`${state.endpoint}/audit/run`,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({...payload, issue: state.issueTag || undefined})
        });
      }catch(_){}
    }
    return { setIssue, run };
  })();
  </script>

  <!-- App -->
  <script>
  (function(){
    const $ = (s, r=document)=> r.querySelector(s);
    const $$= (s, r=document)=> Array.from(r.querySelectorAll(s));
    const app = $("#app");
    const toast = $("#toast");
    const loading = $("#loading");
    const coordText = $("#coordText");
    const nowText = $("#now");
    const scoreBar = $("#scoreBar");
    const scoreText= $("#scoreText");
    const radiusView = $("#radiusView");
    const radiusButtons = $$("[data-radius]");
    let map, advMarker, watchId=null, radiusKm=10, locked=false;

    // --- safety: always remove overlay ---
    const removeOverlay = () => loading && loading.classList.add("hidden");
    setTimeout(removeOverlay, 10000);

    function showToast(msg,ms=2500){
      toast.textContent = msg;
      toast.style.display="block";
      toast.classList.remove("pointer-none");
      setTimeout(()=>{toast.style.display="none";toast.classList.add("pointer-none")}, ms);
    }

    function setScore(v){
      const n = Math.max(0, Math.min(100, Number(v)||0));
      scoreBar.style.width = `${n}%`;
      scoreText.textContent = `${n}点`;
    }

    // --- Maps init ---
    async function initMapAt(lat,lng,zoom=17){
      const {Map} = await google.maps.importLibrary("maps");
      const {AdvancedMarkerElement} = await google.maps.importLibrary("marker");
      map = new Map($("#map"), {
        center:{lat, lng},
        zoom,
        mapId: "DEMO_MAP"
      });
      const el = document.createElement("div");
      el.className="pulse";
      advMarker = new AdvancedMarkerElement({ map, position:{lat,lng}, content: el });
    }

    function updateMarker(lat,lng){
      if(!advMarker) return;
      advMarker.position = {lat,lng};
    }

    function updateCoordUI(lat,lng){
      const t = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      coordText.textContent = t;
      nowText.textContent = `現在地： 緯度 ${lat.toFixed(6)} / 経度 ${lng.toFixed(6)}`;
    }

    function handleGeoError(err){
      removeOverlay();
      showToast(`位置取得エラー: ${err.code||""}`);
    }

    // --- Geolocation ---
    function startWatch(){
      try{
        watchId = navigator.geolocation.watchPosition(pos=>{
          const {latitude:lat, longitude:lng} = pos.coords;
          if(!map){ initMapAt(lat,lng,17).then(()=> { updateCoordUI(lat,lng); removeOverlay(); }); }
          else { updateMarker(lat,lng); }
          updateCoordUI(lat,lng);
        }, handleGeoError, {enableHighAccuracy:true,maximumAge:1000,timeout:8000});
      }catch(e){ handleGeoError(e); }
    }

    // --- Radius buttons ---
    radiusButtons.forEach(b=>{
      b.addEventListener("click",()=>{
        radiusButtons.forEach(x=>x.classList.remove("b-primary"));
        b.classList.add("b-primary");
        radiusKm = Number(b.dataset.radius)||10;
        radiusView.textContent = `${radiusKm}km`;
      });
    });

    // --- Actions ---
    $("#btnLocate").addEventListener("click", ()=> {
      if(!advMarker || !map) return;
      map.panTo(advMarker.position);
      showToast("現在地へ移動");
    });

    $("#btnPause").addEventListener("click", ()=>{
      if(locked){ startWatch(); locked=false; showToast("追従を再開"); return; }
      if(watchId){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      locked=true; showToast("追従を一時停止");
    });

    $("#btnReroute").addEventListener("click", ()=> showToast("リルート（未実装）"));

    $("#btnReset").addEventListener("click", ()=>{
      $("#q").value="";
      showToast("入力をリセット");
    });

    $("#btnText").addEventListener("click", async ()=>{
      const q = $("#q").value.trim();
      if(!q){ showToast("検索ワードを入力してください"); return; }
      showToast(`「${q}」を${radiusKm}kmで検索（デモ）`);
    });

    $("#btnVoice").addEventListener("click", ()=> showToast("音声検索（未実装）"));

    // --- Panel/FAB layering safety ---
    // (Ensure panel never captures clicks over FABs)
    $("#panel").style.zIndex = getComputedStyle(document.documentElement).getPropertyValue('--panel-z');

    // --- Kickoff ---
    setScore(80);
    Audit.setIssue("wrk202511011945"); // auto from /healthz と合わせる想定
    Audit.run({phase:"entry", score:80, errorRate:0});
    startWatch();

    // Exit hook (pagehide)
    addEventListener("pagehide", ()=> Audit.run({phase:"exit", score:80, errorRate:0}));
  })();
  </script>
</body>
</html>