<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cloudflare Workers ãƒŠãƒ“</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin>
<style>
:root{
  --bg:#0e1a28; --panel:#122335; --panel-2:#0f2236; --text:#eaf4ff; --muted:#9eb4c9;
  --primary:#3a91ff; --success:#22c55e; --danger:#ef4444; --warn:#ff7a59;
  --shadow:0 10px 24px rgba(0,0,0,.24); --radius:14px; --pad:14px;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI",sans-serif}
h1{margin:18px 16px 8px;font-size:28px;font-weight:800}
.container{padding:0 14px 14px}
.row{display:grid;gap:10px}
.row.cols-2{grid-template-columns:1fr 1fr}
.row.cols-3{grid-template-columns:1fr 1fr 1fr}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);padding:var(--pad);box-shadow:var(--shadow)}
label{font-size:13px;color:var(--muted);display:block;margin:0 0 6px 4px}
.input,select{width:100%;height:44px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:var(--panel-2);color:var(--text);padding:10px 12px;font-size:15px;outline:none}
.btn{height:44px;padding:0 16px;border-radius:12px;border:none;color:#fff;font-weight:700;cursor:pointer;background:var(--primary);box-shadow:var(--shadow)}
.btn-secondary{background:#2a3f58}.btn-success{background:var(--success)}.btn-danger{background:var(--danger)}.btn-block{width:100%}
.btn-chip{min-width:120px;height:40px;padding:0 12px;border-radius:20px;border:1px solid rgba(255,255,255,.12);background:var(--panel-2);color:var(--text);font-weight:700}
.btn-chip.active{background:var(--primary)}
.small{font-size:13px;color:var(--muted)} .status{margin-top:6px;font-size:15px}

/* map */
.map-wrap{position:relative}
#map{width:100%;height:56vh;border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.fab-col{position:absolute;right:8px;bottom:8px;display:flex;flex-direction:column;gap:10px;z-index:450}
.fab{min-width:150px;height:48px;border-radius:16px;display:flex;align-items:center;justify-content:center;font-weight:800}
.fab.success{background:var(--success)}.fab.info{background:var(--primary)}.fab.warn{background:var(--warn)}.fab.danger{background:var(--danger)}

/* compass : é‡ãŒå††ã‹ã‚‰ã¯ã¿å‡ºãªã„ã‚µã‚¤ã‚ºã«èª¿æ•´ */
.compass{position:absolute;top:10px;left:10px;z-index:440;width:78px;height:78px;border-radius:50%;
  background:radial-gradient(60% 60% at 50% 50%, #1c334d 0%, #0c1b2b 100%);
  border:1px solid rgba(255,255,255,.2);box-shadow:var(--shadow);display:grid;place-items:center}
.compass .needle{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:28px solid #ff4d4d;transform-origin:50% 100%;transform:rotate(0deg);filter:drop-shadow(0 2px 4px rgba(0,0,0,.4))}
.compass .north{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-weight:900;font-size:12px}
.compass .deg{position:absolute;bottom:4px;left:50%;transform:translateX(-50%);font-size:11px;color:var(--muted)}
.compass .label{position:absolute;right:6px;bottom:6px;font-size:10px;background:rgba(0,0,0,.3);padding:2px 6px;border-radius:10px}

/* results sheet */
.sheet{position:fixed;left:0;right:0;bottom:0;z-index:500;padding:10px 12px 16px;background:linear-gradient(180deg, rgba(10,20,32,.0), rgba(10,20,32,.85) 20%, rgba(10,20,32,.95));backdrop-filter:blur(8px)}
.sheet .panel{max-width:1200px;margin:0 auto;background:var(--panel);border-radius:16px;border:1px solid rgba(255,255,255,.1);padding:10px;max-height:44vh;overflow:auto}
.result{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;cursor:pointer}
.result:hover{background:rgba(255,255,255,.06)} .result .name{font-weight:800}.result .meta{font-size:12px;color:var(--muted)} .tags{display:flex;gap:8px;flex-wrap:wrap}.tag{font-size:11px;background:#1b314a;padding:3px 8px;border-radius:999px}
.hidden{display:none!important}
.grid-start-dest{display:grid;gap:10px;grid-template-columns:1fr 1fr}
@media (max-width:720px){.grid-start-dest{grid-template-columns:1fr}}
/* å°‘ã—ä¸‹ã’ã¦ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨UIã®å¹²æ¸‰ã‚’æ¸›ã‚‰ã™ */
.leaflet-top.leaflet-left{top:110px}
</style>
</head>
<body>
<h1>Cloudflare Workers ãƒŠãƒ“</h1>

<div class="container">
  <div class="card">
    <label>åº—èˆ—åãƒ»ä½æ‰€ãƒ»é›»è©±ç•ªå·ã§æ¤œç´¢</label>
    <div class="row cols-3">
      <input id="q" class="input" placeholder="ä¾‹ï¼šãƒ­ãƒ¼ã‚½ãƒ³ é«˜æ¾é§… / 087-xxx-xxxx" />
      <button id="micBtn" class="btn btn-secondary">ğŸ¤ éŸ³å£°</button>
      <button id="searchBtn" class="btn">æ¤œç´¢</button>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <button id="clearHist" class="btn btn-secondary">å±¥æ­´ã‚’ã‚¯ãƒªã‚¢</button>
      <div class="small">æ¤œç´¢å¾Œã¯æœ€å¯„ã‚Š5ä»¶ã‚’è‡ªå‹•è¡¨ç¤ºã€‚é¸æŠã§ç›®çš„åœ°è¨­å®šâ†’ãƒ«ãƒ¼ãƒˆå–å¾—â†’æ¡ˆå†…é–‹å§‹</div>
    </div>
  </div>

  <div class="card grid-start-dest">
    <div>
      <label>é–‹å§‹åœ°ç‚¹ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="row cols-2">
        <input id="startLon" class="input" inputmode="decimal" placeholder="çµŒåº¦" />
        <input id="startLat" class="input" inputmode="decimal" placeholder="ç·¯åº¦" />
      </div>
    </div>
    <div>
      <label>ç›®çš„åœ°ï¼ˆçµŒåº¦ãƒ»ç·¯åº¦ï¼‰</label>
      <div class="row cols-2">
        <input id="destLon" class="input" inputmode="decimal" placeholder="çµŒåº¦" />
        <input id="destLat" class="input" inputmode="decimal" placeholder="ç·¯åº¦" />
      </div>
    </div>
  </div>

  <div class="card">
    <label>ãƒ¢ãƒ¼ãƒ‰</label>
    <div class="row" style="grid-template-columns:repeat(2,1fr)">
      <button data-mode="foot-walking" class="btn-chip active" id="modeWalk">å¾’æ­©</button>
      <button data-mode="wheelchair" class="btn-chip" id="modeWheel">è»Šæ¤…å­</button>
    </div>
    <div class="row cols-2" style="margin-top:10px">
      <button id="routeBtn" class="btn btn-block">ãƒ«ãƒ¼ãƒˆå–å¾—</button>
      <button id="clearBtn" class="btn btn-secondary btn-block">ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="status" id="status">æº–å‚™å®Œäº†ã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>
  </div>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="compass" id="compass">
      <div class="north">N</div><div class="needle" id="needle"></div>
      <div class="deg" id="deg">--Â°</div><div class="label">é€²è¡Œæ–¹å‘</div>
    </div>
    <div class="fab-col">
      <button id="startGuideBtn" class="fab success">æ¡ˆå†…é–‹å§‹</button>
      <button id="locateBtn" class="fab info">ç¾åœ¨åœ°</button>
      <button id="setDestBtn" class="fab info">ç›®çš„åœ°</button>
      <button id="rerouteBtn" class="fab warn">ãƒªãƒ«ãƒ¼ãƒˆ</button>
    </div>
  </div>
</div>

<div class="sheet hidden" id="sheet">
  <div class="panel">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div style="font-weight:800">æ¤œç´¢çµæœï¼ˆè¿‘éš£ ä¸Šä½5ä»¶ï¼‰</div>
      <button id="closeSheet" class="btn btn-secondary" style="height:36px">é–‰ã˜ã‚‹</button>
    </div>
    <div id="results"></div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin></script>
<script>
/* ================= è¨­å®š ================= */
const WORKER_URL = 'https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
const OFF_ROUTE_M = 5;                      // 5mè¶…ã§ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆ
const OFF_ROUTE_CONSEC = 2;                 // é€£ç¶š2å›ã§æœ‰åŠ¹
const OFF_ROUTE_ARM_MS = 3500;              // æ¡ˆå†…é–‹å§‹ã‹ã‚‰ã“ã®é–“ã¯ç„¡è¦–
const OFF_ROUTE_COOLDOWN_MS = 8000;         // æ¬¡ã¾ã§ã®å¾…ã¡
const STEP_ANNOUNCE_M = 12;                 // æ›²ãŒã‚Šèª­ã¿ä¸Šã’è·é›¢
const DEDUP_WINDOW_MS = 5000;               // åŒä¸€ç™ºè©±ã®ãƒ‡ãƒ‡ãƒ¥ãƒ¼ãƒ—
// â˜…é™æ­¢æ™‚ã‚¬ãƒ¼ãƒ‰
const MIN_MOVE_STEP_M = 1.5;                // ã“ã®è·é›¢ä»¥ä¸Šå‹•ã‹ãªã„ã¨æ¡ˆå†…å‡¦ç†ã—ãªã„
const MIN_MOVE_FOR_OFFROUTE_M = 3.0;        // æ¡ˆå†…é–‹å§‹ã‹ã‚‰åˆè¨ˆ3mä»¥ä¸Šå‹•ãã¾ã§ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆåˆ¤å®šã—ãªã„
const SPEAK_RATE = 1.0;

let travelProfile = 'foot-walking';

/* ================= è¦ç´  ================= */
const el = id => document.getElementById(id);
const q = el('q'), searchBtn = el('searchBtn'), micBtn = el('micBtn'), clearHistBtn = el('clearHist');
const startLon = el('startLon'), startLat = el('startLat'), destLon = el('destLon'), destLat = el('destLat');
const modeWalk = el('modeWalk'), modeWheel = el('modeWheel');
const routeBtn = el('routeBtn'), clearBtn = el('clearBtn'), statusEl = el('status');
const startGuideBtn = el('startGuideBtn'), locateBtn = el('locateBtn'), setDestBtn = el('setDestBtn'), rerouteBtn = el('rerouteBtn');
const sheet = el('sheet'), resultsEl = el('results'), closeSheet = el('closeSheet');
const needle = el('needle'), degEl = el('deg');

/* ================= åœ°å›³ ================= */
const map = L.map('map',{zoomControl:true,attributionControl:true});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20}).addTo(map);
let userMarker=null, destMarker=null, routeLine=null;
let routeGeom=[], routeSteps=[];
let watchId=null;

/* ================= æ¡ˆå†…ã‚¹ãƒ†ãƒ¼ãƒˆ ================= */
let guiding=false, nextStepIdx=0;
const nav = {
  armedAt: 0,
  offRouteConsecutive: 0,
  offRouteCooldownUntil: 0,
  lastSpoken:{text:'', at:0},
  stepSpoken:new Set()
};
// ç§»å‹•é‡ç®¡ç†
let guideStartPos=null;       // æ¡ˆå†…é–‹å§‹æ™‚ã®ä½ç½®
let lastPos=null;             // æœ€æ–°ä½ç½®
let lastMovedPos=null;        // ç›´è¿‘ã®ã€Œååˆ†ã«å‹•ã„ãŸã€åŸºæº–ä½ç½®

/* ================= å…±é€š ================= */
function toast(m){ statusEl.textContent = m; }
function setStart(lon,lat){ startLon.value=(+lon).toFixed(6); startLat.value=(+lat).toFixed(6); }
function setDest(lon,lat){ destLon.value=(+lon).toFixed(6); destLat.value=(+lat).toFixed(6); }
function currentStart(){ return [+startLat.value,+startLon.value]; }
function currentDest(){ return [+destLat.value,+destLon.value]; }
function speakOnce(text){
  if(!text) return;
  const now=Date.now();
  if(nav.lastSpoken.text===text && now-nav.lastSpoken.at<DEDUP_WINDOW_MS) return; // åŒæ–‡é€£ç™ºæŠ‘åˆ¶
  nav.lastSpoken={text,at:now};
  try{ speechSynthesis.cancel(); const u=new SpeechSynthesisUtterance(text); u.lang='ja-JP'; u.rate=SPEAK_RATE; speechSynthesis.speak(u); }catch{}
}
function stopAllGuidance(){
  guiding=false; nav.offRouteConsecutive=0; nav.offRouteCooldownUntil=0; nav.lastSpoken={text:'',at:0}; nav.stepSpoken.clear(); nextStepIdx=0;
  try{ speechSynthesis.cancel(); }catch{}
}

/* ================= ä½ç½® ================= */
function focusTo(latlng,z){ map.setView(latlng, z||map.getZoom()); }
function placeOrMoveUser(latlng){ if(!userMarker) userMarker=L.marker(latlng).addTo(map); else userMarker.setLatLng(latlng); }
function placeOrMoveDest(latlng){ if(!destMarker) destMarker=L.marker(latlng).addTo(map); else destMarker.setLatLng(latlng); }

function initGeolocation(){
  if(!navigator.geolocation){ toast('ã“ã®ç«¯æœ«ã¯ä½ç½®å–å¾—ã«æœªå¯¾å¿œã§ã™'); return; }
  navigator.geolocation.getCurrentPosition((pos)=>{
    const {latitude,longitude}=pos.coords; setStart(longitude,latitude); focusTo([latitude,longitude],17); placeOrMoveUser([latitude,longitude]); startWatch();
  },(err)=>{ toast('ç¾åœ¨åœ°ãŒå–å¾—ã§ãã¾ã›ã‚“ï¼š'+err.message); focusTo([35.68,139.76],5); },{enableHighAccuracy:true,timeout:10000,maximumAge:0});
}
function startWatch(){
  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId = navigator.geolocation.watchPosition((pos)=>{
    const {latitude,longitude}=pos.coords;
    const here=[latitude,longitude]; placeOrMoveUser(here);

    // é™æ­¢åˆ¤å®š
    if(!lastPos){ lastPos=here; lastMovedPos=here; }
    const movedFromLast = distMeters(here, lastPos);
    const movedFromMoved = distMeters(here, lastMovedPos);
    const movedSinceStart = guideStartPos ? distMeters(here, guideStartPos) : 0;
    const movedEnoughNow = movedFromMoved >= MIN_MOVE_STEP_M;

    if(guiding){
      // å‹•ã„ã¦ã„ãªã„é–“ã¯ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ã®å…¨å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if(!movedEnoughNow){ lastPos=here; return; }

      // 1) æ›²ãŒã‚Šèª­ã¿ä¸Šã’ï¼ˆ1å›ã®ã¿ï¼‰
      announceUpcomingStep(here);

      // 2) ã‚ªãƒ•ãƒ«ãƒ¼ãƒˆåˆ¤å®šï¼ˆé–‹å§‹ç›´å¾Œï¼†ç§»å‹•é‡ãŒå°‘ãªã„é–“ã¯ç„¡åŠ¹ï¼‰
      const now=Date.now();
      if(now - nav.armedAt >= OFF_ROUTE_ARM_MS && movedSinceStart >= MIN_MOVE_FOR_OFFROUTE_M){
        if(routeGeom.length>1){
          const d=distanceToPolyline(here, routeGeom);
          if(d>OFF_ROUTE_M){ nav.offRouteConsecutive++; } else { nav.offRouteConsecutive=0; }
          if(nav.offRouteConsecutive>=OFF_ROUTE_CONSEC && now>nav.offRouteCooldownUntil){
            nav.offRouteCooldownUntil = now + OFF_ROUTE_COOLDOWN_MS;
            nav.offRouteConsecutive = 0;
            speakOnce('é€šã‚Šéãã¾ã—ãŸã€‚ãƒªãƒ«ãƒ¼ãƒˆã—ã¾ã™ã€‚');
            setTimeout(()=>getRouteAndMaybeGuide(true), 900);
          }
        }
      }
    }

    if(movedEnoughNow) lastMovedPos=here;
    lastPos=here;
  },()=>{}, {enableHighAccuracy:true,timeout:10000,maximumAge:1000});
}

/* ================= ãƒ«ãƒ¼ãƒˆ ================= */
async function fetchRoute(lon1,lat1,lon2,lat2,profile){
  const body={coordinates:[[lon1,lat1],[lon2,lat2]],instructions:true,language:'ja',profile:profile||travelProfile};
  const res=await fetch(WORKER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!res.ok) throw new Error('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ï¼ˆ'+res.status+'ï¼‰');
  return res.json();
}
function decodePolyline(str){ if(Array.isArray(str)) return str; let i=0,lat=0,lon=0,coords=[]; while(i<str.length){ let b,shift=0,result=0; do{ b=str.charCodeAt(i++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20); const dlat=(result&1)?~(result>>1):(result>>1); lat+=dlat; shift=0;result=0; do{ b=str.charCodeAt(i++)-63; result|=(b&0x1f)<<shift; shift+=5; }while(b>=0x20); const dlng=(result&1)?~(result>>1):(result>>1); lon+=dlng; coords.push([lat/1e5,lon/1e5]); } return coords; }
function drawRoute(data){
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  routeGeom = decodePolyline(data.routes[0].geometry).map(([lat,lng])=>[lat,lng]);
  routeSteps = (data.routes[0].segments?.[0]?.steps)||[];
  routeLine = L.polyline(routeGeom,{color:'#2dd4bf',weight:6,opacity:.9}).addTo(map);
  const bounds=L.latLngBounds(routeGeom); map.fitBounds(bounds.pad(0.2));
  setTimeout(()=>{ if(userMarker) focusTo(userMarker.getLatLng(),17); },1500);
}
async function getRouteAndMaybeGuide(autoStart=true){
  const [slat,slon]=currentStart(), [dlat,dlon]=currentDest();
  if(Number.isNaN(slat) || Number.isNaN(dlat)){ toast('é–‹å§‹åœ°ç‚¹ã¨ç›®çš„åœ°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  stopAllGuidance();
  toast('ãƒ«ãƒ¼ãƒˆå–å¾—ä¸­â€¦');
  try{
    const data=await fetchRoute(slon,slat,dlon,dlat,travelProfile);
    drawRoute(data); toast('ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ');
    if(autoStart) startGuidance(true);
  }catch(e){ toast('ãƒ«ãƒ¼ãƒˆå–å¾—ã«å¤±æ•—ï¼š'+e.message); }
}

/* ================= æ¡ˆå†… ================= */
function startGuidance(sayFirst){
  if(routeGeom.length===0){ toast('å…ˆã«ãƒ«ãƒ¼ãƒˆã‚’å–å¾—ã—ã¦ãã ã•ã„'); return; }
  guiding=true; nav.armedAt=Date.now(); nav.stepSpoken.clear(); nextStepIdx=0; nav.lastSpoken={text:'',at:0};
  guideStartPos = userMarker ? [userMarker.getLatLng().lat, userMarker.getLatLng().lng] : null;
  lastMovedPos = guideStartPos || lastMovedPos;

  if(sayFirst){
    const s=routeSteps?.[0]; speakOnce(s? stepToSpeech(s) : 'æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™ã€‚ã¾ãšã¯ç›´é€²ã—ã¦ãã ã•ã„ã€‚');
  }else speakOnce('æ¡ˆå†…ã‚’é–‹å§‹ã—ã¾ã™');
}
function stepToSpeech(step){
  const name = step.name && step.name!=='-' ? step.name : 'ã“ã®é€šã‚Š';
  const types = {0:`${name}ã«å‘ã‘ã¦å·¦ã§ã™`,1:`å³ã¸æ›²ãŒã‚Šã¾ã™`,2:`Uã‚¿ãƒ¼ãƒ³ã§ã™`,3:`ã‚ãšã‹ã«å³ã§ã™`,4:`å·¦æ–¹å‘ã¸æ›²ãŒã‚Šã¾ã™`,5:`å³æ–¹å‘ã¸æ›²ãŒã‚Šã¾ã™`,6:`ç›´é€²ã§ã™`,10:`å³å´ã«ã‚ã‚‹ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã™`,11:`å—ã«å‘ã‹ã„ã¾ã™`,12:`ãã®ã¾ã¾å·¦ã«é€²ã¿ã¾ã™`};
  return types[step.type] || 'ç›´é€²ã—ã¦ãã ã•ã„';
}
function announceUpcomingStep(here){
  if(!routeSteps || nextStepIdx>=routeSteps.length) return;
  const step=routeSteps[nextStepIdx];
  if(nav.stepSpoken.has(nextStepIdx)) { nextStepIdx++; return; }
  const toIdx = (step.way_points && step.way_points[1]) || null;
  if(toIdx==null || !routeGeom[toIdx]) return;
  const target = routeGeom[toIdx];
  const d = distMeters(here, target);
  if(d<=STEP_ANNOUNCE_M){
    speakOnce(stepToSpeech(step));
    nav.stepSpoken.add(nextStepIdx);
    nextStepIdx++;
  }
}

/* ================= æ¤œç´¢ ================= */
async function searchNearby(query){
  if(!query || !query.trim()){ toast('æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  const center = userMarker ? userMarker.getLatLng() : map.getCenter();
  const dx=0.25, dy=0.25;
  const viewbox = [center.lng-dx,center.lat+dy,center.lng+dx,center.lat-dy].join(',');
  const url=`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(query)}&limit=25&viewbox=${viewbox}&bounded=1&accept-language=ja`;
  const r=await fetch(url,{headers:{'Accept':'application/json'}}); const js=await r.json();
  const withDist = js.map(it=>({ ...it, _dist: haversine(center.lat,center.lng,+it.lat,+it.lon) })).sort((a,b)=>a._dist-b._dist);
  const top5 = withDist.slice(0,5);
  renderResults(top5); saveHistory(query); sheet.classList.remove('hidden'); toast('è¿‘ã„é †ã«5ä»¶ã‚’è¡¨ç¤ºã€‚ã‚¿ãƒƒãƒ—ã§ç›®çš„åœ°â†’è‡ªå‹•ãƒ«ãƒ¼ãƒˆâ†’æ¡ˆå†…é–‹å§‹');
}
function renderResults(items){
  resultsEl.innerHTML='';
  if(items.length===0){ resultsEl.innerHTML='<div class="small">è©²å½“ãªã—</div>'; return; }
  items.forEach((it,idx)=>{
    const row=document.createElement('div'); row.className='result';
    row.innerHTML=`<div><div class="name">${escapeHtml(it.display_name?.split(',')[0]||'åç§°ä¸æ˜')}</div><div class="meta">${it._dist.toFixed(2)} km / ${escapeHtml(it.display_name||'')}</div><div class="tags"><span class="tag">#${idx+1}</span><span class="tag">${(+it.lat).toFixed(5)}, ${(+it.lon).toFixed(5)}</span></div></div>`;
    row.addEventListener('click',()=>{
      setDest(+it.lon,+it.lat); placeOrMoveDest([+it.lat,+it.lon]); sheet.classList.add('hidden'); getRouteAndMaybeGuide(true);
    });
    resultsEl.appendChild(row);
  });
}

/* ================= ã‚¯ãƒªã‚¢ ================= */
function clearAll(){
  stopAllGuidance();
  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  routeGeom=[]; routeSteps=[];
  if(destMarker){ map.removeLayer(destMarker); destMarker=null; }
  destLon.value=''; destLat.value='';
  sheet.classList.add('hidden'); toast('ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚ç›®çš„åœ°ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
}
function clearHistory(){ localStorage.removeItem('searchHistory'); q.value=''; stopAllGuidance(); sheet.classList.add('hidden'); toast('æ¤œç´¢å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ'); }

/* ================= æ–¹ä½è¨ˆ ================= */
let heading=0, alpha=0.12;
function updateCompass(deg){ heading = heading + alpha*(normalizeDeg(deg)-heading); needle.style.transform=`rotate(${heading}deg)`; degEl.textContent=`${Math.round(normalizeDeg(heading))}Â°`; }
function normalizeDeg(d){ d=d%360; return d<0? d+360:d; }
function setupOrientation(){
  function handler(e){
    let hdg = (typeof e.webkitCompassHeading==='number') ? e.webkitCompassHeading : (typeof e.alpha==='number' ? 360 - e.alpha : null);
    if(hdg==null) return; updateCompass(hdg);
  }
  if(window.DeviceOrientationEvent){
    if(typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission().then(res=>{ if(res==='granted') window.addEventListener('deviceorientation',handler,true); }).catch(()=>{});
    }else{
      window.addEventListener('deviceorientationabsolute',handler,true);
      window.addEventListener('deviceorientation',handler,true);
    }
  }
}

/* ================= å°ç‰© ================= */
function escapeHtml(s){ return (s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function haversine(lat1,lon1,lat2,lon2){ const R=6371,toRad=a=>a*Math.PI/180; const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
function distMeters(a,b){ return haversine(a[0],a[1],b[0],b[1])*1000; }
function distanceToPolyline(p,poly){ let min=1e9; for(let i=1;i<poly.length;i++){ const a=poly[i-1], b=poly[i]; min=Math.min(min, distancePointToSegment(p,a,b)); } return min; }
function distancePointToSegment(p,a,b){
  const toXY=([lat,lon])=>{const x=lon*111320*Math.cos(lat*Math.PI/180),y=lat*110540;return [x,y]};
  const [px,py]=toXY(p),[ax,ay]=toXY(a),[bx,by]=toXY(b); const abx=bx-ax,aby=by-ay;
  const t=Math.max(0,Math.min(1,((px-ax)*abx+(py-ay)*aby)/(abx*abx+aby*aby))); const cx=ax+t*abx,cy=ay+t*aby; return Math.hypot(px-cx,py-cy);
}
function saveHistory(word){ let h=JSON.parse(localStorage.getItem('searchHistory')||'[]'); h=[word,...h.filter(x=>x!==word)].slice(0,20); localStorage.setItem('searchHistory',JSON.stringify(h)); }

/* ================= ã‚¤ãƒ™ãƒ³ãƒˆ ================= */
function setMode(btn){ [modeWalk,modeWheel].forEach(b=>b.classList.remove('active')); btn.classList.add('active'); travelProfile=btn.dataset.mode; toast(btn===modeWalk?'å¾’æ­©ãƒ¢ãƒ¼ãƒ‰':'è»Šæ¤…å­ãƒ¢ãƒ¼ãƒ‰'); }
modeWalk.addEventListener('click',()=>setMode(modeWalk));
modeWheel.addEventListener('click',()=>setMode(modeWheel));
searchBtn.addEventListener('click',()=>searchNearby(q.value));
q.addEventListener('keydown',e=>{ if(e.key==='Enter') searchNearby(q.value); });
let rec=null; micBtn.addEventListener('click',()=>{ try{ const SR=window.SpeechRecognition||window.webkitSpeechRecognition; if(!SR){ toast('éŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™'); return; } rec=new SR(); rec.lang='ja-JP'; rec.interimResults=false; rec.maxAlternatives=1; rec.onresult=e=>{ const text=e.results[0][0].transcript; q.value=text; searchNearby(text); }; rec.onerror=e=>toast('éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼ï¼š'+e.error); rec.start(); }catch(err){ toast('éŸ³å£°èªè­˜é–‹å§‹ã«å¤±æ•—ï¼š'+err.message); }});
routeBtn.addEventListener('click',()=>getRouteAndMaybeGuide(false));
clearBtn.addEventListener('click',()=>clearAll());
startGuideBtn.addEventListener('click',()=>startGuidance(true));
locateBtn.addEventListener('click',()=>{ if(userMarker) focusTo(userMarker.getLatLng(),18); });
setDestBtn.addEventListener('click',()=>{ if(!userMarker){ toast('ç¾åœ¨åœ°ä¸æ˜ã§ã™'); return; } const here=userMarker.getLatLng(); placeOrMoveDest(here); setDest(here.lng,here.lat); getRouteAndMaybeGuide(true); });
rerouteBtn.addEventListener('click',()=>getRouteAndMaybeGuide(true));
closeSheet.addEventListener('click',()=>sheet.classList.add('hidden'));
clearHistBtn.addEventListener('click',()=>clearHistory());

/* ================= èµ·å‹• ================= */
initGeolocation(); setupOrientation(); window.addEventListener('pagehide',()=>speechSynthesis.cancel());
</script>
</body>
</html>