<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>歩行者ナビ（Cloudflare Workers + OSM）</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">

<style>
:root{
  --bg:#0f1a25; --panel:#132235; --panel2:#0f1e30; --text:#eaf2ff; --muted:#9db0c6;
  --ok:#2ecc71; --primary:#4aa3ff; --danger:#ff6b6b;
  --compassSize:82px; --compassMargin:18px; --labelW:8ch;
  --aqua:#7fd3ff;
}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP","Helvetica Neue",Arial,"メイリオ",Meiryo,sans-serif;scroll-behavior:smooth}
.wrap{max-width:1100px;margin:0 auto;padding:12px;box-sizing:border-box}
.card{background:var(--panel);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.28);overflow:hidden;box-sizing:border-box}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.grow{flex:1 1 200px}
input,button,select{border-radius:12px;border:1px solid rgba(255,255,255,.08);background:var(--panel2);color:var(--text);padding:12px 14px;font-size:16px;outline:none;box-sizing:border-box}
input::placeholder{color:#8aa2bc}
button.primary{background:var(--primary);border:none;font-weight:700}
button.ghost{background:transparent;border:1px solid rgba(255,255,255,.15)}
button.ok{background:var(--ok);border:none;font-weight:700}
button.danger{background:var(--danger);border:none;font-weight:700}
button[disabled]{opacity:.6;pointer-events:none}
.hint{color:var(--muted);font-size:14px}

/* ==== ルート種別トグル（横スライド禁止・折返し） ==== */
.toggle-group{
  display:flex;gap:8px;justify-content:center;align-content:center;
  background:#0b1624;border:1px solid rgba(255,255,255,.12);border-radius:14px;padding:8px 10px;
  flex-wrap:wrap; /* ← 横スライド禁止。はみ出す場合は折り返し */
  overflow:hidden; /* ← 横スクロールを抑止 */
}
.toggle input{display:none}
.toggle label{
  display:inline-flex;align-items:center;justify-content:center;
  padding:7px 12px;border-radius:999px;cursor:pointer;white-space:nowrap;
  font-size:clamp(12px,1.6vw,15px); /* ほんの少し大きい */
  font-weight:800;line-height:1;
}
.toggle input:checked + label{
  background:#18314d;box-shadow:0 0 0 3px rgba(74,163,255,.18) inset;border:1px solid rgba(74,163,255,.5)
}

/* 検索UI：マイクは緑→ビジーは赤 */
#mic{background:var(--ok);border:none;font-weight:800}
.btn-busy{background:var(--danger)!important;border-color:transparent!important}
/* 「検索中…」は水色で大きく */
#searchStatus.search-large{font-size:18px;font-weight:800;color:var(--aqua)}

/* 緯度経度ブロック */
.stagger-wrap{display:flex;flex-direction:column;gap:10px}
.st-row{display:flex;gap:12px;align-items:center;flex-wrap:nowrap}
.st-row>.hint{flex:0 0 var(--labelW);min-width:var(--labelW);text-align:left;color:#ffd166;font-weight:800}
.coords{flex:1 1 auto;display:flex;gap:12px;align-items:stretch;flex-wrap:nowrap}
.coord-col{flex:1 1 0;display:flex;flex-direction:column;gap:6px;min-width:0}
.coord-label{font-size:12px;color:var(--muted);padding-left:2px}
.coord-input{width:100%;max-width:none;min-width:0;padding:10px 12px;font-size:16px}

/* Map */
.mapwrap{position:relative;scroll-margin-top:12px}
#map{height:64vh;min-height:360px;border-radius:16px;overflow:hidden;background:#0c1724}
#mapSkeleton{position:absolute;inset:0;pointer-events:none;z-index:1;background:repeating-linear-gradient(90deg,rgba(255,255,255,.06)0,rgba(255,255,255,.06)40px,rgba(255,255,255,.02)40px,rgba(255,255,255,.02)80px);animation:sh 1.15s linear infinite;opacity:.55;border-radius:16px}
@keyframes sh{from{transform:translateX(-28%)}to{transform:translateX(28%)}}

/* ETAピル */
#etaOverlay{position:absolute;left:calc(var(--compassMargin) + var(--compassSize) + 10px);right:12px;top:var(--compassMargin);z-index:470;display:flex;justify-content:center;pointer-events:none}
#etaPill{pointer-events:auto;display:flex;flex-direction:column;gap:4px;align-items:center;background:rgba(8,16,28,.88);backdrop-filter:blur(4px);border:1px solid rgba(255,255,255,.18);border-radius:14px;padding:8px 12px;max-width:520px}
#timeRow{font-size:18px;font-weight:800;opacity:.95;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
#etaMain{font-size:22px;font-weight:900;letter-spacing:.01em}
#etaMain .num{font-size:24px}

/* コンパス */
.compass{position:absolute;left:var(--compassMargin);top:var(--compassMargin);z-index:450;width:var(--compassSize);height:var(--compassSize);border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.35);pointer-events:none}
.compass svg{display:block;width:100%;height:100%}
.compass text{font-size:10px;fill:#f6d365;letter-spacing:.1em}
#needle polygon{fill:#ff4e4e;filter:drop-shadow(0 4px 8px rgba(0,0,0,.35))}

/* Leaflet UI：ズーム +/− 大きめ */
.leaflet-control-zoom{left:10px!important;right:auto!important;bottom:14px!important;top:auto!important}
.leaflet-control-zoom a{
  width:56px;height:56px;line-height:56px;font-size:28px;
  border-radius:12px;border:1px solid rgba(255,255,255,.2);background:#0e1a2a;color:#eaf2ff;
}
.leaflet-control-zoom a:hover{filter:brightness(1.15)}
.leaflet-control-attribution{left:8px!important;right:auto!important;bottom:10px!important;max-width:calc(100% - 160px)!important;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;background:rgba(0,0,0,.25);color:#eaf2ff;border-radius:10px;padding:2px 6px}

/* FAB */
.fab-col{position:absolute;right:12px;bottom:88px;z-index:460;display:flex;flex-direction:column;gap:10px}
.fab-col button{min-width:126px;padding:10px 12px;font-weight:700;box-shadow:0 10px 20px rgba(0,0,0,.35);white-space:nowrap}

/* 検索結果 */
.results{margin-top:10px}
.result{background:#0b1624;border:1px solid rgba(255,255,255,.08);padding:10px 12px;border-radius:12px;margin-bottom:8px;cursor:pointer}
.result[role="button"]{outline:none}
.result:focus-visible{box-shadow:0 0 0 3px rgba(74,163,255,.45)}
.result small{color:#a9bed5}
.badge{display:inline-block;background:rgba(255,255,255,.08);padding:3px 8px;border-radius:999px;margin-left:6px}
.results .body{max-height:44vh;overflow:auto;margin-top:8px;-webkit-overflow-scrolling:touch;overscroll-behavior:contain}

/* 保存モーダル（キーボード対応） */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:center;z-index:1000;padding:12px 12px calc(env(safe-area-inset-bottom) + 12px)}
.modal .box{background:var(--panel);border-radius:16px;width:92vw;max-width:560px;margin:8px auto 0;padding:16px;box-shadow:0 18px 40px rgba(0,0,0,.5);max-height:85dvh;overflow:auto}
.modal .title{font-weight:800;margin-bottom:8px}
.modal .row{margin-top:8px}
.modal .actions{position:sticky;bottom:0;display:flex;gap:10px;justify-content:flex-end;margin-top:12px;padding-top:8px;background:linear-gradient(to top, rgba(19,34,53,.98), rgba(19,34,53,.82) 60%, rgba(19,34,53,0))}
</style>
</head>
<body>
<div class="wrap">

  <!-- ルートタイプ（横スライド禁止・折返し） -->
  <div class="card">
    <div class="toggle-group" id="routeToggles" role="radiogroup" aria-label="ルートタイプ">
      <div class="toggle"><input type="radio" name="routeMode" id="routeShortest" value="shortest" checked><label for="routeShortest" data-i18n="route.shortest">最短</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeEasy" value="easy"><label for="routeEasy" data-i18n="route.easy">楽チン</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeStroll" value="stroll"><label for="routeStroll" data-i18n="route.stroll">お散歩AI</label></div>
      <div class="toggle"><input type="radio" name="routeMode" id="routeTour" value="tour"><label for="routeTour" data-i18n="route.tour">観光案内（予定）</label></div>
    </div>
  </div>

  <!-- 言語選択（保存地点と同じセレクト方式） -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <div class="hint" style="min-width:8ch" data-i18n="lang.label">言語</div>
      <select id="langSelect" class="grow" aria-label="言語選択">
        <option value="ja">日本語</option>
        <option value="en">English</option>
        <option value="ko">한국어</option>
        <option value="fr">Français</option>
        <option value="es">Español</option>
        <option value="zh">中文</option>
      </select>
    </div>
  </div>

  <!-- 検索 -->
  <div class="card" style="margin-top:12px">
    <div class="row">
      <input id="q" class="grow" placeholder="店舗名・住所・電話番号で検索" autocomplete="off" data-i18n-ph="search.placeholder">
      <button id="mic" class="ok" data-i18n="search.voice">🎤 音声</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="search" class="primary" data-i18n="search.button">検索</button>
      <button id="clearHistory" class="ghost" data-i18n="search.clear">履歴をクリア</button>
      <span id="searchStatus" class="hint" style="min-width:8ch"></span>
    </div>
  </div>

  <!-- 座標＆操作 -->
  <div class="card" style="margin-top:12px">
    <div class="stagger-wrap">
      <div class="st-row start">
        <div class="hint" data-i18n="coord.start">開始地点</div>
        <div class="coords">
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lon">経度</div>
            <input id="startLon" class="coord-input" placeholder="経度" inputmode="decimal" data-i18n-ph="coord.lon">
          </div>
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lat">緯度</div>
            <input id="startLat" class="coord-input" placeholder="緯度" inputmode="decimal" data-i18n-ph="coord.lat">
          </div>
        </div>
      </div>
      <div class="st-row dest">
        <div class="hint" data-i18n="coord.dest">目的地点</div>
        <div class="coords">
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lon">経度</div>
            <input id="destLon" class="coord-input" placeholder="経度" inputmode="decimal" data-i18n-ph="coord.lon">
          </div>
          <div class="coord-col">
            <div class="coord-label" data-i18n="coord.lat">緯度</div>
            <input id="destLat" class="coord-input" placeholder="緯度" inputmode="decimal" data-i18n-ph="coord.lat">
          </div>
        </div>
      </div>
    </div>

    <!-- 地点保存 -->
    <div class="row" style="margin-top:12px">
      <div class="grow">
        <div class="hint" data-i18n="save.label">記憶地点（この端末に保存）</div>
        <div class="row">
          <select id="savedList" class="grow"></select>
          <button id="openSaveModal" class="ok" data-i18n="save.now">現在地を保存</button>
          <button id="setFromSaved" class="primary" data-i18n="save.set">目的地に設定</button>
          <button id="delSaved" class="danger" data-i18n="save.del">削除</button>
        </div>
      </div>
    </div>

    <div id="msg" class="hint" style="margin-top:6px;" data-i18n="msg.wait">現在地の取得を待機中…</div>
  </div>

  <!-- 地図 -->
  <div class="card mapwrap" id="mapCard" style="margin-top:12px">
    <div id="map"></div>
    <div id="mapSkeleton" aria-hidden="true"></div>

    <!-- ETA -->
    <div id="etaOverlay" role="region" aria-label="到着予想">
      <div id="etaPill">
        <div id="timeRow"><span id="nowClock" data-i18n-prefix="clock.now">現在 </span>｜<span id="etaClock" data-i18n-prefix="clock.eta">到着 </span></div>
        <div id="etaMain"><span class="num" id="etaDurationTop">—</span> ｜ <span class="num" id="etaDistanceTop">—</span></div>
      </div>
    </div>

    <!-- コンパス -->
    <div class="compass" aria-hidden="true">
      <svg viewBox="0 0 74 74">
        <defs><radialGradient id="g1" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#0b1624"/><stop offset="60%" stop-color="#0a1320"/><stop offset="100%" stop-color="#07121e"/></radialGradient></defs>
        <circle cx="37" cy="37" r="36" fill="url(#g1)" stroke="rgba(255,255,255,.15)"/>
        <text x="37" y="12" text-anchor="middle">N</text>
        <g id="needle"><polygon points="37,11 31.5,37 42.5,37"/></g>
        <text x="37" y="66" text-anchor="middle" fill="#b8cce2" data-i18n="compass.caption">進行方向</text>
      </svg>
    </div>

    <div class="fab-col">
      <button id="navStart" class="ok" data-i18n="btn.nav">案内開始</button>
      <button id="gotoStart" class="primary" data-i18n="btn.cur">現在地</button>
      <button id="gotoDest"  class="primary" data-i18n="btn.dest">目的地</button>
      <button id="reroute"   class="danger"  data-i18n="btn.reroute">リルート</button>
    </div>
  </div>

  <!-- 検索結果 -->
  <div class="card results" id="results" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <div><span class="badge" data-i18n="results.heading">検索結果（近隣 上位5件）</span></div>
      <button id="closeResults" class="ghost" data-i18n="results.close">閉じる</button>
    </div>
    <div id="resultList" class="body"></div>
  </div>
</div>

<!-- 保存モーダル -->
<div class="modal" id="saveModal" aria-modal="true" role="dialog">
  <div class="box">
    <div class="title" data-i18n="save.title">現在地を保存</div>
    <div class="row"><input id="saveName" class="grow" placeholder="地点名（例：自宅・公園）" data-i18n-ph="save.namePh"></div>
    <div class="row" style="gap:12px">
      <div class="coord-col" style="flex:1 1 0">
        <div class="coord-label" data-i18n="coord.lon">経度</div>
        <input id="saveLon" class="coord-input" placeholder="経度" inputmode="decimal" data-i18n-ph="coord.lon">
      </div>
      <div class="coord-col" style="flex:1 1 0">
        <div class="coord-label" data-i18n="coord.lat">緯度</div>
        <input id="saveLat" class="coord-input" placeholder="緯度" inputmode="decimal" data-i18n-ph="coord.lat">
      </div>
    </div>
    <div class="actions">
      <button id="cancelSave" class="ghost" data-i18n="common.cancel">キャンセル</button>
      <button id="doSave" class="ok" data-i18n="common.save">保存</button>
    </div>
  </div>
</div>

<!-- リルートモーダル -->
<div class="modal" id="rerouteModal" aria-modal="true" role="dialog">
  <div class="box">
    <div class="title" data-i18n="rr.title">リルート方式を選択（徒歩）</div>
    <div class="row">
      <label><input type="radio" name="rr" value="shortest" checked> <span data-i18n="route.shortest">最短</span></label>
      <label><input type="radio" name="rr" value="easy"> <span data-i18n="route.easy">楽チン（階段回避）</span></label>
      <label><input type="radio" name="rr" value="stroll"> <span data-i18n="route.stroll">お散歩AI（遠回り傾向）</span></label>
    </div>
    <div class="actions">
      <button id="cancelRR" class="ghost" data-i18n="common.cancel">キャンセル</button>
      <button id="doRR" class="primary" data-i18n="rr.do">リルート</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" defer></script>

<script>
/* ===== 設定 ===== */
const WORKER_ORIGIN='https://ors-proxy.miyata-connect-jp.workers.dev/proxy';
const OSRM='https://router.project-osrm.org';
const VALHALLA='https://valhalla1.openstreetmap.de/route';
const OVERPASS='https://overpass-api.de/api/interpreter';
const profile='foot-walking';
const ETA_UPDATE_MS=2000;

/* ===== 要素 ===== */
const $=id=>document.getElementById(id);
const els={
  q:$('q'), mic:$('mic'), search:$('search'), clearHistory:$('clearHistory'),
  searchStatus:$('searchStatus'),
  results:$('results'), resultList:$('resultList'), closeResults:$('closeResults'),
  startLat:$('startLat'), startLon:$('startLon'), destLat:$('destLat'), destLon:$('destLon'),
  navStart:$('navStart'), gotoStart:$('gotoStart'), gotoDest:$('gotoDest'), reroute:$('reroute'),
  savedList:$('savedList'), openSaveModal:$('openSaveModal'), saveModal:$('saveModal'),
  saveName:$('saveName'), saveLon:$('saveLon'), saveLat:$('saveLat'),
  cancelSave:$('cancelSave'), doSave:$('doSave'),
  setFromSaved:$('setFromSaved'), delSaved:$('delSaved'),
  routeToggles:$('routeToggles'),
  rerouteModal:$('rerouteModal'), cancelRR:$('cancelRR'), doRR:$('doRR'),
  nowClock:$('nowClock'), etaClock:$('etaClock'), etaDurationTop:$('etaDurationTop'), etaDistanceTop:$('etaDistanceTop'),
  msg:$('msg'), mapCard:$('mapCard'),
  langSelect:$('langSelect')
};

/* ===== 状態 ===== */
let map=null, routeLayer=null, markerLayer=null, routeLine=null, lastRoute=null;
let currentMarker=null, destMarker=null, mapReady=false, watchId=null;
let navActive=false, routingLock=false, routeMode='shortest', safetyPoints=[], navState=null;
let followMe=false, lastKnownPos=null;
/* 言語 */
let voiceMode='ja';

/* ===== i18n（UI表示用） ===== */
const UI_STR={
  ja:{
    title:'歩行者ナビ（Cloudflare Workers + OSM）',
    'route.shortest':'最短','route.easy':'楽チン','route.stroll':'お散歩AI','route.tour':'観光案内（予定）',
    'lang.label':'言語',
    'search.placeholder':'店舗名・住所・電話番号で検索',
    'search.voice':'🎤 音声','search.button':'検索','search.clear':'履歴をクリア',
    'coord.start':'開始地点','coord.dest':'目的地点','coord.lon':'経度','coord.lat':'緯度',
    'save.label':'記憶地点（この端末に保存）','save.now':'現在地を保存','save.set':'目的地に設定','save.del':'削除',
    'msg.wait':'現在地の取得を待機中…','msg.ready':'準備完了。目的地を設定してください',
    'results.heading':'検索結果（近隣 上位5件）','results.close':'閉じる',
    'btn.nav':'案内開始','btn.cur':'現在地','btn.dest':'目的地','btn.reroute':'リルート',
    'save.title':'現在地を保存','save.namePh':'地点名（例：自宅・公園）',
    'common.cancel':'キャンセル','common.save':'保存',
    'rr.title':'リルート方式を選択（徒歩）','rr.do':'リルート',
    'clock.now':'現在 ','clock.eta':'到着 ',
    'status.searching':'検索中…','status.listening':'音声認識中…','status.voiceFail':'音声失敗','status.cleared':'履歴をクリアしました（案内を終了しました）',
    'msg.noStart':'開始地点未設定 → 地図中心を出発地として使用します。','msg.needCoords':'座標が不足しています（開始/目的地を設定）','msg.needDest':'先に目的地を選んでください','msg.noDest':'目的地が未設定です','msg.noCandidates':'候補が見つかりません','msg.candidates':'候補が見つかりました。リストから選ぶと案内を開始します。','msg.searching':'検索中…','msg.routeFail':'ルート取得に失敗しました（再試行してください）','msg.routeOK':'ルート取得完了','msg.startNav':'案内を開始します'
  },
  en:{
    title:'Pedestrian Navigator (Cloudflare Workers + OSM)',
    'route.shortest':'Shortest','route.easy':'Easy','route.stroll':'Stroll AI','route.tour':'Tour (planned)',
    'lang.label':'Language',
    'search.placeholder':'Search by name, address or phone',
    'search.voice':'🎤 Voice','search.button':'Search','search.clear':'Clear history',
    'coord.start':'Start','coord.dest':'Destination','coord.lon':'Longitude','coord.lat':'Latitude',
    'save.label':'Saved places (local)','save.now':'Save current','save.set':'Set as destination','save.del':'Delete',
    'msg.wait':'Waiting for current location…','msg.ready':'Ready. Set a destination.',
    'results.heading':'Results (Top 5 nearby)','results.close':'Close',
    'btn.nav':'Start guidance','btn.cur':'My location','btn.dest':'Destination','btn.reroute':'Reroute',
    'save.title':'Save current place','save.namePh':'Place name (e.g., Home/Park)',
    'common.cancel':'Cancel','common.save':'Save',
    'rr.title':'Choose reroute mode (on foot)','rr.do':'Reroute',
    'clock.now':'Now ','clock.eta':'ETA ',
    'status.searching':'Searching…','status.listening':'Listening…','status.voiceFail':'Voice failed','status.cleared':'History cleared (guidance stopped)',
    'msg.noStart':'No start set → using map center as start.','msg.needCoords':'Missing coordinates (set start/destination).','msg.needDest':'Choose a destination first','msg.noDest':'Destination not set','msg.noCandidates':'No candidates found','msg.candidates':'Found candidates. Tap one to start guidance.','msg.searching':'Searching…','msg.routeFail':'Failed to get route (retry)','msg.routeOK':'Route ready','msg.startNav':'Starting guidance'
  },
  ko:{ /* 以降は主要UIを簡易訳。必要に応じて精緻化可能 */
    title:'보행자 내비 (Cloudflare Workers + OSM)',
    'route.shortest':'최단','route.easy':'편안','route.stroll':'산책 AI','route.tour':'관광 안내(예정)',
    'lang.label':'언어',
    'search.placeholder':'이름·주소·전화로 검색',
    'search.voice':'🎤 음성','search.button':'검색','search.clear':'기록 지우기',
    'coord.start':'출발지','coord.dest':'목적지','coord.lon':'경도','coord.lat':'위도',
    'save.label':'저장 장소(로컬)','save.now':'현재 위치 저장','save.set':'목적지로 설정','save.del':'삭제',
    'msg.wait':'현재 위치 대기 중…','msg.ready':'준비 완료. 목적지를 설정하세요.',
    'results.heading':'검색 결과(주변 상위 5건)','results.close':'닫기',
    'btn.nav':'안내 시작','btn.cur':'현재 위치','btn.dest':'목적지','btn.reroute':'리루트',
    'save.title':'현재 위치 저장','save.namePh':'장소명(예: 집/공원)',
    'common.cancel':'취소','common.save':'저장',
    'rr.title':'리루트 방식 선택(도보)','rr.do':'리루트',
    'clock.now':'현재 ','clock.eta':'도착 ',
    'status.searching':'검색 중…','status.listening':'음성 인식 중…','status.voiceFail':'음성 실패','status.cleared':'기록 삭제(안내 종료)',
    'msg.noStart':'출발지 없음 → 지도의 중앙을 사용','msg.needCoords':'좌표 부족(출발/목적지 설정)','msg.needDest':'먼저 목적지를 선택','msg.noDest':'목적지 미설정','msg.noCandidates':'후보 없음','msg.candidates':'후보 발견. 탭하면 안내 시작.','msg.searching':'검색 중…','msg.routeFail':'경로 획득 실패(재시도)','msg.routeOK':'경로 준비됨','msg.startNav':'안내를 시작합니다'
  },
  fr:{
    title:'Navigation piétonne (Cloudflare Workers + OSM)',
    'route.shortest':'Le plus court','route.easy':'Facile','route.stroll':'Balade AI','route.tour':'Visite (prévu)',
    'lang.label':'Langue',
    'search.placeholder':'Recherche par nom, adresse ou téléphone',
    'search.voice':'🎤 Voix','search.button':'Rechercher','search.clear':'Effacer l’historique',
    'coord.start':'Départ','coord.dest':'Destination','coord.lon':'Longitude','coord.lat':'Latitude',
    'save.label':'Lieux enregistrés (local)','save.now':'Enregistrer la position','save.set':'Définir comme destination','save.del':'Supprimer',
    'msg.wait':'En attente de la position…','msg.ready':'Prêt. Définissez une destination.',
    'results.heading':'Résultats (Top 5 proches)','results.close':'Fermer',
    'btn.nav':'Démarrer','btn.cur':'Ma position','btn.dest':'Destination','btn.reroute':'Recalculer',
    'save.title':'Enregistrer ce lieu','save.namePh':'Nom du lieu (ex. Maison/Parc)',
    'common.cancel':'Annuler','common.save':'Enregistrer',
    'rr.title':'Choisir le recalcul (à pied)','rr.do':'Recalculer',
    'clock.now':'Actuel ','clock.eta':'Arrivée ',
    'status.searching':'Recherche…','status.listening':'Écoute…','status.voiceFail':'Échec voix','status.cleared':'Historique effacé (guidage arrêté)',
    'msg.noStart':'Pas de départ → centre de la carte utilisé','msg.needCoords':'Coordonnées manquantes','msg.needDest':'Choisissez d’abord une destination','msg.noDest':'Destination non définie','msg.noCandidates':'Aucun résultat','msg.candidates':'Des résultats trouvés. Touchez pour démarrer.','msg.searching':'Recherche…','msg.routeFail':'Échec d’itinéraire (réessayez)','msg.routeOK':'Itinéraire prêt','msg.startNav':'Démarrage du guidage'
  },
  es:{
    title:'Navegación a pie (Cloudflare Workers + OSM)',
    'route.shortest':'Más corto','route.easy':'Fácil','route.stroll':'Paseo AI','route.tour':'Turismo (previsto)',
    'lang.label':'Idioma',
    'search.placeholder':'Buscar por nombre, dirección o teléfono',
    'search.voice':'🎤 Voz','search.button':'Buscar','search.clear':'Borrar historial',
    'coord.start':'Inicio','coord.dest':'Destino','coord.lon':'Longitud','coord.lat':'Latitud',
    'save.label':'Lugares guardados (local)','save.now':'Guardar ubicación','save.set':'Definir como destino','save.del':'Eliminar',
    'msg.wait':'Esperando ubicación…','msg.ready':'Listo. Seleccione un destino.',
    'results.heading':'Resultados (Top 5 cercanos)','results.close':'Cerrar',
    'btn.nav':'Iniciar guía','btn.cur':'Mi ubicación','btn.dest':'Destino','btn.reroute':'Recalcular',
    'save.title':'Guardar este lugar','save.namePh':'Nombre (ej. Casa/Parque)',
    'common.cancel':'Cancelar','common.save':'Guardar',
    'rr.title':'Modo de recálculo (a pie)','rr.do':'Recalcular',
    'clock.now':'Ahora ','clock.eta':'Llegada ',
    'status.searching':'Buscando…','status.listening':'Escuchando…','status.voiceFail':'Fallo de voz','status.cleared':'Historial borrado (guía detenida)',
    'msg.noStart':'Sin inicio → usar centro del mapa','msg.needCoords':'Faltan coordenadas','msg.needDest':'Elija un destino primero','msg.noDest':'Destino no definido','msg.noCandidates':'Sin resultados','msg.candidates':'Resultados encontrados. Toque para iniciar.','msg.searching':'Buscando…','msg.routeFail':'Fallo al obtener ruta (reintente)','msg.routeOK':'Ruta lista','msg.startNav':'Iniciando guía'
  },
  zh:{
    title:'步行导航（Cloudflare Workers + OSM）',
    'route.shortest':'最短','route.easy':'轻松','route.stroll':'散步AI','route.tour':'观光（预定）',
    'lang.label':'语言',
    'search.placeholder':'按名称/地址/电话搜索',
    'search.voice':'🎤 语音','search.button':'搜索','search.clear':'清除历史',
    'coord.start':'起点','coord.dest':'终点','coord.lon':'经度','coord.lat':'纬度',
    'save.label':'已保存地点（本机）','save.now':'保存当前位置','save.set':'设为终点','save.del':'删除',
    'msg.wait':'正在等待当前位置…','msg.ready':'准备就绪。请设置目的地。',
    'results.heading':'搜索结果（附近前5）','results.close':'关闭',
    'btn.nav':'开始导航','btn.cur':'当前位置','btn.dest':'目的地','btn.reroute':'重新规划',
    'save.title':'保存当前位置','save.namePh':'地点名（如：家/公园）',
    'common.cancel':'取消','common.save':'保存',
    'rr.title':'选择重新规划方式（步行）','rr.do':'重新规划',
    'clock.now':'当前 ','clock.eta':'到达 ',
    'status.searching':'搜索中…','status.listening':'语音识别中…','status.voiceFail':'语音失败','status.cleared':'已清除历史（导航已停止）',
    'msg.noStart':'未设置起点 → 使用地图中心','msg.needCoords':'坐标缺失（请设定起/终点）','msg.needDest':'请先选择目的地','msg.noDest':'未设置目的地','msg.noCandidates':'没有结果','msg.candidates':'找到候选。点击开始导航。','msg.searching':'搜索中…','msg.routeFail':'获取路线失败（请重试）','msg.routeOK':'路线就绪','msg.startNav':'开始导航'
  }
};
function t(key){ const u=UI_STR[voiceMode]||UI_STR.ja; return u[key]||UI_STR.ja[key]||key; }

/* UI反映 */
function applyUIStrings(){
  document.title=t('title');
  document.documentElement.lang = voiceMode;
  // data-i18n のテキスト
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const val=t(key); if(val!=null) el.textContent=val;
  });
  // data-i18n-ph のプレースホルダ
  document.querySelectorAll('[data-i18n-ph]').forEach(el=>{
    const key=el.getAttribute('data-i18n-ph');
    const val=t(key); if(val!=null) el.setAttribute('placeholder', val);
  });
  // 時刻ラベルの接頭辞
  const nowPref=t('clock.now'); if(els.nowClock){ const txt=els.nowClock.textContent.replace(/^.*\s/, ''); els.nowClock.textContent=nowPref + txt; }
  const etaPref=t('clock.eta'); if(els.etaClock){ const txt=els.etaClock.textContent.replace(/^.*\s/, ''); els.etaClock.textContent=etaPref + txt; }
}

/* ===== ナビ音声のI18N（既存） ===== */
const I18N={ /* 省略せず既存のまま（前バージョンと同等） */ 
  ja:{ start:'案内を開始します。', near:'まもなく目的地です。', arrived:'目的地に到着しました。案内を終了します。',
       ahead:'前方', meters:'メートル', go:'直進してください', then:'、その後', proceed:'進みます', now:'ここで', head:'方向へ', using:'でリルートを開始します。',
       dirs:['北','東','南','西'], left:'左折してください', right:'右折してください', uturn:'Uターンしてください' },
  en:{ start:'Starting guidance.', near:'You are approaching your destination.', arrived:'You have arrived at your destination. Ending guidance.',
       ahead:'In', meters:'meters', go:'go straight', then:', then', proceed:'proceed', now:'Now,', head:'', using:' re-routing.',
       dirs:['north','east','south','west'], left:'turn left', right:'turn right', uturn:'make a U-turn' },
  ko:{ start:'안내를 시작합니다.', near:'곧 목적지에 도착합니다.', arrived:'목적지에 도착했습니다. 안내를 종료합니다.',
       ahead:'앞으로', meters:'미터', go:'직진하세요', then:', 이후', proceed:'진행합니다', now:'지금', head:' 방향으로', using:'로 경로를 다시 안내합니다.',
       dirs:['북','동','남','서'], left:'좌회전하세요', right:'우회전하세요', uturn:'유턴하세요' },
  fr:{ start:'Démarrage du guidage.', near:'Vous approchez de votre destination.', arrived:'Vous êtes arrivé à destination. Fin du guidage.',
       ahead:'Dans', meters:'mètres', go:'continuez tout droit', then:', puis', proceed:'avancez', now:'Maintenant,', head:' vers', using:' pour un nouveau calcul d’itinéraire.',
       dirs:['nord','est','sud','ouest'], left:'tournez à gauche', right:'tournez à droite', uturn:'faites demi-tour' },
  es:{ start:'Iniciando la guía.', near:'Está acercándose a su destino.', arrived:'Ha llegado a su destino. Finalizando la guía.',
       ahead:'En', meters:'metros', go:'siga recto', then:', luego', proceed:'avance', now:'Ahora,', head:' hacia', using:' para recalcular la ruta.',
       dirs:['norte','este','sur','oeste'], left:'gire a la izquierda', right:'gire a la derecha', uturn:'dé la vuelta' },
  zh:{ start:'开始导航。', near:'即将到达目的地。', arrived:'您已到达目的地。结束导航。',
       ahead:'前方', meters:'米', go:'直行', then:'，然后', proceed:'前进', now:'现在，', head:'方向', using:'开始重新规划路线。',
       dirs:['北','东','南','西'], left:'请左转', right:'请右转', uturn:'请掉头' }
};
const LANG_CODE={ ja:'ja-JP', en:'en-US', ko:'ko-KR', fr:'fr-FR', es:'es-ES', zh:'zh-CN' };

/* ===== TTS（重複抑制） ===== */
const tts=(function(){
  const q=[]; let speaking=false; let lastKey=null,lastAt=0;
  const minInterval=900, repeatWindow=7000;
  function pump(){ if(speaking) return; const it=q.shift(); if(!it) return;
    speaking=true; const u=new SpeechSynthesisUtterance(it.txt);
    u.lang=it.lang||'ja-JP'; u.rate=1.0; u.pitch=1.0;
    u.onend=()=>{ speaking=false; lastKey=(it.key||it.txt.slice(0,64))+'|'+(it.lang||''); lastAt=Date.now(); pump(); };
    try{ speechSynthesis.speak(u);}catch{ speaking=false; }
  }
  return {
    speak(txt,key,lang){
      const clean=String(txt||'').replace(/\s+/g,' ').replace(/。+/g,'。').trim();
      const now=Date.now();
      if(key && lastKey===key+'|'+lang && (now-lastAt)<repeatWindow) return;
      if((now-lastAt)<minInterval){ setTimeout(()=>{ q.push({txt:clean,key,lang}); pump(); }, Math.max(0,minInterval-(now-lastAt))); return; }
      q.push({txt:clean,key,lang}); pump();
    },
    stop(){ try{speechSynthesis.cancel();}catch{} speaking=false; q.length=0; lastKey=null; lastAt=0; }
  };
})();

/* ===== コンパス（落ち着き挙動） ===== */
const norm360=x=>{x%=360;if(x<0)x+=360;return x;}
const shortDiff=(a,b)=>{let d=norm360(b)-norm360(a);if(d>180)d-=360;if(d<-180)d+=360;return d;}
const compass={ angle:0,target:0,raf:null,maxDegPerSec:60,deadBand:3,lastTs:0,deviceMinInterval:120 };
function setCompassTarget(deg){ if(!Number.isFinite(deg)) return; const t=norm360(deg);
  if(Math.abs(shortDiff(compass.target,t))<compass.deadBand) return; compass.target=t;
  if(!compass.raf) compass.raf=requestAnimationFrame(needleStep);
}
function needleStep(ts){
  if(!needleStep.prev) needleStep.prev=ts;
  const dt=Math.max(1,ts-needleStep.prev)/1000; needleStep.prev=ts;
  const d=shortDiff(compass.angle,compass.target);
  if(Math.abs(d)<0.15){ compass.raf=null; needleStep.prev=0; return; }
  const maxStep=compass.maxDegPerSec*dt;
  const step=Math.sign(d)*Math.min(Math.abs(d)*0.10,maxStep);
  compass.angle=norm360(compass.angle+step);
  const g=document.getElementById('needle'); if(g) g.setAttribute('transform',`rotate(${compass.angle} 37 37)`);
  compass.raf=requestAnimationFrame(needleStep);
}
function initDeviceOrientation(){
  const getScreenAngle=()=> (screen.orientation&&typeof screen.orientation.angle==='number')?screen.orientation.angle:(typeof window.orientation==='number'?window.orientation:0)||0;
  const handler=(ev)=>{ const now=performance.now(); if(now-compass.lastTs<compass.deviceMinInterval) return;
    let heading=null;
    if(typeof ev.webkitCompassHeading==='number'){ if(ev.webkitCompassAccuracy>45) return; heading=ev.webkitCompassHeading; }
    else if(typeof ev.alpha==='number'){ heading=norm360(360-ev.alpha+getScreenAngle()); }
    compass.lastTs=now; if(heading!=null) setCompassTarget(heading);
  };
  if(window.DeviceOrientationEvent){
    if(DeviceOrientationEvent.requestPermission){
      DeviceOrientationEvent.requestPermission().then(s=>{ if(s==='granted'){ addEventListener('deviceorientation',handler,true); }});
    }else{
      addEventListener('deviceorientationabsolute',handler,true);
      addEventListener('deviceorientation',handler,true);
    }
  }
}

/* ===== 地図 ===== */
function ensureMapVisible(lat=35.362,lon=137.724,zoom=6){
  if(window.L&&L.map&&L.tileLayer){
    if(!mapReady){
      map=L.map('map',{zoomControl:false});
      const base=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20});
      base.addTo(map);
      const sk=document.getElementById('mapSkeleton');
      base.on('load',()=>{ if(sk) sk.style.display='none'; });
      base.on('tileerror',()=>{ if(sk) sk.style.display='none'; });
      setTimeout(()=>{ if(sk) sk.style.display='none'; }, 3000);
      L.control.zoom({position:'bottomleft'}).addTo(map);
      routeLayer=L.layerGroup().addTo(map);
      markerLayer=L.layerGroup().addTo(map);
      map.on('dragstart',()=>{ followMe=false; });
      window.addEventListener('resize',()=>{ if(mapReady&&map) setTimeout(()=>map.invalidateSize(),100); });
      mapReady=true;
    }
    map.setView([lat,lon],zoom);
    requestAnimationFrame(()=>map.invalidateSize());
    return;
  }
}

/* ===== 汎用 ===== */
const timeout=(p,ms)=>Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')),ms))]);
function setBusy(btn,flag){ if(!btn) return; if(flag){ btn.setAttribute('disabled',''); setTimeout(()=>btn.removeAttribute('disabled'),1100); }}

/* ===== 現在地 ===== */
function updateCurrent(latlng){
  lastKnownPos={lat:latlng[0],lng:latlng[1]};
  if(!mapReady) ensureMapVisible(latlng[0],latlng[1],18);
  if(currentMarker){ currentMarker.setLatLng(latlng); }
  else if(window.L){ currentMarker=L.marker(latlng,{title:t('btn.cur')}).addTo(markerLayer||map); }
}
function setStart(lon,lat){ els.startLon.value=lon??''; els.startLat.value=lat??''; }
function setDest(lon,lat){
  els.destLon.value=lon??''; els.destLat.value=lat??'';
  if(Number.isFinite(lat)&&Number.isFinite(lon)){
    if(!mapReady) ensureMapVisible(lat,lon,13);
    if(window.L){
      if(!destMarker) destMarker=L.marker([lat,lon],{title:t('btn.dest')}).addTo(markerLayer||map);
      else destMarker.setLatLng([lat,lon]);
    }
  }
}
function initGeolocation(){
  if(!navigator.geolocation){ ensureMapVisible(); els.msg.textContent=t('msg.ready'); return; }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude,longitude,heading}=pos.coords;
    ensureMapVisible(latitude,longitude,18);
    setStart(longitude,latitude);
    updateCurrent([latitude,longitude]);
    if(Number.isFinite(heading)) setCompassTarget(heading);
    els.msg.textContent=t('msg.ready');
  }, err=>{
    ensureMapVisible();
    els.msg.textContent=t('msg.wait')+' ('+err.message+')';
  }, {enableHighAccuracy:true,maximumAge:1000,timeout:8000});

  if(watchId) navigator.geolocation.clearWatch(watchId);
  watchId=navigator.geolocation.watchPosition(pos=>{
    const {latitude,longitude,heading}=pos.coords;
    updateCurrent([latitude,longitude]);
    if(Number.isFinite(heading)) setCompassTarget(heading);
    if(navActive && followMe && mapReady && map) map.setView([latitude,longitude], map.getZoom());
    if(navActive) advanceGuidance({lat:latitude,lng:longitude});
    tickNowClock(); updateEtaDynamic();
  },()=>{}, {enableHighAccuracy:true,maximumAge:2500,timeout:10000});
}

/* ===== ルーティング関連（既存ロジックを維持） ===== */
function actionFromOsrm(type,modifier){if(type==='arrive')return'arrive';if(type==='depart')return'straight';if(['left','sharp left','slight left'].includes(modifier))return'left';if(['right','sharp right','slight right'].includes(modifier))return'right';if(type==='uturn'||modifier==='uturn')return'uturn';return'straight';}
function osrmToOrsLike(osrm){const r=osrm.routes?.[0]; if(!r) return null; const coords=r.geometry?.coordinates||[]; const leg=r.legs?.[0]||{}; const steps=[]; let idx=0;(leg.steps||[]).forEach(st=>{const segLen=(st.geometry?.coordinates||[]).length; const name=st.name||''; const man=st.maneuver||{}; const action=actionFromOsrm(man.type,man.modifier); const toIdx=Math.min(coords.length-1, idx+Math.max(1,segLen)-1); steps.push({name,action,way_points:[idx,toIdx],distance:st.distance||0,duration:st.duration||0}); idx=toIdx;}); return {geometry:{type:'LineString',coordinates:coords},segments:[{distance:r.distance||0,duration:r.duration||0,steps}],summary:{distance:r.distance||0,duration:r.duration||0}};}
function decode6(str){let i=0,lat=0,lon=0,out=[];while(i<str.length){let b,shift=0,res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);const dlat=((res&1)?~(res>>1):(res>>1));shift=0;res=0;do{b=str.charCodeAt(i++)-63;res|=(b&0x1f)<<shift;shift+=5}while(b>=0x20);const dlon=((res&1)?~(res>>1):(res>>1));lat+=dlat;lon+=dlon;out.push([lat/1e6,lon/1e6])}return out}
function valhallaToOrsLike(vh){const tr=vh.trip; if(!tr) return null; const leg=tr.legs?.[0]; if(!leg) return null; const coords=[];(leg.shape?.length?decode6(leg.shape):[]).forEach(p=>coords.push([p[1],p[0]])); const steps=[]; let idx=0;(leg.maneuvers||[]).forEach(mv=>{const name=(mv.street_names&&mv.street_names[0])||''; const action=(mv.type===17?'right':mv.type===18?'left':mv.type===16?'uturn':(mv.type===15||mv.type===4)?'arrive':'straight'); const addPts=Math.max(1,Math.round((mv.length||0)*20)); const toIdx=Math.min(coords.length-1, idx+addPts); steps.push({name,action,way_points:[idx,toIdx],distance:(mv.length||0)*1000,duration:mv.time||0}); idx=toIdx;}); const dist=(tr.summary?.length||0)*1000, dur=tr.summary?.time||0; return {geometry:{type:'LineString',coordinates:coords},segments:[{distance:dist,duration:dur,steps}],summary:{distance:dist,duration:dur}};}
function normalizeRoadName(name){ if(!name) return ''; const m=name.match(/^(国道|県道|町道)\s*(\d+)\s*号(線)?/); if(m) return `${m[1]}${m[2]}号線`; return name; }
function normalizeRoadNameEn(name){ if(!name) return ''; const m=name.match(/^(国道|県道|町道)\s*(\d+)\s*号(線)?/); if(m){ if(m[1]==='国道') return `National Route ${m[2]}`; if(m[1]==='県道') return `Prefectural Route ${m[2]}`; if(m[1]==='町道') return `Town Road ${m[2]}`; } return name; }
function cardinal4(deg, lang){ const a=norm360(deg); const d=I18N[lang]?.dirs||I18N.ja.dirs; if(a<45||a>=315) return d[0]; if(a<135) return d[1]; if(a<225) return d[2]; return d[3]; }
function initialBearing(){ const g=lastRoute?.route?.geometry?.coordinates; if(!g||g.length<2) return null; const a={lat:g[0][1],lng:g[0][0]},b={lat:g[1][1],lng:g[1][0]}; const toRad=t=>t*Math.PI/180, toDeg=t=>t*180/Math.PI; const φ1=toRad(a.lat),φ2=toRad(b.lat),λ1=toRad(a.lng),λ2=toRad(b.lng); const y=Math.sin(λ2-λ1)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1); return norm360(toDeg(Math.atan2(y,x))); }

/* ===== ETA/残距離（既存） ===== */
function buildRouteMeta(latlngs, route){ const cum=[0]; let total=0; const dist=(a,b)=>L.latLng(a[0],a[1]).distanceTo(L.latLng(b[0],b[1])); for(let i=1;i<latlngs.length;i++){ total += dist(latlngs[i-1], latlngs[i]); cum[i]=total; } const s=route?.summary; const dur = s?.duration ?? (route?.segments||[]).reduce((a,b)=>a+(b.duration||0),0); const speed = (dur>0 && total>0) ? (total/dur) : 1.2; return {latlngs, cum, total, speed}; }
function extractDurDist(route){ const s=route?.summary; if(s) return {dur:s.duration,dist:s.distance}; const seg=route?.segments||[]; return {dur:seg.reduce((a,b)=>a+(b.duration||0),0),dist:seg.reduce((a,b)=>a+(b.distance||0),0)}; }
function km(m){ return (m/1000).toFixed(m>=10000?0:(m>=1000?1:2)); }
function fmtDurationMin(sec){ const m=Math.max(1,Math.ceil(sec/60)); const h=Math.floor(m/60), mm=m%60; return h>0?`${h}時間${mm}分`:`${mm}分`; }
function computeFinalSec(route){ const {dur,dist}=extractDurDist(route); const modelSec=dist>0 ? dist/1.2 : 0; let sec = Math.max(dur||0, modelSec||0); return Math.max(60, Math.ceil(sec/60)*60); }
function estimateRemainingSeconds(){ if(!lastRoute?.meta) return null; const meta=lastRoute.meta; let cur = lastKnownPos; if(!cur && currentMarker){ const ll=currentMarker.getLatLng(); cur={lat:ll.lat,lng:ll.lng}; } if(!cur) return null; let bestIdx=0, bestD=Infinity; for(let i=0;i<meta.latlngs.length;i++){ const p=meta.latlngs[i]; const d=L.latLng(cur.lat,cur.lng).distanceTo(L.latLng(p[0],p[1])); if(d<bestD){ bestD=d; bestIdx=i; } } const remainingDistance = Math.max(0, meta.total - meta.cum[bestIdx]); const speed = Math.max(0.6, Math.min(2.0, meta.speed||1.2)); let sec = remainingDistance / speed; sec = Math.max(60, Math.ceil(sec/60)*60); return {sec, remainingDistance}; }
function updateETAPill(route, overrideSec=null, overrideDist=null){
  const r = route || lastRoute?.route; if(!r){ return; }
  let sec = overrideSec!=null ? overrideSec : computeFinalSec(r);
  let dist = overrideDist!=null ? overrideDist : extractDurDist(r).dist;
  const now=new Date(); const eta=new Date(now.getTime()+sec*1000);
  els.etaDurationTop.textContent=fmtDurationMin(sec);
  els.etaDistanceTop.textContent=`${km(dist)} km`;
  els.etaClock.textContent=`${t('clock.eta')}${String(eta.getHours()).padStart(2,'0')}:${String(eta.getMinutes()).padStart(2,'0')}`;
}
function tickNowClock(){ const n=new Date(); els.nowClock.textContent=`${t('clock.now')}${String(n.getHours()).padStart(2,'0')}:${String(n.getMinutes()).padStart(2,'0')}`; }
function updateEtaDynamic(){ const est = estimateRemainingSeconds(); if(est && lastRoute?.route){ updateETAPill(lastRoute.route, est.sec, est.remainingDistance); } else if(lastRoute?.route){ const sec=computeFinalSec(lastRoute.route); updateETAPill(lastRoute.route, sec, extractDurDist(lastRoute.route).dist); } }

/* ===== 音声ガイダンス（既存） ===== */
function buildIntroSpeechLang(lang){
  const L=I18N[lang]||I18N.ja;
  const st=lastRoute?.route?.segments?.[0]?.steps?.[0];
  const br=initialBearing(); const dir=(br!=null)?cardinal4(br,lang):'';
  const langCode=LANG_CODE[lang]||'ja-JP';
  if(!st){
    const base = lang==='en' ? `${L.start} ${dir?`Head ${dir} and `:''}${L.go}.` :
                lang==='fr' ? `${L.start} ${dir?`Cap ${dir} et `:''}${L.go}.` :
                lang==='es' ? `${L.start} ${dir?`Vaya hacia ${dir} y `:''}${L.go}.` :
                lang==='ko' ? `${L.start} ${dir?`${dir}${L.head} `:''}${L.go}.` :
                lang==='zh' ? `${L.start} ${dir?`向${dir} ${L.go}。`:`${L.go}。`}` :
                              `${L.start}${dir?dir+'へ':''}${L.go}。`;
    return {text:base, lang:langCode};
  }
  const roadJa = normalizeRoadName(st.name||'') || (lang==='ja'?'この道':'');
  const roadEn = normalizeRoadNameEn(st.name||'') || 'this road';
  const road = lang==='ja'?roadJa:roadEn;
  const dRaw=Math.max(1,Math.round(st.distance||0));
  const BUCKETS=[200,150,120,80,50,30,10,5,3];
  function bucket(d){ if(d>200) return 200; for(const b of BUCKETS){ if(d>b) return b; if(d===b) return b; } return 3; }
  const b=bucket(dRaw);
  const dLabel=b>=120?(lang==='en'?`about ${b}`:`約${b}`):`${b}`;
  const action=st.action||'straight';
  let s='';
  switch(lang){
    case 'en': s = `${L.start} Proceed ${dir?`${dir} `:''}${dLabel} ${L.meters} on ${road}${action==='straight'?'.':`, then ${I18N.en[action]}.`}`; break;
    case 'fr': s = `${L.start} ${L.proceed} ${dir?`vers ${dir} `:''}${dLabel} ${L.meters} sur ${road}${action==='straight'?'.':`, puis ${I18N.fr[action]}.`}`; break;
    case 'es': s = `${L.start} ${L.proceed} ${dir?`hacia ${dir} `:''}${dLabel} ${L.meters} por ${road}${action==='straight'?'.':`, luego ${I18N.es[action]}.`}`; break;
    case 'ko': s = `${L.start} ${dir?`${dir}${L.head} `:''}${dLabel}${L.meters} ${L.proceed} (${road})${action==='straight'?'.':`, 이후 ${I18N.ko[action]}.`}`; break;
    case 'zh': s = `${L.start} ${dir?`向${dir} `:''}${dLabel}${L.meters} 在${road}${L.proceed}${action==='straight'? '。' : `，然后${I18N.zh[action]}。`}`; break;
    default:   s = `${L.start}${road}を${dir?dir+'に':''}${dLabel}${L.meters}${L.proceed}。${action==='straight'?'':I18N.ja[action]}`;
  }
  return {text:s, lang:langCode};
}
function bucketSpeakTextLang(lang, b, s){
  const L=I18N[lang]||I18N.ja;
  const dLabel = (lang==='en') ? (b>=120?`about ${b}`:`${b}`) : (b>=120?`約${b}`:`${b}`);
  switch(lang){
    case 'en': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.en[s.action]||L.go}.`;
    case 'fr': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.fr[s.action]||L.go}.`;
    case 'es': return `${L.ahead} ${dLabel} ${L.meters}, ${I18N.es[s.action]||L.go}.`;
    case 'ko': return `${L.ahead} ${dLabel}${L.meters}, ${I18N.ko[s.action]||L.go}.`;
    case 'zh': return `${L.ahead}${dLabel}${L.meters}，${I18N.zh[s.action]||L.go}。`;
    default:   return `${L.ahead}${dLabel}${L.meters}を、${I18N.ja[s.action]||L.go}`;
  }
}
function nowSpeakTextLang(lang, s){ const L=I18N[lang]||I18N.ja; const map=I18N[lang]||I18N.ja;
  switch(lang){
    case 'en': return `${L.now} ${map[s.action]||L.go}.`;
    case 'fr': return `${L.now} ${map[s.action]||L.go}.`;
    case 'es': return `${L.now} ${map[s.action]||L.go}.`;
    case 'ko': return `${L.now} ${map[s.action]||L.go}.`;
    case 'zh': return `${L.now}${map[s.action]||L.go}。`;
    default:   return `${L.now}${map[s.action]||L.go}`;
  }
}

/* ===== ガイダンス進行（既存） ===== */
function prepareGuidance(){
  navState={steps:[],idx:0,nearArrivalSaid:false,arrived:false,lastBucketIdx:null,startAt:Date.now()};
  const coords=lastRoute.route?.geometry?.coordinates||[], st=lastRoute.route?.segments?.[0]?.steps||[];
  const steps=[];
  st.forEach(s=>{
    const i2=Array.isArray(s.way_points)?s.way_points[1]:null;
    if(i2!=null&&coords[i2]){
      const [lon,lat]=coords[i2];
      steps.push({lat,lon,action:(s.action||'straight'),distance:s.distance||0});
    }
  });
  navState.steps=steps;
  if(steps[0]){ const BUCKETS=[200,150,120,80,50,30,10,5,3]; const b=(d)=>{ if(d>200) return 200; for(const x of BUCKETS){ if(d>x) return x; if(d===x) return x; } return 3; }; const bi=(v)=>BUCKETS.indexOf(v); navState.lastBucketIdx=bi(b(steps[0].distance)); }
  updateEtaDynamic();
}
function advanceGuidance(cur){
  if(!navState || navState.arrived) return;
  const L=I18N[voiceMode]||I18N.ja;
  if(destMarker){
    const d=L.latLng(cur.lat,cur.lng).distanceTo(destMarker.getLatLng());
    if(d<=5 && !navState.arrived){
      tts.speak(L.arrived,'arrived',LANG_CODE[voiceMode]);
      navState.arrived=true; navActive=false; return;
    }
    if(d<=8 && !navState.nearArrivalSaid){
      tts.speak(L.near,'near-arrival',LANG_CODE[voiceMode]);
      navState.nearArrivalS
