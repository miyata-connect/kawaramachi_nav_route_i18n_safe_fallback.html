<!-- ISSUE: das202511011946 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="x-issue" content="das202511011946" />
  <title>WalkNav 監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0a1321; --panel:#131c2e; --text:#eaf2ff; --muted:#a7b8ce; --accent:#5fb1ff; --ok:#25d07a; --bad:#ff6565; --warn:#ffb020; --stroke:rgba(255,255,255,.12);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:1180px;margin:26px auto;padding:0 16px}
    h1{margin:0 0 10px}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:14px;padding:16px;margin:14px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .col{flex:1 1 320px}
    label{font-size:14px;color:var(--muted)}
    input,button,select{
      width:100%;padding:10px;border-radius:10px;border:1px solid var(--stroke);background:#0f1727;color:var(--text);
    }
    button{cursor:pointer}
    .mini{width:auto; padding:8px 10px; font-size:13px}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .gauge{font-size:56px;font-weight:800;letter-spacing:1px}
    .sub{color:var(--muted);font-size:13px}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--stroke);padding:8px 6px;text-align:left;font-size:13px}
    .badge{display:inline-block;padding:4px 8px;border:1px solid var(--stroke);border-radius:999px;background:#0f1727;font-size:12px}
    /* Slide panel */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:flex-start;justify-content:flex-end;z-index:50}
    .panel{width:min(520px,100%);height:100%;background:#0c1424;border-left:1px solid var(--stroke);padding:16px;overflow:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; font-size:12px}
    .hint{font-size:12px;color:var(--muted)}
    .right{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WalkNav 監査ダッシュボード <span class="badge" id="issueBadge">ISSUE: --</span></h1>

    <!-- 接続先名 + テスト + 判定 -->
    <div class="card">
      <div class="row">
        <div class="col">
          <label>接続先（Worker エンドポイント）</label>
          <input id="ep" placeholder="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
        </div>
        <div class="right">
          <button id="btnPing" class="mini">接続テスト</button>
          <span id="pingMark" style="font-size:20px">—</span>
        </div>
        <div class="col">
          <label>発行番号（自動取得 / 手動切替）</label>
          <div class="row">
            <div class="col">
              <select id="issueSelect">
                <option value="">— 自動検出（/healthz）—</option>
              </select>
            </div>
            <div class="right">
              <span class="hint">自動で /healthz の issue を取得</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 総合判定 -->
    <div class="card">
      <div class="row" style="align-items:flex-end">
        <div class="col">
          <div class="gauge" id="totalScore">--</div>
          <div class="sub">総合判定（平均スコア）</div>
        </div>
        <div class="col">
          <div class="gauge" id="latestScore">--</div>
          <div class="sub">直近 RUN スコア</div>
        </div>
        <div class="col">
          <div class="gauge" id="latestErr">--%</div>
          <div class="sub">直近 エラー率</div>
        </div>
        <div class="right">
          <button id="btnRefresh" class="mini">再取得</button>
        </div>
      </div>
    </div>

    <!-- 自己診断（入口・実行中・出口） -->
    <div class="card">
      <h3 style="margin:0 0 8px">自己診断</h3>
      <div class="grid3">
        <div>
          <div class="sub">入口（entry）</div>
          <div class="gauge" id="scoreEntry">--</div>
        </div>
        <div>
          <div class="sub">実行中（run）</div>
          <div class="gauge" id="scoreRun">--</div>
        </div>
        <div>
          <div class="sub">出口（exit）</div>
          <div class="gauge" id="scoreExit">--</div>
        </div>
      </div>
      <div class="hint" style="margin-top:8px">※ 手動投稿機能は廃止。WalkNav 本体または自動化から /audit/run を送信してください。</div>
    </div>

    <!-- セクション内訳 -->
    <div class="card">
      <h3 style="margin:0 0 8px">セクション内訳（リスク比率）</h3>
      <table id="riskTable">
        <thead><tr><th>項目</th><th>リスク</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- 接続先（生の統計） -->
    <div class="card">
      <h3 style="margin:0 0 8px">接続先 統計</h3>
      <div class="mono" id="reportBox">{}</div>
    </div>

    <!-- 最終ログ 25件 -->
    <div class="card">
      <h3 style="margin:0 0 8px">最終ログ 25件</h3>
      <table id="evTable">
        <thead><tr><th>時刻</th><th>種別</th><th>短文</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="hint" style="margin-top:6px">※ 行をタップすると詳細パネルがスライド表示されます。</div>
    </div>
  </div>

  <!-- 詳細パネル -->
  <div class="overlay" id="ov">
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">詳細</h3>
        <button id="closePanel" class="mini">閉じる</button>
      </div>
      <div id="detailBox" class="mono" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    const ISSUE_ID = "das202511011946";
    const $ = (s)=>document.querySelector(s);
    const qi = (id)=>document.getElementById(id);

    function prettyt(ms){ const d=new Date(ms); return d.toLocaleString(); }
    function hoursAgo(h){ return Date.now()-h*3600*1000; }

    async function jget(url){
      const r = await fetch(url);
      if(!r.ok) throw new Error("HTTP "+r.status);
      return r.json();
    }

    // 接続テスト
    async function ping(){
      const ep = qi("ep").value.trim();
      try{
        const h = await jget(`${ep}/healthz`);
        qi("pingMark").textContent = "✅";
        // 発行番号 自動取得 → セレクトへ
        const opt = document.createElement("option");
        opt.value = h.issue || "";
        opt.textContent = h.issue ? `自動検出: ${h.issue}` : "自動検出: (なし)";
        // 先頭の自動検出を置き換え
        const sel = qi("issueSelect");
        sel.innerHTML = "";
        sel.appendChild(opt);
        qi("issueBadge").textContent = "ISSUE: " + (h.issue || "--");
        return true;
      }catch{
        qi("pingMark").textContent = "❌";
        return false;
      }
    }

    // レポート再取得
    async function refresh(){
      const ep = qi("ep").value.trim();
      const from = hoursAgo(24), to = Date.now();

      // 最新スコア
      try{
        const cur = await jget(`${ep}/audit/score/current`);
        qi("latestScore").textContent = String(cur.score ?? "--");
        qi("latestErr").textContent   = (cur.errorRate ?? "--") + "%";
        if(cur.latest && cur.latest.issue){
          qi("issueBadge").textContent = "ISSUE: " + cur.latest.issue;
          // セレクトに未登録なら追加
          const sel = qi("issueSelect");
          const exists = Array.from(sel.options).some(o=>o.value===cur.latest.issue);
          if(!exists){
            const o=document.createElement("option");
            o.value = cur.latest.issue;
            o.textContent = `検出: ${cur.latest.issue}`;
            sel.appendChild(o);
          }
        }
      }catch{
        qi("latestScore").textContent="--";
        qi("latestErr").textContent="--%";
      }

      // レポート
      try{
        const rep = await jget(`${ep}/audit/report?from=${from}&to=${to}`);
        // 総合（平均）
        qi("totalScore").textContent = String(rep.report?.avgScore ?? "--");
        // 自己診断（入口/実行/出口）: runs から最新各フェーズ
        const runs = rep.runs || [];
        const latestEntry = [...runs].filter(r=>r.phase==="entry").sort((a,b)=>b.ts-a.ts)[0];
        const latestRun   = [...runs].filter(r=>r.phase==="run").sort((a,b)=>b.ts-a.ts)[0];
        const latestExit  = [...runs].filter(r=>r.phase==="exit").sort((a,b)=>b.ts-a.ts)[0];
        qi("scoreEntry").textContent = latestEntry ? latestEntry.score : "--";
        qi("scoreRun").textContent   = latestRun   ? latestRun.score   : "--";
        qi("scoreExit").textContent  = latestExit  ? latestExit.score  : "--";

        // 内訳テーブル
        const rt = qi("riskTable").querySelector("tbody");
        rt.innerHTML = "";
        (rep.report?.risk || []).forEach(r=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${r.label}</td><td>${r.pct}%</td>`;
          rt.appendChild(tr);
        });

        // 生 JSON
        qi("reportBox").textContent = JSON.stringify(rep, null, 2);

      }catch{
        qi("totalScore").textContent="--";
        qi("scoreEntry").textContent="--";
        qi("scoreRun").textContent="--";
        qi("scoreExit").textContent="--";
        qi("reportBox").textContent="{}";
        const rt = qi("riskTable").querySelector("tbody");
        rt.innerHTML = "";
      }

      // 最新 25 ログ
      try{
        const ev = await jget(`${ep}/audit/latest?n=25`);
        const tb = qi("evTable").querySelector("tbody");
        tb.innerHTML = "";
        (ev.items||[]).forEach(x=>{
          const tr=document.createElement("tr");
          tr.innerHTML = `<td>${prettyt(x.ts)}</td><td>${x.kind}</td><td>${(x.message||"").slice(0,60)}</td>`;
          tr.style.cursor = "pointer";
          tr.addEventListener("click", ()=> openDetail(x));
          tb.appendChild(tr);
        });
      }catch{
        const tb = qi("evTable").querySelector("tbody");
        tb.innerHTML = "";
      }
    }

    // 詳細パネル（仕様に合わせてオーダー番号・内容・得点等を表示）
    function openDetail(x){
      const orderId   = x.meta?.orderId || x.meta?.order || x.id || "(なし)";
      const orderText = (x.meta?.orderText || x.message || "").toString().slice(0, 300);
      const diag = {
        entry: x.meta?.entryScore ?? "(不明)",
        runError: x.meta?.runErrorRate ?? "(不明)",
        exit: x.meta?.exitScore ?? "(不明)",
        avg: x.meta?.avgScore ?? "(不明)"
      };
      const breakdown = x.meta?.breakdown || [];

      const html = [
        `オーダー番号: ${orderId}`,
        ``,
        `オーダー内容(先頭300文字):`,
        orderText || "(なし)",
        ``,
        `自己診断:`,
        ` - 入口: ${diag.entry}`,
        ` - 実行中エラー率: ${diag.runError}`,
        ` - 出口: ${diag.exit}`,
        ` - 平均スコア: ${diag.avg}`,
        ``,
        `セクション内訳:`,
        ...(breakdown.length? breakdown.map(b=>` - ${b.label}: ${b.pct}%`): ["(未登録)"]),
        ``,
        `Raw:`,
        JSON.stringify(x, null, 2)
      ].join("\n");

      qi("detailBox").textContent = html;
      qi("ov").style.display = "flex";
    }
    qi("closePanel").addEventListener("click", ()=> qi("ov").style.display="none");
    qi("ov").addEventListener("click", (e)=>{ if(e.target.id==="ov") qi("ov").style.display="none"; });

    // UI handlers
    qi("btnPing").addEventListener("click", async ()=>{ await ping(); });
    qi("btnRefresh").addEventListener("click", refresh);

    // 初期値
    qi("ep").value = "https://ors-proxy-dev.miyata-connect-jp.workers.dev";
    (async ()=>{ await ping(); await refresh(); setInterval(refresh, 8000); })();
  </script>
</body>
</html>