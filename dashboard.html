<!-- ISSUE_ID: das202511012330 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x-issue" content="das202511012330">
  <title>監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0a1321; --panel:#111A2B; --glass:rgba(20,28,44,.7);
      --stroke:rgba(255,255,255,.14); --text:#EAF2FF; --muted:#A7B8CE;
      --ok:#25D07A; --warn:#FFC857; --bad:#FF6565; --accent:#5FB1FF;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .card{background:var(--glass);border:1px solid var(--stroke);border-radius:16px;padding:14px 16px;backdrop-filter:blur(6px)}
    h1{font-size:20px;margin:0 0 12px}
    h2{font-size:16px;margin:0 0 8px}
    .tiny{font-size:11px;color:var(--muted)}
    .btn{height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--stroke);background:#152136;color:var(--text)}
    .btn:active{transform:translateY(1px)}
    input[type="text"]{height:36px;border-radius:10px;border:1px solid var(--stroke);background:#0f1727;color:var(--text);padding:0 10px;min-width:260px}
    .badge{display:inline-block;padding:3px 8px;border:1px solid var(--stroke);border-radius:999px;background:#0f1727}
    .grid{display:grid;gap:12px}
    .grid.cols2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols4{grid-template-columns:repeat(4,minmax(0,1fr))}
    @media(max-width:900px){.grid.cols3,.grid.cols4{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid.cols2,.grid.cols3,.grid.cols4{grid-template-columns:1fr}}
    .score{display:flex;align-items:center;gap:10px}
    .bar{flex:1;height:12px;border-radius:999px;background:#0f1727;border:1px solid var(--stroke);overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--ok),var(--accent));transition:width .3s}
    .mono{font-variant-numeric:tabular-nums}
    .kv{display:flex;flex-direction:column;gap:6px}
    .kv .k{font-size:12px;color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto}
    .item{border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#0f1727}
    .item h4{margin:0 0 4px;font-size:14px}
    .item p{margin:0;font-size:13px;color:#d7e4ff}
    .nowrap{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .small{font-size:12px}
    .pill{display:inline-flex;gap:6px;align-items:center}
    .right{margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <h1>監査ダッシュボード</h1>
      <span class="tiny">発行番号: <span id="issue" class="badge">das202511012330</span></span>
    </div>

    <!-- 接続先 + テスト -->
    <div class="card">
      <div class="row">
        <label class="tiny" for="endpoint">接続先</label>
        <input id="endpoint" type="text" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
        <button id="btnPing" class="btn">接続テスト</button>
        <span id="pingBadge" class="badge">未判定</span>
        <button id="btnRefresh" class="btn right">再取得</button>
      </div>
    </div>

    <!-- 総合判定（厳格：100点 or 0点） -->
    <div class="card">
      <h2>総合判定</h2>
      <div class="score">
        <div class="bar"><i id="scoreBar"></i></div>
        <strong id="scoreNum" class="mono">0</strong>
      </div>
      <div class="tiny" id="scoreNote">厳格モード：要件をすべて満たした時のみ100点</div>
    </div>

    <!-- 自己診断 -->
    <div class="grid cols3">
      <div class="card">
        <h2>自己診断（入り口）</h2>
        <div class="kv">
          <div class="k">直近の自己診断スコア（平均）</div>
          <div><span id="avgScore" class="mono">0</span> 点</div>
        </div>
      </div>
      <div class="card">
        <h2>自己診断（実行中）</h2>
        <div class="kv">
          <div class="k">直近エラー率</div>
          <div><span id="errRate" class="mono">0</span>%</div>
        </div>
      </div>
      <div class="card">
        <h2>自己診断（出口）</h2>
        <div class="kv">
          <div class="k">最新のイベント数</div>
          <div><span id="evCount" class="mono">0</span> 件</div>
        </div>
      </div>
    </div>

    <!-- セクション内訳 -->
    <div class="card">
      <h2>セクション内訳（リスク推定）</h2>
      <div class="grid cols3" id="sections"></div>
      <div class="tiny">※ 表示幅を自動調整し、はみ出し防止済み</div>
    </div>

    <!-- 最新イベント（25件） -->
    <div class="card">
      <h2>最新イベント（25件）</h2>
      <div class="list" id="evList"></div>
    </div>
  </div>

  <script>
  // ---- 初期設定 ----
  const ISSUE_ID = "das202511012330";
  const qs = (s)=>document.querySelector(s);
  const endpointInput = qs("#endpoint");
  const scoreBar = qs("#scoreBar");
  const scoreNum = qs("#scoreNum");
  const avgScore = qs("#avgScore");
  const errRate = qs("#errRate");
  const evCount = qs("#evCount");
  const pingBadge = qs("#pingBadge");
  const sectionsEl = qs("#sections");
  const evList = qs("#evList");

  // セクション内訳（固定上限）
  const SECTION_RISKS = [
    ["ルーティング互換", 2],
    ["CORS/Origin 厳格化", 3],
    ["FieldMask/整合", 2],
    ["Secrets 参照", 2],
    ["エラー整形/返却差", 2],
    ["速度劣化(監査負荷)", 1],
  ];

  function renderSections() {
    sectionsEl.innerHTML = "";
    SECTION_RISKS.forEach(([name, risk])=>{
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <div class="kv">
          <div class="k nowrap">${name}</div>
          <div><span class="mono">${risk}</span>%</div>
        </div>
      `;
      sectionsEl.appendChild(card);
    });
  }

  async function ping() {
    const ep = endpointInput.value.trim().replace(/\/+$/, "");
    try{
      const r = await fetch(ep + "/healthz", { mode:"cors" });
      if(!r.ok) throw new Error(String(r.status));
      const j = await r.json();
      pingBadge.textContent = "✅";
      pingBadge.style.color = "#25D07A";
      return j;
    }catch(e){
      pingBadge.textContent = "❌";
      pingBadge.style.color = "#FF6565";
      return null;
    }
  }

  function strictScore(summary){
    // 厳格モード：以下を満たす時のみ100点
    // - avgScore >= 90
    // - recentErrorRate === 0
    // - latestEvents は 1件以上
    const ok =
      (summary.avgScore >= 90) &&
      (Number(summary.recentErrorRate) === 0) &&
      (Array.isArray(summary.latestEvents) && summary.latestEvents.length > 0);
    return ok ? 100 : 0;
  }

  function setBar(n){
    const v = Math.max(0, Math.min(100, Number(n)||0));
    scoreBar.style.width = v + "%";
    scoreNum.textContent = v;
  }

  function renderEvents(items){
    evList.innerHTML = "";
    if(!items || !items.length){
      const empty = document.createElement("div");
      empty.className = "tiny";
      empty.textContent = "イベントはありません。";
      evList.appendChild(empty);
      return;
    }
    items.forEach(ev=>{
      const div = document.createElement("div");
      div.className = "item";
      const t = new Date(ev.ts||Date.now());
      div.innerHTML = `
        <h4 class="nowrap">${(ev.title||"イベント")} <span class="tiny">/ ${t.toLocaleString()}</span></h4>
        <p class="small nowrap">オーダー番号: ${(ev.orderId||"—")}</p>
        <p>${(ev.detail||"").slice(0,300)}</p>
        <div class="tiny pill">
          <span class="badge">${ev.section||"general"}</span>
          <span class="badge">${ev.severity||"info"}</span>
        </div>
      `;
      evList.appendChild(div);
    });
  }

  async function reloadAll(){
    renderSections();
    const ep = endpointInput.value.trim().replace(/\/+$/, "");

    // summary
    let summary = { ok:false, totals:{runs:0,events:0}, avgScore:0, recentErrorRate:0, latestEvents:[] };
    try{
      const r = await fetch(ep + "/audit/summary", { mode:"cors" });
      if(r.ok) summary = await r.json();
    }catch{}

    avgScore.textContent = Number(summary.avgScore||0);
    errRate.textContent = Number(summary.recentErrorRate||0);
    evCount.textContent = (summary.latestEvents||[]).length;

    // 厳格総合判定
    setBar(strictScore(summary));

    // events
    try{
      const r2 = await fetch(ep + "/audit/events?limit=25", { mode:"cors" });
      if(r2.ok){
        const j2 = await r2.json();
        renderEvents(j2.items||[]);
      }else{
        renderEvents([]);
      }
    }catch{
      renderEvents([]);
    }
  }

  // イベント
  qs("#btnPing").addEventListener("click", async ()=>{ await ping(); });
  qs("#btnRefresh").addEventListener("click", async ()=>{ await reloadAll(); });

  // 起動時
  (async ()=>{
    await ping();
    await reloadAll();
  })();
  </script>
</body>
</html>