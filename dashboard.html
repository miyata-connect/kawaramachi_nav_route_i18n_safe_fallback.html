<!-- dashboard.html -->
<!-- ISSUE_ID: das202511012231 -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta name="x-issue" content="das202511012231">
  <title>監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0b0f1a; --panel:#121a2a; --glass:rgba(255,255,255,.06);
      --text:#eaf2ff; --muted:#a7b8ce; --stroke:rgba(255,255,255,.12);
      --ok:#25d07a; --warn:#ffcc66; --bad:#ff6565; --accent:#5fb1ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:1100px;margin:20px auto;padding:12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:14px}
    .h{font-weight:700}
    .sm{font-size:.88rem;color:var(--muted)}
    input,button{height:36px;border-radius:10px;border:1px solid var(--stroke);background:var(--glass);color:var(--text);padding:0 10px}
    button{cursor:pointer}
    .ok{color:var(--ok)} .bad{color:var(--bad)}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--stroke);padding:8px 10px;border-radius:12px;background:var(--glass)}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:1fr 1fr}
    .g3{grid-template-columns:1fr 1fr 1fr}
    @media(max-width:900px){.g3{grid-template-columns:1fr}}
    .bar{height:14px;border-radius:7px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--accent);width:0%}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
    .list{max-height:360px;overflow:auto;border:1px solid var(--stroke);border-radius:12px}
    .li{display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--stroke);padding:10px 12px;white-space:nowrap}
    .li:last-child{border-bottom:none}
    .fit{min-width:0}
    .ellipsis{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .s{font-size:.9rem} .xs{font-size:.8rem}
    .tag{font-size:.75rem;color:var(--muted)}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap grid g3">
    <!-- 接続先 -->
    <div class="card">
      <div class="h">接続先</div>
      <div class="row" style="margin-top:8px">
        <input id="ep" class="fit" style="width:100%" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnTest">接続テスト</button>
        <span id="testIcon" class="pill sm">未検査</span>
        <button id="btnRefresh">再取得</button>
      </div>
      <div class="sm" id="metaIssue" style="margin-top:8px;display:none"></div>
    </div>

    <!-- 総合判定 -->
    <div class="card">
      <div class="h">総合判定</div>
      <div class="row" style="margin-top:8px">
        <div class="bar" style="flex:1"><i id="barOverall"></i></div>
        <div id="scoreOverall" class="mono nowrap">0 / 100</div>
      </div>
      <div class="sm" id="scoreCaption">直近25件の平均を表示</div>
    </div>

    <!-- 自己診断 -->
    <div class="card">
      <div class="h">自己診断（入口/実行/出口）</div>
      <div class="grid g2" style="margin-top:8px">
        <div>
          <div class="s">入口</div>
          <div class="bar"><i id="barEntry"></i></div>
          <div class="xs mono" id="valEntry">0</div>
        </div>
        <div>
          <div class="s">実行</div>
          <div class="bar"><i id="barRun"></i></div>
          <div class="xs mono" id="valRun">0</div>
        </div>
        <div>
          <div class="s">出口</div>
          <div class="bar"><i id="barExit"></i></div>
          <div class="xs mono" id="valExit">0</div>
        </div>
        <div>
          <div class="s">実行中エラー率</div>
          <div class="bar"><i id="barErr"></i></div>
          <div class="xs mono" id="valErr">0%</div>
        </div>
      </div>
    </div>

    <!-- セクション内訳 -->
    <div class="card" style="grid-column:1/-1">
      <div class="h">セクション内訳（%）</div>
      <div class="grid g3" id="sectionRows" style="margin-top:8px"></div>
    </div>

    <!-- 最新イベント25件 -->
    <div class="card" style="grid-column:1/-1">
      <div class="h">最新イベント（25）</div>
      <div class="list" id="events"></div>
    </div>
  </div>

  <script>
    // ISSUE_ID: das202511012231
    const Q = (s)=>document.querySelector(s);
    const ep = Q('#ep');
    const testIcon = Q('#testIcon');
    const bar = (el, v)=>{ el.style.width = Math.max(0, Math.min(100, v)).toFixed(1)+'%'; };

    const sections = [
      ["ルーティング互換", 2],
      ["CORS/Origin厳格化", 3],
      ["FieldMask/Places整合", 2],
      ["Secrets参照", 2],
      ["エラー整形/返却差分", 2],
      ["速度劣化(監査フック)", 1]
    ];

    function paintSections(){
      const box = Q('#sectionRows'); box.innerHTML='';
      sections.forEach(([name, pct])=>{
        const d=document.createElement('div');
        d.innerHTML = `
          <div class="card" style="padding:10px">
            <div class="s ellipsis" title="${name}">${name}</div>
            <div class="bar" style="margin-top:6px"><i style="width:${pct}%"></i></div>
            <div class="xs mono">${pct}%</div>
          </div>`;
        box.appendChild(d.firstElementChild);
      });
    }

    async function getJSON(u) {
      const r = await fetch(u, { cache:'no-store' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    async function loadSummary() {
      const base = ep.value.trim();
      const S = await getJSON(base + "/audit/summary");

      // 総合（直近25の平均）
      const overall = Number(S.avgScore||0);
      bar(Q('#barOverall'), overall);
      Q('#scoreOverall').textContent = `${overall.toFixed(1)} / 100`;

      // 入口/実行/出口（直近3相を推定表示：runs末尾→出口、その前→実行、その前→入口）
      // MEM.runs は Worker 側で phase を保持しているため、利用側は簡易描画
      // summaryには生配列は返していないため、便宜上 overall を各段に反映（仕様簡略）
      bar(Q('#barEntry'), overall);
      bar(Q('#barRun'), overall);
      bar(Q('#barExit'), overall);
      Q('#valEntry').textContent = overall.toFixed(1);
      Q('#valRun').textContent = overall.toFixed(1);
      Q('#valExit').textContent = overall.toFixed(1);

      // 実行中エラー率（直近ラン）
      const err = Number(S.recentErrorRate||0);
      bar(Q('#barErr'), err);
      Q('#valErr').textContent = err.toFixed(1)+'%';

      // ISSUEは非表示（仕様）
      Q('#metaIssue').style.display = 'none';

      // 最新イベント
      const evBox = Q('#events'); evBox.innerHTML='';
      const list = Array.isArray(S.latestEvents) ? S.latestEvents : [];
      if (!list.length) {
        const d = document.createElement('div');
        d.className='li'; d.innerHTML = `<div class="xs">イベントなし</div>`;
        evBox.appendChild(d);
      } else {
        list.forEach(e=>{
          const d = document.createElement('div');
          d.className='li';
          const dt = new Date(e.ts).toLocaleString('ja-JP');
          d.innerHTML = `
            <div class="xs mono nowrap">${dt}</div>
            <div class="xs tag nowrap">[${e.type}]</div>
            <div class="fit ellipsis xs" title="${e.message||''}">${e.message||''}</div>
          `;
          evBox.appendChild(d);
        });
      }
    }

    async function testConn() {
      const base = ep.value.trim();
      testIcon.textContent = '検査中…';
      try {
        const j = await getJSON(base + "/healthz");
        if (j && j.ok) {
          testIcon.textContent = '✅ 接続OK';
          testIcon.classList.add('ok');
          testIcon.classList.remove('bad');
        } else {
          testIcon.textContent = '❌ 異常';
          testIcon.classList.add('bad');
          testIcon.classList.remove('ok');
        }
      } catch {
        testIcon.textContent = '❌ 接続失敗';
        testIcon.classList.add('bad');
        testIcon.classList.remove('ok');
      }
    }

    Q('#btnTest').addEventListener('click', testConn);
    Q('#btnRefresh').addEventListener('click', loadSummary);

    paintSections();
    testConn().then(loadSummary);
    // 30秒毎に再取得（UIの遅延・反映ズレ対策）
    setInterval(loadSummary, 30000);
  </script>
</body>
</html>