<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ISSUE: das202511012305 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="x-issue" content="das202511012305" />
  <title>WalkNav 監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#121a2a; --panel-2:#0f1726;
      --text:#eaf2ff; --muted:#a7b8ce; --ok:#27d07a; --danger:#ff6b6b;
      --accent:#64d2ff; --chip:#24324a; --stroke:#23314a;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    h1{font-size:clamp(20px,3.6vw,36px);margin:0 0 12px 0;letter-spacing:.02em}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--stroke);border-radius:18px;padding:16px;margin:14px 0;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .row{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
    .input{width:100%;padding:14px 16px;border-radius:12px;border:1px solid var(--stroke);background:#0d1524;color:var(--text);outline:none}
    .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--stroke);background:#0d1524;color:var(--text);cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .okchip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#0d1f18;border:1px solid #1f3b2f;color:#7ff2b0;font-size:14px}
    .ngchip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:#261416;border:1px solid #4a2329;color:#ff9fa7;font-size:14px}
    .sub{color:var(--muted);font-size:14px}
    .sel{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:#0d1524;color:var(--text)}
    .kpi{display:flex;flex-direction:column;gap:8px;align-items:flex-start}
    .kpi .big{font-size:68px;line-height:1;font-weight:800;letter-spacing:.02em}
    .bar{position:relative;width:100%;height:10px;background:#0c1627;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .bar i{display:block;height:100%;width:0;transition:width .4s ease;background:linear-gradient(90deg,#28d07a,#4be0ff)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .meter{display:flex;align-items:center;gap:10px}
    .meter .dot{width:10px;height:10px;border-radius:999px;background:#2d3a53}
    .meter .val{min-width:34px;text-align:right}
    .sec{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--stroke);background:#0e1727;border-radius:14px;padding:14px;margin-top:12px}
    .badge{padding:6px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--stroke);font-size:13px}
    .badge.warn{background:#2a1e12;border-color:#4b2f17;color:#ffc088}
    .sheet{position:relative;border:1px solid var(--stroke);background:#0d1523;border-radius:14px;padding:10px;margin-top:12px;max-height:calc(100vh - 160px);overflow:auto}
    .item{border-bottom:1px dashed #22324a;padding:10px 6px}
    .item:last-child{border-bottom:none}
    .item h4{margin:0 0 6px 0;font-size:15px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;color:#cfe3ff;word-break:break-all;white-space:pre-wrap}
    .foot{display:flex;justify-content:flex-end;color:var(--muted);font-size:12px;margin-top:8px}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WalkNav 監査ダッシュボード</h1>

    <!-- 接続先 -->
    <div class="card">
      <div class="row" style="gap:8px">
        <input id="ep" class="input" placeholder="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
        <button id="ping" class="btn">接続テスト</button>
        <div id="pingChip" class="hide"></div>
      </div>
      <div class="row" style="margin-top:10px">
        <select id="issueSel" class="sel"></select>
        <button id="reload" class="btn">再取得</button>
      </div>
      <div class="sub" style="margin-top:8px">/healthz から issue を自動取得し、/audit/issues が無い場合はイベント履歴から推定します。</div>
    </div>

    <!-- 総合判定 & 直近エラー率 -->
    <div class="grid2">
      <div class="card kpi">
        <div class="sub">総合判定（平均スコア）</div>
        <div id="avg" class="big">0</div>
        <div class="bar"><i id="avgBar"></i></div>
        <div class="sub" id="aggMeta">集計対象 RUN: 0 / EVENTS: 0</div>
      </div>
      <div class="card kpi">
        <div class="sub">直近 エラー率</div>
        <div id="err" class="big">0%</div>
        <div class="bar"><i id="errBar"></i></div>
        <div class="sub">直近 RUN 記録の失敗割合。</div>
      </div>
    </div>

    <!-- 自己診断（入口/実行/出口） -->
    <div class="card">
      <div class="sub" style="margin-bottom:8px">自己診断</div>

      <div class="meter">
        <span class="badge">入口（entry）</span>
        <div class="bar" style="flex:1"><i id="mEntry"></i></div>
        <span class="val" id="vEntry">0</span>
      </div>
      <div class="meter" style="margin-top:10px">
        <span class="badge">実行中（run）</span>
        <div class="bar" style="flex:1"><i id="mRun"></i></div>
        <span class="val" id="vRun">0</span>
      </div>
      <div class="meter" style="margin-top:10px">
        <span class="badge">出口（exit）</span>
        <div class="bar" style="flex:1"><i id="mExit"></i></div>
        <span class="val" id="vExit">0</span>
      </div>

      <div class="sec" style="margin-top:14px">
        <div class="sub">進行状況</div>
        <div class="badge" id="phase">-</div>
      </div>
      <div class="sub" style="margin-top:8px">※ 手動投稿 UI は撤去。WalkNav 本体または自動化から /audit/run を送信します。</div>
    </div>

    <!-- セクション内訳（リスク比率） -->
    <div class="card">
      <div class="sub">セクション内訳（リスク比率）</div>
      <div id="risks"></div>
    </div>

    <!-- 最新イベント -->
    <div class="card">
      <div class="sub">最新イベント（最大25件）</div>
      <div id="events" class="sheet"></div>
      <div class="foot">© WalkNav Dashboard ・ 発行番号 <span id="footIssue">-</span></div>
    </div>
  </div>

  <script>
  // ====== ISSUE ======
  const DASHBOARD_ISSUE = "das202511012305";

  // ====== State ======
  const S = {
    ep: localStorage.getItem("audit_ep") || "https://ors-proxy-dev.miyata-connect-jp.workers.dev",
    issue: "",
    issues: [],
    summary: null
  };

  // ====== DOM ======
  const $ = (q)=>document.querySelector(q);
  const epEl = $("#ep");
  const pingBtn = $("#ping");
  const pingChip = $("#pingChip");
  const issueSel = $("#issueSel");
  const reloadBtn = $("#reload");

  const avgEl = $("#avg"); const avgBar = $("#avgBar");
  const errEl = $("#err"); const errBar = $("#errBar");
  const aggMeta = $("#aggMeta");
  const vEntry = $("#vEntry"), vRun = $("#vRun"), vExit = $("#vExit");
  const mEntry = $("#mEntry"), mRun = $("#mRun"), mExit = $("#mExit");
  const phaseEl = $("#phase");
  const risksEl = $("#risks");
  const eventsEl = $("#events");
  const footIssue = $("#footIssue");

  // ====== Utils ======
  const toJST = (ts)=>{
    try{ return new Date(ts).toLocaleString("ja-JP",{timeZone:"Asia/Tokyo"}); }
    catch{ return String(ts); }
  };
  const pct = (v)=>Math.max(0,Math.min(100,Math.round(Number(v)||0)));
  const setBar = (el,val)=>{ el.style.width = pct(val) + "%"; };
  const trim300 = (s)=>{
    const t = String(s||"");
    return t.length>300 ? t.slice(0,300) + "…" : t;
  };
  const unique = (arr)=>Array.from(new Set(arr));

  function showChip(ok){
    pingChip.className = ok ? "okchip" : "ngchip";
    pingChip.textContent = ok ? "OK" : "NG";
  }

  function setDisabled(dis){
    pingBtn.disabled = dis; reloadBtn.disabled = dis; issueSel.disabled = dis;
  }

  // ====== Fetchers ======
  async function getJSON(url, init){
    const r = await fetch(url, init);
    if(!r.ok) throw new Error(r.status+"");
    return r.json();
  }

  async function fetchHealthIssue(){
    const j = await getJSON(`${S.ep.replace(/\/+$/,"")}/healthz`);
    return j.issue ? String(j.issue) : "";
  }

  async function fetchIssuesFallbackFromEvents(){
    try{
      const sum = await getJSON(`${S.ep.replace(/\/+$/,"")}/audit/summary`);
      const evIssues = (sum.latestEvents||[]).map(e=>e.issue).filter(Boolean);
      return unique(evIssues).slice(0,20);
    }catch{ return []; }
  }

  async function fetchIssues(){
    try{
      const j = await getJSON(`${S.ep.replace(/\/+$/,"")}/audit/issues`);
      if(Array.isArray(j) && j.length) return j.map(String);
    }catch{/* 404 expected on old worker */}
    const h = await fetchHealthIssue();
    const ev = await fetchIssuesFallbackFromEvents();
    const all = unique([h, ...ev].filter(Boolean));
    return all.length ? all : [h].filter(Boolean);
  }

  async function fetchSummary(issue){
    const url = `${S.ep.replace(/\/+$/,"")}/audit/summary` + (issue?`?issue=${encodeURIComponent(issue)}`:"");
    return await getJSON(url);
  }

  // ====== Renderers ======
  function renderBase(){
    epEl.value = S.ep;
    footIssue.textContent = S.issue || "-";
  }

  function renderIssues(){
    issueSel.innerHTML = "";
    if(!S.issues.length){
      const opt = document.createElement("option");
      opt.value=""; opt.textContent="発行番号なし";
      issueSel.appendChild(opt);
      return;
    }
    S.issues.forEach((i)=>{
      const opt = document.createElement("option");
      opt.value=i; opt.textContent=i;
      issueSel.appendChild(opt);
    });
    if(S.issue){
      issueSel.value = S.issue;
    }else{
      S.issue = S.issues[0];
      issueSel.value = S.issue;
    }
    footIssue.textContent = S.issue || "-";
  }

  function renderSummary(){
    const sum = S.summary || {avgScore:0,recentErrorRate:0,totals:{runs:0,events:0}, latestRun:{}};
    const avg = Math.round(Number(sum.avgScore)||0);
    const err = Math.round(Number(sum.recentErrorRate)||0);
    avgEl.textContent = String(avg);
    errEl.textContent = String(err)+"%";
    setBar(avgBar, avg);
    setBar(errBar, err);
    const runs = sum.totals?.runs||0; const events = sum.totals?.events||0;
    aggMeta.textContent = `集計対象 RUN: ${runs} / EVENTS: ${events}`;

    // self-check (entry/run/exit)
    const r = sum.latestRun || {};
    const e = pct(r.entry||0), rn = pct(r.run||0), ex = pct(r.exit||0);
    vEntry.textContent = e; vRun.textContent = rn; vExit.textContent = ex;
    setBar(mEntry, e); setBar(mRun, rn); setBar(mExit, ex);
    phaseEl.textContent = (r.phase||"-");

    // risks (fixed buckets)
    const buckets = [
      ["Routing (/healthz,/places:searchText,/directions)",2],
      ["CORS/Origin strict",3],
      ["FieldMask/Places New params",2],
      ["Secrets (GMAPS_API_KEY)",2],
      ["Error shape/HTTP code diff",2]
    ];
    risksEl.innerHTML = "";
    buckets.forEach(([label,score])=>{
      const div = document.createElement("div");
      div.className = "sec";
      const b = document.createElement("span"); b.className="badge"; b.textContent=label;
      const s = document.createElement("span"); s.className="badge"+(score>=3?" warn": ""); s.textContent=score+"%";
      div.appendChild(b); div.appendChild(s);
      risksEl.appendChild(div);
    });

    // events
    renderEvents(sum.latestEvents||[]);
  }

  function renderEvents(list){
    eventsEl.innerHTML = "";
    if(!list.length){
      const p = document.createElement("div");
      p.className="sub"; p.textContent="データなし";
      eventsEl.appendChild(p);
      return;
    }
    // sort desc by ts
    list.sort((a,b)=> (b.ts||0) - (a.ts||0));
    list.slice(0,25).forEach(ev=>{
      const div = document.createElement("div"); div.className="item";
      const h = document.createElement("h4");
      const t = `[${toJST(ev.ts)}] ${ev.type||"event"} · ${ev.severity||"info"}`;
      h.textContent = t;
      const body = document.createElement("div");
      const text = ev.title || ev.message || (ev.meta && (ev.meta.text || ev.meta.msg)) || JSON.stringify(ev.meta||{});
      body.className="mono";
      body.textContent = trim300(text);
      div.appendChild(h); div.appendChild(body);
      eventsEl.appendChild(div);
    });
  }

  // ====== Flow ======
  async function ping(){
    setDisabled(true);
    try{
      await fetchHealthIssue();
      showChip(true);
    }catch(e){
      showChip(false);
    }finally{
      setDisabled(false);
    }
  }

  async function reload(){
    setDisabled(true);
    try{
      S.issues = await fetchIssues();
      renderIssues();
      S.summary = await fetchSummary(S.issue);
      renderSummary();
    }catch(e){
      console.error(e);
      alert("取得に失敗しました。接続先を確認してください。");
    }finally{
      setDisabled(false);
    }
  }

  // ====== Bind ======
  epEl.addEventListener("change", ()=>{
    S.ep = epEl.value.trim();
    localStorage.setItem("audit_ep", S.ep);
  });
  pingBtn.addEventListener("click", ping);
  reloadBtn.addEventListener("click", reload);
  issueSel.addEventListener("change", async (e)=>{
    S.issue = String(e.target.value||"");
    footIssue.textContent = S.issue || "-";
    try{
      S.summary = await fetchSummary(S.issue);
      renderSummary();
    }catch(err){ console.error(err); }
  });

  // ====== Boot ======
  (async function boot(){
    renderBase();
    await ping();
    await reload();
  })();
  </script>
</body>
</html>