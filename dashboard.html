<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WalkNav 管理ダッシュボード</title>
  <!-- 発行番号 -->
  <meta name="x-issue" content="das202510310725">
  <style>
    :root{
      --bg:#0b1220;--panel:#131c2b;--ink:#eaf2ff;--muted:#a7b8ce;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--stroke:#1f2a3d;--accent:#5fb1ff;
    }
    *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,"Noto Sans JP",sans-serif}
    .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    .row{display:grid;gap:16px}
    @media(min-width:720px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}}
    .title{font-size:28px;font-weight:800;margin:0 0 8px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:12px}
    .input{width:100%;background:#0f1726;border:1px solid var(--stroke);color:var(--ink);border-radius:12px;padding:12px 14px;font-size:14px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;background:#1a2840;border:1px solid var(--stroke);color:var(--ink);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{background:#1e3151}
    .btn.primary{background:var(--accent);border-color:transparent;color:#06101f;font-weight:700}
    .btn.ghost{background:transparent}
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--stroke);background:#0e1a2e;color:var(--muted);font-size:12px}
    .stat{background:#0f1726;border:1px solid var(--stroke);border-radius:14px;padding:14px}
    .stat .label{color:var(--muted);font-size:12px}
    .stat .val{font-size:28px;font-weight:800;margin-top:6px}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .bar{height:12px;background:#0d1526;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--ok),#10b981 40%,#f59e0b 60%,#ef4444)}
    .hint{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:collapse;border:1px solid var(--stroke);border-radius:12px;overflow:hidden}
    .table th,.table td{border-bottom:1px solid var(--stroke);padding:10px 12px;font-size:13px}
    .table th{background:#0f1726;color:var(--muted);text-align:left}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--stroke)}
    .pill.ok{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:var(--ok)}
    .pill.warn{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:var(--warn)}
    .pill.bad{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:var(--bad)}
    .footer{margin:24px 0 40px;color:var(--muted);font-size:12px;text-align:center}
    .status{margin-top:8px;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" style="margin-bottom:16px">
      <div class="title">WalkNav 管理ダッシュボード</div>
      <div class="sub">自己診断（入り口／実行中／出口）・監視・採点の可視化。発行番号: <span id="ISSUE_ID" class="badge">das202510310725</span></div>

      <div class="row cols-2" style="margin-top:12px">
        <div>
          <div class="hint" style="margin:6px 2px">Worker 基本URL（例: https://ors-proxy-dev.miyata-connect-jp.workers.dev）</div>
          <input id="baseUrl" class="input" placeholder="https://xxxxx.workers.dev">
        </div>
        <div>
          <div class="hint" style="margin:6px 2px">管理トークン（ADMIN_TOKEN／任意）</div>
          <input id="adminToken" class="input" placeholder="未設定なら空のまま">
        </div>
      </div>

      <div style="display:flex;gap:10px;margin-top:12px">
        <button id="saveBtn" class="btn">保存</button>
        <button id="fetchBtn" class="btn primary">最新を取得</button>
        <span id="inlineStatus" class="status"></span>
      </div>
    </div>

    <!-- 指標：入り口／実行中／出口 -->
    <div class="row cols-3" style="margin-bottom:16px">
      <div class="card stat">
        <div class="label">入り口自己診断スコア</div>
        <div class="val" id="scoreStart">0</div>
        <div class="hint">テンプレ遵守・差分禁止・鍵直書き検出などの事前チェック結果</div>
      </div>
      <div class="card stat">
        <div class="label">実行中：問題発生率（%）</div>
        <div class="val" id="errRate">0%</div>
        <div class="bar" style="margin-top:8px"><i id="errBar"></i></div>
        <div class="hint">進行中に検出された違反・例外・API失敗の割合</div>
      </div>
      <div class="card stat">
        <div class="label">出口自己診断スコア</div>
        <div class="val" id="scoreEnd">0</div>
        <div class="hint">要件充足・UI不変・テスト合格・日本語表記などの総合評価</div>
      </div>
    </div>

    <!-- 進行状況と採点推移 -->
    <div class="row cols-2" style="margin-bottom:16px">
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div class="badge">進行状況</div><span id="phaseText" class="hint">停止中</span>
        </div>
        <div class="bar"><i id="progressBar"></i></div>
        <div class="hint" style="margin-top:8px">フェーズ進捗（0→100）と内部イベントに連動</div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
          <div class="badge">採点推移（最新10件）</div><span id="trendNote" class="hint">データなし</span>
        </div>
        <table class="table" id="trendTable">
          <thead><tr><th>時刻</th><th>開始</th><th>終了</th><th>問題率</th><th>判定</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 最近のイベント -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
        <div class="badge">最新イベント</div><span class="hint">重大のみを表示（UI上のポップアップは行いません）</span>
      </div>
      <table class="table" id="evtTable">
        <thead><tr><th>時刻</th><th>種別</th><th>概要</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="footer">
      © WalkNav Dashboard • 発行番号 <span class="badge">das202510310725</span>
    </div>
  </div>

  <script>
  // ====== 設定と状態 ======
  const ISSUE_ID = "das202510310725"; // 画面右上やmetaと一致
  const els = {
    baseUrl: document.getElementById('baseUrl'),
    adminToken: document.getElementById('adminToken'),
    saveBtn: document.getElementById('saveBtn'),
    fetchBtn: document.getElementById('fetchBtn'),
    inlineStatus: document.getElementById('inlineStatus'),
    scoreStart: document.getElementById('scoreStart'),
    scoreEnd: document.getElementById('scoreEnd'),
    errRate: document.getElementById('errRate'),
    errBar: document.getElementById('errBar'),
    progressBar: document.getElementById('progressBar'),
    phaseText: document.getElementById('phaseText'),
    trendTable: document.querySelector('#trendTable tbody'),
    trendNote: document.getElementById('trendNote'),
    evtTable: document.querySelector('#evtTable tbody')
  };

  // 保存/復元
  (function restore(){
    const s = JSON.parse(localStorage.getItem('wn_dash')||'{}');
    if(s.baseUrl) els.baseUrl.value = s.baseUrl;
    if(s.adminToken) els.adminToken.value = s.adminToken;
  })();

  els.saveBtn.onclick = () => {
    localStorage.setItem('wn_dash', JSON.stringify({
      baseUrl: els.baseUrl.value.trim(),
      adminToken: els.adminToken.value.trim()
    }));
    statusMsg('保存しました。');
  };

  // ====== データ取得 ======
  els.fetchBtn.onclick = async () => {
    const base = (els.baseUrl.value||'').trim().replace(/\/+$/,'');
    if(!base){ return statusMsg('Worker 基本URLを入力してください。'); }
    statusMsg('取得中…');

    // /admin/report 仕様（例）
    // { issue:"idx2025...", start_score:80, end_score:86, err_rate:12,
    //   phase:{label:"実行中", progress:65},
    //   trend:[{ts: "...", start:80, end:86, err:12}],
    //   events:[{ts:"...", level:"warn|bad|ok", message:"..."}] }
    const headers = {};
    const token = els.adminToken.value.trim();
    if(token) headers['Authorization'] = 'Bearer ' + token;

    let res, data;
    try{
      res = await fetch(base + '/admin/report', {headers});
      if(res.status === 404){
        // Worker が未実装でも画面は壊さない（無言でデータなし）
        applyReport(null);
        return statusMsg('レポートAPIが見つかりません（404）。画面は継続します。');
      }
      if(!res.ok){
        applyReport(null);
        return statusMsg('取得失敗: ' + res.status);
      }
      data = await res.json();
    }catch(e){
      applyReport(null);
      return statusMsg('通信エラー。');
    }
    applyReport(data);
    statusMsg('更新しました。');
  };

  function statusMsg(t){ els.inlineStatus.textContent = t; }

  // ====== 画面反映 ======
  function applyReport(r){
    // デフォルト（データなし）
    let start=0,end=0,err=0,phaseLabel='停止中',progress=0,trend=[],events=[];
    if(r){
      start = clamp(num(r.start_score),0,100);
      end   = clamp(num(r.end_score),0,100);
      err   = clamp(num(r.err_rate),0,100);
      if(r.phase){ phaseLabel = String(r.phase.label||''); progress = clamp(num(r.phase.progress),0,100); }
      if(Array.isArray(r.trend)) trend = r.trend.slice(0,10);
      if(Array.isArray(r.events)) events = r.events.slice(0,50);
    }

    els.scoreStart.textContent = start.toFixed(0);
    els.scoreEnd.textContent = end.toFixed(0);
    els.errRate.textContent = err.toFixed(0) + '%';
    els.errBar.style.width = err + '%';

    els.phaseText.textContent = phaseLabel || '停止中';
    els.progressBar.style.width = progress + '%';

    // 採点推移
    els.trendTable.innerHTML = '';
    if(trend.length===0){ els.trendNote.textContent='データなし'; }
    else{
      els.trendNote.textContent = '';
      for(const t of trend){
        const tr = document.createElement('tr');
        const ts = fmtTime(t.ts);
        tr.innerHTML =
          `<td>${esc(ts)}</td>
           <td>${esc(nz(t.start))}</td>
           <td>${esc(nz(t.end))}</td>
           <td>${esc(nz(t.err))}%</td>
           <td>${pillFrom(nz(t.err))}</td>`;
        els.trendTable.appendChild(tr);
      }
    }

    // イベント
    els.evtTable.innerHTML='';
    for(const e of events){
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td>${esc(fmtTime(e.ts))}</td>
         <td>${levelPill(e.level)}</td>
         <td>${esc(String(e.message||''))}</td>`;
      els.evtTable.appendChild(tr);
    }
  }

  function pillFrom(err){
    const lvl = err<10?'ok':(err<30?'warn':'bad');
    const txt = err<10?'良好':(err<30?'注意':'要改善');
    return `<span class="pill ${lvl}">${txt}</span>`;
  }
  function levelPill(level){
    const map={ok:'ok',warn:'warn',bad:'bad'};
    const nm = {ok:'情報',warn:'警告',bad:'重大'}[level]||'情報';
    const cl = map[level]||'ok';
    return `<span class="pill ${cl}">${nm}</span>`;
  }
  function esc(s){ return String(s).replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  function fmtTime(ts){ try{ return new Date(ts||Date.now()).toLocaleString(); }catch{ return '-'; } }
  function num(v){ const n = Number(v); return isNaN(n)?0:n; }
  function nz(v){ return (v==null||v==='')?0:v; }
  function clamp(n,min,max){ return Math.max(min,Math.min(max,n)); }

  // 初期描画（保存値で）
  applyReport(null);
  </script>
</body>
</html>