<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ISSUE: das202511012305 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="x-issue" content="das202511012305">
  <title>WalkNav 監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0b1220;--text:#e8f1ff;--muted:#9fb1c9;
      --card:#121a2b;--stroke:rgba(255,255,255,.14);
      --ok:#2ad38a;--warn:#ffbb55;--bad:#ff6b6b;--pri:#66aaff;
      --shadow:0 10px 30px rgba(0,0,0,.35);--r:20px
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 12px;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:.02em;white-space:nowrap}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .label{color:var(--muted);font-size:13px;white-space:nowrap}
    .hint{color:var(--muted);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);
      border-radius:999px;padding:6px 10px;background:#0e1728;font-size:12px}
    .ok{color:var(--ok)}.bad{color:var(--bad)}.warn{color:var(--warn)}
    input[type=text],select{flex:1 1 420px;min-width:240px;max-width:100%;
      background:#0f1726;color:var(--text);border:1px solid var(--stroke);
      border-radius:14px;padding:12px 14px;outline:none;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn{appearance:none;border:1px solid var(--stroke);background:#18243a;color:#dbe8ff;
      border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;white-space:nowrap}
    .btn.primary{background:var(--pri);color:#071120;border-color:transparent}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .scoreBox{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:12px}
    .num{font-size:56px;font-weight:900;letter-spacing:.02em;line-height:1}
    .bar{height:8px;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;background:#0d1626;margin-top:10px}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--bad),var(--warn),var(--ok))}
    /* セクション内訳のタイル */
    .tile{display:flex;align-items:center;gap:10px;justify-content:space-between;
      background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .pill{min-width:48px;text-align:center;border-radius:999px;border:1px solid var(--stroke);padding:6px 10px}
    /* イベントテーブル */
    .tr{display:grid;grid-template-columns:160px 90px 1fr;gap:10px;
      background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .tr:hover{outline:1px solid var(--pri)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    /* スライドパネル（下から） */
    .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--stroke);
      border-radius:16px 16px 0 0;transform:translateY(110%);transition:transform .28s ease;
      max-height:82vh;overflow:auto;box-shadow:0 -10px 30px rgba(0,0,0,.45);padding:16px}
    .sheet.show{transform:translateY(0)}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WalkNav 監査ダッシュボード</h1>

    <!-- 接続先/発行番号 -->
    <div class="card">
      <div class="row">
        <span class="label">接続先（Worker エンドポイント）</span>
        <input id="ep" type="text" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev">
        <button class="btn" id="btnPing">接続テスト</button>
        <span id="pingChip" class="chip">-</span>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="label">発行番号（自動取得／手動切替）</span>
        <select id="issueSel" title="発行番号"></select>
        <button class="btn" id="btnReload">再取得</button>
        <span class="hint">/healthz の issue を自動取得します。</span>
      </div>
    </div>

    <!-- 総合判定・直近エラー率 -->
    <div class="grid grid2" style="margin-top:12px">
      <div class="scoreBox">
        <div class="label">総合判定（平均スコア）</div>
        <div id="overallNum" class="num">0</div>
        <div class="bar"><i id="overallBar"></i></div>
        <div id="overallHint" class="hint">ログ由来の平均値（0〜100）。</div>
      </div>
      <div class="scoreBox">
        <div class="label">直近 エラー率</div>
        <div id="errNum" class="num">0%</div>
        <div class="bar"><i id="errBar"></i></div>
        <div class="hint">直近 RUN 記録の失敗割合。</div>
      </div>
    </div>

    <!-- 自己診断（バー＋数値） -->
    <div class="card" style="margin-top:12px">
      <div class="label">自己診断</div>
      <div class="grid grid2" style="margin-top:10px">
        <div class="scoreBox">
          <div class="label">入口（entry）</div>
          <div id="entryNum" class="num">-</div>
          <div class="bar"><i id="entryBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">実行中（run）</div>
          <div id="runNum" class="num">-</div>
          <div class="bar"><i id="runBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">出口（exit）</div>
          <div id="exitNum" class="num">-</div>
          <div class="bar"><i id="exitBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">進行状況</div>
          <div id="phaseChip" class="chip">-</div>
          <div class="hint">手動投稿 UI は撤去。WalkNav 本体から自動送信。</div>
        </div>
      </div>
    </div>

    <!-- セクション内訳（はみ出し抑止） -->
    <div class="card" style="margin-top:12px">
      <div class="label">セクション内訳（リスク比率）</div>
      <div id="riskGrid" class="grid" style="margin-top:10px"></div>
    </div>

    <!-- 最新イベント -->
    <div class="card" style="margin-top:12px">
      <div class="row">
        <span class="label">最新イベント（25）</span>
        <span class="hint" id="evtHint"></span>
        <button class="btn right" id="btnEvt">イベント再取得</button>
      </div>
      <div id="eventList" class="grid" style="margin-top:10px"></div>
    </div>

    <div class="sheet" id="sheet">
      <div class="row">
        <strong>イベント詳細</strong>
        <button class="btn right" id="closeSheet">閉じる</button>
      </div>
      <pre id="sheetBody" class="mono" style="white-space:pre-wrap"></pre>
    </div>

    <div class="hint" style="text-align:center;margin:16px 0">© WalkNav Dashboard • ISSUE_ID: das202511012305</div>
  </div>

  <script>
    // ===== State =====
    const S = {
      endpoint: document.getElementById('ep').value.trim().replace(/\/+$/,''),
      issue: null,
      timer: null,
      risks: [
        ["Routing (/healthz,/places:searchText,/directions)",2],
        ["CORS/Origin strict",3],
        ["FieldMask/Places New params",2],
        ["Secrets (GMAPS_API_KEY)",2],
        ["Error shape/HTTP code diff",2],
        ["Overhead (audit hooks)",1]
      ]
    };

    // ===== Helpers =====
    const $ = q=>document.querySelector(q);
    const el = (t,p={},c=[])=>{const n=document.createElement(t);Object.assign(n,p);c.forEach(x=>n.append(x));return n;};
    const clampPct = v => Math.max(0, Math.min(100, (v==null?0:Math.round(v))));
    const setNum = (id,v,suf='') => { const n=$('#'+id); n.textContent=(v==null?'-':clampPct(v))+suf; };
    const setBar = (id,v) => { $('#'+id).style.width=clampPct(v)+'%'; };

    async function jget(url, init){
      const r = await fetch(url, init);
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // ===== Endpoint & Issue =====
    async function ping(){
      const chip = $('#pingChip'); chip.textContent='...'; chip.className='chip';
      try{
        const j = await jget(S.endpoint+'/healthz');
        S.issue = j.issue || 'unknown';
        setIssueSel([S.issue]);
        chip.textContent='OK'; chip.classList.add('ok');
      }catch(e){
        chip.textContent='NG'; chip.classList.add('bad');
      }
    }
    function setIssueSel(list){
      const sel = $('#issueSel'); sel.innerHTML='';
      list.forEach(x=> sel.append(el('option',{value:x, textContent:x})));
      sel.value = list[0]||'unknown';
    }

    // ===== Summary / Events =====
    async function loadSummary(){
      try{
        const j = await jget(S.endpoint+'/audit/summary');
        // 総合・エラー率
        const avg = clampPct(j.avgScore||0);
        setNum('overallNum', avg);
        setBar('overallBar', avg);
        $('#overallHint').textContent = `集計対象 RUN: ${j.totals?.runs||0} / EVENTS: ${j.totals?.events||0}`;
        const err = clampPct(j.recentErrorRate||0);
        setNum('errNum', err, '%'); setBar('errBar', err);

        // 自己診断（バー＋数値）
        const en = j.entryScore; const rn = j.runScore; const ex = j.exitScore;
        setNum('entryNum', en); setBar('entryBar', en);
        setNum('runNum', rn);   setBar('runBar', rn);
        setNum('exitNum', ex);  setBar('exitBar', ex);
        $('#phaseChip').textContent = j.phase || '-';

        // リスク（静的）
        const g = $('#riskGrid'); g.innerHTML='';
        S.risks.forEach(([name,r])=>{
          const pill = el('span',{className:'pill '+(r>=4?'bad':r>=3?'warn':'ok'),textContent:r+'%'});
          g.append(el('div',{className:'tile'},[el('span',{textContent:name,className:'label',style:'overflow:hidden;text-overflow:ellipsis;white-space:nowrap'}), pill]));
        });

        // イベント
        renderEvents(j.latestEvents||[]);
      }catch(e){
        // 失敗時は値を落として明示
        ['overallBar','errBar','entryBar','runBar','exitBar'].forEach(id=>setBar(id,0));
        ['overallNum','errNum','entryNum','runNum','exitNum'].forEach(id=>$('#'+id).textContent=id==='errNum'?'0%':'0');
        renderEvents([]);
      }
    }

    async function reloadEvents(){
      // summary に含まれない場合の保険：/audit/summary を再取得
      try{
        const j = await jget(S.endpoint+'/audit/summary');
        renderEvents(j.latestEvents||[]);
      }catch(_e){ renderEvents([]); }
    }

    function renderEvents(list){
      const box = $('#eventList'); box.innerHTML='';
      $('#evtHint').textContent = `受信: ${list.length} 件`;
      if(!list.length){ box.append(el('div',{className:'hint',textContent:'データなし'})); return; }
      list.slice(0,25).forEach(e=>{
        const t = new Date(e.ts||Date.now()).toLocaleString();
        const row = el('div',{className:'tr'});
        row.append(el('div',{textContent:t,className:'small'}));
        row.append(el('div',{textContent:e.kind||'event',className:'chip'}));
        const msg = (e.message||e.summary||JSON.stringify(e.meta||{},null,0)||'').toString().slice(0,180);
        row.append(el('div',{textContent:msg,style:'overflow:hidden;text-overflow:ellipsis'}));
        row.addEventListener('click',()=>openSheet(e));
        box.append(row);
      });
    }

    // ===== Sheet =====
    function openSheet(e){
      $('#sheetBody').textContent = JSON.stringify(e,null,2);
      $('#sheet').classList.add('show');
    }
    $('#closeSheet').onclick = ()=> $('#sheet').classList.remove('show');

    // ===== Wiring =====
    $('#btnPing').onclick = ()=>{ S.endpoint=$('#ep').value.trim().replace(/\/+$/,''); ping(); };
    $('#btnReload').onclick = loadSummary;
    $('#btnEvt').onclick = reloadEvents;
    $('#ep').addEventListener('change',()=>{ S.endpoint=$('#ep').value.trim().replace(/\/+$/,''); });

    // 初期化（ISSUE バッジは存在しない＝非表示対応済み）
    (async function init(){ await ping(); await loadSummary(); S.timer=setInterval(loadSummary,15000); })();
  </script>
</body>
</html>