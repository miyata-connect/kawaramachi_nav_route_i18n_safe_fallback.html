<!-- dashboard.html  ISSUE: das202511011930 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>監査ダッシュボード</title>
  <meta name="x-issue" content="das202511011930" />
  <style>
    :root{
      --bg:#0b1220; --panel:#101a2e; --glass:rgba(16,26,46,.85);
      --stroke:rgba(255,255,255,.12); --text:#eaf2ff; --muted:#a7b8ce;
      --accent:#5fb1ff; --ok:#2ad07a; --warn:#ffb020; --bad:#ff6565;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:1100px;margin:16px auto;padding:0 12px}
    .grid{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{
      background:var(--glass);border:1px solid var(--stroke);border-radius:16px;padding:14px 16px;
      backdrop-filter: blur(6px);
    }
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row.nowrap{flex-wrap:nowrap}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    input,button{
      height:36px;border-radius:10px;border:1px solid var(--stroke);background:#0f1830;color:var(--text);
      padding:0 10px
    }
    input[readonly]{opacity:.8}
    button{cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:#00101c}
    button.ghost{background:transparent}
    h1{font-size:18px;margin:4px 0 8px}
    h2{font-size:14px;margin:0 0 8px}
    .scoreBox{display:flex;align-items:center;gap:12px}
    .scoreNum{font-size:36px;font-weight:700;min-width:88px;text-align:center}
    .bar{flex:1;height:14px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden}
    .bar>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--ok),#32b3ff)}
    .list{display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto}
    .item{border:1px solid var(--stroke);border-radius:12px;padding:10px;background:#0e172b}
    .kv{display:grid;grid-template-columns:120px 1fr;gap:6px}
    .pill{padding:4px 8px;border-radius:999px;background:#0a1426;border:1px solid var(--stroke);font-size:12px}
    .risk{display:grid;gap:8px}
    .risk .r{display:grid;grid-template-columns:1fr 60px;gap:8px;align-items:center}
    .risk .meter{height:10px;background:#0a1426;border:1px solid var(--stroke);border-radius:8px;overflow:hidden}
    .risk .meter>i{display:block;height:100%;width:0%}
    .ok i{background:var(--ok)}
    .mid i{background:var(--warn)}
    .bad i{background:var(--bad)}
    .tight *{font-size:12px;line-height:1.2}
    .foot{margin-top:8px;text-align:right;color:var(--muted);font-size:11px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ヘッダ -->
    <div class="card">
      <div class="row nowrap" style="gap:10px;">
        <div class="small">接続先</div>
        <input id="endpoint" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev" class="nowrap" style="min-width:320px;flex:1" readonly />
        <!-- 接続テストボタンは仕様により廃止 -->
        <button id="btn-refresh" class="primary">再取得</button>
        <span id="conn-mark" class="pill">未検証</span>
      </div>
    </div>

    <!-- 総合判定 -->
    <div class="card">
      <h1>総合判定（100点満点・厳格）</h1>
      <div class="scoreBox">
        <div id="score" class="scoreNum">0</div>
        <div class="bar"><i id="score-bar"></i></div>
      </div>
      <div class="small muted" id="score-note">条件未充足：イベント0件 / recentErrorRate≠0 / avgScore&lt;90 のいずれか</div>
    </div>

    <div class="grid">
      <!-- 自己診断 -->
      <div class="card tight">
        <h2>自己診断（入口 / 実行中 / 出口）</h2>
        <div class="kv">
          <div>入口</div><div id="diag-entry" class="pill">--</div>
          <div>実行中エラー率</div><div id="diag-run" class="pill">--</div>
          <div>出口</div><div id="diag-exit" class="pill">--</div>
        </div>
      </div>

      <!-- セクション内訳 -->
      <div class="card tight">
        <h2>セクション内訳（主要コンポーネント別）</h2>
        <div class="risk" id="risk">
          <!-- 動的生成 -->
        </div>
      </div>
    </div>

    <!-- 最新イベント -->
    <div class="card">
      <h2>最新イベント（25件）</h2>
      <div class="list" id="events"></div>
    </div>

    <!-- 接続情報（表示のみ） -->
    <div class="card tight">
      <h2>接続情報</h2>
      <div class="kv">
        <div>発行番号</div><div id="issue" class="pill">（非表示仕様）</div>
        <div>平均スコア</div><div id="avgScore" class="pill">--</div>
        <div>直近エラー率</div><div id="recentErr" class="pill">--</div>
        <div>ラン数</div><div id="runs" class="pill">--</div>
        <div>イベント数</div><div id="evs" class="pill">--</div>
      </div>
      <div class="foot">© WalkNav / Dashboard ISSUE: das202511011930</div>
    </div>
  </div>

  <script>
  const ISSUE_ID = "das202511011930";
  const el = (id)=>document.getElementById(id);

  // 厳格採点：条件満たせば100、それ以外0
  function strictScore(summary, events){
    const hasEvents = Array.isArray(events) && events.length > 0;
    const avg = Number(summary?.avgScore||0);
    const recent = Number(summary?.recentErrorRate||0);
    const ok = hasEvents && recent === 0 && avg >= 90;
    return {score: ok?100:0, reason: ok?"条件充足で100点":"条件未充足で0点"};
  }

  // セクション内訳（固定仕様）
  const SECTION_RISKS = [
    {label:"ルーティング互換（/healthz, /places:searchText, /directions）", pct:2},
    {label:"CORS/Origin 厳格化（許可外ブロック誤検出）", pct:3},
    {label:"FieldMask/Places New パラメータ整合", pct:2},
    {label:"Secrets 参照（GMAPS_API_KEY 誤環境/未反映）", pct:2},
    {label:"エラー整形 / 返却コード差分（呼び出し側期待と差異）", pct:2},
    {label:"速度劣化（監査フック増設の影響）", pct:1},
  ];

  function renderRisks(){
    const box = el('risk'); box.innerHTML = '';
    SECTION_RISKS.forEach(r=>{
      const wrap = document.createElement('div'); wrap.className='r';
      const name = document.createElement('div'); name.textContent = `${r.label}`;
      const meter = document.createElement('div'); meter.className='meter';
      const i = document.createElement('i');
      const klass = r.pct<=2?'ok':(r.pct<=5?'mid':'bad');
      meter.appendChild(i); wrap.appendChild(name); wrap.appendChild(meter);
      box.appendChild(wrap); meter.classList.add(klass);
      requestAnimationFrame(()=>{ i.style.width = `${Math.min(100, r.pct)}%`; });
    });
  }

  function trim300(s){
    if(!s) return '';
    const t = s.toString();
    return t.length>300 ? t.slice(0,300)+'…' : t;
  }

  async function fetchJSON(u, opt){
    const r = await fetch(u, opt);
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  async function loadAll(){
    const base = el('endpoint').value.trim();
    // 接続状態は summary の成否で判定（ボタン廃止方針）
    let summary = null, events = null, okMark = '❌ 失敗';
    try{
      summary = await fetchJSON(`${base}/audit/summary`, {cache:'no-store'});
      okMark = '✅ 接続OK';
    }catch(e){
      // summary落ちでも events が取れる可能性に賭ける
      try{
        events = await fetchJSON(`${base}/audit/events?limit=25`, {cache:'no-store'});
        okMark = '✅ 接続OK（eventsのみ）';
      }catch(e2){
        okMark = '❌ 失敗';
      }
    }

    // events優先取得（なければ summary.latestEvents フォールバック）
    if(!events){
      try{
        events = await fetchJSON(`${base}/audit/events?limit=25`, {cache:'no-store'});
      }catch{}
    }
    if((!events || !Array.isArray(events)) && summary && Array.isArray(summary.latestEvents)){
      events = summary.latestEvents;
    }
    if(!events) events = [];

    // summaryがなければゼロで埋める
    if(!summary) summary = { ok:false, avgScore:0, recentErrorRate:0, totals:{runs:0, events:0} };

    // 表示反映
    el('conn-mark').textContent = okMark;
    el('avgScore').textContent = `${Number(summary.avgScore||0).toFixed(1)}`;
    el('recentErr').textContent = `${Number(summary.recentErrorRate||0).toFixed(1)}%`;
    el('runs').textContent = `${Number(summary.totals?.runs||0)}`;
    el('evs').textContent = `${Number(summary.totals?.events||0)}`;

    // 厳格スコア
    const ss = strictScore(summary, events);
    el('score').textContent = String(ss.score);
    el('score-bar').style.width = ss.score+'%';
    el('score-note').textContent = ss.score===100 ? '条件充足：イベント≥1 / recentErrorRate=0 / avgScore≥90 → 100点' : '条件未充足：イベント0件 / recentErrorRate≠0 / avgScore<90 のいずれか';

    // 自己診断（入口/実行/出口）… summaryから近似。未提供時は "--"
    el('diag-entry').textContent = summary.entryScore!=null ? `${summary.entryScore}` : '--';
    el('diag-run').textContent   = summary.recentErrorRate!=null ? `${Number(summary.recentErrorRate).toFixed(1)}%` : '--';
    el('diag-exit').textContent  = summary.exitScore!=null ? `${summary.exitScore}` : '--';

    // イベント描画
    const list = el('events'); list.innerHTML='';
    if(events.length===0){
      const it = document.createElement('div');
      it.className='item'; it.textContent='（イベントがありません）';
      list.appendChild(it);
    }else{
      events.slice(0,25).forEach(ev=>{
        const it = document.createElement('div'); it.className='item';
        const when = new Date(ev.ts || Date.now());
        const head = document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
        const left = document.createElement('div'); left.className='row';
        const t1 = document.createElement('span'); t1.className='pill'; t1.textContent = ev.type || 'event';
        const t2 = document.createElement('span'); t2.className='small muted'; t2.textContent = when.toLocaleString();
        left.appendChild(t1); left.appendChild(t2);
        const right = document.createElement('span'); right.className='pill'; right.textContent = (ev.severity||'info');
        head.appendChild(left); head.appendChild(right);

        const body = document.createElement('div'); body.className='small'; body.style.marginTop='6px';
        body.textContent = trim300(ev.summary || ev.message || '');

        it.appendChild(head); it.appendChild(body);
        list.appendChild(it);
      });
    }
  }

  // 初期化
  renderRisks();
  loadAll();

  // 再取得
  el('btn-refresh').addEventListener('click', ()=>loadAll());
  </script>
</body>
</html>