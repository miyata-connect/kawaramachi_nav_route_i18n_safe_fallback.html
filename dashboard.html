<!DOCTYPE html>
<html lang="ja">
<head>
  <!-- ISSUE: das202511012330 -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="x-issue" content="das202511012330">
  <title>WalkNav 監査ダッシュボード</title>
  <style>
    :root{
      --bg:#0b1220;--text:#e8f1ff;--muted:#9fb1c9;
      --card:#121a2b;--stroke:rgba(255,255,255,.14);
      --ok:#2ad38a;--warn:#ffbb55;--bad:#ff6b6b;--pri:#66aaff;
      --shadow:0 10px 30px rgba(0,0,0,.35);--r:20px
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:980px;margin:24px auto;padding:0 14px}
    h1{margin:0 0 12px;font-size:28px;line-height:1.05;font-weight:800;letter-spacing:.02em;white-space:nowrap}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.03));
      border:1px solid var(--stroke);border-radius:var(--r);box-shadow:var(--shadow);padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .label{color:var(--muted);font-size:13px;white-space:nowrap}
    .hint{color:var(--muted);font-size:12px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--stroke);
      border-radius:999px;padding:6px 10px;background:#0e1728;font-size:12px}
    .ok{color:var(--ok)}.bad{color:var(--bad)}.warn{color:var(--warn)}
    input[type=text],select{flex:1 1 420px;min-width:240px;max-width:100%;
      background:#0f1726;color:var(--text);border:1px solid var(--stroke);
      border-radius:14px;padding:12px 14px;outline:none;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn{appearance:none;border:1px solid var(--stroke);background:#18243a;color:#dbe8ff;
      border-radius:14px;padding:10px 14px;font-weight:700;cursor:pointer;white-space:nowrap}
    .btn.primary{background:var(--pri);color:#071120;border-color:transparent}
    .grid{display:grid;gap:12px}
    .grid2{grid-template-columns:1fr 1fr}
    .scoreBox{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:12px}
    .num{font-size:56px;font-weight:900;letter-spacing:.02em;line-height:1}
    .bar{height:8px;border:1px solid var(--stroke);border-radius:999px;overflow:hidden;background:#0d1626;margin-top:10px}
    .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--bad),var(--warn),var(--ok))}
    .tile{display:flex;align-items:center;gap:10px;justify-content:space-between;
      background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .pill{min-width:48px;text-align:center;border-radius:999px;border:1px solid var(--stroke);padding:6px 10px}
    .tr{display:grid;grid-template-columns:160px 90px 1fr;gap:10px;
      background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px}
    .tr:hover{outline:1px solid var(--pri)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace}
    .sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--stroke);
      border-radius:16px 16px 0 0;transform:translateY(110%);transition:transform .28s ease;
      max-height:82vh;overflow:auto;box-shadow:0 -10px 30px rgba(0,0,0,.45);padding:16px}
    .sheet.show{transform:translateY(0)}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WalkNav 監査ダッシュボード</h1>

    <div class="card">
      <div class="row">
        <span class="label">接続先（Worker エンドポイント）</span>
        <input id="ep" type="text" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev">
        <button class="btn" id="btnPing">接続テスト</button>
        <span id="pingChip" class="chip">-</span>
      </div>
      <div class="row" style="margin-top:8px">
        <span class="label">発行番号（自動取得／手動切替）</span>
        <select id="issueSel" title="発行番号"></select>
        <button class="btn" id="btnReload">再取得</button>
        <span class="hint">/healthz の issue を自動取得します。</span>
      </div>
    </div>

    <div class="grid grid2" style="margin-top:12px">
      <div class="scoreBox">
        <div class="label">総合判定（平均スコア）</div>
        <div id="overallNum" class="num">0</div>
        <div class="bar"><i id="overallBar"></i></div>
        <div id="overallHint" class="hint">ログ由来の平均値（0〜100）。</div>
      </div>
      <div class="scoreBox">
        <div class="label">直近 エラー率</div>
        <div id="errNum" class="num">0%</div>
        <div class="bar"><i id="errBar"></i></div>
        <div class="hint">直近 RUN 記録の失敗割合。</div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="label">自己診断</div>
      <div class="grid grid2" style="margin-top:10px">
        <div class="scoreBox">
          <div class="label">入口（entry）</div>
          <div id="entryNum" class="num">-</div>
          <div class="bar"><i id="entryBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">実行中（run）</div>
          <div id="runNum" class="num">-</div>
          <div class="bar"><i id="runBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">出口（exit）</div>
          <div id="exitNum" class="num">-</div>
          <div class="bar"><i id="exitBar"></i></div>
        </div>
        <div class="scoreBox">
          <div class="label">進行状況</div>
          <div id="phaseChip" class="chip">-</div>
          <div class="hint">手動投稿 UI は撤去。WalkNav 本体から自動送信。</div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="label">セクション内訳（リスク比率）</div>
      <div id="riskGrid" class="grid" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="row">
        <span class="label">最新イベント（25）</span>
        <span class="hint" id="evtHint"></span>
        <button class="btn" id="btnEvt">イベント再取得</button>
      </div>
      <div id="eventList" class="grid" style="margin-top:10px"></div>
    </div>

    <div class="sheet" id="sheet">
      <div class="row">
        <strong>イベント詳細</strong>
        <button class="btn" id="closeSheet">閉じる</button>
      </div>
      <pre id="sheetBody" class="mono" style="white-space:pre-wrap"></pre>
    </div>

    <div class="hint" style="text-align:center;margin:16px 0">© WalkNav Dashboard • ISSUE_ID: das202511012330</div>
  </div>

  <script>
    // ===== 状態 =====
    const S = {
      endpoint: document.getElementById('ep').value.trim().replace(/\/+$/,''),
      issue: null,
      risks: [
        ["Routing (/healthz,/places:searchText,/directions)",2],
        ["CORS/Origin strict",3],
        ["FieldMask/Places New params",2],
        ["Secrets (GMAPS_API_KEY)",2],
        ["Error shape/HTTP code diff",2],
        ["Overhead (audit hooks)",1]
      ],
      cache: { // “前回成功値” を保持
        overall: null, err: null, entry:null, run:null, exit:null, phase:'-',
        events: []
      }
    };

    // ===== util =====
    const $ = q=>document.querySelector(q);
    const el = (t,p={},c=[])=>{const n=document.createElement(t);Object.assign(n,p);c.forEach(x=>n.append(x));return n;};
    const clamp = v => Math.max(0, Math.min(100, Math.round(+v||0)));
    const setNum = (id,v,suf='') => $('#'+id).textContent=(v==null?'-':clamp(v))+suf;
    const setBar = (id,v) => $('#'+id).style.width=clamp(v)+'%';
    const jget = async (u,i)=>{const r=await fetch(u,i); if(!r.ok) throw new Error('HTTP '+r.status); return r.json();};

    // ===== 接続/発行番号 =====
    async function ping(){
      const chip = $('#pingChip'); chip.textContent='...'; chip.className='chip';
      try{
        const j = await jget(S.endpoint+'/healthz');
        S.issue = j.issue || 'unknown';
        setIssueSel([S.issue]);
        chip.textContent='OK'; chip.classList.add('ok');
      }catch(e){ chip.textContent='NG'; chip.classList.add('bad'); }
    }
    function setIssueSel(list){
      const sel=$('#issueSel'); sel.innerHTML=''; list.forEach(x=>sel.append(el('option',{value:x,textContent:x})));
      sel.value=list[0]||'unknown';
    }

    // ===== 描画 =====
    function renderRisks(){
      const g=$('#riskGrid'); g.innerHTML='';
      S.risks.forEach(([name,r])=>{
        const pill=el('span',{className:'pill '+(r>=4?'bad':r>=3?'warn':'ok'),textContent:r+'%'});
        g.append(el('div',{className:'tile'},[
          el('span',{textContent:name,className:'label',style:'overflow:hidden;text-overflow:ellipsis;white-space:nowrap'}),
          pill
        ]));
      });
    }
    function renderEvents(list){
      const box=$('#eventList'); box.innerHTML='';
      $('#evtHint').textContent=`受信: ${list.length} 件`;
      if(!list.length){ box.append(el('div',{className:'hint',textContent:'データなし'})); return; }
      list.slice(0,25).forEach(e=>{
        const t=new Date(e.ts||Date.now()).toLocaleString();
        const row=el('div',{className:'tr'});
        row.append(el('div',{textContent:t}));
        row.append(el('div',{className:'chip',textContent:e.kind||'event'}));
        const msg=(e.message||e.summary||JSON.stringify(e.meta||{},null,0)||'').toString().slice(0,180);
        row.append(el('div',{textContent:msg,style:'overflow:hidden;text-overflow:ellipsis'}));
        row.addEventListener('click',()=>openSheet(e));
        box.append(row);
      });
    }
    function openSheet(e){ $('#sheetBody').textContent=JSON.stringify(e,null,2); $('#sheet').classList.add('show'); }
    $('#closeSheet').onclick=()=>$('#sheet').classList.remove('show');

    // ===== Summary 取得（安定化ロジック） =====
    async function loadSummary(){
      try{
        const j = await jget(S.endpoint+'/audit/summary');

        // runs/events が 0 のときは “データなし” と見做し、前回成功値を維持
        const hasData = (j?.totals?.runs||0) > 0 || (j?.totals?.events||0) > 0;

        if(hasData){
          S.cache.overall = clamp(j.avgScore||0);
          S.cache.err     = clamp(j.recentErrorRate||0);
          S.cache.entry   = j.entryScore==null?S.cache.entry:clamp(j.entryScore);
          S.cache.run     = j.runScore  ==null?S.cache.run  :clamp(j.runScore);
          S.cache.exit    = j.exitScore ==null?S.cache.exit :clamp(j.exitScore);
          S.cache.phase   = j.phase || S.cache.phase;
          S.cache.events  = Array.isArray(j.latestEvents)?j.latestEvents:S.cache.events;
        }
        // 表示（前回値を用いる）
        setNum('overallNum', S.cache.overall??0);
        setBar('overallBar', S.cache.overall??0);
        $('#overallHint').textContent=`集計対象 RUN: ${j?.totals?.runs||0} / EVENTS: ${j?.totals?.events||0}`;
        setNum('errNum', S.cache.err??0, '%'); setBar('errBar', S.cache.err??0);
        setNum('entryNum', S.cache.entry); setBar('entryBar', S.cache.entry??0);
        setNum('runNum',   S.cache.run);   setBar('runBar',   S.cache.run??0);
        setNum('exitNum',  S.cache.exit);  setBar('exitBar',  S.cache.exit??0);
        $('#phaseChip').textContent=S.cache.phase||'-';

        renderEvents(S.cache.events||[]);
      }catch(e){
        // 通信失敗時も前回成功値を保持して静かに継続
      }
    }

    async function reloadEvents(){
      try{
        const j = await jget(S.endpoint+'/audit/summary');
        if(Array.isArray(j.latestEvents)){ S.cache.events=j.latestEvents; }
        renderEvents(S.cache.events||[]);
      }catch(_e){ /* 無視 */ }
    }

    // ===== 配線 =====
    $('#btnPing').onclick = ()=>{ S.endpoint=$('#ep').value.trim().replace(/\/+$/,''); ping(); };
    $('#btnReload').onclick = loadSummary;
    $('#btnEvt').onclick = reloadEvents;
    $('#ep').addEventListener('change',()=>{ S.endpoint=$('#ep').value.trim().replace(/\/+$/,''); });

    (async function init(){
      renderRisks();
      await ping();
      await loadSummary();
      setInterval(loadSummary, 5000); // 5秒周期
    })();
  </script>
</body>
</html>