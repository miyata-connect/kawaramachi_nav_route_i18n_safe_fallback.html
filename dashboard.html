<!-- ISSUE_ID: das202511011031 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WalkNav 管理ダッシュボード</title>
  <meta name="x-issue" content="das202511011031" />
  <style>
    /* ISSUE_ID css202511011031 */
    :root{
      --bg:#0a1321; --text:#eaf2ff; --muted:#a7b8ce; --glass:rgba(20,28,44,.78);
      --stroke:rgba(255,255,255,.12); --ok:#25d07a; --warn:#ffb020; --bad:#ff6565; --accent:#5fb1ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    h1{margin:0 0 16px;font-size:24px}
    .card{background:var(--glass);border:1px solid var(--stroke);border-radius:16px;padding:16px;margin-bottom:16px;backdrop-filter:blur(6px)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .btn{padding:10px 14px;border:1px solid var(--stroke);border-radius:10px;background:rgba(255,255,255,.06);color:var(--text);cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.12)}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    .bar{height:12px;background:#20304a;border-radius:8px;overflow:hidden}
    .bar>span{display:block;height:100%;background:var(--accent);width:0%}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:12px}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--stroke);padding:8px;text-align:left;font-size:14px}
    small{color:var(--muted)}
    input,select{background:rgba(255,255,255,.06);border:1px solid var(--stroke);border-radius:8px;color:var(--text);padding:8px}
    label{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>WalkNav 管理ダッシュボード <small>（採点/監視/出口報告）</small></h1>

    <div class="card">
      <div class="row">
        <div class="grow">
          <div>接続先 Worker</div>
          <div class="row" style="gap:8px;margin-top:6px">
            <input id="base" class="grow" value="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
            <button class="btn" id="btnPing">接続テスト</button>
            <button class="btn" id="btnClear">監査ログのクリア</button>
          </div>
          <small class="mono" id="connLog">未接続</small>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="grow">
          <div class="row" style="justify-content:space-between">
            <strong>自己診断（入口 / 実行 / 出口）</strong>
            <small id="issueId">ISSUE:</small>
          </div>
          <div class="grid" style="margin-top:10px">
            <div>
              <div>入口スコア <span id="inScore" class="ok">--</span>/100</div>
              <div class="bar"><span id="inBar"></span></div>
            </div>
            <div>
              <div>実行中エラー率 <span id="runErr" class="warn">--</span>%</div>
              <div class="bar"><span id="runBar"></span></div>
            </div>
            <div>
              <div>出口スコア <span id="outScore" class="ok">--</span>/100</div>
              <div class="bar"><span id="outBar"></span></div>
            </div>
            <div>
              <div>平均スコア <span id="avgScore">--</span>/100</div>
              <div class="bar"><span id="avgBar"></span></div>
            </div>
          </div>
        </div>
        <div style="min-width:260px">
          <div class="row" style="gap:8px">
            <label class="grow">手動投稿（テスト用）</label>
            <select id="phase">
              <option value="IN">IN（入口）</option>
              <option value="RUN">RUN（実行）</option>
              <option value="OUT">OUT（出口）</option>
            </select>
          </div>
          <div class="row" style="gap:8px;margin-top:8px">
            <input id="score" placeholder="score 0-100" />
            <input id="err" placeholder="errorRate 0-100%" />
          </div>
          <div class="row" style="gap:8px;margin-top:8px">
            <button class="btn" id="btnIngest">投稿</button>
            <button class="btn" id="btnRefresh">再取得</button>
          </div>
          <small>※ 実運用ではフロント/CIから自動送信</small>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>セクション内訳（主要コンポーネント別）</strong>
      <table style="margin-top:8px">
        <thead><tr><th>項目</th><th>リスク(%)</th></tr></thead>
        <tbody id="riskBody">
          <tr><td>ルーティング互換（/healthz, /places:searchText, /directions）</td><td class="warn">--</td></tr>
          <tr><td>CORS/Origin 厳格化（許可外ブロック誤検出）</td><td class="warn">--</td></tr>
          <tr><td>FieldMask/Places New パラメータ整合</td><td class="warn">--</td></tr>
          <tr><td>Secrets 参照（GMAPS_API_KEY 誤環境/未反映）</td><td class="warn">--</td></tr>
          <tr><td>エラー整形/返却コード差分（呼び出し側期待と差異）</td><td class="warn">--</td></tr>
          <tr><td>速度劣化（ログ/監査フック増設の影響）</td><td class="warn">--</td></tr>
        </tbody>
      </table>
      <small>※ リスクはPOST /audit/ingest の記録に含めて集計表示</small>
    </div>

    <div class="card">
      <strong>最新25件ログ</strong>
      <div id="log" class="mono" style="margin-top:8px;white-space:pre-wrap"></div>
    </div>
  </div>

  <script>
    // ISSUE_ID js202511011031
    const $ = (id)=>document.getElementById(id);
    const fmt = (n)=> (n==null||isNaN(n)) ? "--" : String(n);
    const setBar = (el, v)=> el.style.width = Math.max(0, Math.min(100, Number(v)||0)) + "%";

    async function ping() {
      const base = $("base").value.trim();
      try{
        const r = await fetch(base + "/healthz", { method:"GET" });
        const j = await r.json();
        $("connLog").textContent = r.ok ? `接続OK ts=${j.ts} issue=${j.issue}` : `NG ${r.status}`;
        $("issueId").textContent = "ISSUE: " + (j.issue || "n/a");
      }catch(e){
        $("connLog").textContent = "接続失敗: " + e.message;
      }
    }

    async function refresh() {
      const base = $("base").value.trim();
      try{
        const r = await fetch(base + "/audit/summary");
        const j = await r.json();
        const last = j.last || {};
        // 平均など
        $("avgScore").textContent = fmt(j.avgScore);
        setBar($("avgBar"), j.avgScore);

        // 入口/実行/出口は最新のフェーズ別をざっくり表示（簡易）
        $("inScore").textContent = fmt(last?.phase==="IN" ? last.score : "--");
        setBar($("inBar"), last?.phase==="IN" ? last.score : 0);

        $("runErr").textContent = fmt(last?.phase==="RUN" ? last.errorRate : "--");
        setBar($("runBar"), last?.phase==="RUN" ? last.errorRate : 0);

        $("outScore").textContent = fmt(last?.phase==="OUT" ? last.score : "--");
        setBar($("outBar"), last?.phase==="OUT" ? last.score : 0);

        // リスク内訳（最新を採用）
        const risks = last.risks || {};
        const rows = $("riskBody").querySelectorAll("tr");
        const keys = [
          "routingCompat","corsStrict","fieldMaskAlign","secretsRef","errorShape","perfOverhead"
        ];
        const fallback = [2,3,2,2,2,1]; // 既定
        keys.forEach((k, i)=>{
          const val = risks[k];
          rows[i].lastElementChild.textContent = fmt(val == null ? fallback[i] : val);
        });

        // ログ
        const lines = (j.items||[]).map(it=>{
          return `[${new Date(it.ts).toISOString()}] phase=${it.phase} score=${it.score} err=${it.errorRate}% risks=${JSON.stringify(it.risks)} notes=${it.notes}`;
        }).join("\n");
        $("log").textContent = lines || "(ログなし)";
      }catch(e){
        $("log").textContent = "取得失敗: " + e.message;
      }
    }

    async function ingest() {
      const base = $("base").value.trim();
      const body = {
        phase: $("phase").value,
        score: Number($("score").value || 0),
        errorRate: Number($("err").value || 0),
        risks: {
          routingCompat: 2,
          corsStrict: 3,
          fieldMaskAlign: 2,
          secretsRef: 2,
          errorShape: 2,
          perfOverhead: 1
        },
        notes: "manual submit",
        sectionScores: {
          IN: 97, RUN: 95, OUT: 95
        }
      };
      try{
        const r = await fetch(base + "/audit/ingest", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        if(!r.ok) throw new Error("HTTP "+r.status);
        await refresh();
      }catch(e){
        alert("投稿失敗: " + e.message);
      }
    }

    async function clearLog() {
      const base = $("base").value.trim();
      try{
        await fetch(base + "/audit/clear", { method:"POST" });
        await refresh();
      }catch(e){
        alert("クリア失敗: " + e.message);
      }
    }

    $("btnPing").addEventListener("click", ping);
    $("btnRefresh").addEventListener("click", refresh);
    $("btnIngest").addEventListener("click", ingest);
    $("btnClear").addEventListener("click", clearLog);

    // 初期ロード
    ping().then(refresh);
  </script>
</body>
</html>