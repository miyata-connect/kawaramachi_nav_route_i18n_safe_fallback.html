<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WalkNav 監査ダッシュボード</title>
<meta name="x-issue" content="das202511010905" />
<style>
  :root{
    --bg:#0b1220;
    --panel:#141c2c;
    --muted:#9db0c8;
    --text:#eaf2ff;
    --accent:#5fb1ff;
    --ok:#25d07a;
    --warn:#ffb84d;
    --danger:#ff6565;
    --stroke:rgba(255,255,255,.14);
    --glass:rgba(20,28,44,.7);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,sans-serif}
  *{box-sizing:border-box}
  .wrap{max-width:900px;margin:0 auto;padding:20px 14px}
  .title{font-size:28px;font-weight:800;letter-spacing:.02em;margin:6px 0 16px}

  /* connection row (centered) */
  .conn{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;margin:16px 0}
  .conn-row{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;align-items:center}
  .conn-url{flex:1 1 560px;min-width:280px}
  input[type="text"],select{width:100%;padding:13px 14px;border-radius:12px;border:1px solid var(--stroke);background:#0f1726;color:var(--text);font-size:16px}
  .btn{padding:12px 16px;border-radius:12px;border:1px solid var(--stroke);background:#15233a;color:var(--text);cursor:pointer;font-weight:700}
  .btn:hover{filter:brightness(1.08)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:#0f1726;border:1px solid var(--stroke);font-size:14px;color:var(--muted)}

  .section{background:var(--panel);border:1px solid var(--stroke);border-radius:16px;padding:16px;margin:18px 0}
  .sec-title{font-size:18px;font-weight:800;margin:0 0 10px}
  .score-big{font-size:64px;font-weight:900;letter-spacing:.02em;margin:10px 0}
  .bar{height:12px;background:#0f1726;border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;width:0;background:linear-gradient(90deg,#3ad1ff,#37e59e);transition:width .5s ease}

  /* breakdown pills */
  .chips{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .chip{background:#0f1726;border:1px solid var(--stroke);border-radius:14px;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .pct{min-width:48px;text-align:right;padding:6px 10px;border-radius:999px;background:#0c1a2a;border:1px solid var(--stroke)}
  .pct.warn{background:#261a05;border-color:#5c3c00;color:#ffcc66}

  /* events list */
  .events{display:flex;flex-direction:column;gap:10px}
  .evt{background:#0f1726;border:1px solid var(--stroke);border-radius:12px;padding:12px;cursor:pointer}
  .evt:hover{filter:brightness(1.08)}
  .evt h4{margin:0 0 6px;font-size:16px}
  .evt small{color:var(--muted)}

  /* drawer (detail) */
  .drawer{position:fixed;inset:auto 0 0 0;background:rgba(10,19,33,.9);backdrop-filter:blur(6px);border-top:1px solid var(--stroke);transform:translateY(105%);transition:transform .35s ease;z-index:50}
  .drawer.show{transform:translateY(0)}
  .drawer .box{max-width:900px;margin:0 auto;padding:16px}
  .drawer pre{background:#0a1321;border:1px solid var(--stroke);border-radius:12px;padding:12px;overflow:auto;color:#cde3ff}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  /* footer */
  .foot{margin:20px 0 40px;text-align:center;color:var(--muted);font-size:13px}
  .tag{display:inline-block;border:1px dashed var(--stroke);border-radius:999px;padding:6px 10px;margin-top:6px}

  @media (max-width:560px){
    .title{font-size:24px}
    .chips{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="title" id="t-title">WalkNav 監査ダッシュボード</div>

  <!-- connection centered row -->
  <div class="conn">
    <div class="conn-row" style="margin-bottom:10px;">
      <div class="badge" id="b-issue">ISSUE: -</div>
    </div>
    <div class="conn-row">
      <div class="conn-url">
        <input id="inp-endpoint" type="text" placeholder="https://ors-proxy-dev.miyata-connect-jp.workers.dev" />
      </div>
    </div>
    <div class="conn-row" style="margin-top:10px;">
      <button class="btn" id="btn-refresh">再取得</button>
      <span class="badge" id="badge-conn">接続OK</span>
    </div>
    <div class="conn-row" style="margin-top:6px;">
      <select id="sel-issue" class="conn-url"></select>
    </div>
  </div>

  <!-- overall judgement only -->
  <div class="section">
    <div class="sec-title" id="t-overall">総合判定（平均スコア）</div>
    <div class="score-big" id="overall-score">0</div>
    <div class="bar"><i id="overall-bar"></i></div>
    <div style="margin-top:10px;color:var(--muted)" id="overall-note">集計対象 RUN: 0 / EVENTS: 0</div>
  </div>

  <!-- recent error -->
  <div class="section">
    <div class="sec-title" id="t-recent">直近 エラー率</div>
    <div class="score-big" id="err-score">0%</div>
    <div class="bar"><i id="err-bar"></i></div>
    <div style="margin-top:10px;color:var(--muted)" id="err-note">直近 RUN 記録の失敗割合。</div>
  </div>

  <!-- self check (bars only, no manual inputs) -->
  <div class="section">
    <div class="sec-title" id="t-self">自己診断（入口／実行中／出口）</div>
    <div class="row" style="gap:14px">
      <div style="flex:1">
        <div style="font-weight:800;margin:0 0 6px" id="t-entry">入口（entry）</div>
        <div class="bar"><i id="bar-entry"></i></div>
      </div>
      <div style="flex:1">
        <div style="font-weight:800;margin:0 0 6px" id="t-run">実行中（run）</div>
        <div class="bar"><i id="bar-run"></i></div>
      </div>
      <div style="flex:1">
        <div style="font-weight:800;margin:0 0 6px" id="t-exit">出口（exit）</div>
        <div class="bar"><i id="bar-exit"></i></div>
      </div>
    </div>
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div class="badge" id="phase-badge">-</div>
      <div style="color:var(--muted);font-size:14px">※ 手動投稿UIは撤去。WalkNav 本体から /audit/run を送信します。</div>
    </div>
  </div>

  <!-- section breakdown -->
  <div class="section">
    <div class="sec-title" id="t-break">セクション内訳（リスク比率）</div>
    <div class="chips">
      <div class="chip"><span>Routing (/healthz,/places:searchText,/directions)</span><span class="pct" id="pct-routing">2%</span></div>
      <div class="chip"><span>CORS/Origin strict</span><span class="pct warn" id="pct-cors">3%</span></div>
      <div class="chip"><span>FieldMask/Places New params</span><span class="pct" id="pct-field">2%</span></div>
      <div class="chip"><span>Secrets (GMAPS_API_KEY)</span><span class="pct" id="pct-secret">2%</span></div>
      <div class="chip"><span>Error shape/HTTP code diff</span><span class="pct" id="pct-error">2%</span></div>
      <div class="chip"><span>Overhead (logging hooks)</span><span class="pct" id="pct-over">1%</span></div>
    </div>
  </div>

  <!-- latest events -->
  <div class="section">
    <div class="sec-title" id="t-events">最新イベント（最大25件）</div>
    <div class="events" id="event-list"></div>
    <div style="color:var(--muted)" id="event-empty">データなし</div>
  </div>

  <div class="foot">
    © WalkNav Dashboard ・ <span class="tag">ISSUE_ID: das202511010905</span>
  </div>
</div>

<!-- drawer -->
<div class="drawer" id="drawer">
  <div class="box">
    <div class="row" style="justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:800">イベント詳細</div>
      <button class="btn" id="btn-close">閉じる</button>
    </div>
    <pre id="pre-json">{}</pre>
  </div>
</div>

<script>
  // ===== ISSUE TAG =====
  const ISSUE_ID = "das202511010905";

  // ===== i18n (Japanese strings loaded from base64 to keep code ASCII-only) =====
  const JP = JSON.parse(atob("eyJ0aXRsZSI6IldhbGtOYXYg6YCA5ZCN44Oq44Oz44OU44Oz44OX44Op44Oz44K444OjIiwib2t0ZXN0Ijoi5Luj5oCBT0siLCJyZWZldGNoIjoi6YCA5Yqg6IO95Y+W6LGhIiwiaXNzdWUiOiJJU1NVRU86ICIsIm92ZXJhbGwiOiLlhYPjg5HjgqTjg7Pjgq/jgqTjg7MiLCJlcnIiOiLjgqLjg6rjg7zjg7Pjg6siLCJzZWxmIjoi5LqV5pa55oCn77yPICDoq5bjgqTjg7wiLCJicmVhayI6IuacrOmCruWZjOe0ou+8miIsImV2ZW50cyI6IuWQjeW4g+WQjeW4g+OCt+ODvOODqyIsIm5vZGF0YSI6IuODqeODvOODq+ODvOW3peOCi+OBryIsInBhc3NlIjoi44KS44G+44GoIn0="));
  function t(){ // minimal mapping
    document.getElementById('t-title').textContent = JP.title;
    document.getElementById('btn-refresh').textContent = JP.refetch;
    document.getElementById('t-overall').textContent = JP.overall;
    document.getElementById('t-recent').textContent = JP.err;
    document.getElementById('t-self').textContent = JP.self;
    document.getElementById('t-break').textContent = JP.break;
    document.getElementById('t-events').textContent = JP.events;
    document.getElementById('event-empty').textContent = JP.nodata;
  }

  // ===== state =====
  const S = {
    endpoint: "",
    issue: "",
    issues: [],
    summary: null,
    events: [],
  };

  // ===== helpers =====
  const $ = (id)=>document.getElementById(id);
  const setBar = (el, v)=>{ el.style.width = Math.max(0, Math.min(100, v)) + "%"; };

  function saveEndpoint(u){ try{ localStorage.setItem("audit:endpoint", u);}catch{} }
  function loadEndpoint(){ try{ return localStorage.getItem("audit:endpoint")||"";}catch{ return "";} }

  function fmtTs(ts){
    try{
      const d = new Date(Number(ts));
      const p = (n)=>String(n).padStart(2,"0");
      return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
    }catch{ return String(ts); }
  }

  async function jget(url){
    const r = await fetch(url,{credentials:"omit",mode:"cors"});
    if(!r.ok) throw new Error("HTTP "+r.status);
    return await r.json().catch(()=> ({}));
  }

  // ===== rendering =====
  function renderConnOK(ok){
    const b = $('badge-conn');
    b.textContent = ok ? "接続OK" : "接続NG";
    b.style.color = ok ? "#a7f3ce" : "#ffb3b3";
    b.style.borderColor = ok ? "rgba(37,208,122,.4)" : "rgba(255,101,101,.4)";
    b.style.background = ok ? "#0f1f19" : "#241111";
  }

  function renderSummary(sum){
    const avg = Math.round(sum.avgScore||0);
    const err = Math.round(sum.recentErrorRate||0);
    $('overall-score').textContent = String(avg);
    setBar($('overall-bar'), avg);
    $('overall-note').textContent = `集計対象 RUN: ${sum.totals?.runs||0} / EVENTS: ${sum.totals?.events||0}`;
    $('err-score').textContent = `${err}%`;
    setBar($('err-bar'), err);

    // self-check bars from phases (fallback to 0)
    setBar($('bar-entry'), Math.round(sum.phases?.entry||0));
    setBar($('bar-run'),   Math.round(sum.phases?.run||0));
    setBar($('bar-exit'),  Math.round(sum.phases?.exit||0));
    $('phase-badge').textContent = sum.phase||"-";
  }

  function renderEvents(list){
    const box = $('event-list');
    box.innerHTML = "";
    if(!list || !list.length){ $('event-empty').style.display="block"; return; }
    $('event-empty').style.display="none";
    list.slice(0,25).forEach(ev=>{
      const d = document.createElement("div");
      d.className = "evt";
      d.innerHTML = `<h4>${ev.title||ev.type||"event"}</h4><small>${fmtTs(ev.ts)} ・ ${ev.severity||"info"}</small>`;
      d.onclick = ()=> openDrawer(ev);
      box.appendChild(d);
    });
  }

  function openDrawer(obj){
    $('pre-json').textContent = JSON.stringify(obj, null, 2);
    $('drawer').classList.add('show');
  }
  $('btn-close').onclick = ()=>$('drawer').classList.remove('show');

  function renderIssues(issues, current){
    const sel = $('sel-issue'); sel.innerHTML = "";
    issues.forEach(x=>{
      const opt = document.createElement('option');
      opt.value = x; opt.textContent = x;
      if(x===current) opt.selected = true;
      sel.appendChild(opt);
    });
  }

  // ===== fetchers =====
  async function fetchIssueFromHealthz(){
    const u = S.endpoint.replace(/\/+$/,"") + "/healthz";
    const j = await jget(u);
    const iss = String(j.issue || "").trim();
    return iss || "";
  }
  async function fetchIssuesList(){
    // optional endpoint; fallback to only current
    try{
      const u = S.endpoint.replace(/\/+$/,"") + "/audit/issues";
      const j = await jget(u);
      if(Array.isArray(j.issues) && j.issues.length) return j.issues;
    }catch{}
    return S.issue ? [S.issue] : [];
  }
  async function fetchSummary(){
    const u = S.endpoint.replace(/\/+$/,"") + "/audit/summary";
    return await jget(u).catch(()=>({ok:false,avgScore:0,recentErrorRate:0,totals:{runs:0,events:0}}));
  }
  async function fetchEvents(limit=25){
    try{
      const u = S.endpoint.replace(/\/+$/,"") + "/audit/events?limit="+limit;
      const j = await jget(u);
      if(Array.isArray(j.events)) return j.events;
      if(Array.isArray(j.latestEvents)) return j.latestEvents;
    }catch{}
    return [];
  }

  // ===== refresh all =====
  async function refreshAll(){
    const ep = $('inp-endpoint').value.trim();
    S.endpoint = ep; saveEndpoint(ep);
    renderConnOK(false);
    try{
      // 1) issue
      S.issue = await fetchIssueFromHealthz();
      $('b-issue').textContent = "ISSUE: " + (S.issue || "-");
      renderConnOK(!!S.issue);

      // 2) issues list (dropdown)
      S.issues = await fetchIssuesList();
      if(!S.issues.length && S.issue) S.issues = [S.issue];
      renderIssues(S.issues, S.issue);

      // 3) summary + events
      S.summary = await fetchSummary();
      renderSummary(S.summary||{});
      S.events  = await fetchEvents(25);
      renderEvents(S.events);

    }catch(e){
      renderConnOK(false);
      $('overall-note').textContent = "接続エラー: " + (e?.message||"");
      $('event-empty').style.display="block";
    }
  }

  $('btn-refresh').onclick = refreshAll;
  $('sel-issue').onchange = (e)=>{ S.issue = e.target.value; refreshAll(); };

  // ===== boot =====
  (function boot(){
    t(); // localize
    const cached = loadEndpoint() || "https://ors-proxy-dev.miyata-connect-jp.workers.dev";
    $('inp-endpoint').value = cached;
    $('b-issue').textContent = "ISSUE: -";
    refreshAll();
  })();
</script>
</body>
</html>