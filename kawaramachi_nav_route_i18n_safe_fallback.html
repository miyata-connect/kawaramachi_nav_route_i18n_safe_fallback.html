<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>高松・瓦町 多言語徒歩ナビ（音声入力＋音声案内＋SAFE MODE）</title>

  <!-- Leaflet（CDN）：ブロック時はSAFE MODEに自動切替 -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    /* 上部検索パネル */
    #panel {
      position: absolute; top: 8px; left: 8px; right: 8px; z-index: 1000;
      display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
      background: rgba(255,255,255,0.92); border: 1px solid #ccc; border-radius: 10px;
      padding: 6px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #q { flex: 1 1 240px; padding: 8px; font-size: 14px; }
    select, button { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #888; background:#fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .group { display:flex; gap:6px; align-items:center; }

    /* 検索結果リスト */
    #results {
      position: absolute; top: 64px; left: 8px; max-height: 45%; overflow: auto; z-index: 999;
      background: white; border: 1px solid #ddd; border-radius: 8px; display: none; min-width: 320px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #results .item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #results .item:hover { background: #f5f5f5; }
    .badge { font-size: 11px; color: #333; background:#eee; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }

    /* 下部ナビパネル */
    #navPanel {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1050;
      background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 12px; padding: 8px 12px;
      display: none; flex-direction: column; align-items: center; gap: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 260px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #arrow { font-size: 40px; line-height: 1; }
    #dirText { font-size:16px; font-weight:600; } /* ← 方向テキスト */
    #distText { font-size: 18px; font-weight: 700; }
    #targetName { font-size: 14px; color: #333; max-width: 70vw; text-align: center; }
    #actions { display:flex; gap:8px; }

    /* 右下：道案内手順 */
    #steps {
      position: absolute; right: 8px; bottom: 84px; z-index: 1100;
      background: rgba(255,255,255,0.95); border:1px solid #ccc; border-radius: 10px; padding:8px;
      width: 300px; max-height: 45%; overflow:auto; display:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #steps h4 { margin: 0 0 6px 0; font-size: 14px; }
    #steps .step { padding:6px 4px; border-bottom:1px solid #eee; font-size:13px; }
    #steps .step.active { background:#e8f7ff; border-left: 3px solid #2ea8ff; }

    /* SAFE MODE（Leaflet不可の時のCanvas描画） */
    #safeCanvasWrap { position:absolute; inset:0; display:none;
      background: repeating-conic-gradient(#fafafa 0 25%, #f3f3f3 0 50%); background-size: 24px 24px; }
    #safeCanvas { width:100%; height:100%; display:block; }
    #safeNote { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; }

    /* トースト（0件などの軽い通知） */
    #toast {
      position:absolute; top:70px; left:50%; transform: translateX(-50%);
      background:rgba(0,0,0,0.75); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; z-index:2000; display:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }

    /* 録音中の視覚フィードバック */
    #mic.rec { background:#ffeaea; border-color:#d33; }
  </style>
</head>
<body>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- 上部検索パネル -->
  <div id="panel" role="search" aria-label="search panel">
    <div class="group">
      <label for="lang" id="label-lang">言語</label>
      <select id="lang" title="Language">
        <option value="ja">日本語</option>
        <option value="en">English</option>
        <option value="ko">한국어</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
        <option value="es">Español</option>
        <option value="zh">中文</option>
      </select>
    </div>

    <div class="group">
      <label for="mode" id="label-mode">検索モード</label>
      <select id="mode" title="検索モード" aria-label="検索モード">
        <option value="nearby">近くの店舗名</option>
        <option value="phone">電話番号</option>
        <option value="address">住所</option>
      </select>
    </div>

    <input id="q" type="text" placeholder="例）うどん / 087-xxx-xxxx / 香川県高松市…" aria-label="検索語句" />
    <div class="group">
      <label for="radius" id="label-radius">半径</label>
      <select id="radius" title="検索半径" aria-label="検索半径">
        <option value="300">300m</option>
        <option value="500" selected>500m</option>
        <option value="800">800m</option>
        <option value="1200">1200m</option>
      </select>
    </div>
    <button id="mic" title="音声入力">🎤</button>
    <button id="searchBtn" title="検索する">検索</button>
  </div>

  <div id="results" aria-live="polite"></div>
  <div id="map" role="application" aria-label="地図"></div>

  <!-- SAFE MODE -->
  <div id="safeCanvasWrap">
    <canvas id="safeCanvas"></canvas>
    <div id="safeNote">SAFE MODE（タイル非表示）：UIと案内は利用可</div>
  </div>

  <!-- 下部ナビパネル -->
  <div id="navPanel" aria-live="polite">
    <div id="arrow">↑</div>
    <div id="dirText">方向：—</div> <!-- ★追加：進行方向テキスト -->
    <div id="distText">— m</div>
    <div id="targetName"></div>
    <div id="actions">
      <button id="startNav">案内開始</button>
      <button id="stopNav" disabled>停止</button>
      <button id="speak">読み上げ</button>
    </div>
  </div>

  <!-- 右下：道案内手順 -->
  <div id="steps">
    <h4 id="stepsTitle">道案内手順</h4>
    <div id="stepsBody"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ========= i18n ========= */
    const I18N = {
      ja: { lang:'言語', mode:'検索モード', radius:'半径', mic:'音声', search:'検索',
            placeholder:'例）うどん / 087-xxx-xxxx / 香川県高松市…', current:'現在地',
            distance:'距離：約 __m__ m', address:'住所', tel:'電話', poi:'施設',
            near:'近くの店舗名', phone:'電話番号', addr:'住所', start:'案内開始',
            stop:'停止', speak:'読み上げ', arrived:'到着しました', steps:'道案内手順',
            start_say:'出発します', arrived_say:'目的地に到着しました',
            go_straight:'このまま直進', slight_right:'やや右方向', right:'右方向',
            sharp_right:'鋭角に右方向', slight_left:'やや左方向', left:'左方向',
            sharp_left:'鋭角に左方向', back_right:'後方右方向（Uターン気味）', back_left:'後方左方向（Uターン気味）'
      },
      en: { lang:'Language', mode:'Search mode', radius:'Radius', mic:'Voice', search:'Search',
            placeholder:'e.g., udon / 087-xxx-xxxx / Takamatsu…', current:'Current location',
            distance:'Distance: ~ __m__ m', address:'Address', tel:'Tel', poi:'POI',
            near:'Nearby stores', phone:'Phone number', addr:'Address', start:'Start',
            stop:'Stop', speak:'Speak', arrived:'Arrived', steps:'Steps',
            start_say:'Navigation started', arrived_say:'You have arrived at your destination',
            go_straight:'Go straight', slight_right:'Slight right', right:'Right',
            sharp_right:'Sharp right', slight_left:'Slight left', left:'Left',
            sharp_left:'Sharp left', back_right:'Back-right (U-turn-ish)', back_left:'Back-left (U-turn-ish)'
      }
    };

    /* ========= 既知ランドマーク（最小限） ========= */
    const BASE_GEOJSON = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"id":"KAWARAMACHI_STATION","name_ja":"ことでん 瓦町駅（駅ビル）","name_en":"Kotoden Kawaramachi Station","kind":"station"},"geometry":{"type":"Point","coordinates":[134.05264,34.33917]}},
        {"type":"Feature","properties":{"id":"CHUO_PARK_CENTER","name_ja":"高松市立中央公園（中心付近）","name_en":"Takamatsu Chuo Park (center)","kind":"park"},"geometry":{"type":"Point","coordinates":[134.04667,34.34139]}}
      ]
    };

    /* ========= util ========= */
    const toastEl = document.getElementById('toast');
    function showToast(msg){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1600); }
    function langToSpeechLocale(l){ return ({ja:'ja-JP', en:'en-US', ko:'ko-KR', fr:'fr-FR', de:'de-DE', es:'es-ES', zh:'zh-CN'})[l] || 'ja-JP'; }
    function toRad(x){return x*Math.PI/180;}
    function haversine(lat1, lon1, lat2, lon2){ const R=6371000; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
    function bearing(lat1, lon1, lat2, lon2){ const φ1=toRad(lat1), φ2=toRad(lat2), λ1=toRad(lon1), λ2=toRad(lon2); const y=Math.sin(λ2-λ1)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1); let θ=Math.atan2(y,x)*180/Math.PI; if(θ<0) θ+=360; return θ; }
    function arrowFromDelta(delta){ delta=((delta+540)%360)-180; const ad=Math.abs(delta); if(ad<22.5) return '↑'; if(ad<67.5) return delta>0?'↗︎':'↖︎'; if(ad<112.5) return delta>0?'→':'←'; if(ad<157.5) return delta>0?'↘︎':'↙︎'; return '↓'; }

    // ★ 角度差→テキスト（表示/読み上げ両用）
    function directionTextFromDelta(lang, deltaDeg){
      const L = I18N[lang] || I18N.ja;
      const d = ((deltaDeg + 540) % 360) - 180; // -180..180
      const ad = Math.abs(d);
      if (ad < 15)  return L.go_straight;
      if (ad < 45)  return d > 0 ? L.slight_right : L.slight_left;
      if (ad < 90)  return d > 0 ? L.right : L.left;
      if (ad < 135) return d > 0 ? L.sharp_right : L.sharp_left;
      return d > 0 ? L.back_right : L.back_left;
    }

    function distText(m){ const L=I18N[currentLang]||I18N.ja; return (L.distance||'Distance: ~ __m__ m').replace('__m__', Math.round(m)); }
    function speakText(text){ if (!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang=langToSpeechLocale(currentLang); u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }

    /* ========= state ========= */
    const mapDiv = document.getElementById('map');
    const safeWrap = document.getElementById('safeCanvasWrap');
    const safeCanvas = document.getElementById('safeCanvas');

    const langEl = document.getElementById('lang');
    const modeEl = document.getElementById('mode');
    const radiusEl = document.getElementById('radius');
    const qEl = document.getElementById('q');
    const micBtn = document.getElementById('mic');
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const navPanel = document.getElementById('navPanel');
    const startBtn = document.getElementById('startNav');
    const stopBtn  = document.getElementById('stopNav');
    const speakBtn = document.getElementById('speak');
    const distLabel= document.getElementById('distText');
    const arrowEl  = document.getElementById('arrow');
    const dirTextEl= document.getElementById('dirText');  // ★追加
    const targetNameEl = document.getElementById('targetName');
    const stepsDiv = document.getElementById('steps');
    const stepsBody= document.getElementById('stepsBody');
    const stepsTitle = document.getElementById('stepsTitle');

    let currentLang = localStorage.getItem('kawaramachi_lang') || (navigator.language||'ja').slice(0,2);
    if (!(currentLang in I18N)) currentLang = 'ja';
    langEl.value = currentLang;
    function applyLangUI(){
      const L=I18N[currentLang]||I18N.ja;
      document.getElementById('label-lang').textContent=L.lang;
      document.getElementById('label-mode').textContent=L.mode;
      document.getElementById('label-radius').textContent=L.radius;
      micBtn.title=L.mic; searchBtn.textContent=L.search; qEl.placeholder=L.placeholder;
      modeEl.options[0].textContent=L.near; modeEl.options[1].textContent=L.phone; modeEl.options[2].textContent=L.addr;
      startBtn.textContent=L.start; stopBtn.textContent=L.stop; speakBtn.textContent=L.speak;
      stepsTitle.textContent=L.steps;
    }
    applyLangUI();
    langEl.addEventListener('change', ()=>{ currentLang = langEl.value; localStorage.setItem('kawaramachi_lang', currentLang); applyLangUI(); if (recog) recog.lang = langToSpeechLocale(currentLang); });

    /* ========= Leaflet or SAFE MODE ========= */
    let SAFE=false, map=null, tile=null, currentMarker=null, routeLine=null;
    function initLeaflet(){
      map = L.map('map');
      tile = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:20, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
      const gj = L.geoJSON(BASE_GEOJSON).addTo(map);
      map.fitBounds(gj.getBounds().pad(0.2));
      L.control.scale({imperial:false, maxWidth:150}).addTo(map);
    }
    // SAFE MODE座標系（簡易メルカトル）
    let safeCenter = {lat:34.3398, lon:134.0500}, safeZoom = 17;
    function redrawSafe(){ const ctx = safeCanvas.getContext('2d'); const w = safeCanvas.width = safeWrap.clientWidth; const h = safeCanvas.height= safeWrap.clientHeight; ctx.clearRect(0,0,w,h); /* 省略: 線の描画は必要最低限 */ }
    function useSafeMode(){ SAFE=true; mapDiv.style.display='none'; safeWrap.style.display='block'; window.addEventListener('resize', redrawSafe); redrawSafe(); }
    try { if (typeof L === 'undefined') throw new Error('Leaflet not available'); initLeaflet(); } catch(e){ useSafeMode(); }

    /* ========= 位置・検索・ナビ ========= */
    let currentLL=null, dest=null, routeSteps=[], routeCoords=[], activeStepIndex=0;
    function setCurrent(lat, lon){
      currentLL = {lat, lon};
      if (!SAFE){
        if (currentMarker) map.removeLayer(currentMarker);
        const LSTR=(I18N[currentLang]||I18N.ja).current;
        currentMarker = L.marker([lat,lon], {title:LSTR}).addTo(map).bindPopup(LSTR);
      } else { safeCenter={lat,lon}; redrawSafe(); }
    }
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{ setCurrent(pos.coords.latitude, pos.coords.longitude); if (!SAFE) map.setView([pos.coords.latitude,pos.coords.longitude], 17); else { safeZoom=17; redrawSafe(); } });
    }

    function openNavPanel(name){ targetNameEl.textContent=name||''; navPanel.style.display='flex'; stepsDiv.style.display='none'; startBtn.disabled=false; stopBtn.disabled=true; }
    function focusResult(lat, lon, name, info, showNav){
      dest = {lat, lon, name};
      if (!SAFE){
        const m=L.marker([lat,lon]).addTo(map).bindPopup('<b>'+name+'</b>'+(info?'<br>'+info:'')); m.openPopup(); map.setView([lat,lon], 18);
        if (currentMarker){ const cl=currentMarker.getLatLng(); if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline([[cl.lat,cl.lng],[lat,lon]], {color:'#2ecc71', weight:4, opacity:0.8}).addTo(map); distLabel.textContent = distText(haversine(cl.lat,cl.lng,lat,lon)); }
      } else { redrawSafe(); }
      if (showNav) openNavPanel(name);
    }

    async function fetchRoute(lat1,lon1,lat2,lon2){
      const url = `https://router.project-osrm.org/route/v1/foot/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=true`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if (!res.ok) throw new Error('OSRM response not OK');
      const data = await res.json(); if (!data.routes || !data.routes.length) throw new Error('No routes');
      const r = data.routes[0];
      const coords = r.geometry.coordinates.map(([x,y])=>[y,x]);
      const steps = r.legs[0].steps.map(s => ({ name:s.name, distance:s.distance, duration:s.duration, maneuver:s.maneuver, location:{lat:s.maneuver.location[1], lon:s.maneuver.location[0]} }));
      return {coords, steps};
    }

    function renderSteps(steps){
      function turnLabel(lang, man){
        const type = man && man.type || ''; const mod = man && man.modifier || '';
        if (lang === 'ja'){
          if (type === 'depart') return '出発';
          if (type === 'arrive') return '到着';
          if (type === 'roundabout') return 'ラウンドアバウト';
          if (type === 'merge') return '合流';
          if (type === 'fork') return '分岐';
          if (type === 'end of road') return '道の終わり';
          if (type === 'new name') return '道なり';
          if (type === 'notification') return 'お知らせ';
          if (type === 'exit roundabout') return 'ラウンドアバウトを出る';
          if (type === 'exit rotary') return 'ロータリーを出る';
          if (type === 'rotary') return 'ロータリー';
          if (type === 'turn' || type === 'continue'){
            if (mod === 'left') return '左折'; if (mod === 'right') return '右折';
            if (mod === 'slight left') return 'やや左'; if (mod === 'slight right') return 'やや右';
            if (mod === 'sharp left') return '鋭角に左'; if (mod === 'sharp right') return '鋭角に右';
            if (mod === 'uturn') return 'Uターン';
            if (mod === 'straight' || mod === '') return '直進'; return '進行';
          }
          return type || '進行';
        } else {
          if (type === 'depart') return 'depart'; if (type === 'arrive') return 'arrive';
          if (type === 'turn' || type === 'continue'){ if (mod) return mod; return 'forward'; }
          return type || 'forward';
        }
      }
      stepsBody.innerHTML = steps.map((s,i)=>{
        const icon = turnLabel(currentLang, s.maneuver || {});
        const distStr = Math.round(s.distance) + ' m';
        const nameStr = (s.name || '');
        return `<div class="step" id="step-${i}">▶ ${icon} : ${nameStr ? nameStr + ' ' : ''}(${distStr})</div>`;
      }).join('');
      stepsDiv.style.display = 'block';
    }
    function highlightStep(i){ activeStepIndex=i; Array.from(stepsBody.children).forEach((el,idx)=>el.classList.toggle('active', idx===i)); }
    function nearestStepIndex(lat,lon){ if(!routeSteps.length) return 0; let best=0,bd=1e12; for(let i=0;i<routeSteps.length;i++){ const s=routeSteps[i]; const d=haversine(lat,lon,s.location.lat,s.location.lon); if(d<bd){bd=d;best=i;} } return best; }

    // ステップの自然言語（読み上げ用）
    function stepSpeechText(step){
      const man = step.maneuver || {};
      const type = man.type || '', mod = man.modifier || '';
      if (currentLang==='ja'){
        if (type==='depart') return '出発します。';
        if (type==='arrive') return 'まもなく到着です。';
        if (type==='turn' || type==='continue'){
          if (mod==='left') return '次の交差点を左折です。';
          if (mod==='right') return '次の交差点を右折です。';
          if (mod==='slight left') return 'やや左方向です。';
          if (mod==='slight right') return 'やや右方向です。';
          if (mod==='straight' || !mod) return '直進です。';
          if (mod==='uturn') return 'ここでUターンです。';
        }
        return '道なりに進みます。';
      } else {
        if (type==='depart') return "Let's go.";
        if (type==='arrive') return 'Approaching destination.';
        if (type==='turn' || type==='continue'){
          if (mod==='left') return 'Turn left.';
          if (mod==='right') return 'Turn right.';
          if (mod==='slight left') return 'Slight left.';
          if (mod==='slight right') return 'Slight right.';
          if (mod==='straight' || !mod) return 'Go straight.';
          if (mod==='uturn') return 'Make a U-turn.';
        }
        return 'Continue.';
      }
    }

    /* ========= ライブナビ ========= */
    let watchId=null, lastStepAnnounced=-1;
    let lastDirSpoken = '';           // ★直近の方向テキスト（重複読み上げ防止）
    let lastDirSpokenTime = 0;        // ★発話間引き

    async function startNavigation(){
      if (!dest) return alert('目的地を選択してください');
      startBtn.disabled=true; stopBtn.disabled=false;
      const Ltxt=I18N[currentLang]||I18N.ja;
      speakText(Ltxt.start_say || '出発します');

      // ★案内開始とともに現在地へズーム復帰
      if (currentLL){
        if (!SAFE) map.setView([currentLL.lat, currentLL.lon], 18, {animate:true});
        else { /* SAFE */ }
      }

      let lat0,lon0; if (currentLL){ lat0=currentLL.lat; lon0=currentLL.lon; } else { lat0=34.3398; lon0=134.0500; }
      try {
        const r = await fetchRoute(lat0,lon0,dest.lat,dest.lon);
        routeCoords=r.coords; routeSteps=r.steps;
        if (!SAFE){ if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline(routeCoords,{color:'#1976d2',weight:5,opacity:0.9}).addTo(map); }
        renderSteps(routeSteps); highlightStep(0);
        lastStepAnnounced=-1; lastDirSpoken=''; lastDirSpokenTime=0;
        if (routeSteps.length){ speakText(stepSpeechText(routeSteps[0])); lastStepAnnounced=0; }
        navPanel.style.display='flex';
      } catch(e){
        routeCoords=[]; routeSteps=[];
        if (!SAFE){ if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline([[lat0,lon0],[dest.lat,dest.lon]],{color:'#2ecc71',weight:4,opacity:0.8}).addTo(map); }
        stepsDiv.style.display='none';
        navPanel.style.display='flex';
      }

      if (!navigator.geolocation) return alert('Geolocation未対応');
      watchId = navigator.geolocation.watchPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude; setCurrent(lat,lon);

        // 案内中は常に「次のターゲット」へ向けた方位を出す
        const target = routeSteps.length ? routeSteps[nearestStepIndex(lat,lon)].location : dest;
        const br=bearing(lat,lon,target.lat,target.lon);
        const heading=(pos.coords.heading!=null&&pos.coords.heading>=0)?pos.coords.heading:0;
        const delta = br - heading;

        // 方向矢印＆テキスト更新
        arrowEl.textContent = arrowFromDelta(delta);
        const dirText = directionTextFromDelta(currentLang, delta);
        dirTextEl.textContent = '方向：' + dirText;

        // 距離更新
        const d=haversine(lat,lon,dest.lat,dest.lon);
        distLabel.textContent=distText(d);

        // ステップハイライト＆必要時読み上げ
        if (routeSteps.length){
          const idx = nearestStepIndex(lat,lon);
          if (idx !== activeStepIndex){ highlightStep(idx); }
          if (idx !== lastStepAnnounced){ speakText(stepSpeechText(routeSteps[idx])); lastStepAnnounced = idx; }
        }

        // ★方向テキストの読み上げ（3秒に1回まで、内容変化時のみ）
        const now = Date.now();
        if (dirText !== lastDirSpoken && now - lastDirSpokenTime > 3000){
          speakText(dirText);
          lastDirSpoken = dirText;
          lastDirSpokenTime = now;
        }

        // 到着判定：5m
        if (d < 5){
          stopNavigation();
          const L = I18N[currentLang] || I18N.ja;
          distLabel.textContent = L.arrived;
          speakText((L.arrived_say||'到着しました') + '。' + (dest.name||''));
        }
      }, err=>{ console.warn('watchPosition error',err); }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    }

    function stopNavigation(){ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } startBtn.disabled=false; stopBtn.disabled=true; }

    startBtn.addEventListener('click', startNavigation);
    stopBtn.addEventListener('click', stopNavigation);
    speakBtn.addEventListener('click', ()=>{
      if (!dest || !currentLL) return;
      // 手動読み上げ：方向＋距離
      const br=bearing(currentLL.lat,currentLL.lon, (routeSteps.length?routeSteps[nearestStepIndex(currentLL.lat,currentLL.lon)].location:dest).lat, (routeSteps.length?routeSteps[nearestStepIndex(currentLL.lat,currentLL.lon)].location:dest).lon);
      const heading=0;
      const dirText = directionTextFromDelta(currentLang, br - heading);
      const d=haversine(currentLL.lat,currentLL.lon,dest.lat,dest.lon);
      speakText(dirText + '。' + distText(d).replace('距離：約 ','').replace('Distance: ~ ',''));
    });

    /* ========= 音声入力（Android対応・長押しPTT） ========= */
    let recog = null;
    (function initSpeech() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        micBtn.disabled = false;
        micBtn.title = '音声入力未対応。キーボードのマイクで代用してください';
        micBtn.addEventListener('click', () => {
          alert('この端末/ブラウザはWebの音声認識に対応していません。\n' +
                '・Chromeでこのページを開く\n' +
                '・検索欄をタップ→キーボードの🎤アイコンで音声入力\n' +
                '・アプリ内ブラウザではなくChromeで開いてください。');
          qEl.focus();
        });
        return;
      }
      recog = new SR();
      recog.lang = langToSpeechLocale(currentLang);
      recog.interimResults = false;
      recog.continuous = false;
      recog.maxAlternatives = 1;

      let recognizing = false;

      recog.onresult = (e) => {
        const text = e.results[0][0].transcript;
        qEl.value = text;
        setTimeout(()=>doSearch(), 30);
      };
      recog.onerror = (e) => {
        if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
          alert('マイクが許可されていません。アドレスバーの🔒→「権限」→マイクを許可してください。');
        } else if (e.error === 'no-speech' || e.error === 'audio-capture') {
          showToast('音声が取得できませんでした。もう一度お試しください。');
        } else {
          showToast('音声エラー: ' + e.error);
        }
        recognizing = false;
        micBtn.classList.remove('rec');
      };
      recog.onend = () => { recognizing = false; micBtn.classList.remove('rec'); };

      const startRec = () => {
        if (recognizing) { try { recog.stop(); } catch(_){} return; }
        recognizing = true;
        micBtn.classList.add('rec');
        try { recog.start(); } catch(_) { recognizing = false; micBtn.classList.remove('rec'); }
      };
      const stopRec = () => { if (!recognizing) return; try { recog.stop(); } catch(_) {} };

      micBtn.addEventListener('click', startRec);
      micBtn.addEventListener('mousedown', startRec);
      micBtn.addEventListener('mouseup', stopRec);
      micBtn.addEventListener('mouseleave', stopRec);
      micBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
      micBtn.addEventListener('touchend',   (e)=>{ e.preventDefault(); stopRec(); },   {passive:false});
    })();

    /* ========= 共通フェッチ＆Overpassミラー ========= */
    async function fetchJSON(url, opt={}) {
      const res = await fetch(url, opt);
      const ct = res.headers.get('content-type')||'';
      if (!ct.includes('application/json')) {
        const text = await res.text();
        throw new Error(`非JSON応答 (${res.status}) : ${text.slice(0,120)}…`);
      }
      return await res.json();
    }
    async function fetchOverpass(query) {
      const mirrors = [
        'https://overpass-api.de/api/interpreter',
        'https://z.overpass-api.de/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter'
      ];
      let lastErr;
      for (const base of mirrors) {
        try {
          const url = base + '?data=' + encodeURIComponent(query);
          return await fetchJSON(url, { headers: { 'Accept': 'application/json' }});
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Overpass 全ミラー失敗');
    }

    /* ========= 検索（周辺／電話／住所） ========= */
    const resultsDivEl = document.getElementById('results');
    searchBtn.addEventListener('click', doSearch);
    qEl.addEventListener('keydown', e=>{ if (e.key==='Enter') doSearch(); });
    function getLangTag(){ const m={ja:'ja', en:'en', ko:'ko', fr:'fr', de:'de', es:'es', zh:'zh'}; return m[currentLang] || 'ja'; }

    async function doSearch(){
      const mode = modeEl.value;
      const q = qEl.value.trim();
      const radius = parseInt(radiusEl.value, 10) || 500;

      // 現在地バイアス（未取得時は瓦町近辺）
      let lat, lon; if (currentLL){ lat=currentLL.lat; lon=currentLL.lon; } else { lat=34.3398; lon=134.0500; }

      try {
        if (mode==='nearby')  return await searchNearby(lat,lon,radius,q);
        if (mode==='phone')   return await searchPhone(lat,lon,Math.max(radius,800),q);
        if (mode==='address') return await searchAddress(q, {lat, lon});
      } catch(e){
        alert('検索エラー: ' + (e && e.message ? e.message : e));
      }
    }

    function showResults(items){
      const resultsDiv = resultsDivEl;
      if (!Array.isArray(items)) items = [];
      if (items.length === 1){
        const it = items[0];
        focusResult(it.lat, it.lon, it.name, it.info, true);
        resultsDiv.style.display = 'none';
        return;
      }
      if (items.length === 0){
        resultsDiv.style.display = 'none';
        showToast('見つかりませんでした');
        return;
      }
      resultsDiv.innerHTML = items.map((it) => {
        const safeName = (it.name||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const safeInfo = (it.info||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <div class="item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${safeName}" data-info="${safeInfo}">
            <div><b>${safeName}</b>${it.badge?'<span class="badge">'+it.badge+'</span>':''}</div>
            <div style="font-size:12px;color:#555">${safeInfo}</div>
          </div>`;
      }).join('');
      resultsDiv.style.display = 'block';
      Array.from(resultsDiv.querySelectorAll('.item')).forEach(el => el.addEventListener('click', () => {
        const lat = parseFloat(el.getAttribute('data-lat'));
        const lon = parseFloat(el.getAttribute('data-lon'));
        const name = el.getAttribute('data-name');
        const info = el.getAttribute('data-info');
        focusResult(lat, lon, name, info, true);
      }));
    }

    async function searchNearby(lat, lon, radius, keyword){
      const around = radius;
      const nameFilter = keyword ? `[name~"{keyword}",i]` : '';
      const query = `
        [out:json][timeout:25];
        (
          node(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
          way(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
        );
        out center 60;
      `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon)
       .replace(/{nameFilter}/g, nameFilter).replace(/{keyword}/g, (keyword||'').replace(/"/g,'\\"'));
      const json = await fetchOverpass(query);
      const tagLang = getLangTag();
      const L = I18N[currentLang] || I18N.ja;
      const items = (json.elements || []).map(el=>{
        const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
        if (!center) return null;
        const t = el.tags || {};
        const name = t['name:'+tagLang] || t.name || '(名称未設定)';
        const info = [t['addr:full'], t['name:en'], t['addr:street']].filter(Boolean).join(' / ');
        const badge = t.shop || t.amenity || L.poi;
        return {lat:center.lat, lon:center.lon, name, info, badge};
      }).filter(Boolean);
      showResults(items.slice(0,60));
    }

    async function searchPhone(lat, lon, radius, phoneRaw){
      const digits = (phoneRaw||'').replace(/[^0-9+]/g,'');
      if (!digits) { alert('電話番号を入力してください'); return; }
      const around = radius;
      const query = `
        [out:json][timeout:25];
        (
          node(around:{around},{lat},{lon})[phone~"{digits}"];
          node(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
          way(around:{around},{lat},{lon})[phone~"{digits}"];
          way(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
        );
        out center 40;
      `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon).replace(/{digits}/g, digits);
      const json = await fetchOverpass(query);
      const nameLang = getLangTag();
      const L = I18N[currentLang] || I18N.ja;
      const items = (json.elements || []).map(el=>{
        const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
        if (!center) return null;
        const t = el.tags || {};
        const name = t['name:'+nameLang] || t.name || '(名称未設定)';
        const info = [t.phone, t['contact:phone']].filter(Boolean).join(' / ');
        return {lat:center.lat, lon:center.lon, name, info, badge:L.tel};
      }).filter(Boolean);
      showResults(items.slice(0,40));
    }

    // 住所検索：現在地バイアス → Photon → 0件ならNominatimへフォールバック
    async function searchAddress(q, bias){
      if (!q) { alert('住所を入力してください'); return; }
      const lang = (currentLang || 'ja');
      const ref = bias || (currentLL || {lat:34.3398, lon:134.0500}); // 現在地バイアス

      // 1) Photon
      try {
        const url1 = 'https://photon.komoot.io/api/?' + new URLSearchParams({
          q, lang, limit: '15', lat: String(ref.lat), lon: String(ref.lon)
        }).toString();
        const j1 = await fetchJSON(url1, { headers: { 'Accept': 'application/json' } });
        const L = I18N[currentLang] || I18N.ja;
        let items = (j1.features || []).map(f=>{
          const [lon,lat] = f.geometry.coordinates;
          const p = f.properties || {};
          const name = p.name || [p.city, p.street, p.housenumber].filter(Boolean).join(' ') || p.country || '(不明)';
          const info = [p.country, p.state, p.city, p.district, p.street, p.housenumber].filter(Boolean).join(' / ');
          return { lat, lon, name, info, badge:L.address };
        });
        if (items.length){ showResults(items); return; }
      } catch(e){ /* 続行 */ }

      // 2) Nominatim
      try {
        const url2 = 'https://nominatim.openstreetmap.org/search?' + new URLSearchParams({
          q,
          format: 'jsonv2',
          addressdetails: '1',
          limit: '15',
          countrycodes: 'jp',
          'accept-language': lang+',ja,en',
          viewbox: [
            (ref.lon-0.05).toFixed(6), (ref.lat+0.05).toFixed(6),
            (ref.lon+0.05).toFixed(6), (ref.lat-0.05).toFixed(6)
          ].join(','),
          bounded: '1'
        }).toString();
        const j2 = await fetchJSON(url2, { headers: { 'Accept': 'application/json' } });
        const L = I18N[currentLang] || I18N.ja;
        const items2 = (j2 || []).map(r=>{
          const lat = parseFloat(r.lat), lon = parseFloat(r.lon);
          const a = r.address || {};
          const name = r.display_name || [a.state, a.city || a.town || a.village, a.road, a.house_number].filter(Boolean).join(' ');
          const info = [a.postcode, a.state, a.city||a.town||a.village, a.road, a.house_number].filter(Boolean).join(' / ');
          return { lat, lon, name, info, badge:L.address };
        });
        showResults(items2);
      } catch(e2){
        alert('検索エラー: ' + (e2 && e2.message ? e2.message : e2));
      }
    }
  </script>
</body>
</html>

