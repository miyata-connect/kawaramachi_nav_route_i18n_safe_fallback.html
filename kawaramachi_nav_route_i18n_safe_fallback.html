<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é«˜æ¾ãƒ»ç“¦ç”º å¤šè¨€èªå¾’æ­©ãƒŠãƒ“ï¼ˆéŸ³å£°å…¥åŠ›ï¼‹éŸ³å£°æ¡ˆå†…ï¼‹SAFE MODEï¼‰</title>

  <!-- Leafletï¼ˆCDNï¼‰ï¼šãƒ–ãƒ­ãƒƒã‚¯æ™‚ã¯SAFE MODEã«è‡ªå‹•åˆ‡æ›¿ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    /* ä¸Šéƒ¨æ¤œç´¢ãƒ‘ãƒãƒ« */
    #panel {
      position: absolute; top: 8px; left: 8px; right: 8px; z-index: 1000;
      display: flex; gap: 6px; align-items: center; flex-wrap: wrap;
      background: rgba(255,255,255,0.92); border: 1px solid #ccc; border-radius: 10px;
      padding: 6px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #q { flex: 1 1 240px; padding: 8px; font-size: 14px; }
    select, button { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #888; background:#fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .group { display:flex; gap:6px; align-items:center; }

    /* æ¤œç´¢çµæœãƒªã‚¹ãƒˆ */
    #results {
      position: absolute; top: 64px; left: 8px; max-height: 45%; overflow: auto; z-index: 999;
      background: white; border: 1px solid #ddd; border-radius: 8px; display: none; min-width: 320px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #results .item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    #results .item:hover { background: #f5f5f5; }
    .badge { font-size: 11px; color: #333; background:#eee; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }

    /* ä¸‹éƒ¨ãƒŠãƒ“ãƒ‘ãƒãƒ« */
    #navPanel {
      position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1050;
      background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 12px; padding: 8px 12px;
      display: none; flex-direction: column; align-items: center; gap: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 260px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #arrow { font-size: 40px; line-height: 1; }
    #dirText { font-size:16px; font-weight:600; } /* â† æ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆ */
    #distText { font-size: 18px; font-weight: 700; }
    #targetName { font-size: 14px; color: #333; max-width: 70vw; text-align: center; }
    #actions { display:flex; gap:8px; }

    /* å³ä¸‹ï¼šé“æ¡ˆå†…æ‰‹é † */
    #steps {
      position: absolute; right: 8px; bottom: 84px; z-index: 1100;
      background: rgba(255,255,255,0.95); border:1px solid #ccc; border-radius: 10px; padding:8px;
      width: 300px; max-height: 45%; overflow:auto; display:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }
    #steps h4 { margin: 0 0 6px 0; font-size: 14px; }
    #steps .step { padding:6px 4px; border-bottom:1px solid #eee; font-size:13px; }
    #steps .step.active { background:#e8f7ff; border-left: 3px solid #2ea8ff; }

    /* SAFE MODEï¼ˆLeafletä¸å¯ã®æ™‚ã®Canvasæç”»ï¼‰ */
    #safeCanvasWrap { position:absolute; inset:0; display:none;
      background: repeating-conic-gradient(#fafafa 0 25%, #f3f3f3 0 50%); background-size: 24px 24px; }
    #safeCanvas { width:100%; height:100%; display:block; }
    #safeNote { position:absolute; top:8px; right:8px; background:rgba(0,0,0,0.6); color:#fff; padding:4px 8px; border-radius:8px; font-size:12px; }

    /* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆ0ä»¶ãªã©ã®è»½ã„é€šçŸ¥ï¼‰ */
    #toast {
      position:absolute; top:70px; left:50%; transform: translateX(-50%);
      background:rgba(0,0,0,0.75); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; z-index:2000; display:none;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
    }

    /* éŒ²éŸ³ä¸­ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    #mic.rec { background:#ffeaea; border-color:#d33; }
  </style>
</head>
<body>
  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ä¸Šéƒ¨æ¤œç´¢ãƒ‘ãƒãƒ« -->
  <div id="panel" role="search" aria-label="search panel">
    <div class="group">
      <label for="lang" id="label-lang">è¨€èª</label>
      <select id="lang" title="Language">
        <option value="ja">æ—¥æœ¬èª</option>
        <option value="en">English</option>
        <option value="ko">í•œêµ­ì–´</option>
        <option value="fr">FranÃ§ais</option>
        <option value="de">Deutsch</option>
        <option value="es">EspaÃ±ol</option>
        <option value="zh">ä¸­æ–‡</option>
      </select>
    </div>

    <div class="group">
      <label for="mode" id="label-mode">æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰</label>
      <select id="mode" title="æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰" aria-label="æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰">
        <option value="nearby">è¿‘ãã®åº—èˆ—å</option>
        <option value="phone">é›»è©±ç•ªå·</option>
        <option value="address">ä½æ‰€</option>
      </select>
    </div>

    <input id="q" type="text" placeholder="ä¾‹ï¼‰ã†ã©ã‚“ / 087-xxx-xxxx / é¦™å·çœŒé«˜æ¾å¸‚â€¦" aria-label="æ¤œç´¢èªå¥" />
    <div class="group">
      <label for="radius" id="label-radius">åŠå¾„</label>
      <select id="radius" title="æ¤œç´¢åŠå¾„" aria-label="æ¤œç´¢åŠå¾„">
        <option value="300">300m</option>
        <option value="500" selected>500m</option>
        <option value="800">800m</option>
        <option value="1200">1200m</option>
      </select>
    </div>
    <button id="mic" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
    <button id="searchBtn" title="æ¤œç´¢ã™ã‚‹">æ¤œç´¢</button>
  </div>

  <div id="results" aria-live="polite"></div>
  <div id="map" role="application" aria-label="åœ°å›³"></div>

  <!-- SAFE MODE -->
  <div id="safeCanvasWrap">
    <canvas id="safeCanvas"></canvas>
    <div id="safeNote">SAFE MODEï¼ˆã‚¿ã‚¤ãƒ«éè¡¨ç¤ºï¼‰ï¼šUIã¨æ¡ˆå†…ã¯åˆ©ç”¨å¯</div>
  </div>

  <!-- ä¸‹éƒ¨ãƒŠãƒ“ãƒ‘ãƒãƒ« -->
  <div id="navPanel" aria-live="polite">
    <div id="arrow">â†‘</div>
    <div id="dirText">æ–¹å‘ï¼šâ€”</div> <!-- â˜…è¿½åŠ ï¼šé€²è¡Œæ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div id="distText">â€” m</div>
    <div id="targetName"></div>
    <div id="actions">
      <button id="startNav">æ¡ˆå†…é–‹å§‹</button>
      <button id="stopNav" disabled>åœæ­¢</button>
      <button id="speak">èª­ã¿ä¸Šã’</button>
    </div>
  </div>

  <!-- å³ä¸‹ï¼šé“æ¡ˆå†…æ‰‹é † -->
  <div id="steps">
    <h4 id="stepsTitle">é“æ¡ˆå†…æ‰‹é †</h4>
    <div id="stepsBody"></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    /* ========= i18n ========= */
    const I18N = {
      ja: { lang:'è¨€èª', mode:'æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰', radius:'åŠå¾„', mic:'éŸ³å£°', search:'æ¤œç´¢',
            placeholder:'ä¾‹ï¼‰ã†ã©ã‚“ / 087-xxx-xxxx / é¦™å·çœŒé«˜æ¾å¸‚â€¦', current:'ç¾åœ¨åœ°',
            distance:'è·é›¢ï¼šç´„ __m__ m', address:'ä½æ‰€', tel:'é›»è©±', poi:'æ–½è¨­',
            near:'è¿‘ãã®åº—èˆ—å', phone:'é›»è©±ç•ªå·', addr:'ä½æ‰€', start:'æ¡ˆå†…é–‹å§‹',
            stop:'åœæ­¢', speak:'èª­ã¿ä¸Šã’', arrived:'åˆ°ç€ã—ã¾ã—ãŸ', steps:'é“æ¡ˆå†…æ‰‹é †',
            start_say:'å‡ºç™ºã—ã¾ã™', arrived_say:'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ',
            go_straight:'ã“ã®ã¾ã¾ç›´é€²', slight_right:'ã‚„ã‚„å³æ–¹å‘', right:'å³æ–¹å‘',
            sharp_right:'é‹­è§’ã«å³æ–¹å‘', slight_left:'ã‚„ã‚„å·¦æ–¹å‘', left:'å·¦æ–¹å‘',
            sharp_left:'é‹­è§’ã«å·¦æ–¹å‘', back_right:'å¾Œæ–¹å³æ–¹å‘ï¼ˆUã‚¿ãƒ¼ãƒ³æ°—å‘³ï¼‰', back_left:'å¾Œæ–¹å·¦æ–¹å‘ï¼ˆUã‚¿ãƒ¼ãƒ³æ°—å‘³ï¼‰'
      },
      en: { lang:'Language', mode:'Search mode', radius:'Radius', mic:'Voice', search:'Search',
            placeholder:'e.g., udon / 087-xxx-xxxx / Takamatsuâ€¦', current:'Current location',
            distance:'Distance: ~ __m__ m', address:'Address', tel:'Tel', poi:'POI',
            near:'Nearby stores', phone:'Phone number', addr:'Address', start:'Start',
            stop:'Stop', speak:'Speak', arrived:'Arrived', steps:'Steps',
            start_say:'Navigation started', arrived_say:'You have arrived at your destination',
            go_straight:'Go straight', slight_right:'Slight right', right:'Right',
            sharp_right:'Sharp right', slight_left:'Slight left', left:'Left',
            sharp_left:'Sharp left', back_right:'Back-right (U-turn-ish)', back_left:'Back-left (U-turn-ish)'
      }
    };

    /* ========= æ—¢çŸ¥ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ï¼ˆæœ€å°é™ï¼‰ ========= */
    const BASE_GEOJSON = {
      "type":"FeatureCollection",
      "features":[
        {"type":"Feature","properties":{"id":"KAWARAMACHI_STATION","name_ja":"ã“ã¨ã§ã‚“ ç“¦ç”ºé§…ï¼ˆé§…ãƒ“ãƒ«ï¼‰","name_en":"Kotoden Kawaramachi Station","kind":"station"},"geometry":{"type":"Point","coordinates":[134.05264,34.33917]}},
        {"type":"Feature","properties":{"id":"CHUO_PARK_CENTER","name_ja":"é«˜æ¾å¸‚ç«‹ä¸­å¤®å…¬åœ’ï¼ˆä¸­å¿ƒä»˜è¿‘ï¼‰","name_en":"Takamatsu Chuo Park (center)","kind":"park"},"geometry":{"type":"Point","coordinates":[134.04667,34.34139]}}
      ]
    };

    /* ========= util ========= */
    const toastEl = document.getElementById('toast');
    function showToast(msg){ toastEl.textContent=msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 1600); }
    function langToSpeechLocale(l){ return ({ja:'ja-JP', en:'en-US', ko:'ko-KR', fr:'fr-FR', de:'de-DE', es:'es-ES', zh:'zh-CN'})[l] || 'ja-JP'; }
    function toRad(x){return x*Math.PI/180;}
    function haversine(lat1, lon1, lat2, lon2){ const R=6371000; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
    function bearing(lat1, lon1, lat2, lon2){ const Ï†1=toRad(lat1), Ï†2=toRad(lat2), Î»1=toRad(lon1), Î»2=toRad(lon2); const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2); const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1); let Î¸=Math.atan2(y,x)*180/Math.PI; if(Î¸<0) Î¸+=360; return Î¸; }
    function arrowFromDelta(delta){ delta=((delta+540)%360)-180; const ad=Math.abs(delta); if(ad<22.5) return 'â†‘'; if(ad<67.5) return delta>0?'â†—ï¸':'â†–ï¸'; if(ad<112.5) return delta>0?'â†’':'â†'; if(ad<157.5) return delta>0?'â†˜ï¸':'â†™ï¸'; return 'â†“'; }

    // â˜… è§’åº¦å·®â†’ãƒ†ã‚­ã‚¹ãƒˆï¼ˆè¡¨ç¤º/èª­ã¿ä¸Šã’ä¸¡ç”¨ï¼‰
    function directionTextFromDelta(lang, deltaDeg){
      const L = I18N[lang] || I18N.ja;
      const d = ((deltaDeg + 540) % 360) - 180; // -180..180
      const ad = Math.abs(d);
      if (ad < 15)  return L.go_straight;
      if (ad < 45)  return d > 0 ? L.slight_right : L.slight_left;
      if (ad < 90)  return d > 0 ? L.right : L.left;
      if (ad < 135) return d > 0 ? L.sharp_right : L.sharp_left;
      return d > 0 ? L.back_right : L.back_left;
    }

    function distText(m){ const L=I18N[currentLang]||I18N.ja; return (L.distance||'Distance: ~ __m__ m').replace('__m__', Math.round(m)); }
    function speakText(text){ if (!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang=langToSpeechLocale(currentLang); u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }

    /* ========= state ========= */
    const mapDiv = document.getElementById('map');
    const safeWrap = document.getElementById('safeCanvasWrap');
    const safeCanvas = document.getElementById('safeCanvas');

    const langEl = document.getElementById('lang');
    const modeEl = document.getElementById('mode');
    const radiusEl = document.getElementById('radius');
    const qEl = document.getElementById('q');
    const micBtn = document.getElementById('mic');
    const searchBtn = document.getElementById('searchBtn');
    const resultsDiv = document.getElementById('results');
    const navPanel = document.getElementById('navPanel');
    const startBtn = document.getElementById('startNav');
    const stopBtn  = document.getElementById('stopNav');
    const speakBtn = document.getElementById('speak');
    const distLabel= document.getElementById('distText');
    const arrowEl  = document.getElementById('arrow');
    const dirTextEl= document.getElementById('dirText');  // â˜…è¿½åŠ 
    const targetNameEl = document.getElementById('targetName');
    const stepsDiv = document.getElementById('steps');
    const stepsBody= document.getElementById('stepsBody');
    const stepsTitle = document.getElementById('stepsTitle');

    let currentLang = localStorage.getItem('kawaramachi_lang') || (navigator.language||'ja').slice(0,2);
    if (!(currentLang in I18N)) currentLang = 'ja';
    langEl.value = currentLang;
    function applyLangUI(){
      const L=I18N[currentLang]||I18N.ja;
      document.getElementById('label-lang').textContent=L.lang;
      document.getElementById('label-mode').textContent=L.mode;
      document.getElementById('label-radius').textContent=L.radius;
      micBtn.title=L.mic; searchBtn.textContent=L.search; qEl.placeholder=L.placeholder;
      modeEl.options[0].textContent=L.near; modeEl.options[1].textContent=L.phone; modeEl.options[2].textContent=L.addr;
      startBtn.textContent=L.start; stopBtn.textContent=L.stop; speakBtn.textContent=L.speak;
      stepsTitle.textContent=L.steps;
    }
    applyLangUI();
    langEl.addEventListener('change', ()=>{ currentLang = langEl.value; localStorage.setItem('kawaramachi_lang', currentLang); applyLangUI(); if (recog) recog.lang = langToSpeechLocale(currentLang); });

    /* ========= Leaflet or SAFE MODE ========= */
    let SAFE=false, map=null, tile=null, currentMarker=null, routeLine=null;
    function initLeaflet(){
      map = L.map('map');
      tile = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:20, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
      const gj = L.geoJSON(BASE_GEOJSON).addTo(map);
      map.fitBounds(gj.getBounds().pad(0.2));
      L.control.scale({imperial:false, maxWidth:150}).addTo(map);
    }
    // SAFE MODEåº§æ¨™ç³»ï¼ˆç°¡æ˜“ãƒ¡ãƒ«ã‚«ãƒˆãƒ«ï¼‰
    let safeCenter = {lat:34.3398, lon:134.0500}, safeZoom = 17;
    function redrawSafe(){ const ctx = safeCanvas.getContext('2d'); const w = safeCanvas.width = safeWrap.clientWidth; const h = safeCanvas.height= safeWrap.clientHeight; ctx.clearRect(0,0,w,h); /* çœç•¥: ç·šã®æç”»ã¯å¿…è¦æœ€ä½é™ */ }
    function useSafeMode(){ SAFE=true; mapDiv.style.display='none'; safeWrap.style.display='block'; window.addEventListener('resize', redrawSafe); redrawSafe(); }
    try { if (typeof L === 'undefined') throw new Error('Leaflet not available'); initLeaflet(); } catch(e){ useSafeMode(); }

    /* ========= ä½ç½®ãƒ»æ¤œç´¢ãƒ»ãƒŠãƒ“ ========= */
    let currentLL=null, dest=null, routeSteps=[], routeCoords=[], activeStepIndex=0;
    function setCurrent(lat, lon){
      currentLL = {lat, lon};
      if (!SAFE){
        if (currentMarker) map.removeLayer(currentMarker);
        const LSTR=(I18N[currentLang]||I18N.ja).current;
        currentMarker = L.marker([lat,lon], {title:LSTR}).addTo(map).bindPopup(LSTR);
      } else { safeCenter={lat,lon}; redrawSafe(); }
    }
    if (navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{ setCurrent(pos.coords.latitude, pos.coords.longitude); if (!SAFE) map.setView([pos.coords.latitude,pos.coords.longitude], 17); else { safeZoom=17; redrawSafe(); } });
    }

    function openNavPanel(name){ targetNameEl.textContent=name||''; navPanel.style.display='flex'; stepsDiv.style.display='none'; startBtn.disabled=false; stopBtn.disabled=true; }
    function focusResult(lat, lon, name, info, showNav){
      dest = {lat, lon, name};
      if (!SAFE){
        const m=L.marker([lat,lon]).addTo(map).bindPopup('<b>'+name+'</b>'+(info?'<br>'+info:'')); m.openPopup(); map.setView([lat,lon], 18);
        if (currentMarker){ const cl=currentMarker.getLatLng(); if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline([[cl.lat,cl.lng],[lat,lon]], {color:'#2ecc71', weight:4, opacity:0.8}).addTo(map); distLabel.textContent = distText(haversine(cl.lat,cl.lng,lat,lon)); }
      } else { redrawSafe(); }
      if (showNav) openNavPanel(name);
    }

    async function fetchRoute(lat1,lon1,lat2,lon2){
      const url = `https://router.project-osrm.org/route/v1/foot/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=true`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if (!res.ok) throw new Error('OSRM response not OK');
      const data = await res.json(); if (!data.routes || !data.routes.length) throw new Error('No routes');
      const r = data.routes[0];
      const coords = r.geometry.coordinates.map(([x,y])=>[y,x]);
      const steps = r.legs[0].steps.map(s => ({ name:s.name, distance:s.distance, duration:s.duration, maneuver:s.maneuver, location:{lat:s.maneuver.location[1], lon:s.maneuver.location[0]} }));
      return {coords, steps};
    }

    function renderSteps(steps){
      function turnLabel(lang, man){
        const type = man && man.type || ''; const mod = man && man.modifier || '';
        if (lang === 'ja'){
          if (type === 'depart') return 'å‡ºç™º';
          if (type === 'arrive') return 'åˆ°ç€';
          if (type === 'roundabout') return 'ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¢ãƒã‚¦ãƒˆ';
          if (type === 'merge') return 'åˆæµ';
          if (type === 'fork') return 'åˆ†å²';
          if (type === 'end of road') return 'é“ã®çµ‚ã‚ã‚Š';
          if (type === 'new name') return 'é“ãªã‚Š';
          if (type === 'notification') return 'ãŠçŸ¥ã‚‰ã›';
          if (type === 'exit roundabout') return 'ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¢ãƒã‚¦ãƒˆã‚’å‡ºã‚‹';
          if (type === 'exit rotary') return 'ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼ã‚’å‡ºã‚‹';
          if (type === 'rotary') return 'ãƒ­ãƒ¼ã‚¿ãƒªãƒ¼';
          if (type === 'turn' || type === 'continue'){
            if (mod === 'left') return 'å·¦æŠ˜'; if (mod === 'right') return 'å³æŠ˜';
            if (mod === 'slight left') return 'ã‚„ã‚„å·¦'; if (mod === 'slight right') return 'ã‚„ã‚„å³';
            if (mod === 'sharp left') return 'é‹­è§’ã«å·¦'; if (mod === 'sharp right') return 'é‹­è§’ã«å³';
            if (mod === 'uturn') return 'Uã‚¿ãƒ¼ãƒ³';
            if (mod === 'straight' || mod === '') return 'ç›´é€²'; return 'é€²è¡Œ';
          }
          return type || 'é€²è¡Œ';
        } else {
          if (type === 'depart') return 'depart'; if (type === 'arrive') return 'arrive';
          if (type === 'turn' || type === 'continue'){ if (mod) return mod; return 'forward'; }
          return type || 'forward';
        }
      }
      stepsBody.innerHTML = steps.map((s,i)=>{
        const icon = turnLabel(currentLang, s.maneuver || {});
        const distStr = Math.round(s.distance) + ' m';
        const nameStr = (s.name || '');
        return `<div class="step" id="step-${i}">â–¶ ${icon} : ${nameStr ? nameStr + ' ' : ''}(${distStr})</div>`;
      }).join('');
      stepsDiv.style.display = 'block';
    }
    function highlightStep(i){ activeStepIndex=i; Array.from(stepsBody.children).forEach((el,idx)=>el.classList.toggle('active', idx===i)); }
    function nearestStepIndex(lat,lon){ if(!routeSteps.length) return 0; let best=0,bd=1e12; for(let i=0;i<routeSteps.length;i++){ const s=routeSteps[i]; const d=haversine(lat,lon,s.location.lat,s.location.lon); if(d<bd){bd=d;best=i;} } return best; }

    // ã‚¹ãƒ†ãƒƒãƒ—ã®è‡ªç„¶è¨€èªï¼ˆèª­ã¿ä¸Šã’ç”¨ï¼‰
    function stepSpeechText(step){
      const man = step.maneuver || {};
      const type = man.type || '', mod = man.modifier || '';
      if (currentLang==='ja'){
        if (type==='depart') return 'å‡ºç™ºã—ã¾ã™ã€‚';
        if (type==='arrive') return 'ã¾ã‚‚ãªãåˆ°ç€ã§ã™ã€‚';
        if (type==='turn' || type==='continue'){
          if (mod==='left') return 'æ¬¡ã®äº¤å·®ç‚¹ã‚’å·¦æŠ˜ã§ã™ã€‚';
          if (mod==='right') return 'æ¬¡ã®äº¤å·®ç‚¹ã‚’å³æŠ˜ã§ã™ã€‚';
          if (mod==='slight left') return 'ã‚„ã‚„å·¦æ–¹å‘ã§ã™ã€‚';
          if (mod==='slight right') return 'ã‚„ã‚„å³æ–¹å‘ã§ã™ã€‚';
          if (mod==='straight' || !mod) return 'ç›´é€²ã§ã™ã€‚';
          if (mod==='uturn') return 'ã“ã“ã§Uã‚¿ãƒ¼ãƒ³ã§ã™ã€‚';
        }
        return 'é“ãªã‚Šã«é€²ã¿ã¾ã™ã€‚';
      } else {
        if (type==='depart') return "Let's go.";
        if (type==='arrive') return 'Approaching destination.';
        if (type==='turn' || type==='continue'){
          if (mod==='left') return 'Turn left.';
          if (mod==='right') return 'Turn right.';
          if (mod==='slight left') return 'Slight left.';
          if (mod==='slight right') return 'Slight right.';
          if (mod==='straight' || !mod) return 'Go straight.';
          if (mod==='uturn') return 'Make a U-turn.';
        }
        return 'Continue.';
      }
    }

    /* ========= ãƒ©ã‚¤ãƒ–ãƒŠãƒ“ ========= */
    let watchId=null, lastStepAnnounced=-1;
    let lastDirSpoken = '';           // â˜…ç›´è¿‘ã®æ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆï¼ˆé‡è¤‡èª­ã¿ä¸Šã’é˜²æ­¢ï¼‰
    let lastDirSpokenTime = 0;        // â˜…ç™ºè©±é–“å¼•ã

    async function startNavigation(){
      if (!dest) return alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„');
      startBtn.disabled=true; stopBtn.disabled=false;
      const Ltxt=I18N[currentLang]||I18N.ja;
      speakText(Ltxt.start_say || 'å‡ºç™ºã—ã¾ã™');

      // â˜…æ¡ˆå†…é–‹å§‹ã¨ã¨ã‚‚ã«ç¾åœ¨åœ°ã¸ã‚ºãƒ¼ãƒ å¾©å¸°
      if (currentLL){
        if (!SAFE) map.setView([currentLL.lat, currentLL.lon], 18, {animate:true});
        else { /* SAFE */ }
      }

      let lat0,lon0; if (currentLL){ lat0=currentLL.lat; lon0=currentLL.lon; } else { lat0=34.3398; lon0=134.0500; }
      try {
        const r = await fetchRoute(lat0,lon0,dest.lat,dest.lon);
        routeCoords=r.coords; routeSteps=r.steps;
        if (!SAFE){ if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline(routeCoords,{color:'#1976d2',weight:5,opacity:0.9}).addTo(map); }
        renderSteps(routeSteps); highlightStep(0);
        lastStepAnnounced=-1; lastDirSpoken=''; lastDirSpokenTime=0;
        if (routeSteps.length){ speakText(stepSpeechText(routeSteps[0])); lastStepAnnounced=0; }
        navPanel.style.display='flex';
      } catch(e){
        routeCoords=[]; routeSteps=[];
        if (!SAFE){ if (routeLine) map.removeLayer(routeLine); routeLine=L.polyline([[lat0,lon0],[dest.lat,dest.lon]],{color:'#2ecc71',weight:4,opacity:0.8}).addTo(map); }
        stepsDiv.style.display='none';
        navPanel.style.display='flex';
      }

      if (!navigator.geolocation) return alert('Geolocationæœªå¯¾å¿œ');
      watchId = navigator.geolocation.watchPosition(pos=>{
        const lat=pos.coords.latitude, lon=pos.coords.longitude; setCurrent(lat,lon);

        // æ¡ˆå†…ä¸­ã¯å¸¸ã«ã€Œæ¬¡ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€ã¸å‘ã‘ãŸæ–¹ä½ã‚’å‡ºã™
        const target = routeSteps.length ? routeSteps[nearestStepIndex(lat,lon)].location : dest;
        const br=bearing(lat,lon,target.lat,target.lon);
        const heading=(pos.coords.heading!=null&&pos.coords.heading>=0)?pos.coords.heading:0;
        const delta = br - heading;

        // æ–¹å‘çŸ¢å°ï¼†ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
        arrowEl.textContent = arrowFromDelta(delta);
        const dirText = directionTextFromDelta(currentLang, delta);
        dirTextEl.textContent = 'æ–¹å‘ï¼š' + dirText;

        // è·é›¢æ›´æ–°
        const d=haversine(lat,lon,dest.lat,dest.lon);
        distLabel.textContent=distText(d);

        // ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼†å¿…è¦æ™‚èª­ã¿ä¸Šã’
        if (routeSteps.length){
          const idx = nearestStepIndex(lat,lon);
          if (idx !== activeStepIndex){ highlightStep(idx); }
          if (idx !== lastStepAnnounced){ speakText(stepSpeechText(routeSteps[idx])); lastStepAnnounced = idx; }
        }

        // â˜…æ–¹å‘ãƒ†ã‚­ã‚¹ãƒˆã®èª­ã¿ä¸Šã’ï¼ˆ3ç§’ã«1å›ã¾ã§ã€å†…å®¹å¤‰åŒ–æ™‚ã®ã¿ï¼‰
        const now = Date.now();
        if (dirText !== lastDirSpoken && now - lastDirSpokenTime > 3000){
          speakText(dirText);
          lastDirSpoken = dirText;
          lastDirSpokenTime = now;
        }

        // åˆ°ç€åˆ¤å®šï¼š5m
        if (d < 5){
          stopNavigation();
          const L = I18N[currentLang] || I18N.ja;
          distLabel.textContent = L.arrived;
          speakText((L.arrived_say||'åˆ°ç€ã—ã¾ã—ãŸ') + 'ã€‚' + (dest.name||''));
        }
      }, err=>{ console.warn('watchPosition error',err); }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    }

    function stopNavigation(){ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } startBtn.disabled=false; stopBtn.disabled=true; }

    startBtn.addEventListener('click', startNavigation);
    stopBtn.addEventListener('click', stopNavigation);
    speakBtn.addEventListener('click', ()=>{
      if (!dest || !currentLL) return;
      // æ‰‹å‹•èª­ã¿ä¸Šã’ï¼šæ–¹å‘ï¼‹è·é›¢
      const br=bearing(currentLL.lat,currentLL.lon, (routeSteps.length?routeSteps[nearestStepIndex(currentLL.lat,currentLL.lon)].location:dest).lat, (routeSteps.length?routeSteps[nearestStepIndex(currentLL.lat,currentLL.lon)].location:dest).lon);
      const heading=0;
      const dirText = directionTextFromDelta(currentLang, br - heading);
      const d=haversine(currentLL.lat,currentLL.lon,dest.lat,dest.lon);
      speakText(dirText + 'ã€‚' + distText(d).replace('è·é›¢ï¼šç´„ ','').replace('Distance: ~ ',''));
    });

    /* ========= éŸ³å£°å…¥åŠ›ï¼ˆAndroidå¯¾å¿œãƒ»é•·æŠ¼ã—PTTï¼‰ ========= */
    let recog = null;
    (function initSpeech() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        micBtn.disabled = false;
        micBtn.title = 'éŸ³å£°å…¥åŠ›æœªå¯¾å¿œã€‚ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ãƒã‚¤ã‚¯ã§ä»£ç”¨ã—ã¦ãã ã•ã„';
        micBtn.addEventListener('click', () => {
          alert('ã“ã®ç«¯æœ«/ãƒ–ãƒ©ã‚¦ã‚¶ã¯Webã®éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\n' +
                'ãƒ»Chromeã§ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‹ã\n' +
                'ãƒ»æ¤œç´¢æ¬„ã‚’ã‚¿ãƒƒãƒ—â†’ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ã‚¢ã‚¤ã‚³ãƒ³ã§éŸ³å£°å…¥åŠ›\n' +
                'ãƒ»ã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãªãChromeã§é–‹ã„ã¦ãã ã•ã„ã€‚');
          qEl.focus();
        });
        return;
      }
      recog = new SR();
      recog.lang = langToSpeechLocale(currentLang);
      recog.interimResults = false;
      recog.continuous = false;
      recog.maxAlternatives = 1;

      let recognizing = false;

      recog.onresult = (e) => {
        const text = e.results[0][0].transcript;
        qEl.value = text;
        setTimeout(()=>doSearch(), 30);
      };
      recog.onerror = (e) => {
        if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
          alert('ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ğŸ”’â†’ã€Œæ¨©é™ã€â†’ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚');
        } else if (e.error === 'no-speech' || e.error === 'audio-capture') {
          showToast('éŸ³å£°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        } else {
          showToast('éŸ³å£°ã‚¨ãƒ©ãƒ¼: ' + e.error);
        }
        recognizing = false;
        micBtn.classList.remove('rec');
      };
      recog.onend = () => { recognizing = false; micBtn.classList.remove('rec'); };

      const startRec = () => {
        if (recognizing) { try { recog.stop(); } catch(_){} return; }
        recognizing = true;
        micBtn.classList.add('rec');
        try { recog.start(); } catch(_) { recognizing = false; micBtn.classList.remove('rec'); }
      };
      const stopRec = () => { if (!recognizing) return; try { recog.stop(); } catch(_) {} };

      micBtn.addEventListener('click', startRec);
      micBtn.addEventListener('mousedown', startRec);
      micBtn.addEventListener('mouseup', stopRec);
      micBtn.addEventListener('mouseleave', stopRec);
      micBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
      micBtn.addEventListener('touchend',   (e)=>{ e.preventDefault(); stopRec(); },   {passive:false});
    })();

    /* ========= å…±é€šãƒ•ã‚§ãƒƒãƒï¼†OverpassãƒŸãƒ©ãƒ¼ ========= */
    async function fetchJSON(url, opt={}) {
      const res = await fetch(url, opt);
      const ct = res.headers.get('content-type')||'';
      if (!ct.includes('application/json')) {
        const text = await res.text();
        throw new Error(`éJSONå¿œç­” (${res.status}) : ${text.slice(0,120)}â€¦`);
      }
      return await res.json();
    }
    async function fetchOverpass(query) {
      const mirrors = [
        'https://overpass-api.de/api/interpreter',
        'https://z.overpass-api.de/api/interpreter',
        'https://overpass.kumi.systems/api/interpreter'
      ];
      let lastErr;
      for (const base of mirrors) {
        try {
          const url = base + '?data=' + encodeURIComponent(query);
          return await fetchJSON(url, { headers: { 'Accept': 'application/json' }});
        } catch (e) { lastErr = e; }
      }
      throw lastErr || new Error('Overpass å…¨ãƒŸãƒ©ãƒ¼å¤±æ•—');
    }

    /* ========= æ¤œç´¢ï¼ˆå‘¨è¾ºï¼é›»è©±ï¼ä½æ‰€ï¼‰ ========= */
    const resultsDivEl = document.getElementById('results');
    searchBtn.addEventListener('click', doSearch);
    qEl.addEventListener('keydown', e=>{ if (e.key==='Enter') doSearch(); });
    function getLangTag(){ const m={ja:'ja', en:'en', ko:'ko', fr:'fr', de:'de', es:'es', zh:'zh'}; return m[currentLang] || 'ja'; }

    async function doSearch(){
      const mode = modeEl.value;
      const q = qEl.value.trim();
      const radius = parseInt(radiusEl.value, 10) || 500;

      // ç¾åœ¨åœ°ãƒã‚¤ã‚¢ã‚¹ï¼ˆæœªå–å¾—æ™‚ã¯ç“¦ç”ºè¿‘è¾ºï¼‰
      let lat, lon; if (currentLL){ lat=currentLL.lat; lon=currentLL.lon; } else { lat=34.3398; lon=134.0500; }

      try {
        if (mode==='nearby')  return await searchNearby(lat,lon,radius,q);
        if (mode==='phone')   return await searchPhone(lat,lon,Math.max(radius,800),q);
        if (mode==='address') return await searchAddress(q, {lat, lon});
      } catch(e){
        alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + (e && e.message ? e.message : e));
      }
    }

    function showResults(items){
      const resultsDiv = resultsDivEl;
      if (!Array.isArray(items)) items = [];
      if (items.length === 1){
        const it = items[0];
        focusResult(it.lat, it.lon, it.name, it.info, true);
        resultsDiv.style.display = 'none';
        return;
      }
      if (items.length === 0){
        resultsDiv.style.display = 'none';
        showToast('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        return;
      }
      resultsDiv.innerHTML = items.map((it) => {
        const safeName = (it.name||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const safeInfo = (it.info||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
          <div class="item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${safeName}" data-info="${safeInfo}">
            <div><b>${safeName}</b>${it.badge?'<span class="badge">'+it.badge+'</span>':''}</div>
            <div style="font-size:12px;color:#555">${safeInfo}</div>
          </div>`;
      }).join('');
      resultsDiv.style.display = 'block';
      Array.from(resultsDiv.querySelectorAll('.item')).forEach(el => el.addEventListener('click', () => {
        const lat = parseFloat(el.getAttribute('data-lat'));
        const lon = parseFloat(el.getAttribute('data-lon'));
        const name = el.getAttribute('data-name');
        const info = el.getAttribute('data-info');
        focusResult(lat, lon, name, info, true);
      }));
    }

    async function searchNearby(lat, lon, radius, keyword){
      const around = radius;
      const nameFilter = keyword ? `[name~"{keyword}",i]` : '';
      const query = `
        [out:json][timeout:25];
        (
          node(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
          way(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
        );
        out center 60;
      `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon)
       .replace(/{nameFilter}/g, nameFilter).replace(/{keyword}/g, (keyword||'').replace(/"/g,'\\"'));
      const json = await fetchOverpass(query);
      const tagLang = getLangTag();
      const L = I18N[currentLang] || I18N.ja;
      const items = (json.elements || []).map(el=>{
        const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
        if (!center) return null;
        const t = el.tags || {};
        const name = t['name:'+tagLang] || t.name || '(åç§°æœªè¨­å®š)';
        const info = [t['addr:full'], t['name:en'], t['addr:street']].filter(Boolean).join(' / ');
        const badge = t.shop || t.amenity || L.poi;
        return {lat:center.lat, lon:center.lon, name, info, badge};
      }).filter(Boolean);
      showResults(items.slice(0,60));
    }

    async function searchPhone(lat, lon, radius, phoneRaw){
      const digits = (phoneRaw||'').replace(/[^0-9+]/g,'');
      if (!digits) { alert('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const around = radius;
      const query = `
        [out:json][timeout:25];
        (
          node(around:{around},{lat},{lon})[phone~"{digits}"];
          node(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
          way(around:{around},{lat},{lon})[phone~"{digits}"];
          way(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
        );
        out center 40;
      `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon).replace(/{digits}/g, digits);
      const json = await fetchOverpass(query);
      const nameLang = getLangTag();
      const L = I18N[currentLang] || I18N.ja;
      const items = (json.elements || []).map(el=>{
        const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
        if (!center) return null;
        const t = el.tags || {};
        const name = t['name:'+nameLang] || t.name || '(åç§°æœªè¨­å®š)';
        const info = [t.phone, t['contact:phone']].filter(Boolean).join(' / ');
        return {lat:center.lat, lon:center.lon, name, info, badge:L.tel};
      }).filter(Boolean);
      showResults(items.slice(0,40));
    }

    // ä½æ‰€æ¤œç´¢ï¼šç¾åœ¨åœ°ãƒã‚¤ã‚¢ã‚¹ â†’ Photon â†’ 0ä»¶ãªã‚‰Nominatimã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    async function searchAddress(q, bias){
      if (!q) { alert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      const lang = (currentLang || 'ja');
      const ref = bias || (currentLL || {lat:34.3398, lon:134.0500}); // ç¾åœ¨åœ°ãƒã‚¤ã‚¢ã‚¹

      // 1) Photon
      try {
        const url1 = 'https://photon.komoot.io/api/?' + new URLSearchParams({
          q, lang, limit: '15', lat: String(ref.lat), lon: String(ref.lon)
        }).toString();
        const j1 = await fetchJSON(url1, { headers: { 'Accept': 'application/json' } });
        const L = I18N[currentLang] || I18N.ja;
        let items = (j1.features || []).map(f=>{
          const [lon,lat] = f.geometry.coordinates;
          const p = f.properties || {};
          const name = p.name || [p.city, p.street, p.housenumber].filter(Boolean).join(' ') || p.country || '(ä¸æ˜)';
          const info = [p.country, p.state, p.city, p.district, p.street, p.housenumber].filter(Boolean).join(' / ');
          return { lat, lon, name, info, badge:L.address };
        });
        if (items.length){ showResults(items); return; }
      } catch(e){ /* ç¶šè¡Œ */ }

      // 2) Nominatim
      try {
        const url2 = 'https://nominatim.openstreetmap.org/search?' + new URLSearchParams({
          q,
          format: 'jsonv2',
          addressdetails: '1',
          limit: '15',
          countrycodes: 'jp',
          'accept-language': lang+',ja,en',
          viewbox: [
            (ref.lon-0.05).toFixed(6), (ref.lat+0.05).toFixed(6),
            (ref.lon+0.05).toFixed(6), (ref.lat-0.05).toFixed(6)
          ].join(','),
          bounded: '1'
        }).toString();
        const j2 = await fetchJSON(url2, { headers: { 'Accept': 'application/json' } });
        const L = I18N[currentLang] || I18N.ja;
        const items2 = (j2 || []).map(r=>{
          const lat = parseFloat(r.lat), lon = parseFloat(r.lon);
          const a = r.address || {};
          const name = r.display_name || [a.state, a.city || a.town || a.village, a.road, a.house_number].filter(Boolean).join(' ');
          const info = [a.postcode, a.state, a.city||a.town||a.village, a.road, a.house_number].filter(Boolean).join(' / ');
          return { lat, lon, name, info, badge:L.address };
        });
        showResults(items2);
      } catch(e2){
        alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + (e2 && e2.message ? e2.message : e2));
      }
    }
  </script>
</body>
</html>

