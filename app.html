<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é«˜æ¾ãƒ»ç“¦ç”º å¤šè¨€èªå¾’æ­©ãƒŠãƒ“</title>

<!-- Leafletï¼ˆjsDelivrãƒ»SRIä»˜ãï¼‰ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
<style>
  html,body,#map{height:100%;margin:0}
  /* æ¤œç´¢ãƒ˜ãƒƒãƒ€ */
  #panel{
    position:absolute; top:8px; left:8px; right:8px; z-index:1000;
    display:grid; grid-template-columns:1fr auto auto auto; gap:6px; align-items:center;
    background:rgba(255,255,255,.96); border:1px solid #ccc; border-radius:10px; padding:6px 8px;
    box-shadow:0 2px 8px rgba(0,0,0,.15); font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif
  }
  #q{padding:8px;font-size:14px;border-radius:8px;border:1px solid #888}
  #mic,#searchBtn,#lang{padding:8px 10px; font-size:14px; border-radius:8px; border:1px solid #888; background:#fff; cursor:pointer}
  #mic.rec{background:#ffeaea;border-color:#d33}
  #searchBtn[aria-busy="true"]{cursor:progress;opacity:.7}
  /* å€™è£œãƒªã‚¹ãƒˆ */
  #results{
    position:absolute; left:8px; z-index:999; min-width:320px; max-height:45%; overflow:auto; display:none;
    background:#fff; border:1px solid #ddd; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,.15);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif
  }
  #results .item{padding:10px;border-bottom:1px solid #eee;cursor:pointer}
  #results .item:hover{background:#f5f5f5}
  .badge{font-size:11px;color:#333;background:#eee;padding:2px 6px;border-radius:10px;margin-left:6px}

  /* æ¡ˆå†…ãƒ‘ãƒãƒ« */
  #navPanel{
    position:absolute; bottom:10px; left:50%; transform:translateX(-50%); z-index:1050;
    background:rgba(255,255,255,.95); border:1px solid #ccc; border-radius:12px; padding:8px 12px; min-width:260px;
    display:none; flex-direction:column; align-items:center; gap:6px; box-shadow:0 2px 8px rgba(0,0,0,.15);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif
  }
  #arrow{font-size:40px;line-height:1}
  #dirText{font-size:16px;font-weight:600}
  #distText{font-size:18px;font-weight:700}
  #targetName{font-size:14px;color:#333;max-width:70vw;text-align:center}
  #actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}

  /* ã‚¹ãƒ†ãƒƒãƒ—è©³ç´° */
  #steps{
    position:absolute; right:8px; bottom:84px; z-index:1100; width:300px; max-height:45%; overflow:auto; display:none;
    background:rgba(255,255,255,.95); border:1px solid #ccc; border-radius:10px; padding:8px;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif
  }
  #steps h4{margin:0 0 6px 0; font-size:14px}
  #steps .step{padding:6px 4px; border-bottom:1px solid #eee; font-size:13px}
  #steps .step.active{background:#e8f7ff; border-left:3px solid #2ea8ff}

  /* ç¾åœ¨åœ°ã«æˆ»ã‚‹ */
  #recenter{
    position:absolute; right:12px; bottom:12px; z-index:1200; width:48px; height:48px; border-radius:999px;
    display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #bbb; box-shadow:0 2px 8px rgba(0,0,0,.2)
  }

  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  #toast{
    position:absolute; top:70px; left:50%; transform:translateX(-50%); z-index:2000;
    background:rgba(0,0,0,.75); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; display:none;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans JP',sans-serif
  }
</style>
</head>
<body>
<div id="toast" role="status" aria-live="polite"></div>

<div id="panel" role="search" aria-label="search panel">
  <input id="q" type="text" placeholder="åº—åãƒ»åœ°åãƒ»é›»è©±ç•ªå·ãƒ»ä½æ‰€ã‚’å…¥åŠ›" aria-label="æ¤œç´¢èªå¥">
  <button id="mic" title="éŸ³å£°å…¥åŠ›">ğŸ¤</button>
  <button id="searchBtn" title="æ¤œç´¢ã™ã‚‹">æ¤œç´¢</button>
  <select id="lang" title="Language">
    <option value="ja" selected>æ—¥æœ¬èª</option>
    <option value="en">English</option>
    <option value="ko">í•œêµ­ì–´</option>
    <option value="fr">FranÃ§ais</option>
    <option value="de">Deutsch</option>
    <option value="es">EspaÃ±ol</option>
    <option value="zh">ä¸­æ–‡</option>
  </select>
</div>

<div id="results" aria-live="polite"></div>
<div id="map" role="application" aria-label="åœ°å›³"></div>

<div id="navPanel" aria-live="polite">
  <div id="arrow">â†‘</div>
  <div id="dirText">æ–¹å‘ï¼šâ€”</div>
  <div id="distText">â€” m</div>
  <div id="targetName"></div>
  <div id="actions">
    <button id="startNav">æ¡ˆå†…é–‹å§‹</button>
    <button id="stopNav" disabled>åœæ­¢</button>
    <button id="speak">èª­ã¿ä¸Šã’</button>
  </div>
</div>

<button id="recenter" title="ç¾åœ¨åœ°ã¸æˆ»ã‚‹">ğŸ“</button>

<div id="steps">
  <h4 id="stepsTitle">é“æ¡ˆå†…æ‰‹é †</h4>
  <div id="stepsBody"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-VuZ8H6HxZ7Q6OQEiQY6m+yt9Y1/1Xx1bCHHBw36r2nM=" crossorigin="anonymous"></script>
<script>
/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ / i18n ===== */
const I18N={
  ja:{search:'æ¤œç´¢',current:'ç¾åœ¨åœ°',distance:'è·é›¢ï¼šç´„ __m__ m',start:'æ¡ˆå†…é–‹å§‹',stop:'åœæ­¢',speak:'èª­ã¿ä¸Šã’',
      steps:'é“æ¡ˆå†…æ‰‹é †',start_say:'å‡ºç™ºã—ã¾ã™',arrived:'åˆ°ç€ã—ã¾ã—ãŸ',arrived_say:'ç›®çš„åœ°ã«åˆ°ç€ã—ã¾ã—ãŸ',
      go_straight:'ã“ã®ã¾ã¾ç›´é€²',slight_right:'ã‚„ã‚„å³æ–¹å‘',right:'å³æ–¹å‘',sharp_right:'é‹­è§’ã«å³æ–¹å‘',
      slight_left:'ã‚„ã‚„å·¦æ–¹å‘',left:'å·¦æ–¹å‘',sharp_left:'é‹­è§’ã«å·¦æ–¹å‘',back_right:'å¾Œæ–¹å³æ–¹å‘ï¼ˆUã‚¿ãƒ¼ãƒ³æ°—å‘³ï¼‰',back_left:'å¾Œæ–¹å·¦æ–¹å‘ï¼ˆUã‚¿ãƒ¼ãƒ³æ°—å‘³ï¼‰',
      not_supported:'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«æœªå¯¾å¿œã§ã™ã€‚Chromeã§é–‹ãã‹ã€ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ğŸ¤ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚'},
  en:{search:'Search',current:'Current location',distance:'Distance: ~ __m__ m',start:'Start',stop:'Stop',speak:'Speak',
      steps:'Steps',start_say:'Navigation started',arrived:'Arrived',arrived_say:'You have arrived',
      go_straight:'Go straight',slight_right:'Slight right',right:'Right',sharp_right:'Sharp right',
      slight_left:'Slight left',left:'Left',sharp_left:'Sharp left',back_right:'Back-right (U-turn-ish)',back_left:'Back-left (U-turn-ish)'}
};
const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.style.display='block';setTimeout(()=>t.style.display='none',1600);};
const toRad=x=>x*Math.PI/180;
const hav=(a,b,c,d)=>{const R=6371000, dLat=toRad(c-a), dLon=toRad(d-b); const A=Math.sin(dLat/2)**2 + Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(A),Math.sqrt(1-A));};
const brg=(a,b,c,d)=>{const Ï†1=toRad(a),Ï†2=toRad(c),Î»1=toRad(b),Î»2=toRad(d); const y=Math.sin(Î»2-Î»1)*Math.cos(Ï†2); const x=Math.cos(Ï†1)*Math.sin(Ï†2)-Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î»2-Î»1); let Î¸=Math.atan2(y,x)*180/Math.PI; if(Î¸<0)Î¸+=360; return Î¸;};
const arrowFromDelta=d=>{d=((d+540)%360)-180; const A=Math.abs(d); if(A<22.5)return'â†‘'; if(A<67.5)return d>0?'â†—ï¸':'â†–ï¸'; if(A<112.5)return d>0?'â†’':'â†'; if(A<157.5)return d>0?'â†˜ï¸':'â†™ï¸'; return 'â†“';};
const dirText=(L,delta)=>{const d=((delta+540)%360)-180, A=Math.abs(d); if(A<15)return L.go_straight; if(A<45)return d>0?L.slight_right:L.slight_left; if(A<90)return d>0?L.right:L.left; if(A<135)return d>0?L.sharp_right:L.sharp_left; return d>0?L.back_right:L.back_left;};
const speechLocale=l=>({ja:'ja-JP',en:'en-US',ko:'ko-KR',fr:'fr-FR',de:'de-DE',es:'es-ES',zh:'zh-CN'})[l]||'ja-JP';
let currentLang=localStorage.getItem('k_lang')|| (navigator.language||'ja').slice(0,2); if(!I18N[currentLang]) currentLang='ja';
const qEl=document.getElementById('q'), searchBtn=document.getElementById('searchBtn'), mic=document.getElementById('mic'), langSel=document.getElementById('lang');
document.getElementById('lang').value=currentLang;
function applyLang(){const L=I18N[currentLang]; searchBtn.textContent=L.search; document.getElementById('stepsTitle').textContent=L.steps; qEl.placeholder='åº—åãƒ»åœ°åãƒ»é›»è©±ç•ªå·ãƒ»ä½æ‰€ã‚’å…¥åŠ›';}
applyLang();

/* ===== åœ°å›³ï¼ˆã‚¿ã‚¤ãƒ«è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰ ===== */
let map=L.map('map');
const tileCandidates = [
  { url:'https://tile.openstreetmap.org/{z}/{x}/{y}.png', opt:{maxZoom:20, attribution:'&copy; OpenStreetMap contributors'} },
  { url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', opt:{subdomains:'abcd',maxZoom:20, attribution:'&copy; OpenStreetMap &copy; CARTO'} },
  { url:'https://stamen-tiles.a.ssl.fastly.net/terrain/{z}/{x}/{y}.jpg', opt:{maxZoom:18, attribution:'Map tiles &copy; Stamen, Data &copy; OpenStreetMap'} }
];
function attachTileWithFallback(cands, idx=0){
  if(idx>=cands.length){ toast('ã‚¿ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'); return null; }
  const c=cands[idx], layer=L.tileLayer(c.url,c.opt);
  layer.on('tileerror', ()=>{ toast('ã‚¿ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼â†’åˆ¥ã‚½ãƒ¼ã‚¹ã«åˆ‡æ›¿'); if(map.hasLayer(layer)) map.removeLayer(layer); attachTileWithFallback(cands,idx+1); });
  layer.addTo(map); return layer;
}
attachTileWithFallback(tileCandidates);
const DEF=[34.33917,134.05264]; map.setView(DEF,17);

let currentMarker=null, currentLL=null, routeLine=null;
function setCurrent(lat,lon){ currentLL={lat,lon}; if(currentMarker) map.removeLayer(currentMarker); const Ls=(I18N[currentLang]||I18N.ja).current; currentMarker=L.marker([lat,lon],{title:Ls}).addTo(map).bindPopup(Ls); }
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{ setCurrent(p.coords.latitude,p.coords.longitude); map.setView([p.coords.latitude,p.coords.longitude],17); }, _=> map.setView(DEF,16));
} else { map.setView(DEF,16); }
document.getElementById('recenter').onclick=()=>{ if(!currentLL) return toast('ç¾åœ¨åœ°æœªå–å¾—'); map.setView([currentLL.lat,currentLL.lon],18,{animate:true}); };

/* ===== æ¤œç´¢UIã®ä½ç½®èª¿æ•´ï¼ˆè¢«ã‚Šé˜²æ­¢ï¼‰ ===== */
const panel=document.getElementById('panel'), results=document.getElementById('results');
function placeResults(){ const r=panel.getBoundingClientRect(); results.style.top=(r.height+8)+'px'; }
['load','resize'].forEach(ev=>window.addEventListener(ev,placeResults));

/* ===== ãƒ«ãƒ¼ãƒˆè¨ˆç®—ï¼ˆOSRMï¼‰ ===== */
async function fetchRoute(a,b,c,d){
  const url=`https://router.project-osrm.org/route/v1/foot/${b},${a};${d},${c}?overview=full&geometries=geojson&steps=true`;
  const res=await fetch(url,{headers:{'Accept':'application/json'}}); if(!res.ok) throw new Error('OSRM NG'); const data=await res.json();
  if(!data.routes||!data.routes.length) throw new Error('route none');
  const R=data.routes[0]; const coords=R.geometry.coordinates.map(([x,y])=>[y,x]);
  const steps=R.legs[0].steps.map(s=>({name:s.name,distance:s.distance,maneuver:s.maneuver,location:{lat:s.maneuver.location[1],lon:s.maneuver.location[0]}}));
  return {coords,steps};
}
let dest=null, routeSteps=[], activeIdx=0, watchId=null, lastDirSpoken='', lastSpeak=0;
function renderSteps(){
  const L=document.getElementById('stepsBody');
  L.innerHTML=routeSteps.map((s,i)=>{const m=s.maneuver||{}, mod=m.modifier||''; let icon='ç›´é€²';
    if(m.type==='arrive') icon='åˆ°ç€'; else if(mod==='left') icon='å·¦æŠ˜'; else if(mod==='right') icon='å³æŠ˜';
    else if(mod==='slight left') icon='ã‚„ã‚„å·¦'; else if(mod==='slight right') icon='ã‚„ã‚„å³'; else if(mod==='uturn') icon='Uã‚¿ãƒ¼ãƒ³';
    return `<div class="step" id="step-${i}">â–¶ ${icon} : ${s.name||''} (${Math.round(s.distance)} m)</div>`;
  }).join('');
  document.getElementById('steps').style.display='block';
}
function hilite(i){ activeIdx=i; [...document.querySelectorAll('#stepsBody .step')].forEach((el,idx)=> el.classList.toggle('active',idx===i)); }
function nearestStep(lat,lon){ let best=0, bd=1e12; for(let i=0;i<routeSteps.length;i++){const s=routeSteps[i]; const d=hav(lat,lon,s.location.lat,s.location.lon); if(d<bd){bd=d;best=i;}} return best; }

/* ===== æ¡ˆå†… ===== */
const navPanel=document.getElementById('navPanel'), arrowEl=document.getElementById('arrow'), dirTextEl=document.getElementById('dirText'), distEl=document.getElementById('distText'), targetEl=document.getElementById('targetName');
function openNav(name){ targetEl.textContent=name||''; navPanel.style.display='flex'; document.getElementById('startNav').disabled=false; document.getElementById('stopNav').disabled=true; }
function speak(t){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(t); u.lang=speechLocale(currentLang); speechSynthesis.cancel(); speechSynthesis.speak(u); }

document.getElementById('startNav').onclick=async()=>{
  if(!dest) return alert('ç›®çš„åœ°ã‚’é¸æŠã—ã¦ãã ã•ã„');
  document.getElementById('startNav').disabled=true; document.getElementById('stopNav').disabled=false;
  if(currentLL) map.setView([currentLL.lat,currentLL.lon],18,{animate:true});
  speak((I18N[currentLang]||I18N.ja).start_say);
  const lat0=currentLL?currentLL.lat:DEF[0], lon0=currentLL?currentLL.lon:DEF[1];
  try{
    const r=await fetchRoute(lat0,lon0,dest.lat,dest.lon);
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline(r.coords,{color:'#1976d2',weight:5,opacity:.9}).addTo(map);
    routeSteps=r.steps; renderSteps(); hilite(0);
    lastDirSpoken=''; lastSpeak=0;
  }catch{
    routeSteps=[];
    if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[lat0,lon0],[dest.lat,dest.lon]],{color:'#2ecc71',weight:4,opacity:.8}).addTo(map);
  }
  if(!navigator.geolocation) return alert('Geolocationæœªå¯¾å¿œ');
  watchId=navigator.geolocation.watchPosition(p=>{
    setCurrent(p.coords.latitude,p.coords.longitude);
    const trg=routeSteps.length?routeSteps[nearestStep(p.coords.latitude,p.coords.longitude)].location:dest;
    const br=brg(p.coords.latitude,p.coords.longitude,trg.lat,trg.lon);
    const heading=(p.coords.heading!=null && p.coords.heading>=0)?p.coords.heading:0;
    const delta=br-heading;
    arrowEl.textContent=arrowFromDelta(delta);
    const Lx=I18N[currentLang]||I18N.ja, dText=dirText(Lx,delta);
    dirTextEl.textContent='æ–¹å‘ï¼š'+dText;
    const d=hav(p.coords.latitude,p.coords.longitude,dest.lat,dest.lon); distEl.textContent=(Lx.distance||'Distance: ~ __m__ m').replace('__m__',Math.round(d));
    if(routeSteps.length){ const idx=nearestStep(p.coords.latitude,p.coords.longitude); if(idx!==activeIdx) hilite(idx); }
    const now=Date.now(); if(dText!==lastDirSpoken && now-lastSpeak>3000){ speak(dText); lastDirSpoken=dText; lastSpeak=now; }
    if(d<5){ document.getElementById('stopNav').click(); distEl.textContent=(Lx.arrived||'Arrived'); speak((Lx.arrived_say||'åˆ°ç€ã—ã¾ã—ãŸ')+'ã€‚'+(dest.name||'')); }
  },err=>console.warn('watch error',err),{enableHighAccuracy:true,maximumAge:1000,timeout:10000});
};
document.getElementById('stopNav').onclick=()=>{ if(watchId!=null){navigator.geolocation.clearWatch(watchId); watchId=null;} document.getElementById('startNav').disabled=false; document.getElementById('stopNav').disabled=true; };
document.getElementById('speak').onclick=()=>{ if(!dest||!currentLL) return; const br=brg(currentLL.lat,currentLL.lon,dest.lat,dest.lon); const Lx=I18N[currentLang]||I18N.ja; const dText=dirText(Lx,br); const d=hav(currentLL.lat,currentLL.lon,dest.lat,dest.lon); speak(dText+'ã€‚'+(Lx.distance||'').replace('__m__',Math.round(d)).replace('è·é›¢ï¼šç´„ ','')); };

/* ===== æ¤œç´¢ï¼ˆå˜ä¸€å…¥åŠ›ã§è‡ªå‹•åˆ¤åˆ¥ï¼‰ ===== */
langSel.onchange=()=>{ currentLang=langSel.value; localStorage.setItem('k_lang',currentLang); applyLang(); if(recog) recog.lang=speechLocale(currentLang); placeResults(); };

function busy(b){ if(b){searchBtn.setAttribute('aria-busy','true'); searchBtn.textContent='æ¤œç´¢ä¸­â€¦'; searchBtn.disabled=true;} else {searchBtn.removeAttribute('aria-busy'); searchBtn.textContent=(I18N[currentLang]||I18N.ja).search; searchBtn.disabled=false;} }
const isPhone=q=>/^[\s+]*[0-9][0-9\s\-()+]{5,}$/.test(q);
const isAddr=q=>/(ã€’?\d{3}\-?\d{4})|(åŒ—æµ·é“|éƒ½|é“|åºœ|çœŒ)|([å¸‚åŒºç”ºæ‘éƒ¡])|(ä¸ç›®|ç•ªåœ°|å·)|\d+\-\d+/.test(q);
function showResults(items){
  placeResults();
  if(!Array.isArray(items)) items=[];
  if(items.length===1){const it=items[0]; results.style.display='none'; focus(it.lat,it.lon,it.name,it.info,true); return;}
  if(!items.length){results.style.display='none'; toast('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'); return;}
  results.innerHTML=items.map(it=>`<div class="item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${(it.name||'').replace(/</g,'&lt;')}" data-info="${(it.info||'').replace(/</g,'&lt;')}">
      <div><b>${it.name||''}</b>${it.badge?`<span class="badge">${it.badge}</span>`:''}</div>
      <div style="font-size:12px;color:#555">${it.info||''}</div></div>`).join('');
  results.style.display='block';
  [...results.querySelectorAll('.item')].forEach(el=>el.onclick=()=>{results.style.display='none'; focus(parseFloat(el.dataset.lat),parseFloat(el.dataset.lon),el.dataset.name,el.dataset.info,true);});
}
function focus(lat,lon,name,info,open){
  dest={lat,lon,name};
  const m=L.marker([lat,lon]).addTo(map).bindPopup('<b>'+name+'</b>'+(info?'<br>'+info:'')); m.openPopup(); map.setView([lat,lon],18);
  if(currentMarker){const cl=currentMarker.getLatLng(); if(routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[cl.lat,cl.lng],[lat,lon]],{color:'#2ecc71',weight:4,opacity:.8}).addTo(map);
    distEl.textContent=(I18N[currentLang].distance||'Distance: ~ __m__ m').replace('__m__',Math.round(hav(cl.lat,cl.lng,lat,lon)));
  }
  if(open) openNav(name);
}

function withTimeout(p,ms=12000){return new Promise((ok,ng)=>{const id=setTimeout(()=>ng(new Error('timeout')),ms); p.then(v=>{clearTimeout(id);ok(v);},e=>{clearTimeout(id);ng(e);});});}
async function j(url,opt={}){const r=await withTimeout(fetch(url,opt)); const ct=r.headers.get('content-type')||''; if(!ct.includes('application/json')) throw new Error('éJSONå¿œç­”'); return r.json(); }
async function overpass(q){const bases=['https://overpass-api.de/api/interpreter','https://z.overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter']; let last; for(const b of bases){try{return await j(b+'?data='+encodeURIComponent(q));}catch(e){last=e;}} throw last||new Error('Overpasså¤±æ•—');}

async function searchNearby(lat,lon,r,kw){
  const nf=kw?`[name~"{kw}",i]`:''; const Q=(`
[out:json][timeout:25];
(
  node(around:${r},${lat},${lon})${nf}[~"^(shop|amenity)$"~".*"];
  way(around:${r},${lat},${lon})${nf}[~"^(shop|amenity)$"~".*"];
); out center 60;`).replace('{kw}',kw.replace(/"/g,'\\"'));
  const js=await overpass(Q);
  const items=(js.elements||[]).map(el=>{
    const c=el.center||(el.type==='node'?{lat:el.lat,lon:el.lon}:null); if(!c)return null;
    const t=el.tags||{}; const name=t['name:ja']||t.name||'(åç§°æœªè¨­å®š)';
    const info=[t['addr:full'],t['name:en'],t['addr:street']].filter(Boolean).join(' / ');
    const badge=t.shop||t.amenity||'æ–½è¨­'; return {lat:c.lat,lon:c.lon,name,info,badge};
  }).filter(Boolean);
  showResults(items.slice(0,60));
}
async function searchPhone(lat,lon,r,raw){
  const d=(raw||'').replace(/[^0-9+]/g,'');
  const Q=`
[out:json][timeout:25];
(
 node(around:${r},${lat},${lon})[phone~"${d}"];
 node(around:${r},${lat},${lon})["contact:phone"~"${d}"];
 way(around:${r},${lat},${lon})[phone~"${d}"];
 way(around:${r},${lat},${lon})["contact:phone"~"${d}"];
); out center 40;`;
  const js=await overpass(Q);
  const items=(js.elements||[]).map(el=>{
    const c=el.center||(el.type==='node'?{lat:el.lat,lon:el.lon}:null); if(!c)return null;
    const t=el.tags||{}; const name=t['name:ja']||t.name||'(åç§°æœªè¨­å®š)'; const info=[t.phone,t['contact:phone']].filter(Boolean).join(' / ');
    return {lat:c.lat,lon:c.lon,name,info,badge:'é›»è©±'};
  }).filter(Boolean);
  showResults(items.slice(0,40));
}
async function searchAddr(q,bias){
  const ref=bias||(currentLL||{lat:DEF[0],lon:DEF[1]});
  try{
    const url='https://photon.komoot.io/api/?'+new URLSearchParams({q,lang:currentLang,limit:'15',lat:String(ref.lat),lon:String(ref.lon)});
    const j1=await j(url,{headers:{Accept:'application/json'}});
    const items=(j1.features||[]).map(f=>{
      const [lo,la]=f.geometry.coordinates; const p=f.properties||{};
      const name=p.name||[p.city,p.street,p.housenumber].filter(Boolean).join(' ')||p.country||'(ä¸æ˜)';
      const info=[p.country,p.state,p.city,p.district,p.street,p.housenumber].filter(Boolean).join(' / ');
      return {lat:la,lon:lo,name,info,badge:'ä½æ‰€'};
    });
    if(items.length){showResults(items); return;}
  }catch{}
  try{
    const url='https://nominatim.openstreetmap.org/search?'+new URLSearchParams({
      q,format:'jsonv2',addressdetails:'1',limit:'15',countrycodes:'jp','accept-language':currentLang+',ja,en',
      viewbox:[(ref.lon-0.05).toFixed(6),(ref.lat+0.05).toFixed(6),(ref.lon+0.05).toFixed(6),(ref.lat-0.05).toFixed(6)].join(','),bounded:'1'
    });
    const j2=await j(url,{headers:{Accept:'application/json'}});
    const items=(j2||[]).map(r=>{
      const la=parseFloat(r.lat), lo=parseFloat(r.lon), a=r.address||{};
      const name=r.display_name||[a.state,a.city||a.town||a.village,a.road,a.house_number].filter(Boolean).join(' ');
      const info=[a.postcode,a.state,a.city||a.town||a.village,a.road,a.house_number].filter(Boolean).join(' / ');
      return {lat:la,lon:lo,name,info,badge:'ä½æ‰€'};
    });
    showResults(items);
  }catch(e){alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: '+(e&&e.message?e.message:e));}
}
async function doSearch(){
  const q=qEl.value.trim(); if(!q){qEl.focus(); return;}
  busy(true); results.style.display='none';
  const lat=currentLL?currentLL.lat:DEF[0], lon=currentLL?currentLL.lon:DEF[1];
  try{
    if(isPhone(q)) await searchPhone(lat,lon,1200,q);
    else if(isAddr(q)) await searchAddr(q,{lat,lon});
    else await searchNearby(lat,lon,800,q);
  } finally { busy(false); }
}
searchBtn.onclick=doSearch; qEl.addEventListener('keydown',e=>{ if(e.key==='Enter') doSearch(); });

/* ===== éŸ³å£°å…¥åŠ›ï¼ˆAndroidå‘ã‘ PTT + äº‹å‰æ¨©é™ã‚¦ã‚©ãƒ¼ãƒ ï¼‰ ===== */
let recog=null, primed=false;
(function(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ mic.onclick=()=>alert((I18N[currentLang]||I18N.ja).not_supported); return; }
  recog=new SR(); recog.lang=speechLocale(currentLang); recog.interimResults=false; recog.continuous=false; recog.maxAlternatives=1;
  recog.onresult=e=>{ qEl.value=e.results[0][0].transcript; setTimeout(()=>doSearch(),30); };
  recog.onerror=e=>{
    if(e.error==='not-allowed'||e.error==='service-not-allowed'){
      alert('ãƒã‚¤ã‚¯ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ğŸ”’â†’æ¨©é™â†’ãƒã‚¤ã‚¯ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\nã‚¢ãƒ—ãƒªå†…ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ãªãChromeã§é–‹ã„ã¦ãã ã•ã„ã€‚');
    } else if(e.error==='no-speech'||e.error==='audio-capture'){ toast('éŸ³å£°ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ'); } else { toast('éŸ³å£°ã‚¨ãƒ©ãƒ¼: '+e.error); }
    mic.classList.remove('rec');
  };
  recog.onend=()=>mic.classList.remove('rec');
  async function prime(){ if(primed||!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) return true;
    try{const s=await navigator.mediaDevices.getUserMedia({audio:true}); s.getTracks().forEach(t=>t.stop()); primed=true; return true;}catch{return false;}
  }
  let on=false;
  const start=async()=>{ await prime(); if(on){try{recog.stop();}catch{} return;} on=true; mic.classList.add('rec'); try{recog.start();}catch{on=false; mic.classList.remove('rec');} };
  const stop =()=>{ if(!on) return; try{recog.stop();}catch{} on=false; };
  mic.addEventListener('click',start);
  mic.addEventListener('mousedown',start); mic.addEventListener('mouseup',stop); mic.addEventListener('mouseleave',stop);
  mic.addEventListener('touchstart',e=>{e.preventDefault();start();},{passive:false});
  mic.addEventListener('touchend',e=>{e.preventDefault();stop();},{passive:false});
})();

/* ===== é–‹ç™ºæ™‚ã® file:// è­¦å‘Š ===== */
if(location.protocol==='file:'){
  alert('file:// ã§é–‹ã„ã¦ã„ã¾ã™ã€‚åœ°å›³/éŸ³å£°/ç¾åœ¨åœ°ãŒåˆ¶é™ã•ã‚Œã¾ã™ã€‚å¿…ãš https:// ã¾ãŸã¯ http://localhost ã§é–‹ã„ã¦ãã ã•ã„ã€‚');
}
</script>
</body>
</html>
