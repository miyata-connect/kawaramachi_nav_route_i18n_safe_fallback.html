<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>高松・瓦町 多言語徒歩ナビ</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<style>
  html, body, #map { height: 100%; margin: 0; }
  #panel {
    position: absolute; top: 8px; left: 8px; right: 8px; z-index: 1000;
    display: grid; grid-template-columns: 1fr auto auto auto; gap: 6px;
    align-items: center;
    background: rgba(255,255,255,0.96); border: 1px solid #ccc; border-radius: 10px;
    padding: 6px 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
  }
  #q { grid-column: 1 / 2; padding: 8px; font-size: 14px; border-radius:8px; border:1px solid #888; }
  #mic, #searchBtn, #lang { padding: 8px 10px; font-size: 14px; border-radius: 8px; border: 1px solid #888; background:#fff; cursor: pointer; }
  #searchBtn[aria-busy="true"] { cursor: progress; opacity:.7; }
  #results {
    position: absolute; left: 8px; z-index: 999;
    background: #fff; border: 1px solid #ddd; border-radius: 8px; display: none; min-width: 320px;
    max-height: 45%; overflow: auto; box-shadow: 0 4px 12px rgba(0,0,0,.15);
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
  }
  #results .item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
  #results .item:hover { background: #f5f5f5; }
  .badge { font-size: 11px; color: #333; background:#eee; padding: 2px 6px; border-radius: 10px; margin-left: 6px; }

  #navPanel {
    position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1050;
    background: rgba(255,255,255,0.95); border: 1px solid #ccc; border-radius: 12px; padding: 8px 12px;
    display: none; flex-direction: column; align-items: center; gap: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15); min-width: 260px;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
  }
  #arrow { font-size: 40px; line-height: 1; }
  #dirText { font-size:16px; font-weight:600; }
  #distText { font-size: 18px; font-weight: 700; }
  #targetName { font-size: 14px; color: #333; max-width: 70vw; text-align: center; }
  #actions { display:flex; gap:8px; flex-wrap: wrap; justify-content:center; }

  #steps {
    position: absolute; right: 8px; bottom: 84px; z-index: 1100;
    background: rgba(255,255,255,0.95); border:1px solid #ccc; border-radius: 10px; padding:8px;
    width: 300px; max-height: 45%; overflow:auto; display:none;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
  }
  #steps h4 { margin: 0 0 6px 0; font-size: 14px; }
  #steps .step { padding:6px 4px; border-bottom:1px solid #eee; font-size:13px; }
  #steps .step.active { background:#e8f7ff; border-left: 3px solid #2ea8ff; }

  #toast {
    position:absolute; top:70px; left:50%; transform: translateX(-50%);
    background:rgba(0,0,0,0.75); color:#fff; padding:8px 12px; border-radius:10px; font-size:13px; z-index:2000; display:none;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans JP', sans-serif;
  }

  #recenter {
    position: absolute; right: 12px; bottom: 12px; z-index: 1200;
    border-radius: 999px; width: 48px; height: 48px; display:flex; align-items:center; justify-content:center;
    background:#fff; border:1px solid #bbb; box-shadow: 0 2px 8px rgba(0,0,0,.2);
  }

  #mic.rec { background:#ffeaea; border-color:#d33; }
</style>
</head>
<body>
<div id="toast" role="status" aria-live="polite"></div>

<!-- 検索パネル（検索モードは廃止。入力ひとつ） -->
<div id="panel" role="search" aria-label="search panel">
  <input id="q" type="text" placeholder="店名・地名・電話番号・住所を入力" aria-label="検索語句" />
  <button id="mic" title="音声入力">🎤</button>
  <button id="searchBtn" title="検索する">検索</button>
  <select id="lang" title="Language">
    <option value="ja" selected>日本語</option>
    <option value="en">English</option>
    <option value="ko">한국어</option>
    <option value="fr">Français</option>
    <option value="de">Deutsch</option>
    <option value="es">Español</option>
    <option value="zh">中文</option>
  </select>
</div>

<div id="results" aria-live="polite"></div>
<div id="map" role="application" aria-label="地図"></div>

<div id="navPanel" aria-live="polite">
  <div id="arrow">↑</div>
  <div id="dirText">方向：—</div>
  <div id="distText">— m</div>
  <div id="targetName"></div>
  <div id="actions">
    <button id="startNav">案内開始</button>
    <button id="stopNav" disabled>停止</button>
    <button id="speak">読み上げ</button>
  </div>
</div>

<button id="recenter" title="現在地へ戻る">📍</button>

<div id="steps">
  <h4 id="stepsTitle">道案内手順</h4>
  <div id="stepsBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
<script>
/* ===== i18n（必要最低限） ===== */
const I18N = {
  ja: { lang:'言語', search:'検索', current:'現在地', distance:'距離：約 __m__ m',
        start:'案内開始', stop:'停止', speak:'読み上げ', steps:'道案内手順',
        start_say:'出発します', arrived:'到着しました', arrived_say:'目的地に到着しました',
        go_straight:'このまま直進', slight_right:'やや右方向', right:'右方向',
        sharp_right:'鋭角に右方向', slight_left:'やや左方向', left:'左方向',
        sharp_left:'鋭角に左方向', back_right:'後方右方向（Uターン気味）', back_left:'後方左方向（Uターン気味）',
        not_supported: 'このブラウザは音声認識に未対応です。Chromeで開くか、キーボードの🎤をご利用ください。'
  },
  en: { search:'Search', current:'Current location', distance:'Distance: ~ __m__ m',
        start:'Start', stop:'Stop', speak:'Speak', steps:'Steps',
        start_say:'Navigation started', arrived:'Arrived', arrived_say:'You have arrived',
        go_straight:'Go straight', slight_right:'Slight right', right:'Right',
        sharp_right:'Sharp right', slight_left:'Slight left', left:'Left',
        sharp_left:'Sharp left', back_right:'Back-right (U-turn-ish)', back_left:'Back-left (U-turn-ish)',
        not_supported: 'Speech recognition not supported. Use Chrome or the keyboard mic.'
  }
};

/* ===== utils ===== */
function showToast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none', 1600); }
function toRad(x){return x*Math.PI/180;}
function haversine(lat1, lon1, lat2, lon2){ const R=6371000; const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
function bearing(lat1, lon1, lat2, lon2){ const φ1=toRad(lat1), φ2=toRad(lat2), λ1=toRad(lon1), λ2=toRad(lon2); const y=Math.sin(λ2-λ1)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(λ2-λ1); let θ=Math.atan2(y,x)*180/Math.PI; if(θ<0) θ+=360; return θ; }
function arrowFromDelta(delta){ delta=((delta+540)%360)-180; const ad=Math.abs(delta); if(ad<22.5) return '↑'; if(ad<67.5) return delta>0?'↗︎':'↖︎'; if(ad<112.5) return delta>0?'→':'←'; if(ad<157.5) return delta>0?'↘︎':'↙︎'; return '↓'; }
function langToSpeechLocale(l){ return ({ja:'ja-JP', en:'en-US', ko:'ko-KR', fr:'fr-FR', de:'de-DE', es:'es-ES', zh:'zh-CN'})[l] || 'ja-JP'; }
function directionTextFromDelta(lang, deltaDeg){
  const L = I18N[lang] || I18N.ja;
  const d = ((deltaDeg + 540) % 360) - 180;
  const ad = Math.abs(d);
  if (ad < 15)  return L.go_straight;
  if (ad < 45)  return d > 0 ? L.slight_right : L.slight_left;
  if (ad < 90)  return d > 0 ? L.right : L.left;
  if (ad < 135) return d > 0 ? L.sharp_right : L.sharp_left;
  return d > 0 ? L.back_right : L.back_left;
}
function distText(m){ const L=I18N[currentLang]||I18N.ja; return (L.distance||'Distance: ~ __m__ m').replace('__m__', Math.round(m)); }
function speakText(text){ if (!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.lang=langToSpeechLocale(currentLang); u.rate=1; u.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(u); }

/* ===== elements & state ===== */
const mapDiv=document.getElementById('map');
const resultsDiv=document.getElementById('results');
const panel=document.getElementById('panel');
const qEl=document.getElementById('q');
const micBtn=document.getElementById('mic');
const searchBtn=document.getElementById('searchBtn');
const langEl=document.getElementById('lang');

const navPanel=document.getElementById('navPanel');
const startBtn=document.getElementById('startNav');
const stopBtn=document.getElementById('stopNav');
const speakBtn=document.getElementById('speak');
const arrowEl=document.getElementById('arrow');
const dirTextEl=document.getElementById('dirText');
const distLabel=document.getElementById('distText');
const targetNameEl=document.getElementById('targetName');

const stepsDiv=document.getElementById('steps');
const stepsBody=document.getElementById('stepsBody');
const stepsTitle=document.getElementById('stepsTitle');

const recenterBtn=document.getElementById('recenter');

let currentLang = localStorage.getItem('kawaramachi_lang') || (navigator.language||'ja').slice(0,2);
if (!(currentLang in I18N)) currentLang = 'ja';
langEl.value = currentLang;

function applyLangUI(){
  const L=I18N[currentLang]||I18N.ja;
  searchBtn.textContent=L.search;
  stepsTitle.textContent=L.steps;
  micBtn.title='音声入力';
  qEl.placeholder='店名・地名・電話番号・住所を入力';
}
applyLangUI();
langEl.addEventListener('change', ()=>{ currentLang = langEl.value; localStorage.setItem('kawaramachi_lang', currentLang); applyLangUI(); if (recog) recog.lang = langToSpeechLocale(currentLang); adjustResultsTop(); });

/* ===== Leaflet ===== */
let map=null, currentMarker=null, routeLine=null;
function initLeaflet(){
  map = L.map('map');
  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom: 20, attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  L.control.scale({imperial:false, maxWidth:150}).addTo(map);
}
initLeaflet();

/* ===== 現在地 ===== */
let currentLL=null;
function setCurrent(lat, lon){
  currentLL = {lat, lon};
  if (currentMarker) map.removeLayer(currentMarker);
  const LSTR=(I18N[currentLang]||I18N.ja).current;
  currentMarker = L.marker([lat,lon], {title:LSTR}).addTo(map).bindPopup(LSTR);
}
if (navigator.geolocation){
  navigator.geolocation.getCurrentPosition(p=>{
    setCurrent(p.coords.latitude, p.coords.longitude);
    map.setView([p.coords.latitude, p.coords.longitude], 17);
  });
}
recenterBtn.addEventListener('click', ()=>{
  if (!currentLL) return showToast('現在地未取得');
  map.setView([currentLL.lat, currentLL.lon], 18, {animate:true});
});

/* ===== 結果の“被り”対策 ===== */
function adjustResultsTop(){
  const rect = panel.getBoundingClientRect();
  resultsDiv.style.top = (rect.height + 8) + 'px';
}
window.addEventListener('resize', adjustResultsTop);
window.addEventListener('load', adjustResultsTop);

/* ===== ルーティング ===== */
async function fetchRoute(lat1,lon1,lat2,lon2){
  const url = `https://router.project-osrm.org/route/v1/foot/${lon1},${lat1};${lon2},${lat2}?overview=full&geometries=geojson&steps=true`;
  const res = await fetch(url, {headers:{'Accept':'application/json'}});
  if (!res.ok) throw new Error('OSRM response not OK');
  const data = await res.json(); if (!data.routes || !data.routes.length) throw new Error('No routes');
  const r = data.routes[0];
  const coords = r.geometry.coordinates.map(([x,y])=>[y,x]);
  const steps = r.legs[0].steps.map(s => ({ name:s.name, distance:s.distance, duration:s.duration, maneuver:s.maneuver, location:{lat:s.maneuver.location[1], lon:s.maneuver.location[0]} }));
  return {coords, steps};
}
let dest=null, routeSteps=[], activeStepIndex=0;
function openNavPanel(name){ targetNameEl.textContent=name||''; navPanel.style.display='flex'; stepsDiv.style.display='none'; startBtn.disabled=false; stopBtn.disabled=true; }
function renderSteps(steps){
  stepsBody.innerHTML = steps.map((s,i)=>{
    const man=s.maneuver||{}; const distStr=Math.round(s.distance)+' m'; const nameStr=(s.name||'');
    const icon = (()=>{
      const type=man.type||'', mod=man.modifier||'';
      if (type==='arrive') return '到着';
      if (type==='turn'||type==='continue'){
        if (mod==='left') return '左折'; if (mod==='right') return '右折';
        if (mod==='slight left') return 'やや左'; if (mod==='slight right') return 'やや右';
        if (mod==='straight'||!mod) return '直進'; if (mod==='uturn') return 'Uターン';
      }
      return '進行';
    })();
    return `<div class="step" id="step-${i}">▶ ${icon} : ${nameStr ? nameStr + ' ' : ''}(${distStr})</div>`;
  }).join('');
  stepsDiv.style.display = 'block';
}
function highlightStep(i){ activeStepIndex=i; Array.from(stepsBody.children).forEach((el,idx)=>el.classList.toggle('active', idx===i)); }
function nearestStepIndex(lat,lon){ if(!routeSteps.length) return 0; let best=0,bd=1e12; for(let i=0;i<routeSteps.length;i++){ const s=routeSteps[i]; const d=haversine(lat,lon,s.location.lat,s.location.lon); if(d<bd){bd=d;best=i;} } return best; }

/* ===== 案内 ===== */
let watchId=null, lastStepAnnounced=-1, lastDirSpoken='', lastDirSpokenTime=0;
async function startNavigation(){
  if (!dest) return alert('目的地を選択してください');
  startBtn.disabled=true; stopBtn.disabled=false;
  if (currentLL) map.setView([currentLL.lat, currentLL.lon], 18, {animate:true});
  speakText((I18N[currentLang]||I18N.ja).start_say);

  const lat0=currentLL?currentLL.lat:34.3398, lon0=currentLL?currentLL.lon:134.0500;
  try {
    const r = await fetchRoute(lat0,lon0,dest.lat,dest.lon);
    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(r.coords,{color:'#1976d2',weight:5,opacity:0.9}).addTo(map);
    routeSteps=r.steps; renderSteps(routeSteps); highlightStep(0);
    lastStepAnnounced=-1; lastDirSpoken=''; lastDirSpokenTime=0;
    navPanel.style.display='flex';
  } catch(e){
    routeSteps=[]; showToast('経路取得に失敗');
    if (routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[lat0,lon0],[dest.lat,dest.lon]],{color:'#2ecc71',weight:4,opacity:0.8}).addTo(map);
    navPanel.style.display='flex';
  }

  if (!navigator.geolocation) return alert('Geolocation未対応');
  watchId = navigator.geolocation.watchPosition(pos=>{
    const lat=pos.coords.latitude, lon=pos.coords.longitude;
    setCurrent(lat,lon);

    const target = routeSteps.length ? routeSteps[nearestStepIndex(lat,lon)].location : dest;
    const br=bearing(lat,lon,target.lat,target.lon);
    const heading=(pos.coords.heading!=null&&pos.coords.heading>=0)?pos.coords.heading:0;
    const delta = br - heading;

    arrowEl.textContent = arrowFromDelta(delta);
    const dirText = directionTextFromDelta(currentLang, delta);
    dirTextEl.textContent = '方向：' + dirText;

    const d=haversine(lat,lon,dest.lat,dest.lon);
    distLabel.textContent=distText(d);

    if (routeSteps.length){
      const idx = nearestStepIndex(lat,lon);
      if (idx !== activeStepIndex){ highlightStep(idx); }
      if (idx !== lastStepAnnounced){ speakText(dirText); lastStepAnnounced = idx; }
    }
    const now = Date.now();
    if (dirText !== lastDirSpoken && now - lastDirSpokenTime > 3000){
      speakText(dirText); lastDirSpoken=dirText; lastDirSpokenTime=now;
    }
    if (d < 5){
      stopNavigation();
      const L = I18N[currentLang] || I18N.ja;
      distLabel.textContent = L.arrived;
      speakText((L.arrived_say||'到着しました') + '。' + (dest.name||''));
    }
  }, err=>{ console.warn('watchPosition error',err); }, {enableHighAccuracy:true, maximumAge:1000, timeout:10000});
}
function stopNavigation(){ if (watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; } startBtn.disabled=false; stopBtn.disabled=true; }
startBtn.addEventListener('click', startNavigation);
stopBtn.addEventListener('click', stopNavigation);
speakBtn.addEventListener('click', ()=>{
  if (!dest || !currentLL) return;
  const target = routeSteps.length ? routeSteps[nearestStepIndex(currentLL.lat,currentLL.lon)].location : dest;
  const br=bearing(currentLL.lat,currentLL.lon, target.lat, target.lon);
  const dirText = directionTextFromDelta(currentLang, br);
  const d=haversine(currentLL.lat,currentLL.lon,dest.lat,dest.lon);
  speakText(dirText + '。' + distText(d).replace('距離：約 ','').replace('Distance: ~ ',''));
});

/* ===== 音声入力：安定化（PTT＋クリック、事前権限オプション） ===== */
let recog=null;
let micPrimed=false; // getUserMediaで事前に権限を取ったか
(function initSpeech(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) {
    micBtn.addEventListener('click', ()=>alert((I18N[currentLang]||I18N.ja).not_supported));
    return;
  }
  recog = new SR();
  recog.lang = langToSpeechLocale(currentLang);
  recog.interimResults = false;
  recog.continuous = false;
  recog.maxAlternatives = 1;

  let recognizing=false;
  recog.onresult = (e) => { qEl.value = e.results[0][0].transcript; setTimeout(()=>doSearch(), 30); };
  recog.onerror = (e) => {
    if (e.error === 'not-allowed' || e.error === 'service-not-allowed') {
      alert('マイクが許可されていません。アドレスバーの🔒→権限→マイクを許可してください。\nまた、アプリ内ブラウザではなくChromeで開いてください。');
    } else if (e.error === 'no-speech' || e.error === 'audio-capture') {
      showToast('音声が取得できませんでした。もう一度お試しください。');
    } else {
      showToast('音声エラー: ' + e.error);
    }
    recognizing=false; micBtn.classList.remove('rec');
  };
  recog.onend = ()=>{ recognizing=false; micBtn.classList.remove('rec'); };

  // 事前権限（任意）。初回のみ実行してマイク権限を先に確保するとAndroidで安定しやすい
  async function primeMic(){
    if (micPrimed || !navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) return true;
    try {
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      stream.getTracks().forEach(t=>t.stop());
      micPrimed = true;
      return true;
    } catch(e){
      // 権限拒否でも後段のSpeechRecognitionで再挑戦できるので続行
      return false;
    }
  }

  const startRec = async ()=>{
    await primeMic();
    if (recognizing) { try{recog.stop();}catch{} return; }
    recognizing=true; micBtn.classList.add('rec');
    try{recog.start();}catch{recognizing=false; micBtn.classList.remove('rec');}
  };
  const stopRec  = ()=>{ if (!recognizing) return; try{recog.stop();}catch{} };

  micBtn.addEventListener('click', startRec);
  micBtn.addEventListener('mousedown', startRec);
  micBtn.addEventListener('mouseup', stopRec);
  micBtn.addEventListener('mouseleave', stopRec);
  micBtn.addEventListener('touchstart', (e)=>{ e.preventDefault(); startRec(); }, {passive:false});
  micBtn.addEventListener('touchend',   (e)=>{ e.preventDefault(); stopRec(); },   {passive:false});
})();

/* ===== フェッチ共通（タイムアウト＋リトライ付き） ===== */
function withTimeout(promise, ms=12000){
  return new Promise((resolve, reject)=>{
    const id=setTimeout(()=>reject(new Error('timeout')), ms);
    promise.then(v=>{ clearTimeout(id); resolve(v); }, e=>{ clearTimeout(id); reject(e); });
  });
}
async function fetchJSON(url, opt={}) {
  const res = await withTimeout(fetch(url, opt));
  const ct = res.headers.get('content-type')||'';
  if (!ct.includes('application/json')) {
    const text = await res.text();
    throw new Error(`非JSON応答 (${res.status}) : ${text.slice(0,120)}…`);
  }
  return await res.json();
}
async function fetchOverpass(query) {
  const mirrors = [
    'https://overpass-api.de/api/interpreter',
    'https://z.overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter'
  ];
  let lastErr;
  for (const base of mirrors) {
    try {
      const url = base + '?data=' + encodeURIComponent(query);
      return await fetchJSON(url, { headers: { 'Accept': 'application/json' }});
    } catch (e) { lastErr = e; }
  }
  throw lastErr || new Error('Overpass 全ミラー失敗');
}

/* ===== 検索（単一入力→自動判別） ===== */
searchBtn.addEventListener('click', doSearch);
qEl.addEventListener('keydown', e=>{ if (e.key==='Enter') doSearch(); });

function startBusy(btn){ btn.setAttribute('aria-busy','true'); btn.textContent='検索中…'; btn.disabled=true; }
function endBusy(btn){ const L=I18N[currentLang]||I18N.ja; btn.removeAttribute('aria-busy'); btn.textContent=L.search; btn.disabled=false; }

function isPhoneQuery(q){ return /^[\s+]*[0-9][0-9\s\-()+]{5,}$/.test(q); }
function isLikelyAddress(q){
  // 郵便番号・都道府県・市区町村・丁目番地っぽい記号の有無で判定
  return /(〒?\d{3}\-?\d{4})|(北海道|都|道|府|県)|([市区町村郡])|(丁目|番地|号)|\d+\-\d+/.test(q);
}

async function doSearch(){
  const q = qEl.value.trim();
  if (!q){ qEl.focus(); return; }
  startBusy(searchBtn);
  resultsDiv.style.display='none';

  const lat = currentLL ? currentLL.lat : 34.3398;
  const lon = currentLL ? currentLL.lon : 134.0500;

  try {
    if (isPhoneQuery(q)) {
      await searchPhone(lat, lon, 1200, q);
    } else if (isLikelyAddress(q)) {
      await searchAddress(q, {lat, lon});
    } else {
      await searchNearby(lat, lon, 800, q);
    }
  } catch(e){
    alert('検索エラー: ' + (e && e.message ? e.message : e));
  } finally {
    endBusy(searchBtn);
  }
}

function showResults(items){
  adjustResultsTop();
  if (!Array.isArray(items)) items = [];
  if (items.length === 1){
    const it = items[0];
    resultsDiv.style.display='none';
    focusResult(it.lat, it.lon, it.name, it.info, true);
    return;
  }
  if (items.length === 0){
    resultsDiv.style.display='none';
    showToast('見つかりませんでした');
    return;
  }
  resultsDiv.innerHTML = items.map((it) => {
    const safeName = (it.name||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    const safeInfo = (it.info||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    return `
      <div class="item" data-lat="${it.lat}" data-lon="${it.lon}" data-name="${safeName}" data-info="${safeInfo}">
        <div><b>${safeName}</b>${it.badge?'<span class="badge">'+it.badge+'</span>':''}</div>
        <div style="font-size:12px;color:#555">${safeInfo}</div>
      </div>`;
  }).join('');
  resultsDiv.style.display = 'block';
  Array.from(resultsDiv.querySelectorAll('.item')).forEach(el => el.addEventListener('click', () => {
    const lat = parseFloat(el.getAttribute('data-lat'));
    const lon = parseFloat(el.getAttribute('data-lon'));
    const name = el.getAttribute('data-name');
    const info = el.getAttribute('data-info');
    resultsDiv.style.display='none';
    focusResult(lat, lon, name, info, true);
  }));
}

async function searchNearby(lat, lon, radius, keyword){
  const around = radius;
  const nameFilter = keyword ? `[name~"{keyword}",i]` : '';
  const query = `
    [out:json][timeout:25];
    (
      node(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
      way(around:{around},{lat},{lon}){nameFilter}[~"^(shop|amenity)$"~".*"];
    );
    out center 60;
  `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon)
   .replace(/{nameFilter}/g, nameFilter).replace(/{keyword}/g, (keyword||'').replace(/"/g,'\\"'));
  const json = await fetchOverpass(query);
  const items = (json.elements || []).map(el=>{
    const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
    if (!center) return null;
    const t = el.tags || {};
    const name = t['name:ja'] || t.name || '(名称未設定)';
    const info = [t['addr:full'], t['name:en'], t['addr:street']].filter(Boolean).join(' / ');
    const badge = t.shop || t.amenity || '施設';
    return {lat:center.lat, lon:center.lon, name, info, badge};
  }).filter(Boolean);
  showResults(items.slice(0,60));
}

async function searchPhone(lat, lon, radius, phoneRaw){
  const digits = (phoneRaw||'').replace(/[^0-9+]/g,'');
  if (!digits) { alert('電話番号を入力してください'); return; }
  const around = radius;
  const query = `
    [out:json][timeout:25];
    (
      node(around:{around},{lat},{lon})[phone~"{digits}"];
      node(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
      way(around:{around},{lat},{lon})[phone~"{digits}"];
      way(around:{around},{lat},{lon})["contact:phone"~"{digits}"];
    );
    out center 40;
  `.replace(/{around}/g, around).replace(/{lat}/g, lat).replace(/{lon}/g, lon).replace(/{digits}/g, digits);
  const json = await fetchOverpass(query);
  const items = (json.elements || []).map(el=>{
    const center = el.center || (el.type==='node'?{lat:el.lat, lon:el.lon}:null);
    if (!center) return null;
    const t = el.tags || {};
    const name = t['name:ja'] || t.name || '(名称未設定)';
    const info = [t.phone, t['contact:phone']].filter(Boolean).join(' / ');
    return {lat:center.lat, lon:center.lon, name, info, badge:'電話'};
  }).filter(Boolean);
  showResults(items.slice(0,40));
}

async function searchAddress(q, bias){
  const ref = bias || (currentLL || {lat:34.3398, lon:134.0500});
  try {
    const url1 = 'https://photon.komoot.io/api/?' + new URLSearchParams({
      q, lang: currentLang, limit: '15', lat: String(ref.lat), lon: String(ref.lon)
    }).toString();
    const j1 = await fetchJSON(url1, { headers: { 'Accept': 'application/json' } });
    let items = (j1.features || []).map(f=>{
      const [lon,lat] = f.geometry.coordinates;
      const p = f.properties || {};
      const name = p.name || [p.city, p.street, p.housenumber].filter(Boolean).join(' ') || p.country || '(不明)';
      const info = [p.country, p.state, p.city, p.district, p.street, p.housenumber].filter(Boolean).join(' / ');
      return { lat, lon, name, info, badge:'住所' };
    });
    if (items.length){ showResults(items); return; }
  } catch(e){ /* fallbackへ */ }

  try {
    const url2 = 'https://nominatim.openstreetmap.org/search?' + new URLSearchParams({
      q,
      format: 'jsonv2',
      addressdetails: '1',
      limit: '15',
      countrycodes: 'jp',
      'accept-language': currentLang+',ja,en',
      viewbox: [
        (ref.lon-0.05).toFixed(6), (ref.lat+0.05).toFixed(6),
        (ref.lon+0.05).toFixed(6), (ref.lat-0.05).toFixed(6)
      ].join(','),
      bounded: '1'
    }).toString();
    const j2 = await fetchJSON(url2, { headers: { 'Accept': 'application/json' } });
    const items2 = (j2 || []).map(r=>{
      const lat = parseFloat(r.lat), lon = parseFloat(r.lon);
      const a = r.address || {};
      const name = r.display_name || [a.state, a.city || a.town || a.village, a.road, a.house_number].filter(Boolean).join(' ');
      const info = [a.postcode, a.state, a.city||a.town||a.village, a.road, a.house_number].filter(Boolean).join(' / ');
      return { lat, lon, name, info, badge:'住所' };
    });
    showResults(items2);
  } catch(e2){
    alert('検索エラー: ' + (e2 && e2.message ? e2.message : e2));
  }
}

/* ===== 目的地フォーカス ===== */
function focusResult(lat, lon, name, info, showNav){
  dest = {lat, lon, name};
  const m=L.marker([lat,lon]).addTo(map).bindPopup('<b>'+name+'</b>'+(info?'<br>'+info:'')); m.openPopup(); map.setView([lat,lon], 18);
  if (currentMarker){
    const cl=currentMarker.getLatLng();
    if (routeLine) map.removeLayer(routeLine);
    routeLine=L.polyline([[cl.lat,cl.lng],[lat,lon]], {color:'#2ecc71', weight:4, opacity:0.8}).addTo(map);
    distLabel.textContent = distText(haversine(cl.lat,cl.lng,lat,lon));
  }
  if (showNav) openNavPanel(name);
}
</script>
</body>
</html>

