# Walk Nav サーバ仕様（上書き版 / SPEC.md）

発行日：2025-10-22 (Asia/Tokyo)  
対象：Cloudflare Worker（`worker.js`）が提供する API 群  
バージョン：v1（上書き確定版）  
更新版：v0.2.0（/v1/incidents v1 追加）

## 注意事項  

-- 移動中に停止した際にも通信線を保つため、数分ごとに少量のパケットを送信して通信を継続します。ユーザー設定でこの機能のオン/オフを選択できるようにし、バッテリー消費への影響を最小限に抑えます。
 緊急時や通信環境が不安定な場合、アプリはオフライン地図データに基づいてナビゲーションを行いますが、モバイルデータ通信を利用する際には通信料金が発生する場合があります。Wi‑Fi 接続時に事前に地図データをダウンロードすることを推奨します。  
- アプリ起動時には最新の地図・天候情報を取得するために最小限のバックグラウンド通信を行います。通信が許可されているネットワーク（Wi‑Fi のみ、または 4G/5G 固定囲系回算）をユーザー設定から選択できるようにし、起動時にバックグラウンド通信が行われる方式を表示します。
---

## 1. 概要

- 目的：徒歩ナビ用の軽量 API を安全・低コスト・低レイテンシで提供。  
- 提供エンドポイント：  
  - `GET /v1/health` …… 稼働/疎通確認  
  - `POST /v1/places` …… Google Places (New) の `places:searchText` プロキシ  
  - `GET /v1/weather` …… Open-Meteo 多時刻天気（**今 / +3h / +6h**, 日本語対応, 5分キャッシュ）  
  - `GET /v1/incidents` …… 周辺道路・通行止情報（Open Data / Provider混合, TTL=300）  
- UI/クライアントの見た目・文言は不要（本仕様はサーバ API と内部アルゴリズムのみ対象）。

---

## 2. 表記ルール

- `[ ]`: 値域、`{ }`: 補足、`"`: JSON構造、`' '`: リテラル。  
- 時刻は ISO 8601 + TZ（例 `"2025-10-22T08:00:00+09:00"`）。  
- 日本語コメントはサーバ実装には含めずドキュメントのみ。  

---

## 3. `/v1/health`

### 概要
稼働監視用の軽量エンドポイント。

**Response**
```json
{ "status": "ok", "uptimeSec": 12345 }

## 9. 緊急時およびオフライン対応  
- **オフライン地図表示**: 緊急時に通信ができない状況下でも徒歩ナビを継続できるよう、事前にダウンロードした地図データを用いてオフラインでも案内を提供する。  
- **地図データのダウンロード範囲**: 利用者が任意に選択できるよう、現在地を中心とした半径5kmおよび10kmの地図データをダウンロードできる機能を提供する。ダウンロードは Wi‑Fi 接続時、または 4G/5G 通信時にユーザーが選択して実行可能とする。  
- **設定項目の追加**: 上記オフライン機能に対応するため、アプリ設定に以下の項目を新設する。  
  - オフライン地図ダウンロードの有効/無効切り替え。  
  - ダウンロード範囲の選択（5km / 10km）。  
  - ダウンロード許可ネットワーク（Wi‑Fi のみ／モバイル通信も可）の選択。  
- **緊急避難ルーティング**: 緊急時には現在地から最寄りの避難所を検索し、徒歩ルートを提示できるようにする。避難所データはオフライン地図に含め、通信不能時でも利用できるようにする。  
- **災害用 Wi‑Fi 表示と案内**: 災害時に提供される災害用 Wi‑Fi（例：00000JAPAN）について、利用可能なアクセスポイントの一覧を表示し、現在地からの案内を行えるようにする。Wi‑Fi アクセスポイント情報はダウンロード時に取得しておき、オフラインでも参照できるようにする。

## 対応言語  
- 日本語 (Japanese)  
- 英語 (English)  
- 韓国語 (Korean)  
- 中国語 (Chinese)  
- スペイン語 (Spanish)  
- ドイツ語 (German)  
- フランス語 (French)  
- イタリア語 (Italian)
