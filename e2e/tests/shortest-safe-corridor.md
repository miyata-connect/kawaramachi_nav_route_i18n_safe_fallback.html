# E2E: Shortest（最短）安全帯遵守で最短ルートを選定できる

- Issue: #2
- Mode: `mode:shortest`
- Area: `area:routing`
- Status: `status:ready-for-e2e`
- 最終更新: 2025-10-20

---

## 目的
Shortest（最短ルート）モードで、**安全帯（歩道・横断歩道・歩道橋・地下道・踏切）を厳守**し、歩道のない区間では**路肩歩行を許可**しつつ、最短ルートを正しく提示できることを確認する。

> 備考：モール型の大型店（イオン・ゆめタウン等）の**駐車場および店内通路の歩行は許可**対象（安全帯として扱う）。

---

## 前提条件
- 端末：iOS または Android 最新版
- 位置情報：許可済
- 起動直後の選択：  
  - 「選択したルート案内を優先」を選択（天候回避は未選択）
- 出発地A → 目的地B：**一部で歩道がない区間**を含む現地ペア
- 天候：晴れ
- 事件・事故：なし
- アプリ：Walk-Nav App build X.Y.Z
- ルール定義：`docs/walk-voice-rules.md` の Shortest 改訂に準拠

---

## テスト手順
1. アプリを起動する
2. ルートモードに **Shortest** を選択する
3. 出発地A と 目的地B を設定する
4. ルート検索を実行する
5. 表示されたルートの**凡例**に「歩道」「横断歩道」「歩道橋」「地下道」「踏切」の安全帯が含まれることを確認
6. 歩道のない区間がある場合、**「路肩歩行」区間が明示**されることを確認
7. 全体距離（または所要時間）が、同一の安全帯条件を満たす候補の中で**最短**になっていることを確認
8. **横断方法**が「横断歩道／歩道橋／地下道／踏切」以外になっていないこと（**車道横断の任意横断なし**）
9. ルートの中にモール（イオン等）を経由する場合、**駐車場内／店内通路**の歩行が**許可**されていることを確認（地図上の注記がある場合は注記も確認）
10. ルートヘルスログ（デバッグ）に、`safe_corridor_check = PASS`、`road_shoulder = ALLOWED (when sidewalk_absent)` が記録されることを確認

---

## 期待値（パス条件）
- 安全帯リスト（歩道・横断歩道・歩道橋・地下道・踏切）がいずれもルート内で遵守されている  
- 歩道が無い区間のみ「路肩歩行」を含み、**危険な車道横断は存在しない**  
- 横断は「横断歩道／歩道橋／地下道／踏切」のいずれかで行われる  
- モール（イオン等）経路が含まれる場合でも、**安全帯扱い**としてルートが生成される  
- 表示距離（または所要時間）が候補群の中で**最短**  
- ルートヘルスログに `safe_corridor_check = PASS` を記録

---

## 例外・エッジケース
- 候補がすべて安全帯条件を満たさない場合：  
  → 「該当ルートなし」表示、または**ルール緩和の選択肢**を提示（案内しないデフォルト）
- 地図データ未整備により安全帯タグが欠落：  
  → 車道横断が必要な場合は**最短ルート不採用**、代替候補を提示
- 天候回避へ途中切替時：  
  → **リルート**で天候回避優先に再計算。Shortest の期待値はこのケースでは適用外。

---

## ログ・トレース
- 取得：`Actions > places-proxy health` またはアプリのデバッグコンソール
- 必須キー：`safe_corridor_check`、`crossing_type`、`sidewalk_presence`、`road_shoulder`

---

## 完了条件（Acceptance Criteria）
- 手順 1–10 を満たし、**期待値ブロックの全条件が PASS**
- ルートスクリーンショット（安全帯凡例が分かる）を保存
- ログに必須キーが出力されていること
